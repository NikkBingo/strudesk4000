import{V as X,N as Y}from"./index-CY-ssS-c.js";import{p as q,E as p,y as T,o as Z,f as _,g as F,t as G}from"./strudel-core-Cml4IbyB.js";import"./strudel-web-Ddx65js9.js";const{WebMidi:a}=X;function H(){return typeof navigator.requestMIDIAccess=="function"}function y(e){return e.map(t=>`'${t.name}'`).join(" | ")}function R(e={}){const{onReady:t,onConnected:n,onDisconnected:i,onEnabled:r}=e;if(!a.enabled){if(!H())throw new Error("Your Browser does not support WebMIDI.");return a.addListener("connected",()=>{n==null||n(a)}),a.addListener("enabled",()=>{r==null||r(a)}),a.addListener("disconnected",o=>{i==null||i(a,o)}),new Promise((o,s)=>{if(a.enabled){o(a);return}a.enable(d=>{d&&s(d),t==null||t(a),o(a)},{sysex:!0})})}}function A(e,t){if(!t.length)throw new Error("ðŸ”Œ No MIDI devices found. Connect a device or enable IAC Driver.");if(typeof e=="number")return t[e];const n=o=>t.find(s=>s.name.includes(o));if(typeof e=="string")return n(e);const i=n("IAC"),r=i??t[0];if(!r)throw new Error(`ðŸ”Œ MIDI device '${r||""}' not found. Use one of ${y(t)}`);return i??t[0]}typeof window<"u"&&window.addEventListener("message",e=>{a!=null&&a.enabled&&e.data==="strudel-stop"&&a.outputs.forEach(t=>t.sendStop())});const h=new Map;function V(e){return Object.fromEntries(Object.entries(e).map(([t,n])=>(typeof n=="number"&&(n={ccn:n}),[T(t),n])))}function J(e,t=""){if(!e.startsWith("github:"))throw new Error('expected "github:" at the start of pseudoUrl');let[n,i]=e.split("github:");return i=i.endsWith("/")?i.slice(0,-1):i,i.split("/").length===2&&(i+="/main"),`https://raw.githubusercontent.com/${i}/${t}`}function ue(e){h.set("default",V(e))}let x={};async function me(e){typeof e=="string"&&(e.startsWith("github:")&&(e=J(e,"midimap.json")),x[e]||(x[e]=fetch(e).then(t=>t.json())),e=await x[e]),typeof e=="object"&&Object.entries(e).forEach(([t,n])=>h.set(t,V(n)))}const le=new Map;function ee(e=0,t=0,n=1,i=1){if(t===n)throw new Error("min and max cannot be the same value");let r=(e-t)/(n-t);return r=Math.min(1,Math.max(0,r)),Math.pow(r,i)}function te(e,t){return Object.keys(t).filter(n=>!!e[T(n)]).map(n=>{const{ccn:i,min:r=0,max:o=1,exp:s=1}=e[n],d=ee(t[n],r,o,s);return{ccn:i,ccv:d}})}function $(e,t,n,i,r){if(typeof t!="number"||t<0||t>1)throw new Error("expected ccv to be a number between 0 and 1");if(!["string","number"].includes(typeof e))throw new Error("expected ccn to be a number or a string");const o=Math.round(t*127);n.sendControlChange(e,o,i,{time:r})}function S(e,t,n,i){if(typeof e!="number"||e<0||e>127)throw new Error("expected progNum (program change) to be a number between 0 and 127");t.sendProgramChange(e,n,{time:i})}function U(e,t,n,i){if(Array.isArray(e)){if(!e.every(r=>Number.isInteger(r)&&r>=0&&r<=255))throw new Error("all sysexid bytes must be integers between 0 and 255")}else if(!Number.isInteger(e)||e<0||e>255)throw new Error("A:sysexid must be an number between 0 and 255 or an array of such integers");if(!Array.isArray(t))throw new Error("expected sysex to be an array of numbers (0-255)");if(!t.every(r=>Number.isInteger(r)&&r>=0&&r<=255))throw new Error("all sysex bytes must be integers between 0 and 255");n.sendSysex(e,t,{time:i})}function ne(e,t,n,i,r){if(Array.isArray(e)){if(!e.every(o=>Number.isInteger(o)&&o>=0&&o<=255))throw new Error("all nrpnn bytes must be integers between 0 and 255")}else if(!Number.isInteger(t)||t<0||t>255)throw new Error("A:sysexid must be an number between 0 and 255 or an array of such integers");n.sendNRPN(e,t,i,{time:r})}function ie(e,t,n,i){if(typeof e!="number"||e<-1||e>1)throw new Error("expected midibend to be a number between -1 and 1");t.sendPitchBend(e,n,{time:i})}function re(e,t,n,i){if(typeof e!="number"||e<0||e>1)throw new Error("expected miditouch to be a number between 0 and 1");t.sendChannelAftertouch(e,n,{time:i})}function oe(e,t,n,i,r,o){if(e==null||e==="")throw new Error("note cannot be null or empty");if(t!=null&&(typeof t!="number"||t<0||t>1))throw new Error("velocity must be a number between 0 and 1");if(n!=null&&(typeof n!="number"||n<0))throw new Error("duration must be a positive number");const s=typeof e=="number"?e:F(e),d=new Y(s,{attack:t,duration:n});i.playNote(d,r,{time:o})}_.prototype.midi=function(e,t={}){var i,r;if(q(e))throw new Error(`.midi does not accept Pattern input for midiport. Make sure to pass device name with single quotes. Example: .midi('${((r=(i=a.outputs)==null?void 0:i[0])==null?void 0:r.name)||"IAC Driver Bus 1"}')`);if(typeof e=="object"){const{port:o,isController:s=!1,...d}=e;t={isController:s,...d,...t},e=o}let n={isController:!1,latencyMs:34,noteOffsetMs:10,midichannel:1,velocity:.9,gain:1,midimap:"default",midiport:e,...t};return R({onEnabled:({outputs:o})=>{const s=A(n.midiport,o),d=o.filter(b=>b.name!==s.name);p(`Midi enabled! Using "${s.name}". ${d!=null&&d.length?`Also available: ${y(d)}`:""}`)},onDisconnected:({outputs:o})=>p(`Midi device disconnected! Available: ${y(o)}`)}),this.onTrigger((o,s,d,b)=>{if(!a.enabled){p("Midi not enabled");return}o.ensureObjectValue();const z=n.latencyMs,u=`+${G(b,s)+z}`;let{note:C,nrpnn:I,nrpv:N,ccn:j,ccv:D,midichan:l=n.midichannel,midicmd:m,midibend:k,miditouch:O,polyTouch:se,gain:K=n.gain,velocity:E=n.velocity,progNum:W,sysexid:B,sysexdata:L,midimap:g=n.midimap,midiport:P=n.midiport}=o.value;const c=A(P,a.outputs);if(!c){p(`[midi] midiport "${P}" not found! available: ${a.outputs.map(f=>`'${f.name}'`).join(", ")}`);return}if(E=K*E,h.has(g)?te(h.get(g),o.value).forEach(({ccn:f,ccv:M})=>$(f,M,c,l,u)):g!=="default"&&p(`[midi] midimap "${g}" not found! Available maps: ${[...h.keys()].join(", ")}`),C!==void 0&&!n.isController){const f=o.duration.valueOf()/d*1e3-n.noteOffsetMs;oe(C,E,f,c,l,u)}if(W!==void 0&&S(W,c,l,u),B!==void 0&&L!==void 0&&U(B,L,c,u),D!==void 0&&j!==void 0&&$(j,D,c,l,u),I!==void 0&&N!==void 0&&ne(I,N,c,l,u),k!==void 0&&ie(k,c,l,u),O!==void 0&&re(O,c,l,u),o.whole.begin+0===0&&c.sendStart({time:u}),["clock","midiClock"].includes(m))c.sendClock({time:u});else if(["start"].includes(m))c.sendStart({time:u});else if(["stop"].includes(m))c.sendStop({time:u});else if(["continue"].includes(m))c.sendContinue({time:u});else if(Array.isArray(m)){if(m[0]==="progNum")S(m[1],c,l,u);else if(m[0]==="cc")m.length===2&&$(m[0],m[1]/127,c,l,u);else if(m[0]==="sysex"&&m.length===3){const[f,M,Q]=m;U(M,Q,c,u)}}})};let v={};const w={};async function fe(e){var r,o;if(q(e))throw new Error(`midin: does not accept Pattern as input. Make sure to pass device name with single quotes. Example: midin('${((o=(r=a.outputs)==null?void 0:r[0])==null?void 0:o.name)||"IAC Driver Bus 1"}')`);const t=await R(),n=A(e,a.inputs);if(!n)throw new Error(`midiin: device "${e}" not found.. connected devices: ${y(a.inputs)}`);if(t){const s=a.inputs.filter(d=>d.name!==n.name);p(`Midi enabled! Using "${n.name}". ${s!=null&&s.length?`Also available: ${y(s)}`:""}`)}w[e]||(w[e]={});const i=s=>Z(()=>w[e][s]||0);return v[e]&&n.removeListener("midimessage",v[e]),v[e]=s=>{const d=s.dataBytes[0],b=s.dataBytes[1];w[e]&&(w[e][d]=b/127)},n.addListener("midimessage",v[e]),i}export{a as WebMidi,ue as defaultmidimap,R as enableWebMidi,h as midicontrolMap,me as midimaps,fe as midin,le as midisoundMap};
