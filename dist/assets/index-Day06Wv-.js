const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/strudel-web-C25uHgU2.js","assets/strudel-core-DenOJOif.js","assets/index-DgkhGcvb.js","assets/_commonjsHelpers-B5BZiXCZ.js","assets/index-BSvGoNXy.js","assets/index-DMlyjRuZ.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const NO="modulepreload",QO=function(i){return"/"+i},Id={},We=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){let o=function(d){return Promise.all(d.map(c=>Promise.resolve(c).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=o(t.map(d=>{if(d=QO(d),d in Id)return;Id[d]=!0;const c=d.endsWith(".css"),u=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${u}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":NO,c||(h.as="script"),h.crossOrigin="",h.href=d,l&&h.setAttribute("nonce",l),document.head.appendChild(h),c)return new Promise((f,m)=>{h.addEventListener("load",f),h.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})},et={elements:[{id:"element-1",selector:'[data-sound-id="element-1"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-2",selector:'[data-sound-id="element-2"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-3",selector:'[data-sound-id="element-3"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-4",selector:'[data-sound-id="element-4"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-5",selector:'[data-sound-id="element-5"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-6",selector:'[data-sound-id="element-6"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-7",selector:'[data-sound-id="element-7"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-8",selector:'[data-sound-id="element-8"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-9",selector:'[data-sound-id="element-9"]',type:"strudel",pattern:"",description:"No sound assigned"},{id:"element-10",selector:'[data-sound-id="element-10"]',type:"strudel",pattern:"",description:"No sound assigned"}],defaults:{proximityThreshold:100,hoverEnabled:!0,proximityEnabled:!0,volume:.5,fadeInTime:.1,fadeOutTime:.2},controls:{"proximity-threshold":{type:"synthesized",pattern:'sound("cp cp ~ cp")',description:"Threshold tick"},volume:{type:"synthesized",pattern:'sound("~ cp cp cp")',description:"Volume tick"}},getElementConfig(i){return this.elements.find(e=>e.id===i)},getSynthesizedElements(){return this.elements.filter(i=>i.type==="synthesized")},getAudioElements(){return this.elements.filter(i=>i.type==="audio")},getControlConfig(i){return this.controls[i]}};function RO(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function _O(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var xf=[0,2,4,-1,1,3,5],$f=xf.map(i=>Math.floor(i*7/12));function IO(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=xf[e]+7*t;if(n===void 0)return[s*r];const o=n-$f[e]-4*t;return[s*r,s*o]}var LO=[3,0,4,1,5,2,6];function BO(i){const[e,t,n]=i,s=LO[DO(e)],r=Math.floor((e+1)/7);if(t===void 0)return{step:s,alt:r,dir:n};const o=t+4*r+$f[s];return{step:s,alt:r,oct:o,dir:n}}function DO(i){const e=(i+1)%7;return e<0?7+e:e}var Ld=(i,e)=>Array(Math.abs(e)+1).join(i),Cl=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),zO="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",VO="(AA|A|P|M|m|d|dd)([-+]?\\d+)",ZO=new RegExp("^"+zO+"|"+VO+"$");function jO(i){const e=ZO.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var Bd={};function Mo(i){return typeof i=="string"?Bd[i]||(Bd[i]=FO(i)):_O(i)?Mo(UO(i)):RO(i)?Mo(i.name):Cl}var Dd=[0,2,4,5,7,9,11],Mf="PMMPPMM";function FO(i){const e=jO(i);if(e[0]==="")return Cl;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=Mf[s];if(r==="M"&&n==="P")return Cl;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=XO(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(Dd[s]+c+12*u),f=(l*(Dd[s]+c)%12+12)%12,m=IO({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function GO(i,e){const[t,n=0]=i,s=t*7+n*12<0,r=e||s?[-t,-n,-1]:[t,n,1];return Mo(BO(r))}function XO(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function UO(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=Mf[e]==="M"?"majorable":"perfectable";return a+o+WO(l,t)}function WO(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?Ld("A",e):Ld("d",i==="perfectable"?e:e+1)}function qO(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function HO(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var Cf=[0,2,4,-1,1,3,5],Ef=Cf.map(i=>Math.floor(i*7/12));function YO(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=Cf[e]+7*t;if(n===void 0)return[s*r];const o=n-Ef[e]-4*t;return[s*r,s*o]}var KO=[3,0,4,1,5,2,6];function JO(i){const[e,t,n]=i,s=KO[ey(e)],r=Math.floor((e+1)/7);if(t===void 0)return{step:s,alt:r,dir:n};const o=t+4*r+Ef[s];return{step:s,alt:r,oct:o,dir:n}}function ey(i){const e=(i+1)%7;return e<0?7+e:e}var zd=(i,e)=>Array(Math.abs(e)+1).join(i),Af=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),Vd=new Map,ty=i=>"CDEFGAB".charAt(i),Ko=i=>i<0?zd("b",-i):zd("#",i),Vc=i=>i[0]==="b"?-i.length:i.length;function nt(i){const e=JSON.stringify(i),t=Vd.get(e);if(t)return t;const n=typeof i=="string"?ry(i):HO(i)?nt(oy(i)):qO(i)?nt(i.name):Af;return Vd.set(e,n),n}var ny=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function Zc(i){const e=ny.exec(i);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function sy(i){return nt(JO(i))}var iy=(i,e)=>(i%e+e)%e,$a=[0,2,4,5,7,9,11];function ry(i){const e=Zc(i);if(e[0]===""||e[3]!=="")return Af;const t=e[0],n=e[1],s=e[2],r=(t.charCodeAt(0)+3)%7,o=Vc(n),a=s.length?+s:void 0,l=YO({step:r,alt:o,oct:a}),d=t+n+s,c=t+n,u=($a[r]+o+120)%12,h=a===void 0?iy($a[r]+o,12)-1188:$a[r]+o+12*(a+1),f=h>=0&&h<=127?h:null,m=a===void 0?null:Math.pow(2,(h-69)/12)*440;return{empty:!1,acc:n,alt:o,chroma:u,coord:l,freq:m,height:h,letter:t,midi:f,name:d,oct:a,pc:c,step:r}}function oy(i){const{step:e,alt:t,oct:n}=i,s=ty(e);if(!s)return"";const r=s+Ko(t);return n||n===0?r+n:r}function Yn(i,e){const t=nt(i),n=Array.isArray(e)?e:Mo(e).coord;if(t.empty||!n||n.length<2)return"";const s=t.coord,r=s.length===1?[s[0]+n[0]]:[s[0]+n[0],s[1]+n[1]];return sy(r).name}function Tf(i,e){const t=i.length;return n=>{if(!e)return"";const s=n<0?(t- -n%t)%t:n%t,r=Math.floor(n/t),o=Yn(e,[0,r]);return Yn(o,i[s])}}function jc(i,e){const t=nt(i),n=nt(e);if(t.empty||n.empty)return"";const s=t.coord,r=n.coord,o=r[0]-s[0],a=s.length===2&&r.length===2?r[1]-s[1]:-Math.floor(o*7/12),l=n.height===t.height&&n.midi!==null&&t.oct===n.oct&&t.step>n.step;return GO([o,a],l).name}function ay(i,e){const t=[];for(;e--;t[e]=e+i);return t}function ly(i,e){const t=[];for(;e--;t[e]=i-e);return t}function Fc(i,e){return i<e?ay(i,e-i+1):ly(i,i-e+1)}function Ci(i,e){const t=e.length,n=(i%t+t)%t;return e.slice(n,t).concat(e.slice(0,n))}function Nf(i){return i.filter(e=>e===0||e)}function cy(i,e=Math.random){let t,n,s=i.length;for(;s;)t=Math.floor(e()*s--),n=i[s],i[s]=i[t],i[t]=n;return i}function Qf(i){return i.length===0?[[]]:Qf(i.slice(1)).reduce((e,t)=>e.concat(i.map((n,s)=>{const r=t.slice();return r.splice(s,0,i[0]),r})),[])}var PM={compact:Nf,permutations:Qf,range:Fc,rotate:Ci,shuffle:cy};function dy(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function uy(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var Rf=[0,2,4,-1,1,3,5],hy=Rf.map(i=>Math.floor(i*7/12));function fy(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=Rf[e]+7*t;if(n===void 0)return[s*r];const o=n-hy[e]-4*t;return[s*r,s*o]}var Zd=(i,e)=>Array(Math.abs(e)+1).join(i),El=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),my="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",py="(AA|A|P|M|m|d|dd)([-+]?\\d+)",gy=new RegExp("^"+my+"|"+py+"$");function Oy(i){const e=gy.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var jd={};function Al(i){return typeof i=="string"?jd[i]||(jd[i]=yy(i)):uy(i)?Al(vy(i)):dy(i)?Al(i.name):El}var Fd=[0,2,4,5,7,9,11],_f="PMMPPMM";function yy(i){const e=Oy(i);if(e[0]==="")return El;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=_f[s];if(r==="M"&&n==="P")return El;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=by(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(Fd[s]+c+12*u),f=(l*(Fd[s]+c)%12+12)%12,m=fy({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function by(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function vy(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=_f[e]==="M"?"majorable":"perfectable";return a+o+wy(l,t)}function wy(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?Zd("A",e):Zd("d",i==="perfectable"?e:e+1)}var Kn={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},Gc=i=>Number(i).toString(2).padStart(12,"0"),Gd=i=>parseInt(i,2),Py=/^[01]{12}$/;function Xc(i){return Py.test(i)}var Sy=i=>typeof i=="number"&&i>=0&&i<=4095,ky=i=>i&&Xc(i.chroma),Xd={[Kn.chroma]:Kn};function vt(i){const e=Xc(i)?i:Sy(i)?Gc(i):Array.isArray(i)?Iy(i):ky(i)?i.chroma:Kn.chroma;return Xd[e]=Xd[e]||_y(e)}var xy=vt,If=i=>vt(i).chroma,$y=i=>vt(i).intervals,My=i=>vt(i).setNum,Cy=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function Ey(i){const e=[];for(let t=0;t<12;t++)i.charAt(t)==="1"&&e.push(Cy[t]);return e}function Ay(i){return vt(i).intervals.map(e=>Yn("C",e))}function Ty(){return Fc(2048,4095).map(Gc)}function Lf(i,e=!0){const n=vt(i).chroma.split("");return Nf(n.map((s,r)=>{const o=Ci(r,n);return e&&o[0]==="0"?null:o.join("")}))}function Ny(i,e){return vt(i).setNum===vt(e).setNum}function Uc(i){const e=vt(i).setNum;return t=>{const n=vt(t).setNum;return e&&e!==n&&(n&e)===n}}function Bf(i){const e=vt(i).setNum;return t=>{const n=vt(t).setNum;return e&&e!==n&&(n|e)===n}}function Df(i){const e=vt(i);return t=>{const n=nt(t);return e&&!n.empty&&e.chroma.charAt(n.chroma)==="1"}}function Qy(i){const e=Df(i);return t=>t.filter(e)}var SM={get:vt,chroma:If,num:My,intervals:$y,chromas:Ty,isSupersetOf:Bf,isSubsetOf:Uc,isNoteIncludedIn:Df,isEqual:Ny,filter:Qy,modes:Lf,notes:Ay,pcset:xy};function Ry(i){const e=i.split("");return e.map((t,n)=>Ci(n,e).join(""))}function _y(i){const e=Gd(i),t=Ry(i).map(Gd).filter(r=>r>=2048).sort()[0],n=Gc(t),s=Ey(i);return{empty:!1,name:"",setNum:e,chroma:i,normalized:n,intervals:s}}function Iy(i){if(i.length===0)return Kn.chroma;let e;const t=[0,0,0,0,0,0,0,0,0,0,0,0];for(let n=0;n<i.length;n++)e=nt(i[n]),e.empty&&(e=Al(i[n])),e.empty||(t[e.chroma]=1);return t.join("")}var Ly=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],By=Ly;({...Kn});var Wc=[],fo={};function kM(){return Wc.slice()}function Dy(i,e,t){const n=Vy(i),s={...vt(i),name:t||"",quality:n,intervals:i,aliases:e};Wc.push(s),s.name&&(fo[s.name]=s),fo[s.setNum]=s,fo[s.chroma]=s,s.aliases.forEach(r=>zy(s,r))}function zy(i,e){fo[e]=i}function Vy(i){const e=t=>i.indexOf(t)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}By.forEach(([i,e,t])=>Dy(i.split(" "),t.split(" "),e));Wc.sort((i,e)=>i.setNum-e.setNum);function Jo(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}var zf=[0,2,4,5,7,9,11],Zy=({step:i,alt:e})=>(zf[i]+e+120)%12,Vf=({step:i,alt:e,oct:t,dir:n=1})=>n*(zf[i]+e+12*(t===void 0?-100:t)),jy=i=>{const e=Vf(i);return i.oct!==void 0&&e>=-12&&e<=115?e+12:null};function qc(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"}var Zf=[0,2,4,-1,1,3,5],jf=Zf.map(i=>Math.floor(i*7/12));function Hc(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=Zf[e]+7*t;if(n===void 0)return[s*r];const o=n-jf[e]-4*t;return[s*r,s*o]}var Fy=[3,0,4,1,5,2,6];function Yc(i){const[e,t,n]=i,s=Fy[Gy(e)],r=Math.floor((e+1)/7);if(t===void 0)return{step:s,alt:r,dir:n};const o=t+4*r+jf[s];return{step:s,alt:r,oct:o,dir:n}}function Gy(i){const e=(i+1)%7;return e<0?7+e:e}var Ud=(i,e)=>Array(Math.abs(e)+1).join(i),Tl={empty:!0,name:"",acc:""},Xy="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",Uy="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Wy=new RegExp("^"+Xy+"|"+Uy+"$");function Ff(i){const e=Wy.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var Wd={};function Wt(i){return typeof i=="string"?Wd[i]||(Wd[i]=qy(i)):qc(i)?Wt(Yy(i)):Jo(i)?Wt(i.name):Tl}var qd=[0,2,4,5,7,9,11],Gf="PMMPPMM";function qy(i){const e=Ff(i);if(e[0]==="")return Tl;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=Gf[s];if(r==="M"&&n==="P")return Tl;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=Hy(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(qd[s]+c+12*u),f=(l*(qd[s]+c)%12+12)%12,m=Hc({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function ea(i,e){const[t,n=0]=i,s=t*7+n*12<0,r=e||s?[-t,-n,-1]:[t,n,1];return Wt(Yc(r))}function Hy(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function Yy(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=Gf[e]==="M"?"majorable":"perfectable";return a+o+Ky(l,t)}function Ky(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?Ud("A",e):Ud("d",i==="perfectable"?e:e+1)}var Hd=(i,e)=>Array(Math.abs(e)+1).join(i),Xf={empty:!0,name:"",pc:"",acc:""},Yd=new Map,Uf=i=>"CDEFGAB".charAt(i),Wf=i=>i<0?Hd("b",-i):Hd("#",i),qf=i=>i[0]==="b"?-i.length:i.length;function Xs(i){const e=JSON.stringify(i),t=Yd.get(e);if(t)return t;const n=typeof i=="string"?t0(i):qc(i)?Xs(n0(i)):Jo(i)?Xs(i.name):Xf;return Yd.set(e,n),n}var Jy=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function Hf(i){const e=Jy.exec(i);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function Yf(i){return Xs(Yc(i))}var e0=(i,e)=>(i%e+e)%e,Ma=[0,2,4,5,7,9,11];function t0(i){const e=Hf(i);if(e[0]===""||e[3]!=="")return Xf;const t=e[0],n=e[1],s=e[2],r=(t.charCodeAt(0)+3)%7,o=qf(n),a=s.length?+s:void 0,l=Hc({step:r,alt:o,oct:a}),d=t+n+s,c=t+n,u=(Ma[r]+o+120)%12,h=a===void 0?e0(Ma[r]+o,12)-1188:Ma[r]+o+12*(a+1),f=h>=0&&h<=127?h:null,m=a===void 0?null:Math.pow(2,(h-69)/12)*440;return{empty:!1,acc:n,alt:o,chroma:u,coord:l,freq:m,height:h,letter:t,midi:f,name:d,oct:a,pc:c,step:r}}function n0(i){const{step:e,alt:t,oct:n}=i,s=Uf(e);if(!s)return"";const r=s+Wf(t);return n||n===0?r+n:r}function Nl(i,e){const t=Xs(i),n=Array.isArray(e)?e:Wt(e).coord;if(t.empty||!n||n.length<2)return"";const s=t.coord,r=s.length===1?[s[0]+n[0]]:[s[0]+n[0],s[1]+n[1]];return Yf(r).name}function s0(i,e){const t=i.length;return n=>{if(!e)return"";const s=n<0?(t- -n%t)%t:n%t,r=Math.floor(n/t),o=Nl(e,[0,r]);return Nl(o,i[s])}}function i0(i,e){const t=Xs(i),n=Xs(e);if(t.empty||n.empty)return"";const s=t.coord,r=n.coord,o=r[0]-s[0],a=s.length===2&&r.length===2?r[1]-s[1]:-Math.floor(o*7/12),l=n.height===t.height&&n.midi!==null&&t.midi!==null&&t.step>n.step;return ea([o,a],l).name}var r0=(i,e)=>Array(Math.abs(e)+1).join(i);function ta(i,e,t){return function(...n){return console.warn(`${i} is deprecated. Use ${e}.`),t.apply(this,n)}}var o0=ta("isNamed","isNamedPitch",Jo);const xM=Object.freeze(Object.defineProperty({__proto__:null,accToAlt:qf,altToAcc:Wf,chroma:Zy,coordToInterval:ea,coordToNote:Yf,coordinates:Hc,deprecate:ta,distance:i0,fillStr:r0,height:Vf,interval:Wt,isNamed:o0,isNamedPitch:Jo,isPitch:qc,midi:jy,note:Xs,pitch:Yc,stepToLetter:Uf,tokenizeInterval:Ff,tokenizeNote:Hf,tonicIntervalsTransposer:s0,transpose:Nl},Symbol.toStringTag,{value:"Module"}));var a0=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],l0=a0,c0={...Kn,name:"",quality:"Unknown",intervals:[],aliases:[]},Ei=[],Zs={};function Kf(i){return Zs[i]||c0}var d0=ta("ChordType.chordType","ChordType.get",Kf);function u0(){return Ei.map(i=>i.name).filter(i=>i)}function h0(){return Ei.map(i=>i.aliases[0]).filter(i=>i)}function f0(){return Object.keys(Zs)}function Jf(){return Ei.slice()}var m0=ta("ChordType.entries","ChordType.all",Jf);function p0(){Ei=[],Zs={}}function em(i,e,t){const n=O0(i),s={...vt(i),name:t||"",quality:n,intervals:i,aliases:e};Ei.push(s),s.name&&(Zs[s.name]=s),Zs[s.setNum]=s,Zs[s.chroma]=s,s.aliases.forEach(r=>g0(s,r))}function g0(i,e){Zs[e]=i}function O0(i){const e=t=>i.indexOf(t)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}l0.forEach(([i,e,t])=>em(i.split(" "),t.split(" "),e));Ei.sort((i,e)=>i.setNum-e.setNum);var $M={names:u0,symbols:h0,get:Kf,all:Jf,add:em,removeAll:p0,keys:f0,entries:m0,chordType:d0},y0=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],b0=y0,v0={...Kn,intervals:[],aliases:[]},na=[],js={};function tm(){return na.map(i=>i.name)}function sa(i){return js[i]||v0}var w0=sa;function kr(){return na.slice()}var P0=kr;function S0(){return Object.keys(js)}function k0(){na=[],js={}}function nm(i,e,t=[]){const n={...vt(i),name:e,intervals:i,aliases:t};return na.push(n),js[n.name]=n,js[n.setNum]=n,js[n.chroma]=n,n.aliases.forEach(s=>x0(n,s)),n}function x0(i,e){js[e]=i}b0.forEach(([i,e,...t])=>nm(i.split(" "),e,t));var MM={names:tm,get:sa,all:kr,add:nm,removeAll:k0,keys:S0,entries:P0,scaleType:w0},$0=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],M0=$0,ia=[];M0.forEach(([i,e,t])=>R0(i,e,t));var C0={empty:!0,name:"",value:0,fraction:[0,0],shorthand:"",dots:"",names:[]};function E0(){return ia.reduce((i,e)=>(e.names.forEach(t=>i.push(t)),i),[])}function A0(){return ia.map(i=>i.shorthand)}var T0=/^([^.]+)(\.*)$/;function Kc(i){const[e,t,n]=T0.exec(i)||[],s=ia.find(a=>a.shorthand===t||a.names.includes(t));if(!s)return C0;const r=_0(s.fraction,n.length),o=r[0]/r[1];return{...s,name:i,dots:n,value:o,fraction:r}}var N0=i=>Kc(i).value,Q0=i=>Kc(i).fraction,CM={names:E0,shorthands:A0,get:Kc,value:N0,fraction:Q0};function R0(i,e,t){ia.push({empty:!1,dots:"",name:"",value:1/i,fraction:i<1?[1/i,1]:[1,i],shorthand:e,names:t})}function _0(i,e){const t=Math.pow(2,e);let n=i[0]*t,s=i[1]*t;const r=n;for(let o=0;o<e;o++)n+=r/Math.pow(2,o+1);for(;n%2===0&&s%2===0;)n/=2,s/=2;return[n,s]}function I0(){return"1P 2M 3M 4P 5P 6m 7m".split(" ")}var sm=Wt,L0=i=>Wt(i).name,B0=i=>Wt(i).semitones,D0=i=>Wt(i).q,z0=i=>Wt(i).num;function V0(i){const e=Wt(i);return e.empty?"":e.simple+e.q}function Z0(i){const e=Wt(i);if(e.empty)return"";const t=(7-e.step)%7,n=e.type==="perfectable"?-e.alt:-(e.alt+1);return Wt({step:t,alt:n,oct:e.oct,dir:e.dir}).name}var j0=[1,2,2,3,3,4,5,5,6,6,7,7],F0="P m M m M P d P m M m M".split(" ");function G0(i){const e=i<0?-1:1,t=Math.abs(i),n=t%12,s=Math.floor(t/12);return e*(j0[n]+7*s)+F0[n]}var X0=jc,im=rm((i,e)=>[i[0]+e[0],i[1]+e[1]]),U0=i=>e=>im(i,e),W0=rm((i,e)=>[i[0]-e[0],i[1]-e[1]]);function q0(i,e){const t=sm(i);if(t.empty)return"";const[n,s,r]=t.coord;return ea([n+e,s,r]).name}var H0={names:I0,get:sm,name:L0,num:z0,semitones:B0,quality:D0,fromSemitones:G0,distance:X0,invert:Z0,simplify:V0,add:im,addTo:U0,substract:W0,transposeFifths:q0};function rm(i){return(e,t)=>{const n=Wt(e).coord,s=Wt(t).coord;if(n&&s){const r=i(n,s);return ea(r).name}}}function om(i){return+i>=0&&+i<=127}function Y0(i){if(om(i))return+i;const e=nt(i);return e.empty?null:e.midi}function K0(i,e=440){return Math.pow(2,(i-69)/12)*e}var J0=Math.log(2),eb=Math.log(440);function Jc(i){const e=12*(Math.log(i)-eb)/J0+69;return Math.round(e*100)/100}var tb="C C# D D# E F F# G G# A A# B".split(" "),nb="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Js(i,e={}){if(isNaN(i)||i===-1/0||i===1/0)return"";i=Math.round(i);const n=(e.sharps===!0?tb:nb)[i%12];if(e.pitchClass)return n;const s=Math.floor(i/12)-1;return n+s}function ed(i){return i%12}function sb(i){return i.split("").reduce((e,t,n)=>(n<12&&t==="1"&&e.push(n),e),[])}function ib(i){return i.map(ed).sort((e,t)=>e-t).filter((e,t,n)=>t===0||e!==n[t-1])}function td(i){return Array.isArray(i)?ib(i):sb(i)}function rb(i){const e=td(i);return t=>{const n=ed(t);for(let s=0;s<12;s++){if(e.includes(n+s))return t+s;if(e.includes(n-s))return t-s}}}function am(i,e){const t=td(i),n=t.length;return s=>{const r=s<0?(n- -s%n)%n:s%n,o=Math.floor(s/n);return t[r]+o*12+e}}function ob(i,e){const t=am(i,e);return n=>{if(n!==0)return t(n>0?n-1:n)}}var EM={chroma:ed,freqToMidi:Jc,isMidi:om,midiToFreq:K0,midiToNoteName:Js,pcsetNearest:rb,pcset:td,pcsetDegrees:ob,pcsetSteps:am,toMidi:Y0},ab=["C","D","E","F","G","A","B"],lm=i=>i.name,cm=i=>i.map(nt).filter(e=>!e.empty);function lb(i){return i===void 0?ab.slice():Array.isArray(i)?cm(i).map(lm):[]}var An=nt,cb=i=>An(i).name,db=i=>An(i).pc,ub=i=>An(i).acc,hb=i=>An(i).oct,fb=i=>An(i).midi,mb=i=>An(i).freq,pb=i=>An(i).chroma;function dm(i){return Js(i)}function gb(i){return Js(Jc(i))}function Ob(i){return Js(Jc(i),{sharps:!0})}function yb(i){return Js(i,{sharps:!0})}var bb=jc,En=Yn,vb=Yn,um=i=>e=>En(e,i),wb=um,hm=i=>e=>En(i,e),Pb=hm;function Co(i,e){return En(i,[e,0])}var Sb=Co;function kb(i,e){return En(i,[0,e])}var nd=(i,e)=>i.height-e.height,xb=(i,e)=>e.height-i.height;function fm(i,e){return e=e||nd,cm(i).sort(e).map(lm)}function mm(i){return fm(i,nd).filter((e,t,n)=>t===0||e!==n[t-1])}var $b=i=>{const e=An(i);return e.empty?"":Js(e.midi||e.chroma,{sharps:e.alt>0,pitchClass:e.midi===null})};function pm(i,e){const t=An(i);if(t.empty)return"";const n=An(e||Js(t.midi||t.chroma,{sharps:t.alt<0,pitchClass:!0}));if(n.empty||n.chroma!==t.chroma)return"";if(t.oct===void 0)return n.pc;const s=t.chroma-t.alt,r=n.chroma-n.alt,o=s>11||r<0?-1:s<0||r>11?1:0,a=t.oct+o;return n.pc+a}var Ql={names:lb,get:An,name:cb,pitchClass:db,accidentals:ub,octave:hb,midi:fb,ascending:nd,descending:xb,distance:bb,sortedNames:fm,sortedUniqNames:mm,fromMidi:dm,fromMidiSharps:yb,freq:mb,fromFreq:gb,fromFreqSharps:Ob,chroma:pb,transpose:En,tr:vb,transposeBy:um,trBy:wb,transposeFrom:hm,trFrom:Pb,transposeFifths:Co,transposeOctaves:kb,trFifths:Sb,simplify:$b,enharmonic:pm};function gm(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function Om(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var ym=[0,2,4,-1,1,3,5],Mb=ym.map(i=>Math.floor(i*7/12));function Cb(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=ym[e]+7*t;if(n===void 0)return[s*r];const o=n-Mb[e]-4*t;return[s*r,s*o]}var Kd=(i,e)=>Array(Math.abs(e)+1).join(i),Rl=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),Eb="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",Ab="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Tb=new RegExp("^"+Eb+"|"+Ab+"$");function Nb(i){const e=Tb.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var Jd={};function _l(i){return typeof i=="string"?Jd[i]||(Jd[i]=Qb(i)):Om(i)?_l(_b(i)):gm(i)?_l(i.name):Rl}var eu=[0,2,4,5,7,9,11],bm="PMMPPMM";function Qb(i){const e=Nb(i);if(e[0]==="")return Rl;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=bm[s];if(r==="M"&&n==="P")return Rl;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=Rb(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(eu[s]+c+12*u),f=(l*(eu[s]+c)%12+12)%12,m=Cb({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function Rb(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function _b(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=bm[e]==="M"?"majorable":"perfectable";return a+o+Ib(l,t)}function Ib(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?Kd("A",e):Kd("d",i==="perfectable"?e:e+1)}var vm={empty:!0,name:"",chordType:""},tu={};function ws(i){return typeof i=="string"?tu[i]||(tu[i]=jb(i)):typeof i=="number"?ws(ra[i]||""):Om(i)?Db(i):gm(i)?ws(i.name):vm}var Lb=ws;function Bb(i=!0){return(i?ra:Zb).slice()}function Db(i){return ws(Ko(i.alt)+ra[i.step])}var zb=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function Vb(i){return zb.exec(i)||["","","",""]}var wm="I II III IV V VI VII",ra=wm.split(" "),Zb=wm.toLowerCase().split(" ");function jb(i){const[e,t,n,s]=Vb(i);if(!n)return vm;const r=n.toUpperCase(),o=ra.indexOf(r),a=Vc(t),l=1;return{empty:!1,name:e,roman:n,interval:_l({step:o,alt:a,dir:l}).name,acc:t,chordType:s,alt:a,step:o,major:n===r,oct:0,dir:l}}var AM={names:Bb,get:ws,romanNumeral:Lb},At=Object.freeze([]),Pm={type:"major",tonic:"",alteration:0,keySignature:""},mo={tonic:"",grades:At,intervals:At,scale:At,triads:At,chords:At,chordsHarmonicFunction:At,chordScales:At,secondaryDominants:At,secondaryDominantSupertonics:At,substituteDominantsMinorRelative:At,substituteDominants:At,substituteDominantSupertonics:At,secondaryDominantsMinorRelative:At},Fb={...Pm,...mo,type:"major",minorRelative:"",scale:At,substituteDominants:At,secondaryDominantSupertonics:At,substituteDominantsMinorRelative:At},Gb={...Pm,type:"minor",relativeMajor:"",natural:mo,harmonic:mo,melodic:mo},Ca=(i,e,t="")=>e.map((n,s)=>`${i[s]}${t}${n}`);function oa(i,e,t,n,s){return r=>{const o=i.map(f=>ws(f).interval||""),a=o.map(f=>En(r,f)),l=Ca(a,t),d=a.map(f=>En(f,"5P")).map(f=>a.includes(f)&&!l.includes(f+"7")?f+"7":""),c=nu(d,e),u=d.map(f=>{if(!f)return"";const m=f.slice(0,-1);return En(m,"5d")+"7"}),h=nu(u,e);return{tonic:r,grades:i,intervals:o,scale:a,triads:Ca(a,e),chords:l,chordsHarmonicFunction:n.slice(),chordScales:Ca(a,s," "),secondaryDominants:d,secondaryDominantSupertonics:c,substituteDominants:u,substituteDominantSupertonics:h,secondaryDominantsMinorRelative:c,substituteDominantsMinorRelative:h}}}var nu=(i,e)=>i.map((t,n)=>{if(!t)return"";const s=t.slice(0,-1),r=En(s,"5P");return e[n].endsWith("m")?r+"m7":r+"m7b5"}),Sm=(i,e)=>{const t=nt(i),n=nt(e);return t.empty||n.empty?0:n.coord[0]-t.coord[0]},Xb=oa("I II III IV V VI VII".split(" ")," m m   m dim".split(" "),"maj7 m7 m7 maj7 7 m7 m7b5".split(" "),"T SD T SD D T D".split(" "),"major,dorian,phrygian,lydian,mixolydian,minor,locrian".split(",")),Ub=oa("I II bIII IV V bVI bVII".split(" "),"m dim  m m  ".split(" "),"m7 m7b5 maj7 m7 m7 maj7 7".split(" "),"T SD T SD D SD SD".split(" "),"minor,locrian,major,dorian,phrygian,lydian,mixolydian".split(",")),Wb=oa("I II bIII IV V bVI VII".split(" "),"m dim aug m   dim".split(" "),"mMaj7 m7b5 +maj7 m7 7 maj7 o7".split(" "),"T SD T SD D SD D".split(" "),"harmonic minor,locrian 6,major augmented,lydian diminished,phrygian dominant,lydian #9,ultralocrian".split(",")),qb=oa("I II bIII IV V VI VII".split(" "),"m m aug   dim dim".split(" "),"m6 m7 +maj7 7 7 m7b5 m7b5".split(" "),"T SD T SD D  ".split(" "),"melodic minor,dorian b2,lydian augmented,lydian dominant,mixolydian b6,locrian #2,altered".split(","));function Hb(i){const e=nt(i).pc;if(!e)return Fb;const t=Xb(e),n=Sm("C",e);return{...t,type:"major",minorRelative:En(e,"-3m"),alteration:n,keySignature:Ko(n)}}function Yb(i){const e=nt(i).pc;if(!e)return Gb;const t=Sm("C",e)-3;return{type:"minor",tonic:e,relativeMajor:En(e,"3m"),alteration:t,keySignature:Ko(t),natural:Ub(e),harmonic:Wb(e),melodic:qb(e)}}function Kb(i){return typeof i=="number"?Co("C",i):typeof i=="string"&&/^b+|#+$/.test(i)?Co("C",Vc(i)):null}var TM={majorKey:Hb,majorTonicFromKeySignature:Kb,minorKey:Yb};function Jb(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function e1(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var km=[0,2,4,-1,1,3,5],xm=km.map(i=>Math.floor(i*7/12));function t1(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=km[e]+7*t;if(n===void 0)return[s*r];const o=n-xm[e]-4*t;return[s*r,s*o]}var n1=[3,0,4,1,5,2,6];function s1(i){const[e,t,n]=i,s=n1[i1(e)],r=Math.floor((e+1)/7);if(t===void 0)return{step:s,alt:r,dir:n};const o=t+4*r+xm[s];return{step:s,alt:r,oct:o,dir:n}}function i1(i){const e=(i+1)%7;return e<0?7+e:e}var su=(i,e)=>Array(Math.abs(e)+1).join(i),Il=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),r1="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",o1="(AA|A|P|M|m|d|dd)([-+]?\\d+)",a1=new RegExp("^"+r1+"|"+o1+"$");function l1(i){const e=a1.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var iu={};function fr(i){return typeof i=="string"?iu[i]||(iu[i]=c1(i)):e1(i)?fr(h1(i)):Jb(i)?fr(i.name):Il}var ru=[0,2,4,5,7,9,11],$m="PMMPPMM";function c1(i){const e=l1(i);if(e[0]==="")return Il;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=$m[s];if(r==="M"&&n==="P")return Il;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=u1(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(ru[s]+c+12*u),f=(l*(ru[s]+c)%12+12)%12,m=t1({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function d1(i,e){const[t,n=0]=i,r=t*7+n*12<0?[-t,-n,-1]:[t,n,1];return fr(s1(r))}function u1(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function h1(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=$m[e]==="M"?"majorable":"perfectable";return a+o+f1(l,t)}function f1(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?su("A",e):su("d",i==="perfectable"?e:e+1)}var m1=fr;function p1(i){const e=fr(i);return e.empty?"":e.simple+e.q}function g1(i,e){const t=m1(i);if(t.empty)return"";const[n,s,r]=t.coord;return d1([n+e,s,r]).name}var sd=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],ou={...Kn,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},id=sd.map(v1),Ll={};id.forEach(i=>{Ll[i.name]=i,i.aliases.forEach(e=>{Ll[e]=i})});function Us(i){return typeof i=="string"?Ll[i.toLowerCase()]||ou:i&&i.name?Us(i.name):ou}var O1=Us;function Mm(){return id.slice()}var y1=Mm;function b1(){return id.map(i=>i.name)}function v1(i){const[e,t,n,s,r,o,a]=i,l=a?[a]:[],d=Number(t).toString(2);return{empty:!1,intervals:sa(s).intervals,modeNum:e,chroma:d,normalized:d,name:s,setNum:t,alt:n,triad:r,seventh:o,aliases:l}}function w1(i,e){return Us(i).intervals.map(t=>Yn(e,t))}function Cm(i){return(e,t)=>{const n=Us(e);if(n.empty)return[];const s=Ci(n.modeNum,i),r=n.intervals.map(o=>Yn(t,o));return s.map((o,a)=>r[a]+o)}}var P1=Cm(sd.map(i=>i[4])),S1=Cm(sd.map(i=>i[5]));function Em(i,e){const t=Us(e),n=Us(i);return t.empty||n.empty?"":p1(g1("1P",n.alt-t.alt))}function k1(i,e,t){return Yn(t,Em(i,e))}var NM={get:Us,names:b1,all:Mm,distance:Em,relativeTonic:k1,notes:w1,triads:P1,seventhChords:S1,entries:y1,mode:O1},x1=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],$1=x1;({...Kn});var Am=[],po={};function M1(i,e,t){const n=E1(i),s={...vt(i),name:t||"",quality:n,intervals:i,aliases:e};Am.push(s),s.name&&(po[s.name]=s),po[s.setNum]=s,po[s.chroma]=s,s.aliases.forEach(r=>C1(s,r))}function C1(i,e){po[e]=i}function E1(i){const e=t=>i.indexOf(t)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}$1.forEach(([i,e,t])=>M1(i.split(" "),t.split(" "),e));Am.sort((i,e)=>i.setNum-e.setNum);function A1(i){return i!==null&&typeof i=="object"&&"name"in i&&typeof i.name=="string"}function T1(i){return i!==null&&typeof i=="object"&&"step"in i&&typeof i.step=="number"&&"alt"in i&&typeof i.alt=="number"&&!isNaN(i.step)&&!isNaN(i.alt)}var Tm=[0,2,4,-1,1,3,5],N1=Tm.map(i=>Math.floor(i*7/12));function Q1(i){const{step:e,alt:t,oct:n,dir:s=1}=i,r=Tm[e]+7*t;if(n===void 0)return[s*r];const o=n-N1[e]-4*t;return[s*r,s*o]}var au=(i,e)=>Array(Math.abs(e)+1).join(i),Bl=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),R1="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",_1="(AA|A|P|M|m|d|dd)([-+]?\\d+)",I1=new RegExp("^"+R1+"|"+_1+"$");function L1(i){const e=I1.exec(`${i}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var lu={};function Eo(i){return typeof i=="string"?lu[i]||(lu[i]=B1(i)):T1(i)?Eo(z1(i)):A1(i)?Eo(i.name):Bl}var cu=[0,2,4,5,7,9,11],Nm="PMMPPMM";function B1(i){const e=L1(i);if(e[0]==="")return Bl;const t=+e[0],n=e[1],s=(Math.abs(t)-1)%7,r=Nm[s];if(r==="M"&&n==="P")return Bl;const o=r==="M"?"majorable":"perfectable",a=""+t+n,l=t<0?-1:1,d=t===8||t===-8?t:l*(s+1),c=D1(o,n),u=Math.floor((Math.abs(t)-1)/7),h=l*(cu[s]+c+12*u),f=(l*(cu[s]+c)%12+12)%12,m=Q1({step:s,alt:c,oct:u,dir:l});return{empty:!1,name:a,num:t,q:n,step:s,alt:c,dir:l,type:o,simple:d,semitones:h,chroma:f,coord:m,oct:u}}function D1(i,e){return e==="M"&&i==="majorable"||e==="P"&&i==="perfectable"?0:e==="m"&&i==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(i==="perfectable"?e.length:e.length+1):0}function z1(i){const{step:e,alt:t,oct:n=0,dir:s}=i;if(!s)return"";const r=e+1+7*n,o=r===0?e+1:r,a=s<0?"-":"",l=Nm[e]==="M"?"majorable":"perfectable";return a+o+V1(l,t)}function V1(i,e){return e===0?i==="majorable"?"M":"P":e===-1&&i==="majorable"?"m":e>0?au("A",e):au("d",i==="perfectable"?e:e+1)}function Z1(i){const[e,t,n,s]=Zc(i);return e===""?Ea("",i):e==="A"&&s==="ug"?Ea("","aug"):Ea(e+t,n+s)}function Ea(i,e){const t=e.split("/");if(t.length===1)return[i,t[0],""];const[n,s,r,o]=Zc(t[1]);return n!==""&&r===""&&o===""?[i,t[0],n+s]:[i,e,""]}function j1(i,e){return e.map(ws).map(n=>Yn(i,Eo(n))+n.chordType)}function F1(i,e){return e.map(t=>{const[n,s]=Z1(t),r=jc(i,n);return ws(Eo(r)).name+s})}var G1={fromRomanNumerals:j1,toRomanNumerals:F1},X1=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],U1=X1;({...Kn});var rd=[],go={};function W1(){return rd.slice()}function q1(i,e,t){const n=Y1(i),s={...vt(i),name:t||"",quality:n,intervals:i,aliases:e};rd.push(s),s.name&&(go[s.name]=s),go[s.setNum]=s,go[s.chroma]=s,s.aliases.forEach(r=>H1(s,r))}function H1(i,e){go[e]=i}function Y1(i){const e=t=>i.indexOf(t)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}U1.forEach(([i,e,t])=>q1(i.split(" "),t.split(" "),e));rd.sort((i,e)=>i.setNum-e.setNum);var K1={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Qm(i){if(typeof i!="string")return["",""];const e=i.indexOf(" "),t=nt(i.substring(0,e));if(t.empty){const s=nt(i);return s.empty?["",i.toLowerCase()]:[s.name,""]}const n=i.substring(t.name.length+1).toLowerCase();return[t.name,n.length?n:""]}var J1=tm;function Jn(i){const e=Array.isArray(i)?i:Qm(i),t=nt(e[0]).name,n=sa(e[1]);if(n.empty)return K1;const s=n.name,r=t?n.intervals.map(a=>Yn(t,a)):[],o=t?t+" "+s:s;return{...n,name:o,type:s,tonic:t,notes:r}}var ev=Jn;function tv(i,e={}){const t=If(i),n=nt(e.tonic??i[0]??""),s=n.chroma;if(s===void 0)return[];const r=t.split("");r[s]="1";const o=Ci(s,r).join(""),a=kr().find(d=>d.chroma===o),l=[];return a&&l.push(n.name+" "+a.name),e.match==="exact"||Rm(o).forEach(d=>{l.push(n.name+" "+d)}),l}function nv(i){const e=Jn(i),t=Uc(e.chroma);return W1().filter(n=>t(n.chroma)).map(n=>n.aliases[0])}function Rm(i){const e=Xc(i)?i:Jn(i).chroma,t=Bf(e);return kr().filter(n=>t(n.chroma)).map(n=>n.name)}function sv(i){const e=Uc(Jn(i).chroma);return kr().filter(t=>e(t.chroma)).map(t=>t.name)}function _m(i){const e=i.map(s=>nt(s).pc).filter(s=>s),t=e[0],n=mm(e);return Ci(n.indexOf(t),n)}function iv(i){const e=Jn(i);if(e.empty)return[];const t=e.tonic?e.notes:e.intervals;return Lf(e.chroma).map((n,s)=>{const r=Jn(n).name;return r?[t[s],r]:["",""]}).filter(n=>n[0])}function rv(i){const e=Array.isArray(i)?_m(i):Jn(i).notes,t=e.map(n=>nt(n).chroma);return n=>{const s=nt(typeof n=="number"?dm(n):n),r=s.height;if(r===void 0)return;const o=r%12,a=t.indexOf(o);if(a!==-1)return pm(s.name,e[a])}}function ov(i){const e=rv(i);return(t,n)=>{const s=nt(t).height,r=nt(n).height;return s===void 0||r===void 0?[]:Fc(s,r).map(e).filter(o=>o)}}function av(i){const{intervals:e,tonic:t}=Jn(i),n=Tf(e,t);return s=>s?n(s>0?s-1:s):""}function lv(i){const{intervals:e,tonic:t}=Jn(i);return Tf(e,t)}var Ki={degrees:av,detect:tv,extended:Rm,get:Jn,modeNames:iv,names:J1,rangeOf:ov,reduced:sv,scaleChords:nv,scaleNotes:_m,steps:lv,tokenize:Qm,scale:ev};class Mn{constructor(e=!1){this.eventMap={},this.eventsSuspended=e==!0}addListener(e,t,n={}){if(typeof e=="string"&&e.length<1||e instanceof String&&e.length<1||typeof e!="string"&&!(e instanceof String)&&e!==Mn.ANY_EVENT)throw new TypeError("The 'event' parameter must be a string or EventEmitter.ANY_EVENT.");if(typeof t!="function")throw new TypeError("The callback must be a function.");const s=new du(e,this,t,n);return this.eventMap[e]||(this.eventMap[e]=[]),n.prepend?this.eventMap[e].unshift(s):this.eventMap[e].push(s),s}addOneTimeListener(e,t,n={}){n.remaining=1,this.addListener(e,t,n)}static get ANY_EVENT(){return Symbol.for("Any event")}hasListener(e,t){return e===void 0?this.eventMap[Mn.ANY_EVENT]&&this.eventMap[Mn.ANY_EVENT].length>0?!0:Object.entries(this.eventMap).some(([,n])=>n.length>0):this.eventMap[e]&&this.eventMap[e].length>0?t instanceof du?this.eventMap[e].filter(s=>s===t).length>0:typeof t=="function"?this.eventMap[e].filter(s=>s.callback===t).length>0:t==null:!1}get eventNames(){return Object.keys(this.eventMap)}getListeners(e){return this.eventMap[e]||[]}suspendEvent(e){this.getListeners(e).forEach(t=>{t.suspended=!0})}unsuspendEvent(e){this.getListeners(e).forEach(t=>{t.suspended=!1})}getListenerCount(e){return this.getListeners(e).length}emit(e,...t){if(typeof e!="string"&&!(e instanceof String))throw new TypeError("The 'event' parameter must be a string.");if(this.eventsSuspended)return;let n=[],s=this.eventMap[Mn.ANY_EVENT]||[];return this.eventMap[e]&&(s=s.concat(this.eventMap[e])),s.forEach(r=>{if(r.suspended)return;let o=[...t];Array.isArray(r.arguments)&&(o=o.concat(r.arguments)),r.remaining>0&&(n.push(r.callback.apply(r.context,o)),r.count++),--r.remaining<1&&r.remove()}),n}removeListener(e,t,n={}){if(e===void 0){this.eventMap={};return}else if(!this.eventMap[e])return;let s=this.eventMap[e].filter(r=>t&&r.callback!==t||n.remaining&&n.remaining!==r.remaining||n.context&&n.context!==r.context);s.length?this.eventMap[e]=s:delete this.eventMap[e]}async waitFor(e,t={}){return t.duration=parseInt(t.duration),(isNaN(t.duration)||t.duration<=0)&&(t.duration=1/0),new Promise((n,s)=>{let r,o=this.addListener(e,()=>{clearTimeout(r),n()},{remaining:1});t.duration!==1/0&&(r=setTimeout(()=>{o.remove(),s("The duration expired before the event was emitted.")},t.duration))})}get eventCount(){return Object.keys(this.eventMap).length}}class du{constructor(e,t,n,s={}){if(typeof e!="string"&&!(e instanceof String)&&e!==Mn.ANY_EVENT)throw new TypeError("The 'event' parameter must be a string or EventEmitter.ANY_EVENT.");if(!t)throw new ReferenceError("The 'target' parameter is mandatory.");if(typeof n!="function")throw new TypeError("The 'callback' must be a function.");s.arguments!==void 0&&!Array.isArray(s.arguments)&&(s.arguments=[s.arguments]),s=Object.assign({context:t,remaining:1/0,arguments:void 0,duration:1/0},s),s.duration!==1/0&&setTimeout(()=>this.remove(),s.duration),this.arguments=s.arguments,this.callback=n,this.context=s.context,this.count=0,this.event=e,this.remaining=parseInt(s.remaining)>=1?parseInt(s.remaining):1/0,this.suspended=!1,this.target=t}remove(){this.target.removeListener(this.event,this.callback,{context:this.context,remaining:this.remaining})}}/**
 * The `Enumerations` class contains enumerations and arrays of elements used throughout the
 * library. All its properties are static and should be referenced using the class name. For
 * example: `Enumerations.CHANNEL_MESSAGES`.
 *
 * @license Apache-2.0
 * @since 3.0.0
 */class I{static get MIDI_CHANNEL_MESSAGES(){return this.validation&&console.warn("The MIDI_CHANNEL_MESSAGES enum has been deprecated. Use the Enumerations.CHANNEL_MESSAGES enum instead."),I.CHANNEL_MESSAGES}static get CHANNEL_MESSAGES(){return{noteoff:8,noteon:9,keyaftertouch:10,controlchange:11,programchange:12,channelaftertouch:13,pitchbend:14}}static get CHANNEL_NUMBERS(){return[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]}static get MIDI_CHANNEL_NUMBERS(){return this.validation&&console.warn("The MIDI_CHANNEL_NUMBERS array has been deprecated. Use the Enumerations.CHANNEL_NUMBERS array instead."),[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]}static get CHANNEL_MODE_MESSAGES(){return{allsoundoff:120,resetallcontrollers:121,localcontrol:122,allnotesoff:123,omnimodeoff:124,omnimodeon:125,monomodeon:126,polymodeon:127}}static get MIDI_CHANNEL_MODE_MESSAGES(){return this.validation&&console.warn("The MIDI_CHANNEL_MODE_MESSAGES enum has been deprecated. Use the Enumerations.CHANNEL_MODE_MESSAGES enum instead."),I.CHANNEL_MODE_MESSAGES}static get MIDI_CONTROL_CHANGE_MESSAGES(){return this.validation&&console.warn("The MIDI_CONTROL_CHANGE_MESSAGES enum has been deprecated. Use the Enumerations.CONTROL_CHANGE_MESSAGES array instead."),{bankselectcoarse:0,modulationwheelcoarse:1,breathcontrollercoarse:2,controller3:3,footcontrollercoarse:4,portamentotimecoarse:5,dataentrycoarse:6,volumecoarse:7,balancecoarse:8,controller9:9,pancoarse:10,expressioncoarse:11,effectcontrol1coarse:12,effectcontrol2coarse:13,controller14:14,controller15:15,generalpurposeslider1:16,generalpurposeslider2:17,generalpurposeslider3:18,generalpurposeslider4:19,controller20:20,controller21:21,controller22:22,controller23:23,controller24:24,controller25:25,controller26:26,controller27:27,controller28:28,controller29:29,controller30:30,controller31:31,bankselectfine:32,modulationwheelfine:33,breathcontrollerfine:34,controller35:35,footcontrollerfine:36,portamentotimefine:37,dataentryfine:38,volumefine:39,balancefine:40,controller41:41,panfine:42,expressionfine:43,effectcontrol1fine:44,effectcontrol2fine:45,controller46:46,controller47:47,controller48:48,controller49:49,controller50:50,controller51:51,controller52:52,controller53:53,controller54:54,controller55:55,controller56:56,controller57:57,controller58:58,controller59:59,controller60:60,controller61:61,controller62:62,controller63:63,holdpedal:64,portamento:65,sustenutopedal:66,softpedal:67,legatopedal:68,hold2pedal:69,soundvariation:70,resonance:71,soundreleasetime:72,soundattacktime:73,brightness:74,soundcontrol6:75,soundcontrol7:76,soundcontrol8:77,soundcontrol9:78,soundcontrol10:79,generalpurposebutton1:80,generalpurposebutton2:81,generalpurposebutton3:82,generalpurposebutton4:83,controller84:84,controller85:85,controller86:86,controller87:87,controller88:88,controller89:89,controller90:90,reverblevel:91,tremololevel:92,choruslevel:93,celestelevel:94,phaserlevel:95,databuttonincrement:96,databuttondecrement:97,nonregisteredparametercoarse:98,nonregisteredparameterfine:99,registeredparametercoarse:100,registeredparameterfine:101,controller102:102,controller103:103,controller104:104,controller105:105,controller106:106,controller107:107,controller108:108,controller109:109,controller110:110,controller111:111,controller112:112,controller113:113,controller114:114,controller115:115,controller116:116,controller117:117,controller118:118,controller119:119,allsoundoff:120,resetallcontrollers:121,localcontrol:122,allnotesoff:123,omnimodeoff:124,omnimodeon:125,monomodeon:126,polymodeon:127}}static get CONTROL_CHANGE_MESSAGES(){return[{number:0,name:"bankselectcoarse",description:"Bank Select (Coarse)",position:"msb"},{number:1,name:"modulationwheelcoarse",description:"Modulation Wheel (Coarse)",position:"msb"},{number:2,name:"breathcontrollercoarse",description:"Breath Controller (Coarse)",position:"msb"},{number:3,name:"controller3",description:"Undefined",position:"msb"},{number:4,name:"footcontrollercoarse",description:"Foot Controller (Coarse)",position:"msb"},{number:5,name:"portamentotimecoarse",description:"Portamento Time (Coarse)",position:"msb"},{number:6,name:"dataentrycoarse",description:"Data Entry (Coarse)",position:"msb"},{number:7,name:"volumecoarse",description:"Channel Volume (Coarse)",position:"msb"},{number:8,name:"balancecoarse",description:"Balance (Coarse)",position:"msb"},{number:9,name:"controller9",description:"Controller 9 (Coarse)",position:"msb"},{number:10,name:"pancoarse",description:"Pan (Coarse)",position:"msb"},{number:11,name:"expressioncoarse",description:"Expression Controller (Coarse)",position:"msb"},{number:12,name:"effectcontrol1coarse",description:"Effect Control 1 (Coarse)",position:"msb"},{number:13,name:"effectcontrol2coarse",description:"Effect Control 2 (Coarse)",position:"msb"},{number:14,name:"controller14",description:"Undefined",position:"msb"},{number:15,name:"controller15",description:"Undefined",position:"msb"},{number:16,name:"generalpurposecontroller1",description:"General Purpose Controller 1 (Coarse)",position:"msb"},{number:17,name:"generalpurposecontroller2",description:"General Purpose Controller 2 (Coarse)",position:"msb"},{number:18,name:"generalpurposecontroller3",description:"General Purpose Controller 3 (Coarse)",position:"msb"},{number:19,name:"generalpurposecontroller4",description:"General Purpose Controller 4 (Coarse)",position:"msb"},{number:20,name:"controller20",description:"Undefined",position:"msb"},{number:21,name:"controller21",description:"Undefined",position:"msb"},{number:22,name:"controller22",description:"Undefined",position:"msb"},{number:23,name:"controller23",description:"Undefined",position:"msb"},{number:24,name:"controller24",description:"Undefined",position:"msb"},{number:25,name:"controller25",description:"Undefined",position:"msb"},{number:26,name:"controller26",description:"Undefined",position:"msb"},{number:27,name:"controller27",description:"Undefined",position:"msb"},{number:28,name:"controller28",description:"Undefined",position:"msb"},{number:29,name:"controller29",description:"Undefined",position:"msb"},{number:30,name:"controller30",description:"Undefined",position:"msb"},{number:31,name:"controller31",description:"Undefined",position:"msb"},{number:32,name:"bankselectfine",description:"Bank Select (Fine)",position:"lsb"},{number:33,name:"modulationwheelfine",description:"Modulation Wheel (Fine)",position:"lsb"},{number:34,name:"breathcontrollerfine",description:"Breath Controller (Fine)",position:"lsb"},{number:35,name:"controller35",description:"Undefined",position:"lsb"},{number:36,name:"footcontrollerfine",description:"Foot Controller (Fine)",position:"lsb"},{number:37,name:"portamentotimefine",description:"Portamento Time (Fine)",position:"lsb"},{number:38,name:"dataentryfine",description:"Data Entry (Fine)",position:"lsb"},{number:39,name:"channelvolumefine",description:"Channel Volume (Fine)",position:"lsb"},{number:40,name:"balancefine",description:"Balance (Fine)",position:"lsb"},{number:41,name:"controller41",description:"Undefined",position:"lsb"},{number:42,name:"panfine",description:"Pan (Fine)",position:"lsb"},{number:43,name:"expressionfine",description:"Expression Controller (Fine)",position:"lsb"},{number:44,name:"effectcontrol1fine",description:"Effect control 1 (Fine)",position:"lsb"},{number:45,name:"effectcontrol2fine",description:"Effect control 2 (Fine)",position:"lsb"},{number:46,name:"controller46",description:"Undefined",position:"lsb"},{number:47,name:"controller47",description:"Undefined",position:"lsb"},{number:48,name:"controller48",description:"General Purpose Controller 1 (Fine)",position:"lsb"},{number:49,name:"controller49",description:"General Purpose Controller 2 (Fine)",position:"lsb"},{number:50,name:"controller50",description:"General Purpose Controller 3 (Fine)",position:"lsb"},{number:51,name:"controller51",description:"General Purpose Controller 4 (Fine)",position:"lsb"},{number:52,name:"controller52",description:"Undefined",position:"lsb"},{number:53,name:"controller53",description:"Undefined",position:"lsb"},{number:54,name:"controller54",description:"Undefined",position:"lsb"},{number:55,name:"controller55",description:"Undefined",position:"lsb"},{number:56,name:"controller56",description:"Undefined",position:"lsb"},{number:57,name:"controller57",description:"Undefined",position:"lsb"},{number:58,name:"controller58",description:"Undefined",position:"lsb"},{number:59,name:"controller59",description:"Undefined",position:"lsb"},{number:60,name:"controller60",description:"Undefined",position:"lsb"},{number:61,name:"controller61",description:"Undefined",position:"lsb"},{number:62,name:"controller62",description:"Undefined",position:"lsb"},{number:63,name:"controller63",description:"Undefined",position:"lsb"},{number:64,name:"damperpedal",description:"Damper Pedal On/Off"},{number:65,name:"portamento",description:"Portamento On/Off"},{number:66,name:"sostenuto",description:"Sostenuto On/Off"},{number:67,name:"softpedal",description:"Soft Pedal On/Off"},{number:68,name:"legatopedal",description:"Legato Pedal On/Off"},{number:69,name:"hold2",description:"Hold 2 On/Off"},{number:70,name:"soundvariation",description:"Sound Variation",position:"lsb"},{number:71,name:"resonance",description:"Resonance",position:"lsb"},{number:72,name:"releasetime",description:"Release Time",position:"lsb"},{number:73,name:"attacktime",description:"Attack Time",position:"lsb"},{number:74,name:"brightness",description:"Brightness",position:"lsb"},{number:75,name:"decaytime",description:"Decay Time",position:"lsb"},{number:76,name:"vibratorate",description:"Vibrato Rate",position:"lsb"},{number:77,name:"vibratodepth",description:"Vibrato Depth",position:"lsb"},{number:78,name:"vibratodelay",description:"Vibrato Delay",position:"lsb"},{number:79,name:"controller79",description:"Undefined",position:"lsb"},{number:80,name:"generalpurposecontroller5",description:"General Purpose Controller 5",position:"lsb"},{number:81,name:"generalpurposecontroller6",description:"General Purpose Controller 6",position:"lsb"},{number:82,name:"generalpurposecontroller7",description:"General Purpose Controller 7",position:"lsb"},{number:83,name:"generalpurposecontroller8",description:"General Purpose Controller 8",position:"lsb"},{number:84,name:"portamentocontrol",description:"Portamento Control",position:"lsb"},{number:85,name:"controller85",description:"Undefined"},{number:86,name:"controller86",description:"Undefined"},{number:87,name:"controller87",description:"Undefined"},{number:88,name:"highresolutionvelocityprefix",description:"High Resolution Velocity Prefix",position:"lsb"},{number:89,name:"controller89",description:"Undefined"},{number:90,name:"controller90",description:"Undefined"},{number:91,name:"effect1depth",description:"Effects 1 Depth (Reverb Send Level)"},{number:92,name:"effect2depth",description:"Effects 2 Depth"},{number:93,name:"effect3depth",description:"Effects 3 Depth (Chorus Send Level)"},{number:94,name:"effect4depth",description:"Effects 4 Depth"},{number:95,name:"effect5depth",description:"Effects 5 Depth"},{number:96,name:"dataincrement",description:"Data Increment"},{number:97,name:"datadecrement",description:"Data Decrement"},{number:98,name:"nonregisteredparameterfine",description:"Non-Registered Parameter Number (Fine)",position:"lsb"},{number:99,name:"nonregisteredparametercoarse",description:"Non-Registered Parameter Number (Coarse)",position:"msb"},{number:100,name:"registeredparameterfine",description:"Registered Parameter Number (Fine)",position:"lsb"},{number:101,name:"registeredparametercoarse",description:"Registered Parameter Number (Coarse)",position:"msb"},{number:102,name:"controller102",description:"Undefined"},{number:103,name:"controller103",description:"Undefined"},{number:104,name:"controller104",description:"Undefined"},{number:105,name:"controller105",description:"Undefined"},{number:106,name:"controller106",description:"Undefined"},{number:107,name:"controller107",description:"Undefined"},{number:108,name:"controller108",description:"Undefined"},{number:109,name:"controller109",description:"Undefined"},{number:110,name:"controller110",description:"Undefined"},{number:111,name:"controller111",description:"Undefined"},{number:112,name:"controller112",description:"Undefined"},{number:113,name:"controller113",description:"Undefined"},{number:114,name:"controller114",description:"Undefined"},{number:115,name:"controller115",description:"Undefined"},{number:116,name:"controller116",description:"Undefined"},{number:117,name:"controller117",description:"Undefined"},{number:118,name:"controller118",description:"Undefined"},{number:119,name:"controller119",description:"Undefined"},{number:120,name:"allsoundoff",description:"All Sound Off"},{number:121,name:"resetallcontrollers",description:"Reset All Controllers"},{number:122,name:"localcontrol",description:"Local Control On/Off"},{number:123,name:"allnotesoff",description:"All Notes Off"},{number:124,name:"omnimodeoff",description:"Omni Mode Off"},{number:125,name:"omnimodeon",description:"Omni Mode On"},{number:126,name:"monomodeon",description:"Mono Mode On"},{number:127,name:"polymodeon",description:"Poly Mode On"}]}static get REGISTERED_PARAMETERS(){return{pitchbendrange:[0,0],channelfinetuning:[0,1],channelcoarsetuning:[0,2],tuningprogram:[0,3],tuningbank:[0,4],modulationrange:[0,5],azimuthangle:[61,0],elevationangle:[61,1],gain:[61,2],distanceratio:[61,3],maximumdistance:[61,4],maximumdistancegain:[61,5],referencedistanceratio:[61,6],panspreadangle:[61,7],rollangle:[61,8]}}static get MIDI_REGISTERED_PARAMETERS(){return this.validation&&console.warn("The MIDI_REGISTERED_PARAMETERS enum has been deprecated. Use the Enumerations.REGISTERED_PARAMETERS enum instead."),I.MIDI_REGISTERED_PARAMETERS}static get SYSTEM_MESSAGES(){return{sysex:240,timecode:241,songposition:242,songselect:243,tunerequest:246,tuningrequest:246,sysexend:247,clock:248,start:250,continue:251,stop:252,activesensing:254,reset:255,midimessage:0,unknownsystemmessage:-1}}static get MIDI_SYSTEM_MESSAGES(){return this.validation&&console.warn("The MIDI_SYSTEM_MESSAGES enum has been deprecated. Use the Enumerations.SYSTEM_MESSAGES enum instead."),I.SYSTEM_MESSAGES}static get CHANNEL_EVENTS(){return["noteoff","controlchange","noteon","keyaftertouch","programchange","channelaftertouch","pitchbend","allnotesoff","allsoundoff","localcontrol","monomode","omnimode","resetallcontrollers","nrpn","nrpn-dataentrycoarse","nrpn-dataentryfine","nrpn-dataincrement","nrpn-datadecrement","rpn","rpn-dataentrycoarse","rpn-dataentryfine","rpn-dataincrement","rpn-datadecrement","nrpn-databuttonincrement","nrpn-databuttondecrement","rpn-databuttonincrement","rpn-databuttondecrement"]}}/**
 * The `Note` class represents a single musical note such as `"D3"`, `"G#4"`, `"F-1"`, `"Gb7"`, etc.
 *
 * `Note` objects can be played back on a single channel by calling
 * [`OutputChannel.playNote()`]{@link OutputChannel#playNote} or, on multiple channels of the same
 * output, by calling [`Output.playNote()`]{@link Output#playNote}.
 *
 * The note has [`attack`](#attack) and [`release`](#release) velocities set at `0.5` by default.
 * These can be changed by passing in the appropriate option. It is also possible to set a
 * system-wide default for attack and release velocities by using the
 * [`WebMidi.defaults`](WebMidi#defaults) property.
 *
 * If you prefer to work with raw MIDI values (`0` to `127`), you can use [`rawAttack`](#rawAttack) and
 * [`rawRelease`](#rawRelease) to both get and set the values.
 *
 * The note may have a [`duration`](#duration). If it does, playback will be automatically stopped
 * when the duration has elapsed by sending a `"noteoff"` event. By default, the duration is set to
 * `Infinity`. In this case, it will never stop playing unless explicitly stopped by calling a
 * method such as [`OutputChannel.stopNote()`]{@link OutputChannel#stopNote},
 * [`Output.stopNote()`]{@link Output#stopNote} or similar.
 *
 * @license Apache-2.0
 * @since 3.0.0
 */class Ls{constructor(e,t={}){this.duration=Y.defaults.note.duration,this.attack=Y.defaults.note.attack,this.release=Y.defaults.note.release,t.duration!=null&&(this.duration=t.duration),t.attack!=null&&(this.attack=t.attack),t.rawAttack!=null&&(this.attack=K.from7bitToFloat(t.rawAttack)),t.release!=null&&(this.release=t.release),t.rawRelease!=null&&(this.release=K.from7bitToFloat(t.rawRelease)),Number.isInteger(e)?this.identifier=K.toNoteIdentifier(e):this.identifier=e}get identifier(){return this._name+(this._accidental||"")+this._octave}set identifier(e){const t=K.getNoteDetails(e);if(Y.validation&&!e)throw new Error("Invalid note identifier");this._name=t.name,this._accidental=t.accidental,this._octave=t.octave}get name(){return this._name}set name(e){if(Y.validation&&(e=e.toUpperCase(),!["C","D","E","F","G","A","B"].includes(e)))throw new Error("Invalid name value");this._name=e}get accidental(){return this._accidental}set accidental(e){if(Y.validation&&(e=e.toLowerCase(),!["#","##","b","bb"].includes(e)))throw new Error("Invalid accidental value");this._accidental=e}get octave(){return this._octave}set octave(e){if(Y.validation&&(e=parseInt(e),isNaN(e)))throw new Error("Invalid octave value");this._octave=e}get duration(){return this._duration}set duration(e){if(Y.validation&&(e=parseFloat(e),isNaN(e)||e===null||e<0))throw new RangeError("Invalid duration value.");this._duration=e}get attack(){return this._attack}set attack(e){if(Y.validation&&(e=parseFloat(e),isNaN(e)||!(e>=0&&e<=1)))throw new RangeError("Invalid attack value.");this._attack=e}get release(){return this._release}set release(e){if(Y.validation&&(e=parseFloat(e),isNaN(e)||!(e>=0&&e<=1)))throw new RangeError("Invalid release value.");this._release=e}get rawAttack(){return K.fromFloatTo7Bit(this._attack)}set rawAttack(e){this._attack=K.from7bitToFloat(e)}get rawRelease(){return K.fromFloatTo7Bit(this._release)}set rawRelease(e){this._release=K.from7bitToFloat(e)}get number(){return K.toNoteNumber(this.identifier)}getOffsetNumber(e=0,t=0){return Y.validation&&(e=parseInt(e)||0,t=parseInt(t)||0),Math.min(Math.max(this.number+e*12+t,0),127)}}/**
 * The `Utilities` class contains general-purpose utility methods. All methods are static and
 * should be called using the class name. For example: `Utilities.getNoteDetails("C4")`.
 *
 * @license Apache-2.0
 * @since 3.0.0
 */class K{static toNoteNumber(e,t=0){if(t=t==null?0:parseInt(t),isNaN(t))throw new RangeError("Invalid 'octaveOffset' value");typeof e!="string"&&(e="");const n=this.getNoteDetails(e);if(!n)throw new TypeError("Invalid note identifier");const s={C:0,D:2,E:4,F:5,G:7,A:9,B:11};let r=(n.octave+1+t)*12;if(r+=s[n.name],n.accidental&&(n.accidental.startsWith("b")?r-=n.accidental.length:r+=n.accidental.length),r<0||r>127)throw new RangeError("Invalid octaveOffset value");return r}static getNoteDetails(e){Number.isInteger(e)&&(e=this.toNoteIdentifier(e));const t=e.match(/^([CDEFGAB])(#{0,2}|b{0,2})(-?\d+)$/i);if(!t)throw new TypeError("Invalid note identifier");const n=t[1].toUpperCase(),s=parseInt(t[3]);let r=t[2].toLowerCase();return r=r===""?void 0:r,{accidental:r,identifier:n+(r||"")+s,name:n,octave:s}}static sanitizeChannels(e){let t;if(Y.validation){if(e==="all")t=["all"];else if(e==="none")return[]}return Array.isArray(e)?t=e:t=[e],t.indexOf("all")>-1&&(t=I.MIDI_CHANNEL_NUMBERS),t.map(function(n){return parseInt(n)}).filter(function(n){return n>=1&&n<=16})}static toTimestamp(e){let t=!1;const n=parseFloat(e);return isNaN(n)?!1:(typeof e=="string"&&e.substring(0,1)==="+"?n>=0&&(t=Y.time+n):n>=0&&(t=n),t)}static guessNoteNumber(e,t){t=parseInt(t)||0;let n=!1;if(Number.isInteger(e)&&e>=0&&e<=127)n=parseInt(e);else if(parseInt(e)>=0&&parseInt(e)<=127)n=parseInt(e);else if(typeof e=="string"||e instanceof String)try{n=this.toNoteNumber(e.trim(),t)}catch{return!1}return n}static toNoteIdentifier(e,t){if(e=parseInt(e),isNaN(e)||e<0||e>127)throw new RangeError("Invalid note number");if(t=t==null?0:parseInt(t),isNaN(t))throw new RangeError("Invalid octaveOffset value");const n=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],s=Math.floor(e/12-1)+t;return n[e%12]+s.toString()}static buildNote(e,t={}){if(t.octaveOffset=parseInt(t.octaveOffset)||0,e instanceof Ls)return e;let n=this.guessNoteNumber(e,t.octaveOffset);if(n===!1)throw new TypeError(`The input could not be parsed as a note (${e})`);return t.octaveOffset=void 0,new Ls(n,t)}static buildNoteArray(e,t={}){let n=[];return Array.isArray(e)||(e=[e]),e.forEach(s=>{n.push(this.buildNote(s,t))}),n}static from7bitToFloat(e){return e===1/0&&(e=127),e=parseInt(e)||0,Math.min(Math.max(e/127,0),1)}static fromFloatTo7Bit(e){return e===1/0&&(e=1),e=parseFloat(e)||0,Math.min(Math.max(Math.round(e*127),0),127)}static fromMsbLsbToFloat(e,t=0){Y.validation&&(e=Math.min(Math.max(parseInt(e)||0,0),127),t=Math.min(Math.max(parseInt(t)||0,0),127));const n=((e<<7)+t)/16383;return Math.min(Math.max(n,0),1)}static fromFloatToMsbLsb(e){Y.validation&&(e=Math.min(Math.max(parseFloat(e)||0,0),1));const t=Math.round(e*16383);return{msb:t>>7,lsb:t&127}}static offsetNumber(e,t=0,n=0){if(Y.validation){if(e=parseInt(e),isNaN(e))throw new Error("Invalid note number");t=parseInt(t)||0,n=parseInt(n)||0}return Math.min(Math.max(e+t*12+n,0),127)}static getPropertyByValue(e,t){return Object.keys(e).find(n=>e[n]===t)}static getCcNameByNumber(e){if(!(Y.validation&&(e=parseInt(e),!(e>=0&&e<=127))))return I.CONTROL_CHANGE_MESSAGES[e].name}static getCcNumberByName(e){let t=I.CONTROL_CHANGE_MESSAGES.find(n=>n.name===e);return t?t.number:I.MIDI_CONTROL_CHANGE_MESSAGES[e]}static getChannelModeByNumber(e){if(!(e>=120&&e<=127))return!1;for(let t in I.CHANNEL_MODE_MESSAGES)if(I.CHANNEL_MODE_MESSAGES.hasOwnProperty(t)&&e===I.CHANNEL_MODE_MESSAGES[t])return t;return!1}static get isNode(){return typeof process<"u"&&process.versions!=null&&process.versions.node!=null}static get isBrowser(){return typeof window<"u"&&typeof window.document<"u"}}/**
 * The `OutputChannel` class represents a single output MIDI channel. `OutputChannel` objects are
 * provided by an [`Output`](Output) port which, itself, is made available by a device. The
 * `OutputChannel` object is derived from the host's MIDI subsystem and should not be instantiated
 * directly.
 *
 * All 16 `OutputChannel` objects can be found inside the parent output's
 * [`channels`]{@link Output#channels} property.
 *
 * @param {Output} output The [`Output`](Output) this channel belongs to.
 * @param {number} number The MIDI channel number (`1` - `16`).
 *
 * @extends EventEmitter
 * @license Apache-2.0
 * @since 3.0.0
 */class Im extends Mn{constructor(e,t){super(),this._output=e,this._number=t,this._octaveOffset=0}destroy(){this._output=null,this._number=null,this._octaveOffset=0,this.removeListener()}send(e,t={time:0}){return this.output.send(e,t),this}sendKeyAftertouch(e,t,n={}){if(Y.validation){if(n.useRawValue&&(n.rawValue=n.useRawValue),isNaN(parseFloat(t)))throw new RangeError("Invalid key aftertouch value.");if(n.rawValue){if(!(t>=0&&t<=127&&Number.isInteger(t)))throw new RangeError("Key aftertouch raw value must be an integer between 0 and 127.")}else if(!(t>=0&&t<=1))throw new RangeError("Key aftertouch value must be a float between 0 and 1.")}n.rawValue||(t=K.fromFloatTo7Bit(t));const s=Y.octaveOffset+this.output.octaveOffset+this.octaveOffset;return Array.isArray(e)||(e=[e]),K.buildNoteArray(e).forEach(r=>{this.send([(I.CHANNEL_MESSAGES.keyaftertouch<<4)+(this.number-1),r.getOffsetNumber(s),t],{time:K.toTimestamp(n.time)})}),this}sendControlChange(e,t,n={}){if(typeof e=="string"&&(e=K.getCcNumberByName(e)),Array.isArray(t)||(t=[t]),Y.validation){if(e===void 0)throw new TypeError("Control change must be identified with a valid name or an integer between 0 and 127.");if(!Number.isInteger(e)||!(e>=0&&e<=127))throw new TypeError("Control change number must be an integer between 0 and 127.");if(t=t.map(s=>{const r=Math.min(Math.max(parseInt(s),0),127);if(isNaN(r))throw new TypeError("Values must be integers between 0 and 127");return r}),t.length===2&&e>=32)throw new TypeError("To use a value array, the controller must be between 0 and 31")}return t.forEach((s,r)=>{this.send([(I.CHANNEL_MESSAGES.controlchange<<4)+(this.number-1),e+r*32,t[r]],{time:K.toTimestamp(n.time)})}),this}_selectNonRegisteredParameter(e,t={}){return this.sendControlChange(99,e[0],t),this.sendControlChange(98,e[1],t),this}_deselectRegisteredParameter(e={}){return this.sendControlChange(101,127,e),this.sendControlChange(100,127,e),this}_deselectNonRegisteredParameter(e={}){return this.sendControlChange(101,127,e),this.sendControlChange(100,127,e),this}_selectRegisteredParameter(e,t={}){return this.sendControlChange(101,e[0],t),this.sendControlChange(100,e[1],t),this}_setCurrentParameter(e,t={}){return e=[].concat(e),this.sendControlChange(6,e[0],t),e.length<2?this:(this.sendControlChange(38,e[1],t),this)}sendRpnDecrement(e,t={}){if(Array.isArray(e)||(e=I.REGISTERED_PARAMETERS[e]),Y.validation){if(e===void 0)throw new TypeError("The specified registered parameter is invalid.");let n=!1;if(Object.getOwnPropertyNames(I.REGISTERED_PARAMETERS).forEach(s=>{I.REGISTERED_PARAMETERS[s][0]===e[0]&&I.REGISTERED_PARAMETERS[s][1]===e[1]&&(n=!0)}),!n)throw new TypeError("The specified registered parameter is invalid.")}return this._selectRegisteredParameter(e,t),this.sendControlChange(97,0,t),this._deselectRegisteredParameter(t),this}sendRpnIncrement(e,t={}){if(Array.isArray(e)||(e=I.REGISTERED_PARAMETERS[e]),Y.validation){if(e===void 0)throw new TypeError("The specified registered parameter is invalid.");let n=!1;if(Object.getOwnPropertyNames(I.REGISTERED_PARAMETERS).forEach(s=>{I.REGISTERED_PARAMETERS[s][0]===e[0]&&I.REGISTERED_PARAMETERS[s][1]===e[1]&&(n=!0)}),!n)throw new TypeError("The specified registered parameter is invalid.")}return this._selectRegisteredParameter(e,t),this.sendControlChange(96,0,t),this._deselectRegisteredParameter(t),this}playNote(e,t={}){this.sendNoteOn(e,t);const n=Array.isArray(e)?e:[e];for(let s of n)if(parseInt(s.duration)>0){const r={time:(K.toTimestamp(t.time)||Y.time)+parseInt(s.duration),release:s.release,rawRelease:s.rawRelease};this.sendNoteOff(s,r)}else if(parseInt(t.duration)>0){const r={time:(K.toTimestamp(t.time)||Y.time)+parseInt(t.duration),release:t.release,rawRelease:t.rawRelease};this.sendNoteOff(s,r)}return this}sendNoteOff(e,t={}){if(Y.validation){if(t.rawRelease!=null&&!(t.rawRelease>=0&&t.rawRelease<=127))throw new RangeError("The 'rawRelease' option must be an integer between 0 and 127");if(t.release!=null&&!(t.release>=0&&t.release<=1))throw new RangeError("The 'release' option must be an number between 0 and 1");t.rawVelocity&&(t.rawRelease=t.velocity,console.warn("The 'rawVelocity' option is deprecated. Use 'rawRelease' instead.")),t.velocity&&(t.release=t.velocity,console.warn("The 'velocity' option is deprecated. Use 'attack' instead."))}let n=64;t.rawRelease!=null?n=t.rawRelease:isNaN(t.release)||(n=Math.round(t.release*127));const s=Y.octaveOffset+this.output.octaveOffset+this.octaveOffset;return K.buildNoteArray(e,{rawRelease:parseInt(n)}).forEach(r=>{this.send([(I.CHANNEL_MESSAGES.noteoff<<4)+(this.number-1),r.getOffsetNumber(s),r.rawRelease],{time:K.toTimestamp(t.time)})}),this}stopNote(e,t={}){return this.sendNoteOff(e,t)}sendNoteOn(e,t={}){if(Y.validation){if(t.rawAttack!=null&&!(t.rawAttack>=0&&t.rawAttack<=127))throw new RangeError("The 'rawAttack' option must be an integer between 0 and 127");if(t.attack!=null&&!(t.attack>=0&&t.attack<=1))throw new RangeError("The 'attack' option must be an number between 0 and 1");t.rawVelocity&&(t.rawAttack=t.velocity,t.rawRelease=t.release,console.warn("The 'rawVelocity' option is deprecated. Use 'rawAttack' or 'rawRelease'.")),t.velocity&&(t.attack=t.velocity,console.warn("The 'velocity' option is deprecated. Use 'attack' instead."))}let n=64;t.rawAttack!=null?n=t.rawAttack:isNaN(t.attack)||(n=Math.round(t.attack*127));const s=Y.octaveOffset+this.output.octaveOffset+this.octaveOffset;return K.buildNoteArray(e,{rawAttack:n}).forEach(r=>{this.send([(I.CHANNEL_MESSAGES.noteon<<4)+(this.number-1),r.getOffsetNumber(s),r.rawAttack],{time:K.toTimestamp(t.time)})}),this}sendChannelMode(e,t=0,n={}){if(typeof e=="string"&&(e=I.CHANNEL_MODE_MESSAGES[e]),Y.validation){if(e===void 0)throw new TypeError("Invalid channel mode message name or number.");if(isNaN(e)||!(e>=120&&e<=127))throw new TypeError("Invalid channel mode message number.");if(isNaN(parseInt(t))||t<0||t>127)throw new RangeError("Value must be an integer between 0 and 127.")}return this.send([(I.CHANNEL_MESSAGES.controlchange<<4)+(this.number-1),e,t],{time:K.toTimestamp(n.time)}),this}sendOmniMode(e,t={}){return e===void 0||e?this.sendChannelMode("omnimodeon",0,t):this.sendChannelMode("omnimodeoff",0,t),this}sendChannelAftertouch(e,t={}){if(Y.validation){if(isNaN(parseFloat(e)))throw new RangeError("Invalid channel aftertouch value.");if(t.rawValue){if(!(e>=0&&e<=127&&Number.isInteger(e)))throw new RangeError("Channel aftertouch raw value must be an integer between 0 and 127.")}else if(!(e>=0&&e<=1))throw new RangeError("Channel aftertouch value must be a float between 0 and 1.")}return t.rawValue||(e=K.fromFloatTo7Bit(e)),this.send([(I.CHANNEL_MESSAGES.channelaftertouch<<4)+(this.number-1),Math.round(e)],{time:K.toTimestamp(t.time)}),this}sendMasterTuning(e,t={}){if(e=parseFloat(e)||0,Y.validation&&!(e>-65&&e<64))throw new RangeError("The value must be a decimal number larger than -65 and smaller than 64.");let n=Math.floor(e)+64,s=e-Math.floor(e);s=Math.round((s+1)/2*16383);let r=s>>7&127,o=s&127;return this.sendRpnValue("channelcoarsetuning",n,t),this.sendRpnValue("channelfinetuning",[r,o],t),this}sendModulationRange(e,t,n={}){if(Y.validation){if(!Number.isInteger(e)||!(e>=0&&e<=127))throw new RangeError("The semitones value must be an integer between 0 and 127.");if(t!=null&&(!Number.isInteger(t)||!(t>=0&&t<=127)))throw new RangeError("If specified, the cents value must be an integer between 0 and 127.")}return t>=0&&t<=127||(t=0),this.sendRpnValue("modulationrange",[e,t],n),this}sendNrpnValue(e,t,n={}){if(t=[].concat(t),Y.validation){if(!Array.isArray(e)||!Number.isInteger(e[0])||!Number.isInteger(e[1]))throw new TypeError("The specified NRPN is invalid.");if(!(e[0]>=0&&e[0]<=127))throw new RangeError("The first byte of the NRPN must be between 0 and 127.");if(!(e[1]>=0&&e[1]<=127))throw new RangeError("The second byte of the NRPN must be between 0 and 127.");t.forEach(s=>{if(!(s>=0&&s<=127))throw new RangeError("The data bytes of the NRPN must be between 0 and 127.")})}return this._selectNonRegisteredParameter(e,n),this._setCurrentParameter(t,n),this._deselectNonRegisteredParameter(n),this}sendPitchBend(e,t={}){if(Y.validation)if(t.rawValue&&Array.isArray(e)){if(!(e[0]>=0&&e[0]<=127))throw new RangeError("The pitch bend MSB must be an integer between 0 and 127.");if(!(e[1]>=0&&e[1]<=127))throw new RangeError("The pitch bend LSB must be an integer between 0 and 127.")}else if(t.rawValue&&!Array.isArray(e)){if(!(e>=0&&e<=127))throw new RangeError("The pitch bend MSB must be an integer between 0 and 127.")}else{if(isNaN(e)||e===null)throw new RangeError("Invalid pitch bend value.");if(!(e>=-1&&e<=1))throw new RangeError("The pitch bend value must be a float between -1 and 1.")}let n=0,s=0;if(t.rawValue&&Array.isArray(e))n=e[0],s=e[1];else if(t.rawValue&&!Array.isArray(e))n=e;else{const r=K.fromFloatToMsbLsb((e+1)/2);n=r.msb,s=r.lsb}return this.send([(I.CHANNEL_MESSAGES.pitchbend<<4)+(this.number-1),s,n],{time:K.toTimestamp(t.time)}),this}sendPitchBendRange(e,t,n={}){if(Y.validation){if(!Number.isInteger(e)||!(e>=0&&e<=127))throw new RangeError("The semitones value must be an integer between 0 and 127.");if(!Number.isInteger(t)||!(t>=0&&t<=127))throw new RangeError("The cents value must be an integer between 0 and 127.")}return this.sendRpnValue("pitchbendrange",[e,t],n),this}sendProgramChange(e,t={}){if(e=parseInt(e)||0,Y.validation&&!(e>=0&&e<=127))throw new RangeError("The program number must be between 0 and 127.");return this.send([(I.CHANNEL_MESSAGES.programchange<<4)+(this.number-1),e],{time:K.toTimestamp(t.time)}),this}sendRpnValue(e,t,n={}){if(Array.isArray(e)||(e=I.REGISTERED_PARAMETERS[e]),Y.validation){if(!Number.isInteger(e[0])||!Number.isInteger(e[1]))throw new TypeError("The specified NRPN is invalid.");if(!(e[0]>=0&&e[0]<=127))throw new RangeError("The first byte of the RPN must be between 0 and 127.");if(!(e[1]>=0&&e[1]<=127))throw new RangeError("The second byte of the RPN must be between 0 and 127.");[].concat(t).forEach(s=>{if(!(s>=0&&s<=127))throw new RangeError("The data bytes of the RPN must be between 0 and 127.")})}return this._selectRegisteredParameter(e,n),this._setCurrentParameter(t,n),this._deselectRegisteredParameter(n),this}sendTuningBank(e,t={}){if(Y.validation&&(!Number.isInteger(e)||!(e>=0&&e<=127)))throw new RangeError("The tuning bank number must be between 0 and 127.");return this.sendRpnValue("tuningbank",e,t),this}sendTuningProgram(e,t={}){if(Y.validation&&(!Number.isInteger(e)||!(e>=0&&e<=127)))throw new RangeError("The tuning program number must be between 0 and 127.");return this.sendRpnValue("tuningprogram",e,t),this}sendLocalControl(e,t={}){return e?this.sendChannelMode("localcontrol",127,t):this.sendChannelMode("localcontrol",0,t)}sendAllNotesOff(e={}){return this.sendChannelMode("allnotesoff",0,e)}sendAllSoundOff(e={}){return this.sendChannelMode("allsoundoff",0,e)}sendResetAllControllers(e={}){return this.sendChannelMode("resetallcontrollers",0,e)}sendPolyphonicMode(e,t={}){return e==="mono"?this.sendChannelMode("monomodeon",0,t):this.sendChannelMode("polymodeon",0,t)}get octaveOffset(){return this._octaveOffset}set octaveOffset(e){if(this.validation&&(e=parseInt(e),isNaN(e)))throw new TypeError("The 'octaveOffset' property must be an integer.");this._octaveOffset=e}get output(){return this._output}get number(){return this._number}}/**
 * The `Output` class represents a single MIDI output port (not to be confused with a MIDI channel).
 * A port is made available by a MIDI device. A MIDI device can advertise several input and output
 * ports. Each port has 16 MIDI channels which can be accessed via the [`channels`](#channels)
 * property.
 *
 * The `Output` object is automatically instantiated by the library according to the host's MIDI
 * subsystem and should not be directly instantiated.
 *
 * You can access all available `Output` objects by referring to the
 * [`WebMidi.outputs`](WebMidi#outputs) array or by using methods such as
 * [`WebMidi.getOutputByName()`](WebMidi#getOutputByName) or
 * [`WebMidi.getOutputById()`](WebMidi#getOutputById).
 *
 * @fires Output#opened
 * @fires Output#disconnected
 * @fires Output#closed
 *
 * @extends EventEmitter
 * @license Apache-2.0
 */class Ao extends Mn{constructor(e){super(),this._midiOutput=e,this._octaveOffset=0,this.channels=[];for(let t=1;t<=16;t++)this.channels[t]=new Im(this,t);this._midiOutput.onstatechange=this._onStateChange.bind(this)}async destroy(){this.removeListener(),this.channels.forEach(e=>e.destroy()),this.channels=[],this._midiOutput&&(this._midiOutput.onstatechange=null),await this.close(),this._midiOutput=null}_onStateChange(e){let t={timestamp:Y.time};e.port.connection==="open"?(t.type="opened",t.target=this,t.port=t.target,this.emit("opened",t)):e.port.connection==="closed"&&e.port.state==="connected"?(t.type="closed",t.target=this,t.port=t.target,this.emit("closed",t)):e.port.connection==="closed"&&e.port.state==="disconnected"?(t.type="disconnected",t.port={connection:e.port.connection,id:e.port.id,manufacturer:e.port.manufacturer,name:e.port.name,state:e.port.state,type:e.port.type},this.emit("disconnected",t)):e.port.connection==="pending"&&e.port.state==="disconnected"||console.warn("This statechange event was not caught:",e.port.connection,e.port.state)}async open(){try{return await this._midiOutput.open(),Promise.resolve(this)}catch(e){return Promise.reject(e)}}async close(){this._midiOutput?await this._midiOutput.close():await Promise.resolve()}send(e,t={time:0},n=0){if(e instanceof od&&(e=K.isNode?e.data:e.rawData),e instanceof Uint8Array&&K.isNode&&(e=Array.from(e)),Y.validation){if(!Array.isArray(e)&&!(e instanceof Uint8Array)&&(e=[e],Array.isArray(t)&&(e=e.concat(t)),t=isNaN(n)?{time:0}:{time:n}),!(parseInt(e[0])>=128&&parseInt(e[0])<=255))throw new RangeError("The first byte (status) must be an integer between 128 and 255.");e.slice(1).forEach(s=>{if(s=parseInt(s),!(s>=0&&s<=255))throw new RangeError("Data bytes must be integers between 0 and 255.")}),t||(t={time:0})}return this._midiOutput.send(e,K.toTimestamp(t.time)),this}sendSysex(e,t=[],n={}){if(e=[].concat(e),t instanceof Uint8Array){const s=new Uint8Array(1+e.length+t.length+1);s[0]=I.SYSTEM_MESSAGES.sysex,s.set(Uint8Array.from(e),1),s.set(t,1+e.length),s[s.length-1]=I.SYSTEM_MESSAGES.sysexend,this.send(s,{time:n.time})}else{const s=e.concat(t,I.SYSTEM_MESSAGES.sysexend);this.send([I.SYSTEM_MESSAGES.sysex].concat(s),{time:n.time})}return this}clear(){return this._midiOutput.clear?this._midiOutput.clear():Y.validation&&console.warn("The 'clear()' method has not yet been implemented in your environment."),this}sendTimecodeQuarterFrame(e,t={}){if(Y.validation&&(e=parseInt(e),isNaN(e)||!(e>=0&&e<=127)))throw new RangeError("The value must be an integer between 0 and 127.");return this.send([I.SYSTEM_MESSAGES.timecode,e],{time:t.time}),this}sendSongPosition(e=0,t={}){e=Math.floor(e)||0;var n=e>>7&127,s=e&127;return this.send([I.SYSTEM_MESSAGES.songposition,n,s],{time:t.time}),this}sendSongSelect(e=0,t={}){if(Y.validation&&(e=parseInt(e),isNaN(e)||!(e>=0&&e<=127)))throw new RangeError("The program value must be between 0 and 127");return this.send([I.SYSTEM_MESSAGES.songselect,e],{time:t.time}),this}sendTuneRequest(e={}){return this.send([I.SYSTEM_MESSAGES.tunerequest],{time:e.time}),this}sendClock(e={}){return this.send([I.SYSTEM_MESSAGES.clock],{time:e.time}),this}sendStart(e={}){return this.send([I.SYSTEM_MESSAGES.start],{time:e.time}),this}sendContinue(e={}){return this.send([I.SYSTEM_MESSAGES.continue],{time:e.time}),this}sendStop(e={}){return this.send([I.SYSTEM_MESSAGES.stop],{time:e.time}),this}sendActiveSensing(e={}){return this.send([I.SYSTEM_MESSAGES.activesensing],{time:e.time}),this}sendReset(e={}){return this.send([I.SYSTEM_MESSAGES.reset],{time:e.time}),this}sendTuningRequest(e={}){return Y.validation&&console.warn("The sendTuningRequest() method has been deprecated. Use sendTuningRequest() instead."),this.sendTuneRequest(e)}sendKeyAftertouch(e,t,n={}){return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].sendKeyAftertouch(e,t,n)}),this}sendControlChange(e,t,n={},s={}){if(Y.validation&&(Array.isArray(n)||Number.isInteger(n)||n==="all")){const r=n;n=s,n.channels=r,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)}return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(r=>{this.channels[r].sendControlChange(e,t,n)}),this}sendPitchBendRange(e=0,t=0,n={}){return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].sendPitchBendRange(e,t,n)}),this}setPitchBendRange(e=0,t=0,n="all",s={}){return Y.validation&&(console.warn("The setPitchBendRange() method is deprecated. Use sendPitchBendRange() instead."),s.channels=n,s.channels==="all"&&(s.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendPitchBendRange(e,t,s)}sendRpnValue(e,t,n={}){return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].sendRpnValue(e,t,n)}),this}setRegisteredParameter(e,t=[],n="all",s={}){return Y.validation&&(console.warn("The setRegisteredParameter() method is deprecated. Use sendRpnValue() instead."),s.channels=n,s.channels==="all"&&(s.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendRpnValue(e,t,s)}sendChannelAftertouch(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendChannelAftertouch(e,t)}),this}sendPitchBend(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendPitchBend(e,t)}),this}sendProgramChange(e=0,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendProgramChange(e,t)}),this}sendModulationRange(e,t,n={}){return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].sendModulationRange(e,t,n)}),this}setModulationRange(e=0,t=0,n="all",s={}){return Y.validation&&(console.warn("The setModulationRange() method is deprecated. Use sendModulationRange() instead."),s.channels=n,s.channels==="all"&&(s.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendModulationRange(e,t,s)}sendMasterTuning(e,t={}){return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(n=>{this.channels[n].sendMasterTuning(e,t)}),this}setMasterTuning(e,t={},n={}){return Y.validation&&(console.warn("The setMasterTuning() method is deprecated. Use sendMasterTuning() instead."),n.channels=t,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendMasterTuning(e,n)}sendTuningProgram(e,t={}){return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(n=>{this.channels[n].sendTuningProgram(e,t)}),this}setTuningProgram(e,t="all",n={}){return Y.validation&&(console.warn("The setTuningProgram() method is deprecated. Use sendTuningProgram() instead."),n.channels=t,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendTuningProgram(e,n)}sendTuningBank(e=0,t={}){return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(n=>{this.channels[n].sendTuningBank(e,t)}),this}setTuningBank(e,t="all",n={}){return Y.validation&&(console.warn("The setTuningBank() method is deprecated. Use sendTuningBank() instead."),n.channels=t,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendTuningBank(e,n)}sendChannelMode(e,t=0,n={},s={}){if(Y.validation&&(Array.isArray(n)||Number.isInteger(n)||n==="all")){const r=n;n=s,n.channels=r,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)}return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(r=>{this.channels[r].sendChannelMode(e,t,n)}),this}sendAllSoundOff(e={}){return e.channels==null&&(e.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(e.channels).forEach(t=>{this.channels[t].sendAllSoundOff(e)}),this}sendAllNotesOff(e={}){return e.channels==null&&(e.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(e.channels).forEach(t=>{this.channels[t].sendAllNotesOff(e)}),this}sendResetAllControllers(e={},t={}){if(Y.validation&&(Array.isArray(e)||Number.isInteger(e)||e==="all")){const n=e;e=t,e.channels=n,e.channels==="all"&&(e.channels=I.MIDI_CHANNEL_NUMBERS)}return e.channels==null&&(e.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(e.channels).forEach(n=>{this.channels[n].sendResetAllControllers(e)}),this}sendPolyphonicMode(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendPolyphonicMode(e,t)}),this}sendLocalControl(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendLocalControl(e,t)}),this}sendOmniMode(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendOmniMode(e,t)}),this}sendNrpnValue(e,t,n={}){return n.channels==null&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].sendNrpnValue(e,t,n)}),this}setNonRegisteredParameter(e,t=[],n="all",s={}){return Y.validation&&(console.warn("The setNonRegisteredParameter() method is deprecated. Use sendNrpnValue() instead."),s.channels=n,s.channels==="all"&&(s.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendNrpnValue(e,t,s)}sendRpnIncrement(e,t={}){return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(n=>{this.channels[n].sendRpnIncrement(e,t)}),this}incrementRegisteredParameter(e,t="all",n={}){return Y.validation&&(console.warn("The incrementRegisteredParameter() method is deprecated. Use sendRpnIncrement() instead."),n.channels=t,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendRpnIncrement(e,n)}sendRpnDecrement(e,t={}){return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(n=>{this.channels[n].sendRpnDecrement(e,t)}),this}decrementRegisteredParameter(e,t="all",n={}){return Y.validation&&(console.warn("The decrementRegisteredParameter() method is deprecated. Use sendRpnDecrement() instead."),n.channels=t,n.channels==="all"&&(n.channels=I.MIDI_CHANNEL_NUMBERS)),this.sendRpnDecrement(e,n)}sendNoteOff(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendNoteOff(e,t)}),this}stopNote(e,t){return this.sendNoteOff(e,t)}playNote(e,t={},n={}){if(Y.validation&&(t.rawVelocity&&console.warn("The 'rawVelocity' option is deprecated. Use 'rawAttack' instead."),t.velocity&&console.warn("The 'velocity' option is deprecated. Use 'velocity' instead."),Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].playNote(e,t)}),this}sendNoteOn(e,t={},n={}){if(Y.validation&&(Array.isArray(t)||Number.isInteger(t)||t==="all")){const s=t;t=n,t.channels=s,t.channels==="all"&&(t.channels=I.MIDI_CHANNEL_NUMBERS)}return t.channels==null&&(t.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(t.channels).forEach(s=>{this.channels[s].sendNoteOn(e,t)}),this}get name(){return this._midiOutput.name}get id(){return this._midiOutput.id}get connection(){return this._midiOutput.connection}get manufacturer(){return this._midiOutput.manufacturer}get state(){return this._midiOutput.state}get type(){return this._midiOutput.type}get octaveOffset(){return this._octaveOffset}set octaveOffset(e){if(this.validation&&(e=parseInt(e),isNaN(e)))throw new TypeError("The 'octaveOffset' property must be an integer.");this._octaveOffset=e}}/**
 * The `Forwarder` class allows the forwarding of MIDI messages to predetermined outputs. When you
 * call its [`forward()`](#forward) method, it will send the specified [`Message`](Message) object
 * to all the outputs listed in its [`destinations`](#destinations) property.
 *
 * If specific channels or message types have been defined in the [`channels`](#channels) or
 * [`types`](#types) properties, only messages matching the channels/types will be forwarded.
 *
 * While it can be manually instantiated, you are more likely to come across a `Forwarder` object as
 * the return value of the [`Input.addForwarder()`](Input#addForwarder) method.
 *
 * @license Apache-2.0
 * @since 3.0.0
 */class Dl{constructor(e=[],t={}){this.destinations=[],this.types=[...Object.keys(I.SYSTEM_MESSAGES),...Object.keys(I.CHANNEL_MESSAGES)],this.channels=I.MIDI_CHANNEL_NUMBERS,this.suspended=!1,Array.isArray(e)||(e=[e]),t.types&&!Array.isArray(t.types)&&(t.types=[t.types]),t.channels&&!Array.isArray(t.channels)&&(t.channels=[t.channels]),Y.validation&&(e.forEach(n=>{if(!(n instanceof Ao))throw new TypeError("Destinations must be of type 'Output'.")}),t.types!==void 0&&t.types.forEach(n=>{if(!I.SYSTEM_MESSAGES.hasOwnProperty(n)&&!I.CHANNEL_MESSAGES.hasOwnProperty(n))throw new TypeError("Type must be a valid message type.")}),t.channels!==void 0&&t.channels.forEach(n=>{if(!I.MIDI_CHANNEL_NUMBERS.includes(n))throw new TypeError("MIDI channel must be between 1 and 16.")})),this.destinations=e,t.types&&(this.types=t.types),t.channels&&(this.channels=t.channels)}forward(e){this.suspended||this.types.includes(e.type)&&(e.channel&&!this.channels.includes(e.channel)||this.destinations.forEach(t=>{Y.validation&&!(t instanceof Ao)||t.send(e)}))}}/**
 * The `InputChannel` class represents a single MIDI input channel (1-16) from a single input
 * device. This object is derived from the host's MIDI subsystem and should not be instantiated
 * directly.
 *
 * All 16 `InputChannel` objects can be found inside the input's [`channels`](Input#channels)
 * property.
 *
 * @fires InputChannel#midimessage
 * @fires InputChannel#unknownmessage
 *
 * @fires InputChannel#noteoff
 * @fires InputChannel#noteon
 * @fires InputChannel#keyaftertouch
 * @fires InputChannel#programchange
 * @fires InputChannel#channelaftertouch
 * @fires InputChannel#pitchbend
 *
 * @fires InputChannel#allnotesoff
 * @fires InputChannel#allsoundoff
 * @fires InputChannel#localcontrol
 * @fires InputChannel#monomode
 * @fires InputChannel#omnimode
 * @fires InputChannel#resetallcontrollers
 *
 * @fires InputChannel#event:nrpn
 * @fires InputChannel#event:nrpn-dataentrycoarse
 * @fires InputChannel#event:nrpn-dataentryfine
 * @fires InputChannel#event:nrpn-dataincrement
 * @fires InputChannel#event:nrpn-datadecrement
 * @fires InputChannel#event:rpn
 * @fires InputChannel#event:rpn-dataentrycoarse
 * @fires InputChannel#event:rpn-dataentryfine
 * @fires InputChannel#event:rpn-dataincrement
 * @fires InputChannel#event:rpn-datadecrement
 *
 * @fires InputChannel#controlchange
 * @fires InputChannel#event:controlchange-controllerxxx
 * @fires InputChannel#event:controlchange-bankselectcoarse
 * @fires InputChannel#event:controlchange-modulationwheelcoarse
 * @fires InputChannel#event:controlchange-breathcontrollercoarse
 * @fires InputChannel#event:controlchange-footcontrollercoarse
 * @fires InputChannel#event:controlchange-portamentotimecoarse
 * @fires InputChannel#event:controlchange-dataentrycoarse
 * @fires InputChannel#event:controlchange-volumecoarse
 * @fires InputChannel#event:controlchange-balancecoarse
 * @fires InputChannel#event:controlchange-pancoarse
 * @fires InputChannel#event:controlchange-expressioncoarse
 * @fires InputChannel#event:controlchange-effectcontrol1coarse
 * @fires InputChannel#event:controlchange-effectcontrol2coarse
 * @fires InputChannel#event:controlchange-generalpurposecontroller1
 * @fires InputChannel#event:controlchange-generalpurposecontroller2
 * @fires InputChannel#event:controlchange-generalpurposecontroller3
 * @fires InputChannel#event:controlchange-generalpurposecontroller4
 * @fires InputChannel#event:controlchange-bankselectfine
 * @fires InputChannel#event:controlchange-modulationwheelfine
 * @fires InputChannel#event:controlchange-breathcontrollerfine
 * @fires InputChannel#event:controlchange-footcontrollerfine
 * @fires InputChannel#event:controlchange-portamentotimefine
 * @fires InputChannel#event:controlchange-dataentryfine
 * @fires InputChannel#event:controlchange-channelvolumefine
 * @fires InputChannel#event:controlchange-balancefine
 * @fires InputChannel#event:controlchange-panfine
 * @fires InputChannel#event:controlchange-expressionfine
 * @fires InputChannel#event:controlchange-effectcontrol1fine
 * @fires InputChannel#event:controlchange-effectcontrol2fine
 * @fires InputChannel#event:controlchange-damperpedal
 * @fires InputChannel#event:controlchange-portamento
 * @fires InputChannel#event:controlchange-sostenuto
 * @fires InputChannel#event:controlchange-softpedal
 * @fires InputChannel#event:controlchange-legatopedal
 * @fires InputChannel#event:controlchange-hold2
 * @fires InputChannel#event:controlchange-soundvariation
 * @fires InputChannel#event:controlchange-resonance
 * @fires InputChannel#event:controlchange-releasetime
 * @fires InputChannel#event:controlchange-attacktime
 * @fires InputChannel#event:controlchange-brightness
 * @fires InputChannel#event:controlchange-decaytime
 * @fires InputChannel#event:controlchange-vibratorate
 * @fires InputChannel#event:controlchange-vibratodepth
 * @fires InputChannel#event:controlchange-vibratodelay
 * @fires InputChannel#event:controlchange-generalpurposecontroller5
 * @fires InputChannel#event:controlchange-generalpurposecontroller6
 * @fires InputChannel#event:controlchange-generalpurposecontroller7
 * @fires InputChannel#event:controlchange-generalpurposecontroller8
 * @fires InputChannel#event:controlchange-portamentocontrol
 * @fires InputChannel#event:controlchange-highresolutionvelocityprefix
 * @fires InputChannel#event:controlchange-effect1depth
 * @fires InputChannel#event:controlchange-effect2depth
 * @fires InputChannel#event:controlchange-effect3depth
 * @fires InputChannel#event:controlchange-effect4depth
 * @fires InputChannel#event:controlchange-effect5depth
 * @fires InputChannel#event:controlchange-dataincrement
 * @fires InputChannel#event:controlchange-datadecrement
 * @fires InputChannel#event:controlchange-nonregisteredparameterfine
 * @fires InputChannel#event:controlchange-nonregisteredparametercoarse
 * @fires InputChannel#event:controlchange-registeredparameterfine
 * @fires InputChannel#event:controlchange-registeredparametercoarse
 * @fires InputChannel#event:controlchange-allsoundoff
 * @fires InputChannel#event:controlchange-resetallcontrollers
 * @fires InputChannel#event:controlchange-localcontrol
 * @fires InputChannel#event:controlchange-allnotesoff
 * @fires InputChannel#event:controlchange-omnimodeoff
 * @fires InputChannel#event:controlchange-omnimodeon
 * @fires InputChannel#event:controlchange-monomodeon
 * @fires InputChannel#event:controlchange-polymodeon
 * @fires InputChannel#event:
 *
 * @extends EventEmitter
 * @license Apache-2.0
 * @since 3.0.0
 */class Lm extends Mn{constructor(e,t){super(),this._input=e,this._number=t,this._octaveOffset=0,this._nrpnBuffer=[],this._rpnBuffer=[],this.parameterNumberEventsEnabled=!0,this.notesState=new Array(128).fill(!1)}destroy(){this._input=null,this._number=null,this._octaveOffset=0,this._nrpnBuffer=[],this.notesState=new Array(128).fill(!1),this.parameterNumberEventsEnabled=!1,this.removeListener()}_processMidiMessageEvent(e){const t=Object.assign({},e);t.port=this.input,t.target=this,t.type="midimessage",this.emit(t.type,t),this._parseEventForStandardMessages(t)}_parseEventForStandardMessages(e){const t=Object.assign({},e);t.type=t.message.type||"unknownmessage";const n=e.message.dataBytes[0],s=e.message.dataBytes[1];if(t.type==="noteoff"||t.type==="noteon"&&s===0)this.notesState[n]=!1,t.type="noteoff",t.note=new Ls(K.offsetNumber(n,this.octaveOffset+this.input.octaveOffset+Y.octaveOffset),{rawAttack:0,rawRelease:s}),t.value=K.from7bitToFloat(s),t.rawValue=s,t.velocity=t.note.release,t.rawVelocity=t.note.rawRelease;else if(t.type==="noteon")this.notesState[n]=!0,t.note=new Ls(K.offsetNumber(n,this.octaveOffset+this.input.octaveOffset+Y.octaveOffset),{rawAttack:s}),t.value=K.from7bitToFloat(s),t.rawValue=s,t.velocity=t.note.attack,t.rawVelocity=t.note.rawAttack;else if(t.type==="keyaftertouch")t.note=new Ls(K.offsetNumber(n,this.octaveOffset+this.input.octaveOffset+Y.octaveOffset)),t.value=K.from7bitToFloat(s),t.rawValue=s,t.identifier=t.note.identifier,t.key=t.note.number,t.rawKey=n;else if(t.type==="controlchange"){t.controller={number:n,name:I.CONTROL_CHANGE_MESSAGES[n].name,description:I.CONTROL_CHANGE_MESSAGES[n].description,position:I.CONTROL_CHANGE_MESSAGES[n].position},t.subtype=t.controller.name||"controller"+n,t.value=K.from7bitToFloat(s),t.rawValue=s;const r=Object.assign({},t);r.type=`${t.type}-controller${n}`,delete r.subtype,this.emit(r.type,r);const o=Object.assign({},t);o.type=`${t.type}-`+I.CONTROL_CHANGE_MESSAGES[n].name,delete o.subtype,o.type.indexOf("controller")!==0&&this.emit(o.type,o),t.message.dataBytes[0]>=120&&this._parseChannelModeMessage(t),this.parameterNumberEventsEnabled&&this._isRpnOrNrpnController(t.message.dataBytes[0])&&this._parseEventForParameterNumber(t)}else t.type==="programchange"?(t.value=n,t.rawValue=t.value):t.type==="channelaftertouch"?(t.value=K.from7bitToFloat(n),t.rawValue=n):t.type==="pitchbend"?(t.value=((s<<7)+n-8192)/8192,t.rawValue=(s<<7)+n):t.type="unknownmessage";this.emit(t.type,t)}_parseChannelModeMessage(e){const t=Object.assign({},e);t.type=t.controller.name,t.type==="localcontrol"&&(t.value=t.message.data[2]===127,t.rawValue=t.message.data[2]),t.type==="omnimodeon"?(t.type="omnimode",t.value=!0,t.rawValue=t.message.data[2]):t.type==="omnimodeoff"&&(t.type="omnimode",t.value=!1,t.rawValue=t.message.data[2]),t.type==="monomodeon"?(t.type="monomode",t.value=!0,t.rawValue=t.message.data[2]):t.type==="polymodeon"&&(t.type="monomode",t.value=!1,t.rawValue=t.message.data[2]),this.emit(t.type,t)}_parseEventForParameterNumber(e){const t=e.message.dataBytes[0],n=e.message.dataBytes[1];t===99||t===101?(this._nrpnBuffer=[],this._rpnBuffer=[],t===99?this._nrpnBuffer=[e.message]:n!==127&&(this._rpnBuffer=[e.message])):t===98||t===100?t===98?(this._rpnBuffer=[],this._nrpnBuffer.length===1?this._nrpnBuffer.push(e.message):this._nrpnBuffer=[]):(this._nrpnBuffer=[],this._rpnBuffer.length===1&&n!==127?this._rpnBuffer.push(e.message):this._rpnBuffer=[]):(t===6||t===38||t===96||t===97)&&(this._rpnBuffer.length===2?this._dispatchParameterNumberEvent("rpn",this._rpnBuffer[0].dataBytes[1],this._rpnBuffer[1].dataBytes[1],e):this._nrpnBuffer.length===2?this._dispatchParameterNumberEvent("nrpn",this._nrpnBuffer[0].dataBytes[1],this._nrpnBuffer[1].dataBytes[1],e):(this._nrpnBuffer=[],this._rpnBuffer=[]))}_isRpnOrNrpnController(e){return e===6||e===38||e===96||e===97||e===98||e===99||e===100||e===101}_dispatchParameterNumberEvent(e,t,n,s){e=e==="nrpn"?"nrpn":"rpn";const r={target:s.target,timestamp:s.timestamp,message:s.message,parameterMsb:t,parameterLsb:n,value:K.from7bitToFloat(s.message.dataBytes[1]),rawValue:s.message.dataBytes[1]};e==="rpn"?r.parameter=Object.keys(I.REGISTERED_PARAMETERS).find(l=>I.REGISTERED_PARAMETERS[l][0]===t&&I.REGISTERED_PARAMETERS[l][1]===n):r.parameter=(t<<7)+n;const o=I.CONTROL_CHANGE_MESSAGES[s.message.dataBytes[0]].name;r.type=`${e}-${o}`,this.emit(r.type,r);const a=Object.assign({},r);a.type==="nrpn-dataincrement"?a.type="nrpn-databuttonincrement":a.type==="nrpn-datadecrement"?a.type="nrpn-databuttondecrement":a.type==="rpn-dataincrement"?a.type="rpn-databuttonincrement":a.type==="rpn-datadecrement"&&(a.type="rpn-databuttondecrement"),this.emit(a.type,a),r.type=e,r.subtype=o,this.emit(r.type,r)}getChannelModeByNumber(e){return Y.validation&&(console.warn("The 'getChannelModeByNumber()' method has been moved to the 'Utilities' class."),e=Math.floor(e)),K.getChannelModeByNumber(e)}getCcNameByNumber(e){if(Y.validation&&(console.warn("The 'getCcNameByNumber()' method has been moved to the 'Utilities' class."),e=parseInt(e),!(e>=0&&e<=127)))throw new RangeError("Invalid control change number.");return K.getCcNameByNumber(e)}getNoteState(e){e instanceof Ls&&(e=e.identifier);const t=K.guessNoteNumber(e,Y.octaveOffset+this.input.octaveOffset+this.octaveOffset);return this.notesState[t]}get octaveOffset(){return this._octaveOffset}set octaveOffset(e){if(this.validation&&(e=parseInt(e),isNaN(e)))throw new TypeError("The 'octaveOffset' property must be an integer.");this._octaveOffset=e}get input(){return this._input}get number(){return this._number}get nrpnEventsEnabled(){return this.parameterNumberEventsEnabled}set nrpnEventsEnabled(e){this.validation&&(e=!!e),this.parameterNumberEventsEnabled=e}}/**
 * The `Message` class represents a single MIDI message. It has several properties that make it
 * easy to make sense of the binary data it contains.
 *
 * @license Apache-2.0
 * @since 3.0.0
 */class od{constructor(e){this.rawData=e,this.data=Array.from(this.rawData),this.statusByte=this.rawData[0],this.rawDataBytes=this.rawData.slice(1),this.dataBytes=this.data.slice(1),this.isChannelMessage=!1,this.isSystemMessage=!1,this.command=void 0,this.channel=void 0,this.manufacturerId=void 0,this.type=void 0,this.statusByte<240?(this.isChannelMessage=!0,this.command=this.statusByte>>4,this.channel=(this.statusByte&15)+1):(this.isSystemMessage=!0,this.command=this.statusByte),this.isChannelMessage?this.type=K.getPropertyByValue(I.CHANNEL_MESSAGES,this.command):this.isSystemMessage&&(this.type=K.getPropertyByValue(I.SYSTEM_MESSAGES,this.command)),this.statusByte===I.SYSTEM_MESSAGES.sysex&&(this.dataBytes[0]===0?(this.manufacturerId=this.dataBytes.slice(0,3),this.dataBytes=this.dataBytes.slice(3,this.rawDataBytes.length-1),this.rawDataBytes=this.rawDataBytes.slice(3,this.rawDataBytes.length-1)):(this.manufacturerId=[this.dataBytes[0]],this.dataBytes=this.dataBytes.slice(1,this.dataBytes.length-1),this.rawDataBytes=this.rawDataBytes.slice(1,this.rawDataBytes.length-1)))}}/**
 * The `Input` class represents a single MIDI input port. This object is automatically instantiated
 * by the library according to the host's MIDI subsystem and does not need to be directly
 * instantiated. Instead, you can access all `Input` objects by referring to the
 * [`WebMidi.inputs`](WebMidi#inputs) array. You can also retrieve inputs by using methods such as
 * [`WebMidi.getInputByName()`](WebMidi#getInputByName) and
 * [`WebMidi.getInputById()`](WebMidi#getInputById).
 *
 * Note that a single MIDI device may expose several inputs and/or outputs.
 *
 * **Important**: the `Input` class does not directly fire channel-specific MIDI messages
 * (such as [`noteon`](InputChannel#event:noteon) or
 * [`controlchange`](InputChannel#event:controlchange), etc.). The [`InputChannel`](InputChannel)
 * object does that. However, you can still use the
 * [`Input.addListener()`](#addListener) method to listen to channel-specific events on multiple
 * [`InputChannel`](InputChannel) objects at once.
 *
 * @fires Input#opened
 * @fires Input#disconnected
 * @fires Input#closed
 * @fires Input#midimessage
 *
 * @fires Input#sysex
 * @fires Input#timecode
 * @fires Input#songposition
 * @fires Input#songselect
 * @fires Input#tunerequest
 * @fires Input#clock
 * @fires Input#start
 * @fires Input#continue
 * @fires Input#stop
 * @fires Input#activesensing
 * @fires Input#reset
 *
 * @fires Input#unknownmidimessage
 *
 * @extends EventEmitter
 * @license Apache-2.0
 */class Bm extends Mn{constructor(e){super(),this._midiInput=e,this._octaveOffset=0,this.channels=[];for(let t=1;t<=16;t++)this.channels[t]=new Lm(this,t);this._forwarders=[],this._midiInput.onstatechange=this._onStateChange.bind(this),this._midiInput.onmidimessage=this._onMidiMessage.bind(this)}async destroy(){this.removeListener(),this.channels.forEach(e=>e.destroy()),this.channels=[],this._forwarders=[],this._midiInput&&(this._midiInput.onstatechange=null,this._midiInput.onmidimessage=null),await this.close(),this._midiInput=null}_onStateChange(e){let t={timestamp:Y.time,target:this,port:this};e.port.connection==="open"?(t.type="opened",this.emit("opened",t)):e.port.connection==="closed"&&e.port.state==="connected"?(t.type="closed",this.emit("closed",t)):e.port.connection==="closed"&&e.port.state==="disconnected"?(t.type="disconnected",t.port={connection:e.port.connection,id:e.port.id,manufacturer:e.port.manufacturer,name:e.port.name,state:e.port.state,type:e.port.type},this.emit("disconnected",t)):e.port.connection==="pending"&&e.port.state==="disconnected"||console.warn("This statechange event was not caught: ",e.port.connection,e.port.state)}_onMidiMessage(e){const t=new od(e.data),n={port:this,target:this,message:t,timestamp:e.timeStamp,type:"midimessage",data:t.data,rawData:t.data,statusByte:t.data[0],dataBytes:t.dataBytes};this.emit("midimessage",n),t.isSystemMessage?this._parseEvent(n):t.isChannelMessage&&this.channels[t.channel]._processMidiMessageEvent(n),this._forwarders.forEach(s=>s.forward(t))}_parseEvent(e){const t=Object.assign({},e);t.type=t.message.type||"unknownmidimessage",t.type==="songselect"&&(t.song=e.data[1]+1,t.value=e.data[1],t.rawValue=t.value),this.emit(t.type,t)}async open(){try{await this._midiInput.open()}catch(e){return Promise.reject(e)}return Promise.resolve(this)}async close(){if(!this._midiInput)return Promise.resolve(this);try{await this._midiInput.close()}catch(e){return Promise.reject(e)}return Promise.resolve(this)}getChannelModeByNumber(){Y.validation&&console.warn("The 'getChannelModeByNumber()' method has been moved to the 'Utilities' class.")}addListener(e,t,n={}){if(Y.validation&&typeof n=="function"){let s=t!=null?[].concat(t):void 0;t=n,n={channels:s}}if(I.CHANNEL_EVENTS.includes(e)){n.channels===void 0&&(n.channels=I.MIDI_CHANNEL_NUMBERS);let s=[];return K.sanitizeChannels(n.channels).forEach(r=>{s.push(this.channels[r].addListener(e,t,n))}),s}else return super.addListener(e,t,n)}addOneTimeListener(e,t,n={}){return n.remaining=1,this.addListener(e,t,n)}on(e,t,n,s){return this.addListener(e,t,n,s)}hasListener(e,t,n={}){if(Y.validation&&typeof n=="function"){let s=[].concat(t);t=n,n={channels:s}}return I.CHANNEL_EVENTS.includes(e)?(n.channels===void 0&&(n.channels=I.MIDI_CHANNEL_NUMBERS),K.sanitizeChannels(n.channels).every(s=>this.channels[s].hasListener(e,t))):super.hasListener(e,t)}removeListener(e,t,n={}){if(Y.validation&&typeof n=="function"){let s=[].concat(t);t=n,n={channels:s}}if(n.channels===void 0&&(n.channels=I.MIDI_CHANNEL_NUMBERS),e==null)return K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s]&&this.channels[s].removeListener()}),super.removeListener();I.CHANNEL_EVENTS.includes(e)?K.sanitizeChannels(n.channels).forEach(s=>{this.channels[s].removeListener(e,t,n)}):super.removeListener(e,t,n)}addForwarder(e,t={}){let n;return e instanceof Dl?n=e:n=new Dl(e,t),this._forwarders.push(n),n}removeForwarder(e){this._forwarders=this._forwarders.filter(t=>t!==e)}hasForwarder(e){return this._forwarders.includes(e)}get name(){return this._midiInput.name}get id(){return this._midiInput.id}get connection(){return this._midiInput.connection}get manufacturer(){return this._midiInput.manufacturer}get octaveOffset(){return this._octaveOffset}set octaveOffset(e){if(this.validation&&(e=parseInt(e),isNaN(e)))throw new TypeError("The 'octaveOffset' property must be an integer.");this._octaveOffset=e}get state(){return this._midiInput.state}get type(){return this._midiInput.type}get nrpnEventsEnabled(){return Y.validation&&console.warn("The 'nrpnEventsEnabled' property has been moved to the 'InputChannel' class."),!1}}/**
 * The `WebMidi` object makes it easier to work with the low-level Web MIDI API. Basically, it
 * simplifies sending outgoing MIDI messages and reacting to incoming MIDI messages.
 *
 * When using the WebMidi.js library, you should know that the `WebMidi` class has already been
 * instantiated. You cannot instantiate it yourself. If you use the **IIFE** version, you should
 * simply use the global object called `WebMidi`. If you use the **CJS** (CommonJS) or **ESM** (ES6
 * module) version, you get an already-instantiated object when you import the module.
 *
 * @fires WebMidi#connected
 * @fires WebMidi#disabled
 * @fires WebMidi#disconnected
 * @fires WebMidi#enabled
 * @fires WebMidi#error
 * @fires WebMidi#midiaccessgranted
 * @fires WebMidi#portschanged
 *
 * @extends EventEmitter
 * @license Apache-2.0
 */class cv extends Mn{constructor(){super(),this.defaults={note:{attack:K.from7bitToFloat(64),release:K.from7bitToFloat(64),duration:1/0}},this.interface=null,this.validation=!0,this._inputs=[],this._disconnectedInputs=[],this._outputs=[],this._disconnectedOutputs=[],this._stateChangeQueue=[],this._octaveOffset=0}async enable(e={},t=!1){if(K.isNode)try{window.navigator}catch{let a=await Object.getPrototypeOf(async function(){}).constructor(`
        let jzz = await import("jzz");
        return jzz.default;
        `)();global.navigator||(global.navigator={}),Object.assign(global.navigator,a)}if(this.validation=e.validation!==!1,this.validation&&(typeof e=="function"&&(e={callback:e,sysex:t}),t&&(e.sysex=!0)),this.enabled)return typeof e.callback=="function"&&e.callback(),Promise.resolve();const n={timestamp:this.time,target:this,type:"error",error:void 0},s={timestamp:this.time,target:this,type:"midiaccessgranted"},r={timestamp:this.time,target:this,type:"enabled"};try{typeof e.requestMIDIAccessFunction=="function"?this.interface=await e.requestMIDIAccessFunction({sysex:e.sysex,software:e.software}):this.interface=await navigator.requestMIDIAccess({sysex:e.sysex,software:e.software})}catch(o){return n.error=o,this.emit("error",n),typeof e.callback=="function"&&e.callback(o),Promise.reject(o)}this.emit("midiaccessgranted",s),this.interface.onstatechange=this._onInterfaceStateChange.bind(this);try{await this._updateInputsAndOutputs()}catch(o){return n.error=o,this.emit("error",n),typeof e.callback=="function"&&e.callback(o),Promise.reject(o)}return this.emit("enabled",r),typeof e.callback=="function"&&e.callback(),Promise.resolve(this)}async disable(){return this.interface&&(this.interface.onstatechange=void 0),this._destroyInputsAndOutputs().then(()=>{navigator&&typeof navigator.close=="function"&&navigator.close(),this.interface=null;let e={timestamp:this.time,target:this,type:"disabled"};this.emit("disabled",e),this.removeListener()})}getInputById(e,t={disconnected:!1}){if(this.validation){if(!this.enabled)throw new Error("WebMidi is not enabled.");if(!e)return}if(t.disconnected){for(let n=0;n<this._disconnectedInputs.length;n++)if(this._disconnectedInputs[n]._midiInput&&this._disconnectedInputs[n].id===e.toString())return this._disconnectedInputs[n]}else for(let n=0;n<this.inputs.length;n++)if(this.inputs[n]._midiInput&&this.inputs[n].id===e.toString())return this.inputs[n]}getInputByName(e,t={disconnected:!1}){if(this.validation){if(!this.enabled)throw new Error("WebMidi is not enabled.");if(!e)return;e=e.toString()}if(t.disconnected){for(let n=0;n<this._disconnectedInputs.length;n++)if(~this._disconnectedInputs[n].name.indexOf(e))return this._disconnectedInputs[n]}else for(let n=0;n<this.inputs.length;n++)if(~this.inputs[n].name.indexOf(e))return this.inputs[n]}getOutputByName(e,t={disconnected:!1}){if(this.validation){if(!this.enabled)throw new Error("WebMidi is not enabled.");if(!e)return;e=e.toString()}if(t.disconnected){for(let n=0;n<this._disconnectedOutputs.length;n++)if(~this._disconnectedOutputs[n].name.indexOf(e))return this._disconnectedOutputs[n]}else for(let n=0;n<this.outputs.length;n++)if(~this.outputs[n].name.indexOf(e))return this.outputs[n]}getOutputById(e,t={disconnected:!1}){if(this.validation){if(!this.enabled)throw new Error("WebMidi is not enabled.");if(!e)return}if(t.disconnected){for(let n=0;n<this._disconnectedOutputs.length;n++)if(this._disconnectedOutputs[n]._midiOutput&&this._disconnectedOutputs[n].id===e.toString())return this._disconnectedOutputs[n]}else for(let n=0;n<this.outputs.length;n++)if(this.outputs[n]._midiOutput&&this.outputs[n].id===e.toString())return this.outputs[n]}noteNameToNumber(e){return this.validation&&console.warn("The noteNameToNumber() method is deprecated. Use Utilities.toNoteNumber() instead."),K.toNoteNumber(e,this.octaveOffset)}getOctave(e){return this.validation&&(console.warn("The getOctave()is deprecated. Use Utilities.getNoteDetails() instead"),e=parseInt(e)),!isNaN(e)&&e>=0&&e<=127?K.getNoteDetails(K.offsetNumber(e,this.octaveOffset)).octave:!1}sanitizeChannels(e){return this.validation&&console.warn("The sanitizeChannels() method has been moved to the utilities class."),K.sanitizeChannels(e)}toMIDIChannels(e){return this.validation&&console.warn("The toMIDIChannels() method has been deprecated. Use Utilities.sanitizeChannels() instead."),K.sanitizeChannels(e)}guessNoteNumber(e){return this.validation&&console.warn("The guessNoteNumber() method has been deprecated. Use Utilities.guessNoteNumber() instead."),K.guessNoteNumber(e,this.octaveOffset)}getValidNoteArray(e,t={}){return this.validation&&console.warn("The getValidNoteArray() method has been moved to the Utilities.buildNoteArray()"),K.buildNoteArray(e,t)}convertToTimestamp(e){return this.validation&&console.warn("The convertToTimestamp() method has been moved to Utilities.toTimestamp()."),K.toTimestamp(e)}async _destroyInputsAndOutputs(){let e=[];return this.inputs.forEach(t=>e.push(t.destroy())),this.outputs.forEach(t=>e.push(t.destroy())),Promise.all(e).then(()=>{this._inputs=[],this._outputs=[]})}_onInterfaceStateChange(e){this._updateInputsAndOutputs();let t={timestamp:e.timeStamp,type:e.port.state,target:this};if(e.port.state==="connected"&&e.port.connection==="open"){e.port.type==="output"?t.port=this.getOutputById(e.port.id):e.port.type==="input"&&(t.port=this.getInputById(e.port.id)),this.emit(e.port.state,t);const n=Object.assign({},t);n.type="portschanged",this.emit(n.type,n)}else if(e.port.state==="disconnected"&&e.port.connection==="pending"){e.port.type==="input"?t.port=this.getInputById(e.port.id,{disconnected:!0}):e.port.type==="output"&&(t.port=this.getOutputById(e.port.id,{disconnected:!0})),this.emit(e.port.state,t);const n=Object.assign({},t);n.type="portschanged",this.emit(n.type,n)}}async _updateInputsAndOutputs(){return Promise.all([this._updateInputs(),this._updateOutputs()])}async _updateInputs(){if(!this.interface)return;for(let t=this._inputs.length-1;t>=0;t--){const n=this._inputs[t];Array.from(this.interface.inputs.values()).find(r=>r===n._midiInput)||(this._disconnectedInputs.push(n),this._inputs.splice(t,1))}let e=[];return this.interface.inputs.forEach(t=>{if(!this._inputs.find(n=>n._midiInput===t)){let n=this._disconnectedInputs.find(s=>s._midiInput===t);n||(n=new Bm(t)),this._inputs.push(n),e.push(n.open())}}),Promise.all(e)}async _updateOutputs(){if(!this.interface)return;for(let t=this._outputs.length-1;t>=0;t--){const n=this._outputs[t];Array.from(this.interface.outputs.values()).find(r=>r===n._midiOutput)||(this._disconnectedOutputs.push(n),this._outputs.splice(t,1))}let e=[];return this.interface.outputs.forEach(t=>{if(!this._outputs.find(n=>n._midiOutput===t)){let n=this._disconnectedOutputs.find(s=>s._midiOutput===t);n||(n=new Ao(t)),this._outputs.push(n),e.push(n.open())}}),Promise.all(e)}get enabled(){return this.interface!==null}get inputs(){return this._inputs}get isNode(){return this.validation&&console.warn("WebMidi.isNode has been deprecated. Use Utilities.isNode instead."),K.isNode}get isBrowser(){return this.validation&&console.warn("WebMidi.isBrowser has been deprecated. Use Utilities.isBrowser instead."),K.isBrowser}get octaveOffset(){return this._octaveOffset}set octaveOffset(e){if(this.validation&&(e=parseInt(e),isNaN(e)))throw new TypeError("The 'octaveOffset' property must be an integer.");this._octaveOffset=e}get outputs(){return this._outputs}get supported(){return typeof navigator<"u"&&!!navigator.requestMIDIAccess}get sysexEnabled(){return!!(this.interface&&this.interface.sysexEnabled)}get time(){return performance.now()}get version(){return"3.1.14"}get flavour(){return"esm"}get CHANNEL_EVENTS(){return this.validation&&console.warn("The CHANNEL_EVENTS enum has been moved to Enumerations.CHANNEL_EVENTS."),I.CHANNEL_EVENTS}get MIDI_SYSTEM_MESSAGES(){return this.validation&&console.warn("The MIDI_SYSTEM_MESSAGES enum has been moved to Enumerations.SYSTEM_MESSAGES."),I.SYSTEM_MESSAGES}get MIDI_CHANNEL_MODE_MESSAGES(){return this.validation&&console.warn("The MIDI_CHANNEL_MODE_MESSAGES enum has been moved to Enumerations.CHANNEL_MODE_MESSAGES."),I.CHANNEL_MODE_MESSAGES}get MIDI_CONTROL_CHANGE_MESSAGES(){return this.validation&&console.warn("The MIDI_CONTROL_CHANGE_MESSAGES enum has been replaced by the Enumerations.CONTROL_CHANGE_MESSAGES array."),I.MIDI_CONTROL_CHANGE_MESSAGES}get MIDI_REGISTERED_PARAMETER(){return this.validation&&console.warn("The MIDI_REGISTERED_PARAMETER enum has been moved to Enumerations.REGISTERED_PARAMETERS."),I.REGISTERED_PARAMETERS}get NOTES(){return this.validation&&console.warn("The NOTES enum has been deprecated."),["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]}}const Y=new cv;Y.constructor=null;const QM=Object.freeze(Object.defineProperty({__proto__:null,Enumerations:I,Forwarder:Dl,Input:Bm,InputChannel:Lm,Message:od,Note:Ls,Output:Ao,OutputChannel:Im,Utilities:K,WebMidi:Y},Symbol.toStringTag,{value:"Module"}));let Aa=null,uu=null,hu=null,fu=null,mu=null,zl=null,pu=null;const dv=(i,e)=>{if(!i||!e)return i;try{return new URL(i,e).toString()}catch{return i}},Vl=(i,e)=>{if(typeof i=="string")return dv(i,e);if(Array.isArray(i))return i.map(t=>Vl(t,e));if(i&&typeof i=="object"){const t={};return Object.entries(i).forEach(([n,s])=>{t[n]=Vl(s,e)}),t}return i},uv=i=>{if(!i||typeof i!="object")return i;const e=i._base||"",t={};return Object.entries(i).forEach(([n,s])=>{n!=="_base"&&(t[n]=Vl(s,e))}),t},Ta="https://raw.githubusercontent.com/felixroos/dough-samples/main";async function Vi(){return Aa||(Aa=Promise.all([We(()=>import("./strudel-core-DenOJOif.js").then(i=>i.b),[]),We(()=>import("./strudel-web-C25uHgU2.js").then(i=>i.i),__vite__mapDeps([0,1])),We(()=>import("./strudel-web-C25uHgU2.js").then(i=>i.b),__vite__mapDeps([0,1])),We(()=>import("./index-DgkhGcvb.js"),__vite__mapDeps([2,1,3])),We(()=>import("./index-BSvGoNXy.js"),__vite__mapDeps([4,1])).catch(()=>null)]).then(i=>(uu=i[0],fu=i[1],hu=i[2],mu=i[3],zl=i[4],pu=null,{coreModule:uu,webModule:fu,webaudioModule:hu,tonalModule:mu,midiModule:zl,samplerModule:pu}))),Aa}const Ji={superpiano:"piano",wood:"jazz"};function Na(i){if(!i||typeof i!="string")return i;let e=i;for(const[t,n]of Object.entries(Ji)){const s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`(\\.s\\(["'])${s}(["']\\))`,"gi");e=e.replace(r,(a,l,d)=>`${l}${n}${d}`);const o=new RegExp(`(sound\\(["'])${s}(["']\\))`,"gi");e=e.replace(o,(a,l,d)=>`${l}${n}${d}`)}return e}const Qa={major:"major",minor:"minor",harmonicMinor:"harmonic minor",melodicMinor:"melodic minor",dorian:"dorian",phrygian:"phrygian",lydian:"lydian",mixolydian:"mixolydian",locrian:"locrian",blues:"blues",pentatonicMajor:"major pentatonic",pentatonicMinor:"minor pentatonic",ionian:"major",aeolian:"minor","melodic minor":"melodic minor","dorian b2":"dorian b2","lydian augmented":"lydian augmented","lydian dominant":"lydian dominant","mixolydian b6":"mixolydian b6","locrian #2":"locrian #2",altered:"altered","harmonic minor":"harmonic minor","locrian #6":"locrian #6","ionian #5":"ionian #5","dorian #4":"dorian #4","phrygian dominant":"phrygian dominant","lydian #2":"lydian #2",ultralocrian:"ultralocrian","harmonic major":"harmonic major","dorian b5":"dorian b5","phrygian b4":"phrygian b4","lydian b3":"lydian b3","mixolydian b2":"mixolydian b2","lydian augmented #2":"lydian augmented #2","locrian bb7":"locrian bb7","major pentatonic":"major pentatonic","suspended pentatonic":"suspended pentatonic","man gong":"man gong",ritusen:"ritusen","minor pentatonic mode 5":"minor pentatonic","minor pentatonic":"minor pentatonic","blues minor pentatonic":"minor pentatonic","major pentatonic mode 3":"major pentatonic",egyptian:"egyptian","minor pentatonic mode 5":"minor pentatonic","whole tone":"whole tone","half-whole diminished":"dominant diminished","whole-half diminished":"diminished","minor blues":"blues"};function gu(i){const e=/(\s+|[,;:<>()[\]{}|\\/]+|\*+)/g,t=i.split(e);let n=!1,s=null;for(let r=0;r<t.length;r++){const o=t[r];if(!o||e.test(o)){e.lastIndex=0;continue}const a=o.match(/^([a-gA-G])([#b]?)(-?\d+)?(@[\d.]+)?$/);if(!a){e.lastIndex=0;continue}const l=a[1].toUpperCase(),d=a[2]||"",c=a[3]?parseInt(a[3],10):null,u=a[4]||"",h=[];c!==null&&!Number.isNaN(c)&&h.push(c),s!==null&&(h.push(Math.round(s/12)-1),h.push(Math.round(s/12)),h.push(Math.round(s/12)+1)),h.push(3,4,5);let f=null;for(const O of h){const p=`${l}${d}${O}`,y=Ql.get(p);if(y&&Number.isFinite(y.midi)){f=y;break}}if(!f||!Number.isFinite(f.midi))return null;const m=Math.round(f.midi);s===null&&(s=m);const g=m-s;t[r]=String(g)+u,n=!0,e.lastIndex=0}return n?t.join(""):null}function Ou(i){if(!i||typeof i!="string")return i;const e=/\bnote\s*\(\s*([a-gA-G][^'"()]*?)\s*\)/gi;let t=i.replace(e,(s,r)=>{const o=(r||"").trim();if(!o)return s;const a=gu(o);return a===null?s:`n("${a}")`});const n=/\bnote\s*\(\s*(['"])([\s\S]*?)\1\s*\)/gi;return t=t.replace(n,(s,r,o)=>{const a=gu(o);return a===null?s:`n(${r}${a}${r})`}),t}let yu=!1,Ra=null,_a=null;function Qs(){if(yu)return;yu=!0,Ra=Ra||console.error,_a=_a||console.warn;const i=e=>{if(e&&e.length>0){let t="",n=null;if(typeof e[0]=="string"?t=e[0]:e[0]instanceof Error||typeof e[0]=="object"&&e[0]!==null?(t=e[0].message||String(e[0]),n=e[0]):t=String(e[0]),t.includes("AudioContext")&&(t.includes("not allowed")||t.includes("start")||t.includes("resume")||t.includes("user gesture"))||t.includes("@strudel/core was loaded more than once")||t.includes("undefined instead of pattern")||t.includes('got "undefined" instead of pattern')||t.includes("got undefined instead of pattern")||t.includes("Pattern evaluation failed: got undefined"))return!0;let s=t;for(let o=0;o<e.length;o++)(typeof e[o]=="string"||e[o]&&e[o].toString)&&(s+=" "+String(e[o]));const r=s.toLowerCase();if(s.includes("not found! Is it loaded?")||s.includes("not found")||r.includes("not found")||s.includes("sound ")&&s.includes("not found")||s.includes("[getTrigger] error")||s.includes("[getTrigger]")||t.includes("[getTrigger]")||s.includes("[eval] error")||s.includes("[eval]")||t.includes("[eval]")||s.includes("Unexpected token")||s.includes("createPeriodicWave")||s.includes("length of the real array provided (0)")||s.includes("minimum bound (2)")||s.includes('got "undefined" instead of pattern')||s.includes("got undefined instead of pattern")||s.includes("undefined instead of pattern")||r.includes("undefined instead of pattern")||t.includes("undefined instead of pattern")||s.includes("RolandTR909")||s.includes("RolandTR808")||s.includes("RolandTR")||r.includes("rolandtr")||t.includes("RolandTR")||s.includes("[superdough]")||s.includes("cannot schedule sounds in the past")||t.includes("[superdough]")||t.includes("cannot schedule sounds in the past")||(t.includes("SyntaxError")||s.includes("SyntaxError"))&&(t.includes("JSON")||s.includes("JSON"))||t.includes("<!DOCTYPE")||s.includes("<!DOCTYPE")||t.includes("Unexpected token")&&t.includes("<")||s.includes("Unexpected token")&&s.includes("<")||t.includes("is not valid JSON")||s.includes("is not valid JSON")||s.includes("Unexpected non-whitespace character after JSON")||s.includes("Unexpected token")&&s.includes("JSON")||s.includes("error loading")&&(s.includes("CycleTones")||s.includes("strudel.json"))||s.includes("Failed to load default sound banks")||t.includes("Failed to load default sound banks")||n&&n.isUndefinedPattern===!0)return!0}return!1};console.error=(...e)=>{const t=i(e);if(!t&&e.length>0){const n=e[0],s=typeof n=="string"?n:String(n);if(s.includes("[eval]")||s.includes("[getTrigger]")||s.includes("RolandTR")||s.includes("undefined instead of pattern")||s.includes("not found")||s.includes("createPeriodicWave")||s.includes("length of the real array provided (0)")||s.includes("minimum bound (2)")||s.includes("Unexpected token"))return}t||Ra.apply(console,e)},console.warn=(...e)=>{const t=i(e);if(!t&&e.length>0){const n=e[0],s=typeof n=="string"?n:String(n);if(s.includes("[eval]")||s.includes("[getTrigger]")||s.includes("RolandTR")||s.includes("undefined instead of pattern")||s.includes("not found")||s.includes("[superdough]")||s.includes("cannot schedule sounds in the past")||s.includes("CycleTones not available")||s.includes("falling back to dirt-samples")||s.includes("createPeriodicWave")||s.includes("length of the real array provided (0)")||s.includes("minimum bound (2)")||s.includes("Unexpected token"))return}t||_a.apply(console,e)}}Qs();function Et(i,...e){try{i&&typeof i._logRoute=="function"&&i._logRoute(...e)}catch{}}class hv{constructor(){this.audioContext=null,this.appInstance=null,this.volume=et.defaults.volume,this.activeSounds=new Map,this.audioBuffers=new Map,this.oscillators=new Map,this.elementGainNodes=new Map,this.elementPanNodes=new Map,this.elementGainValues=new Map,this.elementPanValues=new Map,this.currentEvaluatingSlot=null,this.initialized=!1,this.strudelSoundBanksLoaded=!1,this.strudelSoundBankLoading=!1,this.soundsPreloaded=!1,this.onSoundsReadyCallback=null,this.onMasterPatternUpdateCallback=null,this.onMasterStateChangeCallback=null,this.strudelLoading=!1,this.strudelLoaded=!1,this.strudelPatternSlots=new Map,this.patternSlotToElementId=new Map,this.nextPatternSlot=1,this.previewSlotName="d16",this.reservedSlots=new Set([this.previewSlotName]),this.loadedBanks=new Set,this.currentTempo=120,this.currentKey="C",this.currentScale="chromatic",this.currentTimeSignature="",this.patternCache=new Map,this.masterGainNode=null,this._manualStrudelOutputNode=null,this._manualStrudelOutputDisabled=!1,this.masterPanNode=null,this.masterVolume=.7,this.masterPan=0,this.masterMuted=!1,this.masterVolumeBeforeMute=.7,this.visualizerAnalyser=null,this.visualizerAnalyserTapGain=null,this.visualizerAnalyserTapGainConnected=!1,this.debugAudioRouting=!1,this._logRoute=(...e)=>{this.debugAudioRouting&&console.log(...e)},this._routingBypass=!1,this.masterPattern="",this.masterSlot="d0",this.trackedPatterns=new Map,this.masterActive=!1,this.masterPlaybackStartTime=null,this.masterPlaybackSpeed=1,this.masterPlaybackTempo=this.currentTempo,this.masterOnlyPlayback=!0,this.previewElementIds=new Set,this.sampleNameToSpecialtyBank=new Map,this.specialtyManifests=new Map,this._pendingMasterPatternRefreshReason=null,this._masterPatternRefreshTimer=null,this._masterPatternEvalPromise=Promise.resolve(),this._cachedScaleContext=null,this._cachedScaleKey="",this.mediaRecorder=null,this.recordedChunks=[],this.isRecording=!1,this.midiEnabled=!1,this.midiOutputs=new Map,this.selectedMidiOutput=null,this.midiChannel=0}getPatternSlot(e){if(e==="modal-preview"){const n=this.previewSlotName,s=this.patternSlotToElementId.get(n);return s&&s!==e&&(console.log(`⚠️ Preview slot ${n} previously mapped to ${s}, reassigning...`),this.strudelPatternSlots.delete(s),this.patternSlotToElementId.delete(n),this.getPatternSlot(s)),this.strudelPatternSlots.set(e,n),this.patternSlotToElementId.set(n,e),n}if(!this.strudelPatternSlots.has(e)){let n=this.nextPatternSlot,s=`d${n}`;for(;this.reservedSlots.has(s);)n++,n>16&&(n=1),s=`d${n}`;this.strudelPatternSlots.set(e,s),this.patternSlotToElementId.set(s,e),console.log(`🎵 Assigned ${e} to pattern slot ${s}`),n++,n>16&&(n=1),this.nextPatternSlot=n}const t=this.strudelPatternSlots.get(e);return console.log(`🎵 ${e} using slot ${t}`),t}onSoundsReady(e){this.onSoundsReadyCallback=e}onMasterPatternUpdate(e){this.onMasterPatternUpdateCallback=e}onMasterStateChange(e){this.onMasterStateChangeCallback=e}async initializeStrudelAndSounds(){try{if(console.log("📦 Loading Strudel from CDN..."),!window.strudel||!window.strudel.evaluate||typeof globalThis.silence!="object"||typeof globalThis.sound!="function"?(console.log("Loading Strudel (window.strudel exists:",!!window.strudel,", functions exposed:",typeof globalThis.sound=="function",")"),await this.loadStrudelFromCDN()):console.log("Strudel already loaded and functions exposed"),!window.strudel||!window.strudel.evaluate)return console.error("Strudel failed to load properly"),!1;if(typeof globalThis.silence!="object"||typeof globalThis.sound!="function")return console.error("Strudel loaded but functions not exposed to globalThis!"),console.log("  typeof globalThis.silence:",typeof globalThis.silence,"(should be object)"),console.log("  typeof globalThis.sound:",typeof globalThis.sound,"(should be function)"),console.log("  typeof globalThis.note:",typeof globalThis.note,"(should be function)"),!1;if(console.log("✅ Strudel loaded successfully with functions exposed"),console.log("🔇 Ensuring all patterns are silent..."),globalThis.silence&&typeof globalThis.silence=="object")for(let n=1;n<=16;n++)try{window.strudel.evaluate(`d${n} = silence`).catch(()=>{})}catch{}else console.warn("⚠️ silence pattern not available yet - skipping pattern slot initialization");return console.log("📦 Loading sound banks..."),await this.ensureDefaultSoundBanks()?console.log("✅ Default sound banks loaded"):console.warn("⚠️ Default sound banks failed to load"),console.log("📦 Preloading all sounds..."),await this.preloadAllCommonDrumSounds(),console.log("📦 Pre-loading all configured patterns..."),this.preloadAllPatterns().catch(n=>{console.log("⚠️ Pattern pre-loading failed:",n)}),this.soundsPreloaded=!0,console.log("✅✅✅ All sounds ready and preloaded!"),!0}catch(e){return console.error("Error initializing Strudel/sounds:",e),!1}}async initialize(){var e;if(this.initialized&&this.audioContext&&this.audioContext.state==="running")return!0;try{if(this.audioContext&&this.audioContext.state==="closed"&&(this.audioContext=null),!this.audioContext){const t=window.AudioContext||window.webkitAudioContext;window.__OriginalAudioContext||(window.__OriginalAudioContext=t),this.audioContext=new t;const n=this.audioContext,s=function(){return Et(this,"🎚️ AudioContext constructor hijacked - returning our shared context"),n};if(s.prototype=t.prototype,s.__proto__=t,window.AudioContext=s,window.webkitAudioContext&&(window.webkitAudioContext=s),window.__hijackedAudioContext=n,this.audioContext.__masterPanNode=!0,console.log("✅ AudioContext hijacked - all future AudioContext creations will use our shared context"),this.masterPanNode=this.audioContext.createStereoPanner(),this.masterGainNode=this.audioContext.createGain(),this._realDestination=this.audioContext.destination,this.masterPanNode.connect(this.masterGainNode),this.masterGainNode.connect(this._realDestination),Et(this,`🎚️ ✅ INITIAL: Connected masterPan -> masterGain -> destination (gain=${this.masterGainNode.gain.value.toFixed(3)})`),this.masterGainNode.gain.value=this.masterVolume,this.masterPanNode.pan.value=this.masterPan,this.gainNode=this.masterGainNode,console.log("💡 Master channel ready - will route Strudel through it during init"),this.strudelLoaded||(Et(this,"🎚️ Loading Strudel after hijacking AudioContext (master nodes ready for destination)..."),await this.loadStrudelFromCDN()),!AudioNode.prototype.__originalConnect){AudioNode.prototype.__originalConnect=AudioNode.prototype.connect;const r=this.masterPanNode,o=this.masterGainNode,a=this.audioContext,l=this,d=this._realDestination;AudioNode.prototype.connect=function(c,u,h){var B,F,W,z,ce,ie,se,pe,Se,st,Ze,St,it,je;if(l&&l._routingBypass===!0)return this.__originalConnect.call(this,c,u,h);const f=this.context,m=c==null?void 0:c.context,g=f&&f===a,O=m&&m===a,p=c===d||c===a.destination;if(!g||!(O||c&&!m&&p))return this.__originalConnect.call(this,c,u,h);if(l&&l.masterActive){const Ie=this.constructor.name,ee=((B=c==null?void 0:c.constructor)==null?void 0:B.name)||"unknown",kt=c===d||c===a.destination||((F=c==null?void 0:c.constructor)==null?void 0:F.name)==="AudioDestinationNode";l._allConnectionsDebugLogged||(l._allConnectionsDebugLogged=new Set);const ut=`${Ie}->${ee}`;l._allConnectionsDebugLogged.has(ut)||(console.log(`🔊 CONNECTION DEBUG: ${Ie} -> ${ee}, isDestination=${kt}, context=${this.context===a?"OUR":"OTHER"}`),l._allConnectionsDebugLogged.add(ut))}const M=this.constructor.name==="AnalyserNode",b=c===d||c===a.destination,S=c&&c.constructor&&c.constructor.name==="AudioDestinationNode";if((b||S)&&!M){l._allDestConnectionsLogged||(l._allDestConnectionsLogged=new Set);const Ie=`${this.constructor.name}->${(W=c==null?void 0:c.constructor)==null?void 0:W.name}`;l._allDestConnectionsLogged.has(Ie)||(l._logRoute(`🎚️ 🔴 DESTINATION CONNECTION: ${this.constructor.name} -> ${(z=c==null?void 0:c.constructor)==null?void 0:z.name}, masterActive=${l.masterActive}, trackedPatterns=${l.trackedPatterns.size}`),l._allDestConnectionsLogged.add(Ie))}if(l.masterActive&&!M){l._allConnectionsLogged||(l._allConnectionsLogged=new Set);const Ie=`${this.constructor.name}->${(ce=c==null?void 0:c.constructor)==null?void 0:ce.name}`;l._allConnectionsLogged.has(Ie)||(l._logRoute(`🎚️ Connection attempt: ${this.constructor.name} -> ${(ie=c==null?void 0:c.constructor)==null?void 0:ie.name}, isMasterDest=${b}, isAnyDest=${S}, masterActive=${l.masterActive}`),l._allConnectionsLogged.add(Ie))}const k=(b||S)&&!M,x=l.masterActive&&l.trackedPatterns.size>0,E=x;if(k){l._masterDestinationConnectLogged||(l._logRoute(`🎚️ ✅ INTERCEPTING connection to destination: ${this.constructor.name} -> ${(se=c==null?void 0:c.constructor)==null?void 0:se.name}, masterActive=${l.masterActive}, trackedPatterns=${l.trackedPatterns.size}`),l._masterDestinationConnectLogged=!0),l._nodeTypeConnectLogged||(l._nodeTypeConnectLogged=new Set);const Ie=this.constructor.name;if(l._nodeTypeConnectLogged.has(Ie)||(l._logRoute(`🎚️ Intercepting ${Ie} connecting to ${(pe=c==null?void 0:c.constructor)==null?void 0:pe.name}`),l._nodeTypeConnectLogged.add(Ie)),x){const ae=r||o;if(ae){if(r&&o)try{r.connect(o)}catch(Me){Me.message.includes("already")||console.warn(`⚠️ Master chain connect error: ${Me.message}`)}if(o&&l._realDestination)try{o.connect(l._realDestination)}catch(Me){Me.message.includes("already")||console.warn(`⚠️ Master destination connect error: ${Me.message}`)}return this.__punchcardMasterRouted=!0,this.__punchcardMasterConnectionNode=ae,this.__originalConnect.call(this,ae,u,h)}}let ee=null;if(!E&&l.masterActive&&l.trackedPatterns.size>0){const ae=Array.from(l.trackedPatterns.keys());if(ae.length===1)ee=ae[0],l._singleElementMasterRoutingLogged||(l._logRoute(`🎚️ Single element master detected, routing through ${ee} (trackedPatterns.size=${l.trackedPatterns.size})`),l._logRoute(`🎚️ currentEvaluatingSlot=${l.currentEvaluatingSlot}, patternSlotToElementId mapping:`,Array.from(l.patternSlotToElementId.entries())),l._singleElementMasterRoutingLogged=!0);else if(l.currentEvaluatingSlot){const Me=l.patternSlotToElementId.get(l.currentEvaluatingSlot);Me&&ae.includes(Me)&&(ee=Me,l._logRoute(`🎚️ Multi-element evaluate: routing via currentEvaluatingSlot ${l.currentEvaluatingSlot} -> ${ee}`))}}if(l.masterActive&&!ee&&l.currentEvaluatingSlot&&(ee=l.patternSlotToElementId.get(l.currentEvaluatingSlot),ee?l._logRoute(`🎚️ Found element from currentEvaluatingSlot: ${ee} (slot: ${l.currentEvaluatingSlot})`):l._logRoute(`🎚️ currentEvaluatingSlot=${l.currentEvaluatingSlot} but no mapping found. Available mappings:`,Array.from(l.patternSlotToElementId.entries()))),!ee)for(const[ae,Me]of l.patternSlotToElementId.entries())try{const qe=globalThis[ae];if(qe&&qe!==globalThis.silence){ee=Me,l._logRoute(`🎚️ Found element from active slot: ${ee} (slot: ${ae})`);break}}catch{}if(ee){const ae=l.getElementAudioNodes(ee);if(ae&&ae.gainNode){const Me=ae.panNode;if(this.__punchcardMasterRouted&&this.__punchcardMasterConnectionNode&&typeof this.disconnect=="function"){try{this.disconnect(this.__punchcardMasterConnectionNode),l._logRoute(`🎚️ Disconnected ${this.constructor.name} from master fallback before routing through element chain`)}catch{}this.__punchcardMasterRouted=!1,this.__punchcardMasterConnectionNode=null}if(Me)if(l.masterPanNode||l.masterGainNode)try{l._panNodeConnectedToMaster||(l._panNodeConnectedToMaster=new Set);const pn=`${ee}-${l.masterPanNode?"pan":"gain"}`;if(!l._panNodeConnectedToMaster.has(pn)){let xt=!1;if(l.masterPanNode)try{Me.connect(l.masterPanNode),xt=!0,l._panNodeConnectedToMaster.add(pn),l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.has(ee)||(l._logRoute(`🎚️ ✅ Connected ${ee} panNode -> masterPanNode`),l._panNodeConnectedLogged.add(ee))}catch(qt){if(qt.message.includes("already connected")||qt.message.includes("already been connected"))l._panNodeConnectedToMaster.add(pn),xt=!0;else throw qt}else if(l.masterGainNode)try{Me.connect(l.masterGainNode),xt=!0,l._panNodeConnectedToMaster.add(pn),l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.has(ee)||(l._logRoute(`🎚️ ✅ Connected ${ee} panNode -> masterGainNode (fallback)`),l._panNodeConnectedLogged.add(ee))}catch(qt){if(qt.message.includes("already connected")||qt.message.includes("already been connected"))l._panNodeConnectedToMaster.add(pn),xt=!0;else throw qt}xt||console.error(`❌ ${ee} panNode: Master nodes exist but connection failed!`)}}catch(pn){l._panNodeConnectionErrorLogged||(l._panNodeConnectionErrorLogged=new Set),l._panNodeConnectionErrorLogged.has(ee)||(console.error(`❌ Failed to connect ${ee} panNode to master chain:`,pn.message),console.error("   panNode:",Me),console.error("   masterPanNode:",l.masterPanNode),console.error("   masterGainNode:",l.masterGainNode),l._panNodeConnectionErrorLogged.add(ee))}else l._panNodeNotConnectedLogged||(l._panNodeNotConnectedLogged=new Set),l._panNodeNotConnectedLogged.has(ee)||(console.warn(`⚠️ ${ee} panNode: Master nodes not available yet (will connect when available)`),l._panNodeNotConnectedLogged.add(ee));let qe=[];qe.push(`gainNode: gain=${ae.gainNode.gain.value.toFixed(3)}, inputs=${ae.gainNode.numberOfInputs}, outputs=${ae.gainNode.numberOfOutputs}`),Me?qe.push(`panNode: pan=${Me.pan.value.toFixed(3)}, inputs=${Me.numberOfInputs}, outputs=${Me.numberOfOutputs}`):qe.push("panNode: MISSING"),l.masterPanNode?qe.push(`masterPanNode: inputs=${l.masterPanNode.numberOfInputs}, outputs=${l.masterPanNode.numberOfOutputs}`):qe.push("masterPanNode: MISSING"),l.masterGainNode?qe.push(`masterGainNode: gain=${l.masterGainNode.gain.value.toFixed(3)}, inputs=${l.masterGainNode.numberOfInputs}, outputs=${l.masterGainNode.numberOfOutputs}`):qe.push("masterGainNode: MISSING"),l._chainVerificationLogged||(l._chainVerificationLogged=new Set),l._chainVerificationLogged.has(ee)||(l._logRoute(`🎚️ INTERCEPTED: Routing ${ee} audio through element gain node (${this.constructor.name} -> ${ae.gainNode.constructor.name})`),l._logRoute(`🎚️ Audio chain verification for ${ee}:`,qe.join(", ")),l._chainVerificationLogged.add(ee));const ds=ae.panNode;if(ds&&!((Se=l._panNodeConnectedLogged)!=null&&Se.has(ee)))try{if(l.masterPanNode)try{ds.connect(l.masterPanNode),l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.add(ee),l._logRoute(`🎚️ ✅ CRITICAL: Connected ${ee} panNode -> masterPanNode`)}catch{l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.add(ee)}else if(l.masterGainNode)try{ds.connect(l.masterGainNode),l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.add(ee),l._logRoute(`🎚️ ✅ CRITICAL: Connected ${ee} panNode -> masterGainNode (fallback)`)}catch{l._panNodeConnectedLogged||(l._panNodeConnectedLogged=new Set),l._panNodeConnectedLogged.add(ee)}}catch(Vt){console.error(`❌ CRITICAL: Failed to connect ${ee} panNode: ${Vt.message}`)}const _n=this.__originalConnect.call(this,ae.gainNode,u,h);if(l._masterGainDestVerifiedAfterRouting||(l._masterGainDestVerifiedAfterRouting=new Set),!l._masterGainDestVerifiedAfterRouting.has(ee))if(l._masterGainDestVerifiedAfterRouting.add(ee),l._logRoute(`🎚️ 🔍 VERIFYING: masterGainNode=${!!l.masterGainNode}, _realDestination=${!!l._realDestination}, gain=${((St=(Ze=(st=l.masterGainNode)==null?void 0:st.gain)==null?void 0:Ze.value)==null?void 0:St.toFixed(3))||"N/A"}, muted=${l.masterMuted}`),l.masterGainNode&&l._realDestination)try{l.masterGainNode.connect(l._realDestination),l._logRoute(`🎚️ ✅ CRITICAL: Connected masterGainNode -> destination after routing ${ee} (gain=${l.masterGainNode.gain.value.toFixed(3)}, muted=${l.masterMuted})`)}catch(Vt){l._logRoute(`🎚️ ✅ CRITICAL: masterGainNode -> destination already connected for ${ee} (${Vt.message})`)}else console.error(`❌ CRITICAL: Cannot verify masterGainNode -> destination: masterGainNode=${!!l.masterGainNode}, _realDestination=${!!l._realDestination}`);return l._connectionSuccessLogged||(l._connectionSuccessLogged=new Set),l._connectionSuccessLogged.has(ee)||(l._logRoute(`🎚️ Connection result for ${ee}: ${_n?"SUCCESS":"FAILED"}, source inputs now: ${ae.gainNode.numberOfInputs}`),l._connectionSuccessLogged.add(ee)),this.__punchcardElementRouted!==!0&&(this.__punchcardElementRouted=!0),_n}else console.error(`❌ CRITICAL: Element ${ee} found but no gain node available - elementNodes=${!!ae}, gainNode=${!!(ae!=null&&ae.gainNode)}`),console.error("❌ This means audio will bypass element controls!"),ee=null}else{if(x){l._stackMasterRoutingLogged||(console.log(`🎚️ Stack() pattern: Routing through master chain (${l.trackedPatterns.size} elements)`),l._stackMasterRoutingLogged=!0);const Me=r||o;if(Me)return this.__originalConnect.call(this,Me,u,h)}l._noElementRoutingLogged||(l._logRoute(`🎚️ No element found for routing - trackedPatterns.size=${l.trackedPatterns.size}, currentEvaluatingSlot=${l.currentEvaluatingSlot}`),l._logRoute("🎚️ Available pattern slot mappings:",Array.from(l.patternSlotToElementId.entries())),l._logRoute("🎚️ Tracked elements:",Array.from(l.trackedPatterns.keys())),l._noElementRoutingLogged=!0)}if(l.masterActive&&l.trackedPatterns.size===1&&!ee){const ae=Array.from(l.trackedPatterns.keys());l._logRoute(`🎚️ 🔍 FALLBACK CHECK: trackedPatterns.size=${l.trackedPatterns.size}, elementId=${ee}, trackedElementIds=${ae.join(", ")}`),ae.length===1?(ee=ae[0],l._logRoute(`🎚️ ⚠️ Fallback: Using tracked element ${ee} for routing (elementId was null)`)):console.warn(`🎚️ ⚠️ Fallback: trackedElementIds.length=${ae.length}, expected 1`)}else l.trackedPatterns.size!==1?console.log(`🎚️ 🔍 FALLBACK SKIP: trackedPatterns.size=${l.trackedPatterns.size}, elementId=${ee} (not single element, skipping fallback)`):ee&&console.log(`🎚️ 🔍 FALLBACK SKIP: trackedPatterns.size=${l.trackedPatterns.size}, elementId=${ee} (elementId already set, skipping fallback)`);if(ee){console.log(`🎚️ 🔍 FALLBACK ROUTING ATTEMPT: elementId=${ee}, attempting to get elementNodes...`);const ae=l.getElementAudioNodes(ee);if(console.log(`🎚️ 🔍 FALLBACK ROUTING: elementNodes=${!!ae}, gainNode=${!!(ae!=null&&ae.gainNode)}, panNode=${!!(ae!=null&&ae.panNode)}`),ae&&ae.gainNode){const Me=ae.panNode;if(Me&&r)try{try{Me.disconnect(r)}catch{}Me.connect(r)}catch{}return console.log(`🎚️ ✅ FALLBACK ROUTING: Routing ${this.constructor.name} through ${ee} element chain (gain=${ae.gainNode.gain.value.toFixed(3)})`),this.__originalConnect.call(this,ae.gainNode,u,h)}else console.error(`❌ CRITICAL FALLBACK: Element ${ee} found but elementNodes or gainNode is missing - elementNodes=${!!ae}, gainNode=${!!(ae!=null&&ae.gainNode)}`),console.error("❌ Audio will route through master chain, bypassing element controls!")}else console.log("🎚️ 🔍 FALLBACK ROUTING SKIP: elementId is null, will route through master chain");const ut=x||l.trackedPatterns.size===0||!l.masterActive?r||o:null;if(ut){if(this.__punchcardElementRouted)return console.log(`🎚️ Skipping master fallback for ${this.constructor.name} (already routed through element chain)`),this.__originalConnect.call(this,c,u,h);l._masterRoutingLogged||(l._masterRoutingLogged=new Set);const ae=`master-${ut.constructor.name}`;if(!l._masterRoutingLogged.has(ae)){if(l._masterRoutingLogged.add(ae),console.log(`🎚️ ⚠️ FALLBACK: Routing ${this.constructor.name} through master chain (${ut.constructor.name}) - element routing not available`),console.log(`🎚️ ⚠️ FALLBACK: masterGainNode.gain=${((je=(it=o==null?void 0:o.gain)==null?void 0:it.value)==null?void 0:je.toFixed(3))||"N/A"}, muted=${l.masterMuted}, connected to destination=${!!l._realDestination}`),r&&o)try{r.connect(o),console.log("🎚️ ✅ FALLBACK: Verified masterPanNode -> masterGainNode connection")}catch(qe){qe.message.includes("already connected")||qe.message.includes("already been connected")?console.log("🎚️ ✅ FALLBACK: masterPanNode -> masterGainNode already connected"):console.warn(`⚠️ FALLBACK: Could not connect masterPanNode -> masterGainNode: ${qe.message}`)}if(o&&l._realDestination)try{o.connect(l._realDestination),console.log(`🎚️ ✅ FALLBACK: Ensured masterGainNode -> destination connection (gain=${o.gain.value.toFixed(3)})`)}catch(qe){console.log(`🎚️ ✅ FALLBACK: masterGainNode -> destination already connected (${qe.message})`)}}const Me=this.__originalConnect.call(this,ut,u,h);return this.__punchcardMasterRouted=!0,this.__punchcardMasterConnectionNode=ut,Me}if(!r&&!o&&console.warn("⚠️ No master nodes available, allowing direct connection to destination"),o&&d)try{o.connect(d),l._masterGainDestVerified||(console.log("🎚️ ✅ Ensured masterGainNode -> destination connection (critical for audio output)"),l._masterGainDestVerified=!0)}catch(ae){!l._masterGainDestVerified&&ae.message&&!ae.message.includes("already connected")&&(console.log(`🎚️ masterGainNode -> destination: ${ae.message.includes("already")?"already connected":"connection verified"}`),l._masterGainDestVerified=!0)}}return this.__originalConnect.call(this,c,u,h)},console.log("🎚️ Patched AudioNode.prototype.connect to route through element gain nodes or master channel"),console.log("🎚️ Hijacking verification: AudioNode.prototype.__originalConnect exists:",!!AudioNode.prototype.__originalConnect),console.log("🎚️ Hijacking verification: AudioNode.prototype.connect is patched:",AudioNode.prototype.connect!==AudioNode.prototype.__originalConnect)}this.audioContext.__masterPanNode=this.masterPanNode,console.log("Audio context created with master channel, state:",this.audioContext.state),Et(this,`🎚️ Master initialized: volume=${(this.masterVolume*100).toFixed(0)}%, pan=${this.masterPan.toFixed(2)}`)}if(this.audioContext.state==="suspended")try{Qs(),await this.audioContext.resume(),this.audioContext.state==="running"?console.log("Audio context resumed successfully"):console.log("Audio context state:",this.audioContext.state)}catch(t){return t.message&&t.message.includes("user gesture")||console.error("Cannot resume audio context:",t),!1}return this.audioContext&&this.audioContext.state==="running"?(this.initialized=!0,console.log("Sound Manager initialized successfully"),this.masterGainNode&&(this.masterGainNode.gain.value=this.masterVolume),this.masterPanNode&&(this.masterPanNode.pan.value=this.masterPan),Et(this,`🎚️ Master values set: volume=${(this.masterVolume*100).toFixed(0)}%, pan=${this.masterPan.toFixed(2)}`),console.log("🎵 Starting Strudel initialization and sound bank loading..."),this.initializeStrudelAndSounds().catch(t=>{console.error("Failed to initialize Strudel/sounds:",t)}),this.preloadAudioFiles().catch(t=>{console.log("Background audio preload failed:",t)}),!0):(console.warn("Audio context not in running state:",(e=this.audioContext)==null?void 0:e.state),!1)}catch(t){return console.error("Failed to initialize audio context:",t),this.initialized=!1,!1}}async preloadAudioFiles(){const e=et.getAudioElements();for(const t of e)if(t.audioFile)try{(await fetch(t.audioFile,{method:"HEAD"})).ok?await this.loadAudioFile(t.id,t.audioFile):console.log(`Skipping preload for ${t.id} (file not found): ${t.audioFile}`)}catch{}}async loadAudioFile(e,t){try{const n=await fetch(t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const s=await n.arrayBuffer(),r=await this.audioContext.decodeAudioData(s);return this.audioBuffers.set(e,r),r}catch(n){throw console.error(`Error loading audio file ${t}:`,n),n}}setVolume(e){this.volume=Math.max(0,Math.min(1,e)),this.gainNode&&(this.gainNode.gain.value=this.volume)}setMasterVolume(e){this.masterVolume=Math.max(0,Math.min(1,e)),this.masterGainNode?(this.masterGainNode.gain.value=this.masterVolume,Et(this,`🎚️ Master volume set to ${(this.masterVolume*100).toFixed(0)}% (gainNode instant via Web Audio API)`)):Et(this,`🎚️ Master volume stored as ${(this.masterVolume*100).toFixed(0)}% (gainNode not ready yet)`)}setMasterPan(e){this.masterPan=Math.max(-1,Math.min(1,e)),this.masterPanNode?(this.masterPanNode.pan.value=this.masterPan,Et(this,`🎚️ Master pan set to ${this.masterPan.toFixed(2)} (panNode instant via Web Audio API)`)):Et(this,`🎚️ Master pan stored as ${this.masterPan.toFixed(2)} (panNode not ready yet)`)}toggleMasterMute(){return this.masterMuted=!this.masterMuted,this.masterMuted?(this.masterVolumeBeforeMute=this.masterVolume,this.masterGainNode&&(this.masterGainNode.gain.value=0),console.log("🔇 Master muted (instant via Web Audio API)")):(this.masterGainNode&&(this.masterGainNode.gain.value=this.masterVolumeBeforeMute),this.masterVolume=this.masterVolumeBeforeMute,console.log(`🔊 Master unmuted (volume: ${(this.masterVolume*100).toFixed(0)}%) (instant via Web Audio API)`)),this.masterMuted}getElementAudioNodes(e){if(!this.audioContext)return null;if(!this.elementGainNodes.has(e)){const t=this.audioContext.createGain(),n=this.audioContext.createStereoPanner(),s=this.elementGainValues.get(e)||.8,r=this.elementPanValues.get(e)||0;this.elementGainNodes.set(e,t),this.elementPanNodes.set(e,n),this.elementGainValues.set(e,s),this.elementPanValues.set(e,r),t.gain.value=s*this.volume,n.pan.value=r,t.connect(n);let o=!1;if(this.masterPanNode)try{n.connect(this.masterPanNode),o=!0,Et(this,`🎚️ ${e}: Connected panNode to masterPanNode during node creation`)}catch(a){console.warn(`⚠️ ${e}: Failed to connect panNode to masterPanNode:`,a.message)}else if(this.masterGainNode)try{n.connect(this.masterGainNode),o=!0,Et(this,`🎚️ ${e}: Connected panNode to masterGainNode during node creation`)}catch(a){console.warn(`⚠️ ${e}: Failed to connect panNode to masterGainNode:`,a.message)}else if(this.gainNode)try{n.connect(this.gainNode),o=!0,Et(this,`🎚️ ${e}: Connected panNode to gainNode during node creation`)}catch(a){console.warn(`⚠️ ${e}: Failed to connect panNode to gainNode:`,a.message)}o||console.warn(`⚠️ ${e}: panNode not connected to master chain (master nodes may not exist yet - will connect on first audio connection)`),Et(this,`🎚️ Element audio chain for ${e}:`),console.log(`   gainNode (${t.numberOfInputs} inputs, ${t.numberOfOutputs} outputs)`),console.log(`   panNode (${n.numberOfInputs} inputs, ${n.numberOfOutputs} outputs)`),console.log(`   masterPanNode (${this.masterPanNode?this.masterPanNode.numberOfInputs:"N/A"} inputs)`),Et(this,`🎚️ Created element audio chain for ${e}: gain -> pan -> master`)}return{gainNode:this.elementGainNodes.get(e),panNode:this.elementPanNodes.get(e)}}disposeElementAudioNodes(e){if(!e)return;const t=this.elementGainNodes.get(e),n=this.elementPanNodes.get(e);if(t){try{t.disconnect()}catch{}this.elementGainNodes.delete(e)}if(n){try{n.disconnect()}catch{}this.elementPanNodes.delete(e)}this.elementGainValues.delete(e),this.elementPanValues.delete(e),this._panNodeConnectedToMaster&&(this._panNodeConnectedToMaster.delete(`${e}-pan`),this._panNodeConnectedToMaster.delete(`${e}-gain`))}isNotePattern(e){return!e||typeof e!="string"?!1:/\b(note|n)\s*\(/.test(e)}applyElementGainPanToPattern(e,t,n={}){const{applyGainInPattern:s=!0,applyPanInPattern:r=!0,applyTempoInPattern:o=!0}=n,a=this.elementGainValues.get(t)||.8,l=this.elementPanValues.get(t)||0,d=this.currentTempo||120;let c=e;c=c.replace(/\.postgain\s*\([^)]*\)/g,""),c=c.replace(/\.pan\s*\([^)]*\)/g,""),c=c.replace(/\.\.+/g,".").trim(),c=c.replace(/\.+$/,"").trim(),s&&(/\.postgain\s*\([^)]*\)\s*$/i.test(c)?c=c.replace(/\.postgain\s*\([^)]*\)\s*$/i,`.postgain(${a})`):c=`${c}.postgain(${a})`),r&&l!==0&&(c+=`.pan(${l})`);const u=d/120;return o&&(u>1?c+=`.fast(${u})`:u<1&&(c+=`.slow(${1/u})`)),console.log(`Applied gain=${a.toFixed(2)}, pan=${l.toFixed(2)}, tempo=${d} BPM (speed=${u.toFixed(2)}x) to ${t}`),c}async processPattern(e,t,n={}){const{preserveBanks:s=!1,attemptBankLoad:r=!1}=n||{};if(!e||typeof e!="string"||e.trim()==="")return null;let o=e.replace(/\s+/g," ").trim();if(o=o.replace(/\s+\./g,".").trim(),o=o.replace(/\.\.+/g,".").trim(),o=o.replace(/\.(cpm|fast|slow)\([^)]*\)/g,"").trim(),o=o.replace(/\.\.+/g,".").trim(),o=Na(o),!o||o==="")return console.warn(`[${t}] Pattern became empty after processing - cannot process`),null;const a=o.match(/\.bank\(["']([^"']+)["']\)/g);if(a){const d=a.map(u=>u.match(/\.bank\(["']([^"']+)["']\)/)[1]);console.log(`[${t}] Pattern uses bank(s):`,d);let c=!1;for(const u of d){const h=u,m=["RolandTR808","RolandTR909","RolandTR707","RhythmAce","AkaiLinn","ViscoSpaceDrum","CasioRZ1"].includes(h);let g=this.loadedBanks.has(h)||m;if(!g&&r&&typeof this.loadBank=="function")try{console.log(`[${t}] Attempting to load bank "${h}" for pattern processing`),await this.loadBank(h)?(this.loadedBanks.add(h),g=!0,console.log(`[${t}] Bank "${h}" loaded successfully for pattern processing`)):console.warn(`[${t}] Bank "${h}" could not be loaded on demand`)}catch(O){console.warn(`[${t}] Error loading bank "${h}":`,O)}!g&&!s?(console.warn(`⚠️ Bank "${h}" not loaded - removing .bank() modifier from pattern`),o=o.replace(new RegExp(`\\.bank(["']${h.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}["'])`,"g"),""),c=!0):!g&&s?console.warn(`⚠️ Bank "${h}" is not loaded but preserving .bank() for preview`):m&&(console.log(`[${t}] Bank "${h}" is built-in - keeping .bank() modifier`),this.loadedBanks.add(h))}if(o=o.replace(/\.+$/,"").trim(),c&&!s&&(!o||o.trim()===""))return console.warn("⚠️ Pattern became empty after removing unloaded banks"),null;console.log(`[${t}] Pattern after bank cleanup:`,o.substring(0,100))}const l=n.applyGainInPattern!==void 0?n.applyGainInPattern:this.masterActive;return o=this.applyElementGainPanToPattern(o,t,{applyGainInPattern:l}),!o||o.trim()===""?(console.warn(`[${t}] Pattern became empty after applying gain/pan - cannot process`),null):o}async preEvaluatePattern(e,t){if(!window.strudel||!window.strudel.evaluate)return console.log(`[${e}] Cannot pre-evaluate: Strudel not ready`),!1;if(!t||typeof t!="string"||t.trim()==="")return console.log(`[${e}] No pattern to pre-evaluate`),this.patternCache.set(e,{processedPattern:null,patternSlot:this.getPatternSlot(e),isPreEvaluated:!1,originalPattern:t||""}),!1;const n=await this.processPattern(t,e);if(!n)return console.warn(`[${e}] Pattern processing failed - cannot cache`),this.patternCache.set(e,{processedPattern:null,patternSlot:this.getPatternSlot(e),isPreEvaluated:!1,originalPattern:t}),!1;const s=this.getPatternSlot(e);try{const r=`${s} = silence`;return await window.strudel.evaluate(r),this.patternCache.set(e,{processedPattern:n,patternSlot:s,isPreEvaluated:!0,originalPattern:t}),console.log(`✅ Pre-evaluated and cached pattern for ${e} in ${s} (silent, ready for manual trigger)`),!0}catch(r){return console.warn(`[${e}] Failed to pre-evaluate pattern:`,r),this.patternCache.set(e,{processedPattern:n,patternSlot:s,isPreEvaluated:!1,originalPattern:t}),!1}}invalidatePatternCache(e){this.patternCache.delete(e),console.log(`🗑️ Invalidated pattern cache for ${e}`)}async preloadAllPatterns(){if(!window.strudel||!window.strudel.evaluate){console.log("Cannot preload patterns: Strudel not ready");return}console.log("📦 Pre-loading all configured patterns...");const e=et.elements||[];let t=0,n=0;for(const s of e){const r=s.id;let o=null;try{const l=localStorage.getItem(`element-config-${r}`);l&&(o=JSON.parse(l))}catch{}const a=(o==null?void 0:o.pattern)||(s==null?void 0:s.pattern)||"";a&&a.trim()!==""&&(await this.preEvaluatePattern(r,a)?t++:n++)}console.log(`✅ Pre-loaded ${t} patterns${n>0?`, ${n} failed`:""}`)}setElementGain(e,t){const n=Math.max(0,Math.min(1,t)),s=this.elementGainValues.get(e);this.elementGainValues.set(e,n),console.log(`[${e}] Gain set to ${n.toFixed(2)}`);const r=this.elementGainNodes.get(e);r&&(r.gain.value=n*this.volume,Et(this,`🎚️ Updated ${e} gain node to ${(n*this.volume).toFixed(2)}`)),s!==n&&(this.patternCache.get(e)&&(this.patternCache.delete(e),console.log(`🗑️ Invalidated pattern cache for ${e} (gain changed)`)),this.trackedPatterns.has(e)&&this.updateTrackedElementGain(e,n)),this.isPlaying(e)&&!this.masterActive&&s!==n&&this.updatePlayingPattern(e)}setElementPan(e,t){const n=Math.max(-1,Math.min(1,t)),s=this.elementPanValues.get(e);this.elementPanValues.set(e,n),console.log(`[${e}] Pan set to ${n.toFixed(2)}`);const r=this.elementPanNodes.get(e);r&&(r.pan.value=n,Et(this,`🎚️ Updated ${e} pan node to ${n.toFixed(2)}`)),s!==n&&(this.patternCache.get(e)&&(this.patternCache.delete(e),console.log(`🗑️ Invalidated pattern cache for ${e} (pan changed)`)),this.trackedPatterns.has(e)&&this.updateTrackedElementPan(e,n)),this.isPlaying(e)&&!this.masterActive&&s!==n&&this.updatePlayingPattern(e)}async updatePlayingPattern(e){const t=this.activeSounds.get(e);if(!t||t.type!=="strudel")return;const n=this.elementGainValues.get(e)||.8;if(n<=.001){console.log(`[${e}] Gain is ${n} (effectively muted) - stopping playback`),this.stopSound(e);return}const s=this.strudelPatternSlots.get(e);if(!(!s||!window.strudel||!window.strudel.evaluate))try{const r=et.getElementConfig(e);if(!r||!r.pattern)return;let o=r.pattern.replace(/\._scope\(\)/g,"");o=this.applyElementGainPanToPattern(o,e,{applyGainInPattern:!1}),await window.strudel.evaluate(`${s} = ${o}`),console.log(`✅ Updated ${s} with new gain/pan`)}catch(r){console.warn(`Could not update pattern for ${e}:`,r)}}async updatePatternInPlace(e,t){if(this.trackedPatterns.has(e)){const r=this.trackedPatterns.get(e),o=t.replace(/[""]/g,'"').replace(/['']/g,"'");r.rawPattern=o,r.pattern=this.convertPatternForScale(o)||o,Et(this,`🎚️ Updated tracked pattern for ${e} in master: ${t.substring(0,60)}...`),this.updateMasterPattern(this.soloedElements,this.mutedElements)}const n=this.activeSounds.get(e);if(!n||n.type!=="strudel")return;const s=this.strudelPatternSlots.get(e);if(!(!s||!window.strudel||!window.strudel.evaluate))try{let r=t.replace(/\s+/g," ").trim();r=r.replace(/\s+\./g,".").trim(),r=r.replace(/\.\.+/g,".").trim(),r=r.replace(/\.(cpm|fast|slow)\([^)]*\)/g,"").trim(),r=r.replace(/\.\.+/g,".").trim();const o=r.match(/\.bank\(["']([^"']+)["']\)/g);if(o){const a=o.map(l=>l.match(/\.bank\(["']([^"']+)["']\)/)[1]);for(const l of a)this.loadedBanks.has(l)||(r=r.replace(new RegExp(`\\.bank(["']${l}["'])`,"g"),""));r=r.replace(/\.+$/,"").trim()}r=this.applyElementGainPanToPattern(r,e,{applyGainInPattern:this.masterActive}),await window.strudel.evaluate(`${s} = ${r}`),console.log(`✅ Updated ${s} pattern in place: ${r.substring(0,60)}...`)}catch(r){console.warn(`Could not update pattern in place for ${e}:`,r)}}getElementGain(e){return this.elementGainValues.get(e)||.8}getElementPan(e){return this.elementPanValues.get(e)||0}async playSynthesizedSound(e,t){if(!this.initialized||!this.audioContext){console.log("Audio not initialized - waiting for user interaction");return}if(this.audioContext.state==="suspended")try{if(Qs(),await this.audioContext.resume(),this.audioContext.state!=="running"){console.log("Audio context not running - user interaction required");return}}catch{console.log("Audio context needs user interaction");return}this.stopSound(e);const n=this.parsePattern(t);if(n.sounds.length===0){console.warn(`No sounds parsed from pattern: ${t}`);return}console.log(`Playing pattern for ${e}:`,t,n);try{const s=this.createOscillatorForPattern(n,e);s&&s.gain?(this.activeSounds.set(e,{type:"synthesized",oscillator:s,gain:s.gain}),console.log(`Sound started for ${e}`)):console.error(`Failed to create oscillator for ${e}`)}catch(s){console.error(`Error playing sound for ${e}:`,s)}}parsePattern(e){let t=e;const n=e.match(/(?:sound|s)\(["']([^"']+)["']\)/);n&&(t=n[1]);const s={bd:{freq:60,duration:.1,type:"sine"},sd:{freq:200,duration:.05,type:"noise"},hh:{freq:800,duration:.02,type:"square"},cp:{freq:400,duration:.08,type:"triangle"},misc:{freq:300,duration:.06,type:"triangle"}},r=[];if(t.split(",").forEach((l,d)=>{let c=l.trim();c=c.replace(/(\w+)\*(\d+)/g,(f,m,g)=>Array(parseInt(g)).fill(m).join(" ")),c=c.replace(/\[([^\]]+)\]/g,(f,m)=>m.trim());const u=c.trim().split(/\s+/);let h=0;for(const f of u){if(f==="~"||f===""){h++;continue}s[f]&&r.push({...s[f],time:h*.25}),h++}}),r.length===0)return console.warn(`No sounds found in pattern: ${e}`),{sounds:[],duration:0};r.sort((l,d)=>l.time-d.time);const a=Math.max(...r.map(l=>l.time+l.duration));return{sounds:r,duration:Math.max(a,.5)}}parseIndexPattern(e){const t=[];let n=e.replace(/<([^>]+)>/g,(r,o)=>o.trim().split(/\s+/)[0]);n=n.replace(/\[([^\]]+)\]/g,(r,o)=>o.trim()),n=n.replace(/(\d+)\*(\d+)/g,(r,o,a)=>Array(parseInt(a)).fill(o).join(" "));const s=n.trim().split(/\s+/);for(const r of s){const o=parseInt(r);isNaN(o)||t.push(o)}return t}createPatternFromIndices(e){const t=["bd","sd","hh","cp","bd","sd","hh","cp"];return`sound("${e.map(s=>t[s%t.length]||"~").join(" ")}")`}createPatternFromSampleName(e){return e.includes("break")||e.includes("165")?'sound("bd ~ sd ~ bd ~ sd hh")':'sound("bd sd hh ~ cp ~ hh ~")'}createOscillatorForPattern(e,t){if(!this.audioContext)return console.error("Audio context not initialized"),{gain:null,stop:()=>{}};const n=this.audioContext.createGain(),s=t?this.getElementAudioNodes(t):null;s?(n.connect(s.gainNode),n.gain.value=1):(n.connect(this.gainNode),n.gain.value=this.volume);const r=this.audioContext.currentTime;e.sounds.forEach((a,l)=>{const d=r+a.time;if(a.type==="noise"){const c=Math.floor(this.audioContext.sampleRate*a.duration),u=this.audioContext.createBuffer(1,c,this.audioContext.sampleRate),h=u.getChannelData(0);for(let g=0;g<c;g++)h[g]=Math.random()*2-1;const f=this.audioContext.createBufferSource();f.buffer=u;const m=this.audioContext.createGain();f.connect(m),m.connect(n),m.gain.setValueAtTime(0,d),m.gain.linearRampToValueAtTime(.3,d+.01),m.gain.exponentialRampToValueAtTime(.01,d+a.duration),f.start(d),f.stop(d+a.duration)}else{const c=this.audioContext.createOscillator();c.type=a.type,c.frequency.value=a.freq;const u=this.audioContext.createGain();c.connect(u),u.connect(n),u.gain.setValueAtTime(0,d),u.gain.linearRampToValueAtTime(.5,d+.01),u.gain.exponentialRampToValueAtTime(.01,d+a.duration),c.start(d),c.stop(d+a.duration)}});const o=r+e.duration;return n.gain.setValueAtTime(this.volume,o),n.gain.exponentialRampToValueAtTime(.01,o+.1),{gain:n,stop:()=>{try{n.gain.cancelScheduledValues(this.audioContext.currentTime),n.gain.setValueAtTime(n.gain.value,this.audioContext.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),setTimeout(()=>n.disconnect(),150)}catch(a){console.error("Error stopping sound:",a)}}}}playAudioFile(e,t){if(!this.initialized||!this.audioContext){console.warn("Audio not initialized yet. Please click anywhere first to enable audio.");return}this.audioContext.state==="suspended"&&(Qs(),this.audioContext.resume().catch(s=>{console.error("Failed to resume audio context:",s)})),this.stopSound(e);const n=this.audioBuffers.get(e);n?this.playAudioBuffer(e,n):this.loadAudioFile(e,t).then(s=>{this.playAudioBuffer(e,s)}).catch(s=>{console.error(`Failed to play audio for ${e}:`,s)})}playAudioBuffer(e,t){const n=this.audioContext.createBufferSource();n.buffer=t;const s=this.audioContext.createGain();n.connect(s);const r=this.getElementAudioNodes(e);r?(s.connect(r.gainNode),s.gain.value=1):(s.connect(this.gainNode),s.gain.value=this.volume);const o=r?1:this.volume;s.gain.setValueAtTime(0,this.audioContext.currentTime),s.gain.linearRampToValueAtTime(o,this.audioContext.currentTime+et.defaults.fadeInTime),n.onended=()=>{this.activeSounds.delete(e)},n.start(0),this.activeSounds.set(e,{type:"audio",source:n,gain:s})}async playStrudelPattern(e,t,n,s=!1){var a;if(!t||typeof t!="string"||t.trim()===""){console.log(`[${e}] No pattern assigned - skipping playback`);return}const r=this.elementGainValues.get(e)||.8;if(r<=.001){console.log(`[${e}] Gain is ${r} (effectively muted) - stopping playback`),this.stopSound(e);return}if(this.masterOnlyPlayback){const l=typeof e=="string"&&e.toLowerCase().includes("preview"),d=l,c=await this.routePatternThroughMaster(e,t,{isPreview:l,autoStart:d});return console.log(`🎚️ Routed ${e} through master-only playback`,c),c}if(!s){const l=document.querySelector(`[data-sound-id="${e}"]`);if(l){const d=l.querySelector(".loop-button");if((d==null?void 0:d.classList.contains("active"))&&this.isPlaying(e)){console.log(`🔄 ${e} has loop active and is playing - skipping sound trigger to prevent layering`);return}}}if(!this.initialized||!this.audioContext){console.log("Audio not initialized - attempting to initialize now...");try{await this.initialize()||console.warn("⚠️ Audio initialization failed - sounds may not play until user clicks")}catch(l){console.warn("⚠️ Error initializing audio:",l)}}if(this.strudelSoundBanksLoaded||console.log(`⏳ Sound banks not fully loaded yet for ${e}, but attempting to play anyway...`),this.audioContext.state==="suspended"){console.log(`🔄 Audio context is suspended for ${e}, attempting to resume...`);try{Qs(),await this.audioContext.resume(),await new Promise(l=>setTimeout(l,50)),this.audioContext.state!=="running"?(console.warn(`⚠️ Audio context not running after resume attempt - state: ${this.audioContext.state}`),console.warn("   User interaction (click) may be required to resume audio")):console.log(`✅ Audio context resumed successfully for ${e}`)}catch(l){console.warn("⚠️ Failed to resume audio context:",l),console.warn("   User interaction (click) may be required to resume audio")}}this.stopSound(e),window.strudel&&window.strudel.scheduler&&!window.strudel.scheduler.started&&(console.log(`▶️ Starting scheduler for ${e} playback...`),await window.strudel.scheduler.start()),console.log(`Playing Strudel pattern for ${e}:`,t);try{if(window.strudel||await this.loadStrudelFromCDN(),!window.strudel||!window.strudel.evaluate||typeof window.strudel.evaluate!="function")throw console.error("❌ window.strudel.evaluate is not available"),console.error("window.strudel:",window.strudel),new Error("Strudel REPL evaluate function is not available. Strudel may not have initialized correctly.");if(console.log("Strudel evaluate is available..."),typeof globalThis.note=="function"&&typeof globalThis.sound=="function")console.log("✅ Core functions verified and available");else{const u=new Error("Core functions not available");console.warn("Core functions not available, attempting to load...");try{const{coreModule:h}=await Vi();window.__coreModule=h,await window.strudel.evaluate(`
            (function() {
              const core = window.__coreModule || {};
              if (core && typeof core === 'object') {
                Object.assign(globalThis, core);
              }
              globalThis.__core_loaded = true;
            })();
          `);for(let f=0;f<20;f++){try{if(await window.strudel.evaluate("globalThis.__core_loaded === true")&&typeof globalThis.note=="function"){console.log("✅ Core functions loaded into REPL");break}}catch{}await new Promise(m=>setTimeout(m,100))}}catch(h){console.warn("Could not load core functions:",h)}}await this.ensureDefaultSoundBanks()||console.warn("⚠️ Continuing without default sound banks - patterns may fail");try{console.log("Registering sawtooth sound...");try{const{webaudioModule:u}=await Vi(),h=`
                (function() {
                  const webaudio = window.__webaudioModule || {};
                  const { registerSound, getAudioContext } = webaudio;
                  
                  registerSound('sawtooth', (time, value, onended) => {
                    let { freq } = value;
                    const ctx = getAudioContext();
                    const o = new OscillatorNode(ctx, { type: 'sawtooth', frequency: Number(freq) || 440 });
                    o.start(time);
                    const g = new GainNode(ctx, { gain: 0.3 });
                    o.connect(g);
                    const stop = (time) => {
                      o.stop(time);
                      o.disconnect();
                      g.disconnect();
                      onended();
                    };
                    o.addEventListener('ended', () => {
                      o.disconnect();
                      g.disconnect();
                      onended();
                    });
                    return { node: g, stop };
                  }, { type: 'synth' });
                  
                  // Make registerSound and getAudioContext available globally for future use
                  globalThis.registerSound = registerSound;
                  globalThis.getAudioContext = getAudioContext;
                })();
              `;window.__webaudioModule=u,await window.strudel.evaluate(h),await new Promise(f=>setTimeout(f,200)),console.log("✅ Sawtooth sound registered (will be verified on first use)")}catch(u){console.warn("Could not use webaudio module:",u);try{const{webaudioModule:h}=await Vi();window.__webaudioModule=h,await window.strudel.evaluate(`
                  (function() {
                    const webaudio = window.__webaudioModule || {};
                    const { registerSound, getAudioContext } = webaudio;
                  
                  if (registerSound && getAudioContext) {
                    registerSound('sawtooth', (time, value, onended) => {
                      let { freq } = value;
                      const ctx = getAudioContext();
                      const o = new OscillatorNode(ctx, { type: 'sawtooth', frequency: Number(freq) || 440 });
                      o.start(time);
                      const g = new GainNode(ctx, { gain: 0.3 });
                      o.connect(g);
                      const stop = (time) => {
                        o.stop(time);
                      };
                      o.addEventListener('ended', () => {
                        o.disconnect();
                        g.disconnect();
                        onended();
                      });
                      return { node: g, stop };
                    }, { type: 'synth' });
                  }
                })();
              `),await new Promise(m=>setTimeout(m,200)),console.log("✅ Sawtooth sound registered via REPL")}catch(h){console.warn("Could not register sawtooth via fallback:",h)}}}catch(u){console.warn("Could not register sawtooth sound:",u),console.warn("Pattern may still work if sawtooth is a default sound")}if(n){const u=window.strudel.samples||globalThis.samples;if(u&&typeof u=="function")try{if(typeof n=="string")console.log("Loading custom samples with string:",n),await u(n),console.log("Custom samples loaded successfully");else if(typeof n=="object"&&n!==null){const h=et.getElementConfig(e),f=(h==null?void 0:h.samplesBaseUrl)||"";console.log("Loading custom samples:",n),console.log("Base URL:",f),await u(n,{baseUrl:f}),console.log("Custom samples loaded successfully")}}catch(h){console.error("Error loading custom samples:",h)}}try{if(typeof globalThis.note=="function"&&typeof globalThis.sound=="function")console.log("✅ Verified core functions are available");else{const O=new Error("Core functions not available");console.warn("Core functions check failed, attempting to load..."),console.warn("⚠️ Core functions not available, attempting to load now...");try{const{coreModule:p}=await Vi();window.__coreModule=p,await window.strudel.evaluate(`
              (function() {
                const core = window.__coreModule || {};
                if (core && typeof core === 'object') {
                  Object.assign(globalThis, core);
                }
                globalThis.__core_loaded = true;
              })();
            `);for(let y=0;y<20;y++){try{if(await window.strudel.evaluate("globalThis.__core_loaded === true")&&typeof globalThis.note=="function")break}catch{}await new Promise(M=>setTimeout(M,100))}}catch(p){throw console.error("❌ Failed to load core functions:",p),new Error("Core Strudel functions (note, samples, etc.) are not available in REPL context. Pattern evaluation will fail.")}}if(console.log("Evaluating pattern:",t),window.strudel&&window.strudel.evaluate)try{const O=[];let p=0;for(;;){const y=t.indexOf("samples(",p);if(y===-1)break;let M=0,b=!1,S="",k=y+8;for(;k<t.length&&/\s/.test(t[k]);)k++;if(k<t.length&&t[k]==="{"){const x=k;for(M=1,k++;k<t.length&&M>0;){const E=t[k];b?E===S&&t[k-1]!=="\\"&&(b=!1):E==='"'||E==="'"?(b=!0,S=E):E==="{"?M++:E==="}"&&M--,k++}if(M===0){const E=t.substring(x,k);for(;k<t.length&&(/\s/.test(t[k])||t[k]===",");)k++;let B=null;if(k<t.length&&(t[k]==='"'||t[k]==="'")){const F=t[k],W=k;for(k++;k<t.length;){if(t[k]==="\\"){k+=2;continue}if(t[k]===F){B=t.substring(W,k+1),k++;break}k++}}for(;k<t.length&&/\s/.test(t[k]);)k++;if(k<t.length&&t[k]===")"){const F=t.substring(y,k+1);O.push({fullCall:F,samplesObj:E,secondParam:B}),p=k+1;continue}else if(k<t.length){const F=t.substring(y,k);O.push({fullCall:F,samplesObj:E,secondParam:B}),p=k;continue}}}p=y+1}for(const y of O){const M=y.fullCall,b=y.samplesObj,S=y.secondParam;O.push({fullCall:M,samplesObj:b,secondParam:S})}for(const y of O)try{console.log("📦 Pre-loading samples() call in REPL:",y.fullCall),await window.strudel.evaluate(y.fullCall),console.log("✅ Samples loaded via REPL evaluation"),await new Promise(M=>setTimeout(M,500))}catch(M){console.warn("Could not evaluate samples() call in REPL:",M);try{const b=((a=window.strudel)==null?void 0:a.samples)||globalThis.samples;if(b&&typeof b=="function"){let S={};try{S=new Function("return "+y.samplesObj)()}catch(k){console.warn("Could not parse samples object:",k);continue}if(Object.keys(S).length>0){if(console.log("📦 Loading samples directly as fallback:",S),y.secondParam){let k=null;try{const x=y.secondParam.trim();x.startsWith("{")?k=new Function("return "+x)():k=x.replace(/^["']|["']$/g,""),await b(S,k)}catch{const E=y.secondParam.trim().replace(/^["']|["']$/g,"");await b(S,E)}}else await b(S);await new Promise(k=>setTimeout(k,500))}}}catch(b){console.warn("Fallback samples loading also failed:",b)}}O.length>0&&console.log(`✅ Pre-loaded ${O.length} samples() call(s) - pattern will be evaluated with samples already loaded`)}catch(O){console.warn("Error pre-loading samples from pattern:",O)}const u=this.getPatternSlot(e);console.log(`Assigning pattern to ${u} for element ${e}`);const h=this.getElementAudioNodes(e);(!h||!h.gainNode)&&console.warn(`⚠️ Could not prepare audio nodes for ${e} (pattern slot ${u})`),this.currentEvaluatingSlot=u;let f=null;const m=this.patternCache.get(e);if(m&&m.originalPattern===t&&m.processedPattern)f=m.processedPattern,console.log(`⚡ Using cached pattern for ${e} (instant trigger)`),f=this.applyElementGainPanToPattern(m.processedPattern.replace(/\.gain\([^)]*\)/g,"").replace(/\.pan\([^)]*\)/g,"").replace(/\.fast\([^)]*\)/g,"").replace(/\.slow\([^)]*\)/g,"").trim(),e,{applyGainInPattern:this.masterActive});else{if(console.log(`📝 Processing pattern for ${e} (not cached)`),f=await this.processPattern(t,e,{applyGainInPattern:this.masterActive}),!f){console.warn(`[${e}] Pattern processing failed - cannot evaluate`);try{const O=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(O);return}catch(O){console.error(`Failed to set ${u} to silence:`,O);return}}this.patternCache.set(e,{processedPattern:f,patternSlot:u,isPreEvaluated:!1,originalPattern:t})}if(!f||f.trim()===""){console.warn(`[${e}] Pattern became empty - cannot evaluate`);return}f.includes("undefined")&&!f.includes("globalThis.undefined")&&(console.warn("⚠️ Pattern contains 'undefined' - might be from removed samples() call"),f=f.replace(/undefined\s*[,\n;]/g,"").trim(),f=f.replace(/,\s*undefined/g,"").trim(),f=f.replace(/undefined\s*\./g,"").trim());const g=`${u} = ${f}`;console.log(`🎼 ${e} → ${u}:`),console.log(`   Full Pattern: ${f.substring(0,200)}${f.length>200?"...":""}`),console.log(`   Assignment: ${g.substring(0,200)}${g.length>200?"...":""}`);try{window.strudel&&window.strudel.scheduler&&!window.strudel.scheduler.started&&(console.log(`▶️ Starting scheduler for ${e} pattern evaluation...`),await window.strudel.scheduler.start());const O=await window.strudel.evaluate(g);this.currentEvaluatingSlot=u;const p=this.soundsPreloaded?500:1e3;if(setTimeout(()=>{this.currentEvaluatingSlot===u&&(this.currentEvaluatingSlot=null)},p),O&&typeof O=="object"&&O.message&&O.message.includes("undefined instead of pattern")){console.warn("⚠️ Pattern returned undefined - setting to silence");try{const y=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(y);return}catch(y){console.error(`Failed to set ${u} to silence:`,y);return}}console.log(`✅ Pattern assignment attempted for ${u}`)}catch(O){if(O.message&&O.message.includes("undefined instead of pattern")){console.error("❌ Pattern evaluation failed: pattern returned undefined"),console.error("   This usually means:"),console.error("   - Bank samples aren't loaded (check .bank() usage)"),console.error("   - Pattern syntax is invalid"),console.error("   - Required samples/sounds aren't available"),console.error(`   Pattern: ${f.substring(0,100)}`);try{const p=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(p),console.log(`✅ Set ${u} to silence due to pattern error`)}catch(p){console.error(`Failed to set ${u} to silence:`,p)}return}if(O.message.includes("not defined")||O.message.includes("ReferenceError")){console.log(`Slot ${u} doesn't exist, creating it...`);try{const p=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(p),await window.strudel.evaluate(g),console.log(`✅ Pattern assigned to ${u} after slot creation`)}catch(p){if(console.error(`❌ Failed to assign pattern to ${u} even after creating slot:`,p),p.message&&p.message.includes("undefined instead of pattern")){console.error("   Pattern still invalid - setting to silence");try{const y=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(y)}catch(y){console.error(`Failed to set ${u} to silence:`,y)}return}throw p}}else{console.error(`❌ Failed to assign pattern to ${u}:`,O);try{const p=typeof globalThis.silence=="object"?`${u} = globalThis.silence`:`${u} = silence`;await window.strudel.evaluate(p),console.log(`✅ Set ${u} to silence as fallback`)}catch(p){console.error(`Failed to set ${u} to silence:`,p)}return}}}catch(u){if(console.error("❌ Error evaluating pattern:",u),console.error("Pattern was:",t),console.error("Error details:",u.message),u.message&&u.message.includes("undefined instead of pattern")||u.isUndefinedPattern===!0){console.warn("⚠️ Pattern evaluation returned undefined"),console.warn("   This usually means:"),console.warn("   - Bank samples aren't loaded (check .bank() usage)"),console.warn("   - Pattern syntax is invalid"),console.warn("   - Required samples/sounds aren't available"),console.warn(`   Pattern: ${t.substring(0,100)}`);const h=this.getPatternSlot(e);try{await window.strudel.evaluate(`${h} = silence`),console.log(`✅ Set ${h} to silence due to pattern error`)}catch(f){console.warn(`⚠️ Failed to set ${h} to silence:`,f.message)}return}throw(u.message.includes("note is not defined")||u.message.includes("s is not defined"))&&(console.error("❌ Core Strudel functions (note, s, etc.) are not available in REPL context"),console.error("This means Strudel REPL was not properly initialized with core functions"),console.error("Pattern cannot be evaluated without core functions - NOT using fallback")),u}console.log(`Strudel pattern started for ${e}`),this.currentEvaluatingSlot=null;const d=this.strudelPatternSlots.get(e);if(typeof e=="string"&&e.toLowerCase().includes("preview"))this.trackedPatterns.has(e)&&(this.trackedPatterns.delete(e),console.log(`🗑️ Removed preview element ${e} from master tracking`),this.updateMasterPattern(this.soloedElements,this.mutedElements));else if(!this.trackedPatterns.has(e)){const u=this.getElementGain(e)||.8,h=this.getElementPan(e)||0,f=t.replace(/[""]/g,'"').replace(/['']/g,"'");this.trackedPatterns.set(e,{pattern:f,gain:u,pan:h,muted:!1,soloed:!1}),console.log(`➕ Auto-added ${e} to master tracked patterns`),this.updateMasterPattern(this.soloedElements,this.mutedElements)}this.activeSounds.set(e,{type:"strudel",patternSlot:d,stop:()=>{window.strudel.evaluate&&d&&(console.log(`🔇 Stopping ${e} (${d}) - setting to silence`),window.strudel.evaluate(`${d} = silence`).then(()=>{console.log(`✅ ${d} silenced`)}).catch(u=>{console.error(`❌ Error stopping pattern in ${d}:`,u)}))}});return}catch(l){console.warn("Failed to load Strudel from local packages:",l)}console.warn("Using simplified pattern parsing as fallback...");const o=t.match(/s\(["']([^"']+)["']\)/);if(o){const l=o[1],d=t.match(/\.slice\((\d+)\s*,\s*"([^"]+)"\)/);if(d){const c=this.parseIndexPattern(d[2]),u=this.createPatternFromIndices(c);await this.playSynthesizedSound(e,u)}else{const c=this.createPatternFromSampleName(l);await this.playSynthesizedSound(e,c)}}else await this.playSynthesizedSound(e,t)}async loadStrudelFromCDN(){var n,s,r;const e=typeof globalThis.silence=="object"&&typeof globalThis.sound=="function"&&typeof globalThis.note=="function";if(this.strudelLoaded&&window.strudel&&window.strudel.evaluate&&e){console.log("Strudel already loaded, initialized, and functions exposed");return}if(e||console.log("Functions not exposed, need to reload/expose:",{silence:typeof globalThis.silence+" (should be object)",sound:typeof globalThis.sound+" (should be function)",note:typeof globalThis.note+" (should be function)"}),this.strudelLoading){for(console.log("Strudel is currently loading, waiting...");this.strudelLoading;)await new Promise(o=>setTimeout(o,100));if(this.strudelLoaded&&window.strudel){console.log("Strudel loading completed by another call");return}}this.strudelLoading=!0,console.log("Loading Strudel...");try{const{webModule:o,coreModule:a,webaudioModule:l,tonalModule:d}=await Vi(),c=o;console.log("✅ Loaded Strudel from local packages");let u=null,h=null,f=!1,m=l.webaudioOutput||((n=l.default)==null?void 0:n.webaudioOutput)||(c==null?void 0:c.webaudioOutput);!m&&typeof l=="function"&&(m=l),!m&&typeof l.default=="function"&&(m=l.default);const g=c.repl||o.repl,O=c.initStrudel||o.initStrudel;if(!g&&!O)throw new Error("Strudel REPL not available");if(console.log("Available initialization methods:",{hasRepl:!!g,hasInitStrudel:!!O}),!m||typeof m!="function")throw console.error("webaudioModule structure:",Object.keys(l||{})),console.error("webaudioOutput type:",typeof m),new Error("Strudel webaudioOutput not available or not a function");console.log("✅ Core module loaded, available functions:",Object.keys(a).filter(b=>typeof a[b]=="function").slice(0,15)),console.log("webaudioOutput type:",typeof m),this.strudelOutputFactory=m,console.log("Merging modules..."),console.log("  coreModule keys:",a?Object.keys(a).length:0),console.log("  tonalModule keys:",d?Object.keys(d).length:0),console.log("  webaudioModule keys:",l?Object.keys(l).length:0),console.log("  webModule keys:",o?Object.keys(o).length:0);const p={...a||{},...d||{},...l||{},...o||{},...zl||{}};if(Object.keys(p).forEach(b=>{p[b]===void 0&&delete p[b]}),console.log("After merge - allModules total keys:",Object.keys(p).length),console.log("After merge - function count:",Object.keys(p).filter(b=>typeof p[b]=="function").length),typeof globalThis.silence=="object"&&typeof globalThis.sound=="function"&&typeof globalThis.note=="function"?(console.log("Strudel functions already properly exposed to globalThis, skipping..."),console.log("Verification - typeof globalThis.silence:",typeof globalThis.silence,"(Pattern object)"),console.log("Verification - typeof globalThis.sound:",typeof globalThis.sound,"(function)"),console.log("Verification - typeof globalThis.note:",typeof globalThis.note,"(function)")):(console.log("Exposing all Strudel functions to globalThis..."),console.log("allModules keys:",Object.keys(p).length),console.log("Sample functions:",Object.keys(p).filter(b=>typeof p[b]=="function").slice(0,10)),Object.assign(globalThis,p),globalThis.__strudelModulesExposed=!0,console.log("✅ Exposed",Object.keys(p).filter(b=>typeof p[b]=="function").length,"functions to globalThis"),console.log("Verification - typeof globalThis.silence:",typeof globalThis.silence,"(Pattern object)"),console.log("Verification - typeof globalThis.sound:",typeof globalThis.sound,"(function)"),console.log("Verification - typeof globalThis.note:",typeof globalThis.note,"(function)")),h=o.samples||l.samples||c.samples,h?(globalThis.samples=h,console.log("✅ Samples function exposed to globalThis")):console.warn("⚠️ No samples function found in any module"),(o.getAudioContext||l.getAudioContext)&&console.log("✅ Audio context getter available"),console.log("🎚️ Using element channel routing:",!!(this.masterPanNode&&this.masterGainNode)),!globalThis.__strudelPatternsPreInitialized){console.log("🎰 PRE-REPL: Initializing pattern slots d0-d16 on globalThis...");const b=p.silence||globalThis.silence;if(b&&typeof b=="object"){for(let S=0;S<=16;S++)globalThis[`d${S}`]=b;console.log("✅ PRE-REPL: Pattern slots initialized with silence pattern")}else{console.warn("⚠️ PRE-REPL: silence pattern not available, creating empty pattern objects");const S={_type:"pattern",query:()=>[],firstCycle:()=>[]};for(let k=0;k<=16;k++)globalThis[`d${k}`]=S}globalThis.__strudelPatternsPreInitialized=!0,console.log("✅ PRE-REPL: Pattern slots are now defined on globalThis")}if(O&&typeof O=="function"){console.log("Using initStrudel for proper initialization...");try{if(!this.midiEnabled)try{await this.initializeMIDI()}catch(E){console.warn("⚠️ MIDI initialization failed, continuing without MIDI:",E)}const b=E=>{this.midiEnabled&&this.sendMIDIMessage(E)},S={audioContext:this.audioContext,getTime:()=>this.audioContext?this.audioContext.currentTime:0,editPattern:()=>{},setUrl:()=>{},midiOutput:b};console.log("🎚️ initStrudel options:",Object.keys(S));const k=await O(S);u=k.repl||k,console.log("✅ initStrudel completed, replInstance:",!!u);try{const E=await fetch("/strudel.json");if(E.ok){const B=await E.json();if(B.samples){const F=((s=window.strudel)==null?void 0:s.samples)||globalThis.samples;F&&typeof F=="function"&&(console.log("📦 Loading samples from strudel.json"),await F(B.samples),console.log("✅ Samples loaded from strudel.json"))}}}catch{console.log("ℹ️ No strudel.json found or error loading it (this is optional)")}try{await this.preloadPresetSamples()}catch(E){console.warn("⚠️ Error pre-loading preset samples:",E)}try{this.setupStrudelMIDIOutput(),setTimeout(async()=>{try{await this.ensureMIDIFunctionsAvailable()}catch(E){console.warn("⚠️ Error ensuring MIDI functions available:",E)}},1e3)}catch(E){console.warn("⚠️ Error setting up MIDI functions:",E)}console.log("replInstance type:",typeof u),console.log("replInstance.evaluate available:",typeof(u==null?void 0:u.evaluate)),console.log("strudelContext keys:",Object.keys(k)),console.log("🔍 Checking strudelContext for webaudio output...");const x=["strudelContext.webaudio","strudelContext.scheduler.webaudio","replInstance.webaudio","replInstance.scheduler.webaudio","strudelContext.output","replInstance.output"];k.scheduler&&(window.strudel=window.strudel||{},window.strudel.scheduler=k.scheduler,console.log("✅ Stored scheduler from strudelContext to window.strudel.scheduler"),k.scheduler.webaudio&&console.log("✅ Found webaudio in strudelContext.scheduler.webaudio")),k.webaudio&&(console.log("✅ Found webaudio in strudelContext.webaudio"),window.strudel=window.strudel||{},window.strudel.webaudio=k.webaudio),u&&u.scheduler&&(console.log("✅ Found scheduler in replInstance"),u.scheduler.webaudio&&console.log("✅ Found webaudio in replInstance.scheduler.webaudio")),(!u||typeof u.evaluate!="function")&&(console.warn("replInstance.evaluate not available, creating REPL manually..."),u=g({audioContext:this.audioContext,getTime:()=>this.audioContext.currentTime}),console.log("Created manual REPL, evaluate available:",typeof u.evaluate))}catch(b){console.warn("initStrudel failed, falling back to manual REPL:",b),u=g({audioContext:this.audioContext,getTime:()=>this.audioContext.currentTime})}}else console.log("Creating REPL manually (initStrudel not available)..."),u=g({audioContext:this.audioContext,getTime:()=>this.audioContext.currentTime});console.log("🎰 Checking if pattern slots need initialization..."),console.log("   replInstance:",!!u),console.log("   replInstance.evaluate:",typeof(u==null?void 0:u.evaluate)),console.log("   __strudelPatternsInitialized:",!!globalThis.__strudelPatternsInitialized),!globalThis.__strudelPatternsInitialized&&u&&u.evaluate?(console.log("🎰 Initializing pattern slots d0-d16..."),await(async()=>{for(let S=0;S<=16;S++)try{await u.evaluate(`d${S} = silence`),console.log(`  ✓ d${S} initialized with silence`)}catch{try{await u.evaluate(`d${S} = stack()`),console.log(`  ✓ d${S} initialized with stack()`)}catch(x){console.error(`  ✗ Failed to initialize d${S}:`,x.message)}}})(),console.log("✅ Pattern slot initialization complete"),globalThis.__strudelPatternsInitialized=!0,u.scheduler&&(console.log("⏸️ Scheduler NOT auto-started - will start when user presses play/preview"),setTimeout(()=>{const S=u.scheduler;if(S.webaudio||S._webaudio){const k=S.webaudio||S._webaudio;if(k.output||k.outputNode){const x=k.output||k.outputNode;try{x.disconnect(),x.connect(this.masterPanNode),console.log("✅ Connected webaudio output to master")}catch(E){console.warn("⚠️ Could not connect webaudio output:",E)}}}},500))):globalThis.__strudelPatternsInitialized?console.log("✅ Pattern slots already initialized"):console.warn("⚠️ Cannot initialize pattern slots - replInstance not available"),console.log("✅ REPL initialized - functions available via globalThis");try{let b=null;try{b=await We(()=>import("./strudel-web-C25uHgU2.js").then(k=>k.a),__vite__mapDeps([0,1])),console.log("✅ Draw module imported from local packages")}catch{b=await We(()=>import("https://unpkg.com/@strudel/draw@1.2.4/dist/index.mjs"),[]),console.log("✅ Draw module imported from CDN")}const S=((r=a==null?void 0:a.Pattern)==null?void 0:r.prototype)||(typeof Pattern<"u"?Pattern.prototype:null)||(globalThis.Pattern?globalThis.Pattern.prototype:null);if(S&&(!S._spectrum&&S.spectrum&&(S._spectrum=S.spectrum),!S._pianoroll&&S.pianoroll&&(S._pianoroll=S.pianoroll)),b&&u&&u.evaluate){const k="https://unpkg.com/@strudel/draw@1.2.4/dist/index.mjs";try{await u.evaluate(`
              (async function() {
                // Import the draw module - this automatically adds methods to Pattern.prototype
                const draw = await import('${k}')
                // Export getDrawContext for use in visualizers
                if (draw.getDrawContext) {
                  globalThis.getDrawContext = draw.getDrawContext
                }
                if (typeof Pattern !== 'undefined') {
                  if (!Pattern.prototype._spectrum && Pattern.prototype.spectrum) {
                    Pattern.prototype._spectrum = Pattern.prototype.spectrum;
                  }
                  if (!Pattern.prototype._pianoroll && Pattern.prototype.pianoroll) {
                    Pattern.prototype._pianoroll = Pattern.prototype.pianoroll;
                  }
                }
              })()
            `),await new Promise(x=>setTimeout(x,300))}catch(x){console.warn("⚠️ Could not load @strudel/draw in REPL context:",x)}}}catch(b){console.warn("⚠️ Could not load @strudel/draw functions:",b)}if(this.strudelRepl=u,this.audioContext&&(o.getAudioContext||l.getAudioContext)&&typeof(o.getAudioContext||l.getAudioContext)=="function")try{o.getAudioContext&&Object.defineProperty(o,"getAudioContext",{value:()=>(console.log("🎚️ Strudel getAudioContext() called - returning our shared context"),this.audioContext),writable:!0,configurable:!0}),l.getAudioContext&&Object.defineProperty(l,"getAudioContext",{value:()=>(console.log("🎚️ Strudel webaudio getAudioContext() called - returning our shared context"),this.audioContext),writable:!0,configurable:!0}),console.log("✅ Patched Strudel getAudioContext() to return our shared context")}catch(S){S.message.includes("Cannot redefine property")||console.warn("⚠️ Could not patch getAudioContext (module may be read-only):",S.message)}if(u&&u.scheduler){const b=u.scheduler;b.audioContext&&b.audioContext!==this.audioContext&&(console.log("🎚️ Replacing scheduler audioContext with our shared context"),b.audioContext=this.audioContext),b.superdough&&b.superdough.audioContext&&b.superdough.audioContext!==this.audioContext&&(console.log("🎚️ Replacing superdough audioContext with our shared context"),b.superdough.audioContext=this.audioContext)}if(this.exposeSampleListHelper(l,o),u&&u.scheduler&&this.masterPanNode&&this.masterGainNode)try{const b=u.scheduler;if(console.log("🔍 Checking for scheduler output..."),console.log("  scheduler.output:",!!b.output),console.log("  scheduler keys:",Object.keys(b).slice(0,15)),b.output){console.log("  scheduler.output type:",b.output.constructor.name);try{b.output.disconnect(),b.output.connect(this.masterPanNode),console.log("✅ Connected scheduler.output to masterPanNode")}catch(S){console.warn("⚠️ Could not connect scheduler.output:",S)}}if(b.superdough||b.output||b.audioOutput){const S=b.superdough||b.audioOutput||b.output;if(console.log("  Found superdough/audioOutput:",S?S.constructor.name:"null"),S&&typeof S.connect=="function")try{S.disconnect(),S.connect(this.masterPanNode),console.log("✅ Connected superdough/audioOutput to masterPanNode")}catch(k){console.warn("⚠️ Could not connect superdough/audioOutput:",k)}}if(b.audioContext){const S=b.audioContext.destination;try{Object.defineProperty(b.audioContext,"destination",{get:()=>this.masterPanNode||S,configurable:!0}),console.log("🎚️ Patched scheduler audioContext.destination")}catch(k){console.warn("⚠️ Could not patch scheduler audioContext:",k)}}}catch(b){console.warn("⚠️ Could not intercept scheduler output:",b)}u&&u.scheduler&&console.log("⏸️ REPL scheduler found (will be started after pattern slots are initialized)...");const M=async b=>{try{const S=await u.evaluate(b);return S===void 0&&b.includes("=")&&!b.trim().startsWith("//")&&(/^d\d+\s*=\s*/.test(b.trim())||/\w+\s*=\s*s\(|sound\(|note\(/.test(b))&&(console.warn(`⚠️ Pattern assignment returned undefined: ${b.substring(0,80)}`),console.warn("   This usually means the pattern is invalid or samples aren't loaded")),(S!==void 0||!b.includes("="))&&console.log(`Eval result for "${b.substring(0,50)}...":`,typeof S,S),S}catch(S){if(S.message&&S.message.includes("undefined instead of pattern")){const k=new Error("Pattern evaluation failed: got undefined instead of pattern");throw k.originalError=S,k.code=b,k.isUndefinedPattern=!0,console.warn("⚠️ Pattern evaluation error: got undefined instead of pattern"),console.warn(`   Code: ${b.substring(0,100)}`),console.warn("   This usually means:"),console.warn("   - Bank samples aren't loaded (check .bank() usage)"),console.warn("   - Pattern syntax is invalid"),console.warn("   - Required samples/sounds aren't available"),k}throw console.error("Evaluation error:",S),S}};h||(h=o.samples||c.samples||u&&u.samples),window.strudel={initialized:!0,evaluate:M,samples:h||(()=>{}),repl:u,scheduler:u==null?void 0:u.scheduler},this.strudelLoaded=!0,this.strudelLoading=!1,console.log("Checking Strudel functions availability..."),console.log("  typeof silence:",typeof globalThis.silence),console.log("  typeof sound:",typeof globalThis.sound),console.log("  typeof note:",typeof globalThis.note),console.log("✅ REPL ready (functions available via globalThis)"),this.currentTempo=120;try{await window.strudel.evaluate("cps = 1"),console.log("✅ Initial tempo set to 120 BPM (base cps=1, using .fast()/.slow() on patterns)")}catch(b){console.warn("⚠️ Could not set initial cps:",b)}return}catch(o){console.error("Failed to load Strudel module:",o),this.strudelLoading=!1}const t=["https://unpkg.com/@strudel/web@1.2.5/dist/index.mjs","https://cdn.jsdelivr.net/npm/@strudel/web@1.2.5/dist/index.mjs","https://esm.sh/@strudel/web@1.2.5"];for(const o of t)try{console.log(`Trying to load Strudel from: ${o}`);const a=await import(o),l=a.repl,d=a.samples;if(!l){console.warn("Strudel module missing repl. Available exports:",Object.keys(a));continue}const c=a.initStrudel;c&&c({audioContext:this.audioContext,output:this.audioContext});let u=null;try{try{u=await We(()=>import("./strudel-core-DenOJOif.js").then(f=>f.b),[]),console.log("✅ Core module imported from local packages")}catch{u=await We(()=>import("https://unpkg.com/@strudel/core@1.2.5/dist/index.mjs"),[]),console.log("✅ Core module imported from CDN")}console.log("Available exports:",Object.keys(u).slice(0,10))}catch(f){console.warn("Could not import core module:",f)}const h=l({getTime:()=>this.audioContext.currentTime,scope:u?{...u}:void 0});if(u)try{await h.evaluate(`
              (async function() {
                const core = await import('https://unpkg.com/@strudel/core@1.2.5/dist/index.mjs')
                Object.assign(globalThis, core)
              })()
            `),await new Promise(m=>setTimeout(m,300)),console.log("✅ Core functions also loaded via evaluation")}catch(f){console.warn("Could not load core functions via evaluation:",f)}try{let f=null;try{f=await We(()=>import("./strudel-web-C25uHgU2.js").then(m=>m.a),__vite__mapDeps([0,1])),console.log("✅ Draw module imported from local packages")}catch{f=await We(()=>import("https://unpkg.com/@strudel/draw@1.2.4/dist/index.mjs"),[]),console.log("✅ Draw module imported from CDN")}if(f){const m="https://unpkg.com/@strudel/draw@1.2.4/dist/index.mjs";await h.evaluate(`
              (async function() {
                // Import the draw module - this automatically adds methods to Pattern.prototype
                await import('${m}')
                // Also export getDrawContext for use in visualizers
                const draw = await import('${m}')
                if (draw.getDrawContext) {
                  const originalGetDrawContext = draw.getDrawContext;
                  // Patch getDrawContext to use our canvas when available
                  globalThis.getDrawContext = function(id, options) {
                    // If no ID or default ID, try to use our canvas context
                    if ((!id || id === 'test-canvas') && window.__strudelVisualizerCtx) {
                      return window.__strudelVisualizerCtx;
                    }
                    // Otherwise use original function
                    return originalGetDrawContext(id, options);
                  };
                }
              })()
            `),await new Promise(g=>setTimeout(g,300))}}catch(f){console.warn("⚠️ Could not load @strudel/draw functions:",f)}window.strudel={initialized:!0,evaluate:h.evaluate,samples:d},this.strudelLoaded=!0,this.strudelLoading=!1,console.log("Strudel loaded from CDN successfully");return}catch(a){console.warn(`Failed to load from ${o}:`,a.message);continue}throw this.strudelLoading=!1,new Error("Failed to load Strudel from all CDN sources")}async triggerSound(e){let t=null;try{const a=localStorage.getItem(`element-config-${e}`);a&&(t=JSON.parse(a))}catch(a){console.error(`Error loading custom config for ${e}:`,a)}const n=et.getElementConfig(e);if(!n&&!t){console.warn(`No config found for element: ${e}`);return}const s=t&&typeof t.sampleUrl=="string"&&t.sampleUrl.trim()!==""?t.sampleUrl.trim():n&&n.audioFile&&typeof n.audioFile=="string"&&n.audioFile.trim()!==""?n.audioFile.trim():null;if(s){try{await this.initialize()||console.warn("⚠️ Audio engine not fully initialized; attempting custom sample playback anyway.")}catch(a){console.warn("⚠️ Unable to initialize audio engine for custom sample playback:",a)}this.stopSound(e),console.log(`🔊 Playing custom sample for ${e}`),this.playAudioFile(e,s);return}let r=(t==null?void 0:t.pattern)!==void 0?t.pattern:n==null?void 0:n.pattern;const o=(n==null?void 0:n.type)||"strudel";if(!r||typeof r=="string"&&r.trim()===""){console.log(`[${e}] No pattern assigned - skipping sound trigger`);return}if(this.appInstance&&o==="strudel"){const a=this.appInstance.getPatternWithEffects(e,r);a!==r&&(console.log(`   Applying effects to ${e} for individual playback`),r=a)}console.log(`Triggering sound for ${e} (type: ${o})`),t!=null&&t.sampleUrl&&await this.loadCustomSample(e,t.sampleUrl),o==="synthesized"?await this.playSynthesizedSound(e,r):o==="strudel"?await this.playStrudelPattern(e,r,n==null?void 0:n.samples):o==="audio"&&this.playAudioFile(e,(n==null?void 0:n.audioFile)||(t==null?void 0:t.sampleUrl))}async loadCustomSample(e,t){console.log(`Loading custom sample for ${e} from ${t.substring(0,50)}...`)}pauseSound(e){if(this.masterOnlyPlayback){this.removeElementFromMaster(e).success&&this.masterActive&&this.playMasterPattern().catch(s=>console.warn("⚠️ Failed to refresh master after pause:",s)),this.activeSounds.delete(e);return}const t=this.strudelPatternSlots.get(e);if(t&&window.strudel&&window.strudel.evaluate)try{const n=typeof globalThis.silence=="object"?`${t} = globalThis.silence`:`${t} = silence`;window.strudel.evaluate(n),console.log(`⏸️ Paused ${e} (set ${t} to silence)`)}catch(n){console.error(`Error pausing sound for ${e}:`,n)}this.activeSounds.delete(e)}stopSound(e){if(this.masterOnlyPlayback){this.removeElementFromMaster(e).success&&this.masterActive&&this.playMasterPattern().catch(r=>console.warn("⚠️ Failed to refresh master after stop:",r)),this.activeSounds.delete(e);return}const t=this.activeSounds.get(e),n=typeof e=="string"&&e.toLowerCase().includes("preview");if(window.strudel&&window.strudel.evaluate)try{const s=this.getPatternSlot(e),r=typeof globalThis.silence=="object"?`${s} = globalThis.silence`:`${s} = silence`;window.strudel.evaluate(r).catch(o=>{console.log(`Cleared pattern slot ${s} for ${e}`)})}catch{}if(t){if(t.type==="synthesized"&&t.oscillator)t.oscillator.stop&&t.oscillator.stop();else if(t.type==="strudel"&&t.stop)t.stop(),this.activeSounds.delete(e);else if(t.type==="audio"&&t.source){const s=t.gain,r=this.audioContext.currentTime;s.gain.cancelScheduledValues(r),s.gain.setValueAtTime(s.gain.value,r),s.gain.linearRampToValueAtTime(0,r+et.defaults.fadeOutTime),setTimeout(()=>{t.source.stop(),this.activeSounds.delete(e)},et.defaults.fadeOutTime*1e3+50);return}else if(t.type==="sustaining"){this.stopSustainingTone(e);return}this.activeSounds.delete(e)}if(n){const s=this.strudelPatternSlots.get(e);s&&(this.patternSlotToElementId.delete(s),this.strudelPatternSlots.delete(e),console.log(`🧹 Cleared preview slot mapping (${s}) for ${e}`)),this.disposeElementAudioNodes(e),console.log(`🧹 Disposed preview audio nodes for ${e}`)}}async stopAllSounds(){var s;if(this._stoppingAllSounds)return;this._stoppingAllSounds=!0,console.log("🛑🛑🛑 EMERGENCY STOP - Killing all audio 🛑🛑🛑");const e=((s=this.audioContext)==null?void 0:s.currentTime)||0;this.masterGainNode?(this.masterGainNode.gain.setValueAtTime(0,e),console.log("✓ Master gain set to 0 (immediate)"),setTimeout(()=>{var r;this.masterGainNode&&!this.masterMuted&&(this.masterGainNode.gain.setValueAtTime(this.masterVolume,((r=this.audioContext)==null?void 0:r.currentTime)||0),console.log(`✓ Master gain restored to ${(this.masterVolume*100).toFixed(0)}%`))},100)):this.gainNode&&(this.gainNode.gain.setValueAtTime(0,e),console.log("✓ Gain set to 0 (immediate)"),setTimeout(()=>{var r;this.gainNode&&(this.gainNode.gain.setValueAtTime(this.volume,((r=this.audioContext)==null?void 0:r.currentTime)||0),console.log(`✓ Gain restored to ${(this.volume*100).toFixed(0)}%`))},100));let t=!1;if(window.strudel&&window.strudel.repl&&window.strudel.repl.scheduler)try{const r=window.strudel.repl.scheduler;typeof r.stop=="function"&&(r.stop(),t=!0,console.log("✓ Stopped REPL scheduler (immediate)"))}catch{}if(window.strudel&&window.strudel.evaluate){console.log("🔇 Silencing all Strudel pattern slots (d1-d16)...");const r=[];for(let o=0;o<=16;o++){const a=`d${o}`;try{r.push(window.strudel.evaluate(`${a} = silence`).catch(()=>{}))}catch{}}try{await Promise.all(r),console.log("✅ All pattern slots silenced")}catch{}}const n=Array.from(this.activeSounds.keys());console.log(`🔇 Stopping ${n.length} tracked sounds`);for(const r of n)try{this.stopSound(r),console.log(`✓ Stopped ${r}`)}catch{console.log(`Could not stop ${r}`)}this.activeSounds.clear(),this.oscillators.forEach((r,o)=>{try{r.stop&&r.stop(),r.disconnect&&r.disconnect(),console.log(`✓ Disconnected oscillator ${o}`)}catch{}}),this.oscillators.clear(),this.masterActive=!1,this.currentEvaluatingSlot=null,this.masterPattern="",this.trackedPatterns&&this.trackedPatterns.clear&&this.trackedPatterns.clear(),console.log("✅✅✅ EMERGENCY STOP COMPLETE ✅✅✅ (audio context left running, master muted)"),this._stoppingAllSounds=!1}async setTempo(e){this.currentTempo=e,this.masterPlaybackTempo=e;const t=Number.isFinite(e)&&e>0?e/120:1;if(this.masterActive&&this.masterPlaybackStartTime!=null){const n=this.audioContext,s=n?n.currentTime:performance.now()/1e3,r=this.masterPlaybackSpeed||1,o=Math.max(0,s-this.masterPlaybackStartTime),a=r>0?o*r%1:0;this.masterPlaybackSpeed=t>0?t:1,this.masterPlaybackStartTime=s-a/this.masterPlaybackSpeed}else this.masterPlaybackSpeed=t>0?t:1;if(!window.strudel||!window.strudel.evaluate){console.warn("⚠️ Strudel not loaded yet - cannot set tempo");return}console.log(`🎚️ Tempo set to ${e} BPM (using .cpm() on patterns)`),await this.updateAllPatternsWithNewTempo(),this.trackedPatterns.size>0&&(console.log("🔄 Updating master with new tempo"),this.updateMasterPattern())}async ensureStrudelWorkletsReady(e,t=!1){try{if(!window.strudel||!window.strudel.repl||!window.strudel.repl.scheduler)return;const s=window.strudel.repl.scheduler.superdough;if(!s||!(t||typeof e=="string"&&/\b(supersaw|pulse)\b/i.test(e))||this._workletsLoaded)return;typeof s.loadWorklets=="function"&&(console.log("⏳ Loading Strudel AudioWorklets..."),await s.loadWorklets(),this._workletsLoaded=!0,console.log("✅ Strudel AudioWorklets loaded"))}catch(n){console.warn("⚠️ Could not load Strudel AudioWorklets:",(n==null?void 0:n.message)||n)}}setKey(e){this.currentKey=e||"",this._cachedScaleContext=null,this._cachedScaleKey="",this.currentKey?console.log(`🎹 Key set to ${e}`):console.log("🎹 Key cleared (no key selected)"),this.updateAllPatternsWithNewScale()}updateAllPatternsWithNewScale(){this.trackedPatterns.size>0&&(console.log("🔄 Updating master with new key/scale"),this.updateMasterPattern());for(const[e,t]of this.trackedPatterns.entries()){if(!t)continue;const n=t.pattern||t.rawPattern;if(!n)continue;const s=this.convertPatternForScale(n);t.pattern=s||n}for(const[e,t]of this.activeSounds.entries()){if(t.type!=="strudel")continue;const n=this.loadElementConfig?this.loadElementConfig(e):null,s=(n==null?void 0:n.pattern)||t.originalPattern||"";if(!s)continue;const o=this.convertPatternForScale(s)||s;this.updatePatternInPlace(e,o).catch(()=>{})}}setScale(e){this.currentScale=(e||"").trim()||"chromatic",this._cachedScaleContext=null,this._cachedScaleKey="",this.currentScale?console.log(`🎼 Scale set to ${this.currentScale}`):console.log("🎼 Scale cleared (no scale selected)"),this.updateAllPatternsWithNewScale()}setTimeSignature(e){this.currentTimeSignature=e,console.log(`🎵 Time signature set to ${e}`);const[t,n]=e.split("/").map(Number);this.currentBeats=t,this.currentNoteValue=n,console.log(`   ${t} beats per measure, ${n} note gets the beat`),this.trackedPatterns.size>0&&(console.log("🔄 Updating master with new time signature"),this.updateMasterPattern())}extractChannelNumber(e,t=0){if(!e||typeof e!="string")return t+1;const n=e.match(/(\d+)$/);if(n&&n[1]){const s=parseInt(n[1],10);if(Number.isFinite(s)&&s>0)return s}return t+1}formatNumberForPattern(e,t=6){return!Number.isFinite(e)||e===0?"0":e.toFixed(t).replace(/(\.\d*?[1-9])0+$/,"$1").replace(/\.0+$/,"").replace(/^-0$/,"0")}getScaleConversionContext(){return null}convertPatternForScale(e){if(!e||typeof e!="string")return e;const t=this.patternHasNoteNames(e),n=this.patternHasNumericNotePattern(e);return t&&!n?(console.log("📝 convertPatternForScale: Pattern uses note names, preserving format"),e):Ou(e)}convertNoteNamesToSemitones(e){return!e||typeof e!="string"?e:Ou(e)}convertNoteNamesToScaleDegrees(e,t,n){if(!e||typeof e!="string")return e;const s=t&&t.trim()||"C",r=n&&n.trim()||"chromatic",o=this.getScaleSemitoneSteps(s,r);if(!o||!o.length)return e;const l=`${s.replace(/\s+/g,"").toUpperCase()}`.match(/^([A-G])([#B]?)/i);if(!l)return e;const d=`${l[1].toUpperCase()}${l[2]||""}`,c=Ql.get(`${d}4`),u=Number.isFinite(c.midi)?c.midi:60,h=g=>{const O=/(\s+|[,;:<>()[\]{}|\\/]+|\*+)/g,p=[];let y=0,M;for(;(M=O.exec(g))!==null;)M.index>y&&p.push({type:"note",value:g.substring(y,M.index)}),p.push({type:"separator",value:M[0]}),y=M.index+M[0].length;y<g.length&&p.push({type:"note",value:g.substring(y)});let b=!1;for(let S=0;S<p.length;S++){const k=p[S];if(k.type==="separator")continue;const x=k.value.trim();if(!x)continue;const E=x.match(/^([a-gA-G])([#b]?)(-?\d+)?(@[\d.]+)?$/);if(!E)continue;const B=E[1].toUpperCase(),F=E[2]||"",W=E[3]?parseInt(E[3],10):null,z=E[4]||"",ce=[];W!==null&&!Number.isNaN(W)&&ce.push(W);const ie=c.oct||4;ce.push(ie,ie-1,ie+1,3,4,5);let se=null;for(const it of ce){const je=Ql.get(`${B}${F}${it}`);if(je&&Number.isFinite(je.midi)){se=je.midi;break}}if(se===null)return null;const pe=se-u,Se=(pe%12+12)%12,st=o.indexOf(Se);if(st===-1)return null;const St=Math.floor((pe-o[st])/12)*o.length+st;p[S]={type:"note",value:`${St}${z}`},b=!0}return b?p.map(S=>S.value).join(""):null},f=/\bnote\s*\(\s*(["'])([\s\S]*?)\1\s*\)/gi;return e.replace(f,(g,O,p)=>{const y=h(p);return y===null?g:`n(${O}${y}${O})`})}getScaleSemitoneSteps(e,t){const n=e&&typeof e=="string"?e.trim():"",s=t&&typeof t=="string"?t.trim():"",r=Qa[s]||s||"chromatic";let o="C";if(n){const c=n.match(/^([a-gA-G])([#b]?)/);c?o=`${c[1].toUpperCase()}${c[2]||""}`:o=n}const a=Ki.get(`${o} ${r}`);if(!a||!Array.isArray(a.intervals)||a.intervals.length===0)return null;const l=a.intervals.map(c=>{const u=H0.semitones(c);return Number.isFinite(u)?u:null}).filter(c=>c!==null);if(!l.length)return null;const d=Array.from(new Set(l)).sort((c,u)=>c-u);return d[0]!==0&&d.unshift(0),d}patternHasNoteNames(e){if(!e||typeof e!="string")return!1;const t=/\b(note|n)\s*\(\s*["']([^"']+)["']/gi;let n;for(;(n=t.exec(e))!==null;){const s=n[2];if(/[a-gA-G][#b]?\d/.test(s)||/[a-gA-G][#b]?\s/.test(s))return!0}return!1}patternHasNumericNotePattern(e){if(!e||typeof e!="string")return!1;const t=/\b(note|n)\s*\(\s*["']([^"']+)["']/gi;let n,s=!1;for(;(n=t.exec(e))!==null;){s=!0;let r=n[2].replace(/[<>\[\]\{\}\|,]/g," ").trim();if(r&&(/[a-gA-G]/.test(r)||!/^[\d\s~\-\/]+$/.test(r)))return!1}return s}_ensureMasterPatternSanitized(){if(!this.masterPattern||typeof this.masterPattern!="string")return"";const e=this._sanitizePatternExpression(this.masterPattern);return e!==this.masterPattern&&(console.log("🧼 Sanitized master pattern before evaluation"),this.masterPattern=e),this.masterPattern}_repairBrokenSampleStrings(e){if(!e||typeof e!="string")return e;const t=/samples\s*\(\s*\{([\s\S]*?)\}\s*,\s*\{([\s\S]*?)\}\s*\)/g;return e.replace(t,(n,s,r)=>{var f,m;const o=/"([^"]+)"\s*:\s*"([\s\S]*?)"/g,a=[];let l;for(;(l=o.exec(s))!==null;){const g=(f=l[1])==null?void 0:f.trim(),O=(m=l[2])==null?void 0:m.replace(/[\r\n]+/g,"").trim();!g||!O||a.push([g,O])}if(!a.length)return n;const d=r.match(/baseUrl\s*:\s*"([\s\S]*?)"/),c=d?d[1].replace(/[\r\n]+/g,"").trim():"./";return`samples({
${a.map(([g,O])=>`  "${g}": "${O}"`).join(`,
`)}
}, { baseUrl: "${c||"./"}" })`})}_findMatchingParenIndex(e,t){let n=0,s=!1,r=!1,o=!1,a=!1,l=!1,d=!1;for(let c=t;c<e.length;c+=1){const u=e[c],h=e[c+1];if(d){d=!1;continue}if(l){u===`
`&&(l=!1);continue}if(a){u==="*"&&h==="/"&&(a=!1,c+=1);continue}if(u==="\\"){d=!0;continue}if(s){u==="'"&&(s=!1);continue}if(r){u==='"'&&(r=!1);continue}if(o){u==="`"&&(o=!1);continue}if(u==="'"&&!r&&!o){s=!0;continue}if(u==='"'&&!s&&!o){r=!0;continue}if(u==="`"&&!s&&!r){o=!0;continue}if(u==="/"&&h==="*"){a=!0,c+=1;continue}if(u==="/"&&h==="/"){l=!0,c+=1;continue}if(u==="("){n+=1;continue}if(u===")"){if(n-=1,n===0)return c;if(n<0)return-1}}return-1}_repairLeadingSampleStatements(e){if(!e||typeof e!="string")return e;const t=e.trimStart();if(t.startsWith("(() =>")||t.startsWith("(()=>"))return e;const n=e.slice(0,e.length-t.length),s=t.match(/^(?:\/\*[\s\S]*?\*\/\s*|\/\/[^\n]*\n\s*)+/),r=s?s[0]:"";let o=t.slice(r.length).trimStart();if(!o.startsWith("samples"))return e;const a=[];let l=0;for(;o.startsWith("samples",l);){const f=l,m=o.indexOf("(",f);if(m===-1)break;const g=this._findMatchingParenIndex(o,m);if(g===-1)break;const O=o.slice(f,g+1).trim();for(a.push(O),l=g+1;l<o.length&&/\s/.test(o[l]);)l+=1}if(!a.length)return e;const d=o.slice(l).trim();if(!d)return e;const c=a.map(f=>`  ${f};`).join(`
`),u=d.split(`
`).map(f=>`    ${f}`).join(`
`),h=`(() => {
${c}
  return (
${u}
  );
})()`;return`${n}${r}${h}`}_repairStringPatternOperators(e){if(!e||typeof e!="string")return e;let t="",n=0;const s=e.length,r=o=>o?/[,\(\{\[=:+\-*\/!&|?;%]/.test(o):!0;for(;n<s;){const o=e[n];if(o==='"'||o==="'"){const a=o;let l=n+1,d=!1;for(;l<s;){const O=e[l];if(!d&&O===a)break;!d&&O==="\\"?d=!0:d=!1,l+=1}if(l>=s){t+=e.slice(n);break}const c=e.slice(n,l+1);let u=n-1;for(;u>=0&&/\s/.test(e[u]);)u-=1;const h=u>=0?e[u]:"";let f=l+1;for(;f<s&&/\s/.test(e[f]);)f+=1;const m=e.startsWith(".div",f),g=r(h);m&&g?t+=`pattern(${c})`:t+=c,n=l+1;continue}t+=o,n+=1}return t}_sanitizePatternExpression(e){if(!e||typeof e!="string")return e;let t=this._repairBrokenSampleStrings(e);return t=this._repairLeadingSampleStatements(t),t=this._repairStringPatternOperators(t),t}applyMasterMixModifiers(e,t={}){if(!e||typeof e!="string"||e.trim()==="")return e;const{wrapStack:n=!1}=t;let s=e;if(n){const M=s.match(/stack\s*\(/);if(M){let b=M.index+M[0].length-1,S=1,k=b+1,x=!1,E=null;for(;k<s.length&&S>0;){const B=s[k];!x&&(B==='"'||B==="'")?(x=!0,E=B):x&&B===E&&s[k-1]!=="\\"&&(x=!1,E=null),x||(B==="("?S++:B===")"&&S--),S>0&&k++}S===0&&(s=s.substring(0,k+1).trimEnd())}}else s=s.replace(/\.gain\s*\([^)]*\)/g,""),s=s.replace(/\.pan\s*\([^)]*\)/g,""),s=s.replace(/\.cpm\s*\([^)]*\)/g,""),s=s.replace(/\.\.+/g,".").replace(/\.\s*$/,"").trim();s=s.replace(/\.\.+/g,".").replace(/\.\s*$/,"").trim();let r=e;if(n){const M=e.match(/stack\s*\(/);if(M){let b=M.index+M[0].length-1,S=1,k=b+1,x=!1,E=null;for(;k<e.length&&S>0;){const B=e[k];!x&&(B==='"'||B==="'")?(x=!0,E=B):x&&B===E&&e[k-1]!=="\\"&&(x=!1,E=null),x||(B==="("?S++:B===")"&&S--),S>0&&k++}S===0&&(r=e.substring(k+1))}}const o=[...r.matchAll(/\.gain\s*\(\s*([^)]+)\s*\)/g)];if(o.length>0){const M=o[o.length-1],b=parseFloat(M[1]);Number.isFinite(b)&&(this.masterVolume=b)}const a=[...r.matchAll(/\.pan\s*\(\s*([^)]+)\s*\)/g)];if(a.length>0){const M=a[a.length-1],b=parseFloat(M[1]);Number.isFinite(b)&&(this.masterPan=b)}const l=[];Number.isFinite(this.masterVolume)&&Math.abs(this.masterVolume-1)>1e-6&&l.push(`.gain(${this.formatNumberForPattern(this.masterVolume,4)})`),Number.isFinite(this.masterPan)&&Math.abs(this.masterPan)>1e-6&&l.push(`.pan(${this.formatNumberForPattern(this.masterPan,4)})`);const d=Number.isFinite(this.currentTempo)&&this.currentTempo>0?this.currentTempo:120;if(Math.abs(d-120)>1e-6){const M=d/4;l.push(`.cpm(${this.formatNumberForPattern(M,6)})`)}if(!l.length)return s;e=s;const c=l,u=e.match(/^(\s*\/\/[^\n]*\n)+/);let h="",f=e;u&&(h=u[0],f=e.slice(h.length));const m=f.match(/\s*$/),g=m?m[0]:"",O=f.trim();if(!O)return e;if(n){const M=O.match(/stack\s*\(/);if(M){let S=M.index+M[0].length-1,k=1,x=S+1,E=!1,B=null;for(;x<O.length&&k>0;){const F=O[x];!E&&(F==='"'||F==="'")?(E=!0,B=F):E&&F===B&&O[x-1]!=="\\"&&(E=!1,B=null),E||(F==="("?k++:F===")"&&k--),k>0&&x++}if(k===0){const F=O.slice(0,x+1);let z=O.slice(x+1).trim(),ce=z.length,ie=0;for(;ie<10&&(z=z.replace(/\.(gain|pan|cpm)\s*\([^)]*\)/g,""),z=z.replace(/\.\s*\(\s*(gain|pan|cpm)\s*\([^)]*\)\s*\)/g,""),z=z.replace(/\s*\(\s*(gain|pan|cpm)\s*\([^)]*\)\s*\)/g,""),z=z.replace(/\s*(gain|pan|cpm)\s*\([^)]*\)/g,""),z=z.replace(/\.\.+/g,".").replace(/\.\s*$/,"").replace(/^\s*\./,"").trim(),z.length!==ce);)ce=z.length,ie++;(z.match(/(gain|pan|cpm)\s*\(/)||z.match(/[().]/))&&(z="");const se=F+(c.length>0?c.join(""):"");return`${h}${se}${g}`}}const b=O.lastIndexOf(")");if(b!==-1){const S=O.slice(0,b+1);let x=O.slice(b+1).trim(),E=x.length,B=0;for(;B<10&&(x=x.replace(/\.(gain|pan|cpm)\s*\([^)]*\)/g,""),x=x.replace(/\.\s*\(\s*(gain|pan|cpm)\s*\([^)]*\)\s*\)/g,""),x=x.replace(/\s*\(\s*(gain|pan|cpm)\s*\([^)]*\)\s*\)/g,""),x=x.replace(/\s*(gain|pan|cpm)\s*\([^)]*\)/g,""),x=x.replace(/\.\.+/g,".").replace(/\.\s*$/,"").replace(/^\s*\./,"").trim(),x.length!==E);)E=x.length,B++;(x.match(/(gain|pan|cpm)\s*\(/)||x.match(/[().]/))&&(x="");const F=S+(c.length>0?c.join(""):"");return`${h}${F}${g}`}}const p=O.startsWith("(")&&O.endsWith(")"),y=c.length>0?p?`${O}${c.join("")}`:`(${O})${c.join("")}`:O;return`${h}${y}${g}`}applyGlobalSettingsToPattern(e,t=!1,n=!1,s=null,r=null){if(!e||e==="silence")return e;let o=e,a=t;const l=/\b(note|n)\s*\(/.test(o),d=this.patternHasNoteNames(o),c=/\b(note|n)\s*\(\s*["'][a-g][#b]?[a-z0-9]*\s*[a-z]/.test(o)||/\b(note|n)\s*\(\s*["'][^"']*\b(maj|min|m|dim|aug|sus|add|7|9|11|13)\b/i.test(o),u=/\.\s*chord\s*\(/i.test(o),h=/\b(note|n)\s*\(\s*["'][^"']*[a-g][#b]?\s/.test(o),f=d||c||h||u,m=this.patternHasNumericNotePattern(o),g=l&&!f&&!u&&m,O=s!==null?s:this.currentKey&&this.currentKey.trim()!==""?this.currentKey.trim():"",p=r!==null?r:this.currentScale&&this.currentScale.trim()!==""?this.currentScale.trim():"",y=O&&O.trim()!=="",M=p&&p.trim()!==""?p.trim():"";let b="",S="";if(y){const k=O.toLowerCase();k.includes("m")&&!k.includes("major")?(b=k.replace("m","").trim(),S="minor"):(b=k.replace("major","").trim(),S="major"),b||(b=k.trim())}if(g){let k="";if(y){const E=M||S||"major",B=Qa[E]||E,F=b||O.trim().toLowerCase();k=F?`${F}:${B}`:B}else M&&(k=Qa[M]||M);const x=/\.\s*scale\s*\(/i.test(o);if(x&&(o=o.replace(/\.\s*scale\s*\((['"])(?:(?=(\\?))\2.)*?\1\)/gi,""),o=o.replace(/\.\s*scale\s*\([^)]*\)/gi,""),o=o.replace(/\.+/g,".").replace(/\.\s*\./g,".").trim(),o=o.replace(/\.+$/,"").trim(),console.log("  🔄 Removed existing scale modifier")),k&&!u){const E=`.scale('${k}')`,B=o.search(/\.(s|sound)\s*\(/);if(B!==-1){const F=o.slice(0,B),W=o.slice(B);o=`${F}${E}${W}`}else a?o=`${o}${E}`:(o=`(${o})${E}`,a=!0);console.log(`  🎼 Applied scale: ${k}`)}else(y||M)&&console.log(u?"  ⏭️  Skipped scale application (pattern uses .chord() modifier)":x?"  ⏭️  Skipped scale application (pattern already has scale)":"  ⏭️  Skipped scale application (pattern not compatible with key/scale settings)")}else if(f&&(y||M)){let k="note name";u?k="chord modifier (.chord())":c&&(k="chord"),console.log(`  ⏭️  Skipped scale for ${k} pattern (use numeric n() for scale/key changes)`)}else!l&&(y||M)&&console.log(`  ⏭️  Skipped scale for non-note pattern (Key: ${O||"none"}, Scale: ${M||"none"})`);return o}async updateAllPatternsWithNewTempo(){for(const[e,t]of this.activeSounds.entries())if(t.type==="strudel")try{const n=localStorage.getItem(`element-config-${e}`);if(n){const s=JSON.parse(n);s.pattern&&s.pattern.trim()!==""&&await this.updatePatternInPlace(e,s.pattern)}}catch{}}isPlaying(e){return this.activeSounds.has(e)}getAudioContext(){return this.audioContext}isAudioReady(){return this.initialized&&this.audioContext&&(this.audioContext.state==="running"||this.audioContext.state==="suspended")}playSustainingTone(e,t,n,s,r=null){if(!this.initialized||!this.audioContext)return;this.audioContext.state==="suspended"&&(Qs(),this.audioContext.resume().catch(h=>{console.error("Failed to resume audio context:",h)}));const o=(t-n)/(s-n),a=160,d=a*Math.pow(1e4/a,o);this.stopSustainingTone(e);const c=this.audioContext.createOscillator(),u=this.audioContext.createGain();if(c.type="sine",c.frequency.value=d,c.connect(u),r){const h=this.getElementAudioNodes(r);h?(u.connect(h.gainNode),u.gain.value=.3):(u.connect(this.gainNode),u.gain.value=this.volume*.3)}else u.connect(this.gainNode),u.gain.value=this.volume*.3;c.start(0),this.activeSounds.set(e,{type:"sustaining",oscillator:c,gain:u,frequency:d})}updateSustainingToneFrequency(e,t,n,s,r=null){if(!this.audioContext)return;this.audioContext.state==="suspended"&&(Qs(),this.audioContext.resume().catch(a=>{console.error("Failed to resume audio context:",a)}));const o=this.activeSounds.get(e);if(o&&o.type==="sustaining"&&o.oscillator)try{const a=(t-n)/(s-n),l=160,c=l*Math.pow(1e4/l,a);o.oscillator.frequency.setValueAtTime(c,this.audioContext.currentTime),o.frequency=c}catch(a){console.error("Error updating sustaining tone frequency:",a),this.playSustainingTone(e,t,n,s,r)}else this.playSustainingTone(e,t,n,s,r)}async checkSoundBanksStatus(){if(!window.strudel||!window.strudel.evaluate)return{loaded:!1,error:"Strudel not initialized"};try{return{loaded:(typeof globalThis.s=="function"&&typeof globalThis.sound=="function")===!0}}catch(e){return{loaded:!1,error:e.message}}}async ensureDefaultSoundBanks(){var e;if(!window.strudel||!window.strudel.evaluate){try{this.strudelLoaded||await this.initStrudel()}catch{}if(!window.strudel||!window.strudel.evaluate)return!1}if(this.strudelSoundBanksLoaded)return!0;if(this.strudelSoundBankLoading){for(;this.strudelSoundBankLoading;)await new Promise(t=>setTimeout(t,100));return this.strudelSoundBanksLoaded}this.strudelSoundBankLoading=!0;try{if(console.log("📦 Loading default Strudel sound banks (dirt-samples)..."),typeof document<"u"){const s=document.getElementById("status-text");s&&(s.textContent="📦 Loading default drum samples...")}const t=((e=window.strudel)==null?void 0:e.samples)||globalThis.samples;if(t&&typeof t=="function")try{console.log("📦 Loading default Strudel samples from dough-samples CDN...");const s=Ta,r={tidalDrums:!1,piano:!1,dirt:!1,vcsl:!1,mridangam:!1};if(await Promise.all([t(`${s}/tidal-drum-machines.json`).then(()=>{console.log("  ✅ Tidal drum machines loaded (TR-808, TR-909, TR-707, RhythmAce, AkaiLinn, etc.)"),r.tidalDrums=!0}).catch(o=>{console.warn("  ⚠️ Could not load tidal-drum-machines from CDN:",o.message),console.log("  📁 Will use local TR-808/TR-909 samples as fallback")}),t(`${s}/piano.json`).then(()=>{console.log("  ✅ Piano samples loaded"),r.piano=!0}).catch(o=>console.warn("  ⚠️ Could not load piano:",o.message)),t(`${s}/Dirt-Samples.json`).then(()=>{console.log("  ✅ Dirt-Samples loaded"),r.dirt=!0}).catch(o=>console.warn("  ⚠️ Could not load Dirt-Samples:",o.message)),t(`${s}/vcsl.json`).then(()=>{console.log("  ✅ VCSL (vocal) samples loaded"),r.vcsl=!0}).catch(o=>console.warn("  ⚠️ Could not load VCSL:",o.message)),t(`${s}/mridangam.json`).then(()=>{console.log("  ✅ Mridangam (percussion) samples loaded"),r.mridangam=!0}).catch(o=>console.warn("  ⚠️ Could not load mridangam:",o.message))]),console.log("✅ Default Strudel samples loaded from dough-samples CDN"),r.tidalDrums)console.log("📝 Note: TR-808 and TR-909 loaded from CDN (local samples available as backup)");else{console.log("📁 Loading local TR-808 and TR-909 samples as fallback...");try{await this.loadBank("RolandTR808"),await this.loadBank("RolandTR909"),console.log("✅ Local TR-808 and TR-909 samples loaded successfully")}catch(o){console.warn("⚠️ Could not load local TR-808/TR-909 samples:",o)}}}catch(s){console.warn("⚠️ Error loading samples from dough-samples:",s),console.log("   Attempting to load local TR-808/TR-909 samples...");try{await this.loadBank("RolandTR808"),await this.loadBank("RolandTR909"),console.log("✅ Local TR-808 and TR-909 samples loaded as fallback")}catch(r){console.warn("⚠️ Could not load local samples either:",r)}}this.strudelSoundBanksLoaded=!0,this.strudelSoundBankLoading=!1,console.log("✅ Default sound banks ready"),console.log("📦 Available: Piano, Dirt-Samples, VCSL, Mridangam, Drum Machines (TR-808, TR-909, TR-707, etc.)"),console.log("🧪 Testing pattern evaluation...");let n=!1;if(typeof globalThis.silence=="object"&&typeof globalThis.sound=="function"&&typeof globalThis.note=="function"){console.log("✅ Pattern functions available in globalThis");try{await window.strudel.evaluate("d16 = silence"),console.log("✅ Pattern assignment test passed"),n=!0}catch(s){console.warn("⚠️ Pattern assignment test failed:",s),await new Promise(r=>setTimeout(r,1e3));try{await window.strudel.evaluate("d16 = silence"),console.log("✅ Pattern assignment test passed on retry"),n=!0}catch(r){console.error("❌ Pattern assignment still failing:",r)}}}else console.error("❌ Pattern functions not available in globalThis"),console.log("  silence:",typeof globalThis.silence,"(should be object)"),console.log("  sound:",typeof globalThis.sound,"(should be function)"),console.log("  note:",typeof globalThis.note,"(should be function)");if(n&&this.onSoundsReadyCallback?(console.log("🔔 Notifying app that sounds are ready..."),this.onSoundsReadyCallback()):n||console.warn("⚠️ Sounds loaded but patterns not ready - dots will stay red"),typeof document<"u"){const s=document.getElementById("status-text");s&&(s.textContent="✅ Samples loaded - Ready!",setTimeout(()=>{s.textContent.includes("Samples loaded")&&(s.textContent="Ready - Click elements to start/stop patterns (Press Escape to stop all)")},2e3))}return!0}catch(t){return this.strudelSoundBankLoading=!1,t.message&&t.message.includes("CycleTones")?(console.log("⚠️ CycleTones not available - patterns will use dirt-samples if loaded"),!1):(console.error("❌ Failed to load default sound banks:",t),console.error("Error details:",t.message,t.stack),console.error("Strudel patterns may not work without default sound banks"),!1)}}async preloadAllCommonDrumSounds(){return console.log("📦 Preloading skipped (silent mode) - no audible patterns will be evaluated"),!0}exposeSampleListHelper(e,t){globalThis.getLoadedSamples=()=>{try{let n=null,s="";const r=(e==null?void 0:e.soundMap)||(t==null?void 0:t.soundMap);if(r&&(n=typeof r.get=="function"?r.get():r,n&&typeof n=="object"&&(s="webaudioModule/webModule.soundMap")),(!n||Object.keys(n).length===0)&&this.strudelRepl){const l=this.strudelRepl;if(l.scheduler){const d=l.scheduler;if(d.soundMap&&(n=typeof d.soundMap.get=="function"?d.soundMap.get():d.soundMap,n&&typeof n=="object"&&(s="repl.scheduler.soundMap")),(!n||Object.keys(n).length===0)&&d.context){const c=d.context;c.soundMap&&(n=typeof c.soundMap.get=="function"?c.soundMap.get():c.soundMap,n&&typeof n=="object"&&(s="repl.scheduler.context.soundMap"))}}}if((!n||Object.keys(n).length===0)&&window.strudel&&window.strudel.repl&&window.strudel.repl.scheduler){const l=window.strudel.repl.scheduler;l.soundMap&&(n=typeof l.soundMap.get=="function"?l.soundMap.get():l.soundMap,n&&typeof n=="object"&&(s="window.strudel.repl.scheduler.soundMap"))}if(!n||Object.keys(n).length===0){const l=(e==null?void 0:e.getSound)||(t==null?void 0:t.getSound);if(l&&typeof l=="function"){console.log("🔍 Attempting to detect samples via getSound function...");const d=["bd","sd","hh","cp","oh","cr","rim","tr808_bd","tr909_bd","RolandTR808_bd","RolandTR909_bd"],c=[];d.forEach(u=>{try{const h=l(u);h&&h!=="triangle"&&c.push(u)}catch{}}),c.length>0&&(console.log(`📊 Found ${c.length} samples via getSound:`,c),s="getSound detection")}}if((!n||Object.keys(n).length===0)&&this.strudelRepl){const l=this.strudelRepl;console.log("🔍 Checking REPL properties for sample registry..."),console.log("   REPL keys:",Object.keys(l).slice(0,20)),l.scheduler&&(console.log("   Scheduler keys:",Object.keys(l.scheduler).slice(0,20)),l.scheduler.context&&console.log("   Scheduler.context keys:",Object.keys(l.scheduler.context).slice(0,20))),l.samples&&typeof l.samples=="object"&&(n=l.samples,s="repl.samples",console.log("✅ Found samples in repl.samples"))}if((!n||Object.keys(n).length===0)&&window.strudel&&window.strudel.evaluate){console.log("🔍 Testing pattern evaluation to detect available samples...");const l=['s("bd")','s("bd").bank("tr808")','s("bd").bank("tr909")','sound("bd")'];for(const d of l)try{const c=window.strudel.evaluate(d);console.log(`   Pattern "${d}" evaluated successfully`)}catch(c){c.message&&(c.message.includes("not found")||c.message.includes("not loaded"))?console.log(`   Pattern "${d}" - sample not found (expected)`):console.log(`   Pattern "${d}" - error:`,c.message)}}if(!n||Object.keys(n).length===0){const l=Object.keys(globalThis).filter(d=>d.toLowerCase().includes("sample")||d.toLowerCase().includes("sound")||d.toLowerCase().includes("bank"));l.length>0&&(console.log("🔍 Found potential sample-related globals:",l),l.forEach(d=>{try{const c=globalThis[d];if(typeof c=="object"&&c!==null&&!Array.isArray(c)){const u=Object.keys(c);u.length>0&&(console.log(`   ${d} has ${u.length} keys:`,u.slice(0,10)),(!n||Object.keys(n).length===0)&&(n=c,s=`globalThis.${d}`))}}catch{}}))}if(!n||typeof n!="object"||Object.keys(n).length===0)return console.log("⚠️ soundMap not found or empty"),console.log("   Tried: webaudioModule, webModule, repl.scheduler, window.strudel"),console.log("   This might mean samples are loaded but not yet registered"),console.log("   Try loading a bank first, then check again"),{total:0,keys:[],byBank:{},source:"none",note:"No samples found. Samples may need to be loaded first."};const o=Object.keys(n);console.log(`📊 Total loaded samples: ${o.length} (from ${s})`),console.log("📋 All loaded sample names:",o);const a={};return o.forEach(l=>{const d=l.split("_");if(d.length>1){const c=d[0],u=d.slice(1).join("_");a[c]||(a[c]=[]),a[c].push(u)}else a.default||(a.default=[]),a.default.push(l)}),Object.keys(a).length>0&&(console.log("📦 Samples grouped by bank:"),Object.entries(a).forEach(([l,d])=>{console.log(`  ${l}: ${d.length} sounds`,d.slice(0,20))})),{total:o.length,keys:o,byBank:a,source:s}}catch(n){return console.error("❌ Error getting loaded samples:",n),console.error("   Stack:",n.stack),null}},console.log("✅ Helper function available: getLoadedSamples()"),console.log("   Call getLoadedSamples() in console to see all loaded samples")}async loadBank(e){var c,u,h,f,m;if(!window.strudel||!window.strudel.evaluate)throw console.warn("Cannot load bank: Strudel not initialized"),new Error("Strudel not initialized");if(!e||typeof e!="string")return console.warn("Cannot load bank: invalid name",e),!1;if(e=e.trim(),!e)return console.warn("Cannot load bank: empty name after trimming"),!1;const t=e.toLowerCase();if(new Set(["sine","square","triangle","sawtooth","supersaw","pulse","saw","saw2","saw3","saw4","saw8"]).has(e.toLowerCase()))return console.log(`⏭️ Skipping built-in oscillator synth "${e}" (no loading needed)`),this.loadedBanks.add(e.toLowerCase()),this.loadedBanks.add(e),!0;const s={RolandTR909:{RolandTR909_bd:["assets/sounds/Kicks/ESWTR909 Kick 01.wav","assets/sounds/Kicks/ESWTR909 Kick 02.wav","assets/sounds/Kicks/ESWTR909 Kick 03.wav","assets/sounds/Kicks/ESWTR909 Kick 04.wav","assets/sounds/Kicks/ESWTR909 Kick 05.wav","assets/sounds/Kicks/ESWTR909 Kick 06.wav","assets/sounds/Kicks/ESWTR909 Kick 07.wav","assets/sounds/Kicks/ESWTR909 Kick 08.wav","assets/sounds/Kicks/ESWTR909 Kick 09.wav","assets/sounds/Kicks/ESWTR909 Kick 10.wav"],RolandTR909_sd:["assets/sounds/Snares/ESWTR909 Snare 01.wav","assets/sounds/Snares/ESWTR909 Snare 02.wav","assets/sounds/Snares/ESWTR909 Snare 03.wav","assets/sounds/Snares/ESWTR909 Snare 04.wav","assets/sounds/Snares/ESWTR909 Snare 05.wav","assets/sounds/Snares/ESWTR909 Snare 06.wav","assets/sounds/Snares/ESWTR909 Snare 07.wav","assets/sounds/Snares/ESWTR909 Snare 08.wav","assets/sounds/Snares/ESWTR909 Snare 09.wav","assets/sounds/Snares/ESWTR909 Snare 10.wav","assets/sounds/Snares/ESWTR909 Snare 11.wav","assets/sounds/Snares/ESWTR909 Snare 12.wav"],RolandTR909_hh:["assets/sounds/Hats/ESWTR909 HH Closed 01.wav","assets/sounds/Hats/ESWTR909 HH Closed 02.wav","assets/sounds/Hats/ESWTR909 HH Closed 03.wav","assets/sounds/Hats/ESWTR909 HH Closed 04.wav","assets/sounds/Hats/ESWTR909 HH Closed 05.wav","assets/sounds/Hats/ESWTR909 HH Closed 06.wav","assets/sounds/Hats/ESWTR909 HH Closed 07.wav","assets/sounds/Hats/ESWTR909 HH Closed 08.wav","assets/sounds/Hats/ESWTR909 HH Closed 09.wav","assets/sounds/Hats/ESWTR909 HH Closed 10.wav"],RolandTR909_oh:["assets/sounds/Hats/ESWTR909 HH Open 01.wav","assets/sounds/Hats/ESWTR909 HH Open 02.wav","assets/sounds/Hats/ESWTR909 HH Open 03.wav","assets/sounds/Hats/ESWTR909 HH Open 04.wav","assets/sounds/Hats/ESWTR909 HH Open 05.wav","assets/sounds/Hats/ESWTR909 HH Open 06.wav","assets/sounds/Hats/ESWTR909 HH Open 07.wav","assets/sounds/Hats/ESWTR909 HH Open 08.wav"],RolandTR909_cp:["assets/sounds/Claps/ESWTR909 Clap 01.wav","assets/sounds/Claps/ESWTR909 Clap 02.wav","assets/sounds/Claps/ESWTR909 Clap 03.wav","assets/sounds/Claps/ESWTR909 Clap 04.wav","assets/sounds/Claps/ESWTR909 Clap 05.wav"],RolandTR909_cr:["assets/sounds/Hats/ESWTR909 HH Crash 01.wav","assets/sounds/Hats/ESWTR909 HH Crash 02.wav","assets/sounds/Hats/ESWTR909 HH Crash 03.wav","assets/sounds/Hats/ESWTR909 HH Crash 04.wav","assets/sounds/Hats/ESWTR909 HH Crash 05.wav"],RolandTR909_lt:["assets/sounds/Toms/ESWTR909 Tom 01.wav","assets/sounds/Toms/ESWTR909 Tom 02.wav","assets/sounds/Toms/ESWTR909 Tom 03.wav","assets/sounds/Toms/ESWTR909 Tom 04.wav","assets/sounds/Toms/ESWTR909 Tom 05.wav"],RolandTR909_mt:["assets/sounds/Toms/ESWTR909 Tom 06.wav","assets/sounds/Toms/ESWTR909 Tom 07.wav","assets/sounds/Toms/ESWTR909 Tom 08.wav","assets/sounds/Toms/ESWTR909 Tom 09.wav","assets/sounds/Toms/ESWTR909 Tom 10.wav"],RolandTR909_ht:["assets/sounds/Toms/ESWTR909 Tom 11.wav","assets/sounds/Toms/ESWTR909 Tom 12.wav","assets/sounds/Toms/ESWTR909 Tom 13.wav","assets/sounds/Toms/ESWTR909 Tom 14.wav","assets/sounds/Toms/ESWTR909 Tom 15.wav"]},RolandTR808:{RolandTR808_bd:["assets/sounds/Kicks/ESW909X Kick 01.wav","assets/sounds/Kicks/ESW909X Kick 02.wav","assets/sounds/Kicks/ESW909X Kick 03.wav","assets/sounds/Kicks/ESW909X Kick 04.wav","assets/sounds/Kicks/ESW909X Kick 05.wav"],RolandTR808_sd:["assets/sounds/Snares/ESW909X Snare 01.wav","assets/sounds/Snares/ESW909X Snare 02.wav","assets/sounds/Snares/ESW909X Snare 03.wav","assets/sounds/Snares/ESW909X Snare 04.wav","assets/sounds/Snares/ESW909X Snare 05.wav"],RolandTR808_cp:["assets/sounds/Claps/ESW909X Clap 01.wav","assets/sounds/Claps/ESW909X Clap 02.wav","assets/sounds/Claps/ESW909X Clap 03.wav","assets/sounds/Claps/ESW909X Clap 04.wav","assets/sounds/Claps/ESW909X Clap 05.wav"]}},r=["RolandTR707","RhythmAce","AkaiLinn","ViscoSpaceDrum","CasioRZ1"],o=["piano","superpiano","jazz","supersaw","folkharp","casio","insect","wind","wood","metal","east","crow","space","numbers","sawtooth","sine","square","triangle","saw","saw2","saw3","saw4","saw8","gtr"],a={mridangam:`${Ta}/mridangam.json`,vcsl:`${Ta}/vcsl.json`};if(a[t]){const g=((c=window.strudel)==null?void 0:c.samples)||globalThis.samples;if(!g||typeof g!="function")return console.warn(`⚠️ samples() function not available for specialty bank "${t}"`),!1;try{console.log(`📦 Loading specialty sample bank "${t}" from dough-samples`);let O=this.specialtyManifests.get(t);if(!O){const M=await fetch(a[t]);if(!M.ok)throw new Error(`HTTP ${M.status}`);const b=await M.json();O=uv(b),this.specialtyManifests.set(t,O)}const p={...O},y=Object.keys(O||{});return y.forEach(M=>{const b=`${t}_${M}`;p[b]||(p[b]=O[M])}),await g(p),y.forEach(M=>{const b=M.toLowerCase();this.sampleNameToSpecialtyBank.set(b,t),this.sampleNameToSpecialtyBank.set(`${t}_${b}`,t),this.loadedBanks.add(b),this.loadedBanks.add(M),this.loadedBanks.add(`${t}_${b}`),this.loadedBanks.add(`${t}_${M}`)}),this.loadedBanks.add(t),this.loadedBanks.add(e),console.log(`✅ Specialty bank "${t}" loaded`),!0}catch(O){return console.warn(`⚠️ Failed to load specialty bank "${t}":`,O.message||O),!1}}if(s[e]){console.log(`📦 Loading local custom bank "${e}" from assets folder...`);const g=((u=window.strudel)==null?void 0:u.samples)||globalThis.samples;if(g&&typeof g=="function")try{return await g(s[e]),console.log(`✅ Local custom bank "${e}" loaded successfully from assets`),this.loadedBanks.add(e),!0}catch(O){return console.error(`❌ Failed to load local bank "${e}":`,O),!1}else return console.error("❌ samples() function not available"),!1}if(r.includes(e)){console.log(`📦 Ensuring built-in drum bank "${e}" samples are loaded...`);try{const O=`d15 = s("bd sd hh cp oh cr rd ht mt lt sh cb tb pe").bank("${e}")`;if(await window.strudel.evaluate(O),window.strudel.scheduler&&typeof window.strudel.scheduler.tick=="function")for(let p=0;p<4;p++)window.strudel.scheduler.tick(),await new Promise(y=>setTimeout(y,50));else await new Promise(p=>setTimeout(p,200));return await window.strudel.evaluate("d15 = silence"),this.loadedBanks.add(e),console.log(`✅ Built-in drum bank "${e}" ready`),!0}catch(g){return console.warn(`⚠️ Could not preload built-in bank "${e}":`,g),this.loadedBanks.add(e),!0}}let l=t;if(Ji[t]&&(l=Ji[t],console.log(`🔄 Normalizing bank name "${e}" to "${l}"`)),o.includes(l)){const g=((h=window.strudel)==null?void 0:h.samples)||globalThis.samples;if(g&&typeof g=="function")try{return console.log(`📦 Loading sample bank "${l}" via samples()`),await g(l),this.loadedBanks.add(l),this.loadedBanks.add(t),console.log(`✅ Sample bank "${l}" loaded`),!0}catch(O){return console.warn(`⚠️ Failed to load sample bank "${l}":`,O.message||O),this.loadedBanks.add(l),this.loadedBanks.add(t),!1}else return console.warn(`⚠️ samples() function not available for loading "${l}"`),!1}if(e.startsWith("github:")){const g=((f=window.strudel)==null?void 0:f.samples)||globalThis.samples;if(!g||typeof g!="function")throw console.error("samples function not available!"),new Error("samples function not available");console.log(`📦 Loading bank via samples(): ${e}`);try{const O=await g(e);return console.log("samples() call completed, result:",O),console.log("⏳ Waiting for samples to load..."),await new Promise(p=>setTimeout(p,2e3)),console.log(`✅ Bank loaded: ${e}`),!0}catch(O){throw console.error(`❌ Failed to load bank ${e}:`,O),O}}else{console.log(`📦 Bank "${e}" is a predefined bank name`);const g=((m=window.strudel)==null?void 0:m.samples)||globalThis.samples;if(!g||typeof g!="function")return console.warn(`⚠️ samples function not available for loading bank "${e}"`),console.log(`   Bank "${e}" may need to be loaded manually`),!1;const O=[e];let p=!1;const y=console.error;console.error=(...b)=>{let S="";for(let E=0;E<b.length;E++)typeof b[E]=="string"?S+=" "+b[E]:b[E]&&b[E].toString&&(S+=" "+String(b[E]));const k=String(b[0]||""),x=S.toLowerCase();k.includes("JSON")||k.includes("SyntaxError")||k.includes("not found")||k.includes("RolandTR")||k.includes("404")||k.includes("Failed")||k.includes("<!DOCTYPE")||k.includes("Unexpected token")||k.includes("is not valid JSON")||k.includes("Unexpected non-whitespace")||S.includes("JSON")||S.includes("SyntaxError")||S.includes("not found")||S.includes("RolandTR")||S.includes("404")||S.includes("<!DOCTYPE")||S.includes("Unexpected token")||S.includes("is not valid JSON")||x.includes("json")||x.includes("syntaxerror")||x.includes("rolandtr")||y.apply(console,b)};try{for(const b of O)try{console.log(`   Trying to load from: ${b}`);const S=await g(b);console.log(`   ✅ Successfully called samples() with: ${b}`),p=!0;break}catch{console.log(`   ✗ Path "${b}" not available`);continue}}finally{console.error=y}return p?(console.log("⏳ Waiting for samples to load..."),await new Promise(b=>setTimeout(b,3e3)),console.log(`✅ Bank "${e}" loading initiated`),this.loadedBanks.add(e)):(console.log(`⚠️ Could not load "${e}" from any known path`),console.log(`   Bank "${e}" may be embedded in Strudel or unavailable`),console.log(`   To use this bank in patterns (if available), use: .bank("${e}")`),console.log(`   Example: sound("bd hh").bank("${e}")`)),p}}async initializeMIDI(){try{if(await Y.enable(),this.midiEnabled=!0,console.log("✅ WebMidi enabled"),Y.outputs.forEach(e=>{this.midiOutputs.set(e.name,e),console.log(`🎹 MIDI Output available: ${e.name}`)}),this.midiOutputs.size>0){const e=Array.from(this.midiOutputs.values())[0];this.selectedMidiOutput=e,console.log(`✅ Auto-selected MIDI output: ${e.name}`)}Y.addListener("connected",e=>{e.port.type==="output"&&(this.midiOutputs.set(e.port.name,e.port),console.log(`🎹 MIDI Output connected: ${e.port.name}`),this.selectedMidiOutput||(this.selectedMidiOutput=e.port,console.log(`✅ Auto-selected MIDI output: ${e.port.name}`)))}),Y.addListener("disconnected",e=>{e.port.type==="output"&&(this.midiOutputs.delete(e.port.name),console.log(`🎹 MIDI Output disconnected: ${e.port.name}`),this.selectedMidiOutput===e.port&&(this.selectedMidiOutput=null,this.midiOutputs.size>0&&(this.selectedMidiOutput=Array.from(this.midiOutputs.values())[0],console.log(`✅ Auto-selected new MIDI output: ${this.selectedMidiOutput.name}`))))}),this.setupStrudelMIDIOutput()}catch(e){console.warn("⚠️ WebMidi initialization failed:",e),this.midiEnabled=!1}}setupStrudelMIDIOutput(){var e,t;if(!(!this.midiEnabled||!window.strudel))try{const n=(e=window.strudel)==null?void 0:e.scheduler,s=(n==null?void 0:n.webaudio)||((t=window.strudel)==null?void 0:t.webaudio);if(s)if(s.midiOutput){const r=s.midiOutput;s.midiOutput=o=>{this.sendMIDIMessage(o),r&&typeof r=="function"&&r(o)},console.log("✅ Connected Strudel webaudio.midiOutput to WebMidi")}else s.midiOutput=r=>{this.sendMIDIMessage(r)},console.log("✅ Created Strudel webaudio.midiOutput handler"),console.log("ℹ️ MIDI modifiers (.midi(), .midiport()) should now be available on patterns");if(window.strudel.midiOutput){const r=window.strudel.midiOutput;window.strudel.midiOutput=o=>{this.sendMIDIMessage(o),r&&typeof r=="function"&&r(o)}}else window.strudel.midiOutput=r=>{this.sendMIDIMessage(r)};setTimeout(()=>{this.selectIACDriver()},500),console.log("✅ Strudel MIDI output handler set up")}catch(n){console.warn("⚠️ Failed to set up Strudel MIDI output:",n)}}selectIACDriver(){const e=["IAC Driver Bus 1","IAC Driver Bus 2","IAC Driver","IAC Bus 1","IAC Bus 2","loopMIDI","Virtual MIDI"];for(const t of e)for(const[n,s]of this.midiOutputs.entries())if(n===t||t.toLowerCase().includes("iac")&&n.toLowerCase().includes("iac")){this.selectMIDIOutput(n),console.log(`✅ Auto-selected IAC Driver: ${n}`);return}this.midiOutputs.size>0?(console.log("ℹ️ IAC Driver not found. Available MIDI outputs:",Array.from(this.midiOutputs.keys()).join(", ")),console.log('ℹ️ You can manually select a MIDI output using: soundManager.selectMIDIOutput("port name")')):console.log("ℹ️ No MIDI outputs available. Make sure IAC Driver is enabled in Audio MIDI Setup on macOS.")}sendMIDIMessage(e){if(!this.midiEnabled||!this.selectedMidiOutput){this.midiEnabled?this.selectedMidiOutput||console.warn("⚠️ No MIDI output selected. Available:",Array.from(this.midiOutputs.keys()).join(", ")):console.warn("⚠️ MIDI not enabled");return}try{let t=this.midiChannel,n=null,s=127,r=null;switch(e.channel!==void 0?t=e.channel:e.port!==void 0&&(t=e.port),e.note!==void 0?n=e.note:e.number!==void 0&&(n=e.number),e.velocity!==void 0?s=e.velocity:e.value!==void 0&&e.type==="noteon"&&(s=e.value),e.type?r=e.type.toLowerCase():n!==null&&(r="noteon"),t=Math.max(0,Math.min(15,t)),r){case"noteon":case"noteon":n!==null&&this.selectedMidiOutput.playNote(n,{channel:t+1,velocity:Math.max(1,Math.min(127,s))});break;case"noteoff":case"noteoff":n!==null&&this.selectedMidiOutput.stopNote(n,{channel:t+1});break;case"cc":case"controlchange":e.controller!==void 0&&e.value!==void 0&&this.selectedMidiOutput.sendControlChange(e.controller,e.value,{channel:t+1});break;case"programchange":e.program!==void 0&&this.selectedMidiOutput.sendProgramChange(e.program,{channel:t+1});break;case"pitchbend":e.value!==void 0&&this.selectedMidiOutput.sendPitchBend(e.value,{channel:t+1});break;default:e.data&&Array.isArray(e.data)?this.selectedMidiOutput.send(e.data):n!==null&&this.selectedMidiOutput.playNote(n,{channel:t+1,velocity:Math.max(1,Math.min(127,s))})}}catch(t){console.warn("⚠️ Failed to send MIDI message:",t,e)}}getMIDIOutputs(){return Array.from(this.midiOutputs.keys())}selectMIDIOutput(e){return this.midiOutputs.has(e)?(this.selectedMidiOutput=this.midiOutputs.get(e),console.log(`✅ Selected MIDI output: ${e}`),!0):(console.warn(`⚠️ MIDI output not found: ${e}`),!1)}setMIDIChannel(e){e>=0&&e<=15&&(this.midiChannel=e,console.log(`✅ MIDI channel set to: ${e+1}`))}async ensureMIDIFunctionsAvailable(){var e;for(let t=0;t<5&&!(window.strudel&&window.strudel.evaluate);t++)await new Promise(n=>setTimeout(n,500));if(!window.strudel||!window.strudel.evaluate){console.warn("⚠️ Strudel REPL not available for MIDI functions after waiting");return}try{const t=`
        (function() {
          try {
            const testPattern = note("c");
            return typeof testPattern.midi === 'function';
          } catch (e) {
            return false;
          }
        })()
      `;if(await window.strudel.evaluate(t))console.log("✅ MIDI functions verified and available");else{console.log("📦 MIDI functions not available - checking webaudio MIDI setup...");const s=(e=window.strudel)==null?void 0:e.scheduler;if(s&&s.webaudio){const o=s.webaudio;console.log("✅ webaudio found in scheduler"),o.midiOutput?(console.log("✅ MIDI output handler found in webaudio"),console.log("ℹ️ MIDI modifiers (.midi(), .midiport()) should be available"),console.log("ℹ️ If they are not, this may be a Strudel version issue"),console.log('ℹ️ Try: note("c").midi() in the console to test')):(console.warn("⚠️ MIDI output handler not found in webaudio"),console.warn("   This means MIDI modifiers may not be available"),console.warn("   We passed midiOutput to initStrudel, but it may not have been applied"),this.midiEnabled&&(o.midiOutput=a=>{this.sendMIDIMessage(a)},console.log("✅ Manually set webaudio.midiOutput handler")))}else console.warn("⚠️ webaudio not found in scheduler");await new Promise(o=>setTimeout(o,500)),await window.strudel.evaluate(t)?console.log("✅ MIDI functions now available"):(console.warn("⚠️ MIDI functions still not available"),console.warn("   MIDI modifiers (.midi(), .midiport()) are pattern methods from @strudel/webaudio"),console.warn("   They should be available when midiOutput is passed to initStrudel"),console.warn("   This may indicate a Strudel version compatibility issue"),console.warn("   Try updating @strudel/webaudio to the latest version"))}}catch(t){console.warn("⚠️ Error checking MIDI functions:",t)}}async preloadPresetSamples(){var n;const e=((n=window.strudel)==null?void 0:n.samples)||globalThis.samples;if(!e||typeof e!="function"){console.warn("⚠️ samples() function not available for pre-loading preset samples");return}const t=["github:tidalcycles/dirt-samples","github:switchangel/pad","github:yaxu/clean-breaks/main"];console.log("📦 Pre-loading samples from Sampler Effects presets...");for(const s of t)try{console.log(`   Loading: ${s}`),await e(s),console.log(`   ✅ Loaded: ${s}`),await new Promise(r=>setTimeout(r,200))}catch(r){console.warn(`   ⚠️ Failed to load ${s}:`,r.message)}console.log("✅ Finished pre-loading preset samples")}async ensurePatternResourcesLoaded(e){var d;if(!e||typeof e!="string"||typeof this.loadBank!="function")return;const t=this._sanitizePatternExpression(e)||e,n=new Set(["sine","square","triangle","sawtooth","supersaw","pulse","saw","saw2","saw3","saw4","saw8"]),s=new Set,r=/\.bank\(["']([^"']+)["']\)/g;let o;for(;(o=r.exec(t))!==null;)o[1]&&s.add(o[1]);const a=/\.s\(["']([^"']+)["']\)/g;for(;(o=a.exec(t))!==null;){const c=o[1];c&&(/\s|~|\[|\]|,/.test(c)||n.has(c.toLowerCase())||s.add(c))}const l=/\.sound\(["']([^"']+)["']\)/g;for(;(o=l.exec(t))!==null;){const c=o[1];c&&(n.has(c.toLowerCase())||s.add(c))}for(const c of s){if(this.loadedBanks.has(c)||!c)continue;const u=c.toLowerCase();if(n.has(u)){console.log(`⏭️ Skipping built-in oscillator synth "${c}" (no loading needed)`),this.loadedBanks.add(u),this.loadedBanks.add(c);continue}const h=(d=this.sampleNameToSpecialtyBank)==null?void 0:d.get(u);if(h){if(console.log(`⏭️ "${c}" is provided by specialty bank "${h}"`),!this.loadedBanks.has(h))try{await this.loadBank(h)}catch(m){console.warn(`⚠️ Could not ensure specialty bank "${h}" for "${c}":`,m)}this.loadedBanks.add(u),this.loadedBanks.add(c);continue}let f=u;if(Ji[u]&&(f=Ji[u],console.log(`🔄 Normalizing "${c}" to "${f}" for loading`)),this.loadedBanks.has(f)){console.log(`✅ Resource "${c}" already loaded as "${f}"`),this.loadedBanks.add(c);continue}try{console.log(`🎚️ ensurePatternResourcesLoaded: loading "${f}" for playback`),await this.loadBank(f)?(this.loadedBanks.add(f),this.loadedBanks.add(c),console.log(`✅ Resource "${f}" loaded`)):console.warn(`⚠️ Could not load resource "${f}" (continuing anyway)`)}catch(m){console.warn(`⚠️ Error loading resource "${f}" (continuing anyway):`,m.message||m)}}}stopSustainingTone(e){const t=this.activeSounds.get(e);if(t&&t.type==="sustaining"&&t.oscillator)try{const n=t.gain,s=this.audioContext.currentTime;n.gain.cancelScheduledValues(s),n.gain.setValueAtTime(n.gain.value,s),n.gain.linearRampToValueAtTime(0,s+.1),setTimeout(()=>{t.oscillator.stop(),this.activeSounds.delete(e)},100)}catch(n){console.error("Error stopping sustaining tone:",n),this.activeSounds.delete(e)}}saveElementToMaster(e,t,n,s){try{console.log(`💾 Saving ${e} to master: pattern="${t==null?void 0:t.substring(0,50)}...", gain=${n}, pan=${s}`);const r=(t||"").replace(/[""]/g,'"').replace(/['']/g,"'"),o=this._sanitizePatternExpression(r),a=this.patternHasNoteNames(o),l=this.patternHasNumericNotePattern(o);let d=o;if(/\bnote\s*\(/i.test(r)){const u=/\bnote\s*\(\s*(["'])([^"']*)\1/gi;let h=!1;d=d.replace(u,(f,m,g)=>{const O=g.replace(/[<>\[\]\{\}\|,]/g," ").trim();return O&&!/[a-gA-G]/.test(O)&&/^[\d\s~\-\/]+$/.test(O)?(h=!0,`n(${m}${g}${m}`):f}),h&&console.log(`🔄 Converted note() with semitones to n() for ${e}`)}return this.trackedPatterns.set(e,{rawPattern:d,pattern:d,gain:n||.8,pan:s||0,muted:!1,soloed:!1}),this.audioContext&&this.getElementAudioNodes(e)&&console.log(`  🎚️ Created audio nodes for ${e}`),console.log(`✅ Saved ${e} to master. Total tracks: ${this.trackedPatterns.size}`),{success:!0}}catch(r){return console.error(`❌ Error saving ${e} to master:`,r),{success:!1,error:r.message}}}async routePatternThroughMaster(e,t,{isPreview:n=!1,autoStart:s=!1}={}){if(!this.masterOnlyPlayback)return{success:!1,error:"Master-only playback is disabled"};const r=typeof t=="string"?t:"";if(!r.trim())return console.warn(`⚠️ Empty pattern for ${e}, removing from master`),this.removeElementFromMaster(e),this.masterActive&&await this.playMasterPattern(),{success:!1,error:"Pattern empty"};const a=this.getElementGain(e),l=this.getElementPan(e),d=this.saveElementToMaster(e,r,a,l);return d.success?(n?this.previewElementIds.add(e):this.previewElementIds.delete(e),this.updateMasterPattern(this.soloedElements,this.mutedElements),this.masterActive||s?this.playMasterPattern():{success:!0,autoStarted:!1}):d}removeElementFromMaster(e){try{return this.previewElementIds.delete(e),this.trackedPatterns.has(e)&&(this.trackedPatterns.delete(e),console.log(`🗑️ Removed ${e} from master. Remaining tracks: ${this.trackedPatterns.size}`),this.updateMasterPattern(),this.masterOnlyPlayback&&(this.masterPattern&&this.masterPattern.trim()?this.masterActive&&this.playMasterPattern().catch(t=>console.warn("⚠️ Failed to refresh master after removal:",t)):this.masterActive&&this.stopMasterPattern().catch(t=>console.warn("⚠️ Failed to stop master after removal:",t)))),{success:!0}}catch(t){return console.error(`❌ Error removing ${e} from master:`,t),{success:!1,error:t.message}}}updateTrackedElementGain(e,t){if(this.trackedPatterns.has(e)){const n=this.trackedPatterns.get(e);return n.gain=t,console.log(`🎚️ Updated ${e} gain in master: ${t.toFixed(2)}`),this.updateMasterPattern(this.soloedElements,this.mutedElements),this.scheduleMasterPatternRefresh(`gain change: ${e}`),{success:!0}}return{success:!1,reason:"Element not tracked in master"}}updateTrackedElementPan(e,t){if(this.trackedPatterns.has(e)){const n=this.trackedPatterns.get(e);return n.pan=t,console.log(`🎚️ Updated ${e} pan in master: ${t.toFixed(2)}`),this.updateMasterPattern(this.soloedElements,this.mutedElements),this.scheduleMasterPatternRefresh(`pan change: ${e}`),{success:!0}}return{success:!1,reason:"Element not tracked in master"}}scheduleMasterPatternRefresh(e="unspecified"){this._pendingMasterPatternRefreshReason=e,!this._masterPatternRefreshTimer&&(this._masterPatternRefreshTimer=setTimeout(()=>{this._masterPatternRefreshTimer=null,this._performScheduledMasterPatternRefresh()},60))}async _performScheduledMasterPatternRefresh(){if(!this.masterPattern||this.masterPattern.trim()===""){this._pendingMasterPatternRefreshReason=null;return}if(!this.masterActive){console.log(`🔁 Master refresh skipped (not active). Pending reason: ${this._pendingMasterPatternRefreshReason||"unspecified"}`),this._pendingMasterPatternRefreshReason=null;return}const e=this._pendingMasterPatternRefreshReason||"unspecified";this._pendingMasterPatternRefreshReason=null,this._masterPatternEvalPromise=this._masterPatternEvalPromise.catch(()=>{}).then(()=>this._reEvaluateMasterPattern(e));try{await this._masterPatternEvalPromise}catch(t){console.warn(`⚠️ Master pattern refresh failed (${e}):`,t)}}formatMasterPatternWithTempoComment(e){if(!e||typeof e!="string"||e.trim()==="")return e;const t=this.currentTempo||120,n="// Controls Selected Tempo:",r=e.split(`
`).filter(a=>!a.trim().startsWith(n)).join(`
`).trimEnd(),o=this._sanitizePatternExpression(r);return o!==r&&console.log("🧼 Sanitized master pattern when formatting tempo comment"),`${o}

${n} ${t} BPM`}updateMasterPattern(e=new Set,t=new Set){var n,s,r;try{console.log(`🎛️ Updating master pattern. Tracks: ${this.trackedPatterns.size}, Solo: ${e.size}, Muted: ${t.size}`);const o=[],a=[],l=[],d=e.size>0,c=this.getScaleConversionContext();let u=0;for(const[f,m]of this.trackedPatterns.entries()){const g=t.has(f),O=e.has(f),p=this.extractChannelNumber(f,u);if(u+=1,g||d&&!O){console.log(`  ⏭️ Skipping ${f} (muted: ${g}, solo active but not soloed: ${d&&!O})`);continue}if(m.gain<=0){console.log(`  ⏭️ Skipping ${f} (gain is ${m.gain})`);continue}const y=m.pattern||m.rawPattern||"",M=this._sanitizePatternExpression(y);if(M!==y&&(m.pattern=M,m.rawPattern=M),!M||M.trim()===""){console.log(`  ⏭️ Skipping ${f} (empty pattern)`);continue}const b=this.patternHasNoteNames(M),S=this.patternHasNumericNotePattern(M);let k=M;b&&!S?(k=M,console.log(`  📝 Preserving note names format for ${f}: ${M.substring(0,50)}...`)):S&&!b?(k=M,console.log(`  📝 Preserving semitones format for ${f}: ${M.substring(0,50)}...`)):(k=M,console.log(`  📝 Preserving pattern format as-is for ${f}: ${M.substring(0,50)}...`)),m.pattern=k;let x=(k||"").trim();if(x=x.replace(/[""]/g,'"').replace(/['']/g,"'"),(()=>{const se=/\/\*\s*Channel\s+\d+\s*\*\//i.test(x),pe=/\bstack\s*\(/i.test(x);return!(se||pe)})())for(;x.startsWith("(")&&x.endsWith(")");){let se=0,pe=!0;for(let Se=0;Se<x.length;Se++)if(x[Se]==="("?se++:x[Se]===")"&&se--,se===0&&Se<x.length-1){pe=!1;break}if(pe&&se===0)x=x.slice(1,-1).trim();else break}if(x.startsWith("(")){let se=0,pe=-1;for(let Se=0;Se<x.length;Se++)if(x[Se]==="("&&se++,x[Se]===")"&&se--,se===0){pe=Se;break}pe===-1&&(x=x.substring(1),console.log("  🔧 Stripped unmatched opening paren from pattern"))}x=Na(x),x=`${x.trim()}.postgain(${m.gain.toFixed(2)})`,m.pan!==0&&(x=`${x}.pan(${m.pan.toFixed(2)})`);const F=((s=(n=this.appInstance)==null?void 0:n.loadElementConfig)==null?void 0:s.call(n,f))||{};let W=F.key||null,z=F.scale||null;if((!W||!z)&&x.includes(".scale(")){const se=x.match(/\.\s*scale\s*\(\s*['"]([^'"]+)['"]\s*\)/i);if(se&&se[1]){const pe=se[1];if(pe.includes(":")){const[Se,st]=pe.split(":");W=W||Se.trim(),z=z||st.trim(),console.log(`  🎼 Extracted scale from pattern: ${W}:${z}`)}else z=z||pe.trim(),W=W||"C",console.log(`  🎼 Extracted scale from pattern: ${W}:${z}`)}}const ce=x.trim(),ie=ce.startsWith("(")&&ce.endsWith(")");if(x=this.applyGlobalSettingsToPattern(x,ie,!1,W,z),m.pan===0){let se=x.trim();(()=>{for(;se.startsWith("(")&&se.endsWith(")");){let Se=0,st=!0;for(let Ze=0;Ze<se.length;Ze++){const St=se[Ze];if(St==="("?Se++:St===")"&&Se--,Se===0&&Ze<se.length-1){st=!1;break}}if(!st||Se!==0)break;se=se.slice(1,-1).trim()}})(),x=se}o.push(x),l.push(p),a.push(`Channel ${p}`),console.log(`  ✅ Added ${f}: ${x.substring(0,100)}...`)}if(o.length===0)this.masterPattern="",console.log("🔇 No active patterns - master pattern cleared");else{let m=`stack(
${o.map((S,k)=>`  /* Channel ${l[k]??k+1} */
  ${S}`).join(`,

`)}
)`;m=this.applyMasterMixModifiers(m,{wrapStack:!0}),this.masterPattern=m;let g=0,O=!1,p=null,y=!1;for(let S=0;S<this.masterPattern.length;S++){const k=this.masterPattern[S],x=this.masterPattern[S+1];if(!O&&k==="/"&&x==="/"){y=!0,S++;continue}if(y&&k===`
`){y=!1;continue}if(!y){if(!y&&(k==='"'||k==="'")){O?k===p&&this.masterPattern[S-1]!=="\\"&&(O=!1,p=null):(O=!0,p=k);continue}if(!O&&!y){if(k==="(")g++;else if(k===")"&&(g--,g<0)){console.error(`  ⚠️ UNBALANCED PARENTHESES! Extra closing paren at position ${S}`);break}}}}const M=(this.masterPattern.match(/\(/g)||[]).length,b=(this.masterPattern.match(/\)/g)||[]).length;if(console.log(`🎵 Master pattern (stack): ${this.masterPattern.substring(0,150)}...`),console.log(`  📊 Parentheses: ${M} open, ${b} close, depth=${g}, balanced: ${g===0}`),g!==0)if(console.error(`  ⚠️ UNBALANCED PARENTHESES! Depth=${g}, fixing...`),console.log(`  🧾 Master pattern before fix:
`,this.masterPattern),g>0)this.masterPattern+=")".repeat(g),console.log(`  ✅ Added ${g} closing paren(s)`);else{const S=Math.abs(g);let k=0;for(let x=this.masterPattern.length-1;x>=0&&k<S;x--)this.masterPattern[x]===")"&&(this.masterPattern=this.masterPattern.substring(0,x)+this.masterPattern.substring(x+1),k++);console.log(`  ✅ Removed ${k} extra closing paren(s)`)}}if(this.masterPattern&&((r=window.__patternHistory)!=null&&r.saveMasterVersion))try{window.__patternHistory.saveMasterVersion(this.masterPattern)}catch(f){console.warn("⚠️ Unable to record master history entry:",f)}const h=this.masterPattern;if(h&&h.trim()!==""){let f=this.convertPatternForScale(h)||h;this.masterPattern=this.formatMasterPatternWithTempoComment(f)}return console.log(`🎛️ Applied global settings to master pattern (Key: ${this.currentKey||"none"}, Scale: ${this.currentScale||(this.currentKey?"derived":"none")}, Time Sig: ${this.currentTimeSignature||"none"}, Volume: ${this.formatNumberForPattern(this.masterVolume,4)}, Pan: ${this.formatNumberForPattern(this.masterPan,4)}, Tempo: ${this.currentTempo||120} BPM)`),this.onMasterPatternUpdateCallback&&this.onMasterPatternUpdateCallback(),{success:!0,pattern:this.masterPattern}}catch(o){return console.error("❌ Error updating master pattern:",o),{success:!1,error:o.message}}}setupVisualizerAnalyser(){var n,s;if(!this.audioContext||!window.strudel)return;const e="master-punchcard-canvas",t=((n=window.strudel)==null?void 0:n.getAnalyserById)||globalThis.getAnalyserById;if(!t||typeof t!="function"){console.warn("⚠️ getAnalyserById not available - visualizers may not work");return}try{let r=null;try{r=t(e,2048,.8),r&&r.context!==this.audioContext&&(console.warn("⚠️ Analyser from getAnalyserById is in different audio context, creating new one"),r=null)}catch(o){console.warn("⚠️ Could not get analyser from getAnalyserById:",o.message)}if(!r){r=this.audioContext.createAnalyser(),r.fftSize=2048,r.smoothingTimeConstant=.8;const o=t,a=r;window.strudel&&(window.strudel.analysers&&typeof window.strudel.analysers=="object"&&(window.strudel.analysers[e]=r,console.log(`✅ Stored analyser "${e}" in Strudel's analyser registry`)),window.strudel.getAnalyserById=function(l,d,c){return l===e?a:o(l,d,c)}),globalThis.getAnalyserById&&(globalThis.getAnalyserById=function(l,d,c){return l===e?a:o(l,d,c)}),globalThis.analysers||(globalThis.analysers={}),globalThis.analysers[e]=r,console.log(`✅ Created analyser "${e}" in our audio context and patched getAnalyserById`)}if(this.visualizerAnalyser=r,this.masterGainNode&&r){const o=this._realDestination||((s=this.audioContext)==null?void 0:s.destination);if(!o)console.warn("⚠️ Cannot connect analyser - destination unavailable");else try{if(!this.visualizerAnalyserTapGain&&this.audioContext&&(this.visualizerAnalyserTapGain=this.audioContext.createGain(),this.visualizerAnalyserTapGain.gain.value=0),this.visualizerAnalyserTapGain){try{this.visualizerAnalyserTapGain.disconnect()}catch{}this.visualizerAnalyserTapGain.connect(o)}try{r.disconnect()}catch{}try{this.masterGainNode.disconnect(r)}catch{}this.masterGainNode.connect(r),this.visualizerAnalyserTapGain&&r.connect(this.visualizerAnalyserTapGain),console.log(`✅ Connected visualizer analyser "${e}" with silent tap to destination`),setTimeout(()=>{try{const a=new Uint8Array(r.frequencyBinCount);r.getByteFrequencyData(a);const l=a.some(u=>u>0),d=Math.max(...a);console.log(`🔍 Analyser data check: hasData=${l}, maxValue=${d}, frequencyBinCount=${r.frequencyBinCount}`);const c=document.getElementById(e);c?console.log(`🔍 Canvas check: found canvas with ID "${e}", width=${c.width}, height=${c.height}`):console.warn(`⚠️ Canvas with ID "${e}" not found!`)}catch(a){console.warn("⚠️ Could not check analyser data:",a)}},500)}catch(a){console.warn(`⚠️ Failed to connect analyser "${e}":`,a.message)}}else console.warn(`⚠️ Cannot connect analyser - masterGainNode: ${!!this.masterGainNode}, analyser: ${!!r}`)}catch(r){console.warn("⚠️ Failed to setup visualizer analyser:",r)}}applyVisualizerTargetsToPattern(e){if(!e||typeof e!="string")return e;const n="master-punchcard-canvas",s="window.__strudelVisualizerCtx || (document.getElementById('master-punchcard-canvas') && document.getElementById('master-punchcard-canvas').getContext && document.getElementById('master-punchcard-canvas').getContext('2d'))",r=["spectrum","scope","tscope","fscope","visual","pianoroll","barchart"];let o=e;const a=new RegExp(`\\.\\s*_(${r.join("|")})\\s*\\(`,"gi");o=o.replace(a,(c,u)=>c.replace(`_${u}`,u));const l=["spectrum","scope","tscope","fscope"],d=["visual","barchart","pianoroll"];return l.forEach(c=>{const u=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(`\\.\\s*_?${u}\\s*\\(\\s*\\)`,"gi");o=o.replace(h,m=>m.replace(/\(\s*\)/,`({ id: '${n}' })`));const f=new RegExp(`\\.\\s*_?${u}\\s*\\(\\s*\\{([^}]*)\\}\\s*\\)`,"gi");o=o.replace(f,(m,g)=>{let O=g.trim();return/(^|,)\s*id\s*:/.test(O)||(O=O.length>0?`${O}, id: '${n}'`:`id: '${n}'`),m.replace(g,O)})}),d.forEach(c=>{const u=c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(`\\.\\s*_?${u}\\s*\\(\\s*\\)`,"gi");o=o.replace(h,m=>m.replace(/\(\s*\)/,`({ id: '${n}', ctx: ${s} })`));const f=new RegExp(`\\.\\s*_?${u}\\s*\\(\\s*\\{([^}]*)\\}\\s*\\)`,"gi");o=o.replace(f,(m,g)=>{let O=g.trim();const p=/(^|,)\s*id\s*:/.test(O),y=/(^|,)\s*ctx\s*:/.test(O);return p||(O=O.length>0?`${O}, id: '${n}'`:`id: '${n}'`),y||(O=O.length>0?`${O}, ctx: ${s}`:`ctx: ${s}`),m.replace(g,O)})}),o!==e&&(console.log("🎨 Injected canvas ID into visualizer methods"),console.log(`   Before: ${e.substring(0,150)}...`),console.log(`   After: ${o.substring(0,150)}...`)),o}async _reEvaluateMasterPattern(e="manual"){if(!this.masterPattern||this.masterPattern.trim()==="")return console.log("⚠️ No master pattern to re-evaluate"),{success:!1,error:"No pattern to re-evaluate"};if(!window.strudel||typeof window.strudel.evaluate!="function")return{success:!1,error:"Strudel evaluate unavailable"};this._ensureMasterPatternSanitized();const t=this.masterSlot||"d0",n=`${t} = ${this.masterPattern.trim()}`;try{return console.log(`🔄 Re-evaluating master pattern (${e})...`),await window.strudel.evaluate(n),console.log(`✅ Master pattern re-evaluated (${e})`),{success:!0,slot:t}}catch(s){return console.error("❌ Failed to re-evaluate master pattern:",s),{success:!1,error:s.message}}}async _playMasterPatternSimple(){var n,s,r;if(!this.masterPattern||this.masterPattern.trim()==="")return console.log("⚠️ No master pattern to play (master-only mode)"),this.masterActive?await this._stopMasterPatternSimple():this.masterActive=!1,{success:!1,error:"No pattern to play"};if(await this.initialize(),this.strudelLoaded||await this.initStrudel(),this.masterGainNode){const o=((n=this.audioContext)==null?void 0:n.currentTime)||0;this.masterGainNode.gain.setValueAtTime(this.masterVolume,o)}if(this.masterPanNode&&this.masterPanNode.pan.setValueAtTime(this.masterPan,((s=this.audioContext)==null?void 0:s.currentTime)||0),!window.strudel||typeof window.strudel.evaluate!="function")return{success:!1,error:"Strudel evaluate unavailable"};this._ensureMasterPatternSanitized();const e=this.masterSlot||"d0",t=`${e} = ${this.masterPattern.trim()}`;try{return await window.strudel.evaluate(t),window.strudel.scheduler?window.strudel.scheduler.started||await window.strudel.scheduler.start():console.warn("⚠️ Strudel scheduler missing - cannot ensure playback"),this.masterActive=!0,this.masterPlaybackStartTime=((r=this.audioContext)==null?void 0:r.currentTime)||performance.now(),this.onMasterStateChangeCallback&&this.onMasterStateChangeCallback(!0,Array.from(this.trackedPatterns.keys())),{success:!0,slot:e}}catch(o){return console.error("❌ Failed to evaluate master pattern:",o),{success:!1,error:o.message}}}async playMasterPattern(){var e,t,n,s,r,o,a,l,d,c,u,h,f,m,g,O,p,y,M,b,S,k,x,E,B,F,W,z,ce,ie,se,pe,Se,st,Ze,St,it,je,Ie,ee,kt,ut,ae,Me,qe,ds,_n,Vt,pn,xt,qt,ti,ni,Rr,si,_r,ii,ri,Es,ns;if(this.masterOnlyPlayback)return this._playMasterPatternSimple();try{if(console.log("▶️ Playing master pattern..."),this.masterActive=!0,console.log("🎚️ masterActive set to TRUE before pattern evaluation"),console.log("🔍 PRE-PLAY: Verifying audio routing hijacking is active..."),console.log("   AudioNode.prototype.__originalConnect exists:",!!AudioNode.prototype.__originalConnect),console.log("   AudioNode.prototype.connect is patched:",AudioNode.prototype.connect!==AudioNode.prototype.__originalConnect),console.log("   masterActive:",this.masterActive),console.log("   trackedPatterns.size:",this.trackedPatterns.size),console.log("   masterPanNode exists:",!!this.masterPanNode),console.log("   masterGainNode exists:",!!this.masterGainNode),this.masterGainNode&&this.masterGainNode.gain.setValueAtTime(this.masterVolume,((e=this.audioContext)==null?void 0:e.currentTime)||0),(!this.audioContext||this.audioContext.state==="suspended")&&await this.initialize(),this.strudelLoaded||(console.log("⏳ Waiting for Strudel to initialize..."),await this.initStrudel()),this._ensureMasterPatternSanitized(),this.setupVisualizerAnalyser(),!this.masterPattern||this.masterPattern.trim()==="")return console.log("⚠️ No master pattern to play"),this.masterActive=!1,{success:!1,error:"No pattern to play"};if(this.audioContext&&this.audioContext.state==="suspended"){console.log("🔊 Audio context suspended, resuming...");try{await this.audioContext.resume(),console.log(`✅ Audio context resumed, state: ${this.audioContext.state}`)}catch(Ce){console.warn("⚠️ Could not resume audio context:",Ce)}}if(window.strudel&&window.strudel.evaluate){let Ce=this.masterPattern.trim();if(!Ce||Ce==="")return console.error("❌ Master pattern is empty, cannot evaluate"),{success:!1,error:"Master pattern is empty"};console.log("🎼 Master pattern before processing:",Ce.substring(0,200)),Ce=Na(Ce),Ce=this.applyVisualizerTargetsToPattern(Ce),console.log("🎼 Master pattern after visualizer injection:",Ce.substring(0,200)),await this.ensureStrudelWorkletsReady(Ce);const Ir=Ce.match(/\.bank\(["']([^"']+)["']\)/g);if(Ir&&typeof this.loadBank=="function"){const L=[...new Set(Ir.map(D=>{const _=D.match(/\.bank\(["']([^"']+)["']\)/);return _?_[1]:null}).filter(Boolean))];for(const D of L)if(!this.loadedBanks.has(D))try{console.log(`🎚️ Master: ensuring bank "${D}" is loaded before playback`),await this.loadBank(D)?(this.loadedBanks.add(D),console.log(`✅ Master: bank "${D}" loaded`)):console.warn(`⚠️ Master: bank "${D}" could not be loaded (continuing anyway)`)}catch(_){console.warn(`⚠️ Master: error loading bank "${D}":`,_)}}await this.ensurePatternResourcesLoaded(Ce),Ce=Ce.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"").replace(/\n\s*\n/g,`
`).trim();const us=Ce;Ce=Ce.replace(/[""]/g,'"').replace(/['']/g,"'"),us!==Ce&&(console.log("🔧 Normalized quotes in master pattern"),console.log(`  Before: ${us.substring(0,100)}...`),console.log(`  After:  ${Ce.substring(0,100)}...`)),!Ce.includes(".loop(")&&!Ce.includes(".loop()")&&(Ce=`${Ce}.loop()`,console.log("🔄 Added .loop() to master pattern for continuous playback")),this.masterActive=!0,console.log("🎚️ masterActive set to TRUE before pattern evaluation"),this._masterDestinationConnectLogged=!1,this._singleElementMasterRoutingLogged=!1,this._noElementRoutingLogged=!1,this._nodeTypeConnectLogged=new Set,this._stackMasterRoutingLogged=!1,this._masterRoutingLogged=!1,this._panNodeConnectedToMaster=new Set,this._gainConnectDebugged=!1,this._stackElementRoutingLogged=new Set,this._chainVerificationLogged=new Set,this._connectionSuccessLogged=new Set,this._allConnectionsLogged=new Set,this._allDestConnectionsLogged=new Set,this._panNodeConnectedLogged=new Set,this._panNodeNotConnectedLogged=new Set,this._panNodeConnectionErrorLogged=new Set,this._masterGainDestVerifiedAfterRouting=new Set,this._masterGainDestVerified=!1,this._stackConnectionCount&&this._stackConnectionCount.set("total",0);const on=this.masterSlot;this.currentEvaluatingSlot=on,console.log(`🎚️ Master stack evaluation slot: ${on}`),console.log(`🔧 Ensuring audio nodes exist for ${this.trackedPatterns.size} tracked elements...`);for(const[L]of this.trackedPatterns.entries()){const D=this.getElementAudioNodes(L);if(D){const _=this.elementGainValues.get(L)||.8;D.gainNode.gain.value=_*this.volume;let X=[];X.push(`gainNode: gain=${D.gainNode.gain.value.toFixed(3)}`),X.push(`panNode: pan=${D.panNode.pan.value.toFixed(3)}`),console.log(`  ✅ ${L}: ${X.join(", ")}`)}else console.warn(`  ⚠️ ${L}: Failed to create audio nodes`)}if(this.visualizerAnalyser&&this.masterGainNode){try{this.masterGainNode.disconnect(this.visualizerAnalyser)}catch{}try{this.masterGainNode.connect(this.visualizerAnalyser),console.log("✅ Reconnected visualizer analyser to master gain node")}catch(L){console.warn("⚠️ Could not reconnect visualizer analyser:",L)}}if(window.strudel&&window.strudel.scheduler&&!window.strudel.scheduler.started){console.log("▶️ Starting Strudel scheduler BEFORE pattern evaluation..."),await window.strudel.scheduler.start(),console.log("✅ Strudel scheduler started");const L=window.strudel.scheduler;console.log("🔍 POST-START: Checking scheduler for webaudio output..."),console.log(`   scheduler keys: ${Object.keys(L).slice(0,15).join(", ")}`);let D=L.webaudio||L._webaudio;if(!D&&window.strudel.webaudio&&(D=window.strudel.webaudio,console.log("   ✅ Found webaudio in window.strudel.webaudio")),D){console.log(`   ✅ Found webaudio, keys: ${Object.keys(D).slice(0,10).join(", ")}`);const _=D.output||D.outputNode;if(_){if(console.log(`   ✅ Found output node: ${_.constructor.name}`),this.trackedPatterns.size>0){const X=Array.from(this.trackedPatterns.keys())[0],te=this.getElementAudioNodes(X);if(te!=null&&te.gainNode)try{_.disconnect(),_.connect(te.gainNode),console.log(`   ✅ Routed webaudio output to ${X} gainNode`)}catch(q){console.log(`   ✅ webaudio output already routed (${q.message})`)}}else if(this.masterPanNode)try{_.disconnect(),_.connect(this.masterPanNode),console.log("   ✅ Routed webaudio output to masterPanNode (fallback)")}catch(X){console.log(`   ✅ webaudio output already routed to master (${X.message})`)}}else console.log("   ⚠️ webaudio found but no output node")}else console.log("   ⚠️ No webaudio found in scheduler or window.strudel");if(L.superdough){const _=L.superdough;console.log(`   ✅ Found superdough, keys: ${Object.keys(_).slice(0,20).join(", ")}`),_.audioContext&&(console.log(`   🔍 superdough.audioContext: ${_.audioContext===this.audioContext?"OUR CONTEXT ✅":"DIFFERENT CONTEXT ⚠️"}`),console.log(`   🔍 superdough.audioContext.state: ${_.audioContext.state}`));const X=["output","outputNode","_output","destination","_destination","gain","masterGain"];for(const te of X)if(_[te]&&_[te]instanceof AudioNode){if(console.log(`   ✅ Found AudioNode at superdough.${te}: ${_[te].constructor.name}`),this.trackedPatterns.size>0){const q=Array.from(this.trackedPatterns.keys())[0],me=this.getElementAudioNodes(q);if(me!=null&&me.gainNode)try{_[te].disconnect(),_[te].connect(me.gainNode),console.log(`   ✅ Routed superdough.${te} to ${q} gainNode`)}catch(Xe){console.log(`   ✅ superdough.${te} already routed (${Xe.message})`)}}else if(this.masterPanNode)try{_[te].disconnect(),_[te].connect(this.masterPanNode),console.log(`   ✅ Routed superdough.${te} to masterPanNode`)}catch(q){console.log(`   ✅ superdough.${te} already routed to master (${q.message})`)}}}}else if(window.strudel&&window.strudel.scheduler&&window.strudel.scheduler.started){console.log("✅ Strudel scheduler already running");const L=window.strudel.scheduler;console.log("🔍 ALREADY-RUNNING: Checking scheduler for webaudio output..."),console.log(`   scheduler keys: ${Object.keys(L).slice(0,15).join(", ")}`);const D=L.webaudio||L._webaudio;if(D){console.log(`   ✅ Found webaudio, keys: ${Object.keys(D).slice(0,10).join(", ")}`);const _=D.output||D.outputNode;if(_){if(console.log(`   ✅ Found output node: ${_.constructor.name}`),this.trackedPatterns.size>0){const X=Array.from(this.trackedPatterns.keys())[0],te=this.getElementAudioNodes(X);if(te!=null&&te.gainNode)try{_.disconnect(),_.connect(te.gainNode),console.log(`   ✅ Routed webaudio output to ${X} gainNode`)}catch(q){console.log(`   ✅ webaudio output already routed (${q.message})`)}}else if(this.masterPanNode)try{_.disconnect(),_.connect(this.masterPanNode),console.log("   ✅ Routed webaudio output to masterPanNode (fallback)")}catch(X){console.log(`   ✅ webaudio output already routed to master (${X.message})`)}}else console.log("   ⚠️ webaudio found but no output node")}else console.log("   ⚠️ No webaudio found in scheduler");if(L.superdough){const _=L.superdough;console.log(`   ✅ Found superdough, keys: ${Object.keys(_).slice(0,20).join(", ")}`),_.audioContext&&(console.log(`   🔍 superdough.audioContext: ${_.audioContext===this.audioContext?"OUR CONTEXT ✅":"DIFFERENT CONTEXT ⚠️"}`),console.log(`   🔍 superdough.audioContext.state: ${_.audioContext.state}`));const X=["output","outputNode","_output","destination","_destination","gain","masterGain"];for(const te of X)if(_[te]&&_[te]instanceof AudioNode){if(console.log(`   ✅ Found AudioNode at superdough.${te}: ${_[te].constructor.name}`),this.trackedPatterns.size>0){const q=Array.from(this.trackedPatterns.keys())[0],me=this.getElementAudioNodes(q);if(me!=null&&me.gainNode)try{_[te].disconnect(),_[te].connect(me.gainNode),console.log(`   ✅ Routed superdough.${te} to ${q} gainNode`)}catch(Xe){console.log(`   ✅ superdough.${te} already routed (${Xe.message})`)}}else if(this.masterPanNode)try{_[te].disconnect(),_[te].connect(this.masterPanNode),console.log(`   ✅ Routed superdough.${te} to masterPanNode`)}catch(q){console.log(`   ✅ superdough.${te} already routed to master (${q.message})`)}}}else console.log("   ⚠️ No superdough found in scheduler")}const wt=`${on} = ${Ce}`;console.log("🎼 Evaluating master pattern:"),console.log(`   Full code: ${wt}`),console.log(`   Code length: ${wt.length} characters`),console.log(`   Evaluation slot: ${on}`);const hs=((t=window.strudel)==null?void 0:t.repl)||window.strudel;if((n=hs==null?void 0:hs.scheduler)!=null&&n.superdough){const L=hs.scheduler.superdough;if(L.audioWorkletsLoaded===!1||L.audioWorkletsLoaded===void 0){console.log("⏳ Waiting for AudioWorklets to load...");let D=0;for(;(L.audioWorkletsLoaded===!1||L.audioWorkletsLoaded===void 0)&&D<50;)await new Promise(_=>setTimeout(_,100)),D++;L.audioWorkletsLoaded===!0?console.log(`✅ AudioWorklets loaded after ${D*100}ms`):console.warn(`⚠️ AudioWorklets may not be loaded after ${D*100}ms - proceeding anyway`)}else console.log("✅ AudioWorklets already loaded")}const Lr=/\.scope\s*\(/.test(wt),Qi=/\.spectrum\s*\(/.test(wt),As=/\.spiral\s*\(/.test(wt),Ri=/\._?pianoroll\s*\(/.test(wt),_i=/\._?barchart\s*\(/.test(wt);if(Lr||Qi||As||Ri||_i){console.log(`   📊 Visualizer methods detected: scope=${Lr}, spectrum=${Qi}, spiral=${As}, pianoroll=${Ri}, barchart=${_i}`);const L=/master-punchcard-canvas/.test(wt);console.log(`   🎯 Canvas ID present in pattern: ${L}`);const D=wt.match(/\.scope\([^)]*\)/),_=wt.match(/\.spectrum\([^)]*\)/),X=wt.match(/\.spiral\([^)]*\)/),te=wt.match(/\._?pianoroll\([^)]*\)/),q=wt.match(/\._?barchart\([^)]*\)/);D&&console.log(`   📊 Scope call: ${D[0]}`),_&&console.log(`   📊 Spectrum call: ${_[0]}`),X&&console.log(`   📊 Spiral call: ${X[0]}`),te&&console.log(`   📊 Pianoroll call: ${te[0]}`),q&&console.log(`   📊 Barchart call: ${q[0]}`)}let Ii;try{Ii=await window.strudel.evaluate(wt),console.log(`✅ Master pattern evaluated successfully, result type: ${typeof Ii}`)}catch(L){console.warn("⚠️ Pattern evaluation warning:",L.message),console.warn(`⚠️ Pattern code that failed: ${wt.substring(0,300)}`)}try{const L=(s=window.strudel)==null?void 0:s.scheduler,D=globalThis==null?void 0:globalThis[on];if(L&&D){console.log("🔍 PRE-PATTERN-SET: Checking scheduler state..."),console.log(`   scheduler.started: ${L.started}`),console.log(`   scheduler.pattern: ${L.pattern?"exists":"null"}`),console.log(`   scheduler keys before: ${Object.keys(L).slice(0,15).join(", ")}`);const _=["webaudio","_webaudio","superdough","_superdough","output","outputNode","audioContext"];for(const X of _)L[X]&&(console.log(`   ✅ Found ${X} in scheduler: ${typeof L[X]}`),L[X]instanceof AudioNode&&console.log(`      → AudioNode: ${L[X].constructor.name}`));try{L.pattern=D,console.log(`🎚️ Scheduler pattern set directly to ${on}`),console.log("🔍 POST-PATTERN-SET: Checking scheduler state after pattern assignment..."),console.log(`   scheduler.pattern: ${L.pattern?"exists":"null"}`),await new Promise(X=>setTimeout(X,100));for(const X of _)if(L[X]&&!L[`_checked_${X}`]){if(console.log(`   ✅ Found ${X} after pattern set: ${typeof L[X]}`),L[X]instanceof AudioNode&&(console.log(`      → AudioNode: ${L[X].constructor.name}`),this.trackedPatterns.size>0)){const te=Array.from(this.trackedPatterns.keys())[0],q=this.getElementAudioNodes(te);if(q!=null&&q.gainNode)try{L[X].disconnect(),L[X].connect(q.gainNode),console.log(`      ✅ Routed scheduler.${X} to ${te} gainNode`)}catch(me){console.log(`      ✅ scheduler.${X} already routed (${me.message})`)}}L[`_checked_${X}`]=!0}}catch{await window.strudel.evaluate(`pattern = ${on}`),console.log(`🎚️ Scheduler pattern set via REPL to ${on}`)}}else console.log("ℹ️ Could not set scheduler pattern directly (scheduler/slot missing)")}catch(L){console.warn(`⚠️ Failed to set scheduler pattern to ${on}:`,(L==null?void 0:L.message)||L)}console.log(`🔍 POST-EVALUATION: trackedPatterns.size=${this.trackedPatterns.size}`),console.log("🔍 POST-EVALUATION: Searching for audio nodes connected to destination...");try{if(this._realDestination&&this._realDestination._inputs){const L=this._realDestination._inputs;console.log(`   Found ${L.length} input(s) to destination`);for(let D=0;D<L.length;D++){const _=L[D];if(_&&_._node){const X=_._node;if(console.log(`   Input ${D}: ${X.constructor.name}`),this.trackedPatterns.size>0){const te=Array.from(this.trackedPatterns.keys())[0],q=this.getElementAudioNodes(te);if(q!=null&&q.gainNode)try{X.disconnect(this._realDestination),X.connect(q.gainNode),console.log(`   ✅ Rerouted ${X.constructor.name} through ${te} gainNode`)}catch(me){console.log(`   ⚠️ Could not reroute ${X.constructor.name}: ${me.message}`)}}}}}else console.log("   ⚠️ Cannot access destination inputs (might be browser-specific)")}catch(L){console.log(`   ⚠️ Error checking destination inputs: ${L.message}`)}if(console.log(`🔍 POST-EVALUATION: Audio context state=${((r=this.audioContext)==null?void 0:r.state)||"unknown"}`),console.log(`🔍 POST-EVALUATION: masterGainNode.gain=${((l=(a=(o=this.masterGainNode)==null?void 0:o.gain)==null?void 0:a.value)==null?void 0:l.toFixed(3))||"N/A"}, muted=${this.masterMuted}`),console.log(`🔍 POST-EVALUATION: masterVolume=${this.masterVolume}, volume=${this.volume}`),this.trackedPatterns.size>=1){const L=Array.from(this.trackedPatterns.keys());console.log(`🔍 POST-EVALUATION: elementIds=${L.join(", ")}`);for(const D of L){const _=this.elementGainValues.get(D)||.8,X=this.getElementAudioNodes(D),te=((c=(d=X==null?void 0:X.gainNode)==null?void 0:d.gain)==null?void 0:c.value)||0;console.log(`🔍 POST-EVALUATION: ${D} - storedGain=${_.toFixed(3)}, actualGain=${te.toFixed(3)}, volume=${this.volume.toFixed(3)}, totalGain=${(te*((h=(u=this.masterGainNode)==null?void 0:u.gain)==null?void 0:h.value)||0).toFixed(3)}`)}try{const D=((f=window.strudel)==null?void 0:f.repl)||window.strudel;if(D!=null&&D.scheduler){const _=D.scheduler;console.log("🔍 POST-EVALUATION: Exploring scheduler object..."),console.log(`   scheduler keys: ${Object.keys(_).slice(0,20).join(", ")}`);let X=_.webaudio||_._webaudio,te=null;if(X)te=X.output||X.outputNode,console.log(`🔍 POST-EVALUATION: Found webaudio, outputNode=${te?te.constructor.name:"null"}`);else{console.log("🔍 POST-EVALUATION: webaudio not found, searching scheduler for output node...");for(const q of Object.keys(_)){const me=_[q];if(me&&typeof me=="object"){if(me.output&&me.output instanceof AudioNode){console.log(`🔍 POST-EVALUATION: Found output node in scheduler.${q}.output`),te=me.output;break}if(me.outputNode&&me.outputNode instanceof AudioNode){console.log(`🔍 POST-EVALUATION: Found output node in scheduler.${q}.outputNode`),te=me.outputNode;break}}}}console.log(`🎚️ 🔍 POST-EVALUATION: Final outputNode=${te?te.constructor.name:"null"}`);for(const q of L){const me=this.getElementAudioNodes(q);if(console.log(`🎚️ 🔍 POST-EVALUATION: ${q}: elementNodes=${!!me}, gainNode=${!!(me!=null&&me.gainNode)}`),me&&me.gainNode){if(te)try{te.disconnect(),te.connect(me.gainNode),console.log(`🎚️ ✅ POST-EVALUATION: Reconnected Strudel output -> ${q} gainNode`)}catch(an){console.warn(`⚠️ POST-EVALUATION: Could not reconnect Strudel output: ${an.message}`)}else console.warn("⚠️ POST-EVALUATION: Output node not found - audio may not route through element chain");const Xe=me.panNode;if(Xe&&this.masterPanNode)try{try{Xe.disconnect(this.masterPanNode)}catch{}Xe.connect(this.masterPanNode),console.log(`🎚️ ✅ POST-EVALUATION: Verified ${q} panNode -> masterPanNode`)}catch(an){console.warn(`⚠️ POST-EVALUATION: Could not verify panNode: ${an.message}`)}}}if(this.masterGainNode&&this._realDestination)try{this.masterGainNode.connect(this._realDestination),console.log(`🎚️ ✅ POST-EVALUATION: Verified masterGainNode -> destination (gain=${this.masterGainNode.gain.value.toFixed(3)}, muted=${this.masterMuted})`)}catch(q){q.message.includes("already connected")||q.message.includes("already been connected")?console.log(`🎚️ ✅ POST-EVALUATION: masterGainNode -> destination already connected (gain=${this.masterGainNode.gain.value.toFixed(3)}, muted=${this.masterMuted})`):console.warn(`⚠️ POST-EVALUATION: Could not verify masterGainNode -> destination: ${q.message}`)}}else console.warn("⚠️ POST-EVALUATION: Could not find scheduler")}catch(D){console.warn(`⚠️ POST-EVALUATION: Error reconnecting Strudel output: ${D.message}`)}}if(setTimeout(()=>{this.currentEvaluatingSlot===this.masterSlot&&(this.currentEvaluatingSlot=null)},this.soundsPreloaded?100:500),this.trackedPatterns.size===1){const L=Array.from(this.trackedPatterns.keys())[0],D=this.getElementAudioNodes(L);console.log(`🔍 AUDIO CHAIN VERIFICATION for ${L}:`),console.log("   📊 AUDIO ROUTING CHAIN (simplified, no masterAnalyser):"),console.log(`      1. Strudel output -> elementGainNode (gain=${((O=(g=(m=D==null?void 0:D.gainNode)==null?void 0:m.gain)==null?void 0:g.value)==null?void 0:O.toFixed(3))||"N/A"})`),console.log(`      2. elementGainNode -> elementPanNode (pan=${((M=(y=(p=D==null?void 0:D.panNode)==null?void 0:p.pan)==null?void 0:y.value)==null?void 0:M.toFixed(3))||"N/A"})`),console.log("      3. elementPanNode -> masterPanNode"),console.log(`      4. masterPanNode -> masterGainNode (gain=${((k=(S=(b=this.masterGainNode)==null?void 0:b.gain)==null?void 0:S.value)==null?void 0:k.toFixed(3))||"N/A"}, muted=${this.masterMuted})`),console.log("      5. masterGainNode -> destination (audio output)"),console.log("      6. masterGainNode -> visualizerAnalyser (parallel, for visualization)"),console.log("   ✅ SIMPLIFIED CHAIN: element gain -> element pan -> master pan -> master gain -> destination"),console.log(`   elementGainNode: ${D!=null&&D.gainNode?"EXISTS":"MISSING"} (gain=${((B=(E=(x=D==null?void 0:D.gainNode)==null?void 0:x.gain)==null?void 0:E.value)==null?void 0:B.toFixed(3))||"N/A"})`),console.log(`   elementPanNode: ${D!=null&&D.panNode?"EXISTS":"MISSING"} (pan=${((z=(W=(F=D==null?void 0:D.panNode)==null?void 0:F.pan)==null?void 0:W.value)==null?void 0:z.toFixed(3))||"N/A"})`),console.log(`   masterPanNode: ${this.masterPanNode?"EXISTS":"MISSING"}`),console.log(`   masterGainNode: ${this.masterGainNode?"EXISTS":"MISSING"} (gain=${((se=(ie=(ce=this.masterGainNode)==null?void 0:ce.gain)==null?void 0:ie.value)==null?void 0:se.toFixed(3))||"N/A"}, muted=${this.masterMuted})`),console.log(`   visualizerAnalyser: ${this.visualizerAnalyser?"EXISTS":"MISSING"}`),console.log(`   destination: ${this._realDestination?"EXISTS":"MISSING"}`),console.log(`   TOTAL GAIN: ${((((Se=(pe=D==null?void 0:D.gainNode)==null?void 0:pe.gain)==null?void 0:Se.value)||0)*(((Ze=(st=this.masterGainNode)==null?void 0:st.gain)==null?void 0:Ze.value)||0)).toFixed(3)} (element=${((je=(it=(St=D==null?void 0:D.gainNode)==null?void 0:St.gain)==null?void 0:it.value)==null?void 0:je.toFixed(3))||"0"} * master=${((kt=(ee=(Ie=this.masterGainNode)==null?void 0:Ie.gain)==null?void 0:ee.value)==null?void 0:kt.toFixed(3))||"0"})`);try{const _=((ut=window.strudel)==null?void 0:ut.repl)||window.strudel;if(_!=null&&_.scheduler){const X=_.scheduler,te=X.webaudio||X._webaudio;if(te){const q=te.output||te.outputNode;q?(console.log(`   Strudel outputNode: EXISTS (${q.constructor.name})`),D!=null&&D.gainNode&&console.log("   ✅ Chain should be: Strudel output -> elementGain -> elementPan -> masterPan -> masterGain -> destination")):console.warn("   ⚠️ Strudel outputNode: NOT FOUND")}else console.warn("   ⚠️ Strudel webaudio: NOT FOUND")}}catch(_){console.warn(`   ⚠️ Could not verify Strudel output: ${_.message}`)}if(console.log("   🔍 VERIFYING MASTER CHAIN:"),console.log(`      masterPanNode: ${this.masterPanNode?"EXISTS":"MISSING"}`),console.log(`      masterGainNode: ${this.masterGainNode?"EXISTS":"MISSING"} (gain=${((qe=(Me=(ae=this.masterGainNode)==null?void 0:ae.gain)==null?void 0:Me.value)==null?void 0:qe.toFixed(3))||"N/A"})`),console.log(`      destination: ${this._realDestination?"EXISTS":"MISSING"}`),this.masterPanNode&&this.masterGainNode)try{this.masterPanNode.connect(this.masterGainNode),console.log("   ✅ VERIFIED: masterPanNode -> masterGainNode")}catch(_){_.message.includes("already connected")||_.message.includes("already been connected")?console.log("   ✅ VERIFIED: masterPanNode -> masterGainNode (already connected)"):console.warn(`   ⚠️ Could not verify masterPanNode -> masterGainNode: ${_.message}`)}if(this.masterGainNode&&this._realDestination)try{this.masterGainNode.connect(this._realDestination),console.log("   ✅ CONNECTED: masterGainNode -> destination (CRITICAL for audio output)")}catch(_){if(_.message&&_.message.includes("already connected")||_.message.includes("InvalidStateError"))console.log("   ✅ VERIFIED: masterGainNode -> destination (already connected)");else try{this.masterGainNode.connect(this._realDestination),console.log("   ✅ RECONNECTED: masterGainNode -> destination")}catch(X){X.message.includes("already connected")||X.message.includes("already been connected")?console.log("   ✅ VERIFIED: masterGainNode -> destination (already connected)"):console.error(`   ❌ FAILED: Could not connect masterGainNode -> destination: ${X.message}`)}}else console.warn(`   ⚠️ Cannot verify masterGainNode->destination: masterGainNode=${!!this.masterGainNode}, destination=${!!this._realDestination}`)}if(console.log("🔍 FINAL CHAIN VERIFICATION:"),this.trackedPatterns.size>0){const L=Array.from(this.trackedPatterns.keys());for(const D of L){const _=this.getElementAudioNodes(D);console.log(`   ${D}:`),console.log(`      elementGain: ${_!=null&&_.gainNode?"EXISTS":"MISSING"} (gain=${((Vt=(_n=(ds=_==null?void 0:_.gainNode)==null?void 0:ds.gain)==null?void 0:_n.value)==null?void 0:Vt.toFixed(3))||"N/A"})`),console.log(`      elementPan: ${_!=null&&_.panNode?"EXISTS":"MISSING"} (pan=${((qt=(xt=(pn=_==null?void 0:_.panNode)==null?void 0:pn.pan)==null?void 0:xt.value)==null?void 0:qt.toFixed(3))||"N/A"})`)}}if(console.log(`   masterPanNode: ${this.masterPanNode?"EXISTS":"MISSING"}`),console.log(`   masterGainNode: ${this.masterGainNode?"EXISTS":"MISSING"} (gain=${((Rr=(ni=(ti=this.masterGainNode)==null?void 0:ti.gain)==null?void 0:ni.value)==null?void 0:Rr.toFixed(3))||"N/A"}, muted=${this.masterMuted})`),console.log(`   visualizerAnalyser: ${this.visualizerAnalyser?"EXISTS":"MISSING"}`),console.log(`   destination: ${this._realDestination?"EXISTS":"MISSING"}`),this.masterPanNode&&this.masterGainNode)try{this.masterPanNode.connect(this.masterGainNode),console.log("   ✅ VERIFIED: masterPanNode -> masterGainNode (reconnected)")}catch(L){L.message.includes("already connected")||L.message.includes("already been connected")?console.log("   ✅ VERIFIED: masterPanNode -> masterGainNode (already connected)"):console.warn(`   ⚠️ Could not verify masterPanNode -> masterGainNode: ${L.message}`)}if(this.masterGainNode&&this._realDestination)try{this.masterGainNode.connect(this._realDestination),console.log(`   ✅ VERIFIED: masterGainNode -> destination (reconnected, gain=${this.masterGainNode.gain.value.toFixed(3)})`)}catch(L){L.message.includes("already connected")||L.message.includes("already been connected")?console.log(`   ✅ VERIFIED: masterGainNode -> destination (already connected, gain=${this.masterGainNode.gain.value.toFixed(3)})`):console.warn(`   ⚠️ Could not verify masterGainNode -> destination: ${L.message}`)}console.log("   🔍 FINAL: Searching for Strudel output node...");try{const L=((si=window.strudel)==null?void 0:si.repl)||window.strudel;if(console.log(`   🔍 FINAL: replInstance=${!!L}`),L!=null&&L.scheduler){const D=L.scheduler;console.log(`   🔍 FINAL: scheduler=${!!D}, keys=${Object.keys(D).slice(0,10).join(", ")}`);let _=null,X=null;const te=D.webaudio||D._webaudio;if(te&&(_=te.output||te.outputNode,_&&(X="scheduler.webaudio")),!_&&D.superdough){const q=D.superdough;if(console.log(`   🔍 FINAL: superdough found, keys=${Object.keys(q).slice(0,20).join(", ")}`),_=q.output||q.outputNode||q._output||q.destination||q._destination,_&&(X="scheduler.superdough"),!_&&q.webaudio&&(console.log(`   🔍 FINAL: superdough.webaudio found, keys=${Object.keys(q.webaudio).slice(0,10).join(", ")}`),_=q.webaudio.output||q.webaudio.outputNode||q.webaudio.destination,_&&(X="scheduler.superdough.webaudio")),!_&&q.audioContext&&console.log("   🔍 FINAL: superdough.audioContext found"),!_)for(const me of Object.keys(q)){const Xe=q[me];if(Xe&&typeof Xe=="object"&&(((_r=Xe.constructor)==null?void 0:_r.name)==="GainNode"||((ii=Xe.constructor)==null?void 0:ii.name)==="AudioNode"||Xe instanceof AudioNode)){console.log(`   🔍 FINAL: Found potential output node at superdough.${me} (${Xe.constructor.name})`),_=Xe,X=`scheduler.superdough.${me}`;break}}}if(!_&&D._superdough){const q=D._superdough;_=q.output||q.outputNode||q._output,_&&(X="scheduler._superdough")}if(console.log(`   🔍 FINAL: outputNode=${_?_.constructor.name:"null"}, source=${X||"not found"}`),_&&this.trackedPatterns.size>0){const q=Array.from(this.trackedPatterns.keys())[0],me=this.getElementAudioNodes(q);if(console.log(`   🔍 FINAL: ${q}, elementNodes=${!!me}, gainNode=${!!(me!=null&&me.gainNode)}`),me!=null&&me.gainNode)try{_.disconnect(),_.connect(me.gainNode),console.log(`   ✅ FINAL: Reconnected Strudel output (${X}) -> ${q} gainNode (THIS IS CRITICAL FOR AUDIO)`)}catch(Xe){console.log(`   ✅ FINAL: Strudel output already routed to ${q} gainNode (${Xe.message})`)}else console.error("   ❌ FINAL: Cannot reconnect - elementNodes or gainNode missing!")}else if(console.warn(`   ⚠️ FINAL: Cannot reconnect - outputNode=${!!_}, trackedPatterns.size=${this.trackedPatterns.size}`),!_&&(console.warn("   ⚠️ FINAL: Strudel output node not found in any expected location."),console.warn("   ⚠️ FINAL: This might mean Strudel creates audio nodes dynamically. Audio routing hijacking should catch connections."),console.warn('   ⚠️ FINAL: If you see "DESTINATION CONNECTION" logs, the hijacking is working. If not, Strudel might be using a different routing mechanism.'),console.log("   🔧 FINAL: Ensuring master chain is connected (fallback for dynamic audio nodes)..."),this.masterPanNode&&this.masterGainNode&&this._realDestination))try{this.masterGainNode.connect(this._realDestination),console.log(`   ✅ FINAL: Master chain verified and connected (gain=${this.masterGainNode.gain.value.toFixed(3)})`)}catch(q){console.log(`   ✅ FINAL: Master chain already connected (${q.message})`)}}else console.warn("   ⚠️ FINAL: scheduler not found in replInstance")}catch(L){console.error(`   ❌ FINAL: Error reconnecting Strudel output: ${L.message}`),console.error(`   ❌ FINAL: Stack: ${L.stack}`)}const Br=this.audioContext?this.audioContext.currentTime:performance.now()/1e3;this.masterPlaybackStartTime=Br,this.masterPlaybackTempo=this.currentTempo||120;const fs=this.masterPlaybackTempo/120;this.masterPlaybackSpeed=Number.isFinite(fs)&&fs>0?fs:1,console.log(`✅ Master pattern playing on ${this.masterSlot} (volume/pan/mute via Web Audio API)`),console.log(`🔊 Audio context state: ${((ri=this.audioContext)==null?void 0:ri.state)||"unknown"}`),console.log(`🔊 Master gain value: ${((ns=(Es=this.masterGainNode)==null?void 0:Es.gain)==null?void 0:ns.value)||"unknown"}`),console.log(`🔊 Master muted: ${this.masterMuted||!1}`),console.log("ℹ️ Note: If you see createPeriodicWave errors, they are suppressed but may affect audio playback"),this._audioNodeMonitorInterval&&clearInterval(this._audioNodeMonitorInterval);let gt=0;const Zt=20;return this._audioNodeMonitorInterval=setInterval(()=>{var L;if(gt++,gt>Zt){clearInterval(this._audioNodeMonitorInterval),this._audioNodeMonitorInterval=null,console.log(`🔍 Audio node monitoring stopped after ${Zt} checks`);return}try{const D=(L=window.strudel)==null?void 0:L.scheduler;if(D){const _=["webaudio","_webaudio","superdough","_superdough","output","outputNode"];for(const X of _)if(D[X]&&!D[`_monitored_${X}`]){if(console.log(`🔍 MONITOR: Found ${X} in scheduler at check ${gt}: ${typeof D[X]}`),D[X]instanceof AudioNode&&(console.log(`   → AudioNode: ${D[X].constructor.name}`),this.trackedPatterns.size>0)){const te=Array.from(this.trackedPatterns.keys())[0],q=this.getElementAudioNodes(te);if(q!=null&&q.gainNode)try{D[X].disconnect(),D[X].connect(q.gainNode),console.log(`   ✅ MONITOR: Routed scheduler.${X} to ${te} gainNode`)}catch(me){console.log(`   ✅ MONITOR: scheduler.${X} already routed (${me.message})`)}}D[`_monitored_${X}`]=!0}if(D.superdough&&!D._monitored_superdough){const X=D.superdough;console.log(`🔍 MONITOR: Found superdough at check ${gt}, keys: ${Object.keys(X).slice(0,10).join(", ")}`);const te=["output","outputNode","_output","destination","_destination","gain","masterGain"];for(const q of te)if(X[q]&&X[q]instanceof AudioNode&&(console.log(`   → Found AudioNode at superdough.${q}: ${X[q].constructor.name}`),this.trackedPatterns.size>0)){const me=Array.from(this.trackedPatterns.keys())[0],Xe=this.getElementAudioNodes(me);if(Xe!=null&&Xe.gainNode)try{X[q].disconnect(),X[q].connect(Xe.gainNode),console.log(`   ✅ MONITOR: Routed superdough.${q} to ${me} gainNode`)}catch(an){console.log(`   ✅ MONITOR: superdough.${q} already routed (${an.message})`)}}D._monitored_superdough=!0}}}catch(D){console.warn(`🔍 MONITOR: Error checking scheduler: ${D.message}`)}},100),this.audioContext&&this.audioContext.state==="suspended"&&(console.warn("⚠️ AUDIO CONTEXT SUSPENDED: Audio context is suspended - attempting to resume..."),this.audioContext.resume().then(()=>{console.log("✅ Audio context resumed successfully")}).catch(L=>{console.error(`❌ Failed to resume audio context: ${L.message}`)})),this._audioChainCheckInterval&&clearInterval(this._audioChainCheckInterval),this._zeroGainLogged=!1,this._mutedLogged=!1,this._audioChainCheckInterval=setInterval(()=>{if(this.masterActive&&this.masterGainNode&&this._realDestination){try{this.masterGainNode.connect(this._realDestination)}catch{}this.masterGainNode.gain.value===0&&!this._zeroGainLogged&&(console.warn("⚠️ AUDIO CHAIN CHECK: masterGainNode.gain.value is 0 - no audio will play!"),this._zeroGainLogged=!0),this.masterMuted&&!this._mutedLogged&&(console.warn("⚠️ AUDIO CHAIN CHECK: masterGainNode is muted - no audio will play!"),this._mutedLogged=!0)}else this._audioChainCheckInterval&&(clearInterval(this._audioChainCheckInterval),this._audioChainCheckInterval=null)},1e3),this.onMasterStateChangeCallback&&this.onMasterStateChangeCallback(!0,Array.from(this.trackedPatterns.keys())),{success:!0}}else return console.error("❌ Strudel not properly initialized"),{success:!1,error:"Strudel not initialized"}}catch(Ce){return console.error("❌ Error playing master pattern:",Ce),{success:!1,error:Ce.message}}}async _stopMasterPatternSimple(){var e;try{if(window.strudel&&typeof window.strudel.evaluate=="function"){const t=this.masterSlot||"d0";await window.strudel.evaluate(`${t} = silence`),window.strudel.scheduler&&window.strudel.scheduler.started&&typeof window.strudel.scheduler.stop=="function"&&await window.strudel.scheduler.stop()}return this.masterActive=!1,this.masterPlaybackStartTime=null,this.masterGainNode&&this.masterGainNode.gain.setValueAtTime(0,((e=this.audioContext)==null?void 0:e.currentTime)||0),this.onMasterStateChangeCallback&&this.onMasterStateChangeCallback(!1,[]),{success:!0}}catch(t){return console.error("❌ Error stopping master (simple mode):",t),{success:!1,error:t.message}}}async stopMasterPattern(){var e;if(this.masterOnlyPlayback)return this._stopMasterPatternSimple();try{if(console.log("⏹️ Stopping master pattern..."),window.strudel&&window.strudel.evaluate){window.strudel.repl&&window.strudel.repl.scheduler&&typeof window.strudel.repl.scheduler.stop=="function"&&(window.strudel.repl.scheduler.stop(),console.log("✓ Stopped REPL scheduler"));const t=`${this.masterSlot} = silence`;return await window.strudel.evaluate(t),window.strudel.repl&&window.strudel.repl.scheduler&&typeof window.strudel.repl.scheduler.start=="function"&&(window.strudel.repl.scheduler.start(),console.log("✓ Restarted REPL scheduler")),this.masterPlaybackStartTime=null,this.masterActive=!1,this.masterGainNode&&this.masterGainNode.gain.setValueAtTime(0,((e=this.audioContext)==null?void 0:e.currentTime)||0),this._audioChainCheckInterval&&(clearInterval(this._audioChainCheckInterval),this._audioChainCheckInterval=null),console.log("✅ Master pattern stopped"),this._masterTapLogged=!1,this._masterTapSuccess=new Set,this.onMasterStateChangeCallback&&this.onMasterStateChangeCallback(!1,[]),{success:!0}}else return console.error("❌ Strudel not available"),{success:!1,error:"Strudel not available"}}catch(t){return console.error("❌ Error stopping master pattern:",t),{success:!1,error:t.message}}}getMasterPatternCode(){if(this.masterPattern&&this.masterPattern.trim()!==""){const e="// Controls Selected Tempo:";this.masterPattern.split(`
`).some(n=>n.trim().startsWith(e))||(this.masterPattern=this.formatMasterPatternWithTempoComment(this.masterPattern))}return this._ensureMasterPatternSanitized(),this.masterPattern}isMasterActive(){return!!this.masterActive}getMasterPlaybackInfo(){return{isPlaying:!!this.masterActive,startTime:this.masterPlaybackStartTime,speed:this.masterPlaybackSpeed||1,tempo:this.masterPlaybackTempo||this.currentTempo||120}}async setMasterPatternCode(e){try{if(console.log(`✏️ Setting master pattern code: ${e.substring(0,100)}...`),e&&e.trim()!==""?this.masterPattern=this.formatMasterPatternWithTempoComment(e):this.masterPattern="",this._ensureMasterPatternSanitized(),this.appInstance&&typeof this.appInstance.syncElementsFromMasterPattern=="function")try{this.appInstance.syncElementsFromMasterPattern(this.masterPattern)}catch(t){console.warn("⚠️ Failed to sync elements from master pattern:",t)}if(this.masterActive){console.log("🔄 Master is active - re-evaluating with updated pattern (no stop).");try{await this.playMasterPattern()}catch(t){console.warn("⚠️ Could not re-evaluate master after code update:",t.message)}}return{success:!0}}catch(t){return console.error("❌ Error setting master pattern code:",t),{success:!1,error:t.message}}}async previewPattern(e,t="preview",n=null){var s,r,o;if(this.masterOnlyPlayback)return console.log(`👀 Preview via master stack (${t})`),this.routePatternThroughMaster(t,e,{isPreview:!0,autoStart:!0});try{console.log(`👀 Previewing pattern (received): ${e.substring(0,100)}...`),console.log(`👀 Full pattern to preview: ${e}`);const a="d16";if(this.currentEvaluatingSlot=a,this.patternSlotToElementId.set(a,t),console.log(`🎵 Preview: Mapped slot ${a} to elementId ${t} for audio routing`),window.strudel&&window.strudel.evaluate)try{await window.strudel.evaluate(`${a} = silence`),console.log(`✅ Preview slot ${a} cleared`)}catch(c){console.warn("⚠️ Error clearing preview slot:",c.message)}if((!this.audioContext||this.audioContext.state==="suspended")&&await this.initialize(),this.audioContext&&this.audioContext.state==="suspended"){console.log("🔊 Audio context suspended for preview, resuming...");try{await this.audioContext.resume(),console.log(`✅ Audio context resumed for preview, state: ${this.audioContext.state}`)}catch(c){console.warn("⚠️ Could not resume audio context for preview:",c)}}const l=this.getElementAudioNodes(t);(!l||!l.gainNode)&&console.warn(`⚠️ Could not prepare audio nodes for preview element ${t}`),this.strudelLoaded||(console.log("⏳ Waiting for Strudel to initialize..."),await this.initStrudel()),await this.ensurePatternResourcesLoaded(e),console.log(`🔍 Preview - Original pattern: ${e}`),console.log(`🔍 Preview - Pattern type check: isNotePattern=${this.isNotePattern(e)}, contains s(${e.includes("s(")}, contains sound(${e.includes("sound(")}, contains note(${/\bnote\s*\(/i.test(e)})`);let d=await this.processPattern(e,t,{preserveBanks:!0,attemptBankLoad:!0,applyGainInPattern:!1});if(!d)return console.error("❌ Pattern processing failed for preview"),{success:!1,error:"Pattern processing failed"};if(console.log(`🔍 Preview - After processPattern: ${d}`),console.log(`🔍 Preview - Processed pattern type check: isNotePattern=${this.isNotePattern(d)}, contains s(${d.includes("s(")}, contains sound(${d.includes("sound(")}, contains note(${/\bnote\s*\(/i.test(d)})`),!d.includes(".loop(")&&!d.includes(".loop()")&&(d=`${d}.loop()`,console.log("🔄 Added .loop() to preview pattern for continuous playback")),window.strudel&&window.strudel.evaluate){const c=`${a} = ${d}`;console.log(`🎼 Preview evaluating: ${c.substring(0,300)}...`),console.log(`🔍 Preview - Full pattern code (${c.length} chars): ${c}`);const u=c.match(/\.s\(["']([^"']+)["']\)/),h=c.match(/\.sound\(["']([^"']+)["']\)/),f=h?h[1]:u?u[1]:"unknown";console.log(`🎵 Preview waveform: ${f}`);try{if(await window.strudel.evaluate(c),console.log("✅ Preview pattern evaluated successfully"),window.strudel.scheduler&&(window.strudel.scheduler.started?console.log("🔄 Scheduler already running, ensuring pattern is active..."):(console.log("▶️ Starting Strudel scheduler for preview..."),await window.strudel.scheduler.start())),this.soundsPreloaded)await new Promise(g=>setTimeout(g,50)),setTimeout(()=>{this.currentEvaluatingSlot===a&&(this.currentEvaluatingSlot=null)},500);else{if(window.strudel.scheduler&&window.strudel.scheduler.tick)try{for(let g=0;g<2;g++)window.strudel.scheduler.tick(),await new Promise(O=>setTimeout(O,10))}catch(g){console.warn("⚠️ Could not trigger scheduler tick:",g)}await new Promise(g=>setTimeout(g,200)),setTimeout(()=>{this.currentEvaluatingSlot===a&&(this.currentEvaluatingSlot=null)},1e3)}}catch(g){return console.error("❌ Preview pattern evaluation error:",g.message),console.error(`❌ Failed pattern code: ${c}`),{success:!1,error:g.message}}console.log(`✅ Preview pattern is playing on ${a}`),console.log(`🔊 Audio context state: ${((s=this.audioContext)==null?void 0:s.state)||"unknown"}`),console.log(`🔊 Master gain value: ${((o=(r=this.masterGainNode)==null?void 0:r.gain)==null?void 0:o.value)||"unknown"}`),console.log(`🔊 Master muted: ${this.masterMuted||!1}`);const m=d.includes(".s(")||d.includes(".sound(");return console.log(`🔍 Preview pattern waveform check: ${m?"Has waveform (.s() or .sound())":"No waveform found"}`),{success:!0,previewSlot:a}}else return console.error("❌ Strudel not properly initialized"),{success:!1,error:"Strudel not initialized"}}catch(a){return console.error("❌ Error previewing pattern:",a),{success:!1,error:a.message}}}async stopPreview(){if(this.masterOnlyPlayback){console.log("⏹️ Stopping preview routed through master");for(const e of this.previewElementIds)this.removeElementFromMaster(e);return this.previewElementIds.clear(),this.masterActive&&(!this.masterPattern||!this.masterPattern.trim())?await this.stopMasterPattern():this.masterActive&&await this.playMasterPattern(),{success:!0}}try{return console.log("⏹️ Stopping preview..."),window.strudel&&window.strudel.evaluate?(await window.strudel.evaluate("d16 = silence"),console.log("✅ Preview stopped"),{success:!0}):{success:!1,error:"Strudel not available"}}catch(e){return console.error("❌ Error stopping preview:",e),{success:!1,error:e.message}}}async exportAudioWAV(e=16,t=44100){try{if(console.log(`📦 Exporting master pattern as WAV (${e} seconds)...`),!this.masterPattern||this.masterPattern.trim()==="")return{success:!1,error:"No master pattern to export"};this.strudelLoaded||await this.initStrudel();const s=new OfflineAudioContext(2,t*e,t).destination;return window.strudel&&window.strudel.repl&&window.strudel.repl.audioContext?(console.log("⚠️ Using MediaRecorder fallback for audio export"),await this.exportAudioMediaRecorder(e)):await this.exportAudioMediaRecorder(e)}catch(n){return console.error("❌ Error exporting WAV:",n),{success:!1,error:n.message}}}async exportAudioMediaRecorder(e=16){return new Promise(t=>{try{if(!this.audioContext){t({success:!1,error:"Audio context not initialized"});return}if(!this.masterGainNode||!this.masterPanNode){t({success:!1,error:"Master audio nodes not found"});return}const n=this.audioContext.sampleRate,s=Math.floor(n*e),r=2,o=4096,a=[];let l=!1,d=null;try{d=this.audioContext.createScriptProcessor(o,r,r);let h=0;d.onaudioprocess=f=>{h++;const m=f.inputBuffer,g=f.outputBuffer;for(let M=0;M<r;M++){const b=m.getChannelData(M);g.getChannelData(M).set(b)}const O=Math.max(...Array.from(m.getChannelData(0).map(Math.abs)));if((h<=5||h%50===0)&&console.log(`🔍 ScriptProcessor call #${h}: max amplitude = ${O.toFixed(6)}, isRecording = ${l}`),!l)return;const p=[];for(let M=0;M<r;M++){const b=m.getChannelData(M);p.push(new Float32Array(b))}const y=Math.max(...p[0].map(Math.abs));y>1e-4?(a.length%10===0||a.length<5)&&console.log(`📦 Recording chunk ${a.length}: max amplitude = ${y.toFixed(6)}`):a.length<5&&console.log(`📦 Recording chunk ${a.length}: SILENT (max amplitude = ${y.toFixed(6)})`),a.push(p)},console.log("✅ ScriptProcessorNode created")}catch(h){console.error("❌ Failed to create ScriptProcessorNode:",h),t({success:!1,error:"ScriptProcessorNode not supported: "+h.message});return}const c=this.masterActive;console.log("▶️ Setting up recording..."),console.log("🔍 Pattern code:",this.masterPattern.substring(0,100)),console.log("🔍 Pattern already playing:",c);let u;c?(console.log("▶️ Pattern already playing, ensuring scheduler is running..."),u=Promise.resolve().then(async()=>(window.strudel&&window.strudel.scheduler&&!window.strudel.scheduler.started&&(console.log("▶️ Starting Strudel scheduler..."),await window.strudel.scheduler.start()),{success:!0}))):(console.log("▶️ Pattern not playing, starting it now..."),u=this.playMasterPattern()),u.then(()=>{setTimeout(()=>{console.log("🔧 Setting up recording routing..."),console.log("🔍 Master active:",this.masterActive),console.log("🔍 Audio context state:",this.audioContext.state);try{this.masterGainNode.disconnect(),console.log("✅ Disconnected all connections from masterGainNode")}catch(h){console.warn("⚠️ Could not disconnect all:",h);try{this.masterGainNode.disconnect(this._realDestination),console.log("✅ Disconnected masterGainNode from destination")}catch(f){console.warn("⚠️ Could not disconnect from destination:",f)}}this.masterGainNode.connect(d),d.connect(this._realDestination),console.log("✅ Connected audio routing: masterGainNode -> scriptProcessor -> destination"),console.log("🔍 Verifying connections:"),console.log("  masterGainNode numberOfOutputs:",this.masterGainNode.numberOfOutputs),console.log("  scriptProcessor inputs:",d.numberOfInputs,"outputs:",d.numberOfOutputs),console.log("  Waiting for audio to flow through scriptProcessor..."),setTimeout(()=>{console.log(`🎙️ Recording started for ${e} seconds...`),console.log("🔍 Master active:",this.masterActive),console.log("🔍 Audio context state:",this.audioContext.state),console.log("🔍 ScriptProcessor connected - waiting for audio chunks..."),l=!0,setTimeout(()=>{var x;console.log(`⏹️ Stopping recording after ${e} seconds...`),console.log(`📦 Total chunks captured: ${a.length}`),l=!1;try{try{d.disconnect(this._realDestination)}catch{}try{this.masterGainNode.disconnect(d)}catch{}try{this.masterGainNode.connect(this._realDestination)}catch{try{this.masterGainNode.disconnect(this._realDestination),this.masterGainNode.connect(this._realDestination)}catch(B){console.warn("Could not restore connection:",B)}}console.log("✅ Restored original audio routing: masterGainNode -> destination")}catch(E){console.warn("Error restoring audio routing:",E);try{this.masterGainNode.connect(this._realDestination)}catch(B){console.error("Failed to restore connection:",B)}}if(c?console.log("✅ Pattern was already playing, leaving it running"):this.stopMasterPattern(),a.length===0){console.error("❌ No audio data recorded"),console.error("🔍 Debug info:"),console.error("  Master active:",this.masterActive),console.error("  Audio context state:",this.audioContext.state),console.error("  Master gain node:",!!this.masterGainNode),console.error("  Master pan node:",!!this.masterPanNode),console.error("  Script processor:",!!d),console.error("  Is recording flag:",l),console.error("  Pattern code length:",((x=this.masterPattern)==null?void 0:x.length)||0),t({success:!1,error:"No audio data was recorded. ScriptProcessorNode may not be receiving audio. Check console for debug info."});return}console.log(`📦 Recorded ${a.length} chunks`);const h=a.reduce((E,B)=>E+B[0].length,0);console.log(`📦 Total samples: ${h} (expected: ~${s})`);const f=new Float32Array(h),m=new Float32Array(h);let g=0;for(const E of a){const B=E[0].length;f.set(E[0],g),E[1]?m.set(E[1],g):m.set(E[0],g),g+=B}let O=0,p=0;const y=Math.max(1,Math.floor(h/1e3));for(let E=0;E<h;E+=y){const B=Math.abs(f[E]),F=Math.abs(m[E]),W=Math.max(B,F);O=Math.max(O,W),W>1e-4&&p++}console.log(`🔍 Audio analysis: max amplitude = ${O.toFixed(6)}, non-zero samples = ${p}`);const M=[],b=[];for(let E=0;E<Math.min(10,h);E++)M.push(Math.abs(f[E]));for(let E=Math.max(0,h-10);E<h;E++)b.push(Math.abs(f[E]));console.log(`🔍 First 10 samples: ${M.map(E=>E.toFixed(4)).join(", ")}`),console.log(`🔍 Last 10 samples: ${b.map(E=>E.toFixed(4)).join(", ")}`),O<1e-4&&(console.warn("⚠️ Audio appears to be silent (all zeros or very quiet)"),console.warn("⚠️ Master volume:",this.masterVolume),console.warn("⚠️ Master muted:",this.masterMuted),console.warn("⚠️ This might indicate that audio is not reaching masterPanNode"));const S=this.audioContext.createBuffer(r,h,n);S.getChannelData(0).set(f),S.getChannelData(1).set(m);const k=this.audioBufferToWAV(S);if(console.log(`✅ WAV blob created: ${k.size} bytes`),k.size===0){t({success:!1,error:"WAV blob is empty"});return}this.downloadBlob(k,"master-pattern.wav","audio/wav"),O<1e-4?t({success:!0,format:"wav",warning:"Audio file created but appears to be silent. Check that the pattern is playing and master volume is not muted."}):t({success:!0,format:"wav"})},e*1e3)},200)},500)}).catch(h=>{console.error("❌ Failed to start pattern for recording:",h);try{this.masterGainNode.disconnect(d),d.disconnect(this._realDestination),this.masterGainNode.connect(this._realDestination)}catch{}t({success:!1,error:"Failed to start pattern: "+h.message})})}catch(n){console.error("❌ Error in audio export:",n),t({success:!1,error:n.message})}})}parsePatternToMIDI(e){const t=[];this.currentTempo;const o=16*480;let a=[e];if(e.includes("stack(")){const d=e.match(/stack\s*\(([^)]+)\)/);if(d){const c=d[1];a=this.splitStackPatterns(c)}}const l={bd:36,kick:36,kickdrum:36,sd:38,snare:38,snaredrum:38,hh:42,hihat:42,closedhihat:42,oh:46,openhihat:46,cr:49,crash:49,rd:51,ride:51,ht:48,hightom:48,mt:47,midtom:47,lt:45,lowtom:45,cp:39,clap:39,rim:37,rimshot:37};return a.forEach((d,c)=>{const u=/note\s*\(["']([^"']+)["']\)/g;let h;const f=[];for(;(h=u.exec(d))!==null;){const g=h[1].split(/\s+/).filter(O=>O.trim());f.push(...g)}if(f.length>0){const m=o/f.length;f.forEach((g,O)=>{const p=this.noteToMIDI(g);if(p!==null){const y=Math.round(O*m),M=Math.round(m*.8);t.push({type:"noteOn",tick:y,channel:c%16,note:p,velocity:100}),t.push({type:"noteOff",tick:y+M,channel:c%16,note:p,velocity:0})}})}else{const m=/(?:sound|s)\s*\(["']([^"']+)["']\)/g;let g;for(;(g=m.exec(d))!==null;){const p=g[1].split(/\s+/).filter(M=>M.trim()),y=o/p.length;p.forEach((M,b)=>{const S=l[M.toLowerCase()]||36,k=Math.round(b*y),x=Math.round(y*.3);t.push({type:"noteOn",tick:k,channel:9,note:S,velocity:100}),t.push({type:"noteOff",tick:k+x,channel:9,note:S,velocity:0})})}}}),t.sort((d,c)=>d.tick-c.tick),t}splitStackPatterns(e){const t=[];let n="",s=0;for(let r=0;r<e.length;r++){const o=e[r];o==="("?(s++,n+=o):o===")"?(s--,n+=o):o===","&&s===0?(t.push(n.trim()),n=""):n+=o}return n.trim()&&t.push(n.trim()),t}noteToMIDI(e){const t=e.match(/^([a-gA-G])([#b]?)(\d+)$/);if(!t)return null;const[,n,s,r]=t,a=["c","d","e","f","g","a","b"].indexOf(n.toLowerCase());if(a===-1)return null;let l=12+parseInt(r)*12+a;return s==="#"?l+=1:s==="b"&&(l-=1),Math.max(0,Math.min(127,l))}createMIDIFile(e){const t=this.currentTempo||120,n=new Uint8Array([77,84,104,100,0,0,0,6,0,1,0,1,1,224]),s=[],r=Math.round(6e7/t);s.push({deltaTime:0,type:255,metaType:81,data:[r>>16&255,r>>8&255,r&255]});let o=0;e.forEach(u=>{const h=u.tick-o;o=u.tick,u.type==="noteOn"?s.push({deltaTime:h,type:144|u.channel,data:[u.note,u.velocity]}):u.type==="noteOff"&&s.push({deltaTime:h,type:128|u.channel,data:[u.note,u.velocity]})}),s.push({deltaTime:0,type:255,metaType:47,data:[]});const a=[];s.forEach(u=>{let h=u.deltaTime;const f=[];do{let m=h&127;h>>=7,f.length>0&&(m|=128),f.push(m)}while(h>0);a.push(...f),a.push(u.type),u.metaType!==void 0&&(a.push(u.metaType),a.push(u.data.length)),a.push(...u.data)});const l=a.length,d=new Uint8Array([77,84,114,107,l>>24&255,l>>16&255,l>>8&255,l&255,...a]),c=new Uint8Array(n.length+d.length);return c.set(n,0),c.set(d,n.length),new Blob([c],{type:"audio/midi"})}downloadBlob(e,t,n){const s=URL.createObjectURL(e),r=document.createElement("a");r.href=s,r.download=t,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s)}async blobToAudioBuffer(e){const t=await e.arrayBuffer();return await this.audioContext.decodeAudioData(t)}audioBufferToWAV(e){const t=e.numberOfChannels,n=e.sampleRate,s=1,r=16,o=r/8,a=t*o,l=n*a,d=e.length*a,c=44+d,u=new ArrayBuffer(c),h=new DataView(u),f=(O,p)=>{for(let y=0;y<p.length;y++)h.setUint8(O+y,p.charCodeAt(y))};f(0,"RIFF"),h.setUint32(4,c-8,!0),f(8,"WAVE"),f(12,"fmt "),h.setUint32(16,16,!0),h.setUint16(20,s,!0),h.setUint16(22,t,!0),h.setUint32(24,n,!0),h.setUint32(28,l,!0),h.setUint16(32,a,!0),h.setUint16(34,r,!0),f(36,"data"),h.setUint32(40,d,!0);let m=44;const g=[];for(let O=0;O<t;O++)g.push(e.getChannelData(O));for(let O=0;O<e.length;O++)for(let p=0;p<t;p++){const y=Math.max(-1,Math.min(1,g[p][O]));h.setInt16(m,y<0?y*32768:y*32767,!0),m+=2}return new Blob([u],{type:"audio/wav"})}async exportAudioWAVOffline(e=16,t=44100){try{return console.log("📦 Exporting master pattern as WAV using OfflineAudioContext..."),!this.masterPattern||this.masterPattern.trim()===""?{success:!1,error:"No master pattern to export"}:(this.strudelLoaded||await this.initStrudel(),await this.exportAudioMediaRecorder(e))}catch(n){return console.error("❌ Error exporting WAV offline:",n),{success:!1,error:n.message}}}}const C=new hv;typeof window<"u"&&(window.soundManager=C);class fv{constructor(){this.updateCallbacks=new Map,this.soundTrigger=null,this.controlSoundTimers=new Map,this.activeSliders=new Set,this.tempoSliderActivated=!1,this.tapTimes=[],this.tapTimeout=null,this.tapTimeoutDelay=2e3,this.initializeControls()}setSoundTrigger(e){this.soundTrigger=e}triggerControlSound(e){if(!this.soundTrigger)return;const t=this.controlSoundTimers.get(e);t&&clearTimeout(t);const n=setTimeout(()=>{this.controlSoundTimers.delete(e);const s=et.getControlConfig(e);if(s&&s.type){const r=`control-${e}`;this.soundTrigger(r,s)}},100);this.controlSoundTimers.set(e,n)}initializeControls(){const e=document.getElementById("tempo-slider"),t=document.getElementById("tempo-value");if(e&&t){e.classList.add("inactive"),t.classList.add("inactive");const o=()=>this.markTempoSliderActive(e,t);e.addEventListener&&(e.addEventListener("pointerdown",o,{once:!0}),e.addEventListener("focus",o,{once:!0})),e.addEventListener("input",a=>{o();const l=parseInt(a.target.value);t.textContent=l,this.notify("tempo",l)})}const n=document.getElementById("tap-tempo-btn");n&&n.addEventListener("click",()=>{this.handleTapTempo(e,t,n)});const s=document.getElementById("key-select");s&&s.addEventListener("change",o=>{const a=o.target.value;a!==""&&this.notify("key",a)});const r=document.getElementById("scale-select");r&&r.addEventListener("change",o=>{const a=o.target.value;if(a===""){this.notify("scale","chromatic");return}this.notify("scale",a)})}markTempoSliderActive(e,t){this.tempoSliderActivated||(this.tempoSliderActivated=!0,e&&e.classList.remove("inactive"),t&&t.classList.remove("inactive"))}handleTapTempo(e,t,n){this.markTempoSliderActive(e,t);const s=Date.now();if(this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),this.tapTimes.push(s),this.tapTimes.length>=3){const r=[];for(let l=1;l<this.tapTimes.length;l++)r.push(this.tapTimes[l]-this.tapTimes[l-1]);const o=r.reduce((l,d)=>l+d,0)/r.length;let a=Math.round(6e4/o);a=Math.max(60,Math.min(240,a)),e&&(e.value=a),t&&(t.textContent=a),this.notify("tempo",a),this.tapTimes.length>4&&(this.tapTimes=this.tapTimes.slice(-4))}else{const r=3-this.tapTimes.length;if(n){const o=n.textContent;n.textContent=`${r} more`,setTimeout(()=>{n.textContent=o},500)}}this.tapTimeout=setTimeout(()=>{this.tapTimes=[],this.tapTimeout=null,n&&(n.textContent="TAP")},this.tapTimeoutDelay)}onUpdate(e,t){this.updateCallbacks.has(e)||this.updateCallbacks.set(e,[]),this.updateCallbacks.get(e).push(t)}notify(e,t){const n=this.updateCallbacks.get(e);n&&n.forEach(s=>s(t))}updateStatus(e){const t=document.getElementById("status-text");t&&(t.textContent=e)}updateActiveElements(e){const t=document.getElementById("active-elements");t&&(e.length===0?t.textContent="None":t.textContent=e.join(", "))}setElementState(e,t){const n=e.querySelector(".element-indicator");n&&(n.className="element-indicator",t==="hover"?n.classList.add("hover"):t==="proximity"&&n.classList.add("proximity")),e.className="sound-element",t==="hover"?e.classList.add("is-hovered"):t==="proximity"&&e.classList.add("is-proximity")}}const ot=new fv;let Zl=[],Dm=[];(()=>{let i="lc,34,7n,7,7b,19,,,,2,,2,,,20,b,1c,l,g,,2t,7,2,6,2,2,,4,z,,u,r,2j,b,1m,9,9,,o,4,,9,,3,,5,17,3,3b,f,,w,1j,,,,4,8,4,,3,7,a,2,t,,1m,,,,2,4,8,,9,,a,2,q,,2,2,1l,,4,2,4,2,2,3,3,,u,2,3,,b,2,1l,,4,5,,2,4,,k,2,m,6,,,1m,,,2,,4,8,,7,3,a,2,u,,1n,,,,c,,9,,14,,3,,1l,3,5,3,,4,7,2,b,2,t,,1m,,2,,2,,3,,5,2,7,2,b,2,s,2,1l,2,,,2,4,8,,9,,a,2,t,,20,,4,,2,3,,,8,,29,,2,7,c,8,2q,,2,9,b,6,22,2,r,,,,,,1j,e,,5,,2,5,b,,10,9,,2u,4,,6,,2,2,2,p,2,4,3,g,4,d,,2,2,6,,f,,jj,3,qa,3,t,3,t,2,u,2,1s,2,,7,8,,2,b,9,,19,3,3b,2,y,,3a,3,4,2,9,,6,3,63,2,2,,1m,,,7,,,,,2,8,6,a,2,,1c,h,1r,4,1c,7,,,5,,14,9,c,2,w,4,2,2,,3,1k,,,2,3,,,3,1m,8,2,2,48,3,,d,,7,4,,6,,3,2,5i,1m,,5,ek,,5f,x,2da,3,3x,,2o,w,fe,6,2x,2,n9w,4,,a,w,2,28,2,7k,,3,,4,,p,2,5,,47,2,q,i,d,,12,8,p,b,1a,3,1c,,2,4,2,2,13,,1v,6,2,2,2,2,c,,8,,1b,,1f,,,3,2,2,5,2,,,16,2,8,,6m,,2,,4,,fn4,,kh,g,g,g,a6,2,gt,,6a,,45,5,1ae,3,,2,5,4,14,3,4,,4l,2,fx,4,ar,2,49,b,4w,,1i,f,1k,3,1d,4,2,2,1x,3,10,5,,8,1q,,c,2,1g,9,a,4,2,,2n,3,2,,,2,6,,4g,,3,8,l,2,1l,2,,,,,m,,e,7,3,5,5f,8,2,3,,,n,,29,,2,6,,,2,,,2,,2,6j,,2,4,6,2,,2,r,2,2d,8,2,,,2,2y,,,,2,6,,,2t,3,2,4,,5,77,9,,2,6t,,a,2,,,4,,40,4,2,2,4,,w,a,14,6,2,4,8,,9,6,2,3,1a,d,,2,ba,7,,6,,,2a,m,2,7,,2,,2,3e,6,3,,,2,,7,,,20,2,3,,,,9n,2,f0b,5,1n,7,t4,,1r,4,29,,f5k,2,43q,,,3,4,5,8,8,2,7,u,4,44,3,1iz,1j,4,1e,8,,e,,m,5,,f,11s,7,,h,2,7,,2,,5,79,7,c5,4,15s,7,31,7,240,5,gx7k,2o,3k,6o".split(",").map(e=>e?parseInt(e,36):1);for(let e=0,t=0;e<i.length;e++)(e%2?Dm:Zl).push(t=t+i[e])})();function mv(i){if(i<768)return!1;for(let e=0,t=Zl.length;;){let n=e+t>>1;if(i<Zl[n])t=n;else if(i>=Dm[n])e=n+1;else return!0;if(e==t)return!1}}function bu(i){return i>=127462&&i<=127487}const vu=8205;function pv(i,e,t=!0,n=!0){return(t?zm:gv)(i,e,n)}function zm(i,e,t){if(e==i.length)return e;e&&Vm(i.charCodeAt(e))&&Zm(i.charCodeAt(e-1))&&e--;let n=Ia(i,e);for(e+=wu(n);e<i.length;){let s=Ia(i,e);if(n==vu||s==vu||t&&mv(s))e+=wu(s),n=s;else if(bu(s)){let r=0,o=e-2;for(;o>=0&&bu(Ia(i,o));)r++,o-=2;if(r%2==0)break;e+=2}else break}return e}function gv(i,e,t){for(;e>0;){let n=zm(i,e-2,t);if(n<e)return n;e--}return 0}function Ia(i,e){let t=i.charCodeAt(e);if(!Zm(t)||e+1==i.length)return t;let n=i.charCodeAt(e+1);return Vm(n)?(t-55296<<10)+(n-56320)+65536:t}function Vm(i){return i>=56320&&i<57344}function Zm(i){return i>=55296&&i<56320}function wu(i){return i<65536?1:2}class Qe{lineAt(e){if(e<0||e>this.length)throw new RangeError(`Invalid position ${e} in document of length ${this.length}`);return this.lineInner(e,!1,1,0)}line(e){if(e<1||e>this.lines)throw new RangeError(`Invalid line number ${e} in ${this.lines}-line document`);return this.lineInner(e,!0,1,0)}replace(e,t,n){[e,t]=Pi(this,e,t);let s=[];return this.decompose(0,e,s,2),n.length&&n.decompose(0,n.length,s,3),this.decompose(t,this.length,s,1),jn.from(s,this.length-(t-e)+n.length)}append(e){return this.replace(this.length,this.length,e)}slice(e,t=this.length){[e,t]=Pi(this,e,t);let n=[];return this.decompose(e,t,n,0),jn.from(n,t-e)}eq(e){if(e==this)return!0;if(e.length!=this.length||e.lines!=this.lines)return!1;let t=this.scanIdentical(e,1),n=this.length-this.scanIdentical(e,-1),s=new rr(this),r=new rr(e);for(let o=t,a=t;;){if(s.next(o),r.next(o),o=0,s.lineBreak!=r.lineBreak||s.done!=r.done||s.value!=r.value)return!1;if(a+=s.value.length,s.done||a>=n)return!0}}iter(e=1){return new rr(this,e)}iterRange(e,t=this.length){return new jm(this,e,t)}iterLines(e,t){let n;if(e==null)n=this.iter();else{t==null&&(t=this.lines+1);let s=this.line(e).from;n=this.iterRange(s,Math.max(s,t==this.lines+1?this.length:t<=1?0:this.line(t-1).to))}return new Fm(n)}toString(){return this.sliceString(0)}toJSON(){let e=[];return this.flatten(e),e}constructor(){}static of(e){if(e.length==0)throw new RangeError("A document must have at least one line");return e.length==1&&!e[0]?Qe.empty:e.length<=32?new dt(e):jn.from(dt.split(e,[]))}}class dt extends Qe{constructor(e,t=Ov(e)){super(),this.text=e,this.length=t}get lines(){return this.text.length}get children(){return null}lineInner(e,t,n,s){for(let r=0;;r++){let o=this.text[r],a=s+o.length;if((t?n:a)>=e)return new yv(s,a,n,o);s=a+1,n++}}decompose(e,t,n,s){let r=e<=0&&t>=this.length?this:new dt(Pu(this.text,e,t),Math.min(t,this.length)-Math.max(0,e));if(s&1){let o=n.pop(),a=Oo(r.text,o.text.slice(),0,r.length);if(a.length<=32)n.push(new dt(a,o.length+r.length));else{let l=a.length>>1;n.push(new dt(a.slice(0,l)),new dt(a.slice(l)))}}else n.push(r)}replace(e,t,n){if(!(n instanceof dt))return super.replace(e,t,n);[e,t]=Pi(this,e,t);let s=Oo(this.text,Oo(n.text,Pu(this.text,0,e)),t),r=this.length+n.length-(t-e);return s.length<=32?new dt(s,r):jn.from(dt.split(s,[]),r)}sliceString(e,t=this.length,n=`
`){[e,t]=Pi(this,e,t);let s="";for(let r=0,o=0;r<=t&&o<this.text.length;o++){let a=this.text[o],l=r+a.length;r>e&&o&&(s+=n),e<l&&t>r&&(s+=a.slice(Math.max(0,e-r),t-r)),r=l+1}return s}flatten(e){for(let t of this.text)e.push(t)}scanIdentical(){return 0}static split(e,t){let n=[],s=-1;for(let r of e)n.push(r),s+=r.length+1,n.length==32&&(t.push(new dt(n,s)),n=[],s=-1);return s>-1&&t.push(new dt(n,s)),t}}class jn extends Qe{constructor(e,t){super(),this.children=e,this.length=t,this.lines=0;for(let n of e)this.lines+=n.lines}lineInner(e,t,n,s){for(let r=0;;r++){let o=this.children[r],a=s+o.length,l=n+o.lines-1;if((t?l:a)>=e)return o.lineInner(e,t,n,s);s=a+1,n=l+1}}decompose(e,t,n,s){for(let r=0,o=0;o<=t&&r<this.children.length;r++){let a=this.children[r],l=o+a.length;if(e<=l&&t>=o){let d=s&((o<=e?1:0)|(l>=t?2:0));o>=e&&l<=t&&!d?n.push(a):a.decompose(e-o,t-o,n,d)}o=l+1}}replace(e,t,n){if([e,t]=Pi(this,e,t),n.lines<this.lines)for(let s=0,r=0;s<this.children.length;s++){let o=this.children[s],a=r+o.length;if(e>=r&&t<=a){let l=o.replace(e-r,t-r,n),d=this.lines-o.lines+l.lines;if(l.lines<d>>4&&l.lines>d>>6){let c=this.children.slice();return c[s]=l,new jn(c,this.length-(t-e)+n.length)}return super.replace(r,a,l)}r=a+1}return super.replace(e,t,n)}sliceString(e,t=this.length,n=`
`){[e,t]=Pi(this,e,t);let s="";for(let r=0,o=0;r<this.children.length&&o<=t;r++){let a=this.children[r],l=o+a.length;o>e&&r&&(s+=n),e<l&&t>o&&(s+=a.sliceString(e-o,t-o,n)),o=l+1}return s}flatten(e){for(let t of this.children)t.flatten(e)}scanIdentical(e,t){if(!(e instanceof jn))return 0;let n=0,[s,r,o,a]=t>0?[0,0,this.children.length,e.children.length]:[this.children.length-1,e.children.length-1,-1,-1];for(;;s+=t,r+=t){if(s==o||r==a)return n;let l=this.children[s],d=e.children[r];if(l!=d)return n+l.scanIdentical(d,t);n+=l.length+1}}static from(e,t=e.reduce((n,s)=>n+s.length+1,-1)){let n=0;for(let f of e)n+=f.lines;if(n<32){let f=[];for(let m of e)m.flatten(f);return new dt(f,t)}let s=Math.max(32,n>>5),r=s<<1,o=s>>1,a=[],l=0,d=-1,c=[];function u(f){let m;if(f.lines>r&&f instanceof jn)for(let g of f.children)u(g);else f.lines>o&&(l>o||!l)?(h(),a.push(f)):f instanceof dt&&l&&(m=c[c.length-1])instanceof dt&&f.lines+m.lines<=32?(l+=f.lines,d+=f.length+1,c[c.length-1]=new dt(m.text.concat(f.text),m.length+1+f.length)):(l+f.lines>s&&h(),l+=f.lines,d+=f.length+1,c.push(f))}function h(){l!=0&&(a.push(c.length==1?c[0]:jn.from(c,d)),d=-1,l=c.length=0)}for(let f of e)u(f);return h(),a.length==1?a[0]:new jn(a,t)}}Qe.empty=new dt([""],0);function Ov(i){let e=-1;for(let t of i)e+=t.length+1;return e}function Oo(i,e,t=0,n=1e9){for(let s=0,r=0,o=!0;r<i.length&&s<=n;r++){let a=i[r],l=s+a.length;l>=t&&(l>n&&(a=a.slice(0,n-s)),s<t&&(a=a.slice(t-s)),o?(e[e.length-1]+=a,o=!1):e.push(a)),s=l+1}return e}function Pu(i,e,t){return Oo(i,[""],e,t)}class rr{constructor(e,t=1){this.dir=t,this.done=!1,this.lineBreak=!1,this.value="",this.nodes=[e],this.offsets=[t>0?1:(e instanceof dt?e.text.length:e.children.length)<<1]}nextInner(e,t){for(this.done=this.lineBreak=!1;;){let n=this.nodes.length-1,s=this.nodes[n],r=this.offsets[n],o=r>>1,a=s instanceof dt?s.text.length:s.children.length;if(o==(t>0?a:0)){if(n==0)return this.done=!0,this.value="",this;t>0&&this.offsets[n-1]++,this.nodes.pop(),this.offsets.pop()}else if((r&1)==(t>0?0:1)){if(this.offsets[n]+=t,e==0)return this.lineBreak=!0,this.value=`
`,this;e--}else if(s instanceof dt){let l=s.text[o+(t<0?-1:0)];if(this.offsets[n]+=t,l.length>Math.max(0,e))return this.value=e==0?l:t>0?l.slice(e):l.slice(0,l.length-e),this;e-=l.length}else{let l=s.children[o+(t<0?-1:0)];e>l.length?(e-=l.length,this.offsets[n]+=t):(t<0&&this.offsets[n]--,this.nodes.push(l),this.offsets.push(t>0?1:(l instanceof dt?l.text.length:l.children.length)<<1))}}}next(e=0){return e<0&&(this.nextInner(-e,-this.dir),e=this.value.length),this.nextInner(e,this.dir)}}class jm{constructor(e,t,n){this.value="",this.done=!1,this.cursor=new rr(e,t>n?-1:1),this.pos=t>n?e.length:0,this.from=Math.min(t,n),this.to=Math.max(t,n)}nextInner(e,t){if(t<0?this.pos<=this.from:this.pos>=this.to)return this.value="",this.done=!0,this;e+=Math.max(0,t<0?this.pos-this.to:this.from-this.pos);let n=t<0?this.pos-this.from:this.to-this.pos;e>n&&(e=n),n-=e;let{value:s}=this.cursor.next(e);return this.pos+=(s.length+e)*t,this.value=s.length<=n?s:t<0?s.slice(s.length-n):s.slice(0,n),this.done=!this.value,this}next(e=0){return e<0?e=Math.max(e,this.from-this.pos):e>0&&(e=Math.min(e,this.to-this.pos)),this.nextInner(e,this.cursor.dir)}get lineBreak(){return this.cursor.lineBreak&&this.value!=""}}class Fm{constructor(e){this.inner=e,this.afterBreak=!0,this.value="",this.done=!1}next(e=0){let{done:t,lineBreak:n,value:s}=this.inner.next(e);return t&&this.afterBreak?(this.value="",this.afterBreak=!1):t?(this.done=!0,this.value=""):n?this.afterBreak?this.value="":(this.afterBreak=!0,this.next()):(this.value=s,this.afterBreak=!1),this}get lineBreak(){return!1}}typeof Symbol<"u"&&(Qe.prototype[Symbol.iterator]=function(){return this.iter()},rr.prototype[Symbol.iterator]=jm.prototype[Symbol.iterator]=Fm.prototype[Symbol.iterator]=function(){return this});class yv{constructor(e,t,n,s){this.from=e,this.to=t,this.number=n,this.text=s}get length(){return this.to-this.from}}function Pi(i,e,t){return e=Math.max(0,Math.min(i.length,e)),[e,Math.max(e,Math.min(i.length,t))]}function Xt(i,e,t=!0,n=!0){return pv(i,e,t,n)}function bv(i){return i>=56320&&i<57344}function vv(i){return i>=55296&&i<56320}function ei(i,e){let t=i.charCodeAt(e);if(!vv(t)||e+1==i.length)return t;let n=i.charCodeAt(e+1);return bv(n)?(t-55296<<10)+(n-56320)+65536:t}function Gm(i){return i<=65535?String.fromCharCode(i):(i-=65536,String.fromCharCode((i>>10)+55296,(i&1023)+56320))}function xr(i){return i<65536?1:2}const jl=/\r\n?|\n/;var Lt=(function(i){return i[i.Simple=0]="Simple",i[i.TrackDel=1]="TrackDel",i[i.TrackBefore=2]="TrackBefore",i[i.TrackAfter=3]="TrackAfter",i})(Lt||(Lt={}));class Hn{constructor(e){this.sections=e}get length(){let e=0;for(let t=0;t<this.sections.length;t+=2)e+=this.sections[t];return e}get newLength(){let e=0;for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t+1];e+=n<0?this.sections[t]:n}return e}get empty(){return this.sections.length==0||this.sections.length==2&&this.sections[1]<0}iterGaps(e){for(let t=0,n=0,s=0;t<this.sections.length;){let r=this.sections[t++],o=this.sections[t++];o<0?(e(n,s,r),s+=r):s+=o,n+=r}}iterChangedRanges(e,t=!1){Fl(this,e,t)}get invertedDesc(){let e=[];for(let t=0;t<this.sections.length;){let n=this.sections[t++],s=this.sections[t++];s<0?e.push(n,s):e.push(s,n)}return new Hn(e)}composeDesc(e){return this.empty?e:e.empty?this:Xm(this,e)}mapDesc(e,t=!1){return e.empty?this:Gl(this,e,t)}mapPos(e,t=-1,n=Lt.Simple){let s=0,r=0;for(let o=0;o<this.sections.length;){let a=this.sections[o++],l=this.sections[o++],d=s+a;if(l<0){if(d>e)return r+(e-s);r+=a}else{if(n!=Lt.Simple&&d>=e&&(n==Lt.TrackDel&&s<e&&d>e||n==Lt.TrackBefore&&s<e||n==Lt.TrackAfter&&d>e))return null;if(d>e||d==e&&t<0&&!a)return e==s||t<0?r:r+l;r+=l}s=d}if(e>s)throw new RangeError(`Position ${e} is out of range for changeset of length ${s}`);return r}touchesRange(e,t=e){for(let n=0,s=0;n<this.sections.length&&s<=t;){let r=this.sections[n++],o=this.sections[n++],a=s+r;if(o>=0&&s<=t&&a>=e)return s<e&&a>t?"cover":!0;s=a}return!1}toString(){let e="";for(let t=0;t<this.sections.length;){let n=this.sections[t++],s=this.sections[t++];e+=(e?" ":"")+n+(s>=0?":"+s:"")}return e}toJSON(){return this.sections}static fromJSON(e){if(!Array.isArray(e)||e.length%2||e.some(t=>typeof t!="number"))throw new RangeError("Invalid JSON representation of ChangeDesc");return new Hn(e)}static create(e){return new Hn(e)}}class Ot extends Hn{constructor(e,t){super(e),this.inserted=t}apply(e){if(this.length!=e.length)throw new RangeError("Applying change set to a document with the wrong length");return Fl(this,(t,n,s,r,o)=>e=e.replace(s,s+(n-t),o),!1),e}mapDesc(e,t=!1){return Gl(this,e,t,!0)}invert(e){let t=this.sections.slice(),n=[];for(let s=0,r=0;s<t.length;s+=2){let o=t[s],a=t[s+1];if(a>=0){t[s]=a,t[s+1]=o;let l=s>>1;for(;n.length<l;)n.push(Qe.empty);n.push(o?e.slice(r,r+o):Qe.empty)}r+=o}return new Ot(t,n)}compose(e){return this.empty?e:e.empty?this:Xm(this,e,!0)}map(e,t=!1){return e.empty?this:Gl(this,e,t,!0)}iterChanges(e,t=!1){Fl(this,e,t)}get desc(){return Hn.create(this.sections)}filter(e){let t=[],n=[],s=[],r=new mr(this);e:for(let o=0,a=0;;){let l=o==e.length?1e9:e[o++];for(;a<l||a==l&&r.len==0;){if(r.done)break e;let c=Math.min(r.len,l-a);It(s,c,-1);let u=r.ins==-1?-1:r.off==0?r.ins:0;It(t,c,u),u>0&&bs(n,t,r.text),r.forward(c),a+=c}let d=e[o++];for(;a<d;){if(r.done)break e;let c=Math.min(r.len,d-a);It(t,c,-1),It(s,c,r.ins==-1?-1:r.off==0?r.ins:0),r.forward(c),a+=c}}return{changes:new Ot(t,n),filtered:Hn.create(s)}}toJSON(){let e=[];for(let t=0;t<this.sections.length;t+=2){let n=this.sections[t],s=this.sections[t+1];s<0?e.push(n):s==0?e.push([n]):e.push([n].concat(this.inserted[t>>1].toJSON()))}return e}static of(e,t,n){let s=[],r=[],o=0,a=null;function l(c=!1){if(!c&&!s.length)return;o<t&&It(s,t-o,-1);let u=new Ot(s,r);a=a?a.compose(u.map(a)):u,s=[],r=[],o=0}function d(c){if(Array.isArray(c))for(let u of c)d(u);else if(c instanceof Ot){if(c.length!=t)throw new RangeError(`Mismatched change set length (got ${c.length}, expected ${t})`);l(),a=a?a.compose(c.map(a)):c}else{let{from:u,to:h=u,insert:f}=c;if(u>h||u<0||h>t)throw new RangeError(`Invalid change range ${u} to ${h} (in doc of length ${t})`);let m=f?typeof f=="string"?Qe.of(f.split(n||jl)):f:Qe.empty,g=m.length;if(u==h&&g==0)return;u<o&&l(),u>o&&It(s,u-o,-1),It(s,h-u,g),bs(r,s,m),o=h}}return d(e),l(!a),a}static empty(e){return new Ot(e?[e,-1]:[],[])}static fromJSON(e){if(!Array.isArray(e))throw new RangeError("Invalid JSON representation of ChangeSet");let t=[],n=[];for(let s=0;s<e.length;s++){let r=e[s];if(typeof r=="number")t.push(r,-1);else{if(!Array.isArray(r)||typeof r[0]!="number"||r.some((o,a)=>a&&typeof o!="string"))throw new RangeError("Invalid JSON representation of ChangeSet");if(r.length==1)t.push(r[0],0);else{for(;n.length<s;)n.push(Qe.empty);n[s]=Qe.of(r.slice(1)),t.push(r[0],n[s].length)}}}return new Ot(t,n)}static createSet(e,t){return new Ot(e,t)}}function It(i,e,t,n=!1){if(e==0&&t<=0)return;let s=i.length-2;s>=0&&t<=0&&t==i[s+1]?i[s]+=e:s>=0&&e==0&&i[s]==0?i[s+1]+=t:n?(i[s]+=e,i[s+1]+=t):i.push(e,t)}function bs(i,e,t){if(t.length==0)return;let n=e.length-2>>1;if(n<i.length)i[i.length-1]=i[i.length-1].append(t);else{for(;i.length<n;)i.push(Qe.empty);i.push(t)}}function Fl(i,e,t){let n=i.inserted;for(let s=0,r=0,o=0;o<i.sections.length;){let a=i.sections[o++],l=i.sections[o++];if(l<0)s+=a,r+=a;else{let d=s,c=r,u=Qe.empty;for(;d+=a,c+=l,l&&n&&(u=u.append(n[o-2>>1])),!(t||o==i.sections.length||i.sections[o+1]<0);)a=i.sections[o++],l=i.sections[o++];e(s,d,r,c,u),s=d,r=c}}}function Gl(i,e,t,n=!1){let s=[],r=n?[]:null,o=new mr(i),a=new mr(e);for(let l=-1;;){if(o.done&&a.len||a.done&&o.len)throw new Error("Mismatched change set lengths");if(o.ins==-1&&a.ins==-1){let d=Math.min(o.len,a.len);It(s,d,-1),o.forward(d),a.forward(d)}else if(a.ins>=0&&(o.ins<0||l==o.i||o.off==0&&(a.len<o.len||a.len==o.len&&!t))){let d=a.len;for(It(s,a.ins,-1);d;){let c=Math.min(o.len,d);o.ins>=0&&l<o.i&&o.len<=c&&(It(s,0,o.ins),r&&bs(r,s,o.text),l=o.i),o.forward(c),d-=c}a.next()}else if(o.ins>=0){let d=0,c=o.len;for(;c;)if(a.ins==-1){let u=Math.min(c,a.len);d+=u,c-=u,a.forward(u)}else if(a.ins==0&&a.len<c)c-=a.len,a.next();else break;It(s,d,l<o.i?o.ins:0),r&&l<o.i&&bs(r,s,o.text),l=o.i,o.forward(o.len-c)}else{if(o.done&&a.done)return r?Ot.createSet(s,r):Hn.create(s);throw new Error("Mismatched change set lengths")}}}function Xm(i,e,t=!1){let n=[],s=t?[]:null,r=new mr(i),o=new mr(e);for(let a=!1;;){if(r.done&&o.done)return s?Ot.createSet(n,s):Hn.create(n);if(r.ins==0)It(n,r.len,0,a),r.next();else if(o.len==0&&!o.done)It(n,0,o.ins,a),s&&bs(s,n,o.text),o.next();else{if(r.done||o.done)throw new Error("Mismatched change set lengths");{let l=Math.min(r.len2,o.len),d=n.length;if(r.ins==-1){let c=o.ins==-1?-1:o.off?0:o.ins;It(n,l,c,a),s&&c&&bs(s,n,o.text)}else o.ins==-1?(It(n,r.off?0:r.len,l,a),s&&bs(s,n,r.textBit(l))):(It(n,r.off?0:r.len,o.off?0:o.ins,a),s&&!o.off&&bs(s,n,o.text));a=(r.ins>l||o.ins>=0&&o.len>l)&&(a||n.length>d),r.forward2(l),o.forward(l)}}}}class mr{constructor(e){this.set=e,this.i=0,this.next()}next(){let{sections:e}=this.set;this.i<e.length?(this.len=e[this.i++],this.ins=e[this.i++]):(this.len=0,this.ins=-2),this.off=0}get done(){return this.ins==-2}get len2(){return this.ins<0?this.len:this.ins}get text(){let{inserted:e}=this.set,t=this.i-2>>1;return t>=e.length?Qe.empty:e[t]}textBit(e){let{inserted:t}=this.set,n=this.i-2>>1;return n>=t.length&&!e?Qe.empty:t[n].slice(this.off,e==null?void 0:this.off+e)}forward(e){e==this.len?this.next():(this.len-=e,this.off+=e)}forward2(e){this.ins==-1?this.forward(e):e==this.ins?this.next():(this.ins-=e,this.off+=e)}}class Bs{constructor(e,t,n){this.from=e,this.to=t,this.flags=n}get anchor(){return this.flags&32?this.to:this.from}get head(){return this.flags&32?this.from:this.to}get empty(){return this.from==this.to}get assoc(){return this.flags&8?-1:this.flags&16?1:0}get bidiLevel(){let e=this.flags&7;return e==7?null:e}get goalColumn(){let e=this.flags>>6;return e==16777215?void 0:e}map(e,t=-1){let n,s;return this.empty?n=s=e.mapPos(this.from,t):(n=e.mapPos(this.from,1),s=e.mapPos(this.to,-1)),n==this.from&&s==this.to?this:new Bs(n,s,this.flags)}extend(e,t=e){if(e<=this.anchor&&t>=this.anchor)return j.range(e,t);let n=Math.abs(e-this.anchor)>Math.abs(t-this.anchor)?e:t;return j.range(this.anchor,n)}eq(e,t=!1){return this.anchor==e.anchor&&this.head==e.head&&(!t||!this.empty||this.assoc==e.assoc)}toJSON(){return{anchor:this.anchor,head:this.head}}static fromJSON(e){if(!e||typeof e.anchor!="number"||typeof e.head!="number")throw new RangeError("Invalid JSON representation for SelectionRange");return j.range(e.anchor,e.head)}static create(e,t,n){return new Bs(e,t,n)}}class j{constructor(e,t){this.ranges=e,this.mainIndex=t}map(e,t=-1){return e.empty?this:j.create(this.ranges.map(n=>n.map(e,t)),this.mainIndex)}eq(e,t=!1){if(this.ranges.length!=e.ranges.length||this.mainIndex!=e.mainIndex)return!1;for(let n=0;n<this.ranges.length;n++)if(!this.ranges[n].eq(e.ranges[n],t))return!1;return!0}get main(){return this.ranges[this.mainIndex]}asSingle(){return this.ranges.length==1?this:new j([this.main],0)}addRange(e,t=!0){return j.create([e].concat(this.ranges),t?0:this.mainIndex+1)}replaceRange(e,t=this.mainIndex){let n=this.ranges.slice();return n[t]=e,j.create(n,this.mainIndex)}toJSON(){return{ranges:this.ranges.map(e=>e.toJSON()),main:this.mainIndex}}static fromJSON(e){if(!e||!Array.isArray(e.ranges)||typeof e.main!="number"||e.main>=e.ranges.length)throw new RangeError("Invalid JSON representation for EditorSelection");return new j(e.ranges.map(t=>Bs.fromJSON(t)),e.main)}static single(e,t=e){return new j([j.range(e,t)],0)}static create(e,t=0){if(e.length==0)throw new RangeError("A selection needs at least one range");for(let n=0,s=0;s<e.length;s++){let r=e[s];if(r.empty?r.from<=n:r.from<n)return j.normalized(e.slice(),t);n=r.to}return new j(e,t)}static cursor(e,t=0,n,s){return Bs.create(e,e,(t==0?0:t<0?8:16)|(n==null?7:Math.min(6,n))|(s??16777215)<<6)}static range(e,t,n,s){let r=(n??16777215)<<6|(s==null?7:Math.min(6,s));return t<e?Bs.create(t,e,48|r):Bs.create(e,t,(t>e?8:0)|r)}static normalized(e,t=0){let n=e[t];e.sort((s,r)=>s.from-r.from),t=e.indexOf(n);for(let s=1;s<e.length;s++){let r=e[s],o=e[s-1];if(r.empty?r.from<=o.to:r.from<o.to){let a=o.from,l=Math.max(r.to,o.to);s<=t&&t--,e.splice(--s,2,r.anchor>r.head?j.range(l,a):j.range(a,l))}}return new j(e,t)}}function Um(i,e){for(let t of i.ranges)if(t.to>e)throw new RangeError("Selection points outside of document")}let ad=0;class he{constructor(e,t,n,s,r){this.combine=e,this.compareInput=t,this.compare=n,this.isStatic=s,this.id=ad++,this.default=e([]),this.extensions=typeof r=="function"?r(this):r}get reader(){return this}static define(e={}){return new he(e.combine||(t=>t),e.compareInput||((t,n)=>t===n),e.compare||(e.combine?(t,n)=>t===n:ld),!!e.static,e.enables)}of(e){return new yo([],this,0,e)}compute(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new yo(e,this,1,t)}computeN(e,t){if(this.isStatic)throw new Error("Can't compute a static facet");return new yo(e,this,2,t)}from(e,t){return t||(t=n=>n),this.compute([e],n=>t(n.field(e)))}}function ld(i,e){return i==e||i.length==e.length&&i.every((t,n)=>t===e[n])}class yo{constructor(e,t,n,s){this.dependencies=e,this.facet=t,this.type=n,this.value=s,this.id=ad++}dynamicSlot(e){var t;let n=this.value,s=this.facet.compareInput,r=this.id,o=e[r]>>1,a=this.type==2,l=!1,d=!1,c=[];for(let u of this.dependencies)u=="doc"?l=!0:u=="selection"?d=!0:(((t=e[u.id])!==null&&t!==void 0?t:1)&1)==0&&c.push(e[u.id]);return{create(u){return u.values[o]=n(u),1},update(u,h){if(l&&h.docChanged||d&&(h.docChanged||h.selection)||Xl(u,c)){let f=n(u);if(a?!Su(f,u.values[o],s):!s(f,u.values[o]))return u.values[o]=f,1}return 0},reconfigure:(u,h)=>{let f,m=h.config.address[r];if(m!=null){let g=No(h,m);if(this.dependencies.every(O=>O instanceof he?h.facet(O)===u.facet(O):O instanceof mn?h.field(O,!1)==u.field(O,!1):!0)||(a?Su(f=n(u),g,s):s(f=n(u),g)))return u.values[o]=g,0}else f=n(u);return u.values[o]=f,1}}}}function Su(i,e,t){if(i.length!=e.length)return!1;for(let n=0;n<i.length;n++)if(!t(i[n],e[n]))return!1;return!0}function Xl(i,e){let t=!1;for(let n of e)or(i,n)&1&&(t=!0);return t}function wv(i,e,t){let n=t.map(l=>i[l.id]),s=t.map(l=>l.type),r=n.filter(l=>!(l&1)),o=i[e.id]>>1;function a(l){let d=[];for(let c=0;c<n.length;c++){let u=No(l,n[c]);if(s[c]==2)for(let h of u)d.push(h);else d.push(u)}return e.combine(d)}return{create(l){for(let d of n)or(l,d);return l.values[o]=a(l),1},update(l,d){if(!Xl(l,r))return 0;let c=a(l);return e.compare(c,l.values[o])?0:(l.values[o]=c,1)},reconfigure(l,d){let c=Xl(l,n),u=d.config.facets[e.id],h=d.facet(e);if(u&&!c&&ld(t,u))return l.values[o]=h,0;let f=a(l);return e.compare(f,h)?(l.values[o]=h,0):(l.values[o]=f,1)}}}const jr=he.define({static:!0});class mn{constructor(e,t,n,s,r){this.id=e,this.createF=t,this.updateF=n,this.compareF=s,this.spec=r,this.provides=void 0}static define(e){let t=new mn(ad++,e.create,e.update,e.compare||((n,s)=>n===s),e);return e.provide&&(t.provides=e.provide(t)),t}create(e){let t=e.facet(jr).find(n=>n.field==this);return((t==null?void 0:t.create)||this.createF)(e)}slot(e){let t=e[this.id]>>1;return{create:n=>(n.values[t]=this.create(n),1),update:(n,s)=>{let r=n.values[t],o=this.updateF(r,s);return this.compareF(r,o)?0:(n.values[t]=o,1)},reconfigure:(n,s)=>{let r=n.facet(jr),o=s.facet(jr),a;return(a=r.find(l=>l.field==this))&&a!=o.find(l=>l.field==this)?(n.values[t]=a.create(n),1):s.config.address[this.id]!=null?(n.values[t]=s.field(this),0):(n.values[t]=this.create(n),1)}}}init(e){return[this,jr.of({field:this,create:e})]}get extension(){return this}}const _s={lowest:4,low:3,default:2,high:1,highest:0};function Zi(i){return e=>new Wm(e,i)}const aa={highest:Zi(_s.highest),high:Zi(_s.high),default:Zi(_s.default),low:Zi(_s.low),lowest:Zi(_s.lowest)};class Wm{constructor(e,t){this.inner=e,this.prec=t}}class la{of(e){return new Ul(this,e)}reconfigure(e){return la.reconfigure.of({compartment:this,extension:e})}get(e){return e.config.compartments.get(this)}}class Ul{constructor(e,t){this.compartment=e,this.inner=t}}class To{constructor(e,t,n,s,r,o){for(this.base=e,this.compartments=t,this.dynamicSlots=n,this.address=s,this.staticValues=r,this.facets=o,this.statusTemplate=[];this.statusTemplate.length<n.length;)this.statusTemplate.push(0)}staticFacet(e){let t=this.address[e.id];return t==null?e.default:this.staticValues[t>>1]}static resolve(e,t,n){let s=[],r=Object.create(null),o=new Map;for(let h of Pv(e,t,o))h instanceof mn?s.push(h):(r[h.facet.id]||(r[h.facet.id]=[])).push(h);let a=Object.create(null),l=[],d=[];for(let h of s)a[h.id]=d.length<<1,d.push(f=>h.slot(f));let c=n==null?void 0:n.config.facets;for(let h in r){let f=r[h],m=f[0].facet,g=c&&c[h]||[];if(f.every(O=>O.type==0))if(a[m.id]=l.length<<1|1,ld(g,f))l.push(n.facet(m));else{let O=m.combine(f.map(p=>p.value));l.push(n&&m.compare(O,n.facet(m))?n.facet(m):O)}else{for(let O of f)O.type==0?(a[O.id]=l.length<<1|1,l.push(O.value)):(a[O.id]=d.length<<1,d.push(p=>O.dynamicSlot(p)));a[m.id]=d.length<<1,d.push(O=>wv(O,m,f))}}let u=d.map(h=>h(a));return new To(e,o,u,a,l,r)}}function Pv(i,e,t){let n=[[],[],[],[],[]],s=new Map;function r(o,a){let l=s.get(o);if(l!=null){if(l<=a)return;let d=n[l].indexOf(o);d>-1&&n[l].splice(d,1),o instanceof Ul&&t.delete(o.compartment)}if(s.set(o,a),Array.isArray(o))for(let d of o)r(d,a);else if(o instanceof Ul){if(t.has(o.compartment))throw new RangeError("Duplicate use of compartment in extensions");let d=e.get(o.compartment)||o.inner;t.set(o.compartment,d),r(d,a)}else if(o instanceof Wm)r(o.inner,o.prec);else if(o instanceof mn)n[a].push(o),o.provides&&r(o.provides,a);else if(o instanceof yo)n[a].push(o),o.facet.extensions&&r(o.facet.extensions,_s.default);else{let d=o.extension;if(!d)throw new Error(`Unrecognized extension value in extension set (${o}). This sometimes happens because multiple instances of @codemirror/state are loaded, breaking instanceof checks.`);r(d,a)}}return r(i,_s.default),n.reduce((o,a)=>o.concat(a))}function or(i,e){if(e&1)return 2;let t=e>>1,n=i.status[t];if(n==4)throw new Error("Cyclic dependency between fields and/or facets");if(n&2)return n;i.status[t]=4;let s=i.computeSlot(i,i.config.dynamicSlots[t]);return i.status[t]=2|s}function No(i,e){return e&1?i.config.staticValues[e>>1]:i.values[e>>1]}const qm=he.define(),Wl=he.define({combine:i=>i.some(e=>e),static:!0}),Hm=he.define({combine:i=>i.length?i[0]:void 0,static:!0}),Ym=he.define(),Km=he.define(),Jm=he.define(),ep=he.define({combine:i=>i.length?i[0]:!1});class cs{constructor(e,t){this.type=e,this.value=t}static define(){return new Sv}}class Sv{of(e){return new cs(this,e)}}class kv{constructor(e){this.map=e}of(e){return new Ve(this,e)}}class Ve{constructor(e,t){this.type=e,this.value=t}map(e){let t=this.type.map(this.value,e);return t===void 0?void 0:t==this.value?this:new Ve(this.type,t)}is(e){return this.type==e}static define(e={}){return new kv(e.map||(t=>t))}static mapEffects(e,t){if(!e.length)return e;let n=[];for(let s of e){let r=s.map(t);r&&n.push(r)}return n}}Ve.reconfigure=Ve.define();Ve.appendConfig=Ve.define();class mt{constructor(e,t,n,s,r,o){this.startState=e,this.changes=t,this.selection=n,this.effects=s,this.annotations=r,this.scrollIntoView=o,this._doc=null,this._state=null,n&&Um(n,t.newLength),r.some(a=>a.type==mt.time)||(this.annotations=r.concat(mt.time.of(Date.now())))}static create(e,t,n,s,r,o){return new mt(e,t,n,s,r,o)}get newDoc(){return this._doc||(this._doc=this.changes.apply(this.startState.doc))}get newSelection(){return this.selection||this.startState.selection.map(this.changes)}get state(){return this._state||this.startState.applyTransaction(this),this._state}annotation(e){for(let t of this.annotations)if(t.type==e)return t.value}get docChanged(){return!this.changes.empty}get reconfigured(){return this.startState.config!=this.state.config}isUserEvent(e){let t=this.annotation(mt.userEvent);return!!(t&&(t==e||t.length>e.length&&t.slice(0,e.length)==e&&t[e.length]=="."))}}mt.time=cs.define();mt.userEvent=cs.define();mt.addToHistory=cs.define();mt.remote=cs.define();function xv(i,e){let t=[];for(let n=0,s=0;;){let r,o;if(n<i.length&&(s==e.length||e[s]>=i[n]))r=i[n++],o=i[n++];else if(s<e.length)r=e[s++],o=e[s++];else return t;!t.length||t[t.length-1]<r?t.push(r,o):t[t.length-1]<o&&(t[t.length-1]=o)}}function tp(i,e,t){var n;let s,r,o;return t?(s=e.changes,r=Ot.empty(e.changes.length),o=i.changes.compose(e.changes)):(s=e.changes.map(i.changes),r=i.changes.mapDesc(e.changes,!0),o=i.changes.compose(s)),{changes:o,selection:e.selection?e.selection.map(r):(n=i.selection)===null||n===void 0?void 0:n.map(s),effects:Ve.mapEffects(i.effects,s).concat(Ve.mapEffects(e.effects,r)),annotations:i.annotations.length?i.annotations.concat(e.annotations):e.annotations,scrollIntoView:i.scrollIntoView||e.scrollIntoView}}function ql(i,e,t){let n=e.selection,s=yi(e.annotations);return e.userEvent&&(s=s.concat(mt.userEvent.of(e.userEvent))),{changes:e.changes instanceof Ot?e.changes:Ot.of(e.changes||[],t,i.facet(Hm)),selection:n&&(n instanceof j?n:j.single(n.anchor,n.head)),effects:yi(e.effects),annotations:s,scrollIntoView:!!e.scrollIntoView}}function np(i,e,t){let n=ql(i,e.length?e[0]:{},i.doc.length);e.length&&e[0].filter===!1&&(t=!1);for(let r=1;r<e.length;r++){e[r].filter===!1&&(t=!1);let o=!!e[r].sequential;n=tp(n,ql(i,e[r],o?n.changes.newLength:i.doc.length),o)}let s=mt.create(i,n.changes,n.selection,n.effects,n.annotations,n.scrollIntoView);return Mv(t?$v(s):s)}function $v(i){let e=i.startState,t=!0;for(let s of e.facet(Ym)){let r=s(i);if(r===!1){t=!1;break}Array.isArray(r)&&(t=t===!0?r:xv(t,r))}if(t!==!0){let s,r;if(t===!1)r=i.changes.invertedDesc,s=Ot.empty(e.doc.length);else{let o=i.changes.filter(t);s=o.changes,r=o.filtered.mapDesc(o.changes).invertedDesc}i=mt.create(e,s,i.selection&&i.selection.map(r),Ve.mapEffects(i.effects,r),i.annotations,i.scrollIntoView)}let n=e.facet(Km);for(let s=n.length-1;s>=0;s--){let r=n[s](i);r instanceof mt?i=r:Array.isArray(r)&&r.length==1&&r[0]instanceof mt?i=r[0]:i=np(e,yi(r),!1)}return i}function Mv(i){let e=i.startState,t=e.facet(Jm),n=i;for(let s=t.length-1;s>=0;s--){let r=t[s](i);r&&Object.keys(r).length&&(n=tp(n,ql(e,r,i.changes.newLength),!0))}return n==i?i:mt.create(e,i.changes,i.selection,n.effects,n.annotations,n.scrollIntoView)}const Cv=[];function yi(i){return i==null?Cv:Array.isArray(i)?i:[i]}var Dt=(function(i){return i[i.Word=0]="Word",i[i.Space=1]="Space",i[i.Other=2]="Other",i})(Dt||(Dt={}));const Ev=/[\u00df\u0587\u0590-\u05f4\u0600-\u06ff\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/;let Hl;try{Hl=new RegExp("[\\p{Alphabetic}\\p{Number}_]","u")}catch{}function Av(i){if(Hl)return Hl.test(i);for(let e=0;e<i.length;e++){let t=i[e];if(/\w/.test(t)||t>""&&(t.toUpperCase()!=t.toLowerCase()||Ev.test(t)))return!0}return!1}function Tv(i){return e=>{if(!/\S/.test(e))return Dt.Space;if(Av(e))return Dt.Word;for(let t=0;t<i.length;t++)if(e.indexOf(i[t])>-1)return Dt.Word;return Dt.Other}}class ze{constructor(e,t,n,s,r,o){this.config=e,this.doc=t,this.selection=n,this.values=s,this.status=e.statusTemplate.slice(),this.computeSlot=r,o&&(o._state=this);for(let a=0;a<this.config.dynamicSlots.length;a++)or(this,a<<1);this.computeSlot=null}field(e,t=!0){let n=this.config.address[e.id];if(n==null){if(t)throw new RangeError("Field is not present in this state");return}return or(this,n),No(this,n)}update(...e){return np(this,e,!0)}applyTransaction(e){let t=this.config,{base:n,compartments:s}=t;for(let a of e.effects)a.is(la.reconfigure)?(t&&(s=new Map,t.compartments.forEach((l,d)=>s.set(d,l)),t=null),s.set(a.value.compartment,a.value.extension)):a.is(Ve.reconfigure)?(t=null,n=a.value):a.is(Ve.appendConfig)&&(t=null,n=yi(n).concat(a.value));let r;t?r=e.startState.values.slice():(t=To.resolve(n,s,this),r=new ze(t,this.doc,this.selection,t.dynamicSlots.map(()=>null),(l,d)=>d.reconfigure(l,this),null).values);let o=e.startState.facet(Wl)?e.newSelection:e.newSelection.asSingle();new ze(t,e.newDoc,o,r,(a,l)=>l.update(a,e),e)}replaceSelection(e){return typeof e=="string"&&(e=this.toText(e)),this.changeByRange(t=>({changes:{from:t.from,to:t.to,insert:e},range:j.cursor(t.from+e.length)}))}changeByRange(e){let t=this.selection,n=e(t.ranges[0]),s=this.changes(n.changes),r=[n.range],o=yi(n.effects);for(let a=1;a<t.ranges.length;a++){let l=e(t.ranges[a]),d=this.changes(l.changes),c=d.map(s);for(let h=0;h<a;h++)r[h]=r[h].map(c);let u=s.mapDesc(d,!0);r.push(l.range.map(u)),s=s.compose(c),o=Ve.mapEffects(o,c).concat(Ve.mapEffects(yi(l.effects),u))}return{changes:s,selection:j.create(r,t.mainIndex),effects:o}}changes(e=[]){return e instanceof Ot?e:Ot.of(e,this.doc.length,this.facet(ze.lineSeparator))}toText(e){return Qe.of(e.split(this.facet(ze.lineSeparator)||jl))}sliceDoc(e=0,t=this.doc.length){return this.doc.sliceString(e,t,this.lineBreak)}facet(e){let t=this.config.address[e.id];return t==null?e.default:(or(this,t),No(this,t))}toJSON(e){let t={doc:this.sliceDoc(),selection:this.selection.toJSON()};if(e)for(let n in e){let s=e[n];s instanceof mn&&this.config.address[s.id]!=null&&(t[n]=s.spec.toJSON(this.field(e[n]),this))}return t}static fromJSON(e,t={},n){if(!e||typeof e.doc!="string")throw new RangeError("Invalid JSON representation for EditorState");let s=[];if(n){for(let r in n)if(Object.prototype.hasOwnProperty.call(e,r)){let o=n[r],a=e[r];s.push(o.init(l=>o.spec.fromJSON(a,l)))}}return ze.create({doc:e.doc,selection:j.fromJSON(e.selection),extensions:t.extensions?s.concat([t.extensions]):s})}static create(e={}){let t=To.resolve(e.extensions||[],new Map),n=e.doc instanceof Qe?e.doc:Qe.of((e.doc||"").split(t.staticFacet(ze.lineSeparator)||jl)),s=e.selection?e.selection instanceof j?e.selection:j.single(e.selection.anchor,e.selection.head):j.single(0);return Um(s,n.length),t.staticFacet(Wl)||(s=s.asSingle()),new ze(t,n,s,t.dynamicSlots.map(()=>null),(r,o)=>o.create(r),null)}get tabSize(){return this.facet(ze.tabSize)}get lineBreak(){return this.facet(ze.lineSeparator)||`
`}get readOnly(){return this.facet(ep)}phrase(e,...t){for(let n of this.facet(ze.phrases))if(Object.prototype.hasOwnProperty.call(n,e)){e=n[e];break}return t.length&&(e=e.replace(/\$(\$|\d*)/g,(n,s)=>{if(s=="$")return"$";let r=+(s||1);return!r||r>t.length?n:t[r-1]})),e}languageDataAt(e,t,n=-1){let s=[];for(let r of this.facet(qm))for(let o of r(this,t,n))Object.prototype.hasOwnProperty.call(o,e)&&s.push(o[e]);return s}charCategorizer(e){return Tv(this.languageDataAt("wordChars",e).join(""))}wordAt(e){let{text:t,from:n,length:s}=this.doc.lineAt(e),r=this.charCategorizer(e),o=e-n,a=e-n;for(;o>0;){let l=Xt(t,o,!1);if(r(t.slice(l,o))!=Dt.Word)break;o=l}for(;a<s;){let l=Xt(t,a);if(r(t.slice(a,l))!=Dt.Word)break;a=l}return o==a?null:j.range(o+n,a+n)}}ze.allowMultipleSelections=Wl;ze.tabSize=he.define({combine:i=>i.length?i[0]:4});ze.lineSeparator=Hm;ze.readOnly=ep;ze.phrases=he.define({compare(i,e){let t=Object.keys(i),n=Object.keys(e);return t.length==n.length&&t.every(s=>i[s]==e[s])}});ze.languageData=qm;ze.changeFilter=Ym;ze.transactionFilter=Km;ze.transactionExtender=Jm;la.reconfigure=Ve.define();function $r(i,e,t={}){let n={};for(let s of i)for(let r of Object.keys(s)){let o=s[r],a=n[r];if(a===void 0)n[r]=o;else if(!(a===o||o===void 0))if(Object.hasOwnProperty.call(t,r))n[r]=t[r](a,o);else throw new Error("Config merge conflict for field "+r)}for(let s in e)n[s]===void 0&&(n[s]=e[s]);return n}class Ws{eq(e){return this==e}range(e,t=e){return Yl.create(e,t,this)}}Ws.prototype.startSide=Ws.prototype.endSide=0;Ws.prototype.point=!1;Ws.prototype.mapMode=Lt.TrackDel;let Yl=class sp{constructor(e,t,n){this.from=e,this.to=t,this.value=n}static create(e,t,n){return new sp(e,t,n)}};function Kl(i,e){return i.from-e.from||i.value.startSide-e.value.startSide}class cd{constructor(e,t,n,s){this.from=e,this.to=t,this.value=n,this.maxPoint=s}get length(){return this.to[this.to.length-1]}findIndex(e,t,n,s=0){let r=n?this.to:this.from;for(let o=s,a=r.length;;){if(o==a)return o;let l=o+a>>1,d=r[l]-e||(n?this.value[l].endSide:this.value[l].startSide)-t;if(l==o)return d>=0?o:a;d>=0?a=l:o=l+1}}between(e,t,n,s){for(let r=this.findIndex(t,-1e9,!0),o=this.findIndex(n,1e9,!1,r);r<o;r++)if(s(this.from[r]+e,this.to[r]+e,this.value[r])===!1)return!1}map(e,t){let n=[],s=[],r=[],o=-1,a=-1;for(let l=0;l<this.value.length;l++){let d=this.value[l],c=this.from[l]+e,u=this.to[l]+e,h,f;if(c==u){let m=t.mapPos(c,d.startSide,d.mapMode);if(m==null||(h=f=m,d.startSide!=d.endSide&&(f=t.mapPos(c,d.endSide),f<h)))continue}else if(h=t.mapPos(c,d.startSide),f=t.mapPos(u,d.endSide),h>f||h==f&&d.startSide>0&&d.endSide<=0)continue;(f-h||d.endSide-d.startSide)<0||(o<0&&(o=h),d.point&&(a=Math.max(a,f-h)),n.push(d),s.push(h-o),r.push(f-o))}return{mapped:n.length?new cd(s,r,n,a):null,pos:o}}}class _e{constructor(e,t,n,s){this.chunkPos=e,this.chunk=t,this.nextLayer=n,this.maxPoint=s}static create(e,t,n,s){return new _e(e,t,n,s)}get length(){let e=this.chunk.length-1;return e<0?0:Math.max(this.chunkEnd(e),this.nextLayer.length)}get size(){if(this.isEmpty)return 0;let e=this.nextLayer.size;for(let t of this.chunk)e+=t.value.length;return e}chunkEnd(e){return this.chunkPos[e]+this.chunk[e].length}update(e){let{add:t=[],sort:n=!1,filterFrom:s=0,filterTo:r=this.length}=e,o=e.filter;if(t.length==0&&!o)return this;if(n&&(t=t.slice().sort(Kl)),this.isEmpty)return t.length?_e.of(t):this;let a=new ip(this,null,-1).goto(0),l=0,d=[],c=new Si;for(;a.value||l<t.length;)if(l<t.length&&(a.from-t[l].from||a.startSide-t[l].value.startSide)>=0){let u=t[l++];c.addInner(u.from,u.to,u.value)||d.push(u)}else a.rangeIndex==1&&a.chunkIndex<this.chunk.length&&(l==t.length||this.chunkEnd(a.chunkIndex)<t[l].from)&&(!o||s>this.chunkEnd(a.chunkIndex)||r<this.chunkPos[a.chunkIndex])&&c.addChunk(this.chunkPos[a.chunkIndex],this.chunk[a.chunkIndex])?a.nextChunk():((!o||s>a.to||r<a.from||o(a.from,a.to,a.value))&&(c.addInner(a.from,a.to,a.value)||d.push(Yl.create(a.from,a.to,a.value))),a.next());return c.finishInner(this.nextLayer.isEmpty&&!d.length?_e.empty:this.nextLayer.update({add:d,filter:o,filterFrom:s,filterTo:r}))}map(e){if(e.empty||this.isEmpty)return this;let t=[],n=[],s=-1;for(let o=0;o<this.chunk.length;o++){let a=this.chunkPos[o],l=this.chunk[o],d=e.touchesRange(a,a+l.length);if(d===!1)s=Math.max(s,l.maxPoint),t.push(l),n.push(e.mapPos(a));else if(d===!0){let{mapped:c,pos:u}=l.map(a,e);c&&(s=Math.max(s,c.maxPoint),t.push(c),n.push(u))}}let r=this.nextLayer.map(e);return t.length==0?r:new _e(n,t,r||_e.empty,s)}between(e,t,n){if(!this.isEmpty){for(let s=0;s<this.chunk.length;s++){let r=this.chunkPos[s],o=this.chunk[s];if(t>=r&&e<=r+o.length&&o.between(r,e-r,t-r,n)===!1)return}this.nextLayer.between(e,t,n)}}iter(e=0){return pr.from([this]).goto(e)}get isEmpty(){return this.nextLayer==this}static iter(e,t=0){return pr.from(e).goto(t)}static compare(e,t,n,s,r=-1){let o=e.filter(u=>u.maxPoint>0||!u.isEmpty&&u.maxPoint>=r),a=t.filter(u=>u.maxPoint>0||!u.isEmpty&&u.maxPoint>=r),l=ku(o,a,n),d=new ji(o,l,r),c=new ji(a,l,r);n.iterGaps((u,h,f)=>xu(d,u,c,h,f,s)),n.empty&&n.length==0&&xu(d,0,c,0,0,s)}static eq(e,t,n=0,s){s==null&&(s=999999999);let r=e.filter(c=>!c.isEmpty&&t.indexOf(c)<0),o=t.filter(c=>!c.isEmpty&&e.indexOf(c)<0);if(r.length!=o.length)return!1;if(!r.length)return!0;let a=ku(r,o),l=new ji(r,a,0).goto(n),d=new ji(o,a,0).goto(n);for(;;){if(l.to!=d.to||!Jl(l.active,d.active)||l.point&&(!d.point||!l.point.eq(d.point)))return!1;if(l.to>s)return!0;l.next(),d.next()}}static spans(e,t,n,s,r=-1){let o=new ji(e,null,r).goto(t),a=t,l=o.openStart;for(;;){let d=Math.min(o.to,n);if(o.point){let c=o.activeForPoint(o.to),u=o.pointFrom<t?c.length+1:o.point.startSide<0?c.length:Math.min(c.length,l);s.point(a,d,o.point,c,u,o.pointRank),l=Math.min(o.openEnd(d),c.length)}else d>a&&(s.span(a,d,o.active,l),l=o.openEnd(d));if(o.to>n)return l+(o.point&&o.to>n?1:0);a=o.to,o.next()}}static of(e,t=!1){let n=new Si;for(let s of e instanceof Yl?[e]:t?Nv(e):e)n.add(s.from,s.to,s.value);return n.finish()}static join(e){if(!e.length)return _e.empty;let t=e[e.length-1];for(let n=e.length-2;n>=0;n--)for(let s=e[n];s!=_e.empty;s=s.nextLayer)t=new _e(s.chunkPos,s.chunk,t,Math.max(s.maxPoint,t.maxPoint));return t}}_e.empty=new _e([],[],null,-1);function Nv(i){if(i.length>1)for(let e=i[0],t=1;t<i.length;t++){let n=i[t];if(Kl(e,n)>0)return i.slice().sort(Kl);e=n}return i}_e.empty.nextLayer=_e.empty;class Si{finishChunk(e){this.chunks.push(new cd(this.from,this.to,this.value,this.maxPoint)),this.chunkPos.push(this.chunkStart),this.chunkStart=-1,this.setMaxPoint=Math.max(this.setMaxPoint,this.maxPoint),this.maxPoint=-1,e&&(this.from=[],this.to=[],this.value=[])}constructor(){this.chunks=[],this.chunkPos=[],this.chunkStart=-1,this.last=null,this.lastFrom=-1e9,this.lastTo=-1e9,this.from=[],this.to=[],this.value=[],this.maxPoint=-1,this.setMaxPoint=-1,this.nextLayer=null}add(e,t,n){this.addInner(e,t,n)||(this.nextLayer||(this.nextLayer=new Si)).add(e,t,n)}addInner(e,t,n){let s=e-this.lastTo||n.startSide-this.last.endSide;if(s<=0&&(e-this.lastFrom||n.startSide-this.last.startSide)<0)throw new Error("Ranges must be added sorted by `from` position and `startSide`");return s<0?!1:(this.from.length==250&&this.finishChunk(!0),this.chunkStart<0&&(this.chunkStart=e),this.from.push(e-this.chunkStart),this.to.push(t-this.chunkStart),this.last=n,this.lastFrom=e,this.lastTo=t,this.value.push(n),n.point&&(this.maxPoint=Math.max(this.maxPoint,t-e)),!0)}addChunk(e,t){if((e-this.lastTo||t.value[0].startSide-this.last.endSide)<0)return!1;this.from.length&&this.finishChunk(!0),this.setMaxPoint=Math.max(this.setMaxPoint,t.maxPoint),this.chunks.push(t),this.chunkPos.push(e);let n=t.value.length-1;return this.last=t.value[n],this.lastFrom=t.from[n]+e,this.lastTo=t.to[n]+e,!0}finish(){return this.finishInner(_e.empty)}finishInner(e){if(this.from.length&&this.finishChunk(!1),this.chunks.length==0)return e;let t=_e.create(this.chunkPos,this.chunks,this.nextLayer?this.nextLayer.finishInner(e):e,this.setMaxPoint);return this.from=null,t}}function ku(i,e,t){let n=new Map;for(let r of i)for(let o=0;o<r.chunk.length;o++)r.chunk[o].maxPoint<=0&&n.set(r.chunk[o],r.chunkPos[o]);let s=new Set;for(let r of e)for(let o=0;o<r.chunk.length;o++){let a=n.get(r.chunk[o]);a!=null&&(t?t.mapPos(a):a)==r.chunkPos[o]&&!(t!=null&&t.touchesRange(a,a+r.chunk[o].length))&&s.add(r.chunk[o])}return s}class ip{constructor(e,t,n,s=0){this.layer=e,this.skip=t,this.minPoint=n,this.rank=s}get startSide(){return this.value?this.value.startSide:0}get endSide(){return this.value?this.value.endSide:0}goto(e,t=-1e9){return this.chunkIndex=this.rangeIndex=0,this.gotoInner(e,t,!1),this}gotoInner(e,t,n){for(;this.chunkIndex<this.layer.chunk.length;){let s=this.layer.chunk[this.chunkIndex];if(!(this.skip&&this.skip.has(s)||this.layer.chunkEnd(this.chunkIndex)<e||s.maxPoint<this.minPoint))break;this.chunkIndex++,n=!1}if(this.chunkIndex<this.layer.chunk.length){let s=this.layer.chunk[this.chunkIndex].findIndex(e-this.layer.chunkPos[this.chunkIndex],t,!0);(!n||this.rangeIndex<s)&&this.setRangeIndex(s)}this.next()}forward(e,t){(this.to-e||this.endSide-t)<0&&this.gotoInner(e,t,!0)}next(){for(;;)if(this.chunkIndex==this.layer.chunk.length){this.from=this.to=1e9,this.value=null;break}else{let e=this.layer.chunkPos[this.chunkIndex],t=this.layer.chunk[this.chunkIndex],n=e+t.from[this.rangeIndex];if(this.from=n,this.to=e+t.to[this.rangeIndex],this.value=t.value[this.rangeIndex],this.setRangeIndex(this.rangeIndex+1),this.minPoint<0||this.value.point&&this.to-this.from>=this.minPoint)break}}setRangeIndex(e){if(e==this.layer.chunk[this.chunkIndex].value.length){if(this.chunkIndex++,this.skip)for(;this.chunkIndex<this.layer.chunk.length&&this.skip.has(this.layer.chunk[this.chunkIndex]);)this.chunkIndex++;this.rangeIndex=0}else this.rangeIndex=e}nextChunk(){this.chunkIndex++,this.rangeIndex=0,this.next()}compare(e){return this.from-e.from||this.startSide-e.startSide||this.rank-e.rank||this.to-e.to||this.endSide-e.endSide}}class pr{constructor(e){this.heap=e}static from(e,t=null,n=-1){let s=[];for(let r=0;r<e.length;r++)for(let o=e[r];!o.isEmpty;o=o.nextLayer)o.maxPoint>=n&&s.push(new ip(o,t,n,r));return s.length==1?s[0]:new pr(s)}get startSide(){return this.value?this.value.startSide:0}goto(e,t=-1e9){for(let n of this.heap)n.goto(e,t);for(let n=this.heap.length>>1;n>=0;n--)La(this.heap,n);return this.next(),this}forward(e,t){for(let n of this.heap)n.forward(e,t);for(let n=this.heap.length>>1;n>=0;n--)La(this.heap,n);(this.to-e||this.value.endSide-t)<0&&this.next()}next(){if(this.heap.length==0)this.from=this.to=1e9,this.value=null,this.rank=-1;else{let e=this.heap[0];this.from=e.from,this.to=e.to,this.value=e.value,this.rank=e.rank,e.value&&e.next(),La(this.heap,0)}}}function La(i,e){for(let t=i[e];;){let n=(e<<1)+1;if(n>=i.length)break;let s=i[n];if(n+1<i.length&&s.compare(i[n+1])>=0&&(s=i[n+1],n++),t.compare(s)<0)break;i[n]=t,i[e]=s,e=n}}class ji{constructor(e,t,n){this.minPoint=n,this.active=[],this.activeTo=[],this.activeRank=[],this.minActive=-1,this.point=null,this.pointFrom=0,this.pointRank=0,this.to=-1e9,this.endSide=0,this.openStart=-1,this.cursor=pr.from(e,t,n)}goto(e,t=-1e9){return this.cursor.goto(e,t),this.active.length=this.activeTo.length=this.activeRank.length=0,this.minActive=-1,this.to=e,this.endSide=t,this.openStart=-1,this.next(),this}forward(e,t){for(;this.minActive>-1&&(this.activeTo[this.minActive]-e||this.active[this.minActive].endSide-t)<0;)this.removeActive(this.minActive);this.cursor.forward(e,t)}removeActive(e){Fr(this.active,e),Fr(this.activeTo,e),Fr(this.activeRank,e),this.minActive=$u(this.active,this.activeTo)}addActive(e){let t=0,{value:n,to:s,rank:r}=this.cursor;for(;t<this.activeRank.length&&(r-this.activeRank[t]||s-this.activeTo[t])>0;)t++;Gr(this.active,t,n),Gr(this.activeTo,t,s),Gr(this.activeRank,t,r),e&&Gr(e,t,this.cursor.from),this.minActive=$u(this.active,this.activeTo)}next(){let e=this.to,t=this.point;this.point=null;let n=this.openStart<0?[]:null;for(;;){let s=this.minActive;if(s>-1&&(this.activeTo[s]-this.cursor.from||this.active[s].endSide-this.cursor.startSide)<0){if(this.activeTo[s]>e){this.to=this.activeTo[s],this.endSide=this.active[s].endSide;break}this.removeActive(s),n&&Fr(n,s)}else if(this.cursor.value)if(this.cursor.from>e){this.to=this.cursor.from,this.endSide=this.cursor.startSide;break}else{let r=this.cursor.value;if(!r.point)this.addActive(n),this.cursor.next();else if(t&&this.cursor.to==this.to&&this.cursor.from<this.cursor.to)this.cursor.next();else{this.point=r,this.pointFrom=this.cursor.from,this.pointRank=this.cursor.rank,this.to=this.cursor.to,this.endSide=r.endSide,this.cursor.next(),this.forward(this.to,this.endSide);break}}else{this.to=this.endSide=1e9;break}}if(n){this.openStart=0;for(let s=n.length-1;s>=0&&n[s]<e;s--)this.openStart++}}activeForPoint(e){if(!this.active.length)return this.active;let t=[];for(let n=this.active.length-1;n>=0&&!(this.activeRank[n]<this.pointRank);n--)(this.activeTo[n]>e||this.activeTo[n]==e&&this.active[n].endSide>=this.point.endSide)&&t.push(this.active[n]);return t.reverse()}openEnd(e){let t=0;for(let n=this.activeTo.length-1;n>=0&&this.activeTo[n]>e;n--)t++;return t}}function xu(i,e,t,n,s,r){i.goto(e),t.goto(n);let o=n+s,a=n,l=n-e;for(;;){let d=i.to+l-t.to,c=d||i.endSide-t.endSide,u=c<0?i.to+l:t.to,h=Math.min(u,o);if(i.point||t.point?i.point&&t.point&&(i.point==t.point||i.point.eq(t.point))&&Jl(i.activeForPoint(i.to),t.activeForPoint(t.to))||r.comparePoint(a,h,i.point,t.point):h>a&&!Jl(i.active,t.active)&&r.compareRange(a,h,i.active,t.active),u>o)break;(d||i.openEnd!=t.openEnd)&&r.boundChange&&r.boundChange(u),a=u,c<=0&&i.next(),c>=0&&t.next()}}function Jl(i,e){if(i.length!=e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!=e[t]&&!i[t].eq(e[t]))return!1;return!0}function Fr(i,e){for(let t=e,n=i.length-1;t<n;t++)i[t]=i[t+1];i.pop()}function Gr(i,e,t){for(let n=i.length-1;n>=e;n--)i[n+1]=i[n];i[e]=t}function $u(i,e){let t=-1,n=1e9;for(let s=0;s<e.length;s++)(e[s]-n||i[s].endSide-i[t].endSide)<0&&(t=s,n=e[s]);return t}function ca(i,e,t=i.length){let n=0;for(let s=0;s<t&&s<i.length;)i.charCodeAt(s)==9?(n+=e-n%e,s++):(n++,s=Xt(i,s));return n}function Qv(i,e,t,n){for(let s=0,r=0;;){if(r>=e)return s;if(s==i.length)break;r+=i.charCodeAt(s)==9?t-r%t:1,s=Xt(i,s)}return i.length}const ec="ͼ",Mu=typeof Symbol>"u"?"__"+ec:Symbol.for(ec),tc=typeof Symbol>"u"?"__styleSet"+Math.floor(Math.random()*1e8):Symbol("styleSet"),Cu=typeof globalThis<"u"?globalThis:typeof window<"u"?window:{};class Ps{constructor(e,t){this.rules=[];let{finish:n}=t||{};function s(o){return/^@/.test(o)?[o]:o.split(/,\s*/)}function r(o,a,l,d){let c=[],u=/^@(\w+)\b/.exec(o[0]),h=u&&u[1]=="keyframes";if(u&&a==null)return l.push(o[0]+";");for(let f in a){let m=a[f];if(/&/.test(f))r(f.split(/,\s*/).map(g=>o.map(O=>g.replace(/&/,O))).reduce((g,O)=>g.concat(O)),m,l);else if(m&&typeof m=="object"){if(!u)throw new RangeError("The value of a property ("+f+") should be a primitive value.");r(s(f),m,c,h)}else m!=null&&c.push(f.replace(/_.*/,"").replace(/[A-Z]/g,g=>"-"+g.toLowerCase())+": "+m+";")}(c.length||h)&&l.push((n&&!u&&!d?o.map(n):o).join(", ")+" {"+c.join(" ")+"}")}for(let o in e)r(s(o),e[o],this.rules)}getRules(){return this.rules.join(`
`)}static newName(){let e=Cu[Mu]||1;return Cu[Mu]=e+1,ec+e.toString(36)}static mount(e,t,n){let s=e[tc],r=n&&n.nonce;s?r&&s.setNonce(r):s=new Rv(e,r),s.mount(Array.isArray(t)?t:[t],e)}}let Eu=new Map;class Rv{constructor(e,t){let n=e.ownerDocument||e,s=n.defaultView;if(!e.head&&e.adoptedStyleSheets&&s.CSSStyleSheet){let r=Eu.get(n);if(r)return e[tc]=r;this.sheet=new s.CSSStyleSheet,Eu.set(n,this)}else this.styleTag=n.createElement("style"),t&&this.styleTag.setAttribute("nonce",t);this.modules=[],e[tc]=this}mount(e,t){let n=this.sheet,s=0,r=0;for(let o=0;o<e.length;o++){let a=e[o],l=this.modules.indexOf(a);if(l<r&&l>-1&&(this.modules.splice(l,1),r--,l=-1),l==-1){if(this.modules.splice(r++,0,a),n)for(let d=0;d<a.rules.length;d++)n.insertRule(a.rules[d],s++)}else{for(;r<l;)s+=this.modules[r++].rules.length;s+=a.rules.length,r++}}if(n)t.adoptedStyleSheets.indexOf(this.sheet)<0&&(t.adoptedStyleSheets=[this.sheet,...t.adoptedStyleSheets]);else{let o="";for(let l=0;l<this.modules.length;l++)o+=this.modules[l].getRules()+`
`;this.styleTag.textContent=o;let a=t.head||t;this.styleTag.parentNode!=a&&a.insertBefore(this.styleTag,a.firstChild)}}setNonce(e){this.styleTag&&this.styleTag.getAttribute("nonce")!=e&&this.styleTag.setAttribute("nonce",e)}}var Ss={8:"Backspace",9:"Tab",10:"Enter",12:"NumLock",13:"Enter",16:"Shift",17:"Control",18:"Alt",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",44:"PrintScreen",45:"Insert",46:"Delete",59:";",61:"=",91:"Meta",92:"Meta",106:"*",107:"+",108:",",109:"-",110:".",111:"/",144:"NumLock",145:"ScrollLock",160:"Shift",161:"Shift",162:"Control",163:"Control",164:"Alt",165:"Alt",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},gr={48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"~",219:"{",220:"|",221:"}",222:'"'},_v=typeof navigator<"u"&&/Mac/.test(navigator.platform),Iv=typeof navigator<"u"&&/MSIE \d|Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(navigator.userAgent);for(var Nt=0;Nt<10;Nt++)Ss[48+Nt]=Ss[96+Nt]=String(Nt);for(var Nt=1;Nt<=24;Nt++)Ss[Nt+111]="F"+Nt;for(var Nt=65;Nt<=90;Nt++)Ss[Nt]=String.fromCharCode(Nt+32),gr[Nt]=String.fromCharCode(Nt);for(var Ba in Ss)gr.hasOwnProperty(Ba)||(gr[Ba]=Ss[Ba]);function Lv(i){var e=_v&&i.metaKey&&i.shiftKey&&!i.ctrlKey&&!i.altKey||Iv&&i.shiftKey&&i.key&&i.key.length==1||i.key=="Unidentified",t=!e&&i.key||(i.shiftKey?gr:Ss)[i.keyCode]||i.key||"Unidentified";return t=="Esc"&&(t="Escape"),t=="Del"&&(t="Delete"),t=="Left"&&(t="ArrowLeft"),t=="Up"&&(t="ArrowUp"),t=="Right"&&(t="ArrowRight"),t=="Down"&&(t="ArrowDown"),t}let Gt=typeof navigator<"u"?navigator:{userAgent:"",vendor:"",platform:""},nc=typeof document<"u"?document:{documentElement:{style:{}}};const sc=/Edge\/(\d+)/.exec(Gt.userAgent),rp=/MSIE \d/.test(Gt.userAgent),ic=/Trident\/(?:[7-9]|\d{2,})\..*rv:(\d+)/.exec(Gt.userAgent),da=!!(rp||ic||sc),Au=!da&&/gecko\/(\d+)/i.test(Gt.userAgent),Da=!da&&/Chrome\/(\d+)/.exec(Gt.userAgent),Bv="webkitFontSmoothing"in nc.documentElement.style,rc=!da&&/Apple Computer/.test(Gt.vendor),Tu=rc&&(/Mobile\/\w+/.test(Gt.userAgent)||Gt.maxTouchPoints>2);var re={mac:Tu||/Mac/.test(Gt.platform),windows:/Win/.test(Gt.platform),linux:/Linux|X11/.test(Gt.platform),ie:da,ie_version:rp?nc.documentMode||6:ic?+ic[1]:sc?+sc[1]:0,gecko:Au,gecko_version:Au?+(/Firefox\/(\d+)/.exec(Gt.userAgent)||[0,0])[1]:0,chrome:!!Da,chrome_version:Da?+Da[1]:0,ios:Tu,android:/Android\b/.test(Gt.userAgent),webkit_version:Bv?+(/\bAppleWebKit\/(\d+)/.exec(Gt.userAgent)||[0,0])[1]:0,safari:rc,safari_version:rc?+(/\bVersion\/(\d+(\.\d+)?)/.exec(Gt.userAgent)||[0,0])[1]:0,tabSize:nc.documentElement.style.tabSize!=null?"tab-size":"-moz-tab-size"};function Or(i){let e;return i.nodeType==11?e=i.getSelection?i:i.ownerDocument:e=i,e.getSelection()}function oc(i,e){return e?i==e||i.contains(e.nodeType!=1?e.parentNode:e):!1}function bo(i,e){if(!e.anchorNode)return!1;try{return oc(i,e.anchorNode)}catch{return!1}}function yr(i){return i.nodeType==3?Hs(i,0,i.nodeValue.length).getClientRects():i.nodeType==1?i.getClientRects():[]}function ar(i,e,t,n){return t?Nu(i,e,t,n,-1)||Nu(i,e,t,n,1):!1}function qs(i){for(var e=0;;e++)if(i=i.previousSibling,!i)return e}function Qo(i){return i.nodeType==1&&/^(DIV|P|LI|UL|OL|BLOCKQUOTE|DD|DT|H\d|SECTION|PRE)$/.test(i.nodeName)}function Nu(i,e,t,n,s){for(;;){if(i==t&&e==n)return!0;if(e==(s<0?0:es(i))){if(i.nodeName=="DIV")return!1;let r=i.parentNode;if(!r||r.nodeType!=1)return!1;e=qs(i)+(s<0?0:1),i=r}else if(i.nodeType==1){if(i=i.childNodes[e+(s<0?-1:0)],i.nodeType==1&&i.contentEditable=="false")return!1;e=s<0?es(i):0}else return!1}}function es(i){return i.nodeType==3?i.nodeValue.length:i.childNodes.length}function ua(i,e){let t=e?i.left:i.right;return{left:t,right:t,top:i.top,bottom:i.bottom}}function Dv(i){let e=i.visualViewport;return e?{left:0,right:e.width,top:0,bottom:e.height}:{left:0,right:i.innerWidth,top:0,bottom:i.innerHeight}}function op(i,e){let t=e.width/i.offsetWidth,n=e.height/i.offsetHeight;return(t>.995&&t<1.005||!isFinite(t)||Math.abs(e.width-i.offsetWidth)<1)&&(t=1),(n>.995&&n<1.005||!isFinite(n)||Math.abs(e.height-i.offsetHeight)<1)&&(n=1),{scaleX:t,scaleY:n}}function zv(i,e,t,n,s,r,o,a){let l=i.ownerDocument,d=l.defaultView||window;for(let c=i,u=!1;c&&!u;)if(c.nodeType==1){let h,f=c==l.body,m=1,g=1;if(f)h=Dv(d);else{if(/^(fixed|sticky)$/.test(getComputedStyle(c).position)&&(u=!0),c.scrollHeight<=c.clientHeight&&c.scrollWidth<=c.clientWidth){c=c.assignedSlot||c.parentNode;continue}let y=c.getBoundingClientRect();({scaleX:m,scaleY:g}=op(c,y)),h={left:y.left,right:y.left+c.clientWidth*m,top:y.top,bottom:y.top+c.clientHeight*g}}let O=0,p=0;if(s=="nearest")e.top<h.top?(p=e.top-(h.top+o),t>0&&e.bottom>h.bottom+p&&(p=e.bottom-h.bottom+o)):e.bottom>h.bottom&&(p=e.bottom-h.bottom+o,t<0&&e.top-p<h.top&&(p=e.top-(h.top+o)));else{let y=e.bottom-e.top,M=h.bottom-h.top;p=(s=="center"&&y<=M?e.top+y/2-M/2:s=="start"||s=="center"&&t<0?e.top-o:e.bottom-M+o)-h.top}if(n=="nearest"?e.left<h.left?(O=e.left-(h.left+r),t>0&&e.right>h.right+O&&(O=e.right-h.right+r)):e.right>h.right&&(O=e.right-h.right+r,t<0&&e.left<h.left+O&&(O=e.left-(h.left+r))):O=(n=="center"?e.left+(e.right-e.left)/2-(h.right-h.left)/2:n=="start"==a?e.left-r:e.right-(h.right-h.left)+r)-h.left,O||p)if(f)d.scrollBy(O,p);else{let y=0,M=0;if(p){let b=c.scrollTop;c.scrollTop+=p/g,M=(c.scrollTop-b)*g}if(O){let b=c.scrollLeft;c.scrollLeft+=O/m,y=(c.scrollLeft-b)*m}e={left:e.left-y,top:e.top-M,right:e.right-y,bottom:e.bottom-M},y&&Math.abs(y-O)<1&&(n="nearest"),M&&Math.abs(M-p)<1&&(s="nearest")}if(f)break;(e.top<h.top||e.bottom>h.bottom||e.left<h.left||e.right>h.right)&&(e={left:Math.max(e.left,h.left),right:Math.min(e.right,h.right),top:Math.max(e.top,h.top),bottom:Math.min(e.bottom,h.bottom)}),c=c.assignedSlot||c.parentNode}else if(c.nodeType==11)c=c.host;else break}function Vv(i){let e=i.ownerDocument,t,n;for(let s=i.parentNode;s&&!(s==e.body||t&&n);)if(s.nodeType==1)!n&&s.scrollHeight>s.clientHeight&&(n=s),!t&&s.scrollWidth>s.clientWidth&&(t=s),s=s.assignedSlot||s.parentNode;else if(s.nodeType==11)s=s.host;else break;return{x:t,y:n}}class Zv{constructor(){this.anchorNode=null,this.anchorOffset=0,this.focusNode=null,this.focusOffset=0}eq(e){return this.anchorNode==e.anchorNode&&this.anchorOffset==e.anchorOffset&&this.focusNode==e.focusNode&&this.focusOffset==e.focusOffset}setRange(e){let{anchorNode:t,focusNode:n}=e;this.set(t,Math.min(e.anchorOffset,t?es(t):0),n,Math.min(e.focusOffset,n?es(n):0))}set(e,t,n,s){this.anchorNode=e,this.anchorOffset=t,this.focusNode=n,this.focusOffset=s}}let Rs=null;re.safari&&re.safari_version>=26&&(Rs=!1);function ap(i){if(i.setActive)return i.setActive();if(Rs)return i.focus(Rs);let e=[];for(let t=i;t&&(e.push(t,t.scrollTop,t.scrollLeft),t!=t.ownerDocument);t=t.parentNode);if(i.focus(Rs==null?{get preventScroll(){return Rs={preventScroll:!0},!0}}:void 0),!Rs){Rs=!1;for(let t=0;t<e.length;){let n=e[t++],s=e[t++],r=e[t++];n.scrollTop!=s&&(n.scrollTop=s),n.scrollLeft!=r&&(n.scrollLeft=r)}}}let Qu;function Hs(i,e,t=e){let n=Qu||(Qu=document.createRange());return n.setEnd(i,t),n.setStart(i,e),n}function bi(i,e,t,n){let s={key:e,code:e,keyCode:t,which:t,cancelable:!0};n&&({altKey:s.altKey,ctrlKey:s.ctrlKey,shiftKey:s.shiftKey,metaKey:s.metaKey}=n);let r=new KeyboardEvent("keydown",s);r.synthetic=!0,i.dispatchEvent(r);let o=new KeyboardEvent("keyup",s);return o.synthetic=!0,i.dispatchEvent(o),r.defaultPrevented||o.defaultPrevented}function jv(i){for(;i;){if(i&&(i.nodeType==9||i.nodeType==11&&i.host))return i;i=i.assignedSlot||i.parentNode}return null}function lp(i){for(;i.attributes.length;)i.removeAttributeNode(i.attributes[0])}function Fv(i,e){let t=e.focusNode,n=e.focusOffset;if(!t||e.anchorNode!=t||e.anchorOffset!=n)return!1;for(n=Math.min(n,es(t));;)if(n){if(t.nodeType!=1)return!1;let s=t.childNodes[n-1];s.contentEditable=="false"?n--:(t=s,n=es(t))}else{if(t==i)return!0;n=qs(t),t=t.parentNode}}function cp(i){return i.scrollTop>Math.max(1,i.scrollHeight-i.clientHeight-4)}function dp(i,e){for(let t=i,n=e;;){if(t.nodeType==3&&n>0)return{node:t,offset:n};if(t.nodeType==1&&n>0){if(t.contentEditable=="false")return null;t=t.childNodes[n-1],n=es(t)}else if(t.parentNode&&!Qo(t))n=qs(t),t=t.parentNode;else return null}}function up(i,e){for(let t=i,n=e;;){if(t.nodeType==3&&n<t.nodeValue.length)return{node:t,offset:n};if(t.nodeType==1&&n<t.childNodes.length){if(t.contentEditable=="false")return null;t=t.childNodes[n],n=0}else if(t.parentNode&&!Qo(t))n=qs(t)+1,t=t.parentNode;else return null}}class Bt{constructor(e,t,n=!0){this.node=e,this.offset=t,this.precise=n}static before(e,t){return new Bt(e.parentNode,qs(e),t)}static after(e,t){return new Bt(e.parentNode,qs(e)+1,t)}}const dd=[];class Ge{constructor(){this.parent=null,this.dom=null,this.flags=2}get overrideDOMText(){return null}get posAtStart(){return this.parent?this.parent.posBefore(this):0}get posAtEnd(){return this.posAtStart+this.length}posBefore(e){let t=this.posAtStart;for(let n of this.children){if(n==e)return t;t+=n.length+n.breakAfter}throw new RangeError("Invalid child in posBefore")}posAfter(e){return this.posBefore(e)+e.length}sync(e,t){if(this.flags&2){let n=this.dom,s=null,r;for(let o of this.children){if(o.flags&7){if(!o.dom&&(r=s?s.nextSibling:n.firstChild)){let a=Ge.get(r);(!a||!a.parent&&a.canReuseDOM(o))&&o.reuseDOM(r)}o.sync(e,t),o.flags&=-8}if(r=s?s.nextSibling:n.firstChild,t&&!t.written&&t.node==n&&r!=o.dom&&(t.written=!0),o.dom.parentNode==n)for(;r&&r!=o.dom;)r=Ru(r);else n.insertBefore(o.dom,r);s=o.dom}for(r=s?s.nextSibling:n.firstChild,r&&t&&t.node==n&&(t.written=!0);r;)r=Ru(r)}else if(this.flags&1)for(let n of this.children)n.flags&7&&(n.sync(e,t),n.flags&=-8)}reuseDOM(e){}localPosFromDOM(e,t){let n;if(e==this.dom)n=this.dom.childNodes[t];else{let s=es(e)==0?0:t==0?-1:1;for(;;){let r=e.parentNode;if(r==this.dom)break;s==0&&r.firstChild!=r.lastChild&&(e==r.firstChild?s=-1:s=1),e=r}s<0?n=e:n=e.nextSibling}if(n==this.dom.firstChild)return 0;for(;n&&!Ge.get(n);)n=n.nextSibling;if(!n)return this.length;for(let s=0,r=0;;s++){let o=this.children[s];if(o.dom==n)return r;r+=o.length+o.breakAfter}}domBoundsAround(e,t,n=0){let s=-1,r=-1,o=-1,a=-1;for(let l=0,d=n,c=n;l<this.children.length;l++){let u=this.children[l],h=d+u.length;if(d<e&&h>t)return u.domBoundsAround(e,t,d);if(h>=e&&s==-1&&(s=l,r=d),d>t&&u.dom.parentNode==this.dom){o=l,a=c;break}c=h,d=h+u.breakAfter}return{from:r,to:a<0?n+this.length:a,startDOM:(s?this.children[s-1].dom.nextSibling:null)||this.dom.firstChild,endDOM:o<this.children.length&&o>=0?this.children[o].dom:null}}markDirty(e=!1){this.flags|=2,this.markParentsDirty(e)}markParentsDirty(e){for(let t=this.parent;t;t=t.parent){if(e&&(t.flags|=2),t.flags&1)return;t.flags|=1,e=!1}}setParent(e){this.parent!=e&&(this.parent=e,this.flags&7&&this.markParentsDirty(!0))}setDOM(e){this.dom!=e&&(this.dom&&(this.dom.cmView=null),this.dom=e,e.cmView=this)}get rootView(){for(let e=this;;){let t=e.parent;if(!t)return e;e=t}}replaceChildren(e,t,n=dd){this.markDirty();for(let s=e;s<t;s++){let r=this.children[s];r.parent==this&&n.indexOf(r)<0&&r.destroy()}n.length<250?this.children.splice(e,t-e,...n):this.children=[].concat(this.children.slice(0,e),n,this.children.slice(t));for(let s=0;s<n.length;s++)n[s].setParent(this)}ignoreMutation(e){return!1}ignoreEvent(e){return!1}childCursor(e=this.length){return new hp(this.children,e,this.children.length)}childPos(e,t=1){return this.childCursor().findPos(e,t)}toString(){let e=this.constructor.name.replace("View","");return e+(this.children.length?"("+this.children.join()+")":this.length?"["+(e=="Text"?this.text:this.length)+"]":"")+(this.breakAfter?"#":"")}static get(e){return e.cmView}get isEditable(){return!0}get isWidget(){return!1}get isHidden(){return!1}merge(e,t,n,s,r,o){return!1}become(e){return!1}canReuseDOM(e){return e.constructor==this.constructor&&!((this.flags|e.flags)&8)}getSide(){return 0}destroy(){for(let e of this.children)e.parent==this&&e.destroy();this.parent=null}}Ge.prototype.breakAfter=0;function Ru(i){let e=i.nextSibling;return i.parentNode.removeChild(i),e}class hp{constructor(e,t,n){this.children=e,this.pos=t,this.i=n,this.off=0}findPos(e,t=1){for(;;){if(e>this.pos||e==this.pos&&(t>0||this.i==0||this.children[this.i-1].breakAfter))return this.off=e-this.pos,this;let n=this.children[--this.i];this.pos-=n.length+n.breakAfter}}}function fp(i,e,t,n,s,r,o,a,l){let{children:d}=i,c=d.length?d[e]:null,u=r.length?r[r.length-1]:null,h=u?u.breakAfter:o;if(!(e==n&&c&&!o&&!h&&r.length<2&&c.merge(t,s,r.length?u:null,t==0,a,l))){if(n<d.length){let f=d[n];f&&(s<f.length||f.breakAfter&&(u!=null&&u.breakAfter))?(e==n&&(f=f.split(s),s=0),!h&&u&&f.merge(0,s,u,!0,0,l)?r[r.length-1]=f:((s||f.children.length&&!f.children[0].length)&&f.merge(0,s,null,!1,0,l),r.push(f))):f!=null&&f.breakAfter&&(u?u.breakAfter=1:o=1),n++}for(c&&(c.breakAfter=o,t>0&&(!o&&r.length&&c.merge(t,c.length,r[0],!1,a,0)?c.breakAfter=r.shift().breakAfter:(t<c.length||c.children.length&&c.children[c.children.length-1].length==0)&&c.merge(t,c.length,null,!1,a,0),e++));e<n&&r.length;)if(d[n-1].become(r[r.length-1]))n--,r.pop(),l=r.length?0:a;else if(d[e].become(r[0]))e++,r.shift(),a=r.length?0:l;else break;!r.length&&e&&n<d.length&&!d[e-1].breakAfter&&d[n].merge(0,0,d[e-1],!1,a,l)&&e--,(e<n||r.length)&&i.replaceChildren(e,n,r)}}function mp(i,e,t,n,s,r){let o=i.childCursor(),{i:a,off:l}=o.findPos(t,1),{i:d,off:c}=o.findPos(e,-1),u=e-t;for(let h of n)u+=h.length;i.length+=u,fp(i,d,c,a,l,n,0,s,r)}const Gv=256;class Tn extends Ge{constructor(e){super(),this.text=e}get length(){return this.text.length}createDOM(e){this.setDOM(e||document.createTextNode(this.text))}sync(e,t){this.dom||this.createDOM(),this.dom.nodeValue!=this.text&&(t&&t.node==this.dom&&(t.written=!0),this.dom.nodeValue=this.text)}reuseDOM(e){e.nodeType==3&&this.createDOM(e)}merge(e,t,n){return this.flags&8||n&&(!(n instanceof Tn)||this.length-(t-e)+n.length>Gv||n.flags&8)?!1:(this.text=this.text.slice(0,e)+(n?n.text:"")+this.text.slice(t),this.markDirty(),!0)}split(e){let t=new Tn(this.text.slice(e));return this.text=this.text.slice(0,e),this.markDirty(),t.flags|=this.flags&8,t}localPosFromDOM(e,t){return e==this.dom?t:t?this.text.length:0}domAtPos(e){return new Bt(this.dom,e)}domBoundsAround(e,t,n){return{from:n,to:n+this.length,startDOM:this.dom,endDOM:this.dom.nextSibling}}coordsAt(e,t){return Xv(this.dom,e,t)}}class ls extends Ge{constructor(e,t=[],n=0){super(),this.mark=e,this.children=t,this.length=n;for(let s of t)s.setParent(this)}setAttrs(e){if(lp(e),this.mark.class&&(e.className=this.mark.class),this.mark.attrs)for(let t in this.mark.attrs)e.setAttribute(t,this.mark.attrs[t]);return e}canReuseDOM(e){return super.canReuseDOM(e)&&!((this.flags|e.flags)&8)}reuseDOM(e){e.nodeName==this.mark.tagName.toUpperCase()&&(this.setDOM(e),this.flags|=6)}sync(e,t){this.dom?this.flags&4&&this.setAttrs(this.dom):this.setDOM(this.setAttrs(document.createElement(this.mark.tagName))),super.sync(e,t)}merge(e,t,n,s,r,o){return n&&(!(n instanceof ls&&n.mark.eq(this.mark))||e&&r<=0||t<this.length&&o<=0)?!1:(mp(this,e,t,n?n.children.slice():[],r-1,o-1),this.markDirty(),!0)}split(e){let t=[],n=0,s=-1,r=0;for(let a of this.children){let l=n+a.length;l>e&&t.push(n<e?a.split(e-n):a),s<0&&n>=e&&(s=r),n=l,r++}let o=this.length-e;return this.length=e,s>-1&&(this.children.length=s,this.markDirty()),new ls(this.mark,t,o)}domAtPos(e){return pp(this,e)}coordsAt(e,t){return Op(this,e,t)}}function Xv(i,e,t){let n=i.nodeValue.length;e>n&&(e=n);let s=e,r=e,o=0;e==0&&t<0||e==n&&t>=0?re.chrome||re.gecko||(e?(s--,o=1):r<n&&(r++,o=-1)):t<0?s--:r<n&&r++;let a=Hs(i,s,r).getClientRects();if(!a.length)return null;let l=a[(o?o<0:t>=0)?0:a.length-1];return re.safari&&!o&&l.width==0&&(l=Array.prototype.find.call(a,d=>d.width)||l),o?ua(l,o<0):l||null}class Ds extends Ge{static create(e,t,n){return new Ds(e,t,n)}constructor(e,t,n){super(),this.widget=e,this.length=t,this.side=n,this.prevWidget=null}split(e){let t=Ds.create(this.widget,this.length-e,this.side);return this.length-=e,t}sync(e){(!this.dom||!this.widget.updateDOM(this.dom,e))&&(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(e)),this.widget.editable||(this.dom.contentEditable="false"))}getSide(){return this.side}merge(e,t,n,s,r,o){return n&&(!(n instanceof Ds)||!this.widget.compare(n.widget)||e>0&&r<=0||t<this.length&&o<=0)?!1:(this.length=e+(n?n.length:0)+(this.length-t),!0)}become(e){return e instanceof Ds&&e.side==this.side&&this.widget.constructor==e.widget.constructor?(this.widget.compare(e.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=e.widget,this.length=e.length,!0):!1}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get overrideDOMText(){if(this.length==0)return Qe.empty;let e=this;for(;e.parent;)e=e.parent;let{view:t}=e,n=t&&t.state.doc,s=this.posAtStart;return n?n.slice(s,s+this.length):Qe.empty}domAtPos(e){return(this.length?e==0:this.side>0)?Bt.before(this.dom):Bt.after(this.dom,e==this.length)}domBoundsAround(){return null}coordsAt(e,t){let n=this.widget.coordsAt(this.dom,e,t);if(n)return n;let s=this.dom.getClientRects(),r=null;if(!s.length)return null;let o=this.side?this.side<0:e>0;for(let a=o?s.length-1:0;r=s[a],!(e>0?a==0:a==s.length-1||r.top<r.bottom);a+=o?-1:1);return ua(r,!o)}get isEditable(){return!1}get isWidget(){return!0}get isHidden(){return this.widget.isHidden}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}}class ki extends Ge{constructor(e){super(),this.side=e}get length(){return 0}merge(){return!1}become(e){return e instanceof ki&&e.side==this.side}split(){return new ki(this.side)}sync(){if(!this.dom){let e=document.createElement("img");e.className="cm-widgetBuffer",e.setAttribute("aria-hidden","true"),this.setDOM(e)}}getSide(){return this.side}domAtPos(e){return this.side>0?Bt.before(this.dom):Bt.after(this.dom)}localPosFromDOM(){return 0}domBoundsAround(){return null}coordsAt(e){return this.dom.getBoundingClientRect()}get overrideDOMText(){return Qe.empty}get isHidden(){return!0}}Tn.prototype.children=Ds.prototype.children=ki.prototype.children=dd;function pp(i,e){let t=i.dom,{children:n}=i,s=0;for(let r=0;s<n.length;s++){let o=n[s],a=r+o.length;if(!(a==r&&o.getSide()<=0)){if(e>r&&e<a&&o.dom.parentNode==t)return o.domAtPos(e-r);if(e<=r)break;r=a}}for(let r=s;r>0;r--){let o=n[r-1];if(o.dom.parentNode==t)return o.domAtPos(o.length)}for(let r=s;r<n.length;r++){let o=n[r];if(o.dom.parentNode==t)return o.domAtPos(0)}return new Bt(t,0)}function gp(i,e,t){let n,{children:s}=i;t>0&&e instanceof ls&&s.length&&(n=s[s.length-1])instanceof ls&&n.mark.eq(e.mark)?gp(n,e.children[0],t-1):(s.push(e),e.setParent(i)),i.length+=e.length}function Op(i,e,t){let n=null,s=-1,r=null,o=-1;function a(d,c){for(let u=0,h=0;u<d.children.length&&h<=c;u++){let f=d.children[u],m=h+f.length;m>=c&&(f.children.length?a(f,c-h):(!r||r.isHidden&&(t>0||Wv(r,f)))&&(m>c||h==m&&f.getSide()>0)?(r=f,o=c-h):(h<c||h==m&&f.getSide()<0&&!f.isHidden)&&(n=f,s=c-h)),h=m}}a(i,e);let l=(t<0?n:r)||n||r;return l?l.coordsAt(Math.max(0,l==n?s:o),t):Uv(i)}function Uv(i){let e=i.dom.lastChild;if(!e)return i.dom.getBoundingClientRect();let t=yr(e);return t[t.length-1]||null}function Wv(i,e){let t=i.coordsAt(0,1),n=e.coordsAt(0,1);return t&&n&&n.top<t.bottom}function ac(i,e){for(let t in i)t=="class"&&e.class?e.class+=" "+i.class:t=="style"&&e.style?e.style+=";"+i.style:e[t]=i[t];return e}const _u=Object.create(null);function Ro(i,e,t){if(i==e)return!0;i||(i=_u),e||(e=_u);let n=Object.keys(i),s=Object.keys(e);if(n.length-(t&&n.indexOf(t)>-1?1:0)!=s.length-(t&&s.indexOf(t)>-1?1:0))return!1;for(let r of n)if(r!=t&&(s.indexOf(r)==-1||i[r]!==e[r]))return!1;return!0}function lc(i,e,t){let n=!1;if(e)for(let s in e)t&&s in t||(n=!0,s=="style"?i.style.cssText="":i.removeAttribute(s));if(t)for(let s in t)e&&e[s]==t[s]||(n=!0,s=="style"?i.style.cssText=t[s]:i.setAttribute(s,t[s]));return n}function qv(i){let e=Object.create(null);for(let t=0;t<i.attributes.length;t++){let n=i.attributes[t];e[n.name]=n.value}return e}class Ai{eq(e){return!1}updateDOM(e,t){return!1}compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}get estimatedHeight(){return-1}get lineBreaks(){return 0}ignoreEvent(e){return!0}coordsAt(e,t,n){return null}get isHidden(){return!1}get editable(){return!1}destroy(e){}}var vn=(function(i){return i[i.Text=0]="Text",i[i.WidgetBefore=1]="WidgetBefore",i[i.WidgetAfter=2]="WidgetAfter",i[i.WidgetRange=3]="WidgetRange",i})(vn||(vn={}));class ke extends Ws{constructor(e,t,n,s){super(),this.startSide=e,this.endSide=t,this.widget=n,this.spec=s}get heightRelevant(){return!1}static mark(e){return new Mr(e)}static widget(e){let t=Math.max(-1e4,Math.min(1e4,e.side||0)),n=!!e.block;return t+=n&&!e.inlineOrder?t>0?3e8:-4e8:t>0?1e8:-1e8,new ks(e,t,t,n,e.widget||null,!1)}static replace(e){let t=!!e.block,n,s;if(e.isBlockGap)n=-5e8,s=4e8;else{let{start:r,end:o}=yp(e,t);n=(r?t?-3e8:-1:5e8)-1,s=(o?t?2e8:1:-6e8)+1}return new ks(e,n,s,t,e.widget||null,!0)}static line(e){return new Cr(e)}static set(e,t=!1){return _e.of(e,t)}hasHeight(){return this.widget?this.widget.estimatedHeight>-1:!1}}ke.none=_e.empty;class Mr extends ke{constructor(e){let{start:t,end:n}=yp(e);super(t?-1:5e8,n?1:-6e8,null,e),this.tagName=e.tagName||"span",this.class=e.class||"",this.attrs=e.attributes||null}eq(e){var t,n;return this==e||e instanceof Mr&&this.tagName==e.tagName&&(this.class||((t=this.attrs)===null||t===void 0?void 0:t.class))==(e.class||((n=e.attrs)===null||n===void 0?void 0:n.class))&&Ro(this.attrs,e.attrs,"class")}range(e,t=e){if(e>=t)throw new RangeError("Mark decorations may not be empty");return super.range(e,t)}}Mr.prototype.point=!1;class Cr extends ke{constructor(e){super(-2e8,-2e8,null,e)}eq(e){return e instanceof Cr&&this.spec.class==e.spec.class&&Ro(this.spec.attributes,e.spec.attributes)}range(e,t=e){if(t!=e)throw new RangeError("Line decoration ranges must be zero-length");return super.range(e,t)}}Cr.prototype.mapMode=Lt.TrackBefore;Cr.prototype.point=!0;class ks extends ke{constructor(e,t,n,s,r,o){super(t,n,r,e),this.block=s,this.isReplace=o,this.mapMode=s?t<=0?Lt.TrackBefore:Lt.TrackAfter:Lt.TrackDel}get type(){return this.startSide!=this.endSide?vn.WidgetRange:this.startSide<=0?vn.WidgetBefore:vn.WidgetAfter}get heightRelevant(){return this.block||!!this.widget&&(this.widget.estimatedHeight>=5||this.widget.lineBreaks>0)}eq(e){return e instanceof ks&&Hv(this.widget,e.widget)&&this.block==e.block&&this.startSide==e.startSide&&this.endSide==e.endSide}range(e,t=e){if(this.isReplace&&(e>t||e==t&&this.startSide>0&&this.endSide<=0))throw new RangeError("Invalid range for replacement decoration");if(!this.isReplace&&t!=e)throw new RangeError("Widget decorations can only have zero-length ranges");return super.range(e,t)}}ks.prototype.point=!0;function yp(i,e=!1){let{inclusiveStart:t,inclusiveEnd:n}=i;return t==null&&(t=i.inclusive),n==null&&(n=i.inclusive),{start:t??e,end:n??e}}function Hv(i,e){return i==e||!!(i&&e&&i.compare(e))}function vo(i,e,t,n=0){let s=t.length-1;s>=0&&t[s]+n>=i?t[s]=Math.max(t[s],e):t.push(i,e)}class ft extends Ge{constructor(){super(...arguments),this.children=[],this.length=0,this.prevAttrs=void 0,this.attrs=null,this.breakAfter=0}merge(e,t,n,s,r,o){if(n){if(!(n instanceof ft))return!1;this.dom||n.transferDOM(this)}return s&&this.setDeco(n?n.attrs:null),mp(this,e,t,n?n.children.slice():[],r,o),!0}split(e){let t=new ft;if(t.breakAfter=this.breakAfter,this.length==0)return t;let{i:n,off:s}=this.childPos(e);s&&(t.append(this.children[n].split(s),0),this.children[n].merge(s,this.children[n].length,null,!1,0,0),n++);for(let r=n;r<this.children.length;r++)t.append(this.children[r],0);for(;n>0&&this.children[n-1].length==0;)this.children[--n].destroy();return this.children.length=n,this.markDirty(),this.length=e,t}transferDOM(e){this.dom&&(this.markDirty(),e.setDOM(this.dom),e.prevAttrs=this.prevAttrs===void 0?this.attrs:this.prevAttrs,this.prevAttrs=void 0,this.dom=null)}setDeco(e){Ro(this.attrs,e)||(this.dom&&(this.prevAttrs=this.attrs,this.markDirty()),this.attrs=e)}append(e,t){gp(this,e,t)}addLineDeco(e){let t=e.spec.attributes,n=e.spec.class;t&&(this.attrs=ac(t,this.attrs||{})),n&&(this.attrs=ac({class:n},this.attrs||{}))}domAtPos(e){return pp(this,e)}reuseDOM(e){e.nodeName=="DIV"&&(this.setDOM(e),this.flags|=6)}sync(e,t){var n;this.dom?this.flags&4&&(lp(this.dom),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0):(this.setDOM(document.createElement("div")),this.dom.className="cm-line",this.prevAttrs=this.attrs?null:void 0),this.prevAttrs!==void 0&&(lc(this.dom,this.prevAttrs,this.attrs),this.dom.classList.add("cm-line"),this.prevAttrs=void 0),super.sync(e,t);let s=this.dom.lastChild;for(;s&&Ge.get(s)instanceof ls;)s=s.lastChild;if(!s||!this.length||s.nodeName!="BR"&&((n=Ge.get(s))===null||n===void 0?void 0:n.isEditable)==!1&&(!re.ios||!this.children.some(r=>r instanceof Tn))){let r=document.createElement("BR");r.cmIgnore=!0,this.dom.appendChild(r)}}measureTextSize(){if(this.children.length==0||this.length>20)return null;let e=0,t;for(let n of this.children){if(!(n instanceof Tn)||/[^ -~]/.test(n.text))return null;let s=yr(n.dom);if(s.length!=1)return null;e+=s[0].width,t=s[0].height}return e?{lineHeight:this.dom.getBoundingClientRect().height,charWidth:e/this.length,textHeight:t}:null}coordsAt(e,t){let n=Op(this,e,t);if(!this.children.length&&n&&this.parent){let{heightOracle:s}=this.parent.view.viewState,r=n.bottom-n.top;if(Math.abs(r-s.lineHeight)<2&&s.textHeight<r){let o=(r-s.textHeight)/2;return{top:n.top+o,bottom:n.bottom-o,left:n.left,right:n.left}}}return n}become(e){return e instanceof ft&&this.children.length==0&&e.children.length==0&&Ro(this.attrs,e.attrs)&&this.breakAfter==e.breakAfter}covers(){return!0}static find(e,t){for(let n=0,s=0;n<e.children.length;n++){let r=e.children[n],o=s+r.length;if(o>=t){if(r instanceof ft)return r;if(o>t)break}s=o+r.breakAfter}return null}}class as extends Ge{constructor(e,t,n){super(),this.widget=e,this.length=t,this.deco=n,this.breakAfter=0,this.prevWidget=null}merge(e,t,n,s,r,o){return n&&(!(n instanceof as)||!this.widget.compare(n.widget)||e>0&&r<=0||t<this.length&&o<=0)?!1:(this.length=e+(n?n.length:0)+(this.length-t),!0)}domAtPos(e){return e==0?Bt.before(this.dom):Bt.after(this.dom,e==this.length)}split(e){let t=this.length-e;this.length=e;let n=new as(this.widget,t,this.deco);return n.breakAfter=this.breakAfter,n}get children(){return dd}sync(e){(!this.dom||!this.widget.updateDOM(this.dom,e))&&(this.dom&&this.prevWidget&&this.prevWidget.destroy(this.dom),this.prevWidget=null,this.setDOM(this.widget.toDOM(e)),this.widget.editable||(this.dom.contentEditable="false"))}get overrideDOMText(){return this.parent?this.parent.view.state.doc.slice(this.posAtStart,this.posAtEnd):Qe.empty}domBoundsAround(){return null}become(e){return e instanceof as&&e.widget.constructor==this.widget.constructor?(e.widget.compare(this.widget)||this.markDirty(!0),this.dom&&!this.prevWidget&&(this.prevWidget=this.widget),this.widget=e.widget,this.length=e.length,this.deco=e.deco,this.breakAfter=e.breakAfter,!0):!1}ignoreMutation(){return!0}ignoreEvent(e){return this.widget.ignoreEvent(e)}get isEditable(){return!1}get isWidget(){return!0}coordsAt(e,t){let n=this.widget.coordsAt(this.dom,e,t);return n||(this.widget instanceof cc?null:ua(this.dom.getBoundingClientRect(),this.length?e==0:t<=0))}destroy(){super.destroy(),this.dom&&this.widget.destroy(this.dom)}covers(e){let{startSide:t,endSide:n}=this.deco;return t==n?!1:e<0?t<0:n>0}}class cc extends Ai{constructor(e){super(),this.height=e}toDOM(){let e=document.createElement("div");return e.className="cm-gap",this.updateDOM(e),e}eq(e){return e.height==this.height}updateDOM(e){return e.style.height=this.height+"px",!0}get editable(){return!0}get estimatedHeight(){return this.height}ignoreEvent(){return!1}}class lr{constructor(e,t,n,s){this.doc=e,this.pos=t,this.end=n,this.disallowBlockEffectsFor=s,this.content=[],this.curLine=null,this.breakAtStart=0,this.pendingBuffer=0,this.bufferMarks=[],this.atCursorPos=!0,this.openStart=-1,this.openEnd=-1,this.text="",this.textOff=0,this.cursor=e.iter(),this.skip=t}posCovered(){if(this.content.length==0)return!this.breakAtStart&&this.doc.lineAt(this.pos).from!=this.pos;let e=this.content[this.content.length-1];return!(e.breakAfter||e instanceof as&&e.deco.endSide<0)}getLine(){return this.curLine||(this.content.push(this.curLine=new ft),this.atCursorPos=!0),this.curLine}flushBuffer(e=this.bufferMarks){this.pendingBuffer&&(this.curLine.append(Xr(new ki(-1),e),e.length),this.pendingBuffer=0)}addBlockWidget(e){this.flushBuffer(),this.curLine=null,this.content.push(e)}finish(e){this.pendingBuffer&&e<=this.bufferMarks.length?this.flushBuffer():this.pendingBuffer=0,!this.posCovered()&&!(e&&this.content.length&&this.content[this.content.length-1]instanceof as)&&this.getLine()}buildText(e,t,n){for(;e>0;){if(this.textOff==this.text.length){let{value:o,lineBreak:a,done:l}=this.cursor.next(this.skip);if(this.skip=0,l)throw new Error("Ran out of text content when drawing inline views");if(a){this.posCovered()||this.getLine(),this.content.length?this.content[this.content.length-1].breakAfter=1:this.breakAtStart=1,this.flushBuffer(),this.curLine=null,this.atCursorPos=!0,e--;continue}else this.text=o,this.textOff=0}let s=Math.min(this.text.length-this.textOff,e),r=Math.min(s,512);this.flushBuffer(t.slice(t.length-n)),this.getLine().append(Xr(new Tn(this.text.slice(this.textOff,this.textOff+r)),t),n),this.atCursorPos=!0,this.textOff+=r,e-=r,n=s<=r?0:t.length}}span(e,t,n,s){this.buildText(t-e,n,s),this.pos=t,this.openStart<0&&(this.openStart=s)}point(e,t,n,s,r,o){if(this.disallowBlockEffectsFor[o]&&n instanceof ks){if(n.block)throw new RangeError("Block decorations may not be specified via plugins");if(t>this.doc.lineAt(this.pos).to)throw new RangeError("Decorations that replace line breaks may not be specified via plugins")}let a=t-e;if(n instanceof ks)if(n.block)n.startSide>0&&!this.posCovered()&&this.getLine(),this.addBlockWidget(new as(n.widget||xi.block,a,n));else{let l=Ds.create(n.widget||xi.inline,a,a?0:n.startSide),d=this.atCursorPos&&!l.isEditable&&r<=s.length&&(e<t||n.startSide>0),c=!l.isEditable&&(e<t||r>s.length||n.startSide<=0),u=this.getLine();this.pendingBuffer==2&&!d&&!l.isEditable&&(this.pendingBuffer=0),this.flushBuffer(s),d&&(u.append(Xr(new ki(1),s),r),r=s.length+Math.max(0,r-s.length)),u.append(Xr(l,s),r),this.atCursorPos=c,this.pendingBuffer=c?e<t||r>s.length?1:2:0,this.pendingBuffer&&(this.bufferMarks=s.slice())}else this.doc.lineAt(this.pos).from==this.pos&&this.getLine().addLineDeco(n);a&&(this.textOff+a<=this.text.length?this.textOff+=a:(this.skip+=a-(this.text.length-this.textOff),this.text="",this.textOff=0),this.pos=t),this.openStart<0&&(this.openStart=r)}static build(e,t,n,s,r){let o=new lr(e,t,n,r);return o.openEnd=_e.spans(s,t,n,o),o.openStart<0&&(o.openStart=o.openEnd),o.finish(o.openEnd),o}}function Xr(i,e){for(let t of e)i=new ls(t,[i],i.length);return i}class xi extends Ai{constructor(e){super(),this.tag=e}eq(e){return e.tag==this.tag}toDOM(){return document.createElement(this.tag)}updateDOM(e){return e.nodeName.toLowerCase()==this.tag}get isHidden(){return!0}}xi.inline=new xi("span");xi.block=new xi("div");var bt=(function(i){return i[i.LTR=0]="LTR",i[i.RTL=1]="RTL",i})(bt||(bt={}));const Ys=bt.LTR,ud=bt.RTL;function bp(i){let e=[];for(let t=0;t<i.length;t++)e.push(1<<+i[t]);return e}const Yv=bp("88888888888888888888888888888888888666888888787833333333337888888000000000000000000000000008888880000000000000000000000000088888888888888888888888888888888888887866668888088888663380888308888800000000000000000000000800000000000000000000000000000008"),Kv=bp("4444448826627288999999999992222222222222222222222222222222222222222222222229999999999999999999994444444444644222822222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222999999949999999229989999223333333333"),dc=Object.create(null),Bn=[];for(let i of["()","[]","{}"]){let e=i.charCodeAt(0),t=i.charCodeAt(1);dc[e]=t,dc[t]=-e}function vp(i){return i<=247?Yv[i]:1424<=i&&i<=1524?2:1536<=i&&i<=1785?Kv[i-1536]:1774<=i&&i<=2220?4:8192<=i&&i<=8204?256:64336<=i&&i<=65023?4:1}const Jv=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac\ufb50-\ufdff]/;class vs{get dir(){return this.level%2?ud:Ys}constructor(e,t,n){this.from=e,this.to=t,this.level=n}side(e,t){return this.dir==t==e?this.to:this.from}forward(e,t){return e==(this.dir==t)}static find(e,t,n,s){let r=-1;for(let o=0;o<e.length;o++){let a=e[o];if(a.from<=t&&a.to>=t){if(a.level==n)return o;(r<0||(s!=0?s<0?a.from<t:a.to>t:e[r].level>a.level))&&(r=o)}}if(r<0)throw new RangeError("Index out of range");return r}}function wp(i,e){if(i.length!=e.length)return!1;for(let t=0;t<i.length;t++){let n=i[t],s=e[t];if(n.from!=s.from||n.to!=s.to||n.direction!=s.direction||!wp(n.inner,s.inner))return!1}return!0}const Ue=[];function ew(i,e,t,n,s){for(let r=0;r<=n.length;r++){let o=r?n[r-1].to:e,a=r<n.length?n[r].from:t,l=r?256:s;for(let d=o,c=l,u=l;d<a;d++){let h=vp(i.charCodeAt(d));h==512?h=c:h==8&&u==4&&(h=16),Ue[d]=h==4?2:h,h&7&&(u=h),c=h}for(let d=o,c=l,u=l;d<a;d++){let h=Ue[d];if(h==128)d<a-1&&c==Ue[d+1]&&c&24?h=Ue[d]=c:Ue[d]=256;else if(h==64){let f=d+1;for(;f<a&&Ue[f]==64;)f++;let m=d&&c==8||f<t&&Ue[f]==8?u==1?1:8:256;for(let g=d;g<f;g++)Ue[g]=m;d=f-1}else h==8&&u==1&&(Ue[d]=1);c=h,h&7&&(u=h)}}}function tw(i,e,t,n,s){let r=s==1?2:1;for(let o=0,a=0,l=0;o<=n.length;o++){let d=o?n[o-1].to:e,c=o<n.length?n[o].from:t;for(let u=d,h,f,m;u<c;u++)if(f=dc[h=i.charCodeAt(u)])if(f<0){for(let g=a-3;g>=0;g-=3)if(Bn[g+1]==-f){let O=Bn[g+2],p=O&2?s:O&4?O&1?r:s:0;p&&(Ue[u]=Ue[Bn[g]]=p),a=g;break}}else{if(Bn.length==189)break;Bn[a++]=u,Bn[a++]=h,Bn[a++]=l}else if((m=Ue[u])==2||m==1){let g=m==s;l=g?0:1;for(let O=a-3;O>=0;O-=3){let p=Bn[O+2];if(p&2)break;if(g)Bn[O+2]|=2;else{if(p&4)break;Bn[O+2]|=4}}}}}function nw(i,e,t,n){for(let s=0,r=n;s<=t.length;s++){let o=s?t[s-1].to:i,a=s<t.length?t[s].from:e;for(let l=o;l<a;){let d=Ue[l];if(d==256){let c=l+1;for(;;)if(c==a){if(s==t.length)break;c=t[s++].to,a=s<t.length?t[s].from:e}else if(Ue[c]==256)c++;else break;let u=r==1,h=(c<e?Ue[c]:n)==1,f=u==h?u?1:2:n;for(let m=c,g=s,O=g?t[g-1].to:i;m>l;)m==O&&(m=t[--g].from,O=g?t[g-1].to:i),Ue[--m]=f;l=c}else r=d,l++}}}function uc(i,e,t,n,s,r,o){let a=n%2?2:1;if(n%2==s%2)for(let l=e,d=0;l<t;){let c=!0,u=!1;if(d==r.length||l<r[d].from){let g=Ue[l];g!=a&&(c=!1,u=g==16)}let h=!c&&a==1?[]:null,f=c?n:n+1,m=l;e:for(;;)if(d<r.length&&m==r[d].from){if(u)break e;let g=r[d];if(!c)for(let O=g.to,p=d+1;;){if(O==t)break e;if(p<r.length&&r[p].from==O)O=r[p++].to;else{if(Ue[O]==a)break e;break}}if(d++,h)h.push(g);else{g.from>l&&o.push(new vs(l,g.from,f));let O=g.direction==Ys!=!(f%2);hc(i,O?n+1:n,s,g.inner,g.from,g.to,o),l=g.to}m=g.to}else{if(m==t||(c?Ue[m]!=a:Ue[m]==a))break;m++}h?uc(i,l,m,n+1,s,h,o):l<m&&o.push(new vs(l,m,f)),l=m}else for(let l=t,d=r.length;l>e;){let c=!0,u=!1;if(!d||l>r[d-1].to){let g=Ue[l-1];g!=a&&(c=!1,u=g==16)}let h=!c&&a==1?[]:null,f=c?n:n+1,m=l;e:for(;;)if(d&&m==r[d-1].to){if(u)break e;let g=r[--d];if(!c)for(let O=g.from,p=d;;){if(O==e)break e;if(p&&r[p-1].to==O)O=r[--p].from;else{if(Ue[O-1]==a)break e;break}}if(h)h.push(g);else{g.to<l&&o.push(new vs(g.to,l,f));let O=g.direction==Ys!=!(f%2);hc(i,O?n+1:n,s,g.inner,g.from,g.to,o),l=g.from}m=g.from}else{if(m==e||(c?Ue[m-1]!=a:Ue[m-1]==a))break;m--}h?uc(i,m,l,n+1,s,h,o):m<l&&o.push(new vs(m,l,f)),l=m}}function hc(i,e,t,n,s,r,o){let a=e%2?2:1;ew(i,s,r,n,a),tw(i,s,r,n,a),nw(s,r,n,a),uc(i,s,r,e,t,n,o)}function sw(i,e,t){if(!i)return[new vs(0,0,e==ud?1:0)];if(e==Ys&&!t.length&&!Jv.test(i))return Pp(i.length);if(t.length)for(;i.length>Ue.length;)Ue[Ue.length]=256;let n=[],s=e==Ys?0:1;return hc(i,s,s,t,0,i.length,n),n}function Pp(i){return[new vs(0,i,0)]}let Sp="";function iw(i,e,t,n,s){var r;let o=n.head-i.from,a=vs.find(e,o,(r=n.bidiLevel)!==null&&r!==void 0?r:-1,n.assoc),l=e[a],d=l.side(s,t);if(o==d){let h=a+=s?1:-1;if(h<0||h>=e.length)return null;l=e[a=h],o=l.side(!s,t),d=l.side(s,t)}let c=Xt(i.text,o,l.forward(s,t));(c<l.from||c>l.to)&&(c=d),Sp=i.text.slice(Math.min(o,c),Math.max(o,c));let u=a==(s?e.length-1:0)?null:e[a+(s?1:-1)];return u&&c==d&&u.level+(s?0:1)<l.level?j.cursor(u.side(!s,t)+i.from,u.forward(s,t)?1:-1,u.level):j.cursor(c+i.from,l.forward(s,t)?-1:1,l.level)}function rw(i,e,t){for(let n=e;n<t;n++){let s=vp(i.charCodeAt(n));if(s==1)return Ys;if(s==2||s==4)return ud}return Ys}const kp=he.define(),xp=he.define(),$p=he.define(),Mp=he.define(),fc=he.define(),Cp=he.define(),Ep=he.define(),hd=he.define(),fd=he.define(),Ap=he.define({combine:i=>i.some(e=>e)}),ow=he.define({combine:i=>i.some(e=>e)}),Tp=he.define();class vi{constructor(e,t="nearest",n="nearest",s=5,r=5,o=!1){this.range=e,this.y=t,this.x=n,this.yMargin=s,this.xMargin=r,this.isSnapshot=o}map(e){return e.empty?this:new vi(this.range.map(e),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}clip(e){return this.range.to<=e.doc.length?this:new vi(j.cursor(e.doc.length),this.y,this.x,this.yMargin,this.xMargin,this.isSnapshot)}}const Ur=Ve.define({map:(i,e)=>i.map(e)}),Np=Ve.define();function Gn(i,e,t){let n=i.facet(Mp);n.length?n[0](e):window.onerror&&window.onerror(String(e),t,void 0,void 0,e)||(t?console.error(t+":",e):console.error(e))}const rs=he.define({combine:i=>i.length?i[0]:!0});let aw=0;const pi=he.define({combine(i){return i.filter((e,t)=>{for(let n=0;n<t;n++)if(i[n].plugin==e.plugin)return!1;return!0})}});class ts{constructor(e,t,n,s,r){this.id=e,this.create=t,this.domEventHandlers=n,this.domEventObservers=s,this.baseExtensions=r(this),this.extension=this.baseExtensions.concat(pi.of({plugin:this,arg:void 0}))}of(e){return this.baseExtensions.concat(pi.of({plugin:this,arg:e}))}static define(e,t){const{eventHandlers:n,eventObservers:s,provide:r,decorations:o}=t||{};return new ts(aw++,e,n,s,a=>{let l=[];return o&&l.push(br.of(d=>{let c=d.plugin(a);return c?o(c):ke.none})),r&&l.push(r(a)),l})}static fromClass(e,t){return ts.define((n,s)=>new e(n,s),t)}}class za{constructor(e){this.spec=e,this.mustUpdate=null,this.value=null}get plugin(){return this.spec&&this.spec.plugin}update(e){if(this.value){if(this.mustUpdate){let t=this.mustUpdate;if(this.mustUpdate=null,this.value.update)try{this.value.update(t)}catch(n){if(Gn(t.state,n,"CodeMirror plugin crashed"),this.value.destroy)try{this.value.destroy()}catch{}this.deactivate()}}}else if(this.spec)try{this.value=this.spec.plugin.create(e,this.spec.arg)}catch(t){Gn(e.state,t,"CodeMirror plugin crashed"),this.deactivate()}return this}destroy(e){var t;if(!((t=this.value)===null||t===void 0)&&t.destroy)try{this.value.destroy()}catch(n){Gn(e.state,n,"CodeMirror plugin crashed")}}deactivate(){this.spec=this.value=null}}const Qp=he.define(),md=he.define(),br=he.define(),Rp=he.define(),Er=he.define(),_p=he.define();function Iu(i,e){let t=i.state.facet(_p);if(!t.length)return t;let n=t.map(r=>r instanceof Function?r(i):r),s=[];return _e.spans(n,e.from,e.to,{point(){},span(r,o,a,l){let d=r-e.from,c=o-e.from,u=s;for(let h=a.length-1;h>=0;h--,l--){let f=a[h].spec.bidiIsolate,m;if(f==null&&(f=rw(e.text,d,c)),l>0&&u.length&&(m=u[u.length-1]).to==d&&m.direction==f)m.to=c,u=m.inner;else{let g={from:d,to:c,direction:f,inner:[]};u.push(g),u=g.inner}}}}),s}const Ip=he.define();function Lp(i){let e=0,t=0,n=0,s=0;for(let r of i.state.facet(Ip)){let o=r(i);o&&(o.left!=null&&(e=Math.max(e,o.left)),o.right!=null&&(t=Math.max(t,o.right)),o.top!=null&&(n=Math.max(n,o.top)),o.bottom!=null&&(s=Math.max(s,o.bottom)))}return{left:e,right:t,top:n,bottom:s}}const er=he.define();class wn{constructor(e,t,n,s){this.fromA=e,this.toA=t,this.fromB=n,this.toB=s}join(e){return new wn(Math.min(this.fromA,e.fromA),Math.max(this.toA,e.toA),Math.min(this.fromB,e.fromB),Math.max(this.toB,e.toB))}addToSet(e){let t=e.length,n=this;for(;t>0;t--){let s=e[t-1];if(!(s.fromA>n.toA)){if(s.toA<n.fromA)break;n=n.join(s),e.splice(t-1,1)}}return e.splice(t,0,n),e}static extendWithRanges(e,t){if(t.length==0)return e;let n=[];for(let s=0,r=0,o=0,a=0;;s++){let l=s==e.length?null:e[s],d=o-a,c=l?l.fromB:1e9;for(;r<t.length&&t[r]<c;){let u=t[r],h=t[r+1],f=Math.max(a,u),m=Math.min(c,h);if(f<=m&&new wn(f+d,m+d,f,m).addToSet(n),h>c)break;r+=2}if(!l)return n;new wn(l.fromA,l.toA,l.fromB,l.toB).addToSet(n),o=l.toA,a=l.toB}}}class _o{constructor(e,t,n){this.view=e,this.state=t,this.transactions=n,this.flags=0,this.startState=e.state,this.changes=Ot.empty(this.startState.doc.length);for(let r of n)this.changes=this.changes.compose(r.changes);let s=[];this.changes.iterChangedRanges((r,o,a,l)=>s.push(new wn(r,o,a,l))),this.changedRanges=s}static create(e,t,n){return new _o(e,t,n)}get viewportChanged(){return(this.flags&4)>0}get viewportMoved(){return(this.flags&8)>0}get heightChanged(){return(this.flags&2)>0}get geometryChanged(){return this.docChanged||(this.flags&18)>0}get focusChanged(){return(this.flags&1)>0}get docChanged(){return!this.changes.empty}get selectionSet(){return this.transactions.some(e=>e.selection)}get empty(){return this.flags==0&&this.transactions.length==0}}class Lu extends Ge{get length(){return this.view.state.doc.length}constructor(e){super(),this.view=e,this.decorations=[],this.dynamicDecorationMap=[!1],this.domChanged=null,this.hasComposition=null,this.markedForComposition=new Set,this.editContextFormatting=ke.none,this.lastCompositionAfterCursor=!1,this.minWidth=0,this.minWidthFrom=0,this.minWidthTo=0,this.impreciseAnchor=null,this.impreciseHead=null,this.forceSelection=!1,this.lastUpdate=Date.now(),this.setDOM(e.contentDOM),this.children=[new ft],this.children[0].setParent(this),this.updateDeco(),this.updateInner([new wn(0,0,0,e.state.doc.length)],0,null)}update(e){var t;let n=e.changedRanges;this.minWidth>0&&n.length&&(n.every(({fromA:d,toA:c})=>c<this.minWidthFrom||d>this.minWidthTo)?(this.minWidthFrom=e.changes.mapPos(this.minWidthFrom,1),this.minWidthTo=e.changes.mapPos(this.minWidthTo,1)):this.minWidth=this.minWidthFrom=this.minWidthTo=0),this.updateEditContextFormatting(e);let s=-1;this.view.inputState.composing>=0&&!this.view.observer.editContext&&(!((t=this.domChanged)===null||t===void 0)&&t.newSel?s=this.domChanged.newSel.head:!mw(e.changes,this.hasComposition)&&!e.selectionSet&&(s=e.state.selection.main.head));let r=s>-1?cw(this.view,e.changes,s):null;if(this.domChanged=null,this.hasComposition){this.markedForComposition.clear();let{from:d,to:c}=this.hasComposition;n=new wn(d,c,e.changes.mapPos(d,-1),e.changes.mapPos(c,1)).addToSet(n.slice())}this.hasComposition=r?{from:r.range.fromB,to:r.range.toB}:null,(re.ie||re.chrome)&&!r&&e&&e.state.doc.lines!=e.startState.doc.lines&&(this.forceSelection=!0);let o=this.decorations,a=this.updateDeco(),l=hw(o,a,e.changes);return n=wn.extendWithRanges(n,l),!(this.flags&7)&&n.length==0?!1:(this.updateInner(n,e.startState.doc.length,r),e.transactions.length&&(this.lastUpdate=Date.now()),!0)}updateInner(e,t,n){this.view.viewState.mustMeasureContent=!0,this.updateChildren(e,t,n);let{observer:s}=this.view;s.ignore(()=>{this.dom.style.height=this.view.viewState.contentHeight/this.view.scaleY+"px",this.dom.style.flexBasis=this.minWidth?this.minWidth+"px":"";let o=re.chrome||re.ios?{node:s.selectionRange.focusNode,written:!1}:void 0;this.sync(this.view,o),this.flags&=-8,o&&(o.written||s.selectionRange.focusNode!=o.node)&&(this.forceSelection=!0),this.dom.style.height=""}),this.markedForComposition.forEach(o=>o.flags&=-9);let r=[];if(this.view.viewport.from||this.view.viewport.to<this.view.state.doc.length)for(let o of this.children)o instanceof as&&o.widget instanceof cc&&r.push(o.dom);s.updateGaps(r)}updateChildren(e,t,n){let s=n?n.range.addToSet(e.slice()):e,r=this.childCursor(t);for(let o=s.length-1;;o--){let a=o>=0?s[o]:null;if(!a)break;let{fromA:l,toA:d,fromB:c,toB:u}=a,h,f,m,g;if(n&&n.range.fromB<u&&n.range.toB>c){let b=lr.build(this.view.state.doc,c,n.range.fromB,this.decorations,this.dynamicDecorationMap),S=lr.build(this.view.state.doc,n.range.toB,u,this.decorations,this.dynamicDecorationMap);f=b.breakAtStart,m=b.openStart,g=S.openEnd;let k=this.compositionView(n);S.breakAtStart?k.breakAfter=1:S.content.length&&k.merge(k.length,k.length,S.content[0],!1,S.openStart,0)&&(k.breakAfter=S.content[0].breakAfter,S.content.shift()),b.content.length&&k.merge(0,0,b.content[b.content.length-1],!0,0,b.openEnd)&&b.content.pop(),h=b.content.concat(k).concat(S.content)}else({content:h,breakAtStart:f,openStart:m,openEnd:g}=lr.build(this.view.state.doc,c,u,this.decorations,this.dynamicDecorationMap));let{i:O,off:p}=r.findPos(d,1),{i:y,off:M}=r.findPos(l,-1);fp(this,y,M,O,p,h,f,m,g)}n&&this.fixCompositionDOM(n)}updateEditContextFormatting(e){this.editContextFormatting=this.editContextFormatting.map(e.changes);for(let t of e.transactions)for(let n of t.effects)n.is(Np)&&(this.editContextFormatting=n.value)}compositionView(e){let t=new Tn(e.text.nodeValue);t.flags|=8;for(let{deco:s}of e.marks)t=new ls(s,[t],t.length);let n=new ft;return n.append(t,0),n}fixCompositionDOM(e){let t=(r,o)=>{o.flags|=8|(o.children.some(l=>l.flags&7)?1:0),this.markedForComposition.add(o);let a=Ge.get(r);a&&a!=o&&(a.dom=null),o.setDOM(r)},n=this.childPos(e.range.fromB,1),s=this.children[n.i];t(e.line,s);for(let r=e.marks.length-1;r>=-1;r--)n=s.childPos(n.off,1),s=s.children[n.i],t(r>=0?e.marks[r].node:e.text,s)}updateSelection(e=!1,t=!1){(e||!this.view.observer.selectionRange.focusNode)&&this.view.observer.readSelectionRange();let n=this.view.root.activeElement,s=n==this.dom,r=!s&&!(this.view.state.facet(rs)||this.dom.tabIndex>-1)&&bo(this.dom,this.view.observer.selectionRange)&&!(n&&this.dom.contains(n));if(!(s||t||r))return;let o=this.forceSelection;this.forceSelection=!1;let a=this.view.state.selection.main,l=this.moveToLine(this.domAtPos(a.anchor)),d=a.empty?l:this.moveToLine(this.domAtPos(a.head));if(re.gecko&&a.empty&&!this.hasComposition&&lw(l)){let u=document.createTextNode("");this.view.observer.ignore(()=>l.node.insertBefore(u,l.node.childNodes[l.offset]||null)),l=d=new Bt(u,0),o=!0}let c=this.view.observer.selectionRange;(o||!c.focusNode||(!ar(l.node,l.offset,c.anchorNode,c.anchorOffset)||!ar(d.node,d.offset,c.focusNode,c.focusOffset))&&!this.suppressWidgetCursorChange(c,a))&&(this.view.observer.ignore(()=>{re.android&&re.chrome&&this.dom.contains(c.focusNode)&&fw(c.focusNode,this.dom)&&(this.dom.blur(),this.dom.focus({preventScroll:!0}));let u=Or(this.view.root);if(u)if(a.empty){if(re.gecko){let h=dw(l.node,l.offset);if(h&&h!=3){let f=(h==1?dp:up)(l.node,l.offset);f&&(l=new Bt(f.node,f.offset))}}u.collapse(l.node,l.offset),a.bidiLevel!=null&&u.caretBidiLevel!==void 0&&(u.caretBidiLevel=a.bidiLevel)}else if(u.extend){u.collapse(l.node,l.offset);try{u.extend(d.node,d.offset)}catch{}}else{let h=document.createRange();a.anchor>a.head&&([l,d]=[d,l]),h.setEnd(d.node,d.offset),h.setStart(l.node,l.offset),u.removeAllRanges(),u.addRange(h)}r&&this.view.root.activeElement==this.dom&&(this.dom.blur(),n&&n.focus())}),this.view.observer.setSelectionRange(l,d)),this.impreciseAnchor=l.precise?null:new Bt(c.anchorNode,c.anchorOffset),this.impreciseHead=d.precise?null:new Bt(c.focusNode,c.focusOffset)}suppressWidgetCursorChange(e,t){return this.hasComposition&&t.empty&&ar(e.focusNode,e.focusOffset,e.anchorNode,e.anchorOffset)&&this.posFromDOM(e.focusNode,e.focusOffset)==t.head}enforceCursorAssoc(){if(this.hasComposition)return;let{view:e}=this,t=e.state.selection.main,n=Or(e.root),{anchorNode:s,anchorOffset:r}=e.observer.selectionRange;if(!n||!t.empty||!t.assoc||!n.modify)return;let o=ft.find(this,t.head);if(!o)return;let a=o.posAtStart;if(t.head==a||t.head==a+o.length)return;let l=this.coordsAt(t.head,-1),d=this.coordsAt(t.head,1);if(!l||!d||l.bottom>d.top)return;let c=this.domAtPos(t.head+t.assoc);n.collapse(c.node,c.offset),n.modify("move",t.assoc<0?"forward":"backward","lineboundary"),e.observer.readSelectionRange();let u=e.observer.selectionRange;e.docView.posFromDOM(u.anchorNode,u.anchorOffset)!=t.from&&n.collapse(s,r)}moveToLine(e){let t=this.dom,n;if(e.node!=t)return e;for(let s=e.offset;!n&&s<t.childNodes.length;s++){let r=Ge.get(t.childNodes[s]);r instanceof ft&&(n=r.domAtPos(0))}for(let s=e.offset-1;!n&&s>=0;s--){let r=Ge.get(t.childNodes[s]);r instanceof ft&&(n=r.domAtPos(r.length))}return n?new Bt(n.node,n.offset,!0):e}nearest(e){for(let t=e;t;){let n=Ge.get(t);if(n&&n.rootView==this)return n;t=t.parentNode}return null}posFromDOM(e,t){let n=this.nearest(e);if(!n)throw new RangeError("Trying to find position for a DOM position outside of the document");return n.localPosFromDOM(e,t)+n.posAtStart}domAtPos(e){let{i:t,off:n}=this.childCursor().findPos(e,-1);for(;t<this.children.length-1;){let s=this.children[t];if(n<s.length||s instanceof ft)break;t++,n=0}return this.children[t].domAtPos(n)}coordsAt(e,t){let n=null,s=0;for(let r=this.length,o=this.children.length-1;o>=0;o--){let a=this.children[o],l=r-a.breakAfter,d=l-a.length;if(l<e)break;if(d<=e&&(d<e||a.covers(-1))&&(l>e||a.covers(1))&&(!n||a instanceof ft&&!(n instanceof ft&&t>=0)))n=a,s=d;else if(n&&d==e&&l==e&&a instanceof as&&Math.abs(t)<2){if(a.deco.startSide<0)break;o&&(n=null)}r=d}return n?n.coordsAt(e-s,t):null}coordsForChar(e){let{i:t,off:n}=this.childPos(e,1),s=this.children[t];if(!(s instanceof ft))return null;for(;s.children.length;){let{i:a,off:l}=s.childPos(n,1);for(;;a++){if(a==s.children.length)return null;if((s=s.children[a]).length)break}n=l}if(!(s instanceof Tn))return null;let r=Xt(s.text,n);if(r==n)return null;let o=Hs(s.dom,n,r).getClientRects();for(let a=0;a<o.length;a++){let l=o[a];if(a==o.length-1||l.top<l.bottom&&l.left<l.right)return l}return null}measureVisibleLineHeights(e){let t=[],{from:n,to:s}=e,r=this.view.contentDOM.clientWidth,o=r>Math.max(this.view.scrollDOM.clientWidth,this.minWidth)+1,a=-1,l=this.view.textDirection==bt.LTR;for(let d=0,c=0;c<this.children.length;c++){let u=this.children[c],h=d+u.length;if(h>s)break;if(d>=n){let f=u.dom.getBoundingClientRect();if(t.push(f.height),o){let m=u.dom.lastChild,g=m?yr(m):[];if(g.length){let O=g[g.length-1],p=l?O.right-f.left:f.right-O.left;p>a&&(a=p,this.minWidth=r,this.minWidthFrom=d,this.minWidthTo=h)}}}d=h+u.breakAfter}return t}textDirectionAt(e){let{i:t}=this.childPos(e,1);return getComputedStyle(this.children[t].dom).direction=="rtl"?bt.RTL:bt.LTR}measureTextSize(){for(let r of this.children)if(r instanceof ft){let o=r.measureTextSize();if(o)return o}let e=document.createElement("div"),t,n,s;return e.className="cm-line",e.style.width="99999px",e.style.position="absolute",e.textContent="abc def ghi jkl mno pqr stu",this.view.observer.ignore(()=>{this.dom.appendChild(e);let r=yr(e.firstChild)[0];t=e.getBoundingClientRect().height,n=r?r.width/27:7,s=r?r.height:t,e.remove()}),{lineHeight:t,charWidth:n,textHeight:s}}childCursor(e=this.length){let t=this.children.length;return t&&(e-=this.children[--t].length),new hp(this.children,e,t)}computeBlockGapDeco(){let e=[],t=this.view.viewState;for(let n=0,s=0;;s++){let r=s==t.viewports.length?null:t.viewports[s],o=r?r.from-1:this.length;if(o>n){let a=(t.lineBlockAt(o).bottom-t.lineBlockAt(n).top)/this.view.scaleY;e.push(ke.replace({widget:new cc(a),block:!0,inclusive:!0,isBlockGap:!0}).range(n,o))}if(!r)break;n=r.to+1}return ke.set(e)}updateDeco(){let e=1,t=this.view.state.facet(br).map(r=>(this.dynamicDecorationMap[e++]=typeof r=="function")?r(this.view):r),n=!1,s=this.view.state.facet(Rp).map((r,o)=>{let a=typeof r=="function";return a&&(n=!0),a?r(this.view):r});for(s.length&&(this.dynamicDecorationMap[e++]=n,t.push(_e.join(s))),this.decorations=[this.editContextFormatting,...t,this.computeBlockGapDeco(),this.view.viewState.lineGapDeco];e<this.decorations.length;)this.dynamicDecorationMap[e++]=!1;return this.decorations}scrollIntoView(e){if(e.isSnapshot){let d=this.view.viewState.lineBlockAt(e.range.head);this.view.scrollDOM.scrollTop=d.top-e.yMargin,this.view.scrollDOM.scrollLeft=e.xMargin;return}for(let d of this.view.state.facet(Tp))try{if(d(this.view,e.range,e))return!0}catch(c){Gn(this.view.state,c,"scroll handler")}let{range:t}=e,n=this.coordsAt(t.head,t.empty?t.assoc:t.head>t.anchor?-1:1),s;if(!n)return;!t.empty&&(s=this.coordsAt(t.anchor,t.anchor>t.head?-1:1))&&(n={left:Math.min(n.left,s.left),top:Math.min(n.top,s.top),right:Math.max(n.right,s.right),bottom:Math.max(n.bottom,s.bottom)});let r=Lp(this.view),o={left:n.left-r.left,top:n.top-r.top,right:n.right+r.right,bottom:n.bottom+r.bottom},{offsetWidth:a,offsetHeight:l}=this.view.scrollDOM;zv(this.view.scrollDOM,o,t.head<t.anchor?-1:1,e.x,e.y,Math.max(Math.min(e.xMargin,a),-a),Math.max(Math.min(e.yMargin,l),-l),this.view.textDirection==bt.LTR)}}function lw(i){return i.node.nodeType==1&&i.node.firstChild&&(i.offset==0||i.node.childNodes[i.offset-1].contentEditable=="false")&&(i.offset==i.node.childNodes.length||i.node.childNodes[i.offset].contentEditable=="false")}function Bp(i,e){let t=i.observer.selectionRange;if(!t.focusNode)return null;let n=dp(t.focusNode,t.focusOffset),s=up(t.focusNode,t.focusOffset),r=n||s;if(s&&n&&s.node!=n.node){let a=Ge.get(s.node);if(!a||a instanceof Tn&&a.text!=s.node.nodeValue)r=s;else if(i.docView.lastCompositionAfterCursor){let l=Ge.get(n.node);!l||l instanceof Tn&&l.text!=n.node.nodeValue||(r=s)}}if(i.docView.lastCompositionAfterCursor=r!=n,!r)return null;let o=e-r.offset;return{from:o,to:o+r.node.nodeValue.length,node:r.node}}function cw(i,e,t){let n=Bp(i,t);if(!n)return null;let{node:s,from:r,to:o}=n,a=s.nodeValue;if(/[\n\r]/.test(a)||i.state.doc.sliceString(n.from,n.to)!=a)return null;let l=e.invertedDesc,d=new wn(l.mapPos(r),l.mapPos(o),r,o),c=[];for(let u=s.parentNode;;u=u.parentNode){let h=Ge.get(u);if(h instanceof ls)c.push({node:u,deco:h.mark});else{if(h instanceof ft||u.nodeName=="DIV"&&u.parentNode==i.contentDOM)return{range:d,text:s,marks:c,line:u};if(u!=i.contentDOM)c.push({node:u,deco:new Mr({inclusive:!0,attributes:qv(u),tagName:u.tagName.toLowerCase()})});else return null}}}function dw(i,e){return i.nodeType!=1?0:(e&&i.childNodes[e-1].contentEditable=="false"?1:0)|(e<i.childNodes.length&&i.childNodes[e].contentEditable=="false"?2:0)}let uw=class{constructor(){this.changes=[]}compareRange(e,t){vo(e,t,this.changes)}comparePoint(e,t){vo(e,t,this.changes)}boundChange(e){vo(e,e,this.changes)}};function hw(i,e,t){let n=new uw;return _e.compare(i,e,t,n),n.changes}function fw(i,e){for(let t=i;t&&t!=e;t=t.assignedSlot||t.parentNode)if(t.nodeType==1&&t.contentEditable=="false")return!0;return!1}function mw(i,e){let t=!1;return e&&i.iterChangedRanges((n,s)=>{n<e.to&&s>e.from&&(t=!0)}),t}function pw(i,e,t=1){let n=i.charCategorizer(e),s=i.doc.lineAt(e),r=e-s.from;if(s.length==0)return j.cursor(e);r==0?t=1:r==s.length&&(t=-1);let o=r,a=r;t<0?o=Xt(s.text,r,!1):a=Xt(s.text,r);let l=n(s.text.slice(o,a));for(;o>0;){let d=Xt(s.text,o,!1);if(n(s.text.slice(d,o))!=l)break;o=d}for(;a<s.length;){let d=Xt(s.text,a);if(n(s.text.slice(a,d))!=l)break;a=d}return j.range(o+s.from,a+s.from)}function gw(i,e){return e.left>i?e.left-i:Math.max(0,i-e.right)}function Ow(i,e){return e.top>i?e.top-i:Math.max(0,i-e.bottom)}function Va(i,e){return i.top<e.bottom-1&&i.bottom>e.top+1}function Bu(i,e){return e<i.top?{top:e,left:i.left,right:i.right,bottom:i.bottom}:i}function Du(i,e){return e>i.bottom?{top:i.top,left:i.left,right:i.right,bottom:e}:i}function mc(i,e,t){let n,s,r,o,a=!1,l,d,c,u;for(let m=i.firstChild;m;m=m.nextSibling){let g=yr(m);for(let O=0;O<g.length;O++){let p=g[O];s&&Va(s,p)&&(p=Bu(Du(p,s.bottom),s.top));let y=gw(e,p),M=Ow(t,p);if(y==0&&M==0)return m.nodeType==3?zu(m,e,t):mc(m,e,t);(!n||o>M||o==M&&r>y)&&(n=m,s=p,r=y,o=M,a=y?e<p.left?O>0:O<g.length-1:!0),y==0?t>p.bottom&&(!c||c.bottom<p.bottom)?(l=m,c=p):t<p.top&&(!u||u.top>p.top)&&(d=m,u=p):c&&Va(c,p)?c=Du(c,p.bottom):u&&Va(u,p)&&(u=Bu(u,p.top))}}if(c&&c.bottom>=t?(n=l,s=c):u&&u.top<=t&&(n=d,s=u),!n)return{node:i,offset:0};let h=Math.max(s.left,Math.min(s.right,e));if(n.nodeType==3)return zu(n,h,t);if(a&&n.contentEditable!="false")return mc(n,h,t);let f=Array.prototype.indexOf.call(i.childNodes,n)+(e>=(s.left+s.right)/2?1:0);return{node:i,offset:f}}function zu(i,e,t){let n=i.nodeValue.length,s=-1,r=1e9,o=0;for(let a=0;a<n;a++){let l=Hs(i,a,a+1).getClientRects();for(let d=0;d<l.length;d++){let c=l[d];if(c.top==c.bottom)continue;o||(o=e-c.left);let u=(c.top>t?c.top-t:t-c.bottom)-1;if(c.left-1<=e&&c.right+1>=e&&u<r){let h=e>=(c.left+c.right)/2,f=h;if((re.chrome||re.gecko)&&Hs(i,a).getBoundingClientRect().left==c.right&&(f=!h),u<=0)return{node:i,offset:a+(f?1:0)};s=a+(f?1:0),r=u}}}return{node:i,offset:s>-1?s:o>0?i.nodeValue.length:0}}function Dp(i,e,t,n=-1){var s,r;let o=i.contentDOM.getBoundingClientRect(),a=o.top+i.viewState.paddingTop,l,{docHeight:d}=i.viewState,{x:c,y:u}=e,h=u-a;if(h<0)return 0;if(h>d)return i.state.doc.length;for(let b=i.viewState.heightOracle.textHeight/2,S=!1;l=i.elementAtHeight(h),l.type!=vn.Text;)for(;h=n>0?l.bottom+b:l.top-b,!(h>=0&&h<=d);){if(S)return t?null:0;S=!0,n=-n}u=a+h;let f=l.from;if(f<i.viewport.from)return i.viewport.from==0?0:t?null:Vu(i,o,l,c,u);if(f>i.viewport.to)return i.viewport.to==i.state.doc.length?i.state.doc.length:t?null:Vu(i,o,l,c,u);let m=i.dom.ownerDocument,g=i.root.elementFromPoint?i.root:m,O=g.elementFromPoint(c,u);O&&!i.contentDOM.contains(O)&&(O=null),O||(c=Math.max(o.left+1,Math.min(o.right-1,c)),O=g.elementFromPoint(c,u),O&&!i.contentDOM.contains(O)&&(O=null));let p,y=-1;if(O&&((s=i.docView.nearest(O))===null||s===void 0?void 0:s.isEditable)!=!1){if(m.caretPositionFromPoint){let b=m.caretPositionFromPoint(c,u);b&&({offsetNode:p,offset:y}=b)}else if(m.caretRangeFromPoint){let b=m.caretRangeFromPoint(c,u);b&&({startContainer:p,startOffset:y}=b)}p&&(!i.contentDOM.contains(p)||re.safari&&yw(p,y,c)||re.chrome&&bw(p,y,c))&&(p=void 0),p&&(y=Math.min(es(p),y))}if(!p||!i.docView.dom.contains(p)){let b=ft.find(i.docView,f);if(!b)return h>l.top+l.height/2?l.to:l.from;({node:p,offset:y}=mc(b.dom,c,u))}let M=i.docView.nearest(p);if(!M)return null;if(M.isWidget&&((r=M.dom)===null||r===void 0?void 0:r.nodeType)==1){let b=M.dom.getBoundingClientRect();return e.y<b.top||e.y<=b.bottom&&e.x<=(b.left+b.right)/2?M.posAtStart:M.posAtEnd}else return M.localPosFromDOM(p,y)+M.posAtStart}function Vu(i,e,t,n,s){let r=Math.round((n-e.left)*i.defaultCharacterWidth);if(i.lineWrapping&&t.height>i.defaultLineHeight*1.5){let a=i.viewState.heightOracle.textHeight,l=Math.floor((s-t.top-(i.defaultLineHeight-a)*.5)/a);r+=l*i.viewState.heightOracle.lineLength}let o=i.state.sliceDoc(t.from,t.to);return t.from+Qv(o,r,i.state.tabSize)}function zp(i,e,t){let n,s=i;if(i.nodeType!=3||e!=(n=i.nodeValue.length))return!1;for(;;){let r=s.nextSibling;if(r){if(r.nodeName=="BR")break;return!1}else{let o=s.parentNode;if(!o||o.nodeName=="DIV")break;s=o}}return Hs(i,n-1,n).getBoundingClientRect().right>t}function yw(i,e,t){return zp(i,e,t)}function bw(i,e,t){if(e!=0)return zp(i,e,t);for(let s=i;;){let r=s.parentNode;if(!r||r.nodeType!=1||r.firstChild!=s)return!1;if(r.classList.contains("cm-line"))break;s=r}let n=i.nodeType==1?i.getBoundingClientRect():Hs(i,0,Math.max(i.nodeValue.length,1)).getBoundingClientRect();return t-n.left>5}function vw(i,e,t){let n=i.lineBlockAt(e);if(Array.isArray(n.type)){let s;for(let r of n.type){if(r.from>e)break;if(!(r.to<e)){if(r.from<e&&r.to>e)return r;(!s||r.type==vn.Text&&(s.type!=r.type||(t<0?r.from<e:r.to>e)))&&(s=r)}}return s||n}return n}function ww(i,e,t,n){let s=vw(i,e.head,e.assoc||-1),r=!n||s.type!=vn.Text||!(i.lineWrapping||s.widgetLineBreaks)?null:i.coordsAtPos(e.assoc<0&&e.head>s.from?e.head-1:e.head);if(r){let o=i.dom.getBoundingClientRect(),a=i.textDirectionAt(s.from),l=i.posAtCoords({x:t==(a==bt.LTR)?o.right-1:o.left+1,y:(r.top+r.bottom)/2});if(l!=null)return j.cursor(l,t?-1:1)}return j.cursor(t?s.to:s.from,t?-1:1)}function Zu(i,e,t,n){let s=i.state.doc.lineAt(e.head),r=i.bidiSpans(s),o=i.textDirectionAt(s.from);for(let a=e,l=null;;){let d=iw(s,r,o,a,t),c=Sp;if(!d){if(s.number==(t?i.state.doc.lines:1))return a;c=`
`,s=i.state.doc.line(s.number+(t?1:-1)),r=i.bidiSpans(s),d=i.visualLineSide(s,!t)}if(l){if(!l(c))return a}else{if(!n)return d;l=n(c)}a=d}}function Pw(i,e,t){let n=i.state.charCategorizer(e),s=n(t);return r=>{let o=n(r);return s==Dt.Space&&(s=o),s==o}}function Sw(i,e,t,n){let s=e.head,r=t?1:-1;if(s==(t?i.state.doc.length:0))return j.cursor(s,e.assoc);let o=e.goalColumn,a,l=i.contentDOM.getBoundingClientRect(),d=i.coordsAtPos(s,e.assoc||-1),c=i.documentTop;if(d)o==null&&(o=d.left-l.left),a=r<0?d.top:d.bottom;else{let f=i.viewState.lineBlockAt(s);o==null&&(o=Math.min(l.right-l.left,i.defaultCharacterWidth*(s-f.from))),a=(r<0?f.top:f.bottom)+c}let u=l.left+o,h=n??i.viewState.heightOracle.textHeight>>1;for(let f=0;;f+=10){let m=a+(h+f)*r,g=Dp(i,{x:u,y:m},!1,r);if(m<l.top||m>l.bottom||(r<0?g<s:g>s)){let O=i.docView.coordsForChar(g),p=!O||m<O.top?-1:1;return j.cursor(g,p,void 0,o)}}}function cr(i,e,t){for(;;){let n=0;for(let s of i)s.between(e-1,e+1,(r,o,a)=>{if(e>r&&e<o){let l=n||t||(e-r<o-e?-1:1);e=l<0?r:o,n=l}});if(!n)return e}}function Vp(i,e){let t=null;for(let n=0;n<e.ranges.length;n++){let s=e.ranges[n],r=null;if(s.empty){let o=cr(i,s.from,0);o!=s.from&&(r=j.cursor(o,-1))}else{let o=cr(i,s.from,-1),a=cr(i,s.to,1);(o!=s.from||a!=s.to)&&(r=j.range(s.from==s.anchor?o:a,s.from==s.head?o:a))}r&&(t||(t=e.ranges.slice()),t[n]=r)}return t?j.create(t,e.mainIndex):e}function Za(i,e,t){let n=cr(i.state.facet(Er).map(s=>s(i)),t.from,e.head>t.from?-1:1);return n==t.from?t:j.cursor(n,n<t.from?1:-1)}const tr="￿";class kw{constructor(e,t){this.points=e,this.text="",this.lineSeparator=t.facet(ze.lineSeparator)}append(e){this.text+=e}lineBreak(){this.text+=tr}readRange(e,t){if(!e)return this;let n=e.parentNode;for(let s=e;;){this.findPointBefore(n,s);let r=this.text.length;this.readNode(s);let o=s.nextSibling;if(o==t)break;let a=Ge.get(s),l=Ge.get(o);(a&&l?a.breakAfter:(a?a.breakAfter:Qo(s))||Qo(o)&&(s.nodeName!="BR"||s.cmIgnore)&&this.text.length>r)&&!$w(o,t)&&this.lineBreak(),s=o}return this.findPointBefore(n,t),this}readTextNode(e){let t=e.nodeValue;for(let n of this.points)n.node==e&&(n.pos=this.text.length+Math.min(n.offset,t.length));for(let n=0,s=this.lineSeparator?null:/\r\n?|\n/g;;){let r=-1,o=1,a;if(this.lineSeparator?(r=t.indexOf(this.lineSeparator,n),o=this.lineSeparator.length):(a=s.exec(t))&&(r=a.index,o=a[0].length),this.append(t.slice(n,r<0?t.length:r)),r<0)break;if(this.lineBreak(),o>1)for(let l of this.points)l.node==e&&l.pos>this.text.length&&(l.pos-=o-1);n=r+o}}readNode(e){if(e.cmIgnore)return;let t=Ge.get(e),n=t&&t.overrideDOMText;if(n!=null){this.findPointInside(e,n.length);for(let s=n.iter();!s.next().done;)s.lineBreak?this.lineBreak():this.append(s.value)}else e.nodeType==3?this.readTextNode(e):e.nodeName=="BR"?e.nextSibling&&this.lineBreak():e.nodeType==1&&this.readRange(e.firstChild,null)}findPointBefore(e,t){for(let n of this.points)n.node==e&&e.childNodes[n.offset]==t&&(n.pos=this.text.length)}findPointInside(e,t){for(let n of this.points)(e.nodeType==3?n.node==e:e.contains(n.node))&&(n.pos=this.text.length+(xw(e,n.node,n.offset)?t:0))}}function xw(i,e,t){for(;;){if(!e||t<es(e))return!1;if(e==i)return!0;t=qs(e)+1,e=e.parentNode}}function $w(i,e){let t;for(;!(i==e||!i);i=i.nextSibling){let n=Ge.get(i);if(!(n!=null&&n.isWidget||i.cmIgnore))return!1;n&&(t||(t=[])).push(n)}if(t)for(let n of t){let s=n.overrideDOMText;if(s!=null&&s.length)return!1}return!0}class ju{constructor(e,t){this.node=e,this.offset=t,this.pos=-1}}class Mw{constructor(e,t,n,s){this.typeOver=s,this.bounds=null,this.text="",this.domChanged=t>-1;let{impreciseHead:r,impreciseAnchor:o}=e.docView;if(e.state.readOnly&&t>-1)this.newSel=null;else if(t>-1&&(this.bounds=e.docView.domBoundsAround(t,n,0))){let a=r||o?[]:Ew(e),l=new kw(a,e.state);l.readRange(this.bounds.startDOM,this.bounds.endDOM),this.text=l.text,this.newSel=Aw(a,this.bounds.from)}else{let a=e.observer.selectionRange,l=r&&r.node==a.focusNode&&r.offset==a.focusOffset||!oc(e.contentDOM,a.focusNode)?e.state.selection.main.head:e.docView.posFromDOM(a.focusNode,a.focusOffset),d=o&&o.node==a.anchorNode&&o.offset==a.anchorOffset||!oc(e.contentDOM,a.anchorNode)?e.state.selection.main.anchor:e.docView.posFromDOM(a.anchorNode,a.anchorOffset),c=e.viewport;if((re.ios||re.chrome)&&e.state.selection.main.empty&&l!=d&&(c.from>0||c.to<e.state.doc.length)){let u=Math.min(l,d),h=Math.max(l,d),f=c.from-u,m=c.to-h;(f==0||f==1||u==0)&&(m==0||m==-1||h==e.state.doc.length)&&(l=0,d=e.state.doc.length)}this.newSel=j.single(d,l)}}}function Zp(i,e){let t,{newSel:n}=e,s=i.state.selection.main,r=i.inputState.lastKeyTime>Date.now()-100?i.inputState.lastKeyCode:-1;if(e.bounds){let{from:o,to:a}=e.bounds,l=s.from,d=null;(r===8||re.android&&e.text.length<a-o)&&(l=s.to,d="end");let c=jp(i.state.doc.sliceString(o,a,tr),e.text,l-o,d);c&&(re.chrome&&r==13&&c.toB==c.from+2&&e.text.slice(c.from,c.toB)==tr+tr&&c.toB--,t={from:o+c.from,to:o+c.toA,insert:Qe.of(e.text.slice(c.from,c.toB).split(tr))})}else n&&(!i.hasFocus&&i.state.facet(rs)||n.main.eq(s))&&(n=null);if(!t&&!n)return!1;if(!t&&e.typeOver&&!s.empty&&n&&n.main.empty?t={from:s.from,to:s.to,insert:i.state.doc.slice(s.from,s.to)}:(re.mac||re.android)&&t&&t.from==t.to&&t.from==s.head-1&&/^\. ?$/.test(t.insert.toString())&&i.contentDOM.getAttribute("autocorrect")=="off"?(n&&t.insert.length==2&&(n=j.single(n.main.anchor-1,n.main.head-1)),t={from:t.from,to:t.to,insert:Qe.of([t.insert.toString().replace("."," ")])}):t&&t.from>=s.from&&t.to<=s.to&&(t.from!=s.from||t.to!=s.to)&&s.to-s.from-(t.to-t.from)<=4?t={from:s.from,to:s.to,insert:i.state.doc.slice(s.from,t.from).append(t.insert).append(i.state.doc.slice(t.to,s.to))}:re.chrome&&t&&t.from==t.to&&t.from==s.head&&t.insert.toString()==`
 `&&i.lineWrapping&&(n&&(n=j.single(n.main.anchor-1,n.main.head-1)),t={from:s.from,to:s.to,insert:Qe.of([" "])}),t)return pd(i,t,n,r);if(n&&!n.main.eq(s)){let o=!1,a="select";return i.inputState.lastSelectionTime>Date.now()-50&&(i.inputState.lastSelectionOrigin=="select"&&(o=!0),a=i.inputState.lastSelectionOrigin,a=="select.pointer"&&(n=Vp(i.state.facet(Er).map(l=>l(i)),n))),i.dispatch({selection:n,scrollIntoView:o,userEvent:a}),!0}else return!1}function pd(i,e,t,n=-1){if(re.ios&&i.inputState.flushIOSKey(e))return!0;let s=i.state.selection.main;if(re.android&&(e.to==s.to&&(e.from==s.from||e.from==s.from-1&&i.state.sliceDoc(e.from,s.from)==" ")&&e.insert.length==1&&e.insert.lines==2&&bi(i.contentDOM,"Enter",13)||(e.from==s.from-1&&e.to==s.to&&e.insert.length==0||n==8&&e.insert.length<e.to-e.from&&e.to>s.head)&&bi(i.contentDOM,"Backspace",8)||e.from==s.from&&e.to==s.to+1&&e.insert.length==0&&bi(i.contentDOM,"Delete",46)))return!0;let r=e.insert.toString();i.inputState.composing>=0&&i.inputState.composing++;let o,a=()=>o||(o=Cw(i,e,t));return i.state.facet(Cp).some(l=>l(i,e.from,e.to,r,a))||i.dispatch(a()),!0}function Cw(i,e,t){let n,s=i.state,r=s.selection.main,o=-1;if(e.from==e.to&&e.from<r.from||e.from>r.to){let l=e.from<r.from?-1:1,d=l<0?r.from:r.to,c=cr(s.facet(Er).map(u=>u(i)),d,l);e.from==c&&(o=c)}if(o>-1)n={changes:e,selection:j.cursor(e.from+e.insert.length,-1)};else if(e.from>=r.from&&e.to<=r.to&&e.to-e.from>=(r.to-r.from)/3&&(!t||t.main.empty&&t.main.from==e.from+e.insert.length)&&i.inputState.composing<0){let l=r.from<e.from?s.sliceDoc(r.from,e.from):"",d=r.to>e.to?s.sliceDoc(e.to,r.to):"";n=s.replaceSelection(i.state.toText(l+e.insert.sliceString(0,void 0,i.state.lineBreak)+d))}else{let l=s.changes(e),d=t&&t.main.to<=l.newLength?t.main:void 0;if(s.selection.ranges.length>1&&i.inputState.composing>=0&&e.to<=r.to&&e.to>=r.to-10){let c=i.state.sliceDoc(e.from,e.to),u,h=t&&Bp(i,t.main.head);if(h){let g=e.insert.length-(e.to-e.from);u={from:h.from,to:h.to-g}}else u=i.state.doc.lineAt(r.head);let f=r.to-e.to,m=r.to-r.from;n=s.changeByRange(g=>{if(g.from==r.from&&g.to==r.to)return{changes:l,range:d||g.map(l)};let O=g.to-f,p=O-c.length;if(g.to-g.from!=m||i.state.sliceDoc(p,O)!=c||g.to>=u.from&&g.from<=u.to)return{range:g};let y=s.changes({from:p,to:O,insert:e.insert}),M=g.to-r.to;return{changes:y,range:d?j.range(Math.max(0,d.anchor+M),Math.max(0,d.head+M)):g.map(y)}})}else n={changes:l,selection:d&&s.selection.replaceRange(d)}}let a="input.type";return(i.composing||i.inputState.compositionPendingChange&&i.inputState.compositionEndedAt>Date.now()-50)&&(i.inputState.compositionPendingChange=!1,a+=".compose",i.inputState.compositionFirstChange&&(a+=".start",i.inputState.compositionFirstChange=!1)),s.update(n,{userEvent:a,scrollIntoView:!0})}function jp(i,e,t,n){let s=Math.min(i.length,e.length),r=0;for(;r<s&&i.charCodeAt(r)==e.charCodeAt(r);)r++;if(r==s&&i.length==e.length)return null;let o=i.length,a=e.length;for(;o>0&&a>0&&i.charCodeAt(o-1)==e.charCodeAt(a-1);)o--,a--;if(n=="end"){let l=Math.max(0,r-Math.min(o,a));t-=o+l-r}if(o<r&&i.length<e.length){let l=t<=r&&t>=o?r-t:0;r-=l,a=r+(a-o),o=r}else if(a<r){let l=t<=r&&t>=a?r-t:0;r-=l,o=r+(o-a),a=r}return{from:r,toA:o,toB:a}}function Ew(i){let e=[];if(i.root.activeElement!=i.contentDOM)return e;let{anchorNode:t,anchorOffset:n,focusNode:s,focusOffset:r}=i.observer.selectionRange;return t&&(e.push(new ju(t,n)),(s!=t||r!=n)&&e.push(new ju(s,r))),e}function Aw(i,e){if(i.length==0)return null;let t=i[0].pos,n=i.length==2?i[1].pos:t;return t>-1&&n>-1?j.single(t+e,n+e):null}class Tw{setSelectionOrigin(e){this.lastSelectionOrigin=e,this.lastSelectionTime=Date.now()}constructor(e){this.view=e,this.lastKeyCode=0,this.lastKeyTime=0,this.lastTouchTime=0,this.lastFocusTime=0,this.lastScrollTop=0,this.lastScrollLeft=0,this.pendingIOSKey=void 0,this.tabFocusMode=-1,this.lastSelectionOrigin=null,this.lastSelectionTime=0,this.lastContextMenu=0,this.scrollHandlers=[],this.handlers=Object.create(null),this.composing=-1,this.compositionFirstChange=null,this.compositionEndedAt=0,this.compositionPendingKey=!1,this.compositionPendingChange=!1,this.mouseSelection=null,this.draggedContent=null,this.handleEvent=this.handleEvent.bind(this),this.notifiedFocused=e.hasFocus,re.safari&&e.contentDOM.addEventListener("input",()=>null),re.gecko&&Uw(e.contentDOM.ownerDocument)}handleEvent(e){!Dw(this.view,e)||this.ignoreDuringComposition(e)||e.type=="keydown"&&this.keydown(e)||(this.view.updateState!=0?Promise.resolve().then(()=>this.runHandlers(e.type,e)):this.runHandlers(e.type,e))}runHandlers(e,t){let n=this.handlers[e];if(n){for(let s of n.observers)s(this.view,t);for(let s of n.handlers){if(t.defaultPrevented)break;if(s(this.view,t)){t.preventDefault();break}}}}ensureHandlers(e){let t=Nw(e),n=this.handlers,s=this.view.contentDOM;for(let r in t)if(r!="scroll"){let o=!t[r].handlers.length,a=n[r];a&&o!=!a.handlers.length&&(s.removeEventListener(r,this.handleEvent),a=null),a||s.addEventListener(r,this.handleEvent,{passive:o})}for(let r in n)r!="scroll"&&!t[r]&&s.removeEventListener(r,this.handleEvent);this.handlers=t}keydown(e){if(this.lastKeyCode=e.keyCode,this.lastKeyTime=Date.now(),e.keyCode==9&&this.tabFocusMode>-1&&(!this.tabFocusMode||Date.now()<=this.tabFocusMode))return!0;if(this.tabFocusMode>0&&e.keyCode!=27&&Gp.indexOf(e.keyCode)<0&&(this.tabFocusMode=-1),re.android&&re.chrome&&!e.synthetic&&(e.keyCode==13||e.keyCode==8))return this.view.observer.delayAndroidKey(e.key,e.keyCode),!0;let t;return re.ios&&!e.synthetic&&!e.altKey&&!e.metaKey&&((t=Fp.find(n=>n.keyCode==e.keyCode))&&!e.ctrlKey||Qw.indexOf(e.key)>-1&&e.ctrlKey&&!e.shiftKey)?(this.pendingIOSKey=t||e,setTimeout(()=>this.flushIOSKey(),250),!0):(e.keyCode!=229&&this.view.observer.forceFlush(),!1)}flushIOSKey(e){let t=this.pendingIOSKey;return!t||t.key=="Enter"&&e&&e.from<e.to&&/^\S+$/.test(e.insert.toString())?!1:(this.pendingIOSKey=void 0,bi(this.view.contentDOM,t.key,t.keyCode,t instanceof KeyboardEvent?t:void 0))}ignoreDuringComposition(e){return!/^key/.test(e.type)||e.synthetic?!1:this.composing>0?!0:re.safari&&!re.ios&&this.compositionPendingKey&&Date.now()-this.compositionEndedAt<100?(this.compositionPendingKey=!1,!0):!1}startMouseSelection(e){this.mouseSelection&&this.mouseSelection.destroy(),this.mouseSelection=e}update(e){this.view.observer.update(e),this.mouseSelection&&this.mouseSelection.update(e),this.draggedContent&&e.docChanged&&(this.draggedContent=this.draggedContent.map(e.changes)),e.transactions.length&&(this.lastKeyCode=this.lastSelectionTime=0)}destroy(){this.mouseSelection&&this.mouseSelection.destroy()}}function Fu(i,e){return(t,n)=>{try{return e.call(i,n,t)}catch(s){Gn(t.state,s)}}}function Nw(i){let e=Object.create(null);function t(n){return e[n]||(e[n]={observers:[],handlers:[]})}for(let n of i){let s=n.spec,r=s&&s.plugin.domEventHandlers,o=s&&s.plugin.domEventObservers;if(r)for(let a in r){let l=r[a];l&&t(a).handlers.push(Fu(n.value,l))}if(o)for(let a in o){let l=o[a];l&&t(a).observers.push(Fu(n.value,l))}}for(let n in Nn)t(n).handlers.push(Nn[n]);for(let n in Pn)t(n).observers.push(Pn[n]);return e}const Fp=[{key:"Backspace",keyCode:8,inputType:"deleteContentBackward"},{key:"Enter",keyCode:13,inputType:"insertParagraph"},{key:"Enter",keyCode:13,inputType:"insertLineBreak"},{key:"Delete",keyCode:46,inputType:"deleteContentForward"}],Qw="dthko",Gp=[16,17,18,20,91,92,224,225],Wr=6;function qr(i){return Math.max(0,i)*.7+8}function Rw(i,e){return Math.max(Math.abs(i.clientX-e.clientX),Math.abs(i.clientY-e.clientY))}class _w{constructor(e,t,n,s){this.view=e,this.startEvent=t,this.style=n,this.mustSelect=s,this.scrollSpeed={x:0,y:0},this.scrolling=-1,this.lastEvent=t,this.scrollParents=Vv(e.contentDOM),this.atoms=e.state.facet(Er).map(o=>o(e));let r=e.contentDOM.ownerDocument;r.addEventListener("mousemove",this.move=this.move.bind(this)),r.addEventListener("mouseup",this.up=this.up.bind(this)),this.extend=t.shiftKey,this.multiple=e.state.facet(ze.allowMultipleSelections)&&Iw(e,t),this.dragging=Bw(e,t)&&Wp(t)==1?null:!1}start(e){this.dragging===!1&&this.select(e)}move(e){if(e.buttons==0)return this.destroy();if(this.dragging||this.dragging==null&&Rw(this.startEvent,e)<10)return;this.select(this.lastEvent=e);let t=0,n=0,s=0,r=0,o=this.view.win.innerWidth,a=this.view.win.innerHeight;this.scrollParents.x&&({left:s,right:o}=this.scrollParents.x.getBoundingClientRect()),this.scrollParents.y&&({top:r,bottom:a}=this.scrollParents.y.getBoundingClientRect());let l=Lp(this.view);e.clientX-l.left<=s+Wr?t=-qr(s-e.clientX):e.clientX+l.right>=o-Wr&&(t=qr(e.clientX-o)),e.clientY-l.top<=r+Wr?n=-qr(r-e.clientY):e.clientY+l.bottom>=a-Wr&&(n=qr(e.clientY-a)),this.setScrollSpeed(t,n)}up(e){this.dragging==null&&this.select(this.lastEvent),this.dragging||e.preventDefault(),this.destroy()}destroy(){this.setScrollSpeed(0,0);let e=this.view.contentDOM.ownerDocument;e.removeEventListener("mousemove",this.move),e.removeEventListener("mouseup",this.up),this.view.inputState.mouseSelection=this.view.inputState.draggedContent=null}setScrollSpeed(e,t){this.scrollSpeed={x:e,y:t},e||t?this.scrolling<0&&(this.scrolling=setInterval(()=>this.scroll(),50)):this.scrolling>-1&&(clearInterval(this.scrolling),this.scrolling=-1)}scroll(){let{x:e,y:t}=this.scrollSpeed;e&&this.scrollParents.x&&(this.scrollParents.x.scrollLeft+=e,e=0),t&&this.scrollParents.y&&(this.scrollParents.y.scrollTop+=t,t=0),(e||t)&&this.view.win.scrollBy(e,t),this.dragging===!1&&this.select(this.lastEvent)}select(e){let{view:t}=this,n=Vp(this.atoms,this.style.get(e,this.extend,this.multiple));(this.mustSelect||!n.eq(t.state.selection,this.dragging===!1))&&this.view.dispatch({selection:n,userEvent:"select.pointer"}),this.mustSelect=!1}update(e){e.transactions.some(t=>t.isUserEvent("input.type"))?this.destroy():this.style.update(e)&&setTimeout(()=>this.select(this.lastEvent),20)}}function Iw(i,e){let t=i.state.facet(kp);return t.length?t[0](e):re.mac?e.metaKey:e.ctrlKey}function Lw(i,e){let t=i.state.facet(xp);return t.length?t[0](e):re.mac?!e.altKey:!e.ctrlKey}function Bw(i,e){let{main:t}=i.state.selection;if(t.empty)return!1;let n=Or(i.root);if(!n||n.rangeCount==0)return!0;let s=n.getRangeAt(0).getClientRects();for(let r=0;r<s.length;r++){let o=s[r];if(o.left<=e.clientX&&o.right>=e.clientX&&o.top<=e.clientY&&o.bottom>=e.clientY)return!0}return!1}function Dw(i,e){if(!e.bubbles)return!0;if(e.defaultPrevented)return!1;for(let t=e.target,n;t!=i.contentDOM;t=t.parentNode)if(!t||t.nodeType==11||(n=Ge.get(t))&&n.ignoreEvent(e))return!1;return!0}const Nn=Object.create(null),Pn=Object.create(null),Xp=re.ie&&re.ie_version<15||re.ios&&re.webkit_version<604;function zw(i){let e=i.dom.parentNode;if(!e)return;let t=e.appendChild(document.createElement("textarea"));t.style.cssText="position: fixed; left: -10000px; top: 10px",t.focus(),setTimeout(()=>{i.focus(),t.remove(),Up(i,t.value)},50)}function ha(i,e,t){for(let n of i.facet(e))t=n(t,i);return t}function Up(i,e){e=ha(i.state,hd,e);let{state:t}=i,n,s=1,r=t.toText(e),o=r.lines==t.selection.ranges.length;if(pc!=null&&t.selection.ranges.every(l=>l.empty)&&pc==r.toString()){let l=-1;n=t.changeByRange(d=>{let c=t.doc.lineAt(d.from);if(c.from==l)return{range:d};l=c.from;let u=t.toText((o?r.line(s++).text:e)+t.lineBreak);return{changes:{from:c.from,insert:u},range:j.cursor(d.from+u.length)}})}else o?n=t.changeByRange(l=>{let d=r.line(s++);return{changes:{from:l.from,to:l.to,insert:d.text},range:j.cursor(l.from+d.length)}}):n=t.replaceSelection(r);i.dispatch(n,{userEvent:"input.paste",scrollIntoView:!0})}Pn.scroll=i=>{i.inputState.lastScrollTop=i.scrollDOM.scrollTop,i.inputState.lastScrollLeft=i.scrollDOM.scrollLeft};Nn.keydown=(i,e)=>(i.inputState.setSelectionOrigin("select"),e.keyCode==27&&i.inputState.tabFocusMode!=0&&(i.inputState.tabFocusMode=Date.now()+2e3),!1);Pn.touchstart=(i,e)=>{i.inputState.lastTouchTime=Date.now(),i.inputState.setSelectionOrigin("select.pointer")};Pn.touchmove=i=>{i.inputState.setSelectionOrigin("select.pointer")};Nn.mousedown=(i,e)=>{if(i.observer.flush(),i.inputState.lastTouchTime>Date.now()-2e3)return!1;let t=null;for(let n of i.state.facet($p))if(t=n(i,e),t)break;if(!t&&e.button==0&&(t=jw(i,e)),t){let n=!i.hasFocus;i.inputState.startMouseSelection(new _w(i,e,t,n)),n&&i.observer.ignore(()=>{ap(i.contentDOM);let r=i.root.activeElement;r&&!r.contains(i.contentDOM)&&r.blur()});let s=i.inputState.mouseSelection;if(s)return s.start(e),s.dragging===!1}else i.inputState.setSelectionOrigin("select.pointer");return!1};function Gu(i,e,t,n){if(n==1)return j.cursor(e,t);if(n==2)return pw(i.state,e,t);{let s=ft.find(i.docView,e),r=i.state.doc.lineAt(s?s.posAtEnd:e),o=s?s.posAtStart:r.from,a=s?s.posAtEnd:r.to;return a<i.state.doc.length&&a==r.to&&a++,j.range(o,a)}}let Xu=(i,e,t)=>e>=t.top&&e<=t.bottom&&i>=t.left&&i<=t.right;function Vw(i,e,t,n){let s=ft.find(i.docView,e);if(!s)return 1;let r=e-s.posAtStart;if(r==0)return 1;if(r==s.length)return-1;let o=s.coordsAt(r,-1);if(o&&Xu(t,n,o))return-1;let a=s.coordsAt(r,1);return a&&Xu(t,n,a)?1:o&&o.bottom>=n?-1:1}function Uu(i,e){let t=i.posAtCoords({x:e.clientX,y:e.clientY},!1);return{pos:t,bias:Vw(i,t,e.clientX,e.clientY)}}const Zw=re.ie&&re.ie_version<=11;let Wu=null,qu=0,Hu=0;function Wp(i){if(!Zw)return i.detail;let e=Wu,t=Hu;return Wu=i,Hu=Date.now(),qu=!e||t>Date.now()-400&&Math.abs(e.clientX-i.clientX)<2&&Math.abs(e.clientY-i.clientY)<2?(qu+1)%3:1}function jw(i,e){let t=Uu(i,e),n=Wp(e),s=i.state.selection;return{update(r){r.docChanged&&(t.pos=r.changes.mapPos(t.pos),s=s.map(r.changes))},get(r,o,a){let l=Uu(i,r),d,c=Gu(i,l.pos,l.bias,n);if(t.pos!=l.pos&&!o){let u=Gu(i,t.pos,t.bias,n),h=Math.min(u.from,c.from),f=Math.max(u.to,c.to);c=h<c.from?j.range(h,f):j.range(f,h)}return o?s.replaceRange(s.main.extend(c.from,c.to)):a&&n==1&&s.ranges.length>1&&(d=Fw(s,l.pos))?d:a?s.addRange(c):j.create([c])}}}function Fw(i,e){for(let t=0;t<i.ranges.length;t++){let{from:n,to:s}=i.ranges[t];if(n<=e&&s>=e)return j.create(i.ranges.slice(0,t).concat(i.ranges.slice(t+1)),i.mainIndex==t?0:i.mainIndex-(i.mainIndex>t?1:0))}return null}Nn.dragstart=(i,e)=>{let{selection:{main:t}}=i.state;if(e.target.draggable){let s=i.docView.nearest(e.target);if(s&&s.isWidget){let r=s.posAtStart,o=r+s.length;(r>=t.to||o<=t.from)&&(t=j.range(r,o))}}let{inputState:n}=i;return n.mouseSelection&&(n.mouseSelection.dragging=!0),n.draggedContent=t,e.dataTransfer&&(e.dataTransfer.setData("Text",ha(i.state,fd,i.state.sliceDoc(t.from,t.to))),e.dataTransfer.effectAllowed="copyMove"),!1};Nn.dragend=i=>(i.inputState.draggedContent=null,!1);function Yu(i,e,t,n){if(t=ha(i.state,hd,t),!t)return;let s=i.posAtCoords({x:e.clientX,y:e.clientY},!1),{draggedContent:r}=i.inputState,o=n&&r&&Lw(i,e)?{from:r.from,to:r.to}:null,a={from:s,insert:t},l=i.state.changes(o?[o,a]:a);i.focus(),i.dispatch({changes:l,selection:{anchor:l.mapPos(s,-1),head:l.mapPos(s,1)},userEvent:o?"move.drop":"input.drop"}),i.inputState.draggedContent=null}Nn.drop=(i,e)=>{if(!e.dataTransfer)return!1;if(i.state.readOnly)return!0;let t=e.dataTransfer.files;if(t&&t.length){let n=Array(t.length),s=0,r=()=>{++s==t.length&&Yu(i,e,n.filter(o=>o!=null).join(i.state.lineBreak),!1)};for(let o=0;o<t.length;o++){let a=new FileReader;a.onerror=r,a.onload=()=>{/[\x00-\x08\x0e-\x1f]{2}/.test(a.result)||(n[o]=a.result),r()},a.readAsText(t[o])}return!0}else{let n=e.dataTransfer.getData("Text");if(n)return Yu(i,e,n,!0),!0}return!1};Nn.paste=(i,e)=>{if(i.state.readOnly)return!0;i.observer.flush();let t=Xp?null:e.clipboardData;return t?(Up(i,t.getData("text/plain")||t.getData("text/uri-list")),!0):(zw(i),!1)};function Gw(i,e){let t=i.dom.parentNode;if(!t)return;let n=t.appendChild(document.createElement("textarea"));n.style.cssText="position: fixed; left: -10000px; top: 10px",n.value=e,n.focus(),n.selectionEnd=e.length,n.selectionStart=0,setTimeout(()=>{n.remove(),i.focus()},50)}function Xw(i){let e=[],t=[],n=!1;for(let s of i.selection.ranges)s.empty||(e.push(i.sliceDoc(s.from,s.to)),t.push(s));if(!e.length){let s=-1;for(let{from:r}of i.selection.ranges){let o=i.doc.lineAt(r);o.number>s&&(e.push(o.text),t.push({from:o.from,to:Math.min(i.doc.length,o.to+1)})),s=o.number}n=!0}return{text:ha(i,fd,e.join(i.lineBreak)),ranges:t,linewise:n}}let pc=null;Nn.copy=Nn.cut=(i,e)=>{let{text:t,ranges:n,linewise:s}=Xw(i.state);if(!t&&!s)return!1;pc=s?t:null,e.type=="cut"&&!i.state.readOnly&&i.dispatch({changes:n,scrollIntoView:!0,userEvent:"delete.cut"});let r=Xp?null:e.clipboardData;return r?(r.clearData(),r.setData("text/plain",t),!0):(Gw(i,t),!1)};const qp=cs.define();function Hp(i,e){let t=[];for(let n of i.facet(Ep)){let s=n(i,e);s&&t.push(s)}return t.length?i.update({effects:t,annotations:qp.of(!0)}):null}function Yp(i){setTimeout(()=>{let e=i.hasFocus;if(e!=i.inputState.notifiedFocused){let t=Hp(i.state,e);t?i.dispatch(t):i.update([])}},10)}Pn.focus=i=>{i.inputState.lastFocusTime=Date.now(),!i.scrollDOM.scrollTop&&(i.inputState.lastScrollTop||i.inputState.lastScrollLeft)&&(i.scrollDOM.scrollTop=i.inputState.lastScrollTop,i.scrollDOM.scrollLeft=i.inputState.lastScrollLeft),Yp(i)};Pn.blur=i=>{i.observer.clearSelectionRange(),Yp(i)};Pn.compositionstart=Pn.compositionupdate=i=>{i.observer.editContext||(i.inputState.compositionFirstChange==null&&(i.inputState.compositionFirstChange=!0),i.inputState.composing<0&&(i.inputState.composing=0))};Pn.compositionend=i=>{i.observer.editContext||(i.inputState.composing=-1,i.inputState.compositionEndedAt=Date.now(),i.inputState.compositionPendingKey=!0,i.inputState.compositionPendingChange=i.observer.pendingRecords().length>0,i.inputState.compositionFirstChange=null,re.chrome&&re.android?i.observer.flushSoon():i.inputState.compositionPendingChange?Promise.resolve().then(()=>i.observer.flush()):setTimeout(()=>{i.inputState.composing<0&&i.docView.hasComposition&&i.update([])},50))};Pn.contextmenu=i=>{i.inputState.lastContextMenu=Date.now()};Nn.beforeinput=(i,e)=>{var t,n;if(e.inputType=="insertReplacementText"&&i.observer.editContext){let r=(t=e.dataTransfer)===null||t===void 0?void 0:t.getData("text/plain"),o=e.getTargetRanges();if(r&&o.length){let a=o[0],l=i.posAtDOM(a.startContainer,a.startOffset),d=i.posAtDOM(a.endContainer,a.endOffset);return pd(i,{from:l,to:d,insert:i.state.toText(r)},null),!0}}let s;if(re.chrome&&re.android&&(s=Fp.find(r=>r.inputType==e.inputType))&&(i.observer.delayAndroidKey(s.key,s.keyCode),s.key=="Backspace"||s.key=="Delete")){let r=((n=window.visualViewport)===null||n===void 0?void 0:n.height)||0;setTimeout(()=>{var o;(((o=window.visualViewport)===null||o===void 0?void 0:o.height)||0)>r+10&&i.hasFocus&&(i.contentDOM.blur(),i.focus())},100)}return re.ios&&e.inputType=="deleteContentForward"&&i.observer.flushSoon(),re.safari&&e.inputType=="insertText"&&i.inputState.composing>=0&&setTimeout(()=>Pn.compositionend(i,e),20),!1};const Ku=new Set;function Uw(i){Ku.has(i)||(Ku.add(i),i.addEventListener("copy",()=>{}),i.addEventListener("cut",()=>{}))}const Ju=["pre-wrap","normal","pre-line","break-spaces"];let $i=!1;function eh(){$i=!1}class Ww{constructor(e){this.lineWrapping=e,this.doc=Qe.empty,this.heightSamples={},this.lineHeight=14,this.charWidth=7,this.textHeight=14,this.lineLength=30}heightForGap(e,t){let n=this.doc.lineAt(t).number-this.doc.lineAt(e).number+1;return this.lineWrapping&&(n+=Math.max(0,Math.ceil((t-e-n*this.lineLength*.5)/this.lineLength))),this.lineHeight*n}heightForLine(e){return this.lineWrapping?(1+Math.max(0,Math.ceil((e-this.lineLength)/Math.max(1,this.lineLength-5))))*this.lineHeight:this.lineHeight}setDoc(e){return this.doc=e,this}mustRefreshForWrapping(e){return Ju.indexOf(e)>-1!=this.lineWrapping}mustRefreshForHeights(e){let t=!1;for(let n=0;n<e.length;n++){let s=e[n];s<0?n++:this.heightSamples[Math.floor(s*10)]||(t=!0,this.heightSamples[Math.floor(s*10)]=!0)}return t}refresh(e,t,n,s,r,o){let a=Ju.indexOf(e)>-1,l=Math.round(t)!=Math.round(this.lineHeight)||this.lineWrapping!=a;if(this.lineWrapping=a,this.lineHeight=t,this.charWidth=n,this.textHeight=s,this.lineLength=r,l){this.heightSamples={};for(let d=0;d<o.length;d++){let c=o[d];c<0?d++:this.heightSamples[Math.floor(c*10)]=!0}}return l}}class qw{constructor(e,t){this.from=e,this.heights=t,this.index=0}get more(){return this.index<this.heights.length}}class Fn{constructor(e,t,n,s,r){this.from=e,this.length=t,this.top=n,this.height=s,this._content=r}get type(){return typeof this._content=="number"?vn.Text:Array.isArray(this._content)?this._content:this._content.type}get to(){return this.from+this.length}get bottom(){return this.top+this.height}get widget(){return this._content instanceof ks?this._content.widget:null}get widgetLineBreaks(){return typeof this._content=="number"?this._content:0}join(e){let t=(Array.isArray(this._content)?this._content:[this]).concat(Array.isArray(e._content)?e._content:[e]);return new Fn(this.from,this.length+e.length,this.top,this.height+e.height,t)}}var tt=(function(i){return i[i.ByPos=0]="ByPos",i[i.ByHeight=1]="ByHeight",i[i.ByPosNoHeight=2]="ByPosNoHeight",i})(tt||(tt={}));const wo=.001;class Ut{constructor(e,t,n=2){this.length=e,this.height=t,this.flags=n}get outdated(){return(this.flags&2)>0}set outdated(e){this.flags=(e?2:0)|this.flags&-3}setHeight(e){this.height!=e&&(Math.abs(this.height-e)>wo&&($i=!0),this.height=e)}replace(e,t,n){return Ut.of(n)}decomposeLeft(e,t){t.push(this)}decomposeRight(e,t){t.push(this)}applyChanges(e,t,n,s){let r=this,o=n.doc;for(let a=s.length-1;a>=0;a--){let{fromA:l,toA:d,fromB:c,toB:u}=s[a],h=r.lineAt(l,tt.ByPosNoHeight,n.setDoc(t),0,0),f=h.to>=d?h:r.lineAt(d,tt.ByPosNoHeight,n,0,0);for(u+=f.to-d,d=f.to;a>0&&h.from<=s[a-1].toA;)l=s[a-1].fromA,c=s[a-1].fromB,a--,l<h.from&&(h=r.lineAt(l,tt.ByPosNoHeight,n,0,0));c+=h.from-l,l=h.from;let m=gd.build(n.setDoc(o),e,c,u);r=Io(r,r.replace(l,d,m))}return r.updateHeight(n,0)}static empty(){return new un(0,0)}static of(e){if(e.length==1)return e[0];let t=0,n=e.length,s=0,r=0;for(;;)if(t==n)if(s>r*2){let a=e[t-1];a.break?e.splice(--t,1,a.left,null,a.right):e.splice(--t,1,a.left,a.right),n+=1+a.break,s-=a.size}else if(r>s*2){let a=e[n];a.break?e.splice(n,1,a.left,null,a.right):e.splice(n,1,a.left,a.right),n+=2+a.break,r-=a.size}else break;else if(s<r){let a=e[t++];a&&(s+=a.size)}else{let a=e[--n];a&&(r+=a.size)}let o=0;return e[t-1]==null?(o=1,t--):e[t]==null&&(o=1,n++),new Hw(Ut.of(e.slice(0,t)),o,Ut.of(e.slice(n)))}}function Io(i,e){return i==e?i:(i.constructor!=e.constructor&&($i=!0),e)}Ut.prototype.size=1;class Kp extends Ut{constructor(e,t,n){super(e,t),this.deco=n}blockAt(e,t,n,s){return new Fn(s,this.length,n,this.height,this.deco||0)}lineAt(e,t,n,s,r){return this.blockAt(0,n,s,r)}forEachLine(e,t,n,s,r,o){e<=r+this.length&&t>=r&&o(this.blockAt(0,n,s,r))}updateHeight(e,t=0,n=!1,s){return s&&s.from<=t&&s.more&&this.setHeight(s.heights[s.index++]),this.outdated=!1,this}toString(){return`block(${this.length})`}}class un extends Kp{constructor(e,t){super(e,t,null),this.collapsed=0,this.widgetHeight=0,this.breaks=0}blockAt(e,t,n,s){return new Fn(s,this.length,n,this.height,this.breaks)}replace(e,t,n){let s=n[0];return n.length==1&&(s instanceof un||s instanceof Tt&&s.flags&4)&&Math.abs(this.length-s.length)<10?(s instanceof Tt?s=new un(s.length,this.height):s.height=this.height,this.outdated||(s.outdated=!1),s):Ut.of(n)}updateHeight(e,t=0,n=!1,s){return s&&s.from<=t&&s.more?this.setHeight(s.heights[s.index++]):(n||this.outdated)&&this.setHeight(Math.max(this.widgetHeight,e.heightForLine(this.length-this.collapsed))+this.breaks*e.lineHeight),this.outdated=!1,this}toString(){return`line(${this.length}${this.collapsed?-this.collapsed:""}${this.widgetHeight?":"+this.widgetHeight:""})`}}class Tt extends Ut{constructor(e){super(e,0)}heightMetrics(e,t){let n=e.doc.lineAt(t).number,s=e.doc.lineAt(t+this.length).number,r=s-n+1,o,a=0;if(e.lineWrapping){let l=Math.min(this.height,e.lineHeight*r);o=l/r,this.length>r+1&&(a=(this.height-l)/(this.length-r-1))}else o=this.height/r;return{firstLine:n,lastLine:s,perLine:o,perChar:a}}blockAt(e,t,n,s){let{firstLine:r,lastLine:o,perLine:a,perChar:l}=this.heightMetrics(t,s);if(t.lineWrapping){let d=s+(e<t.lineHeight?0:Math.round(Math.max(0,Math.min(1,(e-n)/this.height))*this.length)),c=t.doc.lineAt(d),u=a+c.length*l,h=Math.max(n,e-u/2);return new Fn(c.from,c.length,h,u,0)}else{let d=Math.max(0,Math.min(o-r,Math.floor((e-n)/a))),{from:c,length:u}=t.doc.line(r+d);return new Fn(c,u,n+a*d,a,0)}}lineAt(e,t,n,s,r){if(t==tt.ByHeight)return this.blockAt(e,n,s,r);if(t==tt.ByPosNoHeight){let{from:f,to:m}=n.doc.lineAt(e);return new Fn(f,m-f,0,0,0)}let{firstLine:o,perLine:a,perChar:l}=this.heightMetrics(n,r),d=n.doc.lineAt(e),c=a+d.length*l,u=d.number-o,h=s+a*u+l*(d.from-r-u);return new Fn(d.from,d.length,Math.max(s,Math.min(h,s+this.height-c)),c,0)}forEachLine(e,t,n,s,r,o){e=Math.max(e,r),t=Math.min(t,r+this.length);let{firstLine:a,perLine:l,perChar:d}=this.heightMetrics(n,r);for(let c=e,u=s;c<=t;){let h=n.doc.lineAt(c);if(c==e){let m=h.number-a;u+=l*m+d*(e-r-m)}let f=l+d*h.length;o(new Fn(h.from,h.length,u,f,0)),u+=f,c=h.to+1}}replace(e,t,n){let s=this.length-t;if(s>0){let r=n[n.length-1];r instanceof Tt?n[n.length-1]=new Tt(r.length+s):n.push(null,new Tt(s-1))}if(e>0){let r=n[0];r instanceof Tt?n[0]=new Tt(e+r.length):n.unshift(new Tt(e-1),null)}return Ut.of(n)}decomposeLeft(e,t){t.push(new Tt(e-1),null)}decomposeRight(e,t){t.push(null,new Tt(this.length-e-1))}updateHeight(e,t=0,n=!1,s){let r=t+this.length;if(s&&s.from<=t+this.length&&s.more){let o=[],a=Math.max(t,s.from),l=-1;for(s.from>t&&o.push(new Tt(s.from-t-1).updateHeight(e,t));a<=r&&s.more;){let c=e.doc.lineAt(a).length;o.length&&o.push(null);let u=s.heights[s.index++];l==-1?l=u:Math.abs(u-l)>=wo&&(l=-2);let h=new un(c,u);h.outdated=!1,o.push(h),a+=c+1}a<=r&&o.push(null,new Tt(r-a).updateHeight(e,a));let d=Ut.of(o);return(l<0||Math.abs(d.height-this.height)>=wo||Math.abs(l-this.heightMetrics(e,t).perLine)>=wo)&&($i=!0),Io(this,d)}else(n||this.outdated)&&(this.setHeight(e.heightForGap(t,t+this.length)),this.outdated=!1);return this}toString(){return`gap(${this.length})`}}class Hw extends Ut{constructor(e,t,n){super(e.length+t+n.length,e.height+n.height,t|(e.outdated||n.outdated?2:0)),this.left=e,this.right=n,this.size=e.size+n.size}get break(){return this.flags&1}blockAt(e,t,n,s){let r=n+this.left.height;return e<r?this.left.blockAt(e,t,n,s):this.right.blockAt(e,t,r,s+this.left.length+this.break)}lineAt(e,t,n,s,r){let o=s+this.left.height,a=r+this.left.length+this.break,l=t==tt.ByHeight?e<o:e<a,d=l?this.left.lineAt(e,t,n,s,r):this.right.lineAt(e,t,n,o,a);if(this.break||(l?d.to<a:d.from>a))return d;let c=t==tt.ByPosNoHeight?tt.ByPosNoHeight:tt.ByPos;return l?d.join(this.right.lineAt(a,c,n,o,a)):this.left.lineAt(a,c,n,s,r).join(d)}forEachLine(e,t,n,s,r,o){let a=s+this.left.height,l=r+this.left.length+this.break;if(this.break)e<l&&this.left.forEachLine(e,t,n,s,r,o),t>=l&&this.right.forEachLine(e,t,n,a,l,o);else{let d=this.lineAt(l,tt.ByPos,n,s,r);e<d.from&&this.left.forEachLine(e,d.from-1,n,s,r,o),d.to>=e&&d.from<=t&&o(d),t>d.to&&this.right.forEachLine(d.to+1,t,n,a,l,o)}}replace(e,t,n){let s=this.left.length+this.break;if(t<s)return this.balanced(this.left.replace(e,t,n),this.right);if(e>this.left.length)return this.balanced(this.left,this.right.replace(e-s,t-s,n));let r=[];e>0&&this.decomposeLeft(e,r);let o=r.length;for(let a of n)r.push(a);if(e>0&&th(r,o-1),t<this.length){let a=r.length;this.decomposeRight(t,r),th(r,a)}return Ut.of(r)}decomposeLeft(e,t){let n=this.left.length;if(e<=n)return this.left.decomposeLeft(e,t);t.push(this.left),this.break&&(n++,e>=n&&t.push(null)),e>n&&this.right.decomposeLeft(e-n,t)}decomposeRight(e,t){let n=this.left.length,s=n+this.break;if(e>=s)return this.right.decomposeRight(e-s,t);e<n&&this.left.decomposeRight(e,t),this.break&&e<s&&t.push(null),t.push(this.right)}balanced(e,t){return e.size>2*t.size||t.size>2*e.size?Ut.of(this.break?[e,null,t]:[e,t]):(this.left=Io(this.left,e),this.right=Io(this.right,t),this.setHeight(e.height+t.height),this.outdated=e.outdated||t.outdated,this.size=e.size+t.size,this.length=e.length+this.break+t.length,this)}updateHeight(e,t=0,n=!1,s){let{left:r,right:o}=this,a=t+r.length+this.break,l=null;return s&&s.from<=t+r.length&&s.more?l=r=r.updateHeight(e,t,n,s):r.updateHeight(e,t,n),s&&s.from<=a+o.length&&s.more?l=o=o.updateHeight(e,a,n,s):o.updateHeight(e,a,n),l?this.balanced(r,o):(this.height=this.left.height+this.right.height,this.outdated=!1,this)}toString(){return this.left+(this.break?" ":"-")+this.right}}function th(i,e){let t,n;i[e]==null&&(t=i[e-1])instanceof Tt&&(n=i[e+1])instanceof Tt&&i.splice(e-1,3,new Tt(t.length+1+n.length))}const Yw=5;class gd{constructor(e,t){this.pos=e,this.oracle=t,this.nodes=[],this.lineStart=-1,this.lineEnd=-1,this.covering=null,this.writtenTo=e}get isCovered(){return this.covering&&this.nodes[this.nodes.length-1]==this.covering}span(e,t){if(this.lineStart>-1){let n=Math.min(t,this.lineEnd),s=this.nodes[this.nodes.length-1];s instanceof un?s.length+=n-this.pos:(n>this.pos||!this.isCovered)&&this.nodes.push(new un(n-this.pos,-1)),this.writtenTo=n,t>n&&(this.nodes.push(null),this.writtenTo++,this.lineStart=-1)}this.pos=t}point(e,t,n){if(e<t||n.heightRelevant){let s=n.widget?n.widget.estimatedHeight:0,r=n.widget?n.widget.lineBreaks:0;s<0&&(s=this.oracle.lineHeight);let o=t-e;n.block?this.addBlock(new Kp(o,s,n)):(o||r||s>=Yw)&&this.addLineDeco(s,r,o)}else t>e&&this.span(e,t);this.lineEnd>-1&&this.lineEnd<this.pos&&(this.lineEnd=this.oracle.doc.lineAt(this.pos).to)}enterLine(){if(this.lineStart>-1)return;let{from:e,to:t}=this.oracle.doc.lineAt(this.pos);this.lineStart=e,this.lineEnd=t,this.writtenTo<e&&((this.writtenTo<e-1||this.nodes[this.nodes.length-1]==null)&&this.nodes.push(this.blankContent(this.writtenTo,e-1)),this.nodes.push(null)),this.pos>e&&this.nodes.push(new un(this.pos-e,-1)),this.writtenTo=this.pos}blankContent(e,t){let n=new Tt(t-e);return this.oracle.doc.lineAt(e).to==t&&(n.flags|=4),n}ensureLine(){this.enterLine();let e=this.nodes.length?this.nodes[this.nodes.length-1]:null;if(e instanceof un)return e;let t=new un(0,-1);return this.nodes.push(t),t}addBlock(e){this.enterLine();let t=e.deco;t&&t.startSide>0&&!this.isCovered&&this.ensureLine(),this.nodes.push(e),this.writtenTo=this.pos=this.pos+e.length,t&&t.endSide>0&&(this.covering=e)}addLineDeco(e,t,n){let s=this.ensureLine();s.length+=n,s.collapsed+=n,s.widgetHeight=Math.max(s.widgetHeight,e),s.breaks+=t,this.writtenTo=this.pos=this.pos+n}finish(e){let t=this.nodes.length==0?null:this.nodes[this.nodes.length-1];this.lineStart>-1&&!(t instanceof un)&&!this.isCovered?this.nodes.push(new un(0,-1)):(this.writtenTo<this.pos||t==null)&&this.nodes.push(this.blankContent(this.writtenTo,this.pos));let n=e;for(let s of this.nodes)s instanceof un&&s.updateHeight(this.oracle,n),n+=s?s.length:1;return this.nodes}static build(e,t,n,s){let r=new gd(n,e);return _e.spans(t,n,s,r,0),r.finish(n)}}function Kw(i,e,t){let n=new Jw;return _e.compare(i,e,t,n,0),n.changes}class Jw{constructor(){this.changes=[]}compareRange(){}comparePoint(e,t,n,s){(e<t||n&&n.heightRelevant||s&&s.heightRelevant)&&vo(e,t,this.changes,5)}}function eP(i,e){let t=i.getBoundingClientRect(),n=i.ownerDocument,s=n.defaultView||window,r=Math.max(0,t.left),o=Math.min(s.innerWidth,t.right),a=Math.max(0,t.top),l=Math.min(s.innerHeight,t.bottom);for(let d=i.parentNode;d&&d!=n.body;)if(d.nodeType==1){let c=d,u=window.getComputedStyle(c);if((c.scrollHeight>c.clientHeight||c.scrollWidth>c.clientWidth)&&u.overflow!="visible"){let h=c.getBoundingClientRect();r=Math.max(r,h.left),o=Math.min(o,h.right),a=Math.max(a,h.top),l=Math.min(d==i.parentNode?s.innerHeight:l,h.bottom)}d=u.position=="absolute"||u.position=="fixed"?c.offsetParent:c.parentNode}else if(d.nodeType==11)d=d.host;else break;return{left:r-t.left,right:Math.max(r,o)-t.left,top:a-(t.top+e),bottom:Math.max(a,l)-(t.top+e)}}function tP(i){let e=i.getBoundingClientRect(),t=i.ownerDocument.defaultView||window;return e.left<t.innerWidth&&e.right>0&&e.top<t.innerHeight&&e.bottom>0}function nP(i,e){let t=i.getBoundingClientRect();return{left:0,right:t.right-t.left,top:e,bottom:t.bottom-(t.top+e)}}class ja{constructor(e,t,n,s){this.from=e,this.to=t,this.size=n,this.displaySize=s}static same(e,t){if(e.length!=t.length)return!1;for(let n=0;n<e.length;n++){let s=e[n],r=t[n];if(s.from!=r.from||s.to!=r.to||s.size!=r.size)return!1}return!0}draw(e,t){return ke.replace({widget:new sP(this.displaySize*(t?e.scaleY:e.scaleX),t)}).range(this.from,this.to)}}class sP extends Ai{constructor(e,t){super(),this.size=e,this.vertical=t}eq(e){return e.size==this.size&&e.vertical==this.vertical}toDOM(){let e=document.createElement("div");return this.vertical?e.style.height=this.size+"px":(e.style.width=this.size+"px",e.style.height="2px",e.style.display="inline-block"),e}get estimatedHeight(){return this.vertical?this.size:-1}}class nh{constructor(e){this.state=e,this.pixelViewport={left:0,right:window.innerWidth,top:0,bottom:0},this.inView=!0,this.paddingTop=0,this.paddingBottom=0,this.contentDOMWidth=0,this.contentDOMHeight=0,this.editorHeight=0,this.editorWidth=0,this.scrollTop=0,this.scrolledToBottom=!1,this.scaleX=1,this.scaleY=1,this.scrollAnchorPos=0,this.scrollAnchorHeight=-1,this.scaler=sh,this.scrollTarget=null,this.printing=!1,this.mustMeasureContent=!0,this.defaultTextDirection=bt.LTR,this.visibleRanges=[],this.mustEnforceCursorAssoc=!1;let t=e.facet(md).some(n=>typeof n!="function"&&n.class=="cm-lineWrapping");this.heightOracle=new Ww(t),this.stateDeco=e.facet(br).filter(n=>typeof n!="function"),this.heightMap=Ut.empty().applyChanges(this.stateDeco,Qe.empty,this.heightOracle.setDoc(e.doc),[new wn(0,0,0,e.doc.length)]);for(let n=0;n<2&&(this.viewport=this.getViewport(0,null),!!this.updateForViewport());n++);this.updateViewportLines(),this.lineGaps=this.ensureLineGaps([]),this.lineGapDeco=ke.set(this.lineGaps.map(n=>n.draw(this,!1))),this.computeVisibleRanges()}updateForViewport(){let e=[this.viewport],{main:t}=this.state.selection;for(let n=0;n<=1;n++){let s=n?t.head:t.anchor;if(!e.some(({from:r,to:o})=>s>=r&&s<=o)){let{from:r,to:o}=this.lineBlockAt(s);e.push(new Hr(r,o))}}return this.viewports=e.sort((n,s)=>n.from-s.from),this.updateScaler()}updateScaler(){let e=this.scaler;return this.scaler=this.heightMap.height<=7e6?sh:new Od(this.heightOracle,this.heightMap,this.viewports),e.eq(this.scaler)?0:2}updateViewportLines(){this.viewportLines=[],this.heightMap.forEachLine(this.viewport.from,this.viewport.to,this.heightOracle.setDoc(this.state.doc),0,0,e=>{this.viewportLines.push(nr(e,this.scaler))})}update(e,t=null){this.state=e.state;let n=this.stateDeco;this.stateDeco=this.state.facet(br).filter(c=>typeof c!="function");let s=e.changedRanges,r=wn.extendWithRanges(s,Kw(n,this.stateDeco,e?e.changes:Ot.empty(this.state.doc.length))),o=this.heightMap.height,a=this.scrolledToBottom?null:this.scrollAnchorAt(this.scrollTop);eh(),this.heightMap=this.heightMap.applyChanges(this.stateDeco,e.startState.doc,this.heightOracle.setDoc(this.state.doc),r),(this.heightMap.height!=o||$i)&&(e.flags|=2),a?(this.scrollAnchorPos=e.changes.mapPos(a.from,-1),this.scrollAnchorHeight=a.top):(this.scrollAnchorPos=-1,this.scrollAnchorHeight=o);let l=r.length?this.mapViewport(this.viewport,e.changes):this.viewport;(t&&(t.range.head<l.from||t.range.head>l.to)||!this.viewportIsAppropriate(l))&&(l=this.getViewport(0,t));let d=l.from!=this.viewport.from||l.to!=this.viewport.to;this.viewport=l,e.flags|=this.updateForViewport(),(d||!e.changes.empty||e.flags&2)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(this.mapLineGaps(this.lineGaps,e.changes))),e.flags|=this.computeVisibleRanges(e.changes),t&&(this.scrollTarget=t),!this.mustEnforceCursorAssoc&&e.selectionSet&&e.view.lineWrapping&&e.state.selection.main.empty&&e.state.selection.main.assoc&&!e.state.facet(ow)&&(this.mustEnforceCursorAssoc=!0)}measure(e){let t=e.contentDOM,n=window.getComputedStyle(t),s=this.heightOracle,r=n.whiteSpace;this.defaultTextDirection=n.direction=="rtl"?bt.RTL:bt.LTR;let o=this.heightOracle.mustRefreshForWrapping(r),a=t.getBoundingClientRect(),l=o||this.mustMeasureContent||this.contentDOMHeight!=a.height;this.contentDOMHeight=a.height,this.mustMeasureContent=!1;let d=0,c=0;if(a.width&&a.height){let{scaleX:b,scaleY:S}=op(t,a);(b>.005&&Math.abs(this.scaleX-b)>.005||S>.005&&Math.abs(this.scaleY-S)>.005)&&(this.scaleX=b,this.scaleY=S,d|=16,o=l=!0)}let u=(parseInt(n.paddingTop)||0)*this.scaleY,h=(parseInt(n.paddingBottom)||0)*this.scaleY;(this.paddingTop!=u||this.paddingBottom!=h)&&(this.paddingTop=u,this.paddingBottom=h,d|=18),this.editorWidth!=e.scrollDOM.clientWidth&&(s.lineWrapping&&(l=!0),this.editorWidth=e.scrollDOM.clientWidth,d|=16);let f=e.scrollDOM.scrollTop*this.scaleY;this.scrollTop!=f&&(this.scrollAnchorHeight=-1,this.scrollTop=f),this.scrolledToBottom=cp(e.scrollDOM);let m=(this.printing?nP:eP)(t,this.paddingTop),g=m.top-this.pixelViewport.top,O=m.bottom-this.pixelViewport.bottom;this.pixelViewport=m;let p=this.pixelViewport.bottom>this.pixelViewport.top&&this.pixelViewport.right>this.pixelViewport.left;if(p!=this.inView&&(this.inView=p,p&&(l=!0)),!this.inView&&!this.scrollTarget&&!tP(e.dom))return 0;let y=a.width;if((this.contentDOMWidth!=y||this.editorHeight!=e.scrollDOM.clientHeight)&&(this.contentDOMWidth=a.width,this.editorHeight=e.scrollDOM.clientHeight,d|=16),l){let b=e.docView.measureVisibleLineHeights(this.viewport);if(s.mustRefreshForHeights(b)&&(o=!0),o||s.lineWrapping&&Math.abs(y-this.contentDOMWidth)>s.charWidth){let{lineHeight:S,charWidth:k,textHeight:x}=e.docView.measureTextSize();o=S>0&&s.refresh(r,S,k,x,Math.max(5,y/k),b),o&&(e.docView.minWidth=0,d|=16)}g>0&&O>0?c=Math.max(g,O):g<0&&O<0&&(c=Math.min(g,O)),eh();for(let S of this.viewports){let k=S.from==this.viewport.from?b:e.docView.measureVisibleLineHeights(S);this.heightMap=(o?Ut.empty().applyChanges(this.stateDeco,Qe.empty,this.heightOracle,[new wn(0,0,0,e.state.doc.length)]):this.heightMap).updateHeight(s,0,o,new qw(S.from,k))}$i&&(d|=2)}let M=!this.viewportIsAppropriate(this.viewport,c)||this.scrollTarget&&(this.scrollTarget.range.head<this.viewport.from||this.scrollTarget.range.head>this.viewport.to);return M&&(d&2&&(d|=this.updateScaler()),this.viewport=this.getViewport(c,this.scrollTarget),d|=this.updateForViewport()),(d&2||M)&&this.updateViewportLines(),(this.lineGaps.length||this.viewport.to-this.viewport.from>4e3)&&this.updateLineGaps(this.ensureLineGaps(o?[]:this.lineGaps,e)),d|=this.computeVisibleRanges(),this.mustEnforceCursorAssoc&&(this.mustEnforceCursorAssoc=!1,e.docView.enforceCursorAssoc()),d}get visibleTop(){return this.scaler.fromDOM(this.pixelViewport.top)}get visibleBottom(){return this.scaler.fromDOM(this.pixelViewport.bottom)}getViewport(e,t){let n=.5-Math.max(-.5,Math.min(.5,e/1e3/2)),s=this.heightMap,r=this.heightOracle,{visibleTop:o,visibleBottom:a}=this,l=new Hr(s.lineAt(o-n*1e3,tt.ByHeight,r,0,0).from,s.lineAt(a+(1-n)*1e3,tt.ByHeight,r,0,0).to);if(t){let{head:d}=t.range;if(d<l.from||d>l.to){let c=Math.min(this.editorHeight,this.pixelViewport.bottom-this.pixelViewport.top),u=s.lineAt(d,tt.ByPos,r,0,0),h;t.y=="center"?h=(u.top+u.bottom)/2-c/2:t.y=="start"||t.y=="nearest"&&d<l.from?h=u.top:h=u.bottom-c,l=new Hr(s.lineAt(h-1e3/2,tt.ByHeight,r,0,0).from,s.lineAt(h+c+1e3/2,tt.ByHeight,r,0,0).to)}}return l}mapViewport(e,t){let n=t.mapPos(e.from,-1),s=t.mapPos(e.to,1);return new Hr(this.heightMap.lineAt(n,tt.ByPos,this.heightOracle,0,0).from,this.heightMap.lineAt(s,tt.ByPos,this.heightOracle,0,0).to)}viewportIsAppropriate({from:e,to:t},n=0){if(!this.inView)return!0;let{top:s}=this.heightMap.lineAt(e,tt.ByPos,this.heightOracle,0,0),{bottom:r}=this.heightMap.lineAt(t,tt.ByPos,this.heightOracle,0,0),{visibleTop:o,visibleBottom:a}=this;return(e==0||s<=o-Math.max(10,Math.min(-n,250)))&&(t==this.state.doc.length||r>=a+Math.max(10,Math.min(n,250)))&&s>o-2*1e3&&r<a+2*1e3}mapLineGaps(e,t){if(!e.length||t.empty)return e;let n=[];for(let s of e)t.touchesRange(s.from,s.to)||n.push(new ja(t.mapPos(s.from),t.mapPos(s.to),s.size,s.displaySize));return n}ensureLineGaps(e,t){let n=this.heightOracle.lineWrapping,s=n?1e4:2e3,r=s>>1,o=s<<1;if(this.defaultTextDirection!=bt.LTR&&!n)return[];let a=[],l=(c,u,h,f)=>{if(u-c<r)return;let m=this.state.selection.main,g=[m.from];m.empty||g.push(m.to);for(let p of g)if(p>c&&p<u){l(c,p-10,h,f),l(p+10,u,h,f);return}let O=rP(e,p=>p.from>=h.from&&p.to<=h.to&&Math.abs(p.from-c)<r&&Math.abs(p.to-u)<r&&!g.some(y=>p.from<y&&p.to>y));if(!O){if(u<h.to&&t&&n&&t.visibleRanges.some(M=>M.from<=u&&M.to>=u)){let M=t.moveToLineBoundary(j.cursor(u),!1,!0).head;M>c&&(u=M)}let p=this.gapSize(h,c,u,f),y=n||p<2e6?p:2e6;O=new ja(c,u,p,y)}a.push(O)},d=c=>{if(c.length<o||c.type!=vn.Text)return;let u=iP(c.from,c.to,this.stateDeco);if(u.total<o)return;let h=this.scrollTarget?this.scrollTarget.range.head:null,f,m;if(n){let g=s/this.heightOracle.lineLength*this.heightOracle.lineHeight,O,p;if(h!=null){let y=Kr(u,h),M=((this.visibleBottom-this.visibleTop)/2+g)/c.height;O=y-M,p=y+M}else O=(this.visibleTop-c.top-g)/c.height,p=(this.visibleBottom-c.top+g)/c.height;f=Yr(u,O),m=Yr(u,p)}else{let g=u.total*this.heightOracle.charWidth,O=s*this.heightOracle.charWidth,p=0;if(g>2e6)for(let k of e)k.from>=c.from&&k.from<c.to&&k.size!=k.displaySize&&k.from*this.heightOracle.charWidth+p<this.pixelViewport.left&&(p=k.size-k.displaySize);let y=this.pixelViewport.left+p,M=this.pixelViewport.right+p,b,S;if(h!=null){let k=Kr(u,h),x=((M-y)/2+O)/g;b=k-x,S=k+x}else b=(y-O)/g,S=(M+O)/g;f=Yr(u,b),m=Yr(u,S)}f>c.from&&l(c.from,f,c,u),m<c.to&&l(m,c.to,c,u)};for(let c of this.viewportLines)Array.isArray(c.type)?c.type.forEach(d):d(c);return a}gapSize(e,t,n,s){let r=Kr(s,n)-Kr(s,t);return this.heightOracle.lineWrapping?e.height*r:s.total*this.heightOracle.charWidth*r}updateLineGaps(e){ja.same(e,this.lineGaps)||(this.lineGaps=e,this.lineGapDeco=ke.set(e.map(t=>t.draw(this,this.heightOracle.lineWrapping))))}computeVisibleRanges(e){let t=this.stateDeco;this.lineGaps.length&&(t=t.concat(this.lineGapDeco));let n=[];_e.spans(t,this.viewport.from,this.viewport.to,{span(r,o){n.push({from:r,to:o})},point(){}},20);let s=0;if(n.length!=this.visibleRanges.length)s=12;else for(let r=0;r<n.length&&!(s&8);r++){let o=this.visibleRanges[r],a=n[r];(o.from!=a.from||o.to!=a.to)&&(s|=4,e&&e.mapPos(o.from,-1)==a.from&&e.mapPos(o.to,1)==a.to||(s|=8))}return this.visibleRanges=n,s}lineBlockAt(e){return e>=this.viewport.from&&e<=this.viewport.to&&this.viewportLines.find(t=>t.from<=e&&t.to>=e)||nr(this.heightMap.lineAt(e,tt.ByPos,this.heightOracle,0,0),this.scaler)}lineBlockAtHeight(e){return e>=this.viewportLines[0].top&&e<=this.viewportLines[this.viewportLines.length-1].bottom&&this.viewportLines.find(t=>t.top<=e&&t.bottom>=e)||nr(this.heightMap.lineAt(this.scaler.fromDOM(e),tt.ByHeight,this.heightOracle,0,0),this.scaler)}scrollAnchorAt(e){let t=this.lineBlockAtHeight(e+8);return t.from>=this.viewport.from||this.viewportLines[0].top-e>200?t:this.viewportLines[0]}elementAtHeight(e){return nr(this.heightMap.blockAt(this.scaler.fromDOM(e),this.heightOracle,0,0),this.scaler)}get docHeight(){return this.scaler.toDOM(this.heightMap.height)}get contentHeight(){return this.docHeight+this.paddingTop+this.paddingBottom}}class Hr{constructor(e,t){this.from=e,this.to=t}}function iP(i,e,t){let n=[],s=i,r=0;return _e.spans(t,i,e,{span(){},point(o,a){o>s&&(n.push({from:s,to:o}),r+=o-s),s=a}},20),s<e&&(n.push({from:s,to:e}),r+=e-s),{total:r,ranges:n}}function Yr({total:i,ranges:e},t){if(t<=0)return e[0].from;if(t>=1)return e[e.length-1].to;let n=Math.floor(i*t);for(let s=0;;s++){let{from:r,to:o}=e[s],a=o-r;if(n<=a)return r+n;n-=a}}function Kr(i,e){let t=0;for(let{from:n,to:s}of i.ranges){if(e<=s){t+=e-n;break}t+=s-n}return t/i.total}function rP(i,e){for(let t of i)if(e(t))return t}const sh={toDOM(i){return i},fromDOM(i){return i},scale:1,eq(i){return i==this}};class Od{constructor(e,t,n){let s=0,r=0,o=0;this.viewports=n.map(({from:a,to:l})=>{let d=t.lineAt(a,tt.ByPos,e,0,0).top,c=t.lineAt(l,tt.ByPos,e,0,0).bottom;return s+=c-d,{from:a,to:l,top:d,bottom:c,domTop:0,domBottom:0}}),this.scale=(7e6-s)/(t.height-s);for(let a of this.viewports)a.domTop=o+(a.top-r)*this.scale,o=a.domBottom=a.domTop+(a.bottom-a.top),r=a.bottom}toDOM(e){for(let t=0,n=0,s=0;;t++){let r=t<this.viewports.length?this.viewports[t]:null;if(!r||e<r.top)return s+(e-n)*this.scale;if(e<=r.bottom)return r.domTop+(e-r.top);n=r.bottom,s=r.domBottom}}fromDOM(e){for(let t=0,n=0,s=0;;t++){let r=t<this.viewports.length?this.viewports[t]:null;if(!r||e<r.domTop)return n+(e-s)/this.scale;if(e<=r.domBottom)return r.top+(e-r.domTop);n=r.bottom,s=r.domBottom}}eq(e){return e instanceof Od?this.scale==e.scale&&this.viewports.length==e.viewports.length&&this.viewports.every((t,n)=>t.from==e.viewports[n].from&&t.to==e.viewports[n].to):!1}}function nr(i,e){if(e.scale==1)return i;let t=e.toDOM(i.top),n=e.toDOM(i.bottom);return new Fn(i.from,i.length,t,n-t,Array.isArray(i._content)?i._content.map(s=>nr(s,e)):i._content)}const Jr=he.define({combine:i=>i.join(" ")}),gc=he.define({combine:i=>i.indexOf(!0)>-1}),Oc=Ps.newName(),Jp=Ps.newName(),eg=Ps.newName(),tg={"&light":"."+Jp,"&dark":"."+eg};function yc(i,e,t){return new Ps(e,{finish(n){return/&/.test(n)?n.replace(/&\w*/,s=>{if(s=="&")return i;if(!t||!t[s])throw new RangeError(`Unsupported selector: ${s}`);return t[s]}):i+" "+n}})}const oP=yc("."+Oc,{"&":{position:"relative !important",boxSizing:"border-box","&.cm-focused":{outline:"1px dotted #212121"},display:"flex !important",flexDirection:"column"},".cm-scroller":{display:"flex !important",alignItems:"flex-start !important",fontFamily:"monospace",lineHeight:1.4,height:"100%",overflowX:"auto",position:"relative",zIndex:0,overflowAnchor:"none"},".cm-content":{margin:0,flexGrow:2,flexShrink:0,display:"block",whiteSpace:"pre",wordWrap:"normal",boxSizing:"border-box",minHeight:"100%",padding:"4px 0",outline:"none","&[contenteditable=true]":{WebkitUserModify:"read-write-plaintext-only"}},".cm-lineWrapping":{whiteSpace_fallback:"pre-wrap",whiteSpace:"break-spaces",wordBreak:"break-word",overflowWrap:"anywhere",flexShrink:1},"&light .cm-content":{caretColor:"black"},"&dark .cm-content":{caretColor:"white"},".cm-line":{display:"block",padding:"0 2px 0 6px"},".cm-layer":{position:"absolute",left:0,top:0,contain:"size style","& > *":{position:"absolute"}},"&light .cm-selectionBackground":{background:"#d9d9d9"},"&dark .cm-selectionBackground":{background:"#222"},"&light.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground":{background:"#d7d4f0"},"&dark.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground":{background:"#233"},".cm-cursorLayer":{pointerEvents:"none"},"&.cm-focused > .cm-scroller > .cm-cursorLayer":{animation:"steps(1) cm-blink 1.2s infinite"},"@keyframes cm-blink":{"0%":{},"50%":{opacity:0},"100%":{}},"@keyframes cm-blink2":{"0%":{},"50%":{opacity:0},"100%":{}},".cm-cursor, .cm-dropCursor":{borderLeft:"1.2px solid black",marginLeft:"-0.6px",pointerEvents:"none"},".cm-cursor":{display:"none"},"&dark .cm-cursor":{borderLeftColor:"#ddd"},".cm-dropCursor":{position:"absolute"},"&.cm-focused > .cm-scroller > .cm-cursorLayer .cm-cursor":{display:"block"},".cm-iso":{unicodeBidi:"isolate"},".cm-announced":{position:"fixed",top:"-10000px"},"@media print":{".cm-announced":{display:"none"}},"&light .cm-activeLine":{backgroundColor:"#cceeff44"},"&dark .cm-activeLine":{backgroundColor:"#99eeff33"},"&light .cm-specialChar":{color:"red"},"&dark .cm-specialChar":{color:"#f78"},".cm-gutters":{flexShrink:0,display:"flex",height:"100%",boxSizing:"border-box",zIndex:200},".cm-gutters-before":{insetInlineStart:0},".cm-gutters-after":{insetInlineEnd:0},"&light .cm-gutters":{backgroundColor:"#f5f5f5",color:"#6c6c6c",border:"0px solid #ddd","&.cm-gutters-before":{borderRightWidth:"1px"},"&.cm-gutters-after":{borderLeftWidth:"1px"}},"&dark .cm-gutters":{backgroundColor:"#333338",color:"#ccc"},".cm-gutter":{display:"flex !important",flexDirection:"column",flexShrink:0,boxSizing:"border-box",minHeight:"100%",overflow:"hidden"},".cm-gutterElement":{boxSizing:"border-box"},".cm-lineNumbers .cm-gutterElement":{padding:"0 3px 0 5px",minWidth:"20px",textAlign:"right",whiteSpace:"nowrap"},"&light .cm-activeLineGutter":{backgroundColor:"#e2f2ff"},"&dark .cm-activeLineGutter":{backgroundColor:"#222227"},".cm-panels":{boxSizing:"border-box",position:"sticky",left:0,right:0,zIndex:300},"&light .cm-panels":{backgroundColor:"#f5f5f5",color:"black"},"&light .cm-panels-top":{borderBottom:"1px solid #ddd"},"&light .cm-panels-bottom":{borderTop:"1px solid #ddd"},"&dark .cm-panels":{backgroundColor:"#333338",color:"white"},".cm-dialog":{padding:"2px 19px 4px 6px",position:"relative","& label":{fontSize:"80%"}},".cm-dialog-close":{position:"absolute",top:"3px",right:"4px",backgroundColor:"inherit",border:"none",font:"inherit",fontSize:"14px",padding:"0"},".cm-tab":{display:"inline-block",overflow:"hidden",verticalAlign:"bottom"},".cm-widgetBuffer":{verticalAlign:"text-top",height:"1em",width:0,display:"inline"},".cm-placeholder":{color:"#888",display:"inline-block",verticalAlign:"top",userSelect:"none"},".cm-highlightSpace":{backgroundImage:"radial-gradient(circle at 50% 55%, #aaa 20%, transparent 5%)",backgroundPosition:"center"},".cm-highlightTab":{backgroundImage:`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="20"><path stroke="%23888" stroke-width="1" fill="none" d="M1 10H196L190 5M190 15L196 10M197 4L197 16"/></svg>')`,backgroundSize:"auto 100%",backgroundPosition:"right 90%",backgroundRepeat:"no-repeat"},".cm-trailingSpace":{backgroundColor:"#ff332255"},".cm-button":{verticalAlign:"middle",color:"inherit",fontSize:"70%",padding:".2em 1em",borderRadius:"1px"},"&light .cm-button":{backgroundImage:"linear-gradient(#eff1f5, #d9d9df)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#b4b4b4, #d0d3d6)"}},"&dark .cm-button":{backgroundImage:"linear-gradient(#393939, #111)",border:"1px solid #888","&:active":{backgroundImage:"linear-gradient(#111, #333)"}},".cm-textfield":{verticalAlign:"middle",color:"inherit",fontSize:"70%",border:"1px solid silver",padding:".2em .5em"},"&light .cm-textfield":{backgroundColor:"white"},"&dark .cm-textfield":{border:"1px solid #555",backgroundColor:"inherit"}},tg),aP={childList:!0,characterData:!0,subtree:!0,attributes:!0,characterDataOldValue:!0},Fa=re.ie&&re.ie_version<=11;class lP{constructor(e){this.view=e,this.active=!1,this.editContext=null,this.selectionRange=new Zv,this.selectionChanged=!1,this.delayedFlush=-1,this.resizeTimeout=-1,this.queue=[],this.delayedAndroidKey=null,this.flushingAndroidKey=-1,this.lastChange=0,this.scrollTargets=[],this.intersection=null,this.resizeScroll=null,this.intersecting=!1,this.gapIntersection=null,this.gaps=[],this.printQuery=null,this.parentCheck=-1,this.dom=e.contentDOM,this.observer=new MutationObserver(t=>{for(let n of t)this.queue.push(n);(re.ie&&re.ie_version<=11||re.ios&&e.composing)&&t.some(n=>n.type=="childList"&&n.removedNodes.length||n.type=="characterData"&&n.oldValue.length>n.target.nodeValue.length)?this.flushSoon():this.flush()}),window.EditContext&&re.android&&e.constructor.EDIT_CONTEXT!==!1&&!(re.chrome&&re.chrome_version<126)&&(this.editContext=new dP(e),e.state.facet(rs)&&(e.contentDOM.editContext=this.editContext.editContext)),Fa&&(this.onCharData=t=>{this.queue.push({target:t.target,type:"characterData",oldValue:t.prevValue}),this.flushSoon()}),this.onSelectionChange=this.onSelectionChange.bind(this),this.onResize=this.onResize.bind(this),this.onPrint=this.onPrint.bind(this),this.onScroll=this.onScroll.bind(this),window.matchMedia&&(this.printQuery=window.matchMedia("print")),typeof ResizeObserver=="function"&&(this.resizeScroll=new ResizeObserver(()=>{var t;((t=this.view.docView)===null||t===void 0?void 0:t.lastUpdate)<Date.now()-75&&this.onResize()}),this.resizeScroll.observe(e.scrollDOM)),this.addWindowListeners(this.win=e.win),this.start(),typeof IntersectionObserver=="function"&&(this.intersection=new IntersectionObserver(t=>{this.parentCheck<0&&(this.parentCheck=setTimeout(this.listenForScroll.bind(this),1e3)),t.length>0&&t[t.length-1].intersectionRatio>0!=this.intersecting&&(this.intersecting=!this.intersecting,this.intersecting!=this.view.inView&&this.onScrollChanged(document.createEvent("Event")))},{threshold:[0,.001]}),this.intersection.observe(this.dom),this.gapIntersection=new IntersectionObserver(t=>{t.length>0&&t[t.length-1].intersectionRatio>0&&this.onScrollChanged(document.createEvent("Event"))},{})),this.listenForScroll(),this.readSelectionRange()}onScrollChanged(e){this.view.inputState.runHandlers("scroll",e),this.intersecting&&this.view.measure()}onScroll(e){this.intersecting&&this.flush(!1),this.editContext&&this.view.requestMeasure(this.editContext.measureReq),this.onScrollChanged(e)}onResize(){this.resizeTimeout<0&&(this.resizeTimeout=setTimeout(()=>{this.resizeTimeout=-1,this.view.requestMeasure()},50))}onPrint(e){(e.type=="change"||!e.type)&&!e.matches||(this.view.viewState.printing=!0,this.view.measure(),setTimeout(()=>{this.view.viewState.printing=!1,this.view.requestMeasure()},500))}updateGaps(e){if(this.gapIntersection&&(e.length!=this.gaps.length||this.gaps.some((t,n)=>t!=e[n]))){this.gapIntersection.disconnect();for(let t of e)this.gapIntersection.observe(t);this.gaps=e}}onSelectionChange(e){let t=this.selectionChanged;if(!this.readSelectionRange()||this.delayedAndroidKey)return;let{view:n}=this,s=this.selectionRange;if(n.state.facet(rs)?n.root.activeElement!=this.dom:!bo(this.dom,s))return;let r=s.anchorNode&&n.docView.nearest(s.anchorNode);if(r&&r.ignoreEvent(e)){t||(this.selectionChanged=!1);return}(re.ie&&re.ie_version<=11||re.android&&re.chrome)&&!n.state.selection.main.empty&&s.focusNode&&ar(s.focusNode,s.focusOffset,s.anchorNode,s.anchorOffset)?this.flushSoon():this.flush(!1)}readSelectionRange(){let{view:e}=this,t=Or(e.root);if(!t)return!1;let n=re.safari&&e.root.nodeType==11&&e.root.activeElement==this.dom&&cP(this.view,t)||t;if(!n||this.selectionRange.eq(n))return!1;let s=bo(this.dom,n);return s&&!this.selectionChanged&&e.inputState.lastFocusTime>Date.now()-200&&e.inputState.lastTouchTime<Date.now()-300&&Fv(this.dom,n)?(this.view.inputState.lastFocusTime=0,e.docView.updateSelection(),!1):(this.selectionRange.setRange(n),s&&(this.selectionChanged=!0),!0)}setSelectionRange(e,t){this.selectionRange.set(e.node,e.offset,t.node,t.offset),this.selectionChanged=!1}clearSelectionRange(){this.selectionRange.set(null,0,null,0)}listenForScroll(){this.parentCheck=-1;let e=0,t=null;for(let n=this.dom;n;)if(n.nodeType==1)!t&&e<this.scrollTargets.length&&this.scrollTargets[e]==n?e++:t||(t=this.scrollTargets.slice(0,e)),t&&t.push(n),n=n.assignedSlot||n.parentNode;else if(n.nodeType==11)n=n.host;else break;if(e<this.scrollTargets.length&&!t&&(t=this.scrollTargets.slice(0,e)),t){for(let n of this.scrollTargets)n.removeEventListener("scroll",this.onScroll);for(let n of this.scrollTargets=t)n.addEventListener("scroll",this.onScroll)}}ignore(e){if(!this.active)return e();try{return this.stop(),e()}finally{this.start(),this.clear()}}start(){this.active||(this.observer.observe(this.dom,aP),Fa&&this.dom.addEventListener("DOMCharacterDataModified",this.onCharData),this.active=!0)}stop(){this.active&&(this.active=!1,this.observer.disconnect(),Fa&&this.dom.removeEventListener("DOMCharacterDataModified",this.onCharData))}clear(){this.processRecords(),this.queue.length=0,this.selectionChanged=!1}delayAndroidKey(e,t){var n;if(!this.delayedAndroidKey){let s=()=>{let r=this.delayedAndroidKey;r&&(this.clearDelayedAndroidKey(),this.view.inputState.lastKeyCode=r.keyCode,this.view.inputState.lastKeyTime=Date.now(),!this.flush()&&r.force&&bi(this.dom,r.key,r.keyCode))};this.flushingAndroidKey=this.view.win.requestAnimationFrame(s)}(!this.delayedAndroidKey||e=="Enter")&&(this.delayedAndroidKey={key:e,keyCode:t,force:this.lastChange<Date.now()-50||!!(!((n=this.delayedAndroidKey)===null||n===void 0)&&n.force)})}clearDelayedAndroidKey(){this.win.cancelAnimationFrame(this.flushingAndroidKey),this.delayedAndroidKey=null,this.flushingAndroidKey=-1}flushSoon(){this.delayedFlush<0&&(this.delayedFlush=this.view.win.requestAnimationFrame(()=>{this.delayedFlush=-1,this.flush()}))}forceFlush(){this.delayedFlush>=0&&(this.view.win.cancelAnimationFrame(this.delayedFlush),this.delayedFlush=-1),this.flush()}pendingRecords(){for(let e of this.observer.takeRecords())this.queue.push(e);return this.queue}processRecords(){let e=this.pendingRecords();e.length&&(this.queue=[]);let t=-1,n=-1,s=!1;for(let r of e){let o=this.readMutation(r);o&&(o.typeOver&&(s=!0),t==-1?{from:t,to:n}=o:(t=Math.min(o.from,t),n=Math.max(o.to,n)))}return{from:t,to:n,typeOver:s}}readChange(){let{from:e,to:t,typeOver:n}=this.processRecords(),s=this.selectionChanged&&bo(this.dom,this.selectionRange);if(e<0&&!s)return null;e>-1&&(this.lastChange=Date.now()),this.view.inputState.lastFocusTime=0,this.selectionChanged=!1;let r=new Mw(this.view,e,t,n);return this.view.docView.domChanged={newSel:r.newSel?r.newSel.main:null},r}flush(e=!0){if(this.delayedFlush>=0||this.delayedAndroidKey)return!1;e&&this.readSelectionRange();let t=this.readChange();if(!t)return this.view.requestMeasure(),!1;let n=this.view.state,s=Zp(this.view,t);return this.view.state==n&&(t.domChanged||t.newSel&&!t.newSel.main.eq(this.view.state.selection.main))&&this.view.update([]),s}readMutation(e){let t=this.view.docView.nearest(e.target);if(!t||t.ignoreMutation(e))return null;if(t.markDirty(e.type=="attributes"),e.type=="attributes"&&(t.flags|=4),e.type=="childList"){let n=ih(t,e.previousSibling||e.target.previousSibling,-1),s=ih(t,e.nextSibling||e.target.nextSibling,1);return{from:n?t.posAfter(n):t.posAtStart,to:s?t.posBefore(s):t.posAtEnd,typeOver:!1}}else return e.type=="characterData"?{from:t.posAtStart,to:t.posAtEnd,typeOver:e.target.nodeValue==e.oldValue}:null}setWindow(e){e!=this.win&&(this.removeWindowListeners(this.win),this.win=e,this.addWindowListeners(this.win))}addWindowListeners(e){e.addEventListener("resize",this.onResize),this.printQuery?this.printQuery.addEventListener?this.printQuery.addEventListener("change",this.onPrint):this.printQuery.addListener(this.onPrint):e.addEventListener("beforeprint",this.onPrint),e.addEventListener("scroll",this.onScroll),e.document.addEventListener("selectionchange",this.onSelectionChange)}removeWindowListeners(e){e.removeEventListener("scroll",this.onScroll),e.removeEventListener("resize",this.onResize),this.printQuery?this.printQuery.removeEventListener?this.printQuery.removeEventListener("change",this.onPrint):this.printQuery.removeListener(this.onPrint):e.removeEventListener("beforeprint",this.onPrint),e.document.removeEventListener("selectionchange",this.onSelectionChange)}update(e){this.editContext&&(this.editContext.update(e),e.startState.facet(rs)!=e.state.facet(rs)&&(e.view.contentDOM.editContext=e.state.facet(rs)?this.editContext.editContext:null))}destroy(){var e,t,n;this.stop(),(e=this.intersection)===null||e===void 0||e.disconnect(),(t=this.gapIntersection)===null||t===void 0||t.disconnect(),(n=this.resizeScroll)===null||n===void 0||n.disconnect();for(let s of this.scrollTargets)s.removeEventListener("scroll",this.onScroll);this.removeWindowListeners(this.win),clearTimeout(this.parentCheck),clearTimeout(this.resizeTimeout),this.win.cancelAnimationFrame(this.delayedFlush),this.win.cancelAnimationFrame(this.flushingAndroidKey),this.editContext&&(this.view.contentDOM.editContext=null,this.editContext.destroy())}}function ih(i,e,t){for(;e;){let n=Ge.get(e);if(n&&n.parent==i)return n;let s=e.parentNode;e=s!=i.dom?s:t>0?e.nextSibling:e.previousSibling}return null}function rh(i,e){let t=e.startContainer,n=e.startOffset,s=e.endContainer,r=e.endOffset,o=i.docView.domAtPos(i.state.selection.main.anchor);return ar(o.node,o.offset,s,r)&&([t,n,s,r]=[s,r,t,n]),{anchorNode:t,anchorOffset:n,focusNode:s,focusOffset:r}}function cP(i,e){if(e.getComposedRanges){let s=e.getComposedRanges(i.root)[0];if(s)return rh(i,s)}let t=null;function n(s){s.preventDefault(),s.stopImmediatePropagation(),t=s.getTargetRanges()[0]}return i.contentDOM.addEventListener("beforeinput",n,!0),i.dom.ownerDocument.execCommand("indent"),i.contentDOM.removeEventListener("beforeinput",n,!0),t?rh(i,t):null}class dP{constructor(e){this.from=0,this.to=0,this.pendingContextChange=null,this.handlers=Object.create(null),this.composing=null,this.resetRange(e.state);let t=this.editContext=new window.EditContext({text:e.state.doc.sliceString(this.from,this.to),selectionStart:this.toContextPos(Math.max(this.from,Math.min(this.to,e.state.selection.main.anchor))),selectionEnd:this.toContextPos(e.state.selection.main.head)});this.handlers.textupdate=n=>{let s=e.state.selection.main,{anchor:r,head:o}=s,a=this.toEditorPos(n.updateRangeStart),l=this.toEditorPos(n.updateRangeEnd);e.inputState.composing>=0&&!this.composing&&(this.composing={contextBase:n.updateRangeStart,editorBase:a,drifted:!1});let d=l-a>n.text.length;a==this.from&&r<this.from?a=r:l==this.to&&r>this.to&&(l=r);let c=jp(e.state.sliceDoc(a,l),n.text,(d?s.from:s.to)-a,d?"end":null);if(!c){let h=j.single(this.toEditorPos(n.selectionStart),this.toEditorPos(n.selectionEnd));h.main.eq(s)||e.dispatch({selection:h,userEvent:"select"});return}let u={from:c.from+a,to:c.toA+a,insert:Qe.of(n.text.slice(c.from,c.toB).split(`
`))};if((re.mac||re.android)&&u.from==o-1&&/^\. ?$/.test(n.text)&&e.contentDOM.getAttribute("autocorrect")=="off"&&(u={from:a,to:l,insert:Qe.of([n.text.replace("."," ")])}),this.pendingContextChange=u,!e.state.readOnly){let h=this.to-this.from+(u.to-u.from+u.insert.length);pd(e,u,j.single(this.toEditorPos(n.selectionStart,h),this.toEditorPos(n.selectionEnd,h)))}this.pendingContextChange&&(this.revertPending(e.state),this.setSelection(e.state)),u.from<u.to&&!u.insert.length&&e.inputState.composing>=0&&!/[\\p{Alphabetic}\\p{Number}_]/.test(t.text.slice(Math.max(0,n.updateRangeStart-1),Math.min(t.text.length,n.updateRangeStart+1)))&&this.handlers.compositionend(n)},this.handlers.characterboundsupdate=n=>{let s=[],r=null;for(let o=this.toEditorPos(n.rangeStart),a=this.toEditorPos(n.rangeEnd);o<a;o++){let l=e.coordsForChar(o);r=l&&new DOMRect(l.left,l.top,l.right-l.left,l.bottom-l.top)||r||new DOMRect,s.push(r)}t.updateCharacterBounds(n.rangeStart,s)},this.handlers.textformatupdate=n=>{let s=[];for(let r of n.getTextFormats()){let o=r.underlineStyle,a=r.underlineThickness;if(!/none/i.test(o)&&!/none/i.test(a)){let l=this.toEditorPos(r.rangeStart),d=this.toEditorPos(r.rangeEnd);if(l<d){let c=`text-decoration: underline ${/^[a-z]/.test(o)?o+" ":o=="Dashed"?"dashed ":o=="Squiggle"?"wavy ":""}${/thin/i.test(a)?1:2}px`;s.push(ke.mark({attributes:{style:c}}).range(l,d))}}}e.dispatch({effects:Np.of(ke.set(s))})},this.handlers.compositionstart=()=>{e.inputState.composing<0&&(e.inputState.composing=0,e.inputState.compositionFirstChange=!0)},this.handlers.compositionend=()=>{if(e.inputState.composing=-1,e.inputState.compositionFirstChange=null,this.composing){let{drifted:n}=this.composing;this.composing=null,n&&this.reset(e.state)}};for(let n in this.handlers)t.addEventListener(n,this.handlers[n]);this.measureReq={read:n=>{this.editContext.updateControlBounds(n.contentDOM.getBoundingClientRect());let s=Or(n.root);s&&s.rangeCount&&this.editContext.updateSelectionBounds(s.getRangeAt(0).getBoundingClientRect())}}}applyEdits(e){let t=0,n=!1,s=this.pendingContextChange;return e.changes.iterChanges((r,o,a,l,d)=>{if(n)return;let c=d.length-(o-r);if(s&&o>=s.to)if(s.from==r&&s.to==o&&s.insert.eq(d)){s=this.pendingContextChange=null,t+=c,this.to+=c;return}else s=null,this.revertPending(e.state);if(r+=t,o+=t,o<=this.from)this.from+=c,this.to+=c;else if(r<this.to){if(r<this.from||o>this.to||this.to-this.from+d.length>3e4){n=!0;return}this.editContext.updateText(this.toContextPos(r),this.toContextPos(o),d.toString()),this.to+=c}t+=c}),s&&!n&&this.revertPending(e.state),!n}update(e){let t=this.pendingContextChange,n=e.startState.selection.main;this.composing&&(this.composing.drifted||!e.changes.touchesRange(n.from,n.to)&&e.transactions.some(s=>!s.isUserEvent("input.type")&&s.changes.touchesRange(this.from,this.to)))?(this.composing.drifted=!0,this.composing.editorBase=e.changes.mapPos(this.composing.editorBase)):!this.applyEdits(e)||!this.rangeIsValid(e.state)?(this.pendingContextChange=null,this.reset(e.state)):(e.docChanged||e.selectionSet||t)&&this.setSelection(e.state),(e.geometryChanged||e.docChanged||e.selectionSet)&&e.view.requestMeasure(this.measureReq)}resetRange(e){let{head:t}=e.selection.main;this.from=Math.max(0,t-1e4),this.to=Math.min(e.doc.length,t+1e4)}reset(e){this.resetRange(e),this.editContext.updateText(0,this.editContext.text.length,e.doc.sliceString(this.from,this.to)),this.setSelection(e)}revertPending(e){let t=this.pendingContextChange;this.pendingContextChange=null,this.editContext.updateText(this.toContextPos(t.from),this.toContextPos(t.from+t.insert.length),e.doc.sliceString(t.from,t.to))}setSelection(e){let{main:t}=e.selection,n=this.toContextPos(Math.max(this.from,Math.min(this.to,t.anchor))),s=this.toContextPos(t.head);(this.editContext.selectionStart!=n||this.editContext.selectionEnd!=s)&&this.editContext.updateSelection(n,s)}rangeIsValid(e){let{head:t}=e.selection.main;return!(this.from>0&&t-this.from<500||this.to<e.doc.length&&this.to-t<500||this.to-this.from>1e4*3)}toEditorPos(e,t=this.to-this.from){e=Math.min(e,t);let n=this.composing;return n&&n.drifted?n.editorBase+(e-n.contextBase):e+this.from}toContextPos(e){let t=this.composing;return t&&t.drifted?t.contextBase+(e-t.editorBase):e-this.from}destroy(){for(let e in this.handlers)this.editContext.removeEventListener(e,this.handlers[e])}}class de{get state(){return this.viewState.state}get viewport(){return this.viewState.viewport}get visibleRanges(){return this.viewState.visibleRanges}get inView(){return this.viewState.inView}get composing(){return!!this.inputState&&this.inputState.composing>0}get compositionStarted(){return!!this.inputState&&this.inputState.composing>=0}get root(){return this._root}get win(){return this.dom.ownerDocument.defaultView||window}constructor(e={}){var t;this.plugins=[],this.pluginMap=new Map,this.editorAttrs={},this.contentAttrs={},this.bidiCache=[],this.destroyed=!1,this.updateState=2,this.measureScheduled=-1,this.measureRequests=[],this.contentDOM=document.createElement("div"),this.scrollDOM=document.createElement("div"),this.scrollDOM.tabIndex=-1,this.scrollDOM.className="cm-scroller",this.scrollDOM.appendChild(this.contentDOM),this.announceDOM=document.createElement("div"),this.announceDOM.className="cm-announced",this.announceDOM.setAttribute("aria-live","polite"),this.dom=document.createElement("div"),this.dom.appendChild(this.announceDOM),this.dom.appendChild(this.scrollDOM),e.parent&&e.parent.appendChild(this.dom);let{dispatch:n}=e;this.dispatchTransactions=e.dispatchTransactions||n&&(s=>s.forEach(r=>n(r,this)))||(s=>this.update(s)),this.dispatch=this.dispatch.bind(this),this._root=e.root||jv(e.parent)||document,this.viewState=new nh(e.state||ze.create(e)),e.scrollTo&&e.scrollTo.is(Ur)&&(this.viewState.scrollTarget=e.scrollTo.value.clip(this.viewState.state)),this.plugins=this.state.facet(pi).map(s=>new za(s));for(let s of this.plugins)s.update(this);this.observer=new lP(this),this.inputState=new Tw(this),this.inputState.ensureHandlers(this.plugins),this.docView=new Lu(this),this.mountStyles(),this.updateAttrs(),this.updateState=0,this.requestMeasure(),!((t=document.fonts)===null||t===void 0)&&t.ready&&document.fonts.ready.then(()=>this.requestMeasure())}dispatch(...e){let t=e.length==1&&e[0]instanceof mt?e:e.length==1&&Array.isArray(e[0])?e[0]:[this.state.update(...e)];this.dispatchTransactions(t,this)}update(e){if(this.updateState!=0)throw new Error("Calls to EditorView.update are not allowed while an update is in progress");let t=!1,n=!1,s,r=this.state;for(let h of e){if(h.startState!=r)throw new RangeError("Trying to update state with a transaction that doesn't start from the previous state.");r=h.state}if(this.destroyed){this.viewState.state=r;return}let o=this.hasFocus,a=0,l=null;e.some(h=>h.annotation(qp))?(this.inputState.notifiedFocused=o,a=1):o!=this.inputState.notifiedFocused&&(this.inputState.notifiedFocused=o,l=Hp(r,o),l||(a=1));let d=this.observer.delayedAndroidKey,c=null;if(d?(this.observer.clearDelayedAndroidKey(),c=this.observer.readChange(),(c&&!this.state.doc.eq(r.doc)||!this.state.selection.eq(r.selection))&&(c=null)):this.observer.clear(),r.facet(ze.phrases)!=this.state.facet(ze.phrases))return this.setState(r);s=_o.create(this,r,e),s.flags|=a;let u=this.viewState.scrollTarget;try{this.updateState=2;for(let h of e){if(u&&(u=u.map(h.changes)),h.scrollIntoView){let{main:f}=h.state.selection;u=new vi(f.empty?f:j.cursor(f.head,f.head>f.anchor?-1:1))}for(let f of h.effects)f.is(Ur)&&(u=f.value.clip(this.state))}this.viewState.update(s,u),this.bidiCache=Lo.update(this.bidiCache,s.changes),s.empty||(this.updatePlugins(s),this.inputState.update(s)),t=this.docView.update(s),this.state.facet(er)!=this.styleModules&&this.mountStyles(),n=this.updateAttrs(),this.showAnnouncements(e),this.docView.updateSelection(t,e.some(h=>h.isUserEvent("select.pointer")))}finally{this.updateState=0}if(s.startState.facet(Jr)!=s.state.facet(Jr)&&(this.viewState.mustMeasureContent=!0),(t||n||u||this.viewState.mustEnforceCursorAssoc||this.viewState.mustMeasureContent)&&this.requestMeasure(),t&&this.docViewUpdate(),!s.empty)for(let h of this.state.facet(fc))try{h(s)}catch(f){Gn(this.state,f,"update listener")}(l||c)&&Promise.resolve().then(()=>{l&&this.state==l.startState&&this.dispatch(l),c&&!Zp(this,c)&&d.force&&bi(this.contentDOM,d.key,d.keyCode)})}setState(e){if(this.updateState!=0)throw new Error("Calls to EditorView.setState are not allowed while an update is in progress");if(this.destroyed){this.viewState.state=e;return}this.updateState=2;let t=this.hasFocus;try{for(let n of this.plugins)n.destroy(this);this.viewState=new nh(e),this.plugins=e.facet(pi).map(n=>new za(n)),this.pluginMap.clear();for(let n of this.plugins)n.update(this);this.docView.destroy(),this.docView=new Lu(this),this.inputState.ensureHandlers(this.plugins),this.mountStyles(),this.updateAttrs(),this.bidiCache=[]}finally{this.updateState=0}t&&this.focus(),this.requestMeasure()}updatePlugins(e){let t=e.startState.facet(pi),n=e.state.facet(pi);if(t!=n){let s=[];for(let r of n){let o=t.indexOf(r);if(o<0)s.push(new za(r));else{let a=this.plugins[o];a.mustUpdate=e,s.push(a)}}for(let r of this.plugins)r.mustUpdate!=e&&r.destroy(this);this.plugins=s,this.pluginMap.clear()}else for(let s of this.plugins)s.mustUpdate=e;for(let s=0;s<this.plugins.length;s++)this.plugins[s].update(this);t!=n&&this.inputState.ensureHandlers(this.plugins)}docViewUpdate(){for(let e of this.plugins){let t=e.value;if(t&&t.docViewUpdate)try{t.docViewUpdate(this)}catch(n){Gn(this.state,n,"doc view update listener")}}}measure(e=!0){if(this.destroyed)return;if(this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled),this.observer.delayedAndroidKey){this.measureScheduled=-1,this.requestMeasure();return}this.measureScheduled=0,e&&this.observer.forceFlush();let t=null,n=this.scrollDOM,s=n.scrollTop*this.scaleY,{scrollAnchorPos:r,scrollAnchorHeight:o}=this.viewState;Math.abs(s-this.viewState.scrollTop)>1&&(o=-1),this.viewState.scrollAnchorHeight=-1;try{for(let a=0;;a++){if(o<0)if(cp(n))r=-1,o=this.viewState.heightMap.height;else{let f=this.viewState.scrollAnchorAt(s);r=f.from,o=f.top}this.updateState=1;let l=this.viewState.measure(this);if(!l&&!this.measureRequests.length&&this.viewState.scrollTarget==null)break;if(a>5){console.warn(this.measureRequests.length?"Measure loop restarted more than 5 times":"Viewport failed to stabilize");break}let d=[];l&4||([this.measureRequests,d]=[d,this.measureRequests]);let c=d.map(f=>{try{return f.read(this)}catch(m){return Gn(this.state,m),oh}}),u=_o.create(this,this.state,[]),h=!1;u.flags|=l,t?t.flags|=l:t=u,this.updateState=2,u.empty||(this.updatePlugins(u),this.inputState.update(u),this.updateAttrs(),h=this.docView.update(u),h&&this.docViewUpdate());for(let f=0;f<d.length;f++)if(c[f]!=oh)try{let m=d[f];m.write&&m.write(c[f],this)}catch(m){Gn(this.state,m)}if(h&&this.docView.updateSelection(!0),!u.viewportChanged&&this.measureRequests.length==0){if(this.viewState.editorHeight)if(this.viewState.scrollTarget){this.docView.scrollIntoView(this.viewState.scrollTarget),this.viewState.scrollTarget=null,o=-1;continue}else{let m=(r<0?this.viewState.heightMap.height:this.viewState.lineBlockAt(r).top)-o;if(m>1||m<-1){s=s+m,n.scrollTop=s/this.scaleY,o=-1;continue}}break}}}finally{this.updateState=0,this.measureScheduled=-1}if(t&&!t.empty)for(let a of this.state.facet(fc))a(t)}get themeClasses(){return Oc+" "+(this.state.facet(gc)?eg:Jp)+" "+this.state.facet(Jr)}updateAttrs(){let e=ah(this,Qp,{class:"cm-editor"+(this.hasFocus?" cm-focused ":" ")+this.themeClasses}),t={spellcheck:"false",autocorrect:"off",autocapitalize:"off",writingsuggestions:"false",translate:"no",contenteditable:this.state.facet(rs)?"true":"false",class:"cm-content",style:`${re.tabSize}: ${this.state.tabSize}`,role:"textbox","aria-multiline":"true"};this.state.readOnly&&(t["aria-readonly"]="true"),ah(this,md,t);let n=this.observer.ignore(()=>{let s=lc(this.contentDOM,this.contentAttrs,t),r=lc(this.dom,this.editorAttrs,e);return s||r});return this.editorAttrs=e,this.contentAttrs=t,n}showAnnouncements(e){let t=!0;for(let n of e)for(let s of n.effects)if(s.is(de.announce)){t&&(this.announceDOM.textContent=""),t=!1;let r=this.announceDOM.appendChild(document.createElement("div"));r.textContent=s.value}}mountStyles(){this.styleModules=this.state.facet(er);let e=this.state.facet(de.cspNonce);Ps.mount(this.root,this.styleModules.concat(oP).reverse(),e?{nonce:e}:void 0)}readMeasured(){if(this.updateState==2)throw new Error("Reading the editor layout isn't allowed during an update");this.updateState==0&&this.measureScheduled>-1&&this.measure(!1)}requestMeasure(e){if(this.measureScheduled<0&&(this.measureScheduled=this.win.requestAnimationFrame(()=>this.measure())),e){if(this.measureRequests.indexOf(e)>-1)return;if(e.key!=null){for(let t=0;t<this.measureRequests.length;t++)if(this.measureRequests[t].key===e.key){this.measureRequests[t]=e;return}}this.measureRequests.push(e)}}plugin(e){let t=this.pluginMap.get(e);return(t===void 0||t&&t.plugin!=e)&&this.pluginMap.set(e,t=this.plugins.find(n=>n.plugin==e)||null),t&&t.update(this).value}get documentTop(){return this.contentDOM.getBoundingClientRect().top+this.viewState.paddingTop}get documentPadding(){return{top:this.viewState.paddingTop,bottom:this.viewState.paddingBottom}}get scaleX(){return this.viewState.scaleX}get scaleY(){return this.viewState.scaleY}elementAtHeight(e){return this.readMeasured(),this.viewState.elementAtHeight(e)}lineBlockAtHeight(e){return this.readMeasured(),this.viewState.lineBlockAtHeight(e)}get viewportLineBlocks(){return this.viewState.viewportLines}lineBlockAt(e){return this.viewState.lineBlockAt(e)}get contentHeight(){return this.viewState.contentHeight}moveByChar(e,t,n){return Za(this,e,Zu(this,e,t,n))}moveByGroup(e,t){return Za(this,e,Zu(this,e,t,n=>Pw(this,e.head,n)))}visualLineSide(e,t){let n=this.bidiSpans(e),s=this.textDirectionAt(e.from),r=n[t?n.length-1:0];return j.cursor(r.side(t,s)+e.from,r.forward(!t,s)?1:-1)}moveToLineBoundary(e,t,n=!0){return ww(this,e,t,n)}moveVertically(e,t,n){return Za(this,e,Sw(this,e,t,n))}domAtPos(e){return this.docView.domAtPos(e)}posAtDOM(e,t=0){return this.docView.posFromDOM(e,t)}posAtCoords(e,t=!0){return this.readMeasured(),Dp(this,e,t)}coordsAtPos(e,t=1){this.readMeasured();let n=this.docView.coordsAt(e,t);if(!n||n.left==n.right)return n;let s=this.state.doc.lineAt(e),r=this.bidiSpans(s),o=r[vs.find(r,e-s.from,-1,t)];return ua(n,o.dir==bt.LTR==t>0)}coordsForChar(e){return this.readMeasured(),this.docView.coordsForChar(e)}get defaultCharacterWidth(){return this.viewState.heightOracle.charWidth}get defaultLineHeight(){return this.viewState.heightOracle.lineHeight}get textDirection(){return this.viewState.defaultTextDirection}textDirectionAt(e){return!this.state.facet(Ap)||e<this.viewport.from||e>this.viewport.to?this.textDirection:(this.readMeasured(),this.docView.textDirectionAt(e))}get lineWrapping(){return this.viewState.heightOracle.lineWrapping}bidiSpans(e){if(e.length>uP)return Pp(e.length);let t=this.textDirectionAt(e.from),n;for(let r of this.bidiCache)if(r.from==e.from&&r.dir==t&&(r.fresh||wp(r.isolates,n=Iu(this,e))))return r.order;n||(n=Iu(this,e));let s=sw(e.text,t,n);return this.bidiCache.push(new Lo(e.from,e.to,t,n,!0,s)),s}get hasFocus(){var e;return(this.dom.ownerDocument.hasFocus()||re.safari&&((e=this.inputState)===null||e===void 0?void 0:e.lastContextMenu)>Date.now()-3e4)&&this.root.activeElement==this.contentDOM}focus(){this.observer.ignore(()=>{ap(this.contentDOM),this.docView.updateSelection()})}setRoot(e){this._root!=e&&(this._root=e,this.observer.setWindow((e.nodeType==9?e:e.ownerDocument).defaultView||window),this.mountStyles())}destroy(){this.root.activeElement==this.contentDOM&&this.contentDOM.blur();for(let e of this.plugins)e.destroy(this);this.plugins=[],this.inputState.destroy(),this.docView.destroy(),this.dom.remove(),this.observer.destroy(),this.measureScheduled>-1&&this.win.cancelAnimationFrame(this.measureScheduled),this.destroyed=!0}static scrollIntoView(e,t={}){return Ur.of(new vi(typeof e=="number"?j.cursor(e):e,t.y,t.x,t.yMargin,t.xMargin))}scrollSnapshot(){let{scrollTop:e,scrollLeft:t}=this.scrollDOM,n=this.viewState.scrollAnchorAt(e);return Ur.of(new vi(j.cursor(n.from),"start","start",n.top-e,t,!0))}setTabFocusMode(e){e==null?this.inputState.tabFocusMode=this.inputState.tabFocusMode<0?0:-1:typeof e=="boolean"?this.inputState.tabFocusMode=e?0:-1:this.inputState.tabFocusMode!=0&&(this.inputState.tabFocusMode=Date.now()+e)}static domEventHandlers(e){return ts.define(()=>({}),{eventHandlers:e})}static domEventObservers(e){return ts.define(()=>({}),{eventObservers:e})}static theme(e,t){let n=Ps.newName(),s=[Jr.of(n),er.of(yc(`.${n}`,e))];return t&&t.dark&&s.push(gc.of(!0)),s}static baseTheme(e){return aa.lowest(er.of(yc("."+Oc,e,tg)))}static findFromDOM(e){var t;let n=e.querySelector(".cm-content"),s=n&&Ge.get(n)||Ge.get(e);return((t=s==null?void 0:s.rootView)===null||t===void 0?void 0:t.view)||null}}de.styleModule=er;de.inputHandler=Cp;de.clipboardInputFilter=hd;de.clipboardOutputFilter=fd;de.scrollHandler=Tp;de.focusChangeEffect=Ep;de.perLineTextDirection=Ap;de.exceptionSink=Mp;de.updateListener=fc;de.editable=rs;de.mouseSelectionStyle=$p;de.dragMovesSelection=xp;de.clickAddsSelectionRange=kp;de.decorations=br;de.outerDecorations=Rp;de.atomicRanges=Er;de.bidiIsolatedRanges=_p;de.scrollMargins=Ip;de.darkTheme=gc;de.cspNonce=he.define({combine:i=>i.length?i[0]:""});de.contentAttributes=md;de.editorAttributes=Qp;de.lineWrapping=de.contentAttributes.of({class:"cm-lineWrapping"});de.announce=Ve.define();const uP=4096,oh={};class Lo{constructor(e,t,n,s,r,o){this.from=e,this.to=t,this.dir=n,this.isolates=s,this.fresh=r,this.order=o}static update(e,t){if(t.empty&&!e.some(r=>r.fresh))return e;let n=[],s=e.length?e[e.length-1].dir:bt.LTR;for(let r=Math.max(0,e.length-10);r<e.length;r++){let o=e[r];o.dir==s&&!t.touchesRange(o.from,o.to)&&n.push(new Lo(t.mapPos(o.from,1),t.mapPos(o.to,-1),o.dir,o.isolates,!1,o.order))}return n}}function ah(i,e,t){for(let n=i.state.facet(e),s=n.length-1;s>=0;s--){let r=n[s],o=typeof r=="function"?r(i):r;o&&ac(o,t)}return t}const hP=re.mac?"mac":re.windows?"win":re.linux?"linux":"key";function fP(i,e){const t=i.split(/-(?!$)/);let n=t[t.length-1];n=="Space"&&(n=" ");let s,r,o,a;for(let l=0;l<t.length-1;++l){const d=t[l];if(/^(cmd|meta|m)$/i.test(d))a=!0;else if(/^a(lt)?$/i.test(d))s=!0;else if(/^(c|ctrl|control)$/i.test(d))r=!0;else if(/^s(hift)?$/i.test(d))o=!0;else if(/^mod$/i.test(d))e=="mac"?a=!0:r=!0;else throw new Error("Unrecognized modifier name: "+d)}return s&&(n="Alt-"+n),r&&(n="Ctrl-"+n),a&&(n="Meta-"+n),o&&(n="Shift-"+n),n}function eo(i,e,t){return e.altKey&&(i="Alt-"+i),e.ctrlKey&&(i="Ctrl-"+i),e.metaKey&&(i="Meta-"+i),t!==!1&&e.shiftKey&&(i="Shift-"+i),i}const mP=aa.default(de.domEventHandlers({keydown(i,e){return yP(pP(e.state),i,e,"editor")}})),yd=he.define({enables:mP}),lh=new WeakMap;function pP(i){let e=i.facet(yd),t=lh.get(e);return t||lh.set(e,t=OP(e.reduce((n,s)=>n.concat(s),[]))),t}let ys=null;const gP=4e3;function OP(i,e=hP){let t=Object.create(null),n=Object.create(null),s=(o,a)=>{let l=n[o];if(l==null)n[o]=a;else if(l!=a)throw new Error("Key binding "+o+" is used both as a regular binding and as a multi-stroke prefix")},r=(o,a,l,d,c)=>{var u,h;let f=t[o]||(t[o]=Object.create(null)),m=a.split(/ (?!$)/).map(p=>fP(p,e));for(let p=1;p<m.length;p++){let y=m.slice(0,p).join(" ");s(y,!0),f[y]||(f[y]={preventDefault:!0,stopPropagation:!1,run:[M=>{let b=ys={view:M,prefix:y,scope:o};return setTimeout(()=>{ys==b&&(ys=null)},gP),!0}]})}let g=m.join(" ");s(g,!1);let O=f[g]||(f[g]={preventDefault:!1,stopPropagation:!1,run:((h=(u=f._any)===null||u===void 0?void 0:u.run)===null||h===void 0?void 0:h.slice())||[]});l&&O.run.push(l),d&&(O.preventDefault=!0),c&&(O.stopPropagation=!0)};for(let o of i){let a=o.scope?o.scope.split(" "):["editor"];if(o.any)for(let d of a){let c=t[d]||(t[d]=Object.create(null));c._any||(c._any={preventDefault:!1,stopPropagation:!1,run:[]});let{any:u}=o;for(let h in c)c[h].run.push(f=>u(f,bc))}let l=o[e]||o.key;if(l)for(let d of a)r(d,l,o.run,o.preventDefault,o.stopPropagation),o.shift&&r(d,"Shift-"+l,o.shift,o.preventDefault,o.stopPropagation)}return t}let bc=null;function yP(i,e,t,n){bc=e;let s=Lv(e),r=ei(s,0),o=xr(r)==s.length&&s!=" ",a="",l=!1,d=!1,c=!1;ys&&ys.view==t&&ys.scope==n&&(a=ys.prefix+" ",Gp.indexOf(e.keyCode)<0&&(d=!0,ys=null));let u=new Set,h=O=>{if(O){for(let p of O.run)if(!u.has(p)&&(u.add(p),p(t)))return O.stopPropagation&&(c=!0),!0;O.preventDefault&&(O.stopPropagation&&(c=!0),d=!0)}return!1},f=i[n],m,g;return f&&(h(f[a+eo(s,e,!o)])?l=!0:o&&(e.altKey||e.metaKey||e.ctrlKey)&&!(re.windows&&e.ctrlKey&&e.altKey)&&!(re.mac&&e.altKey&&!(e.ctrlKey||e.metaKey))&&(m=Ss[e.keyCode])&&m!=s?(h(f[a+eo(m,e,!0)])||e.shiftKey&&(g=gr[e.keyCode])!=s&&g!=m&&h(f[a+eo(g,e,!1)]))&&(l=!0):o&&e.shiftKey&&h(f[a+eo(s,e,!0)])&&(l=!0),!l&&h(f._any)&&(l=!0)),d&&(l=!0),l&&c&&e.stopPropagation(),bc=null,l}class xs extends Ws{compare(e){return this==e||this.constructor==e.constructor&&this.eq(e)}eq(e){return!1}destroy(e){}}xs.prototype.elementClass="";xs.prototype.toDOM=void 0;xs.prototype.mapMode=Lt.TrackBefore;xs.prototype.startSide=xs.prototype.endSide=-1;xs.prototype.point=!0;const Ga=he.define(),bP=he.define(),vP={class:"",renderEmptyElements:!1,elementStyle:"",markers:()=>_e.empty,lineMarker:()=>null,widgetMarker:()=>null,lineMarkerChange:null,initialSpacer:null,updateSpacer:null,domEventHandlers:{},side:"before"},dr=he.define();function wP(i){return[ng(),dr.of({...vP,...i})]}const ch=he.define({combine:i=>i.some(e=>e)});function ng(i){return[PP]}const PP=ts.fromClass(class{constructor(i){this.view=i,this.domAfter=null,this.prevViewport=i.viewport,this.dom=document.createElement("div"),this.dom.className="cm-gutters cm-gutters-before",this.dom.setAttribute("aria-hidden","true"),this.dom.style.minHeight=this.view.contentHeight/this.view.scaleY+"px",this.gutters=i.state.facet(dr).map(e=>new uh(i,e)),this.fixed=!i.state.facet(ch);for(let e of this.gutters)e.config.side=="after"?this.getDOMAfter().appendChild(e.dom):this.dom.appendChild(e.dom);this.fixed&&(this.dom.style.position="sticky"),this.syncGutters(!1),i.scrollDOM.insertBefore(this.dom,i.contentDOM)}getDOMAfter(){return this.domAfter||(this.domAfter=document.createElement("div"),this.domAfter.className="cm-gutters cm-gutters-after",this.domAfter.setAttribute("aria-hidden","true"),this.domAfter.style.minHeight=this.view.contentHeight/this.view.scaleY+"px",this.domAfter.style.position=this.fixed?"sticky":"",this.view.scrollDOM.appendChild(this.domAfter)),this.domAfter}update(i){if(this.updateGutters(i)){let e=this.prevViewport,t=i.view.viewport,n=Math.min(e.to,t.to)-Math.max(e.from,t.from);this.syncGutters(n<(t.to-t.from)*.8)}if(i.geometryChanged){let e=this.view.contentHeight/this.view.scaleY+"px";this.dom.style.minHeight=e,this.domAfter&&(this.domAfter.style.minHeight=e)}this.view.state.facet(ch)!=!this.fixed&&(this.fixed=!this.fixed,this.dom.style.position=this.fixed?"sticky":"",this.domAfter&&(this.domAfter.style.position=this.fixed?"sticky":"")),this.prevViewport=i.view.viewport}syncGutters(i){let e=this.dom.nextSibling;i&&(this.dom.remove(),this.domAfter&&this.domAfter.remove());let t=_e.iter(this.view.state.facet(Ga),this.view.viewport.from),n=[],s=this.gutters.map(r=>new SP(r,this.view.viewport,-this.view.documentPadding.top));for(let r of this.view.viewportLineBlocks)if(n.length&&(n=[]),Array.isArray(r.type)){let o=!0;for(let a of r.type)if(a.type==vn.Text&&o){vc(t,n,a.from);for(let l of s)l.line(this.view,a,n);o=!1}else if(a.widget)for(let l of s)l.widget(this.view,a)}else if(r.type==vn.Text){vc(t,n,r.from);for(let o of s)o.line(this.view,r,n)}else if(r.widget)for(let o of s)o.widget(this.view,r);for(let r of s)r.finish();i&&(this.view.scrollDOM.insertBefore(this.dom,e),this.domAfter&&this.view.scrollDOM.appendChild(this.domAfter))}updateGutters(i){let e=i.startState.facet(dr),t=i.state.facet(dr),n=i.docChanged||i.heightChanged||i.viewportChanged||!_e.eq(i.startState.facet(Ga),i.state.facet(Ga),i.view.viewport.from,i.view.viewport.to);if(e==t)for(let s of this.gutters)s.update(i)&&(n=!0);else{n=!0;let s=[];for(let r of t){let o=e.indexOf(r);o<0?s.push(new uh(this.view,r)):(this.gutters[o].update(i),s.push(this.gutters[o]))}for(let r of this.gutters)r.dom.remove(),s.indexOf(r)<0&&r.destroy();for(let r of s)r.config.side=="after"?this.getDOMAfter().appendChild(r.dom):this.dom.appendChild(r.dom);this.gutters=s}return n}destroy(){for(let i of this.gutters)i.destroy();this.dom.remove(),this.domAfter&&this.domAfter.remove()}},{provide:i=>de.scrollMargins.of(e=>{let t=e.plugin(i);if(!t||t.gutters.length==0||!t.fixed)return null;let n=t.dom.offsetWidth*e.scaleX,s=t.domAfter?t.domAfter.offsetWidth*e.scaleX:0;return e.textDirection==bt.LTR?{left:n,right:s}:{right:n,left:s}})});function dh(i){return Array.isArray(i)?i:[i]}function vc(i,e,t){for(;i.value&&i.from<=t;)i.from==t&&e.push(i.value),i.next()}class SP{constructor(e,t,n){this.gutter=e,this.height=n,this.i=0,this.cursor=_e.iter(e.markers,t.from)}addElement(e,t,n){let{gutter:s}=this,r=(t.top-this.height)/e.scaleY,o=t.height/e.scaleY;if(this.i==s.elements.length){let a=new sg(e,o,r,n);s.elements.push(a),s.dom.appendChild(a.dom)}else s.elements[this.i].update(e,o,r,n);this.height=t.bottom,this.i++}line(e,t,n){let s=[];vc(this.cursor,s,t.from),n.length&&(s=s.concat(n));let r=this.gutter.config.lineMarker(e,t,s);r&&s.unshift(r);let o=this.gutter;s.length==0&&!o.config.renderEmptyElements||this.addElement(e,t,s)}widget(e,t){let n=this.gutter.config.widgetMarker(e,t.widget,t),s=n?[n]:null;for(let r of e.state.facet(bP)){let o=r(e,t.widget,t);o&&(s||(s=[])).push(o)}s&&this.addElement(e,t,s)}finish(){let e=this.gutter;for(;e.elements.length>this.i;){let t=e.elements.pop();e.dom.removeChild(t.dom),t.destroy()}}}class uh{constructor(e,t){this.view=e,this.config=t,this.elements=[],this.spacer=null,this.dom=document.createElement("div"),this.dom.className="cm-gutter"+(this.config.class?" "+this.config.class:"");for(let n in t.domEventHandlers)this.dom.addEventListener(n,s=>{let r=s.target,o;if(r!=this.dom&&this.dom.contains(r)){for(;r.parentNode!=this.dom;)r=r.parentNode;let l=r.getBoundingClientRect();o=(l.top+l.bottom)/2}else o=s.clientY;let a=e.lineBlockAtHeight(o-e.documentTop);t.domEventHandlers[n](e,a,s)&&s.preventDefault()});this.markers=dh(t.markers(e)),t.initialSpacer&&(this.spacer=new sg(e,0,0,[t.initialSpacer(e)]),this.dom.appendChild(this.spacer.dom),this.spacer.dom.style.cssText+="visibility: hidden; pointer-events: none")}update(e){let t=this.markers;if(this.markers=dh(this.config.markers(e.view)),this.spacer&&this.config.updateSpacer){let s=this.config.updateSpacer(this.spacer.markers[0],e);s!=this.spacer.markers[0]&&this.spacer.update(e.view,0,0,[s])}let n=e.view.viewport;return!_e.eq(this.markers,t,n.from,n.to)||(this.config.lineMarkerChange?this.config.lineMarkerChange(e):!1)}destroy(){for(let e of this.elements)e.destroy()}}class sg{constructor(e,t,n,s){this.height=-1,this.above=0,this.markers=[],this.dom=document.createElement("div"),this.dom.className="cm-gutterElement",this.update(e,t,n,s)}update(e,t,n,s){this.height!=t&&(this.height=t,this.dom.style.height=t+"px"),this.above!=n&&(this.dom.style.marginTop=(this.above=n)?n+"px":""),kP(this.markers,s)||this.setMarkers(e,s)}setMarkers(e,t){let n="cm-gutterElement",s=this.dom.firstChild;for(let r=0,o=0;;){let a=o,l=r<t.length?t[r++]:null,d=!1;if(l){let c=l.elementClass;c&&(n+=" "+c);for(let u=o;u<this.markers.length;u++)if(this.markers[u].compare(l)){a=u,d=!0;break}}else a=this.markers.length;for(;o<a;){let c=this.markers[o++];if(c.toDOM){c.destroy(s);let u=s.nextSibling;s.remove(),s=u}}if(!l)break;l.toDOM&&(d?s=s.nextSibling:this.dom.insertBefore(l.toDOM(e),s)),d&&o++}this.dom.className=n,this.markers=t}destroy(){this.setMarkers(null,[])}}function kP(i,e){if(i.length!=e.length)return!1;for(let t=0;t<i.length;t++)if(!i[t].compare(e[t]))return!1;return!0}const xP=he.define(),$P=he.define(),gi=he.define({combine(i){return $r(i,{formatNumber:String,domEventHandlers:{}},{domEventHandlers(e,t){let n=Object.assign({},e);for(let s in t){let r=n[s],o=t[s];n[s]=r?(a,l,d)=>r(a,l,d)||o(a,l,d):o}return n}})}});class Xa extends xs{constructor(e){super(),this.number=e}eq(e){return this.number==e.number}toDOM(){return document.createTextNode(this.number)}}function Ua(i,e){return i.state.facet(gi).formatNumber(e,i.state)}const MP=dr.compute([gi],i=>({class:"cm-lineNumbers",renderEmptyElements:!1,markers(e){return e.state.facet(xP)},lineMarker(e,t,n){return n.some(s=>s.toDOM)?null:new Xa(Ua(e,e.state.doc.lineAt(t.from).number))},widgetMarker:(e,t,n)=>{for(let s of e.state.facet($P)){let r=s(e,t,n);if(r)return r}return null},lineMarkerChange:e=>e.startState.facet(gi)!=e.state.facet(gi),initialSpacer(e){return new Xa(Ua(e,fh(e.state.doc.lines)))},updateSpacer(e,t){let n=Ua(t.view,fh(t.view.state.doc.lines));return n==e.number?e:new Xa(n)},domEventHandlers:i.facet(gi).domEventHandlers,side:"before"}));function hh(i={}){return[gi.of(i),ng(),MP]}function fh(i){let e=9;for(;e<i;)e=e*10+9;return e}const ig=1024;let CP=0;class Wa{constructor(e,t){this.from=e,this.to=t}}class $e{constructor(e={}){this.id=CP++,this.perNode=!!e.perNode,this.deserialize=e.deserialize||(()=>{throw new Error("This node type doesn't define a deserialize function")}),this.combine=e.combine||null}add(e){if(this.perNode)throw new RangeError("Can't add per-node props to node types");return typeof e!="function"&&(e=rn.match(e)),t=>{let n=e(t);return n===void 0?null:[this,n]}}}$e.closedBy=new $e({deserialize:i=>i.split(" ")});$e.openedBy=new $e({deserialize:i=>i.split(" ")});$e.group=new $e({deserialize:i=>i.split(" ")});$e.isolate=new $e({deserialize:i=>{if(i&&i!="rtl"&&i!="ltr"&&i!="auto")throw new RangeError("Invalid value for isolate: "+i);return i||"auto"}});$e.contextHash=new $e({perNode:!0});$e.lookAhead=new $e({perNode:!0});$e.mounted=new $e({perNode:!0});class Bo{constructor(e,t,n){this.tree=e,this.overlay=t,this.parser=n}static get(e){return e&&e.props&&e.props[$e.mounted.id]}}const EP=Object.create(null);class rn{constructor(e,t,n,s=0){this.name=e,this.props=t,this.id=n,this.flags=s}static define(e){let t=e.props&&e.props.length?Object.create(null):EP,n=(e.top?1:0)|(e.skipped?2:0)|(e.error?4:0)|(e.name==null?8:0),s=new rn(e.name||"",t,e.id,n);if(e.props){for(let r of e.props)if(Array.isArray(r)||(r=r(s)),r){if(r[0].perNode)throw new RangeError("Can't store a per-node prop on a node type");t[r[0].id]=r[1]}}return s}prop(e){return this.props[e.id]}get isTop(){return(this.flags&1)>0}get isSkipped(){return(this.flags&2)>0}get isError(){return(this.flags&4)>0}get isAnonymous(){return(this.flags&8)>0}is(e){if(typeof e=="string"){if(this.name==e)return!0;let t=this.prop($e.group);return t?t.indexOf(e)>-1:!1}return this.id==e}static match(e){let t=Object.create(null);for(let n in e)for(let s of n.split(" "))t[s]=e[n];return n=>{for(let s=n.prop($e.group),r=-1;r<(s?s.length:0);r++){let o=t[r<0?n.name:s[r]];if(o)return o}}}}rn.none=new rn("",Object.create(null),0,8);class bd{constructor(e){this.types=e;for(let t=0;t<e.length;t++)if(e[t].id!=t)throw new RangeError("Node type ids should correspond to array positions when creating a node set")}extend(...e){let t=[];for(let n of this.types){let s=null;for(let r of e){let o=r(n);if(o){s||(s=Object.assign({},n.props));let a=o[1],l=o[0];l.combine&&l.id in s&&(a=l.combine(s[l.id],a)),s[l.id]=a}}t.push(s?new rn(n.name,s,n.id,n.flags):n)}return new bd(t)}}const to=new WeakMap,mh=new WeakMap;var yt;(function(i){i[i.ExcludeBuffers=1]="ExcludeBuffers",i[i.IncludeAnonymous=2]="IncludeAnonymous",i[i.IgnoreMounts=4]="IgnoreMounts",i[i.IgnoreOverlays=8]="IgnoreOverlays"})(yt||(yt={}));class pt{constructor(e,t,n,s,r){if(this.type=e,this.children=t,this.positions=n,this.length=s,this.props=null,r&&r.length){this.props=Object.create(null);for(let[o,a]of r)this.props[typeof o=="number"?o:o.id]=a}}toString(){let e=Bo.get(this);if(e&&!e.overlay)return e.tree.toString();let t="";for(let n of this.children){let s=n.toString();s&&(t&&(t+=","),t+=s)}return this.type.name?(/\W/.test(this.type.name)&&!this.type.isError?JSON.stringify(this.type.name):this.type.name)+(t.length?"("+t+")":""):t}cursor(e=0){return new Pc(this.topNode,e)}cursorAt(e,t=0,n=0){let s=to.get(this)||this.topNode,r=new Pc(s);return r.moveTo(e,t),to.set(this,r._tree),r}get topNode(){return new sn(this,0,0,null)}resolve(e,t=0){let n=vr(to.get(this)||this.topNode,e,t,!1);return to.set(this,n),n}resolveInner(e,t=0){let n=vr(mh.get(this)||this.topNode,e,t,!0);return mh.set(this,n),n}resolveStack(e,t=0){return NP(this,e,t)}iterate(e){let{enter:t,leave:n,from:s=0,to:r=this.length}=e,o=e.mode||0,a=(o&yt.IncludeAnonymous)>0;for(let l=this.cursor(o|yt.IncludeAnonymous);;){let d=!1;if(l.from<=r&&l.to>=s&&(!a&&l.type.isAnonymous||t(l)!==!1)){if(l.firstChild())continue;d=!0}for(;d&&n&&(a||!l.type.isAnonymous)&&n(l),!l.nextSibling();){if(!l.parent())return;d=!0}}}prop(e){return e.perNode?this.props?this.props[e.id]:void 0:this.type.prop(e)}get propValues(){let e=[];if(this.props)for(let t in this.props)e.push([+t,this.props[t]]);return e}balance(e={}){return this.children.length<=8?this:Pd(rn.none,this.children,this.positions,0,this.children.length,0,this.length,(t,n,s)=>new pt(this.type,t,n,s,this.propValues),e.makeTree||((t,n,s)=>new pt(rn.none,t,n,s)))}static build(e){return QP(e)}}pt.empty=new pt(rn.none,[],[],0);class vd{constructor(e,t){this.buffer=e,this.index=t}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}get pos(){return this.index}next(){this.index-=4}fork(){return new vd(this.buffer,this.index)}}class $s{constructor(e,t,n){this.buffer=e,this.length=t,this.set=n}get type(){return rn.none}toString(){let e=[];for(let t=0;t<this.buffer.length;)e.push(this.childString(t)),t=this.buffer[t+3];return e.join(",")}childString(e){let t=this.buffer[e],n=this.buffer[e+3],s=this.set.types[t],r=s.name;if(/\W/.test(r)&&!s.isError&&(r=JSON.stringify(r)),e+=4,n==e)return r;let o=[];for(;e<n;)o.push(this.childString(e)),e=this.buffer[e+3];return r+"("+o.join(",")+")"}findChild(e,t,n,s,r){let{buffer:o}=this,a=-1;for(let l=e;l!=t&&!(rg(r,s,o[l+1],o[l+2])&&(a=l,n>0));l=o[l+3]);return a}slice(e,t,n){let s=this.buffer,r=new Uint16Array(t-e),o=0;for(let a=e,l=0;a<t;){r[l++]=s[a++],r[l++]=s[a++]-n;let d=r[l++]=s[a++]-n;r[l++]=s[a++]-e,o=Math.max(o,d)}return new $s(r,o,this.set)}}function rg(i,e,t,n){switch(i){case-2:return t<e;case-1:return n>=e&&t<e;case 0:return t<e&&n>e;case 1:return t<=e&&n>e;case 2:return n>e;case 4:return!0}}function vr(i,e,t,n){for(var s;i.from==i.to||(t<1?i.from>=e:i.from>e)||(t>-1?i.to<=e:i.to<e);){let o=!n&&i instanceof sn&&i.index<0?null:i.parent;if(!o)return i;i=o}let r=n?0:yt.IgnoreOverlays;if(n)for(let o=i,a=o.parent;a;o=a,a=o.parent)o instanceof sn&&o.index<0&&((s=a.enter(e,t,r))===null||s===void 0?void 0:s.from)!=o.from&&(i=a);for(;;){let o=i.enter(e,t,r);if(!o)return i;i=o}}class og{cursor(e=0){return new Pc(this,e)}getChild(e,t=null,n=null){let s=ph(this,e,t,n);return s.length?s[0]:null}getChildren(e,t=null,n=null){return ph(this,e,t,n)}resolve(e,t=0){return vr(this,e,t,!1)}resolveInner(e,t=0){return vr(this,e,t,!0)}matchContext(e){return wc(this.parent,e)}enterUnfinishedNodesBefore(e){let t=this.childBefore(e),n=this;for(;t;){let s=t.lastChild;if(!s||s.to!=t.to)break;s.type.isError&&s.from==s.to?(n=t,t=s.prevSibling):t=s}return n}get node(){return this}get next(){return this.parent}}class sn extends og{constructor(e,t,n,s){super(),this._tree=e,this.from=t,this.index=n,this._parent=s}get type(){return this._tree.type}get name(){return this._tree.type.name}get to(){return this.from+this._tree.length}nextChild(e,t,n,s,r=0){for(let o=this;;){for(let{children:a,positions:l}=o._tree,d=t>0?a.length:-1;e!=d;e+=t){let c=a[e],u=l[e]+o.from;if(rg(s,n,u,u+c.length)){if(c instanceof $s){if(r&yt.ExcludeBuffers)continue;let h=c.findChild(0,c.buffer.length,t,n-u,s);if(h>-1)return new Xn(new AP(o,c,e,u),null,h)}else if(r&yt.IncludeAnonymous||!c.type.isAnonymous||wd(c)){let h;if(!(r&yt.IgnoreMounts)&&(h=Bo.get(c))&&!h.overlay)return new sn(h.tree,u,e,o);let f=new sn(c,u,e,o);return r&yt.IncludeAnonymous||!f.type.isAnonymous?f:f.nextChild(t<0?c.children.length-1:0,t,n,s)}}}if(r&yt.IncludeAnonymous||!o.type.isAnonymous||(o.index>=0?e=o.index+t:e=t<0?-1:o._parent._tree.children.length,o=o._parent,!o))return null}}get firstChild(){return this.nextChild(0,1,0,4)}get lastChild(){return this.nextChild(this._tree.children.length-1,-1,0,4)}childAfter(e){return this.nextChild(0,1,e,2)}childBefore(e){return this.nextChild(this._tree.children.length-1,-1,e,-2)}enter(e,t,n=0){let s;if(!(n&yt.IgnoreOverlays)&&(s=Bo.get(this._tree))&&s.overlay){let r=e-this.from;for(let{from:o,to:a}of s.overlay)if((t>0?o<=r:o<r)&&(t<0?a>=r:a>r))return new sn(s.tree,s.overlay[0].from+this.from,-1,this)}return this.nextChild(0,1,e,t,n)}nextSignificantParent(){let e=this;for(;e.type.isAnonymous&&e._parent;)e=e._parent;return e}get parent(){return this._parent?this._parent.nextSignificantParent():null}get nextSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index+1,1,0,4):null}get prevSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index-1,-1,0,4):null}get tree(){return this._tree}toTree(){return this._tree}toString(){return this._tree.toString()}}function ph(i,e,t,n){let s=i.cursor(),r=[];if(!s.firstChild())return r;if(t!=null){for(let o=!1;!o;)if(o=s.type.is(t),!s.nextSibling())return r}for(;;){if(n!=null&&s.type.is(n))return r;if(s.type.is(e)&&r.push(s.node),!s.nextSibling())return n==null?r:[]}}function wc(i,e,t=e.length-1){for(let n=i;t>=0;n=n.parent){if(!n)return!1;if(!n.type.isAnonymous){if(e[t]&&e[t]!=n.name)return!1;t--}}return!0}class AP{constructor(e,t,n,s){this.parent=e,this.buffer=t,this.index=n,this.start=s}}class Xn extends og{get name(){return this.type.name}get from(){return this.context.start+this.context.buffer.buffer[this.index+1]}get to(){return this.context.start+this.context.buffer.buffer[this.index+2]}constructor(e,t,n){super(),this.context=e,this._parent=t,this.index=n,this.type=e.buffer.set.types[e.buffer.buffer[n]]}child(e,t,n){let{buffer:s}=this.context,r=s.findChild(this.index+4,s.buffer[this.index+3],e,t-this.context.start,n);return r<0?null:new Xn(this.context,this,r)}get firstChild(){return this.child(1,0,4)}get lastChild(){return this.child(-1,0,4)}childAfter(e){return this.child(1,e,2)}childBefore(e){return this.child(-1,e,-2)}enter(e,t,n=0){if(n&yt.ExcludeBuffers)return null;let{buffer:s}=this.context,r=s.findChild(this.index+4,s.buffer[this.index+3],t>0?1:-1,e-this.context.start,t);return r<0?null:new Xn(this.context,this,r)}get parent(){return this._parent||this.context.parent.nextSignificantParent()}externalSibling(e){return this._parent?null:this.context.parent.nextChild(this.context.index+e,e,0,4)}get nextSibling(){let{buffer:e}=this.context,t=e.buffer[this.index+3];return t<(this._parent?e.buffer[this._parent.index+3]:e.buffer.length)?new Xn(this.context,this._parent,t):this.externalSibling(1)}get prevSibling(){let{buffer:e}=this.context,t=this._parent?this._parent.index+4:0;return this.index==t?this.externalSibling(-1):new Xn(this.context,this._parent,e.findChild(t,this.index,-1,0,4))}get tree(){return null}toTree(){let e=[],t=[],{buffer:n}=this.context,s=this.index+4,r=n.buffer[this.index+3];if(r>s){let o=n.buffer[this.index+1];e.push(n.slice(s,r,o)),t.push(0)}return new pt(this.type,e,t,this.to-this.from)}toString(){return this.context.buffer.childString(this.index)}}function ag(i){if(!i.length)return null;let e=0,t=i[0];for(let r=1;r<i.length;r++){let o=i[r];(o.from>t.from||o.to<t.to)&&(t=o,e=r)}let n=t instanceof sn&&t.index<0?null:t.parent,s=i.slice();return n?s[e]=n:s.splice(e,1),new TP(s,t)}class TP{constructor(e,t){this.heads=e,this.node=t}get next(){return ag(this.heads)}}function NP(i,e,t){let n=i.resolveInner(e,t),s=null;for(let r=n instanceof sn?n:n.context.parent;r;r=r.parent)if(r.index<0){let o=r.parent;(s||(s=[n])).push(o.resolve(e,t)),r=o}else{let o=Bo.get(r.tree);if(o&&o.overlay&&o.overlay[0].from<=e&&o.overlay[o.overlay.length-1].to>=e){let a=new sn(o.tree,o.overlay[0].from+r.from,-1,r);(s||(s=[n])).push(vr(a,e,t,!1))}}return s?ag(s):n}class Pc{get name(){return this.type.name}constructor(e,t=0){if(this.mode=t,this.buffer=null,this.stack=[],this.index=0,this.bufferNode=null,e instanceof sn)this.yieldNode(e);else{this._tree=e.context.parent,this.buffer=e.context;for(let n=e._parent;n;n=n._parent)this.stack.unshift(n.index);this.bufferNode=e,this.yieldBuf(e.index)}}yieldNode(e){return e?(this._tree=e,this.type=e.type,this.from=e.from,this.to=e.to,!0):!1}yieldBuf(e,t){this.index=e;let{start:n,buffer:s}=this.buffer;return this.type=t||s.set.types[s.buffer[e]],this.from=n+s.buffer[e+1],this.to=n+s.buffer[e+2],!0}yield(e){return e?e instanceof sn?(this.buffer=null,this.yieldNode(e)):(this.buffer=e.context,this.yieldBuf(e.index,e.type)):!1}toString(){return this.buffer?this.buffer.buffer.childString(this.index):this._tree.toString()}enterChild(e,t,n){if(!this.buffer)return this.yield(this._tree.nextChild(e<0?this._tree._tree.children.length-1:0,e,t,n,this.mode));let{buffer:s}=this.buffer,r=s.findChild(this.index+4,s.buffer[this.index+3],e,t-this.buffer.start,n);return r<0?!1:(this.stack.push(this.index),this.yieldBuf(r))}firstChild(){return this.enterChild(1,0,4)}lastChild(){return this.enterChild(-1,0,4)}childAfter(e){return this.enterChild(1,e,2)}childBefore(e){return this.enterChild(-1,e,-2)}enter(e,t,n=this.mode){return this.buffer?n&yt.ExcludeBuffers?!1:this.enterChild(1,e,t):this.yield(this._tree.enter(e,t,n))}parent(){if(!this.buffer)return this.yieldNode(this.mode&yt.IncludeAnonymous?this._tree._parent:this._tree.parent);if(this.stack.length)return this.yieldBuf(this.stack.pop());let e=this.mode&yt.IncludeAnonymous?this.buffer.parent:this.buffer.parent.nextSignificantParent();return this.buffer=null,this.yieldNode(e)}sibling(e){if(!this.buffer)return this._tree._parent?this.yield(this._tree.index<0?null:this._tree._parent.nextChild(this._tree.index+e,e,0,4,this.mode)):!1;let{buffer:t}=this.buffer,n=this.stack.length-1;if(e<0){let s=n<0?0:this.stack[n]+4;if(this.index!=s)return this.yieldBuf(t.findChild(s,this.index,-1,0,4))}else{let s=t.buffer[this.index+3];if(s<(n<0?t.buffer.length:t.buffer[this.stack[n]+3]))return this.yieldBuf(s)}return n<0?this.yield(this.buffer.parent.nextChild(this.buffer.index+e,e,0,4,this.mode)):!1}nextSibling(){return this.sibling(1)}prevSibling(){return this.sibling(-1)}atLastNode(e){let t,n,{buffer:s}=this;if(s){if(e>0){if(this.index<s.buffer.buffer.length)return!1}else for(let r=0;r<this.index;r++)if(s.buffer.buffer[r+3]<this.index)return!1;({index:t,parent:n}=s)}else({index:t,_parent:n}=this._tree);for(;n;{index:t,_parent:n}=n)if(t>-1)for(let r=t+e,o=e<0?-1:n._tree.children.length;r!=o;r+=e){let a=n._tree.children[r];if(this.mode&yt.IncludeAnonymous||a instanceof $s||!a.type.isAnonymous||wd(a))return!1}return!0}move(e,t){if(t&&this.enterChild(e,0,4))return!0;for(;;){if(this.sibling(e))return!0;if(this.atLastNode(e)||!this.parent())return!1}}next(e=!0){return this.move(1,e)}prev(e=!0){return this.move(-1,e)}moveTo(e,t=0){for(;(this.from==this.to||(t<1?this.from>=e:this.from>e)||(t>-1?this.to<=e:this.to<e))&&this.parent(););for(;this.enterChild(1,e,t););return this}get node(){if(!this.buffer)return this._tree;let e=this.bufferNode,t=null,n=0;if(e&&e.context==this.buffer)e:for(let s=this.index,r=this.stack.length;r>=0;){for(let o=e;o;o=o._parent)if(o.index==s){if(s==this.index)return o;t=o,n=r+1;break e}s=this.stack[--r]}for(let s=n;s<this.stack.length;s++)t=new Xn(this.buffer,t,this.stack[s]);return this.bufferNode=new Xn(this.buffer,t,this.index)}get tree(){return this.buffer?null:this._tree._tree}iterate(e,t){for(let n=0;;){let s=!1;if(this.type.isAnonymous||e(this)!==!1){if(this.firstChild()){n++;continue}this.type.isAnonymous||(s=!0)}for(;;){if(s&&t&&t(this),s=this.type.isAnonymous,!n)return;if(this.nextSibling())break;this.parent(),n--,s=!0}}}matchContext(e){if(!this.buffer)return wc(this.node.parent,e);let{buffer:t}=this.buffer,{types:n}=t.set;for(let s=e.length-1,r=this.stack.length-1;s>=0;r--){if(r<0)return wc(this._tree,e,s);let o=n[t.buffer[this.stack[r]]];if(!o.isAnonymous){if(e[s]&&e[s]!=o.name)return!1;s--}}return!0}}function wd(i){return i.children.some(e=>e instanceof $s||!e.type.isAnonymous||wd(e))}function QP(i){var e;let{buffer:t,nodeSet:n,maxBufferLength:s=ig,reused:r=[],minRepeatType:o=n.types.length}=i,a=Array.isArray(t)?new vd(t,t.length):t,l=n.types,d=0,c=0;function u(S,k,x,E,B,F){let{id:W,start:z,end:ce,size:ie}=a,se=c,pe=d;if(ie<0)if(a.next(),ie==-1){let it=r[W];x.push(it),E.push(z-S);return}else if(ie==-3){d=W;return}else if(ie==-4){c=W;return}else throw new RangeError(`Unrecognized record size: ${ie}`);let Se=l[W],st,Ze,St=z-S;if(ce-z<=s&&(Ze=O(a.pos-k,B))){let it=new Uint16Array(Ze.size-Ze.skip),je=a.pos-Ze.size,Ie=it.length;for(;a.pos>je;)Ie=p(Ze.start,it,Ie);st=new $s(it,ce-Ze.start,n),St=Ze.start-S}else{let it=a.pos-ie;a.next();let je=[],Ie=[],ee=W>=o?W:-1,kt=0,ut=ce;for(;a.pos>it;)ee>=0&&a.id==ee&&a.size>=0?(a.end<=ut-s&&(m(je,Ie,z,kt,a.end,ut,ee,se,pe),kt=je.length,ut=a.end),a.next()):F>2500?h(z,it,je,Ie):u(z,it,je,Ie,ee,F+1);if(ee>=0&&kt>0&&kt<je.length&&m(je,Ie,z,kt,z,ut,ee,se,pe),je.reverse(),Ie.reverse(),ee>-1&&kt>0){let ae=f(Se,pe);st=Pd(Se,je,Ie,0,je.length,0,ce-z,ae,ae)}else st=g(Se,je,Ie,ce-z,se-ce,pe)}x.push(st),E.push(St)}function h(S,k,x,E){let B=[],F=0,W=-1;for(;a.pos>k;){let{id:z,start:ce,end:ie,size:se}=a;if(se>4)a.next();else{if(W>-1&&ce<W)break;W<0&&(W=ie-s),B.push(z,ce,ie),F++,a.next()}}if(F){let z=new Uint16Array(F*4),ce=B[B.length-2];for(let ie=B.length-3,se=0;ie>=0;ie-=3)z[se++]=B[ie],z[se++]=B[ie+1]-ce,z[se++]=B[ie+2]-ce,z[se++]=se;x.push(new $s(z,B[2]-ce,n)),E.push(ce-S)}}function f(S,k){return(x,E,B)=>{let F=0,W=x.length-1,z,ce;if(W>=0&&(z=x[W])instanceof pt){if(!W&&z.type==S&&z.length==B)return z;(ce=z.prop($e.lookAhead))&&(F=E[W]+z.length+ce)}return g(S,x,E,B,F,k)}}function m(S,k,x,E,B,F,W,z,ce){let ie=[],se=[];for(;S.length>E;)ie.push(S.pop()),se.push(k.pop()+x-B);S.push(g(n.types[W],ie,se,F-B,z-F,ce)),k.push(B-x)}function g(S,k,x,E,B,F,W){if(F){let z=[$e.contextHash,F];W=W?[z].concat(W):[z]}if(B>25){let z=[$e.lookAhead,B];W=W?[z].concat(W):[z]}return new pt(S,k,x,E,W)}function O(S,k){let x=a.fork(),E=0,B=0,F=0,W=x.end-s,z={size:0,start:0,skip:0};e:for(let ce=x.pos-S;x.pos>ce;){let ie=x.size;if(x.id==k&&ie>=0){z.size=E,z.start=B,z.skip=F,F+=4,E+=4,x.next();continue}let se=x.pos-ie;if(ie<0||se<ce||x.start<W)break;let pe=x.id>=o?4:0,Se=x.start;for(x.next();x.pos>se;){if(x.size<0)if(x.size==-3)pe+=4;else break e;else x.id>=o&&(pe+=4);x.next()}B=Se,E+=ie,F+=pe}return(k<0||E==S)&&(z.size=E,z.start=B,z.skip=F),z.size>4?z:void 0}function p(S,k,x){let{id:E,start:B,end:F,size:W}=a;if(a.next(),W>=0&&E<o){let z=x;if(W>4){let ce=a.pos-(W-4);for(;a.pos>ce;)x=p(S,k,x)}k[--x]=z,k[--x]=F-S,k[--x]=B-S,k[--x]=E}else W==-3?d=E:W==-4&&(c=E);return x}let y=[],M=[];for(;a.pos>0;)u(i.start||0,i.bufferStart||0,y,M,-1,0);let b=(e=i.length)!==null&&e!==void 0?e:y.length?M[0]+y[0].length:0;return new pt(l[i.topID],y.reverse(),M.reverse(),b)}const gh=new WeakMap;function Po(i,e){if(!i.isAnonymous||e instanceof $s||e.type!=i)return 1;let t=gh.get(e);if(t==null){t=1;for(let n of e.children){if(n.type!=i||!(n instanceof pt)){t=1;break}t+=Po(i,n)}gh.set(e,t)}return t}function Pd(i,e,t,n,s,r,o,a,l){let d=0;for(let m=n;m<s;m++)d+=Po(i,e[m]);let c=Math.ceil(d*1.5/8),u=[],h=[];function f(m,g,O,p,y){for(let M=O;M<p;){let b=M,S=g[M],k=Po(i,m[M]);for(M++;M<p;M++){let x=Po(i,m[M]);if(k+x>=c)break;k+=x}if(M==b+1){if(k>c){let x=m[b];f(x.children,x.positions,0,x.children.length,g[b]+y);continue}u.push(m[b])}else{let x=g[M-1]+m[M-1].length-S;u.push(Pd(i,m,g,b,M,S,x,null,l))}h.push(S+y-r)}}return f(e,t,n,s,0),(a||l)(u,h,o)}class RP{constructor(){this.map=new WeakMap}setBuffer(e,t,n){let s=this.map.get(e);s||this.map.set(e,s=new Map),s.set(t,n)}getBuffer(e,t){let n=this.map.get(e);return n&&n.get(t)}set(e,t){e instanceof Xn?this.setBuffer(e.context.buffer,e.index,t):e instanceof sn&&this.map.set(e.tree,t)}get(e){return e instanceof Xn?this.getBuffer(e.context.buffer,e.index):e instanceof sn?this.map.get(e.tree):void 0}cursorSet(e,t){e.buffer?this.setBuffer(e.buffer.buffer,e.index,t):this.map.set(e.tree,t)}cursorGet(e){return e.buffer?this.getBuffer(e.buffer.buffer,e.index):this.map.get(e.tree)}}class Fs{constructor(e,t,n,s,r=!1,o=!1){this.from=e,this.to=t,this.tree=n,this.offset=s,this.open=(r?1:0)|(o?2:0)}get openStart(){return(this.open&1)>0}get openEnd(){return(this.open&2)>0}static addTree(e,t=[],n=!1){let s=[new Fs(0,e.length,e,0,!1,n)];for(let r of t)r.to>e.length&&s.push(r);return s}static applyChanges(e,t,n=128){if(!t.length)return e;let s=[],r=1,o=e.length?e[0]:null;for(let a=0,l=0,d=0;;a++){let c=a<t.length?t[a]:null,u=c?c.fromA:1e9;if(u-l>=n)for(;o&&o.from<u;){let h=o;if(l>=h.from||u<=h.to||d){let f=Math.max(h.from,l)-d,m=Math.min(h.to,u)-d;h=f>=m?null:new Fs(f,m,h.tree,h.offset+d,a>0,!!c)}if(h&&s.push(h),o.to>u)break;o=r<e.length?e[r++]:null}if(!c)break;l=c.toA,d=c.toA-c.toB}return s}}class lg{startParse(e,t,n){return typeof e=="string"&&(e=new _P(e)),n=n?n.length?n.map(s=>new Wa(s.from,s.to)):[new Wa(0,0)]:[new Wa(0,e.length)],this.createParse(e,t||[],n)}parse(e,t,n){let s=this.startParse(e,t,n);for(;;){let r=s.advance();if(r)return r}}}class _P{constructor(e){this.string=e}get length(){return this.string.length}chunk(e){return this.string.slice(e)}get lineChunks(){return!1}read(e,t){return this.string.slice(e,t)}}new $e({perNode:!0});var Oh={};class Do{constructor(e,t,n,s,r,o,a,l,d,c=0,u){this.p=e,this.stack=t,this.state=n,this.reducePos=s,this.pos=r,this.score=o,this.buffer=a,this.bufferBase=l,this.curContext=d,this.lookAhead=c,this.parent=u}toString(){return`[${this.stack.filter((e,t)=>t%3==0).concat(this.state)}]@${this.pos}${this.score?"!"+this.score:""}`}static start(e,t,n=0){let s=e.parser.context;return new Do(e,[],t,n,n,0,[],0,s?new yh(s,s.start):null,0,null)}get context(){return this.curContext?this.curContext.context:null}pushState(e,t){this.stack.push(this.state,t,this.bufferBase+this.buffer.length),this.state=e}reduce(e){var t;let n=e>>19,s=e&65535,{parser:r}=this.p,o=this.reducePos<this.pos-25;o&&this.setLookAhead(this.pos);let a=r.dynamicPrecedence(s);if(a&&(this.score+=a),n==0){this.pushState(r.getGoto(this.state,s,!0),this.reducePos),s<r.minRepeatTerm&&this.storeNode(s,this.reducePos,this.reducePos,o?8:4,!0),this.reduceContext(s,this.reducePos);return}let l=this.stack.length-(n-1)*3-(e&262144?6:0),d=l?this.stack[l-2]:this.p.ranges[0].from,c=this.reducePos-d;c>=2e3&&!(!((t=this.p.parser.nodeSet.types[s])===null||t===void 0)&&t.isAnonymous)&&(d==this.p.lastBigReductionStart?(this.p.bigReductionCount++,this.p.lastBigReductionSize=c):this.p.lastBigReductionSize<c&&(this.p.bigReductionCount=1,this.p.lastBigReductionStart=d,this.p.lastBigReductionSize=c));let u=l?this.stack[l-1]:0,h=this.bufferBase+this.buffer.length-u;if(s<r.minRepeatTerm||e&131072){let f=r.stateFlag(this.state,1)?this.pos:this.reducePos;this.storeNode(s,d,f,h+4,!0)}if(e&262144)this.state=this.stack[l];else{let f=this.stack[l-3];this.state=r.getGoto(f,s,!0)}for(;this.stack.length>l;)this.stack.pop();this.reduceContext(s,d)}storeNode(e,t,n,s=4,r=!1){if(e==0&&(!this.stack.length||this.stack[this.stack.length-1]<this.buffer.length+this.bufferBase)){let o=this,a=this.buffer.length;if(a==0&&o.parent&&(a=o.bufferBase-o.parent.bufferBase,o=o.parent),a>0&&o.buffer[a-4]==0&&o.buffer[a-1]>-1){if(t==n)return;if(o.buffer[a-2]>=t){o.buffer[a-2]=n;return}}}if(!r||this.pos==n)this.buffer.push(e,t,n,s);else{let o=this.buffer.length;if(o>0&&(this.buffer[o-4]!=0||this.buffer[o-1]<0)){let a=!1;for(let l=o;l>0&&this.buffer[l-2]>n;l-=4)if(this.buffer[l-1]>=0){a=!0;break}if(a)for(;o>0&&this.buffer[o-2]>n;)this.buffer[o]=this.buffer[o-4],this.buffer[o+1]=this.buffer[o-3],this.buffer[o+2]=this.buffer[o-2],this.buffer[o+3]=this.buffer[o-1],o-=4,s>4&&(s-=4)}this.buffer[o]=e,this.buffer[o+1]=t,this.buffer[o+2]=n,this.buffer[o+3]=s}}shift(e,t,n,s){if(e&131072)this.pushState(e&65535,this.pos);else if((e&262144)==0){let r=e,{parser:o}=this.p;(s>this.pos||t<=o.maxNode)&&(this.pos=s,o.stateFlag(r,1)||(this.reducePos=s)),this.pushState(r,n),this.shiftContext(t,n),t<=o.maxNode&&this.buffer.push(t,n,s,4)}else this.pos=s,this.shiftContext(t,n),t<=this.p.parser.maxNode&&this.buffer.push(t,n,s,4)}apply(e,t,n,s){e&65536?this.reduce(e):this.shift(e,t,n,s)}useNode(e,t){let n=this.p.reused.length-1;(n<0||this.p.reused[n]!=e)&&(this.p.reused.push(e),n++);let s=this.pos;this.reducePos=this.pos=s+e.length,this.pushState(t,s),this.buffer.push(n,s,this.reducePos,-1),this.curContext&&this.updateContext(this.curContext.tracker.reuse(this.curContext.context,e,this,this.p.stream.reset(this.pos-e.length)))}split(){let e=this,t=e.buffer.length;for(;t>0&&e.buffer[t-2]>e.reducePos;)t-=4;let n=e.buffer.slice(t),s=e.bufferBase+t;for(;e&&s==e.bufferBase;)e=e.parent;return new Do(this.p,this.stack.slice(),this.state,this.reducePos,this.pos,this.score,n,s,this.curContext,this.lookAhead,e)}recoverByDelete(e,t){let n=e<=this.p.parser.maxNode;n&&this.storeNode(e,this.pos,t,4),this.storeNode(0,this.pos,t,n?8:4),this.pos=this.reducePos=t,this.score-=190}canShift(e){for(let t=new IP(this);;){let n=this.p.parser.stateSlot(t.state,4)||this.p.parser.hasAction(t.state,e);if(n==0)return!1;if((n&65536)==0)return!0;t.reduce(n)}}recoverByInsert(e){if(this.stack.length>=300)return[];let t=this.p.parser.nextStates(this.state);if(t.length>8||this.stack.length>=120){let s=[];for(let r=0,o;r<t.length;r+=2)(o=t[r+1])!=this.state&&this.p.parser.hasAction(o,e)&&s.push(t[r],o);if(this.stack.length<120)for(let r=0;s.length<8&&r<t.length;r+=2){let o=t[r+1];s.some((a,l)=>l&1&&a==o)||s.push(t[r],o)}t=s}let n=[];for(let s=0;s<t.length&&n.length<4;s+=2){let r=t[s+1];if(r==this.state)continue;let o=this.split();o.pushState(r,this.pos),o.storeNode(0,o.pos,o.pos,4,!0),o.shiftContext(t[s],this.pos),o.reducePos=this.pos,o.score-=200,n.push(o)}return n}forceReduce(){let{parser:e}=this.p,t=e.stateSlot(this.state,5);if((t&65536)==0)return!1;if(!e.validAction(this.state,t)){let n=t>>19,s=t&65535,r=this.stack.length-n*3;if(r<0||e.getGoto(this.stack[r],s,!1)<0){let o=this.findForcedReduction();if(o==null)return!1;t=o}this.storeNode(0,this.pos,this.pos,4,!0),this.score-=100}return this.reducePos=this.pos,this.reduce(t),!0}findForcedReduction(){let{parser:e}=this.p,t=[],n=(s,r)=>{if(!t.includes(s))return t.push(s),e.allActions(s,o=>{if(!(o&393216))if(o&65536){let a=(o>>19)-r;if(a>1){let l=o&65535,d=this.stack.length-a*3;if(d>=0&&e.getGoto(this.stack[d],l,!1)>=0)return a<<19|65536|l}}else{let a=n(o,r+1);if(a!=null)return a}})};return n(this.state,0)}forceAll(){for(;!this.p.parser.stateFlag(this.state,2);)if(!this.forceReduce()){this.storeNode(0,this.pos,this.pos,4,!0);break}return this}get deadEnd(){if(this.stack.length!=3)return!1;let{parser:e}=this.p;return e.data[e.stateSlot(this.state,1)]==65535&&!e.stateSlot(this.state,4)}restart(){this.storeNode(0,this.pos,this.pos,4,!0),this.state=this.stack[0],this.stack.length=0}sameState(e){if(this.state!=e.state||this.stack.length!=e.stack.length)return!1;for(let t=0;t<this.stack.length;t+=3)if(this.stack[t]!=e.stack[t])return!1;return!0}get parser(){return this.p.parser}dialectEnabled(e){return this.p.parser.dialect.flags[e]}shiftContext(e,t){this.curContext&&this.updateContext(this.curContext.tracker.shift(this.curContext.context,e,this,this.p.stream.reset(t)))}reduceContext(e,t){this.curContext&&this.updateContext(this.curContext.tracker.reduce(this.curContext.context,e,this,this.p.stream.reset(t)))}emitContext(){let e=this.buffer.length-1;(e<0||this.buffer[e]!=-3)&&this.buffer.push(this.curContext.hash,this.pos,this.pos,-3)}emitLookAhead(){let e=this.buffer.length-1;(e<0||this.buffer[e]!=-4)&&this.buffer.push(this.lookAhead,this.pos,this.pos,-4)}updateContext(e){if(e!=this.curContext.context){let t=new yh(this.curContext.tracker,e);t.hash!=this.curContext.hash&&this.emitContext(),this.curContext=t}}setLookAhead(e){e>this.lookAhead&&(this.emitLookAhead(),this.lookAhead=e)}close(){this.curContext&&this.curContext.tracker.strict&&this.emitContext(),this.lookAhead>0&&this.emitLookAhead()}}class yh{constructor(e,t){this.tracker=e,this.context=t,this.hash=e.strict?e.hash(t):0}}class IP{constructor(e){this.start=e,this.state=e.state,this.stack=e.stack,this.base=this.stack.length}reduce(e){let t=e&65535,n=e>>19;n==0?(this.stack==this.start.stack&&(this.stack=this.stack.slice()),this.stack.push(this.state,0,0),this.base+=3):this.base-=(n-1)*3;let s=this.start.p.parser.getGoto(this.stack[this.base-3],t,!0);this.state=s}}class zo{constructor(e,t,n){this.stack=e,this.pos=t,this.index=n,this.buffer=e.buffer,this.index==0&&this.maybeNext()}static create(e,t=e.bufferBase+e.buffer.length){return new zo(e,t,t-e.bufferBase)}maybeNext(){let e=this.stack.parent;e!=null&&(this.index=this.stack.bufferBase-e.bufferBase,this.stack=e,this.buffer=e.buffer)}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}next(){this.index-=4,this.pos-=4,this.index==0&&this.maybeNext()}fork(){return new zo(this.stack,this.pos,this.index)}}function sr(i,e=Uint16Array){if(typeof i!="string")return i;let t=null;for(let n=0,s=0;n<i.length;){let r=0;for(;;){let o=i.charCodeAt(n++),a=!1;if(o==126){r=65535;break}o>=92&&o--,o>=34&&o--;let l=o-32;if(l>=46&&(l-=46,a=!0),r+=l,a)break;r*=46}t?t[s++]=r:t=new e(r)}return t}class So{constructor(){this.start=-1,this.value=-1,this.end=-1,this.extended=-1,this.lookAhead=0,this.mask=0,this.context=0}}const bh=new So;class LP{constructor(e,t){this.input=e,this.ranges=t,this.chunk="",this.chunkOff=0,this.chunk2="",this.chunk2Pos=0,this.next=-1,this.token=bh,this.rangeIndex=0,this.pos=this.chunkPos=t[0].from,this.range=t[0],this.end=t[t.length-1].to,this.readNext()}resolveOffset(e,t){let n=this.range,s=this.rangeIndex,r=this.pos+e;for(;r<n.from;){if(!s)return null;let o=this.ranges[--s];r-=n.from-o.to,n=o}for(;t<0?r>n.to:r>=n.to;){if(s==this.ranges.length-1)return null;let o=this.ranges[++s];r+=o.from-n.to,n=o}return r}clipPos(e){if(e>=this.range.from&&e<this.range.to)return e;for(let t of this.ranges)if(t.to>e)return Math.max(e,t.from);return this.end}peek(e){let t=this.chunkOff+e,n,s;if(t>=0&&t<this.chunk.length)n=this.pos+e,s=this.chunk.charCodeAt(t);else{let r=this.resolveOffset(e,1);if(r==null)return-1;if(n=r,n>=this.chunk2Pos&&n<this.chunk2Pos+this.chunk2.length)s=this.chunk2.charCodeAt(n-this.chunk2Pos);else{let o=this.rangeIndex,a=this.range;for(;a.to<=n;)a=this.ranges[++o];this.chunk2=this.input.chunk(this.chunk2Pos=n),n+this.chunk2.length>a.to&&(this.chunk2=this.chunk2.slice(0,a.to-n)),s=this.chunk2.charCodeAt(0)}}return n>=this.token.lookAhead&&(this.token.lookAhead=n+1),s}acceptToken(e,t=0){let n=t?this.resolveOffset(t,-1):this.pos;if(n==null||n<this.token.start)throw new RangeError("Token end out of bounds");this.token.value=e,this.token.end=n}acceptTokenTo(e,t){this.token.value=e,this.token.end=t}getChunk(){if(this.pos>=this.chunk2Pos&&this.pos<this.chunk2Pos+this.chunk2.length){let{chunk:e,chunkPos:t}=this;this.chunk=this.chunk2,this.chunkPos=this.chunk2Pos,this.chunk2=e,this.chunk2Pos=t,this.chunkOff=this.pos-this.chunkPos}else{this.chunk2=this.chunk,this.chunk2Pos=this.chunkPos;let e=this.input.chunk(this.pos),t=this.pos+e.length;this.chunk=t>this.range.to?e.slice(0,this.range.to-this.pos):e,this.chunkPos=this.pos,this.chunkOff=0}}readNext(){return this.chunkOff>=this.chunk.length&&(this.getChunk(),this.chunkOff==this.chunk.length)?this.next=-1:this.next=this.chunk.charCodeAt(this.chunkOff)}advance(e=1){for(this.chunkOff+=e;this.pos+e>=this.range.to;){if(this.rangeIndex==this.ranges.length-1)return this.setDone();e-=this.range.to-this.pos,this.range=this.ranges[++this.rangeIndex],this.pos=this.range.from}return this.pos+=e,this.pos>=this.token.lookAhead&&(this.token.lookAhead=this.pos+1),this.readNext()}setDone(){return this.pos=this.chunkPos=this.end,this.range=this.ranges[this.rangeIndex=this.ranges.length-1],this.chunk="",this.next=-1}reset(e,t){if(t?(this.token=t,t.start=e,t.lookAhead=e+1,t.value=t.extended=-1):this.token=bh,this.pos!=e){if(this.pos=e,e==this.end)return this.setDone(),this;for(;e<this.range.from;)this.range=this.ranges[--this.rangeIndex];for(;e>=this.range.to;)this.range=this.ranges[++this.rangeIndex];e>=this.chunkPos&&e<this.chunkPos+this.chunk.length?this.chunkOff=e-this.chunkPos:(this.chunk="",this.chunkOff=0),this.readNext()}return this}read(e,t){if(e>=this.chunkPos&&t<=this.chunkPos+this.chunk.length)return this.chunk.slice(e-this.chunkPos,t-this.chunkPos);if(e>=this.chunk2Pos&&t<=this.chunk2Pos+this.chunk2.length)return this.chunk2.slice(e-this.chunk2Pos,t-this.chunk2Pos);if(e>=this.range.from&&t<=this.range.to)return this.input.read(e,t);let n="";for(let s of this.ranges){if(s.from>=t)break;s.to>e&&(n+=this.input.read(Math.max(s.from,e),Math.min(s.to,t)))}return n}}class wi{constructor(e,t){this.data=e,this.id=t}token(e,t){let{parser:n}=t.p;cg(this.data,e,t,this.id,n.data,n.tokenPrecTable)}}wi.prototype.contextual=wi.prototype.fallback=wi.prototype.extend=!1;class Sc{constructor(e,t,n){this.precTable=t,this.elseToken=n,this.data=typeof e=="string"?sr(e):e}token(e,t){let n=e.pos,s=0;for(;;){let r=e.next<0,o=e.resolveOffset(1,1);if(cg(this.data,e,t,0,this.data,this.precTable),e.token.value>-1)break;if(this.elseToken==null)return;if(r||s++,o==null)break;e.reset(o,e.token)}s&&(e.reset(n,e.token),e.acceptToken(this.elseToken,s))}}Sc.prototype.contextual=wi.prototype.fallback=wi.prototype.extend=!1;class Ar{constructor(e,t={}){this.token=e,this.contextual=!!t.contextual,this.fallback=!!t.fallback,this.extend=!!t.extend}}function cg(i,e,t,n,s,r){let o=0,a=1<<n,{dialect:l}=t.p.parser;e:for(;(a&i[o])!=0;){let d=i[o+1];for(let f=o+3;f<d;f+=2)if((i[f+1]&a)>0){let m=i[f];if(l.allows(m)&&(e.token.value==-1||e.token.value==m||BP(m,e.token.value,s,r))){e.acceptToken(m);break}}let c=e.next,u=0,h=i[o+2];if(e.next<0&&h>u&&i[d+h*3-3]==65535){o=i[d+h*3-1];continue e}for(;u<h;){let f=u+h>>1,m=d+f+(f<<1),g=i[m],O=i[m+1]||65536;if(c<g)h=f;else if(c>=O)u=f+1;else{o=i[m+2],e.advance();continue e}}break}}function vh(i,e,t){for(let n=e,s;(s=i[n])!=65535;n++)if(s==t)return n-e;return-1}function BP(i,e,t,n){let s=vh(t,n,e);return s<0||vh(t,n,i)<s}const dn=typeof process<"u"&&Oh&&/\bparse\b/.test(Oh.LOG);let qa=null;function wh(i,e,t){let n=i.cursor(yt.IncludeAnonymous);for(n.moveTo(e);;)if(!(t<0?n.childBefore(e):n.childAfter(e)))for(;;){if((t<0?n.to<e:n.from>e)&&!n.type.isError)return t<0?Math.max(0,Math.min(n.to-1,e-25)):Math.min(i.length,Math.max(n.from+1,e+25));if(t<0?n.prevSibling():n.nextSibling())break;if(!n.parent())return t<0?0:i.length}}class DP{constructor(e,t){this.fragments=e,this.nodeSet=t,this.i=0,this.fragment=null,this.safeFrom=-1,this.safeTo=-1,this.trees=[],this.start=[],this.index=[],this.nextFragment()}nextFragment(){let e=this.fragment=this.i==this.fragments.length?null:this.fragments[this.i++];if(e){for(this.safeFrom=e.openStart?wh(e.tree,e.from+e.offset,1)-e.offset:e.from,this.safeTo=e.openEnd?wh(e.tree,e.to+e.offset,-1)-e.offset:e.to;this.trees.length;)this.trees.pop(),this.start.pop(),this.index.pop();this.trees.push(e.tree),this.start.push(-e.offset),this.index.push(0),this.nextStart=this.safeFrom}else this.nextStart=1e9}nodeAt(e){if(e<this.nextStart)return null;for(;this.fragment&&this.safeTo<=e;)this.nextFragment();if(!this.fragment)return null;for(;;){let t=this.trees.length-1;if(t<0)return this.nextFragment(),null;let n=this.trees[t],s=this.index[t];if(s==n.children.length){this.trees.pop(),this.start.pop(),this.index.pop();continue}let r=n.children[s],o=this.start[t]+n.positions[s];if(o>e)return this.nextStart=o,null;if(r instanceof pt){if(o==e){if(o<this.safeFrom)return null;let a=o+r.length;if(a<=this.safeTo){let l=r.prop($e.lookAhead);if(!l||a+l<this.fragment.to)return r}}this.index[t]++,o+r.length>=Math.max(this.safeFrom,e)&&(this.trees.push(r),this.start.push(o),this.index.push(0))}else this.index[t]++,this.nextStart=o+r.length}}}class zP{constructor(e,t){this.stream=t,this.tokens=[],this.mainToken=null,this.actions=[],this.tokens=e.tokenizers.map(n=>new So)}getActions(e){let t=0,n=null,{parser:s}=e.p,{tokenizers:r}=s,o=s.stateSlot(e.state,3),a=e.curContext?e.curContext.hash:0,l=0;for(let d=0;d<r.length;d++){if((1<<d&o)==0)continue;let c=r[d],u=this.tokens[d];if(!(n&&!c.fallback)&&((c.contextual||u.start!=e.pos||u.mask!=o||u.context!=a)&&(this.updateCachedToken(u,c,e),u.mask=o,u.context=a),u.lookAhead>u.end+25&&(l=Math.max(u.lookAhead,l)),u.value!=0)){let h=t;if(u.extended>-1&&(t=this.addActions(e,u.extended,u.end,t)),t=this.addActions(e,u.value,u.end,t),!c.extend&&(n=u,t>h))break}}for(;this.actions.length>t;)this.actions.pop();return l&&e.setLookAhead(l),!n&&e.pos==this.stream.end&&(n=new So,n.value=e.p.parser.eofTerm,n.start=n.end=e.pos,t=this.addActions(e,n.value,n.end,t)),this.mainToken=n,this.actions}getMainToken(e){if(this.mainToken)return this.mainToken;let t=new So,{pos:n,p:s}=e;return t.start=n,t.end=Math.min(n+1,s.stream.end),t.value=n==s.stream.end?s.parser.eofTerm:0,t}updateCachedToken(e,t,n){let s=this.stream.clipPos(n.pos);if(t.token(this.stream.reset(s,e),n),e.value>-1){let{parser:r}=n.p;for(let o=0;o<r.specialized.length;o++)if(r.specialized[o]==e.value){let a=r.specializers[o](this.stream.read(e.start,e.end),n);if(a>=0&&n.p.parser.dialect.allows(a>>1)){(a&1)==0?e.value=a>>1:e.extended=a>>1;break}}}else e.value=0,e.end=this.stream.clipPos(s+1)}putAction(e,t,n,s){for(let r=0;r<s;r+=3)if(this.actions[r]==e)return s;return this.actions[s++]=e,this.actions[s++]=t,this.actions[s++]=n,s}addActions(e,t,n,s){let{state:r}=e,{parser:o}=e.p,{data:a}=o;for(let l=0;l<2;l++)for(let d=o.stateSlot(r,l?2:1);;d+=3){if(a[d]==65535)if(a[d+1]==1)d=is(a,d+2);else{s==0&&a[d+1]==2&&(s=this.putAction(is(a,d+2),t,n,s));break}a[d]==t&&(s=this.putAction(is(a,d+1),t,n,s))}return s}}class VP{constructor(e,t,n,s){this.parser=e,this.input=t,this.ranges=s,this.recovering=0,this.nextStackID=9812,this.minStackPos=0,this.reused=[],this.stoppedAt=null,this.lastBigReductionStart=-1,this.lastBigReductionSize=0,this.bigReductionCount=0,this.stream=new LP(t,s),this.tokens=new zP(e,this.stream),this.topTerm=e.top[1];let{from:r}=s[0];this.stacks=[Do.start(this,e.top[0],r)],this.fragments=n.length&&this.stream.end-r>e.bufferLength*4?new DP(n,e.nodeSet):null}get parsedPos(){return this.minStackPos}advance(){let e=this.stacks,t=this.minStackPos,n=this.stacks=[],s,r;if(this.bigReductionCount>300&&e.length==1){let[o]=e;for(;o.forceReduce()&&o.stack.length&&o.stack[o.stack.length-2]>=this.lastBigReductionStart;);this.bigReductionCount=this.lastBigReductionSize=0}for(let o=0;o<e.length;o++){let a=e[o];for(;;){if(this.tokens.mainToken=null,a.pos>t)n.push(a);else{if(this.advanceStack(a,n,e))continue;{s||(s=[],r=[]),s.push(a);let l=this.tokens.getMainToken(a);r.push(l.value,l.end)}}break}}if(!n.length){let o=s&&FP(s);if(o)return dn&&console.log("Finish with "+this.stackID(o)),this.stackToTree(o);if(this.parser.strict)throw dn&&s&&console.log("Stuck with token "+(this.tokens.mainToken?this.parser.getName(this.tokens.mainToken.value):"none")),new SyntaxError("No parse at "+t);this.recovering||(this.recovering=5)}if(this.recovering&&s){let o=this.stoppedAt!=null&&s[0].pos>this.stoppedAt?s[0]:this.runRecovery(s,r,n);if(o)return dn&&console.log("Force-finish "+this.stackID(o)),this.stackToTree(o.forceAll())}if(this.recovering){let o=this.recovering==1?1:this.recovering*3;if(n.length>o)for(n.sort((a,l)=>l.score-a.score);n.length>o;)n.pop();n.some(a=>a.reducePos>t)&&this.recovering--}else if(n.length>1){e:for(let o=0;o<n.length-1;o++){let a=n[o];for(let l=o+1;l<n.length;l++){let d=n[l];if(a.sameState(d)||a.buffer.length>500&&d.buffer.length>500)if((a.score-d.score||a.buffer.length-d.buffer.length)>0)n.splice(l--,1);else{n.splice(o--,1);continue e}}}n.length>12&&n.splice(12,n.length-12)}this.minStackPos=n[0].pos;for(let o=1;o<n.length;o++)n[o].pos<this.minStackPos&&(this.minStackPos=n[o].pos);return null}stopAt(e){if(this.stoppedAt!=null&&this.stoppedAt<e)throw new RangeError("Can't move stoppedAt forward");this.stoppedAt=e}advanceStack(e,t,n){let s=e.pos,{parser:r}=this,o=dn?this.stackID(e)+" -> ":"";if(this.stoppedAt!=null&&s>this.stoppedAt)return e.forceReduce()?e:null;if(this.fragments){let d=e.curContext&&e.curContext.tracker.strict,c=d?e.curContext.hash:0;for(let u=this.fragments.nodeAt(s);u;){let h=this.parser.nodeSet.types[u.type.id]==u.type?r.getGoto(e.state,u.type.id):-1;if(h>-1&&u.length&&(!d||(u.prop($e.contextHash)||0)==c))return e.useNode(u,h),dn&&console.log(o+this.stackID(e)+` (via reuse of ${r.getName(u.type.id)})`),!0;if(!(u instanceof pt)||u.children.length==0||u.positions[0]>0)break;let f=u.children[0];if(f instanceof pt&&u.positions[0]==0)u=f;else break}}let a=r.stateSlot(e.state,4);if(a>0)return e.reduce(a),dn&&console.log(o+this.stackID(e)+` (via always-reduce ${r.getName(a&65535)})`),!0;if(e.stack.length>=8400)for(;e.stack.length>6e3&&e.forceReduce(););let l=this.tokens.getActions(e);for(let d=0;d<l.length;){let c=l[d++],u=l[d++],h=l[d++],f=d==l.length||!n,m=f?e:e.split(),g=this.tokens.mainToken;if(m.apply(c,u,g?g.start:m.pos,h),dn&&console.log(o+this.stackID(m)+` (via ${(c&65536)==0?"shift":`reduce of ${r.getName(c&65535)}`} for ${r.getName(u)} @ ${s}${m==e?"":", split"})`),f)return!0;m.pos>s?t.push(m):n.push(m)}return!1}advanceFully(e,t){let n=e.pos;for(;;){if(!this.advanceStack(e,null,null))return!1;if(e.pos>n)return Ph(e,t),!0}}runRecovery(e,t,n){let s=null,r=!1;for(let o=0;o<e.length;o++){let a=e[o],l=t[o<<1],d=t[(o<<1)+1],c=dn?this.stackID(a)+" -> ":"";if(a.deadEnd&&(r||(r=!0,a.restart(),dn&&console.log(c+this.stackID(a)+" (restarted)"),this.advanceFully(a,n))))continue;let u=a.split(),h=c;for(let f=0;f<10&&u.forceReduce()&&(dn&&console.log(h+this.stackID(u)+" (via force-reduce)"),!this.advanceFully(u,n));f++)dn&&(h=this.stackID(u)+" -> ");for(let f of a.recoverByInsert(l))dn&&console.log(c+this.stackID(f)+" (via recover-insert)"),this.advanceFully(f,n);this.stream.end>a.pos?(d==a.pos&&(d++,l=0),a.recoverByDelete(l,d),dn&&console.log(c+this.stackID(a)+` (via recover-delete ${this.parser.getName(l)})`),Ph(a,n)):(!s||s.score<a.score)&&(s=a)}return s}stackToTree(e){return e.close(),pt.build({buffer:zo.create(e),nodeSet:this.parser.nodeSet,topID:this.topTerm,maxBufferLength:this.parser.bufferLength,reused:this.reused,start:this.ranges[0].from,length:e.pos-this.ranges[0].from,minRepeatType:this.parser.minRepeatTerm})}stackID(e){let t=(qa||(qa=new WeakMap)).get(e);return t||qa.set(e,t=String.fromCodePoint(this.nextStackID++)),t+e}}function Ph(i,e){for(let t=0;t<e.length;t++){let n=e[t];if(n.pos==i.pos&&n.sameState(i)){e[t].score<i.score&&(e[t]=i);return}}e.push(i)}class ZP{constructor(e,t,n){this.source=e,this.flags=t,this.disabled=n}allows(e){return!this.disabled||this.disabled[e]==0}}const Ha=i=>i;class jP{constructor(e){this.start=e.start,this.shift=e.shift||Ha,this.reduce=e.reduce||Ha,this.reuse=e.reuse||Ha,this.hash=e.hash||(()=>0),this.strict=e.strict!==!1}}class Vo extends lg{constructor(e){if(super(),this.wrappers=[],e.version!=14)throw new RangeError(`Parser version (${e.version}) doesn't match runtime version (14)`);let t=e.nodeNames.split(" ");this.minRepeatTerm=t.length;for(let a=0;a<e.repeatNodeCount;a++)t.push("");let n=Object.keys(e.topRules).map(a=>e.topRules[a][1]),s=[];for(let a=0;a<t.length;a++)s.push([]);function r(a,l,d){s[a].push([l,l.deserialize(String(d))])}if(e.nodeProps)for(let a of e.nodeProps){let l=a[0];typeof l=="string"&&(l=$e[l]);for(let d=1;d<a.length;){let c=a[d++];if(c>=0)r(c,l,a[d++]);else{let u=a[d+-c];for(let h=-c;h>0;h--)r(a[d++],l,u);d++}}}this.nodeSet=new bd(t.map((a,l)=>rn.define({name:l>=this.minRepeatTerm?void 0:a,id:l,props:s[l],top:n.indexOf(l)>-1,error:l==0,skipped:e.skippedNodes&&e.skippedNodes.indexOf(l)>-1}))),e.propSources&&(this.nodeSet=this.nodeSet.extend(...e.propSources)),this.strict=!1,this.bufferLength=ig;let o=sr(e.tokenData);this.context=e.context,this.specializerSpecs=e.specialized||[],this.specialized=new Uint16Array(this.specializerSpecs.length);for(let a=0;a<this.specializerSpecs.length;a++)this.specialized[a]=this.specializerSpecs[a].term;this.specializers=this.specializerSpecs.map(Sh),this.states=sr(e.states,Uint32Array),this.data=sr(e.stateData),this.goto=sr(e.goto),this.maxTerm=e.maxTerm,this.tokenizers=e.tokenizers.map(a=>typeof a=="number"?new wi(o,a):a),this.topRules=e.topRules,this.dialects=e.dialects||{},this.dynamicPrecedences=e.dynamicPrecedences||null,this.tokenPrecTable=e.tokenPrec,this.termNames=e.termNames||null,this.maxNode=this.nodeSet.types.length-1,this.dialect=this.parseDialect(),this.top=this.topRules[Object.keys(this.topRules)[0]]}createParse(e,t,n){let s=new VP(this,e,t,n);for(let r of this.wrappers)s=r(s,e,t,n);return s}getGoto(e,t,n=!1){let s=this.goto;if(t>=s[0])return-1;for(let r=s[t+1];;){let o=s[r++],a=o&1,l=s[r++];if(a&&n)return l;for(let d=r+(o>>1);r<d;r++)if(s[r]==e)return l;if(a)return-1}}hasAction(e,t){let n=this.data;for(let s=0;s<2;s++)for(let r=this.stateSlot(e,s?2:1),o;;r+=3){if((o=n[r])==65535)if(n[r+1]==1)o=n[r=is(n,r+2)];else{if(n[r+1]==2)return is(n,r+2);break}if(o==t||o==0)return is(n,r+1)}return 0}stateSlot(e,t){return this.states[e*6+t]}stateFlag(e,t){return(this.stateSlot(e,0)&t)>0}validAction(e,t){return!!this.allActions(e,n=>n==t?!0:null)}allActions(e,t){let n=this.stateSlot(e,4),s=n?t(n):void 0;for(let r=this.stateSlot(e,1);s==null;r+=3){if(this.data[r]==65535)if(this.data[r+1]==1)r=is(this.data,r+2);else break;s=t(is(this.data,r+1))}return s}nextStates(e){let t=[];for(let n=this.stateSlot(e,1);;n+=3){if(this.data[n]==65535)if(this.data[n+1]==1)n=is(this.data,n+2);else break;if((this.data[n+2]&1)==0){let s=this.data[n+1];t.some((r,o)=>o&1&&r==s)||t.push(this.data[n],s)}}return t}configure(e){let t=Object.assign(Object.create(Vo.prototype),this);if(e.props&&(t.nodeSet=this.nodeSet.extend(...e.props)),e.top){let n=this.topRules[e.top];if(!n)throw new RangeError(`Invalid top rule name ${e.top}`);t.top=n}return e.tokenizers&&(t.tokenizers=this.tokenizers.map(n=>{let s=e.tokenizers.find(r=>r.from==n);return s?s.to:n})),e.specializers&&(t.specializers=this.specializers.slice(),t.specializerSpecs=this.specializerSpecs.map((n,s)=>{let r=e.specializers.find(a=>a.from==n.external);if(!r)return n;let o=Object.assign(Object.assign({},n),{external:r.to});return t.specializers[s]=Sh(o),o})),e.contextTracker&&(t.context=e.contextTracker),e.dialect&&(t.dialect=this.parseDialect(e.dialect)),e.strict!=null&&(t.strict=e.strict),e.wrap&&(t.wrappers=t.wrappers.concat(e.wrap)),e.bufferLength!=null&&(t.bufferLength=e.bufferLength),t}hasWrappers(){return this.wrappers.length>0}getName(e){return this.termNames?this.termNames[e]:String(e<=this.maxNode&&this.nodeSet.types[e].name||e)}get eofTerm(){return this.maxNode+1}get topNode(){return this.nodeSet.types[this.top[1]]}dynamicPrecedence(e){let t=this.dynamicPrecedences;return t==null?0:t[e]||0}parseDialect(e){let t=Object.keys(this.dialects),n=t.map(()=>!1);if(e)for(let r of e.split(" ")){let o=t.indexOf(r);o>=0&&(n[o]=!0)}let s=null;for(let r=0;r<t.length;r++)if(!n[r])for(let o=this.dialects[t[r]],a;(a=this.data[o++])!=65535;)(s||(s=new Uint8Array(this.maxTerm+1)))[a]=1;return new ZP(e,n,s)}static deserialize(e){return new Vo(e)}}function is(i,e){return i[e]|i[e+1]<<16}function FP(i){let e=null;for(let t of i){let n=t.p.stoppedAt;(t.pos==t.p.stream.end||n!=null&&t.pos>n)&&t.p.parser.stateFlag(t.state,2)&&(!e||e.score<t.score)&&(e=t)}return e}function Sh(i){if(i.external){let e=i.extend?1:0;return(t,n)=>i.external(t,n)<<1|e}return i.get}let GP=0;class yn{constructor(e,t,n,s){this.name=e,this.set=t,this.base=n,this.modified=s,this.id=GP++}toString(){let{name:e}=this;for(let t of this.modified)t.name&&(e=`${t.name}(${e})`);return e}static define(e,t){let n=typeof e=="string"?e:"?";if(e instanceof yn&&(t=e),t!=null&&t.base)throw new Error("Can not derive from a modified tag");let s=new yn(n,[],null,[]);if(s.set.push(s),t)for(let r of t.set)s.set.push(r);return s}static defineModifier(e){let t=new Zo(e);return n=>n.modified.indexOf(t)>-1?n:Zo.get(n.base||n,n.modified.concat(t).sort((s,r)=>s.id-r.id))}}let XP=0;class Zo{constructor(e){this.name=e,this.instances=[],this.id=XP++}static get(e,t){if(!t.length)return e;let n=t[0].instances.find(a=>a.base==e&&UP(t,a.modified));if(n)return n;let s=[],r=new yn(e.name,s,e,t);for(let a of t)a.instances.push(r);let o=WP(t);for(let a of e.set)if(!a.modified.length)for(let l of o)s.push(Zo.get(a,l));return r}}function UP(i,e){return i.length==e.length&&i.every((t,n)=>t==e[n])}function WP(i){let e=[[]];for(let t=0;t<i.length;t++)for(let n=0,s=e.length;n<s;n++)e.push(e[n].concat(i[t]));return e.sort((t,n)=>n.length-t.length)}function dg(i){let e=Object.create(null);for(let t in i){let n=i[t];Array.isArray(n)||(n=[n]);for(let s of t.split(" "))if(s){let r=[],o=2,a=s;for(let u=0;;){if(a=="..."&&u>0&&u+3==s.length){o=1;break}let h=/^"(?:[^"\\]|\\.)*?"|[^\/!]+/.exec(a);if(!h)throw new RangeError("Invalid path: "+s);if(r.push(h[0]=="*"?"":h[0][0]=='"'?JSON.parse(h[0]):h[0]),u+=h[0].length,u==s.length)break;let f=s[u++];if(u==s.length&&f=="!"){o=0;break}if(f!="/")throw new RangeError("Invalid path: "+s);a=s.slice(u)}let l=r.length-1,d=r[l];if(!d)throw new RangeError("Invalid path: "+s);let c=new wr(n,o,l>0?r.slice(0,l):null);e[d]=c.sort(e[d])}}return ug.add(e)}const ug=new $e({combine(i,e){let t,n,s;for(;i||e;){if(!i||e&&i.depth>=e.depth?(s=e,e=e.next):(s=i,i=i.next),t&&t.mode==s.mode&&!s.context&&!t.context)continue;let r=new wr(s.tags,s.mode,s.context);t?t.next=r:n=r,t=r}return n}});class wr{constructor(e,t,n,s){this.tags=e,this.mode=t,this.context=n,this.next=s}get opaque(){return this.mode==0}get inherit(){return this.mode==1}sort(e){return!e||e.depth<this.depth?(this.next=e,this):(e.next=this.sort(e.next),e)}get depth(){return this.context?this.context.length:0}}wr.empty=new wr([],2,null);function hg(i,e){let t=Object.create(null);for(let r of i)if(!Array.isArray(r.tag))t[r.tag.id]=r.class;else for(let o of r.tag)t[o.id]=r.class;let{scope:n,all:s=null}=e||{};return{style:r=>{let o=s;for(let a of r)for(let l of a.set){let d=t[l.id];if(d){o=o?o+" "+d:d;break}}return o},scope:n}}function qP(i,e){let t=null;for(let n of i){let s=n.style(e);s&&(t=t?t+" "+s:s)}return t}function HP(i,e,t,n=0,s=i.length){let r=new YP(n,Array.isArray(e)?e:[e],t);r.highlightRange(i.cursor(),n,s,"",r.highlighters),r.flush(s)}class YP{constructor(e,t,n){this.at=e,this.highlighters=t,this.span=n,this.class=""}startSpan(e,t){t!=this.class&&(this.flush(e),e>this.at&&(this.at=e),this.class=t)}flush(e){e>this.at&&this.class&&this.span(this.at,e,this.class)}highlightRange(e,t,n,s,r){let{type:o,from:a,to:l}=e;if(a>=n||l<=t)return;o.isTop&&(r=this.highlighters.filter(f=>!f.scope||f.scope(o)));let d=s,c=KP(e)||wr.empty,u=qP(r,c.tags);if(u&&(d&&(d+=" "),d+=u,c.mode==1&&(s+=(s?" ":"")+u)),this.startSpan(Math.max(t,a),d),c.opaque)return;let h=e.tree&&e.tree.prop($e.mounted);if(h&&h.overlay){let f=e.node.enter(h.overlay[0].from+a,1),m=this.highlighters.filter(O=>!O.scope||O.scope(h.tree.type)),g=e.firstChild();for(let O=0,p=a;;O++){let y=O<h.overlay.length?h.overlay[O]:null,M=y?y.from+a:l,b=Math.max(t,p),S=Math.min(n,M);if(b<S&&g)for(;e.from<S&&(this.highlightRange(e,b,S,s,r),this.startSpan(Math.min(S,e.to),d),!(e.to>=M||!e.nextSibling())););if(!y||M>n)break;p=y.to+a,p>t&&(this.highlightRange(f.cursor(),Math.max(t,y.from+a),Math.min(n,p),"",m),this.startSpan(Math.min(n,p),d))}g&&e.parent()}else if(e.firstChild()){h&&(s="");do if(!(e.to<=t)){if(e.from>=n)break;this.highlightRange(e,t,n,s,r),this.startSpan(Math.min(n,e.to),d)}while(e.nextSibling());e.parent()}}}function KP(i){let e=i.type.prop(ug);for(;e&&e.context&&!i.matchContext(e.context);)e=e.next;return e||null}const ne=yn.define,no=ne(),gs=ne(),kh=ne(gs),xh=ne(gs),Os=ne(),so=ne(Os),Ya=ne(Os),Vn=ne(),Ns=ne(Vn),Dn=ne(),zn=ne(),kc=ne(),Fi=ne(kc),io=ne(),Q={comment:no,lineComment:ne(no),blockComment:ne(no),docComment:ne(no),name:gs,variableName:ne(gs),typeName:kh,tagName:ne(kh),propertyName:xh,attributeName:ne(xh),className:ne(gs),labelName:ne(gs),namespace:ne(gs),macroName:ne(gs),literal:Os,string:so,docString:ne(so),character:ne(so),attributeValue:ne(so),number:Ya,integer:ne(Ya),float:ne(Ya),bool:ne(Os),regexp:ne(Os),escape:ne(Os),color:ne(Os),url:ne(Os),keyword:Dn,self:ne(Dn),null:ne(Dn),atom:ne(Dn),unit:ne(Dn),modifier:ne(Dn),operatorKeyword:ne(Dn),controlKeyword:ne(Dn),definitionKeyword:ne(Dn),moduleKeyword:ne(Dn),operator:zn,derefOperator:ne(zn),arithmeticOperator:ne(zn),logicOperator:ne(zn),bitwiseOperator:ne(zn),compareOperator:ne(zn),updateOperator:ne(zn),definitionOperator:ne(zn),typeOperator:ne(zn),controlOperator:ne(zn),punctuation:kc,separator:ne(kc),bracket:Fi,angleBracket:ne(Fi),squareBracket:ne(Fi),paren:ne(Fi),brace:ne(Fi),content:Vn,heading:Ns,heading1:ne(Ns),heading2:ne(Ns),heading3:ne(Ns),heading4:ne(Ns),heading5:ne(Ns),heading6:ne(Ns),contentSeparator:ne(Vn),list:ne(Vn),quote:ne(Vn),emphasis:ne(Vn),strong:ne(Vn),link:ne(Vn),monospace:ne(Vn),strikethrough:ne(Vn),inserted:ne(),deleted:ne(),changed:ne(),invalid:ne(),meta:io,documentMeta:ne(io),annotation:ne(io),processingInstruction:ne(io),definition:yn.defineModifier("definition"),constant:yn.defineModifier("constant"),function:yn.defineModifier("function"),standard:yn.defineModifier("standard"),local:yn.defineModifier("local"),special:yn.defineModifier("special")};for(let i in Q){let e=Q[i];e instanceof yn&&(e.name=i)}hg([{tag:Q.link,class:"tok-link"},{tag:Q.heading,class:"tok-heading"},{tag:Q.emphasis,class:"tok-emphasis"},{tag:Q.strong,class:"tok-strong"},{tag:Q.keyword,class:"tok-keyword"},{tag:Q.atom,class:"tok-atom"},{tag:Q.bool,class:"tok-bool"},{tag:Q.url,class:"tok-url"},{tag:Q.labelName,class:"tok-labelName"},{tag:Q.inserted,class:"tok-inserted"},{tag:Q.deleted,class:"tok-deleted"},{tag:Q.literal,class:"tok-literal"},{tag:Q.string,class:"tok-string"},{tag:Q.number,class:"tok-number"},{tag:[Q.regexp,Q.escape,Q.special(Q.string)],class:"tok-string2"},{tag:Q.variableName,class:"tok-variableName"},{tag:Q.local(Q.variableName),class:"tok-variableName tok-local"},{tag:Q.definition(Q.variableName),class:"tok-variableName tok-definition"},{tag:Q.special(Q.variableName),class:"tok-variableName2"},{tag:Q.definition(Q.propertyName),class:"tok-propertyName tok-definition"},{tag:Q.typeName,class:"tok-typeName"},{tag:Q.namespace,class:"tok-namespace"},{tag:Q.className,class:"tok-className"},{tag:Q.macroName,class:"tok-macroName"},{tag:Q.propertyName,class:"tok-propertyName"},{tag:Q.operator,class:"tok-operator"},{tag:Q.comment,class:"tok-comment"},{tag:Q.meta,class:"tok-meta"},{tag:Q.invalid,class:"tok-invalid"},{tag:Q.punctuation,class:"tok-punctuation"}]);const JP=316,eS=317,$h=1,tS=2,nS=3,sS=4,iS=318,rS=320,oS=321,aS=5,lS=6,cS=0,xc=[9,10,11,12,13,32,133,160,5760,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8232,8233,8239,8287,12288],fg=125,dS=59,$c=47,uS=42,hS=43,fS=45,mS=60,pS=44,gS=63,OS=46,yS=91,bS=new jP({start:!1,shift(i,e){return e==aS||e==lS||e==rS?i:e==oS},strict:!1}),vS=new Ar((i,e)=>{let{next:t}=i;(t==fg||t==-1||e.context)&&i.acceptToken(iS)},{contextual:!0,fallback:!0}),wS=new Ar((i,e)=>{let{next:t}=i,n;xc.indexOf(t)>-1||t==$c&&((n=i.peek(1))==$c||n==uS)||t!=fg&&t!=dS&&t!=-1&&!e.context&&i.acceptToken(JP)},{contextual:!0}),PS=new Ar((i,e)=>{i.next==yS&&!e.context&&i.acceptToken(eS)},{contextual:!0}),SS=new Ar((i,e)=>{let{next:t}=i;if(t==hS||t==fS){if(i.advance(),t==i.next){i.advance();let n=!e.context&&e.canShift($h);i.acceptToken(n?$h:tS)}}else t==gS&&i.peek(1)==OS&&(i.advance(),i.advance(),(i.next<48||i.next>57)&&i.acceptToken(nS))},{contextual:!0});function Ka(i,e){return i>=65&&i<=90||i>=97&&i<=122||i==95||i>=192||!e&&i>=48&&i<=57}const kS=new Ar((i,e)=>{if(i.next!=mS||!e.dialectEnabled(cS)||(i.advance(),i.next==$c))return;let t=0;for(;xc.indexOf(i.next)>-1;)i.advance(),t++;if(Ka(i.next,!0)){for(i.advance(),t++;Ka(i.next,!1);)i.advance(),t++;for(;xc.indexOf(i.next)>-1;)i.advance(),t++;if(i.next==pS)return;for(let n=0;;n++){if(n==7){if(!Ka(i.next,!0))return;break}if(i.next!="extends".charCodeAt(n))break;i.advance(),t++}}i.acceptToken(sS,-t)}),xS=dg({"get set async static":Q.modifier,"for while do if else switch try catch finally return throw break continue default case defer":Q.controlKeyword,"in of await yield void typeof delete instanceof as satisfies":Q.operatorKeyword,"let var const using function class extends":Q.definitionKeyword,"import export from":Q.moduleKeyword,"with debugger new":Q.keyword,TemplateString:Q.special(Q.string),super:Q.atom,BooleanLiteral:Q.bool,this:Q.self,null:Q.null,Star:Q.modifier,VariableName:Q.variableName,"CallExpression/VariableName TaggedTemplateExpression/VariableName":Q.function(Q.variableName),VariableDefinition:Q.definition(Q.variableName),Label:Q.labelName,PropertyName:Q.propertyName,PrivatePropertyName:Q.special(Q.propertyName),"CallExpression/MemberExpression/PropertyName":Q.function(Q.propertyName),"FunctionDeclaration/VariableDefinition":Q.function(Q.definition(Q.variableName)),"ClassDeclaration/VariableDefinition":Q.definition(Q.className),"NewExpression/VariableName":Q.className,PropertyDefinition:Q.definition(Q.propertyName),PrivatePropertyDefinition:Q.definition(Q.special(Q.propertyName)),UpdateOp:Q.updateOperator,"LineComment Hashbang":Q.lineComment,BlockComment:Q.blockComment,Number:Q.number,String:Q.string,Escape:Q.escape,ArithOp:Q.arithmeticOperator,LogicOp:Q.logicOperator,BitOp:Q.bitwiseOperator,CompareOp:Q.compareOperator,RegExp:Q.regexp,Equals:Q.definitionOperator,Arrow:Q.function(Q.punctuation),": Spread":Q.punctuation,"( )":Q.paren,"[ ]":Q.squareBracket,"{ }":Q.brace,"InterpolationStart InterpolationEnd":Q.special(Q.brace),".":Q.derefOperator,", ;":Q.separator,"@":Q.meta,TypeName:Q.typeName,TypeDefinition:Q.definition(Q.typeName),"type enum interface implements namespace module declare":Q.definitionKeyword,"abstract global Privacy readonly override":Q.modifier,"is keyof unique infer asserts":Q.operatorKeyword,JSXAttributeValue:Q.attributeValue,JSXText:Q.content,"JSXStartTag JSXStartCloseTag JSXSelfCloseEndTag JSXEndTag":Q.angleBracket,"JSXIdentifier JSXNameSpacedName":Q.tagName,"JSXAttribute/JSXIdentifier JSXAttribute/JSXNameSpacedName":Q.attributeName,"JSXBuiltin/JSXIdentifier":Q.standard(Q.tagName)}),$S={__proto__:null,export:20,as:25,from:33,default:36,async:41,function:42,in:52,out:55,const:56,extends:60,this:64,true:72,false:72,null:84,void:88,typeof:92,super:108,new:142,delete:154,yield:163,await:167,class:172,public:235,private:235,protected:235,readonly:237,instanceof:256,satisfies:259,import:292,keyof:349,unique:353,infer:359,asserts:395,is:397,abstract:417,implements:419,type:421,let:424,var:426,using:429,interface:435,enum:439,namespace:445,module:447,declare:451,global:455,defer:471,for:476,of:485,while:488,with:492,do:496,if:500,else:502,switch:506,case:512,try:518,catch:522,finally:526,return:530,throw:534,break:538,continue:542,debugger:546},MS={__proto__:null,async:129,get:131,set:133,declare:195,public:197,private:197,protected:197,static:199,abstract:201,override:203,readonly:209,accessor:211,new:401},CS={__proto__:null,"<":193},ES=Vo.deserialize({version:14,states:"$F|Q%TQlOOO%[QlOOO'_QpOOP(lO`OOO*zQ!0MxO'#CiO+RO#tO'#CjO+aO&jO'#CjO+oO#@ItO'#DaO.QQlO'#DgO.bQlO'#DrO%[QlO'#DzO0fQlO'#ESOOQ!0Lf'#E['#E[O1PQ`O'#EXOOQO'#Ep'#EpOOQO'#Il'#IlO1XQ`O'#GsO1dQ`O'#EoO1iQ`O'#EoO3hQ!0MxO'#JrO6[Q!0MxO'#JsO6uQ`O'#F]O6zQ,UO'#FtOOQ!0Lf'#Ff'#FfO7VO7dO'#FfO9XQMhO'#F|O9`Q`O'#F{OOQ!0Lf'#Js'#JsOOQ!0Lb'#Jr'#JrO9eQ`O'#GwOOQ['#K_'#K_O9pQ`O'#IYO9uQ!0LrO'#IZOOQ['#J`'#J`OOQ['#I_'#I_Q`QlOOQ`QlOOO9}Q!L^O'#DvO:UQlO'#EOO:]QlO'#EQO9kQ`O'#GsO:dQMhO'#CoO:rQ`O'#EnO:}Q`O'#EyO;hQMhO'#FeO;xQ`O'#GsOOQO'#K`'#K`O;}Q`O'#K`O<]Q`O'#G{O<]Q`O'#G|O<]Q`O'#HOO9kQ`O'#HRO=SQ`O'#HUO>kQ`O'#CeO>{Q`O'#HcO?TQ`O'#HiO?TQ`O'#HkO`QlO'#HmO?TQ`O'#HoO?TQ`O'#HrO?YQ`O'#HxO?_Q!0LsO'#IOO%[QlO'#IQO?jQ!0LsO'#ISO?uQ!0LsO'#IUO9uQ!0LrO'#IWO@QQ!0MxO'#CiOASQpO'#DlQOQ`OOO%[QlO'#EQOAjQ`O'#ETO:dQMhO'#EnOAuQ`O'#EnOBQQ!bO'#FeOOQ['#Cg'#CgOOQ!0Lb'#Dq'#DqOOQ!0Lb'#Jv'#JvO%[QlO'#JvOOQO'#Jy'#JyOOQO'#Ih'#IhOCQQpO'#EgOOQ!0Lb'#Ef'#EfOOQ!0Lb'#J}'#J}OC|Q!0MSO'#EgODWQpO'#EWOOQO'#Jx'#JxODlQpO'#JyOEyQpO'#EWODWQpO'#EgPFWO&2DjO'#CbPOOO)CD})CD}OOOO'#I`'#I`OFcO#tO,59UOOQ!0Lh,59U,59UOOOO'#Ia'#IaOFqO&jO,59UOGPQ!L^O'#DcOOOO'#Ic'#IcOGWO#@ItO,59{OOQ!0Lf,59{,59{OGfQlO'#IdOGyQ`O'#JtOIxQ!fO'#JtO+}QlO'#JtOJPQ`O,5:ROJgQ`O'#EpOJtQ`O'#KTOKPQ`O'#KSOKPQ`O'#KSOKXQ`O,5;^OK^Q`O'#KROOQ!0Ln,5:^,5:^OKeQlO,5:^OMcQ!0MxO,5:fONSQ`O,5:nONmQ!0LrO'#KQONtQ`O'#KPO9eQ`O'#KPO! YQ`O'#KPO! bQ`O,5;]O! gQ`O'#KPO!#lQ!fO'#JsOOQ!0Lh'#Ci'#CiO%[QlO'#ESO!$[Q!fO,5:sOOQS'#Jz'#JzOOQO-E<j-E<jO9kQ`O,5=_O!$rQ`O,5=_O!$wQlO,5;ZO!&zQMhO'#EkO!(eQ`O,5;ZO!(jQlO'#DyO!(tQpO,5;dO!(|QpO,5;dO%[QlO,5;dOOQ['#FT'#FTOOQ['#FV'#FVO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eO%[QlO,5;eOOQ['#FZ'#FZO!)[QlO,5;tOOQ!0Lf,5;y,5;yOOQ!0Lf,5;z,5;zOOQ!0Lf,5;|,5;|O%[QlO'#IpO!+_Q!0LrO,5<iO%[QlO,5;eO!&zQMhO,5;eO!+|QMhO,5;eO!-nQMhO'#E^O%[QlO,5;wOOQ!0Lf,5;{,5;{O!-uQ,UO'#FjO!.rQ,UO'#KXO!.^Q,UO'#KXO!.yQ,UO'#KXOOQO'#KX'#KXO!/_Q,UO,5<SOOOW,5<`,5<`O!/pQlO'#FvOOOW'#Io'#IoO7VO7dO,5<QO!/wQ,UO'#FxOOQ!0Lf,5<Q,5<QO!0hQ$IUO'#CyOOQ!0Lh'#C}'#C}O!0{O#@ItO'#DRO!1iQMjO,5<eO!1pQ`O,5<hO!3YQ(CWO'#GXO!3jQ`O'#GYO!3oQ`O'#GYO!5_Q(CWO'#G^O!6dQpO'#GbOOQO'#Gn'#GnO!,TQMhO'#GmOOQO'#Gp'#GpO!,TQMhO'#GoO!7VQ$IUO'#JlOOQ!0Lh'#Jl'#JlO!7aQ`O'#JkO!7oQ`O'#JjO!7wQ`O'#CuOOQ!0Lh'#C{'#C{O!8YQ`O'#C}OOQ!0Lh'#DV'#DVOOQ!0Lh'#DX'#DXO!8_Q`O,5<eO1SQ`O'#DZO!,TQMhO'#GPO!,TQMhO'#GRO!8gQ`O'#GTO!8lQ`O'#GUO!3oQ`O'#G[O!,TQMhO'#GaO<]Q`O'#JkO!8qQ`O'#EqO!9`Q`O,5<gOOQ!0Lb'#Cr'#CrO!9hQ`O'#ErO!:bQpO'#EsOOQ!0Lb'#KR'#KRO!:iQ!0LrO'#KaO9uQ!0LrO,5=cO`QlO,5>tOOQ['#Jh'#JhOOQ[,5>u,5>uOOQ[-E<]-E<]O!<hQ!0MxO,5:bO!:]QpO,5:`O!?RQ!0MxO,5:jO%[QlO,5:jO!AiQ!0MxO,5:lOOQO,5@z,5@zO!BYQMhO,5=_O!BhQ!0LrO'#JiO9`Q`O'#JiO!ByQ!0LrO,59ZO!CUQpO,59ZO!C^QMhO,59ZO:dQMhO,59ZO!CiQ`O,5;ZO!CqQ`O'#HbO!DVQ`O'#KdO%[QlO,5;}O!:]QpO,5<PO!D_Q`O,5=zO!DdQ`O,5=zO!DiQ`O,5=zO!DwQ`O,5=zO9uQ!0LrO,5=zO<]Q`O,5=jOOQO'#Cy'#CyO!EOQpO,5=gO!EWQMhO,5=hO!EcQ`O,5=jO!EhQ!bO,5=mO!EpQ`O'#K`O?YQ`O'#HWO9kQ`O'#HYO!EuQ`O'#HYO:dQMhO'#H[O!EzQ`O'#H[OOQ[,5=p,5=pO!FPQ`O'#H]O!FbQ`O'#CoO!FgQ`O,59PO!FqQ`O,59PO!HvQlO,59POOQ[,59P,59PO!IWQ!0LrO,59PO%[QlO,59PO!KcQlO'#HeOOQ['#Hf'#HfOOQ['#Hg'#HgO`QlO,5=}O!KyQ`O,5=}O`QlO,5>TO`QlO,5>VO!LOQ`O,5>XO`QlO,5>ZO!LTQ`O,5>^O!LYQlO,5>dOOQ[,5>j,5>jO%[QlO,5>jO9uQ!0LrO,5>lOOQ[,5>n,5>nO#!dQ`O,5>nOOQ[,5>p,5>pO#!dQ`O,5>pOOQ[,5>r,5>rO##QQpO'#D_O%[QlO'#JvO##sQpO'#JvO##}QpO'#DmO#$`QpO'#DmO#&qQlO'#DmO#&xQ`O'#JuO#'QQ`O,5:WO#'VQ`O'#EtO#'eQ`O'#KUO#'mQ`O,5;_O#'rQpO'#DmO#(PQpO'#EVOOQ!0Lf,5:o,5:oO%[QlO,5:oO#(WQ`O,5:oO?YQ`O,5;YO!CUQpO,5;YO!C^QMhO,5;YO:dQMhO,5;YO#(`Q`O,5@bO#(eQ07dO,5:sOOQO-E<f-E<fO#)kQ!0MSO,5;RODWQpO,5:rO#)uQpO,5:rODWQpO,5;RO!ByQ!0LrO,5:rOOQ!0Lb'#Ej'#EjOOQO,5;R,5;RO%[QlO,5;RO#*SQ!0LrO,5;RO#*_Q!0LrO,5;RO!CUQpO,5:rOOQO,5;X,5;XO#*mQ!0LrO,5;RPOOO'#I^'#I^P#+RO&2DjO,58|POOO,58|,58|OOOO-E<^-E<^OOQ!0Lh1G.p1G.pOOOO-E<_-E<_OOOO,59},59}O#+^Q!bO,59}OOOO-E<a-E<aOOQ!0Lf1G/g1G/gO#+cQ!fO,5?OO+}QlO,5?OOOQO,5?U,5?UO#+mQlO'#IdOOQO-E<b-E<bO#+zQ`O,5@`O#,SQ!fO,5@`O#,ZQ`O,5@nOOQ!0Lf1G/m1G/mO%[QlO,5@oO#,cQ`O'#IjOOQO-E<h-E<hO#,ZQ`O,5@nOOQ!0Lb1G0x1G0xOOQ!0Ln1G/x1G/xOOQ!0Ln1G0Y1G0YO%[QlO,5@lO#,wQ!0LrO,5@lO#-YQ!0LrO,5@lO#-aQ`O,5@kO9eQ`O,5@kO#-iQ`O,5@kO#-wQ`O'#ImO#-aQ`O,5@kOOQ!0Lb1G0w1G0wO!(tQpO,5:uO!)PQpO,5:uOOQS,5:w,5:wO#.iQdO,5:wO#.qQMhO1G2yO9kQ`O1G2yOOQ!0Lf1G0u1G0uO#/PQ!0MxO1G0uO#0UQ!0MvO,5;VOOQ!0Lh'#GW'#GWO#0rQ!0MzO'#JlO!$wQlO1G0uO#2}Q!fO'#JwO%[QlO'#JwO#3XQ`O,5:eOOQ!0Lh'#D_'#D_OOQ!0Lf1G1O1G1OO%[QlO1G1OOOQ!0Lf1G1f1G1fO#3^Q`O1G1OO#5rQ!0MxO1G1PO#5yQ!0MxO1G1PO#8aQ!0MxO1G1PO#8hQ!0MxO1G1PO#;OQ!0MxO1G1PO#=fQ!0MxO1G1PO#=mQ!0MxO1G1PO#=tQ!0MxO1G1PO#@[Q!0MxO1G1PO#@cQ!0MxO1G1PO#BpQ?MtO'#CiO#DkQ?MtO1G1`O#DrQ?MtO'#JsO#EVQ!0MxO,5?[OOQ!0Lb-E<n-E<nO#GdQ!0MxO1G1PO#HaQ!0MzO1G1POOQ!0Lf1G1P1G1PO#IdQMjO'#J|O#InQ`O,5:xO#IsQ!0MxO1G1cO#JgQ,UO,5<WO#JoQ,UO,5<XO#JwQ,UO'#FoO#K`Q`O'#FnOOQO'#KY'#KYOOQO'#In'#InO#KeQ,UO1G1nOOQ!0Lf1G1n1G1nOOOW1G1y1G1yO#KvQ?MtO'#JrO#LQQ`O,5<bO!)[QlO,5<bOOOW-E<m-E<mOOQ!0Lf1G1l1G1lO#LVQpO'#KXOOQ!0Lf,5<d,5<dO#L_QpO,5<dO#LdQMhO'#DTOOOO'#Ib'#IbO#LkO#@ItO,59mOOQ!0Lh,59m,59mO%[QlO1G2PO!8lQ`O'#IrO#LvQ`O,5<zOOQ!0Lh,5<w,5<wO!,TQMhO'#IuO#MdQMjO,5=XO!,TQMhO'#IwO#NVQMjO,5=ZO!&zQMhO,5=]OOQO1G2S1G2SO#NaQ!dO'#CrO#NtQ(CWO'#ErO$ |QpO'#GbO$!dQ!dO,5<sO$!kQ`O'#K[O9eQ`O'#K[O$!yQ`O,5<uO$#aQ!dO'#C{O!,TQMhO,5<tO$#kQ`O'#GZO$$PQ`O,5<tO$$UQ!dO'#GWO$$cQ!dO'#K]O$$mQ`O'#K]O!&zQMhO'#K]O$$rQ`O,5<xO$$wQlO'#JvO$%RQpO'#GcO#$`QpO'#GcO$%dQ`O'#GgO!3oQ`O'#GkO$%iQ!0LrO'#ItO$%tQpO,5<|OOQ!0Lp,5<|,5<|O$%{QpO'#GcO$&YQpO'#GdO$&kQpO'#GdO$&pQMjO,5=XO$'QQMjO,5=ZOOQ!0Lh,5=^,5=^O!,TQMhO,5@VO!,TQMhO,5@VO$'bQ`O'#IyO$'vQ`O,5@UO$(OQ`O,59aOOQ!0Lh,59i,59iO$(TQ`O,5@VO$)TQ$IYO,59uOOQ!0Lh'#Jp'#JpO$)vQMjO,5<kO$*iQMjO,5<mO@zQ`O,5<oOOQ!0Lh,5<p,5<pO$*sQ`O,5<vO$*xQMjO,5<{O$+YQ`O'#KPO!$wQlO1G2RO$+_Q`O1G2RO9eQ`O'#KSO9eQ`O'#EtO%[QlO'#EtO9eQ`O'#I{O$+dQ!0LrO,5@{OOQ[1G2}1G2}OOQ[1G4`1G4`OOQ!0Lf1G/|1G/|OOQ!0Lf1G/z1G/zO$-fQ!0MxO1G0UOOQ[1G2y1G2yO!&zQMhO1G2yO%[QlO1G2yO#.tQ`O1G2yO$/jQMhO'#EkOOQ!0Lb,5@T,5@TO$/wQ!0LrO,5@TOOQ[1G.u1G.uO!ByQ!0LrO1G.uO!CUQpO1G.uO!C^QMhO1G.uO$0YQ`O1G0uO$0_Q`O'#CiO$0jQ`O'#KeO$0rQ`O,5=|O$0wQ`O'#KeO$0|Q`O'#KeO$1[Q`O'#JRO$1jQ`O,5AOO$1rQ!fO1G1iOOQ!0Lf1G1k1G1kO9kQ`O1G3fO@zQ`O1G3fO$1yQ`O1G3fO$2OQ`O1G3fO!DiQ`O1G3fO9uQ!0LrO1G3fOOQ[1G3f1G3fO!EcQ`O1G3UO!&zQMhO1G3RO$2TQ`O1G3ROOQ[1G3S1G3SO!&zQMhO1G3SO$2YQ`O1G3SO$2bQpO'#HQOOQ[1G3U1G3UO!6_QpO'#I}O!EhQ!bO1G3XOOQ[1G3X1G3XOOQ[,5=r,5=rO$2jQMhO,5=tO9kQ`O,5=tO$%dQ`O,5=vO9`Q`O,5=vO!CUQpO,5=vO!C^QMhO,5=vO:dQMhO,5=vO$2xQ`O'#KcO$3TQ`O,5=wOOQ[1G.k1G.kO$3YQ!0LrO1G.kO@zQ`O1G.kO$3eQ`O1G.kO9uQ!0LrO1G.kO$5mQ!fO,5AQO$5zQ`O,5AQO9eQ`O,5AQO$6VQlO,5>PO$6^Q`O,5>POOQ[1G3i1G3iO`QlO1G3iOOQ[1G3o1G3oOOQ[1G3q1G3qO?TQ`O1G3sO$6cQlO1G3uO$:gQlO'#HtOOQ[1G3x1G3xO$:tQ`O'#HzO?YQ`O'#H|OOQ[1G4O1G4OO$:|QlO1G4OO9uQ!0LrO1G4UOOQ[1G4W1G4WOOQ!0Lb'#G_'#G_O9uQ!0LrO1G4YO9uQ!0LrO1G4[O$?TQ`O,5@bO!)[QlO,5;`O9eQ`O,5;`O?YQ`O,5:XO!)[QlO,5:XO!CUQpO,5:XO$?YQ?MtO,5:XOOQO,5;`,5;`O$?dQpO'#IeO$?zQ`O,5@aOOQ!0Lf1G/r1G/rO$@SQpO'#IkO$@^Q`O,5@pOOQ!0Lb1G0y1G0yO#$`QpO,5:XOOQO'#Ig'#IgO$@fQpO,5:qOOQ!0Ln,5:q,5:qO#(ZQ`O1G0ZOOQ!0Lf1G0Z1G0ZO%[QlO1G0ZOOQ!0Lf1G0t1G0tO?YQ`O1G0tO!CUQpO1G0tO!C^QMhO1G0tOOQ!0Lb1G5|1G5|O!ByQ!0LrO1G0^OOQO1G0m1G0mO%[QlO1G0mO$@mQ!0LrO1G0mO$@xQ!0LrO1G0mO!CUQpO1G0^ODWQpO1G0^O$AWQ!0LrO1G0mOOQO1G0^1G0^O$AlQ!0MxO1G0mPOOO-E<[-E<[POOO1G.h1G.hOOOO1G/i1G/iO$AvQ!bO,5<iO$BOQ!fO1G4jOOQO1G4p1G4pO%[QlO,5?OO$BYQ`O1G5zO$BbQ`O1G6YO$BjQ!fO1G6ZO9eQ`O,5?UO$BtQ!0MxO1G6WO%[QlO1G6WO$CUQ!0LrO1G6WO$CgQ`O1G6VO$CgQ`O1G6VO9eQ`O1G6VO$CoQ`O,5?XO9eQ`O,5?XOOQO,5?X,5?XO$DTQ`O,5?XO$+YQ`O,5?XOOQO-E<k-E<kOOQS1G0a1G0aOOQS1G0c1G0cO#.lQ`O1G0cOOQ[7+(e7+(eO!&zQMhO7+(eO%[QlO7+(eO$DcQ`O7+(eO$DnQMhO7+(eO$D|Q!0MzO,5=XO$GXQ!0MzO,5=ZO$IdQ!0MzO,5=XO$KuQ!0MzO,5=ZO$NWQ!0MzO,59uO%!]Q!0MzO,5<kO%$hQ!0MzO,5<mO%&sQ!0MzO,5<{OOQ!0Lf7+&a7+&aO%)UQ!0MxO7+&aO%)xQlO'#IfO%*VQ`O,5@cO%*_Q!fO,5@cOOQ!0Lf1G0P1G0PO%*iQ`O7+&jOOQ!0Lf7+&j7+&jO%*nQ?MtO,5:fO%[QlO7+&zO%*xQ?MtO,5:bO%+VQ?MtO,5:jO%+aQ?MtO,5:lO%+kQMhO'#IiO%+uQ`O,5@hOOQ!0Lh1G0d1G0dOOQO1G1r1G1rOOQO1G1s1G1sO%+}Q!jO,5<ZO!)[QlO,5<YOOQO-E<l-E<lOOQ!0Lf7+'Y7+'YOOOW7+'e7+'eOOOW1G1|1G1|O%,YQ`O1G1|OOQ!0Lf1G2O1G2OOOOO,59o,59oO%,_Q!dO,59oOOOO-E<`-E<`OOQ!0Lh1G/X1G/XO%,fQ!0MxO7+'kOOQ!0Lh,5?^,5?^O%-YQMhO1G2fP%-aQ`O'#IrPOQ!0Lh-E<p-E<pO%-}QMjO,5?aOOQ!0Lh-E<s-E<sO%.pQMjO,5?cOOQ!0Lh-E<u-E<uO%.zQ!dO1G2wO%/RQ!dO'#CrO%/iQMhO'#KSO$$wQlO'#JvOOQ!0Lh1G2_1G2_O%/sQ`O'#IqO%0[Q`O,5@vO%0[Q`O,5@vO%0dQ`O,5@vO%0oQ`O,5@vOOQO1G2a1G2aO%0}QMjO1G2`O$+YQ`O'#K[O!,TQMhO1G2`O%1_Q(CWO'#IsO%1lQ`O,5@wO!&zQMhO,5@wO%1tQ!dO,5@wOOQ!0Lh1G2d1G2dO%4UQ!fO'#CiO%4`Q`O,5=POOQ!0Lb,5<},5<}O%4hQpO,5<}OOQ!0Lb,5=O,5=OOCwQ`O,5<}O%4sQpO,5<}OOQ!0Lb,5=R,5=RO$+YQ`O,5=VOOQO,5?`,5?`OOQO-E<r-E<rOOQ!0Lp1G2h1G2hO#$`QpO,5<}O$$wQlO,5=PO%5RQ`O,5=OO%5^QpO,5=OO!,TQMhO'#IuO%6WQMjO1G2sO!,TQMhO'#IwO%6yQMjO1G2uO%7TQMjO1G5qO%7_QMjO1G5qOOQO,5?e,5?eOOQO-E<w-E<wOOQO1G.{1G.{O!,TQMhO1G5qO!,TQMhO1G5qO!:]QpO,59wO%[QlO,59wOOQ!0Lh,5<j,5<jO%7lQ`O1G2ZO!,TQMhO1G2bO%7qQ!0MxO7+'mOOQ!0Lf7+'m7+'mO!$wQlO7+'mO%8eQ`O,5;`OOQ!0Lb,5?g,5?gOOQ!0Lb-E<y-E<yO%8jQ!dO'#K^O#(ZQ`O7+(eO4UQ!fO7+(eO$DfQ`O7+(eO%8tQ!0MvO'#CiO%9XQ!0MvO,5=SO%9lQ`O,5=SO%9tQ`O,5=SOOQ!0Lb1G5o1G5oOOQ[7+$a7+$aO!ByQ!0LrO7+$aO!CUQpO7+$aO!$wQlO7+&aO%9yQ`O'#JQO%:bQ`O,5APOOQO1G3h1G3hO9kQ`O,5APO%:bQ`O,5APO%:jQ`O,5APOOQO,5?m,5?mOOQO-E=P-E=POOQ!0Lf7+'T7+'TO%:oQ`O7+)QO9uQ!0LrO7+)QO9kQ`O7+)QO@zQ`O7+)QO%:tQ`O7+)QOOQ[7+)Q7+)QOOQ[7+(p7+(pO%:yQ!0MvO7+(mO!&zQMhO7+(mO!E^Q`O7+(nOOQ[7+(n7+(nO!&zQMhO7+(nO%;TQ`O'#KbO%;`Q`O,5=lOOQO,5?i,5?iOOQO-E<{-E<{OOQ[7+(s7+(sO%<rQpO'#HZOOQ[1G3`1G3`O!&zQMhO1G3`O%[QlO1G3`O%<yQ`O1G3`O%=UQMhO1G3`O9uQ!0LrO1G3bO$%dQ`O1G3bO9`Q`O1G3bO!CUQpO1G3bO!C^QMhO1G3bO%=dQ`O'#JPO%=xQ`O,5@}O%>QQpO,5@}OOQ!0Lb1G3c1G3cOOQ[7+$V7+$VO@zQ`O7+$VO9uQ!0LrO7+$VO%>]Q`O7+$VO%[QlO1G6lO%[QlO1G6mO%>bQ!0LrO1G6lO%>lQlO1G3kO%>sQ`O1G3kO%>xQlO1G3kOOQ[7+)T7+)TO9uQ!0LrO7+)_O`QlO7+)aOOQ['#Kh'#KhOOQ['#JS'#JSO%?PQlO,5>`OOQ[,5>`,5>`O%[QlO'#HuO%?^Q`O'#HwOOQ[,5>f,5>fO9eQ`O,5>fOOQ[,5>h,5>hOOQ[7+)j7+)jOOQ[7+)p7+)pOOQ[7+)t7+)tOOQ[7+)v7+)vO%?cQpO1G5|O%?}Q?MtO1G0zO%@XQ`O1G0zOOQO1G/s1G/sO%@dQ?MtO1G/sO?YQ`O1G/sO!)[QlO'#DmOOQO,5?P,5?POOQO-E<c-E<cOOQO,5?V,5?VOOQO-E<i-E<iO!CUQpO1G/sOOQO-E<e-E<eOOQ!0Ln1G0]1G0]OOQ!0Lf7+%u7+%uO#(ZQ`O7+%uOOQ!0Lf7+&`7+&`O?YQ`O7+&`O!CUQpO7+&`OOQO7+%x7+%xO$AlQ!0MxO7+&XOOQO7+&X7+&XO%[QlO7+&XO%@nQ!0LrO7+&XO!ByQ!0LrO7+%xO!CUQpO7+%xO%@yQ!0LrO7+&XO%AXQ!0MxO7++rO%[QlO7++rO%AiQ`O7++qO%AiQ`O7++qOOQO1G4s1G4sO9eQ`O1G4sO%AqQ`O1G4sOOQS7+%}7+%}O#(ZQ`O<<LPO4UQ!fO<<LPO%BPQ`O<<LPOOQ[<<LP<<LPO!&zQMhO<<LPO%[QlO<<LPO%BXQ`O<<LPO%BdQ!0MzO,5?aO%DoQ!0MzO,5?cO%FzQ!0MzO1G2`O%I]Q!0MzO1G2sO%KhQ!0MzO1G2uO%MsQ!fO,5?QO%[QlO,5?QOOQO-E<d-E<dO%M}Q`O1G5}OOQ!0Lf<<JU<<JUO%NVQ?MtO1G0uO&!^Q?MtO1G1PO&!eQ?MtO1G1PO&$fQ?MtO1G1PO&$mQ?MtO1G1PO&&nQ?MtO1G1PO&(oQ?MtO1G1PO&(vQ?MtO1G1PO&(}Q?MtO1G1PO&+OQ?MtO1G1PO&+VQ?MtO1G1PO&+^Q!0MxO<<JfO&-UQ?MtO1G1PO&.RQ?MvO1G1PO&/UQ?MvO'#JlO&1[Q?MtO1G1cO&1iQ?MtO1G0UO&1sQMjO,5?TOOQO-E<g-E<gO!)[QlO'#FqOOQO'#KZ'#KZOOQO1G1u1G1uO&1}Q`O1G1tO&2SQ?MtO,5?[OOOW7+'h7+'hOOOO1G/Z1G/ZO&2^Q!dO1G4xOOQ!0Lh7+(Q7+(QP!&zQMhO,5?^O!,TQMhO7+(cO&2eQ`O,5?]O9eQ`O,5?]O$+YQ`O,5?]OOQO-E<o-E<oO&2sQ`O1G6bO&2sQ`O1G6bO&2{Q`O1G6bO&3WQMjO7+'zO&3hQ!dO,5?_O&3rQ`O,5?_O!&zQMhO,5?_OOQO-E<q-E<qO&3wQ!dO1G6cO&4RQ`O1G6cO&4ZQ`O1G2kO!&zQMhO1G2kOOQ!0Lb1G2i1G2iOOQ!0Lb1G2j1G2jO%4hQpO1G2iO!CUQpO1G2iOCwQ`O1G2iOOQ!0Lb1G2q1G2qO&4`QpO1G2iO&4nQ`O1G2kO$+YQ`O1G2jOCwQ`O1G2jO$$wQlO1G2kO&4vQ`O1G2jO&5jQMjO,5?aOOQ!0Lh-E<t-E<tO&6]QMjO,5?cOOQ!0Lh-E<v-E<vO!,TQMhO7++]O&6gQMjO7++]O&6qQMjO7++]OOQ!0Lh1G/c1G/cO&7OQ`O1G/cOOQ!0Lh7+'u7+'uO&7TQMjO7+'|O&7eQ!0MxO<<KXOOQ!0Lf<<KX<<KXO&8XQ`O1G0zO!&zQMhO'#IzO&8^Q`O,5@xO&:`Q!fO<<LPO!&zQMhO1G2nO&:gQ!0LrO1G2nOOQ[<<G{<<G{O!ByQ!0LrO<<G{O&:xQ!0MxO<<I{OOQ!0Lf<<I{<<I{OOQO,5?l,5?lO&;lQ`O,5?lO&;qQ`O,5?lOOQO-E=O-E=OO&<PQ`O1G6kO&<PQ`O1G6kO9kQ`O1G6kO@zQ`O<<LlOOQ[<<Ll<<LlO&<XQ`O<<LlO9uQ!0LrO<<LlO9kQ`O<<LlOOQ[<<LX<<LXO%:yQ!0MvO<<LXOOQ[<<LY<<LYO!E^Q`O<<LYO&<^QpO'#I|O&<iQ`O,5@|O!)[QlO,5@|OOQ[1G3W1G3WOOQO'#JO'#JOO9uQ!0LrO'#JOO&<qQpO,5=uOOQ[,5=u,5=uO&<xQpO'#EgO&=PQpO'#GeO&=UQ`O7+(zO&=ZQ`O7+(zOOQ[7+(z7+(zO!&zQMhO7+(zO%[QlO7+(zO&=cQ`O7+(zOOQ[7+(|7+(|O9uQ!0LrO7+(|O$%dQ`O7+(|O9`Q`O7+(|O!CUQpO7+(|O&=nQ`O,5?kOOQO-E<}-E<}OOQO'#H^'#H^O&=yQ`O1G6iO9uQ!0LrO<<GqOOQ[<<Gq<<GqO@zQ`O<<GqO&>RQ`O7+,WO&>WQ`O7+,XO%[QlO7+,WO%[QlO7+,XOOQ[7+)V7+)VO&>]Q`O7+)VO&>bQlO7+)VO&>iQ`O7+)VOOQ[<<Ly<<LyOOQ[<<L{<<L{OOQ[-E=Q-E=QOOQ[1G3z1G3zO&>nQ`O,5>aOOQ[,5>c,5>cO&>sQ`O1G4QO9eQ`O7+&fO!)[QlO7+&fOOQO7+%_7+%_O&>xQ?MtO1G6ZO?YQ`O7+%_OOQ!0Lf<<Ia<<IaOOQ!0Lf<<Iz<<IzO?YQ`O<<IzOOQO<<Is<<IsO$AlQ!0MxO<<IsO%[QlO<<IsOOQO<<Id<<IdO!ByQ!0LrO<<IdO&?SQ!0LrO<<IsO&?_Q!0MxO<= ^O&?oQ`O<= ]OOQO7+*_7+*_O9eQ`O7+*_OOQ[ANAkANAkO&?wQ!fOANAkO!&zQMhOANAkO#(ZQ`OANAkO4UQ!fOANAkO&@OQ`OANAkO%[QlOANAkO&@WQ!0MzO7+'zO&BiQ!0MzO,5?aO&DtQ!0MzO,5?cO&GPQ!0MzO7+'|O&IbQ!fO1G4lO&IlQ?MtO7+&aO&KpQ?MvO,5=XO&MwQ?MvO,5=ZO&NXQ?MvO,5=XO&NiQ?MvO,5=ZO&NyQ?MvO,59uO'#PQ?MvO,5<kO'%SQ?MvO,5<mO''hQ?MvO,5<{O')^Q?MtO7+'kO')kQ?MtO7+'mO')xQ`O,5<]OOQO7+'`7+'`OOQ!0Lh7+*d7+*dO')}QMjO<<K}OOQO1G4w1G4wO'*UQ`O1G4wO'*aQ`O1G4wO'*oQ`O7++|O'*oQ`O7++|O!&zQMhO1G4yO'*wQ!dO1G4yO'+RQ`O7++}O'+ZQ`O7+(VO'+fQ!dO7+(VOOQ!0Lb7+(T7+(TOOQ!0Lb7+(U7+(UO!CUQpO7+(TOCwQ`O7+(TO'+pQ`O7+(VO!&zQMhO7+(VO$+YQ`O7+(UO'+uQ`O7+(VOCwQ`O7+(UO'+}QMjO<<NwO!,TQMhO<<NwOOQ!0Lh7+$}7+$}O',XQ!dO,5?fOOQO-E<x-E<xO',cQ!0MvO7+(YO!&zQMhO7+(YOOQ[AN=gAN=gO9kQ`O1G5WOOQO1G5W1G5WO',sQ`O1G5WO',xQ`O7+,VO',xQ`O7+,VO9uQ!0LrOANBWO@zQ`OANBWOOQ[ANBWANBWO'-QQ`OANBWOOQ[ANAsANAsOOQ[ANAtANAtO'-VQ`O,5?hOOQO-E<z-E<zO'-bQ?MtO1G6hOOQO,5?j,5?jOOQO-E<|-E<|OOQ[1G3a1G3aO'-lQ`O,5=POOQ[<<Lf<<LfO!&zQMhO<<LfO&=UQ`O<<LfO'-qQ`O<<LfO%[QlO<<LfOOQ[<<Lh<<LhO9uQ!0LrO<<LhO$%dQ`O<<LhO9`Q`O<<LhO'-yQpO1G5VO'.UQ`O7+,TOOQ[AN=]AN=]O9uQ!0LrOAN=]OOQ[<= r<= rOOQ[<= s<= sO'.^Q`O<= rO'.cQ`O<= sOOQ[<<Lq<<LqO'.hQ`O<<LqO'.mQlO<<LqOOQ[1G3{1G3{O?YQ`O7+)lO'.tQ`O<<JQO'/PQ?MtO<<JQOOQO<<Hy<<HyOOQ!0LfAN?fAN?fOOQOAN?_AN?_O$AlQ!0MxOAN?_OOQOAN?OAN?OO%[QlOAN?_OOQO<<My<<MyOOQ[G27VG27VO!&zQMhOG27VO#(ZQ`OG27VO'/ZQ!fOG27VO4UQ!fOG27VO'/bQ`OG27VO'/jQ?MtO<<JfO'/wQ?MvO1G2`O'1mQ?MvO,5?aO'3pQ?MvO,5?cO'5sQ?MvO1G2sO'7vQ?MvO1G2uO'9yQ?MtO<<KXO':WQ?MtO<<I{OOQO1G1w1G1wO!,TQMhOANAiOOQO7+*c7+*cO':eQ`O7+*cO':pQ`O<= hO':xQ!dO7+*eOOQ!0Lb<<Kq<<KqO$+YQ`O<<KqOCwQ`O<<KqO';SQ`O<<KqO!&zQMhO<<KqOOQ!0Lb<<Ko<<KoO!CUQpO<<KoO';_Q!dO<<KqOOQ!0Lb<<Kp<<KpO';iQ`O<<KqO!&zQMhO<<KqO$+YQ`O<<KpO';nQMjOANDcO';xQ!0MvO<<KtOOQO7+*r7+*rO9kQ`O7+*rO'<YQ`O<= qOOQ[G27rG27rO9uQ!0LrOG27rO@zQ`OG27rO!)[QlO1G5SO'<bQ`O7+,SO'<jQ`O1G2kO&=UQ`OANBQOOQ[ANBQANBQO!&zQMhOANBQO'<oQ`OANBQOOQ[ANBSANBSO9uQ!0LrOANBSO$%dQ`OANBSOOQO'#H_'#H_OOQO7+*q7+*qOOQ[G22wG22wOOQ[ANE^ANE^OOQ[ANE_ANE_OOQ[ANB]ANB]O'<wQ`OANB]OOQ[<<MW<<MWO!)[QlOAN?lOOQOG24yG24yO$AlQ!0MxOG24yO#(ZQ`OLD,qOOQ[LD,qLD,qO!&zQMhOLD,qO'<|Q!fOLD,qO'=TQ?MvO7+'zO'>yQ?MvO,5?aO'@|Q?MvO,5?cO'CPQ?MvO7+'|O'DuQMjOG27TOOQO<<M}<<M}OOQ!0LbANA]ANA]O$+YQ`OANA]OCwQ`OANA]O'EVQ!dOANA]OOQ!0LbANAZANAZO'E^Q`OANA]O!&zQMhOANA]O'EiQ!dOANA]OOQ!0LbANA[ANA[OOQO<<N^<<N^OOQ[LD-^LD-^O9uQ!0LrOLD-^O'EsQ?MtO7+*nOOQO'#Gf'#GfOOQ[G27lG27lO&=UQ`OG27lO!&zQMhOG27lOOQ[G27nG27nO9uQ!0LrOG27nOOQ[G27wG27wO'E}Q?MtOG25WOOQOLD*eLD*eOOQ[!$(!]!$(!]O#(ZQ`O!$(!]O!&zQMhO!$(!]O'FXQ!0MzOG27TOOQ!0LbG26wG26wO$+YQ`OG26wO'HjQ`OG26wOCwQ`OG26wO'HuQ!dOG26wO!&zQMhOG26wOOQ[!$(!x!$(!xOOQ[LD-WLD-WO&=UQ`OLD-WOOQ[LD-YLD-YOOQ[!)9Ew!)9EwO#(ZQ`O!)9EwOOQ!0LbLD,cLD,cO$+YQ`OLD,cOCwQ`OLD,cO'H|Q`OLD,cO'IXQ!dOLD,cOOQ[!$(!r!$(!rOOQ[!.K;c!.K;cO'I`Q?MvOG27TOOQ!0Lb!$( }!$( }O$+YQ`O!$( }OCwQ`O!$( }O'KUQ`O!$( }OOQ!0Lb!)9Ei!)9EiO$+YQ`O!)9EiOCwQ`O!)9EiOOQ!0Lb!.K;T!.K;TO$+YQ`O!.K;TOOQ!0Lb!4/0o!4/0oO!)[QlO'#DzO1PQ`O'#EXO'KaQ!fO'#JrO'KhQ!L^O'#DvO'KoQlO'#EOO'KvQ!fO'#CiO'N^Q!fO'#CiO!)[QlO'#EQO'NnQlO,5;ZO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO,5;eO!)[QlO'#IpO(!qQ`O,5<iO!)[QlO,5;eO(!yQMhO,5;eO($dQMhO,5;eO!)[QlO,5;wO!&zQMhO'#GmO(!yQMhO'#GmO!&zQMhO'#GoO(!yQMhO'#GoO1SQ`O'#DZO1SQ`O'#DZO!&zQMhO'#GPO(!yQMhO'#GPO!&zQMhO'#GRO(!yQMhO'#GRO!&zQMhO'#GaO(!yQMhO'#GaO!)[QlO,5:jO($kQpO'#D_O($uQpO'#JvO!)[QlO,5@oO'NnQlO1G0uO(%PQ?MtO'#CiO!)[QlO1G2PO!&zQMhO'#IuO(!yQMhO'#IuO!&zQMhO'#IwO(!yQMhO'#IwO(%ZQ!dO'#CrO!&zQMhO,5<tO(!yQMhO,5<tO'NnQlO1G2RO!)[QlO7+&zO!&zQMhO1G2`O(!yQMhO1G2`O!&zQMhO'#IuO(!yQMhO'#IuO!&zQMhO'#IwO(!yQMhO'#IwO!&zQMhO1G2bO(!yQMhO1G2bO'NnQlO7+'mO'NnQlO7+&aO!&zQMhOANAiO(!yQMhOANAiO(%nQ`O'#EoO(%sQ`O'#EoO(%{Q`O'#F]O(&QQ`O'#EyO(&VQ`O'#KTO(&bQ`O'#KRO(&mQ`O,5;ZO(&rQMjO,5<eO(&yQ`O'#GYO('OQ`O'#GYO('TQ`O,5<eO(']Q`O,5<gO('eQ`O,5;ZO('mQ?MtO1G1`O('tQ`O,5<tO('yQ`O,5<tO((OQ`O,5<vO((TQ`O,5<vO((YQ`O1G2RO((_Q`O1G0uO((dQMjO<<K}O((kQMjO<<K}O((rQMhO'#F|O9`Q`O'#F{OAuQ`O'#EnO!)[QlO,5;tO!3oQ`O'#GYO!3oQ`O'#GYO!3oQ`O'#G[O!3oQ`O'#G[O!,TQMhO7+(cO!,TQMhO7+(cO%.zQ!dO1G2wO%.zQ!dO1G2wO!&zQMhO,5=]O!&zQMhO,5=]",stateData:"()x~O'|OS'}OSTOS(ORQ~OPYOQYOSfOY!VOaqOdzOeyOl!POpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_XO!iuO!lZO!oYO!pYO!qYO!svO!uwO!xxO!|]O$W|O$niO%h}O%j!QO%l!OO%m!OO%n!OO%q!RO%s!SO%v!TO%w!TO%y!UO&W!WO&^!XO&`!YO&b!ZO&d![O&g!]O&m!^O&s!_O&u!`O&w!aO&y!bO&{!cO(TSO(VTO(YUO(aVO(o[O~OWtO~P`OPYOQYOSfOd!jOe!iOpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_!eO!iuO!lZO!oYO!pYO!qYO!svO!u!gO!x!hO$W!kO$niO(T!dO(VTO(YUO(aVO(o[O~Oa!wOs!nO!S!oO!b!yO!c!vO!d!vO!|<VO#T!pO#U!pO#V!xO#W!pO#X!pO#[!zO#]!zO(U!lO(VTO(YUO(e!mO(o!sO~O(O!{O~OP]XR]X[]Xa]Xj]Xr]X!Q]X!S]X!]]X!l]X!p]X#R]X#S]X#`]X#kfX#n]X#o]X#p]X#q]X#r]X#s]X#t]X#u]X#v]X#x]X#z]X#{]X$Q]X'z]X(a]X(r]X(y]X(z]X~O!g%RX~P(qO_!}O(V#PO(W!}O(X#PO~O_#QO(X#PO(Y#PO(Z#QO~Ox#SO!U#TO(b#TO(c#VO~OPYOQYOSfOd!jOe!iOpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_!eO!iuO!lZO!oYO!pYO!qYO!svO!u!gO!x!hO$W!kO$niO(T<ZO(VTO(YUO(aVO(o[O~O![#ZO!]#WO!Y(hP!Y(vP~P+}O!^#cO~P`OPYOQYOSfOd!jOe!iOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_!eO!iuO!lZO!oYO!pYO!qYO!svO!u!gO!x!hO$W!kO$niO(VTO(YUO(aVO(o[O~Op#mO![#iO!|]O#i#lO#j#iO(T<[O!k(sP~P.iO!l#oO(T#nO~O!x#sO!|]O%h#tO~O#k#uO~O!g#vO#k#uO~OP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!]$_O!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO#v$SO#x$UO#z$WO#{$XO(aVO(r$YO(y#|O(z#}O~Oa(fX'z(fX'w(fX!k(fX!Y(fX!_(fX%i(fX!g(fX~P1qO#S$dO#`$eO$Q$eOP(gXR(gX[(gXj(gXr(gX!Q(gX!S(gX!](gX!l(gX!p(gX#R(gX#n(gX#o(gX#p(gX#q(gX#r(gX#s(gX#t(gX#u(gX#v(gX#x(gX#z(gX#{(gX(a(gX(r(gX(y(gX(z(gX!_(gX%i(gX~Oa(gX'z(gX'w(gX!Y(gX!k(gXv(gX!g(gX~P4UO#`$eO~O$]$hO$_$gO$f$mO~OSfO!_$nO$i$oO$k$qO~Oh%VOj%dOk%dOp%WOr%XOs$tOt$tOz%YO|%ZO!O%]O!S${O!_$|O!i%bO!l$xO#j%cO$W%`O$t%^O$v%_O$y%aO(T$sO(VTO(YUO(a$uO(y$}O(z%POg(^P~Ol%[O~P7eO!l%eO~O!S%hO!_%iO(T%gO~O!g%mO~Oa%nO'z%nO~O!Q%rO~P%[O(U!lO~P%[O%n%vO~P%[Oh%VO!l%eO(T%gO(U!lO~Oe%}O!l%eO(T%gO~Oj$RO~O!_&PO(T%gO(U!lO(VTO(YUO`)WP~O!Q&SO!l&RO%j&VO&T&WO~P;SO!x#sO~O%s&YO!S)SX!_)SX(T)SX~O(T&ZO~Ol!PO!u&`O%j!QO%l!OO%m!OO%n!OO%q!RO%s!SO%v!TO%w!TO~Od&eOe&dO!x&bO%h&cO%{&aO~P<bOd&hOeyOl!PO!_&gO!u&`O!xxO!|]O%h}O%l!OO%m!OO%n!OO%q!RO%s!SO%v!TO%w!TO%y!UO~Ob&kO#`&nO%j&iO(U!lO~P=gO!l&oO!u&sO~O!l#oO~O!_XO~Oa%nO'x&{O'z%nO~Oa%nO'x'OO'z%nO~Oa%nO'x'QO'z%nO~O'w]X!Y]Xv]X!k]X&[]X!_]X%i]X!g]X~P(qO!b'_O!c'WO!d'WO(U!lO(VTO(YUO~Os'UO!S'TO!['XO(e'SO!^(iP!^(xP~P@nOn'bO!_'`O(T%gO~Oe'gO!l%eO(T%gO~O!Q&SO!l&RO~Os!nO!S!oO!|<VO#T!pO#U!pO#W!pO#X!pO(U!lO(VTO(YUO(e!mO(o!sO~O!b'mO!c'lO!d'lO#V!pO#['nO#]'nO~PBYOa%nOh%VO!g#vO!l%eO'z%nO(r'pO~O!p'tO#`'rO~PChOs!nO!S!oO(VTO(YUO(e!mO(o!sO~O!_XOs(mX!S(mX!b(mX!c(mX!d(mX!|(mX#T(mX#U(mX#V(mX#W(mX#X(mX#[(mX#](mX(U(mX(V(mX(Y(mX(e(mX(o(mX~O!c'lO!d'lO(U!lO~PDWO(P'xO(Q'xO(R'zO~O_!}O(V'|O(W!}O(X'|O~O_#QO(X'|O(Y'|O(Z#QO~Ov(OO~P%[Ox#SO!U#TO(b#TO(c(RO~O![(TO!Y'WX!Y'^X!]'WX!]'^X~P+}O!](VO!Y(hX~OP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!](VO!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO#v$SO#x$UO#z$WO#{$XO(aVO(r$YO(y#|O(z#}O~O!Y(hX~PHRO!Y([O~O!Y(uX!](uX!g(uX!k(uX(r(uX~O#`(uX#k#dX!^(uX~PJUO#`(]O!Y(wX!](wX~O!](^O!Y(vX~O!Y(aO~O#`$eO~PJUO!^(bO~P`OR#zO!Q#yO!S#{O!l#xO(aVOP!na[!naj!nar!na!]!na!p!na#R!na#n!na#o!na#p!na#q!na#r!na#s!na#t!na#u!na#v!na#x!na#z!na#{!na(r!na(y!na(z!na~Oa!na'z!na'w!na!Y!na!k!nav!na!_!na%i!na!g!na~PKlO!k(cO~O!g#vO#`(dO(r'pO!](tXa(tX'z(tX~O!k(tX~PNXO!S%hO!_%iO!|]O#i(iO#j(hO(T%gO~O!](jO!k(sX~O!k(lO~O!S%hO!_%iO#j(hO(T%gO~OP(gXR(gX[(gXj(gXr(gX!Q(gX!S(gX!](gX!l(gX!p(gX#R(gX#n(gX#o(gX#p(gX#q(gX#r(gX#s(gX#t(gX#u(gX#v(gX#x(gX#z(gX#{(gX(a(gX(r(gX(y(gX(z(gX~O!g#vO!k(gX~P! uOR(nO!Q(mO!l#xO#S$dO!|!{a!S!{a~O!x!{a%h!{a!_!{a#i!{a#j!{a(T!{a~P!#vO!x(rO~OPYOQYOSfOd!jOe!iOpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_XO!iuO!lZO!oYO!pYO!qYO!svO!u!gO!x!hO$W!kO$niO(T!dO(VTO(YUO(aVO(o[O~Oh%VOp%WOr%XOs$tOt$tOz%YO|%ZO!O<sO!S${O!_$|O!i>VO!l$xO#j<yO$W%`O$t<uO$v<wO$y%aO(T(vO(VTO(YUO(a$uO(y$}O(z%PO~O#k(xO~O![(zO!k(kP~P%[O(e(|O(o[O~O!S)OO!l#xO(e(|O(o[O~OP<UOQ<UOSfOd>ROe!iOpkOr<UOskOtkOzkO|<UO!O<UO!SWO!WkO!XkO!_!eO!i<XO!lZO!o<UO!p<UO!q<UO!s<YO!u<]O!x!hO$W!kO$n>PO(T)]O(VTO(YUO(aVO(o[O~O!]$_Oa$qa'z$qa'w$qa!k$qa!Y$qa!_$qa%i$qa!g$qa~Ol)dO~P!&zOh%VOp%WOr%XOs$tOt$tOz%YO|%ZO!O%]O!S${O!_$|O!i%bO!l$xO#j%cO$W%`O$t%^O$v%_O$y%aO(T(vO(VTO(YUO(a$uO(y$}O(z%PO~Og(pP~P!,TO!Q)iO!g)hO!_$^X$Z$^X$]$^X$_$^X$f$^X~O!g)hO!_({X$Z({X$]({X$_({X$f({X~O!Q)iO~P!.^O!Q)iO!_({X$Z({X$]({X$_({X$f({X~O!_)kO$Z)oO$])jO$_)jO$f)pO~O![)sO~P!)[O$]$hO$_$gO$f)wO~On$zX!Q$zX#S$zX'y$zX(y$zX(z$zX~OgmXg$zXnmX!]mX#`mX~P!0SOx)yO(b)zO(c)|O~On*VO!Q*OO'y*PO(y$}O(z%PO~Og)}O~P!1WOg*WO~Oh%VOr%XOs$tOt$tOz%YO|%ZO!O<sO!S*YO!_*ZO!i>VO!l$xO#j<yO$W%`O$t<uO$v<wO$y%aO(VTO(YUO(a$uO(y$}O(z%PO~Op*`O![*^O(T*XO!k)OP~P!1uO#k*aO~O!l*bO~Oh%VOp%WOr%XOs$tOt$tOz%YO|%ZO!O<sO!S${O!_$|O!i>VO!l$xO#j<yO$W%`O$t<uO$v<wO$y%aO(T*dO(VTO(YUO(a$uO(y$}O(z%PO~O![*gO!Y)PP~P!3tOr*sOs!nO!S*iO!b*qO!c*kO!d*kO!l*bO#[*rO%`*mO(U!lO(VTO(YUO(e!mO~O!^*pO~P!5iO#S$dOn(`X!Q(`X'y(`X(y(`X(z(`X!](`X#`(`X~Og(`X$O(`X~P!6kOn*xO#`*wOg(_X!](_X~O!]*yOg(^X~Oj%dOk%dOl%dO(T&ZOg(^P~Os*|O~Og)}O(T&ZO~O!l+SO~O(T(vO~Op+WO!S%hO![#iO!_%iO!|]O#i#lO#j#iO(T%gO!k(sP~O!g#vO#k+XO~O!S%hO![+ZO!](^O!_%iO(T%gO!Y(vP~Os'[O!S+]O![+[O(VTO(YUO(e(|O~O!^(xP~P!9|O!]+^Oa)TX'z)TX~OP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO#v$SO#x$UO#z$WO#{$XO(aVO(r$YO(y#|O(z#}O~Oa!ja!]!ja'z!ja'w!ja!Y!ja!k!jav!ja!_!ja%i!ja!g!ja~P!:tOR#zO!Q#yO!S#{O!l#xO(aVOP!ra[!raj!rar!ra!]!ra!p!ra#R!ra#n!ra#o!ra#p!ra#q!ra#r!ra#s!ra#t!ra#u!ra#v!ra#x!ra#z!ra#{!ra(r!ra(y!ra(z!ra~Oa!ra'z!ra'w!ra!Y!ra!k!rav!ra!_!ra%i!ra!g!ra~P!=[OR#zO!Q#yO!S#{O!l#xO(aVOP!ta[!taj!tar!ta!]!ta!p!ta#R!ta#n!ta#o!ta#p!ta#q!ta#r!ta#s!ta#t!ta#u!ta#v!ta#x!ta#z!ta#{!ta(r!ta(y!ta(z!ta~Oa!ta'z!ta'w!ta!Y!ta!k!tav!ta!_!ta%i!ta!g!ta~P!?rOh%VOn+gO!_'`O%i+fO~O!g+iOa(]X!_(]X'z(]X!](]X~Oa%nO!_XO'z%nO~Oh%VO!l%eO~Oh%VO!l%eO(T%gO~O!g#vO#k(xO~Ob+tO%j+uO(T+qO(VTO(YUO!^)XP~O!]+vO`)WX~O[+zO~O`+{O~O!_&PO(T%gO(U!lO`)WP~O%j,OO~P;SOh%VO#`,SO~Oh%VOn,VO!_$|O~O!_,XO~O!Q,ZO!_XO~O%n%vO~O!x,`O~Oe,eO~Ob,fO(T#nO(VTO(YUO!^)VP~Oe%}O~O%j!QO(T&ZO~P=gO[,kO`,jO~OPYOQYOSfOdzOeyOpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!iuO!lZO!oYO!pYO!qYO!svO!xxO!|]O$niO%h}O(VTO(YUO(aVO(o[O~O!_!eO!u!gO$W!kO(T!dO~P!FyO`,jOa%nO'z%nO~OPYOQYOSfOd!jOe!iOpkOrYOskOtkOzkO|YO!OYO!SWO!WkO!XkO!_!eO!iuO!lZO!oYO!pYO!qYO!svO!x!hO$W!kO$niO(T!dO(VTO(YUO(aVO(o[O~Oa,pOl!OO!uwO%l!OO%m!OO%n!OO~P!IcO!l&oO~O&^,vO~O!_,xO~O&o,zO&q,{OP&laQ&laS&laY&laa&lad&lae&lal&lap&lar&las&lat&laz&la|&la!O&la!S&la!W&la!X&la!_&la!i&la!l&la!o&la!p&la!q&la!s&la!u&la!x&la!|&la$W&la$n&la%h&la%j&la%l&la%m&la%n&la%q&la%s&la%v&la%w&la%y&la&W&la&^&la&`&la&b&la&d&la&g&la&m&la&s&la&u&la&w&la&y&la&{&la'w&la(T&la(V&la(Y&la(a&la(o&la!^&la&e&lab&la&j&la~O(T-QO~Oh!eX!]!RX!^!RX!g!RX!g!eX!l!eX#`!RX~O!]!eX!^!eX~P#!iO!g-VO#`-UOh(jX!]#hX!^#hX!g(jX!l(jX~O!](jX!^(jX~P##[Oh%VO!g-XO!l%eO!]!aX!^!aX~Os!nO!S!oO(VTO(YUO(e!mO~OP<UOQ<UOSfOd>ROe!iOpkOr<UOskOtkOzkO|<UO!O<UO!SWO!WkO!XkO!_!eO!i<XO!lZO!o<UO!p<UO!q<UO!s<YO!u<]O!x!hO$W!kO$n>PO(VTO(YUO(aVO(o[O~O(T=QO~P#$qO!]-]O!^(iX~O!^-_O~O!g-VO#`-UO!]#hX!^#hX~O!]-`O!^(xX~O!^-bO~O!c-cO!d-cO(U!lO~P#$`O!^-fO~P'_On-iO!_'`O~O!Y-nO~Os!{a!b!{a!c!{a!d!{a#T!{a#U!{a#V!{a#W!{a#X!{a#[!{a#]!{a(U!{a(V!{a(Y!{a(e!{a(o!{a~P!#vO!p-sO#`-qO~PChO!c-uO!d-uO(U!lO~PDWOa%nO#`-qO'z%nO~Oa%nO!g#vO#`-qO'z%nO~Oa%nO!g#vO!p-sO#`-qO'z%nO(r'pO~O(P'xO(Q'xO(R-zO~Ov-{O~O!Y'Wa!]'Wa~P!:tO![.PO!Y'WX!]'WX~P%[O!](VO!Y(ha~O!Y(ha~PHRO!](^O!Y(va~O!S%hO![.TO!_%iO(T%gO!Y'^X!]'^X~O#`.VO!](ta!k(taa(ta'z(ta~O!g#vO~P#,wO!](jO!k(sa~O!S%hO!_%iO#j.ZO(T%gO~Op.`O!S%hO![.]O!_%iO!|]O#i._O#j.]O(T%gO!]'aX!k'aX~OR.dO!l#xO~Oh%VOn.gO!_'`O%i.fO~Oa#ci!]#ci'z#ci'w#ci!Y#ci!k#civ#ci!_#ci%i#ci!g#ci~P!:tOn>]O!Q*OO'y*PO(y$}O(z%PO~O#k#_aa#_a#`#_a'z#_a!]#_a!k#_a!_#_a!Y#_a~P#/sO#k(`XP(`XR(`X[(`Xa(`Xj(`Xr(`X!S(`X!l(`X!p(`X#R(`X#n(`X#o(`X#p(`X#q(`X#r(`X#s(`X#t(`X#u(`X#v(`X#x(`X#z(`X#{(`X'z(`X(a(`X(r(`X!k(`X!Y(`X'w(`Xv(`X!_(`X%i(`X!g(`X~P!6kO!].tO!k(kX~P!:tO!k.wO~O!Y.yO~OP$[OR#zO!Q#yO!S#{O!l#xO!p$[O(aVO[#mia#mij#mir#mi!]#mi#R#mi#o#mi#p#mi#q#mi#r#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi'z#mi(r#mi(y#mi(z#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~O#n#mi~P#3cO#n$OO~P#3cOP$[OR#zOr$aO!Q#yO!S#{O!l#xO!p$[O#n$OO#o$PO#p$PO#q$PO(aVO[#mia#mij#mi!]#mi#R#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi'z#mi(r#mi(y#mi(z#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~O#r#mi~P#6QO#r$QO~P#6QOP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO(aVOa#mi!]#mi#x#mi#z#mi#{#mi'z#mi(r#mi(y#mi(z#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~O#v#mi~P#8oOP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO#v$SO(aVO(z#}Oa#mi!]#mi#z#mi#{#mi'z#mi(r#mi(y#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~O#x$UO~P#;VO#x#mi~P#;VO#v$SO~P#8oOP$[OR#zO[$cOj$ROr$aO!Q#yO!S#{O!l#xO!p$[O#R$RO#n$OO#o$PO#p$PO#q$PO#r$QO#s$RO#t$RO#u$bO#v$SO#x$UO(aVO(y#|O(z#}Oa#mi!]#mi#{#mi'z#mi(r#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~O#z#mi~P#={O#z$WO~P#={OP]XR]X[]Xj]Xr]X!Q]X!S]X!l]X!p]X#R]X#S]X#`]X#kfX#n]X#o]X#p]X#q]X#r]X#s]X#t]X#u]X#v]X#x]X#z]X#{]X$Q]X(a]X(r]X(y]X(z]X!]]X!^]X~O$O]X~P#@jOP$[OR#zO[<mOj<bOr<kO!Q#yO!S#{O!l#xO!p$[O#R<bO#n<_O#o<`O#p<`O#q<`O#r<aO#s<bO#t<bO#u<lO#v<cO#x<eO#z<gO#{<hO(aVO(r$YO(y#|O(z#}O~O$O.{O~P#BwO#S$dO#`<nO$Q<nO$O(gX!^(gX~P! uOa'da!]'da'z'da'w'da!k'da!Y'dav'da!_'da%i'da!g'da~P!:tO[#mia#mij#mir#mi!]#mi#R#mi#r#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi'z#mi(r#mi'w#mi!Y#mi!k#miv#mi!_#mi%i#mi!g#mi~OP$[OR#zO!Q#yO!S#{O!l#xO!p$[O#n$OO#o$PO#p$PO#q$PO(aVO(y#mi(z#mi~P#EyOn>]O!Q*OO'y*PO(y$}O(z%POP#miR#mi!S#mi!l#mi!p#mi#n#mi#o#mi#p#mi#q#mi(a#mi~P#EyO!]/POg(pX~P!1WOg/RO~Oa$Pi!]$Pi'z$Pi'w$Pi!Y$Pi!k$Piv$Pi!_$Pi%i$Pi!g$Pi~P!:tO$]/SO$_/SO~O$]/TO$_/TO~O!g)hO#`/UO!_$cX$Z$cX$]$cX$_$cX$f$cX~O![/VO~O!_)kO$Z/XO$])jO$_)jO$f/YO~O!]<iO!^(fX~P#BwO!^/ZO~O!g)hO$f({X~O$f/]O~Ov/^O~P!&zOx)yO(b)zO(c/aO~O!S/dO~O(y$}On%aa!Q%aa'y%aa(z%aa!]%aa#`%aa~Og%aa$O%aa~P#L{O(z%POn%ca!Q%ca'y%ca(y%ca!]%ca#`%ca~Og%ca$O%ca~P#MnO!]fX!gfX!kfX!k$zX(rfX~P!0SOp%WO![/mO!](^O(T/lO!Y(vP!Y)PP~P!1uOr*sO!b*qO!c*kO!d*kO!l*bO#[*rO%`*mO(U!lO(VTO(YUO~Os<}O!S/nO![+[O!^*pO(e<|O!^(xP~P$ [O!k/oO~P#/sO!]/pO!g#vO(r'pO!k)OX~O!k/uO~OnoX!QoX'yoX(yoX(zoX~O!g#vO!koX~P$#OOp/wO!S%hO![*^O!_%iO(T%gO!k)OP~O#k/xO~O!Y$zX!]$zX!g%RX~P!0SO!]/yO!Y)PX~P#/sO!g/{O~O!Y/}O~OpkO(T0OO~P.iOh%VOr0TO!g#vO!l%eO(r'pO~O!g+iO~Oa%nO!]0XO'z%nO~O!^0ZO~P!5iO!c0[O!d0[O(U!lO~P#$`Os!nO!S0]O(VTO(YUO(e!mO~O#[0_O~Og%aa!]%aa#`%aa$O%aa~P!1WOg%ca!]%ca#`%ca$O%ca~P!1WOj%dOk%dOl%dO(T&ZOg'mX!]'mX~O!]*yOg(^a~Og0hO~On0jO#`0iOg(_a!](_a~OR0kO!Q0kO!S0lO#S$dOn}a'y}a(y}a(z}a!]}a#`}a~Og}a$O}a~P$(cO!Q*OO'y*POn$sa(y$sa(z$sa!]$sa#`$sa~Og$sa$O$sa~P$)_O!Q*OO'y*POn$ua(y$ua(z$ua!]$ua#`$ua~Og$ua$O$ua~P$*QO#k0oO~Og%Ta!]%Ta#`%Ta$O%Ta~P!1WO!g#vO~O#k0rO~O!]+^Oa)Ta'z)Ta~OR#zO!Q#yO!S#{O!l#xO(aVOP!ri[!rij!rir!ri!]!ri!p!ri#R!ri#n!ri#o!ri#p!ri#q!ri#r!ri#s!ri#t!ri#u!ri#v!ri#x!ri#z!ri#{!ri(r!ri(y!ri(z!ri~Oa!ri'z!ri'w!ri!Y!ri!k!riv!ri!_!ri%i!ri!g!ri~P$+oOh%VOr%XOs$tOt$tOz%YO|%ZO!O<sO!S${O!_$|O!i>VO!l$xO#j<yO$W%`O$t<uO$v<wO$y%aO(VTO(YUO(a$uO(y$}O(z%PO~Op0{O%]0|O(T0zO~P$.VO!g+iOa(]a!_(]a'z(]a!](]a~O#k1SO~O[]X!]fX!^fX~O!]1TO!^)XX~O!^1VO~O[1WO~Ob1YO(T+qO(VTO(YUO~O!_&PO(T%gO`'uX!]'uX~O!]+vO`)Wa~O!k1]O~P!:tO[1`O~O`1aO~O#`1fO~On1iO!_$|O~O(e(|O!^)UP~Oh%VOn1rO!_1oO%i1qO~O[1|O!]1zO!^)VX~O!^1}O~O`2POa%nO'z%nO~O(T#nO(VTO(YUO~O#S$dO#`$eO$Q$eOP(gXR(gX[(gXr(gX!Q(gX!S(gX!](gX!l(gX!p(gX#R(gX#n(gX#o(gX#p(gX#q(gX#r(gX#s(gX#t(gX#u(gX#v(gX#x(gX#z(gX#{(gX(a(gX(r(gX(y(gX(z(gX~Oj2SO&[2TOa(gX~P$3pOj2SO#`$eO&[2TO~Oa2VO~P%[Oa2XO~O&e2[OP&ciQ&ciS&ciY&cia&cid&cie&cil&cip&cir&cis&cit&ciz&ci|&ci!O&ci!S&ci!W&ci!X&ci!_&ci!i&ci!l&ci!o&ci!p&ci!q&ci!s&ci!u&ci!x&ci!|&ci$W&ci$n&ci%h&ci%j&ci%l&ci%m&ci%n&ci%q&ci%s&ci%v&ci%w&ci%y&ci&W&ci&^&ci&`&ci&b&ci&d&ci&g&ci&m&ci&s&ci&u&ci&w&ci&y&ci&{&ci'w&ci(T&ci(V&ci(Y&ci(a&ci(o&ci!^&cib&ci&j&ci~Ob2bO!^2`O&j2aO~P`O!_XO!l2dO~O&q,{OP&liQ&liS&liY&lia&lid&lie&lil&lip&lir&lis&lit&liz&li|&li!O&li!S&li!W&li!X&li!_&li!i&li!l&li!o&li!p&li!q&li!s&li!u&li!x&li!|&li$W&li$n&li%h&li%j&li%l&li%m&li%n&li%q&li%s&li%v&li%w&li%y&li&W&li&^&li&`&li&b&li&d&li&g&li&m&li&s&li&u&li&w&li&y&li&{&li'w&li(T&li(V&li(Y&li(a&li(o&li!^&li&e&lib&li&j&li~O!Y2jO~O!]!aa!^!aa~P#BwOs!nO!S!oO![2pO(e!mO!]'XX!^'XX~P@nO!]-]O!^(ia~O!]'_X!^'_X~P!9|O!]-`O!^(xa~O!^2wO~P'_Oa%nO#`3QO'z%nO~Oa%nO!g#vO#`3QO'z%nO~Oa%nO!g#vO!p3UO#`3QO'z%nO(r'pO~Oa%nO'z%nO~P!:tO!]$_Ov$qa~O!Y'Wi!]'Wi~P!:tO!](VO!Y(hi~O!](^O!Y(vi~O!Y(wi!](wi~P!:tO!](ti!k(tia(ti'z(ti~P!:tO#`3WO!](ti!k(tia(ti'z(ti~O!](jO!k(si~O!S%hO!_%iO!|]O#i3]O#j3[O(T%gO~O!S%hO!_%iO#j3[O(T%gO~On3dO!_'`O%i3cO~Oh%VOn3dO!_'`O%i3cO~O#k%aaP%aaR%aa[%aaa%aaj%aar%aa!S%aa!l%aa!p%aa#R%aa#n%aa#o%aa#p%aa#q%aa#r%aa#s%aa#t%aa#u%aa#v%aa#x%aa#z%aa#{%aa'z%aa(a%aa(r%aa!k%aa!Y%aa'w%aav%aa!_%aa%i%aa!g%aa~P#L{O#k%caP%caR%ca[%caa%caj%car%ca!S%ca!l%ca!p%ca#R%ca#n%ca#o%ca#p%ca#q%ca#r%ca#s%ca#t%ca#u%ca#v%ca#x%ca#z%ca#{%ca'z%ca(a%ca(r%ca!k%ca!Y%ca'w%cav%ca!_%ca%i%ca!g%ca~P#MnO#k%aaP%aaR%aa[%aaa%aaj%aar%aa!S%aa!]%aa!l%aa!p%aa#R%aa#n%aa#o%aa#p%aa#q%aa#r%aa#s%aa#t%aa#u%aa#v%aa#x%aa#z%aa#{%aa'z%aa(a%aa(r%aa!k%aa!Y%aa'w%aa#`%aav%aa!_%aa%i%aa!g%aa~P#/sO#k%caP%caR%ca[%caa%caj%car%ca!S%ca!]%ca!l%ca!p%ca#R%ca#n%ca#o%ca#p%ca#q%ca#r%ca#s%ca#t%ca#u%ca#v%ca#x%ca#z%ca#{%ca'z%ca(a%ca(r%ca!k%ca!Y%ca'w%ca#`%cav%ca!_%ca%i%ca!g%ca~P#/sO#k}aP}a[}aa}aj}ar}a!l}a!p}a#R}a#n}a#o}a#p}a#q}a#r}a#s}a#t}a#u}a#v}a#x}a#z}a#{}a'z}a(a}a(r}a!k}a!Y}a'w}av}a!_}a%i}a!g}a~P$(cO#k$saP$saR$sa[$saa$saj$sar$sa!S$sa!l$sa!p$sa#R$sa#n$sa#o$sa#p$sa#q$sa#r$sa#s$sa#t$sa#u$sa#v$sa#x$sa#z$sa#{$sa'z$sa(a$sa(r$sa!k$sa!Y$sa'w$sav$sa!_$sa%i$sa!g$sa~P$)_O#k$uaP$uaR$ua[$uaa$uaj$uar$ua!S$ua!l$ua!p$ua#R$ua#n$ua#o$ua#p$ua#q$ua#r$ua#s$ua#t$ua#u$ua#v$ua#x$ua#z$ua#{$ua'z$ua(a$ua(r$ua!k$ua!Y$ua'w$uav$ua!_$ua%i$ua!g$ua~P$*QO#k%TaP%TaR%Ta[%Taa%Taj%Tar%Ta!S%Ta!]%Ta!l%Ta!p%Ta#R%Ta#n%Ta#o%Ta#p%Ta#q%Ta#r%Ta#s%Ta#t%Ta#u%Ta#v%Ta#x%Ta#z%Ta#{%Ta'z%Ta(a%Ta(r%Ta!k%Ta!Y%Ta'w%Ta#`%Tav%Ta!_%Ta%i%Ta!g%Ta~P#/sOa#cq!]#cq'z#cq'w#cq!Y#cq!k#cqv#cq!_#cq%i#cq!g#cq~P!:tO![3lO!]'YX!k'YX~P%[O!].tO!k(ka~O!].tO!k(ka~P!:tO!Y3oO~O$O!na!^!na~PKlO$O!ja!]!ja!^!ja~P#BwO$O!ra!^!ra~P!=[O$O!ta!^!ta~P!?rOg']X!]']X~P!,TO!]/POg(pa~OSfO!_4TO$d4UO~O!^4YO~Ov4ZO~P#/sOa$mq!]$mq'z$mq'w$mq!Y$mq!k$mqv$mq!_$mq%i$mq!g$mq~P!:tO!Y4]O~P!&zO!S4^O~O!Q*OO'y*PO(z%POn'ia(y'ia!]'ia#`'ia~Og'ia$O'ia~P%-fO!Q*OO'y*POn'ka(y'ka(z'ka!]'ka#`'ka~Og'ka$O'ka~P%.XO(r$YO~P#/sO!YfX!Y$zX!]fX!]$zX!g%RX#`fX~P!0SOp%WO(T=WO~P!1uOp4bO!S%hO![4aO!_%iO(T%gO!]'eX!k'eX~O!]/pO!k)Oa~O!]/pO!g#vO!k)Oa~O!]/pO!g#vO(r'pO!k)Oa~Og$|i!]$|i#`$|i$O$|i~P!1WO![4jO!Y'gX!]'gX~P!3tO!]/yO!Y)Pa~O!]/yO!Y)Pa~P#/sOP]XR]X[]Xj]Xr]X!Q]X!S]X!Y]X!]]X!l]X!p]X#R]X#S]X#`]X#kfX#n]X#o]X#p]X#q]X#r]X#s]X#t]X#u]X#v]X#x]X#z]X#{]X$Q]X(a]X(r]X(y]X(z]X~Oj%YX!g%YX~P%2OOj4oO!g#vO~Oh%VO!g#vO!l%eO~Oh%VOr4tO!l%eO(r'pO~Or4yO!g#vO(r'pO~Os!nO!S4zO(VTO(YUO(e!mO~O(y$}On%ai!Q%ai'y%ai(z%ai!]%ai#`%ai~Og%ai$O%ai~P%5oO(z%POn%ci!Q%ci'y%ci(y%ci!]%ci#`%ci~Og%ci$O%ci~P%6bOg(_i!](_i~P!1WO#`5QOg(_i!](_i~P!1WO!k5VO~Oa$oq!]$oq'z$oq'w$oq!Y$oq!k$oqv$oq!_$oq%i$oq!g$oq~P!:tO!Y5ZO~O!]5[O!_)QX~P#/sOa$zX!_$zX%^]X'z$zX!]$zX~P!0SO%^5_OaoX!_oX'zoX!]oX~P$#OOp5`O(T#nO~O%^5_O~Ob5fO%j5gO(T+qO(VTO(YUO!]'tX!^'tX~O!]1TO!^)Xa~O[5kO~O`5lO~O[5pO~Oa%nO'z%nO~P#/sO!]5uO#`5wO!^)UX~O!^5xO~Or6OOs!nO!S*iO!b!yO!c!vO!d!vO!|<VO#T!pO#U!pO#V!pO#W!pO#X!pO#[5}O#]!zO(U!lO(VTO(YUO(e!mO(o!sO~O!^5|O~P%;eOn6TO!_1oO%i6SO~Oh%VOn6TO!_1oO%i6SO~Ob6[O(T#nO(VTO(YUO!]'sX!^'sX~O!]1zO!^)Va~O(VTO(YUO(e6^O~O`6bO~Oj6eO&[6fO~PNXO!k6gO~P%[Oa6iO~Oa6iO~P%[Ob2bO!^6nO&j2aO~P`O!g6pO~O!g6rOh(ji!](ji!^(ji!g(ji!l(jir(ji(r(ji~O!]#hi!^#hi~P#BwO#`6sO!]#hi!^#hi~O!]!ai!^!ai~P#BwOa%nO#`6|O'z%nO~Oa%nO!g#vO#`6|O'z%nO~O!](tq!k(tqa(tq'z(tq~P!:tO!](jO!k(sq~O!S%hO!_%iO#j7TO(T%gO~O!_'`O%i7WO~On7[O!_'`O%i7WO~O#k'iaP'iaR'ia['iaa'iaj'iar'ia!S'ia!l'ia!p'ia#R'ia#n'ia#o'ia#p'ia#q'ia#r'ia#s'ia#t'ia#u'ia#v'ia#x'ia#z'ia#{'ia'z'ia(a'ia(r'ia!k'ia!Y'ia'w'iav'ia!_'ia%i'ia!g'ia~P%-fO#k'kaP'kaR'ka['kaa'kaj'kar'ka!S'ka!l'ka!p'ka#R'ka#n'ka#o'ka#p'ka#q'ka#r'ka#s'ka#t'ka#u'ka#v'ka#x'ka#z'ka#{'ka'z'ka(a'ka(r'ka!k'ka!Y'ka'w'kav'ka!_'ka%i'ka!g'ka~P%.XO#k$|iP$|iR$|i[$|ia$|ij$|ir$|i!S$|i!]$|i!l$|i!p$|i#R$|i#n$|i#o$|i#p$|i#q$|i#r$|i#s$|i#t$|i#u$|i#v$|i#x$|i#z$|i#{$|i'z$|i(a$|i(r$|i!k$|i!Y$|i'w$|i#`$|iv$|i!_$|i%i$|i!g$|i~P#/sO#k%aiP%aiR%ai[%aia%aij%air%ai!S%ai!l%ai!p%ai#R%ai#n%ai#o%ai#p%ai#q%ai#r%ai#s%ai#t%ai#u%ai#v%ai#x%ai#z%ai#{%ai'z%ai(a%ai(r%ai!k%ai!Y%ai'w%aiv%ai!_%ai%i%ai!g%ai~P%5oO#k%ciP%ciR%ci[%cia%cij%cir%ci!S%ci!l%ci!p%ci#R%ci#n%ci#o%ci#p%ci#q%ci#r%ci#s%ci#t%ci#u%ci#v%ci#x%ci#z%ci#{%ci'z%ci(a%ci(r%ci!k%ci!Y%ci'w%civ%ci!_%ci%i%ci!g%ci~P%6bO!]'Ya!k'Ya~P!:tO!].tO!k(ki~O$O#ci!]#ci!^#ci~P#BwOP$[OR#zO!Q#yO!S#{O!l#xO!p$[O(aVO[#mij#mir#mi#R#mi#o#mi#p#mi#q#mi#r#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi$O#mi(r#mi(y#mi(z#mi!]#mi!^#mi~O#n#mi~P%NdO#n<_O~P%NdOP$[OR#zOr<kO!Q#yO!S#{O!l#xO!p$[O#n<_O#o<`O#p<`O#q<`O(aVO[#mij#mi#R#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi$O#mi(r#mi(y#mi(z#mi!]#mi!^#mi~O#r#mi~P&!lO#r<aO~P&!lOP$[OR#zO[<mOj<bOr<kO!Q#yO!S#{O!l#xO!p$[O#R<bO#n<_O#o<`O#p<`O#q<`O#r<aO#s<bO#t<bO#u<lO(aVO#x#mi#z#mi#{#mi$O#mi(r#mi(y#mi(z#mi!]#mi!^#mi~O#v#mi~P&$tOP$[OR#zO[<mOj<bOr<kO!Q#yO!S#{O!l#xO!p$[O#R<bO#n<_O#o<`O#p<`O#q<`O#r<aO#s<bO#t<bO#u<lO#v<cO(aVO(z#}O#z#mi#{#mi$O#mi(r#mi(y#mi!]#mi!^#mi~O#x<eO~P&&uO#x#mi~P&&uO#v<cO~P&$tOP$[OR#zO[<mOj<bOr<kO!Q#yO!S#{O!l#xO!p$[O#R<bO#n<_O#o<`O#p<`O#q<`O#r<aO#s<bO#t<bO#u<lO#v<cO#x<eO(aVO(y#|O(z#}O#{#mi$O#mi(r#mi!]#mi!^#mi~O#z#mi~P&)UO#z<gO~P&)UOa#|y!]#|y'z#|y'w#|y!Y#|y!k#|yv#|y!_#|y%i#|y!g#|y~P!:tO[#mij#mir#mi#R#mi#r#mi#s#mi#t#mi#u#mi#v#mi#x#mi#z#mi#{#mi$O#mi(r#mi!]#mi!^#mi~OP$[OR#zO!Q#yO!S#{O!l#xO!p$[O#n<_O#o<`O#p<`O#q<`O(aVO(y#mi(z#mi~P&,QOn>^O!Q*OO'y*PO(y$}O(z%POP#miR#mi!S#mi!l#mi!p#mi#n#mi#o#mi#p#mi#q#mi(a#mi~P&,QO#S$dOP(`XR(`X[(`Xj(`Xn(`Xr(`X!Q(`X!S(`X!l(`X!p(`X#R(`X#n(`X#o(`X#p(`X#q(`X#r(`X#s(`X#t(`X#u(`X#v(`X#x(`X#z(`X#{(`X$O(`X'y(`X(a(`X(r(`X(y(`X(z(`X!](`X!^(`X~O$O$Pi!]$Pi!^$Pi~P#BwO$O!ri!^!ri~P$+oOg']a!]']a~P!1WO!^7nO~O!]'da!^'da~P#BwO!Y7oO~P#/sO!g#vO(r'pO!]'ea!k'ea~O!]/pO!k)Oi~O!]/pO!g#vO!k)Oi~Og$|q!]$|q#`$|q$O$|q~P!1WO!Y'ga!]'ga~P#/sO!g7vO~O!]/yO!Y)Pi~P#/sO!]/yO!Y)Pi~O!Y7yO~Oh%VOr8OO!l%eO(r'pO~Oj8QO!g#vO~Or8TO!g#vO(r'pO~O!Q*OO'y*PO(z%POn'ja(y'ja!]'ja#`'ja~Og'ja$O'ja~P&5RO!Q*OO'y*POn'la(y'la(z'la!]'la#`'la~Og'la$O'la~P&5tOg(_q!](_q~P!1WO#`8VOg(_q!](_q~P!1WO!Y8WO~Og%Oq!]%Oq#`%Oq$O%Oq~P!1WOa$oy!]$oy'z$oy'w$oy!Y$oy!k$oyv$oy!_$oy%i$oy!g$oy~P!:tO!g6rO~O!]5[O!_)Qa~O!_'`OP$TaR$Ta[$Taj$Tar$Ta!Q$Ta!S$Ta!]$Ta!l$Ta!p$Ta#R$Ta#n$Ta#o$Ta#p$Ta#q$Ta#r$Ta#s$Ta#t$Ta#u$Ta#v$Ta#x$Ta#z$Ta#{$Ta(a$Ta(r$Ta(y$Ta(z$Ta~O%i7WO~P&8fO%^8[Oa%[i!_%[i'z%[i!]%[i~Oa#cy!]#cy'z#cy'w#cy!Y#cy!k#cyv#cy!_#cy%i#cy!g#cy~P!:tO[8^O~Ob8`O(T+qO(VTO(YUO~O!]1TO!^)Xi~O`8dO~O(e(|O!]'pX!^'pX~O!]5uO!^)Ua~O!^8nO~P%;eO(o!sO~P$&YO#[8oO~O!_1oO~O!_1oO%i8qO~On8tO!_1oO%i8qO~O[8yO!]'sa!^'sa~O!]1zO!^)Vi~O!k8}O~O!k9OO~O!k9RO~O!k9RO~P%[Oa9TO~O!g9UO~O!k9VO~O!](wi!^(wi~P#BwOa%nO#`9_O'z%nO~O!](ty!k(tya(ty'z(ty~P!:tO!](jO!k(sy~O%i9bO~P&8fO!_'`O%i9bO~O#k$|qP$|qR$|q[$|qa$|qj$|qr$|q!S$|q!]$|q!l$|q!p$|q#R$|q#n$|q#o$|q#p$|q#q$|q#r$|q#s$|q#t$|q#u$|q#v$|q#x$|q#z$|q#{$|q'z$|q(a$|q(r$|q!k$|q!Y$|q'w$|q#`$|qv$|q!_$|q%i$|q!g$|q~P#/sO#k'jaP'jaR'ja['jaa'jaj'jar'ja!S'ja!l'ja!p'ja#R'ja#n'ja#o'ja#p'ja#q'ja#r'ja#s'ja#t'ja#u'ja#v'ja#x'ja#z'ja#{'ja'z'ja(a'ja(r'ja!k'ja!Y'ja'w'jav'ja!_'ja%i'ja!g'ja~P&5RO#k'laP'laR'la['laa'laj'lar'la!S'la!l'la!p'la#R'la#n'la#o'la#p'la#q'la#r'la#s'la#t'la#u'la#v'la#x'la#z'la#{'la'z'la(a'la(r'la!k'la!Y'la'w'lav'la!_'la%i'la!g'la~P&5tO#k%OqP%OqR%Oq[%Oqa%Oqj%Oqr%Oq!S%Oq!]%Oq!l%Oq!p%Oq#R%Oq#n%Oq#o%Oq#p%Oq#q%Oq#r%Oq#s%Oq#t%Oq#u%Oq#v%Oq#x%Oq#z%Oq#{%Oq'z%Oq(a%Oq(r%Oq!k%Oq!Y%Oq'w%Oq#`%Oqv%Oq!_%Oq%i%Oq!g%Oq~P#/sO!]'Yi!k'Yi~P!:tO$O#cq!]#cq!^#cq~P#BwO(y$}OP%aaR%aa[%aaj%aar%aa!S%aa!l%aa!p%aa#R%aa#n%aa#o%aa#p%aa#q%aa#r%aa#s%aa#t%aa#u%aa#v%aa#x%aa#z%aa#{%aa$O%aa(a%aa(r%aa!]%aa!^%aa~On%aa!Q%aa'y%aa(z%aa~P&IyO(z%POP%caR%ca[%caj%car%ca!S%ca!l%ca!p%ca#R%ca#n%ca#o%ca#p%ca#q%ca#r%ca#s%ca#t%ca#u%ca#v%ca#x%ca#z%ca#{%ca$O%ca(a%ca(r%ca!]%ca!^%ca~On%ca!Q%ca'y%ca(y%ca~P&LQOn>^O!Q*OO'y*PO(z%PO~P&IyOn>^O!Q*OO'y*PO(y$}O~P&LQOR0kO!Q0kO!S0lO#S$dOP}a[}aj}an}ar}a!l}a!p}a#R}a#n}a#o}a#p}a#q}a#r}a#s}a#t}a#u}a#v}a#x}a#z}a#{}a$O}a'y}a(a}a(r}a(y}a(z}a!]}a!^}a~O!Q*OO'y*POP$saR$sa[$saj$san$sar$sa!S$sa!l$sa!p$sa#R$sa#n$sa#o$sa#p$sa#q$sa#r$sa#s$sa#t$sa#u$sa#v$sa#x$sa#z$sa#{$sa$O$sa(a$sa(r$sa(y$sa(z$sa!]$sa!^$sa~O!Q*OO'y*POP$uaR$ua[$uaj$uan$uar$ua!S$ua!l$ua!p$ua#R$ua#n$ua#o$ua#p$ua#q$ua#r$ua#s$ua#t$ua#u$ua#v$ua#x$ua#z$ua#{$ua$O$ua(a$ua(r$ua(y$ua(z$ua!]$ua!^$ua~On>^O!Q*OO'y*PO(y$}O(z%PO~OP%TaR%Ta[%Taj%Tar%Ta!S%Ta!l%Ta!p%Ta#R%Ta#n%Ta#o%Ta#p%Ta#q%Ta#r%Ta#s%Ta#t%Ta#u%Ta#v%Ta#x%Ta#z%Ta#{%Ta$O%Ta(a%Ta(r%Ta!]%Ta!^%Ta~P''VO$O$mq!]$mq!^$mq~P#BwO$O$oq!]$oq!^$oq~P#BwO!^9oO~O$O9pO~P!1WO!g#vO!]'ei!k'ei~O!g#vO(r'pO!]'ei!k'ei~O!]/pO!k)Oq~O!Y'gi!]'gi~P#/sO!]/yO!Y)Pq~Or9wO!g#vO(r'pO~O[9yO!Y9xO~P#/sO!Y9xO~Oj:PO!g#vO~Og(_y!](_y~P!1WO!]'na!_'na~P#/sOa%[q!_%[q'z%[q!]%[q~P#/sO[:UO~O!]1TO!^)Xq~O`:YO~O#`:ZO!]'pa!^'pa~O!]5uO!^)Ui~P#BwO!S:]O~O!_1oO%i:`O~O(VTO(YUO(e:eO~O!]1zO!^)Vq~O!k:hO~O!k:iO~O!k:jO~O!k:jO~P%[O#`:mO!]#hy!^#hy~O!]#hy!^#hy~P#BwO%i:rO~P&8fO!_'`O%i:rO~O$O#|y!]#|y!^#|y~P#BwOP$|iR$|i[$|ij$|ir$|i!S$|i!l$|i!p$|i#R$|i#n$|i#o$|i#p$|i#q$|i#r$|i#s$|i#t$|i#u$|i#v$|i#x$|i#z$|i#{$|i$O$|i(a$|i(r$|i!]$|i!^$|i~P''VO!Q*OO'y*PO(z%POP'iaR'ia['iaj'ian'iar'ia!S'ia!l'ia!p'ia#R'ia#n'ia#o'ia#p'ia#q'ia#r'ia#s'ia#t'ia#u'ia#v'ia#x'ia#z'ia#{'ia$O'ia(a'ia(r'ia(y'ia!]'ia!^'ia~O!Q*OO'y*POP'kaR'ka['kaj'kan'kar'ka!S'ka!l'ka!p'ka#R'ka#n'ka#o'ka#p'ka#q'ka#r'ka#s'ka#t'ka#u'ka#v'ka#x'ka#z'ka#{'ka$O'ka(a'ka(r'ka(y'ka(z'ka!]'ka!^'ka~O(y$}OP%aiR%ai[%aij%ain%air%ai!Q%ai!S%ai!l%ai!p%ai#R%ai#n%ai#o%ai#p%ai#q%ai#r%ai#s%ai#t%ai#u%ai#v%ai#x%ai#z%ai#{%ai$O%ai'y%ai(a%ai(r%ai(z%ai!]%ai!^%ai~O(z%POP%ciR%ci[%cij%cin%cir%ci!Q%ci!S%ci!l%ci!p%ci#R%ci#n%ci#o%ci#p%ci#q%ci#r%ci#s%ci#t%ci#u%ci#v%ci#x%ci#z%ci#{%ci$O%ci'y%ci(a%ci(r%ci(y%ci!]%ci!^%ci~O$O$oy!]$oy!^$oy~P#BwO$O#cy!]#cy!^#cy~P#BwO!g#vO!]'eq!k'eq~O!]/pO!k)Oy~O!Y'gq!]'gq~P#/sOr:|O!g#vO(r'pO~O[;QO!Y;PO~P#/sO!Y;PO~Og(_!R!](_!R~P!1WOa%[y!_%[y'z%[y!]%[y~P#/sO!]1TO!^)Xy~O!]5uO!^)Uq~O(T;XO~O!_1oO%i;[O~O!k;_O~O%i;dO~P&8fOP$|qR$|q[$|qj$|qr$|q!S$|q!l$|q!p$|q#R$|q#n$|q#o$|q#p$|q#q$|q#r$|q#s$|q#t$|q#u$|q#v$|q#x$|q#z$|q#{$|q$O$|q(a$|q(r$|q!]$|q!^$|q~P''VO!Q*OO'y*PO(z%POP'jaR'ja['jaj'jan'jar'ja!S'ja!l'ja!p'ja#R'ja#n'ja#o'ja#p'ja#q'ja#r'ja#s'ja#t'ja#u'ja#v'ja#x'ja#z'ja#{'ja$O'ja(a'ja(r'ja(y'ja!]'ja!^'ja~O!Q*OO'y*POP'laR'la['laj'lan'lar'la!S'la!l'la!p'la#R'la#n'la#o'la#p'la#q'la#r'la#s'la#t'la#u'la#v'la#x'la#z'la#{'la$O'la(a'la(r'la(y'la(z'la!]'la!^'la~OP%OqR%Oq[%Oqj%Oqr%Oq!S%Oq!l%Oq!p%Oq#R%Oq#n%Oq#o%Oq#p%Oq#q%Oq#r%Oq#s%Oq#t%Oq#u%Oq#v%Oq#x%Oq#z%Oq#{%Oq$O%Oq(a%Oq(r%Oq!]%Oq!^%Oq~P''VOg%e!Z!]%e!Z#`%e!Z$O%e!Z~P!1WO!Y;hO~P#/sOr;iO!g#vO(r'pO~O[;kO!Y;hO~P#/sO!]'pq!^'pq~P#BwO!]#h!Z!^#h!Z~P#BwO#k%e!ZP%e!ZR%e!Z[%e!Za%e!Zj%e!Zr%e!Z!S%e!Z!]%e!Z!l%e!Z!p%e!Z#R%e!Z#n%e!Z#o%e!Z#p%e!Z#q%e!Z#r%e!Z#s%e!Z#t%e!Z#u%e!Z#v%e!Z#x%e!Z#z%e!Z#{%e!Z'z%e!Z(a%e!Z(r%e!Z!k%e!Z!Y%e!Z'w%e!Z#`%e!Zv%e!Z!_%e!Z%i%e!Z!g%e!Z~P#/sOr;tO!g#vO(r'pO~O!Y;uO~P#/sOr;|O!g#vO(r'pO~O!Y;}O~P#/sOP%e!ZR%e!Z[%e!Zj%e!Zr%e!Z!S%e!Z!l%e!Z!p%e!Z#R%e!Z#n%e!Z#o%e!Z#p%e!Z#q%e!Z#r%e!Z#s%e!Z#t%e!Z#u%e!Z#v%e!Z#x%e!Z#z%e!Z#{%e!Z$O%e!Z(a%e!Z(r%e!Z!]%e!Z!^%e!Z~P''VOr<QO!g#vO(r'pO~Ov(fX~P1qO!Q%rO~P!)[O(U!lO~P!)[O!YfX!]fX#`fX~P%2OOP]XR]X[]Xj]Xr]X!Q]X!S]X!]]X!]fX!l]X!p]X#R]X#S]X#`]X#`fX#kfX#n]X#o]X#p]X#q]X#r]X#s]X#t]X#u]X#v]X#x]X#z]X#{]X$Q]X(a]X(r]X(y]X(z]X~O!gfX!k]X!kfX(rfX~P'LTOP<UOQ<UOSfOd>ROe!iOpkOr<UOskOtkOzkO|<UO!O<UO!SWO!WkO!XkO!_XO!i<XO!lZO!o<UO!p<UO!q<UO!s<YO!u<]O!x!hO$W!kO$n>PO(T)]O(VTO(YUO(aVO(o[O~O!]<iO!^$qa~Oh%VOp%WOr%XOs$tOt$tOz%YO|%ZO!O<tO!S${O!_$|O!i>WO!l$xO#j<zO$W%`O$t<vO$v<xO$y%aO(T(vO(VTO(YUO(a$uO(y$}O(z%PO~Ol)dO~P(!yOr!eX(r!eX~P#!iOr(jX(r(jX~P##[O!^]X!^fX~P'LTO!YfX!Y$zX!]fX!]$zX#`fX~P!0SO#k<^O~O!g#vO#k<^O~O#`<nO~Oj<bO~O#`=OO!](wX!^(wX~O#`<nO!](uX!^(uX~O#k=PO~Og=RO~P!1WO#k=XO~O#k=YO~Og=RO(T&ZO~O!g#vO#k=ZO~O!g#vO#k=PO~O$O=[O~P#BwO#k=]O~O#k=^O~O#k=cO~O#k=dO~O#k=eO~O#k=fO~O$O=gO~P!1WO$O=hO~P!1WOl=sO~P7eOk#S#T#U#W#X#[#i#j#u$n$t$v$y%]%^%h%i%j%q%s%v%w%y%{~(OT#o!X'|(U#ps#n#qr!Q'}$]'}(T$_(e~",goto:"$9Y)]PPPPPP)^PP)aP)rP+W/]PPPP6mPP7TPP=QPPP@tPA^PA^PPPA^PCfPA^PA^PA^PCjPCoPD^PIWPPPI[PPPPI[L_PPPLeMVPI[PI[PP! eI[PPPI[PI[P!#lI[P!'S!(X!(bP!)U!)Y!)U!,gPPPPPPP!-W!(XPP!-h!/YP!2iI[I[!2n!5z!:h!:h!>gPPP!>oI[PPPPPPPPP!BOP!C]PPI[!DnPI[PI[I[I[I[I[PI[!FQP!I[P!LbP!Lf!Lp!Lt!LtP!IXP!Lx!LxP#!OP#!SI[PI[#!Y#%_CjA^PA^PA^A^P#&lA^A^#)OA^#+vA^#.SA^A^#.r#1W#1W#1]#1f#1W#1qPP#1WPA^#2ZA^#6YA^A^6mPPP#:_PPP#:x#:xP#:xP#;`#:xPP#;fP#;]P#;]#;y#;]#<e#<k#<n)aP#<q)aP#<z#<z#<zP)aP)aP)aP)aPP)aP#=Q#=TP#=T)aP#=XP#=[P)aP)aP)aP)aP)aP)a)aPP#=b#=h#=s#=y#>P#>V#>]#>k#>q#>{#?R#?]#?c#?s#?y#@k#@}#AT#AZ#Ai#BO#Cs#DR#DY#Et#FS#Gt#HS#HY#H`#Hf#Hp#Hv#H|#IW#Ij#IpPPPPPPPPPPP#IvPPPPPPP#Jk#Mx$ b$ i$ qPPP$']P$'f$*_$0x$0{$1O$1}$2Q$2X$2aP$2g$2jP$3W$3[$4S$5b$5g$5}PP$6S$6Y$6^$6a$6e$6i$7e$7|$8e$8i$8l$8o$8y$8|$9Q$9UR!|RoqOXst!Z#d%m&r&t&u&w,s,x2[2_Y!vQ'`-e1o5{Q%tvQ%|yQ&T|Q&j!VS'W!e-]Q'f!iS'l!r!yU*k$|*Z*oQ+o%}S+|&V&WQ,d&dQ-c'_Q-m'gQ-u'mQ0[*qQ1b,OQ1y,eR<{<Y%SdOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+],p,s,x-i-q.P.V.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3l4z6T6e6f6i6|8t9T9_S#q]<V!r)_$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SU+P%]<s<tQ+t&PQ,f&gQ,m&oQ0x+gQ0}+iQ1Y+uQ2R,kQ3`.gQ5`0|Q5f1TQ6[1zQ7Y3dQ8`5gR9e7['QkOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>S!S!nQ!r!v!y!z$|'W'_'`'l'm'n*k*o*q*r-]-c-e-u0[0_1o5{5}%[$ti#v$b$c$d$x${%O%Q%^%_%c)y*R*T*V*Y*a*g*w*x+f+i,S,V.f/P/d/m/x/y/{0`0b0i0j0o1f1i1q3c4^4_4j4o5Q5[5_6S7W7v8Q8V8[8q9b9p9y:P:`:r;Q;[;d;k<l<m<o<p<q<r<u<v<w<x<y<z=S=T=U=V=X=Y=]=^=_=`=a=b=c=d=g=h>P>X>Y>]>^Q&X|Q'U!eS'[%i-`Q+t&PQ,P&WQ,f&gQ0n+SQ1Y+uQ1_+{Q2Q,jQ2R,kQ5f1TQ5o1aQ6[1zQ6_1|Q6`2PQ8`5gQ8c5lQ8|6bQ:X8dQ:f8yQ;V:YR<}*ZrnOXst!V!Z#d%m&i&r&t&u&w,s,x2[2_R,h&k&z^OPXYstuvwz!Z!`!g!j!o#S#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'b'r(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>R>S[#]WZ#W#Z'X(T!b%jm#h#i#l$x%e%h(^(h(i(j*Y*^*b+Z+[+^,o-V.T.Z.[.]._/m/p2d3[3]4a6r7TQ%wxQ%{yW&Q|&V&W,OQ&_!TQ'c!hQ'e!iQ(q#sS+n%|%}Q+r&PQ,_&bQ,c&dS-l'f'gQ.i(rQ1R+oQ1X+uQ1Z+vQ1^+zQ1t,`S1x,d,eQ2|-mQ5e1TQ5i1WQ5n1`Q6Z1yQ8_5gQ8b5kQ8f5pQ:T8^R;T:U!U$zi$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>Y!^%yy!i!u%{%|%}'V'e'f'g'k'u*j+n+o-Y-l-m-t0R0U1R2u2|3T4r4s4v7}9{Q+h%wQ,T&[Q,W&]Q,b&dQ.h(qQ1s,_U1w,c,d,eQ3e.iQ6U1tS6Y1x1yQ8x6Z#f>T#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^o>U<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=hW%Ti%V*y>PS&[!Q&iQ&]!RQ&^!SU*}%[%d=sR,R&Y%]%Si#v$b$c$d$x${%O%Q%^%_%c)y*R*T*V*Y*a*g*w*x+f+i,S,V.f/P/d/m/x/y/{0`0b0i0j0o1f1i1q3c4^4_4j4o5Q5[5_6S7W7v8Q8V8[8q9b9p9y:P:`:r;Q;[;d;k<l<m<o<p<q<r<u<v<w<x<y<z=S=T=U=V=X=Y=]=^=_=`=a=b=c=d=g=h>P>X>Y>]>^T)z$u){V+P%]<s<tW'[!e%i*Z-`S(}#y#zQ+c%rQ+y&SS.b(m(nQ1j,XQ5T0kR8i5u'QkOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>S$i$^c#Y#e%q%s%u(S(Y(t(y)R)S)T)U)V)W)X)Y)Z)[)^)`)b)g)q+d+x-Z-x-}.S.U.s.v.z.|.}/O/b0p2k2n3O3V3k3p3q3r3s3t3u3v3w3x3y3z3{3|4P4Q4X5X5c6u6{7Q7a7b7k7l8k9X9]9g9m9n:o;W;`<W=vT#TV#U'RkOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SQ'Y!eR2q-]!W!nQ!e!r!v!y!z$|'W'_'`'l'm'n*Z*k*o*q*r-]-c-e-u0[0_1o5{5}R1l,ZnqOXst!Z#d%m&r&t&u&w,s,x2[2_Q&y!^Q'v!xS(s#u<^Q+l%zQ,]&_Q,^&aQ-j'dQ-w'oS.r(x=PS0q+X=ZQ1P+mQ1n,[Q2c,zQ2e,{Q2m-WQ2z-kQ2}-oS5Y0r=eQ5a1QS5d1S=fQ6t2oQ6x2{Q6}3SQ8]5bQ9Y6vQ9Z6yQ9^7OR:l9V$d$]c#Y#e%s%u(S(Y(t(y)R)S)T)U)V)W)X)Y)Z)[)^)`)b)g)q+d+x-Z-x-}.S.U.s.v.z.}/O/b0p2k2n3O3V3k3p3q3r3s3t3u3v3w3x3y3z3{3|4P4Q4X5X5c6u6{7Q7a7b7k7l8k9X9]9g9m9n:o;W;`<W=vS(o#p'iQ)P#zS+b%q.|S.c(n(pR3^.d'QkOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SS#q]<VQ&t!XQ&u!YQ&w![Q&x!]R2Z,vQ'a!hQ+e%wQ-h'cS.e(q+hQ2x-gW3b.h.i0w0yQ6w2yW7U3_3a3e5^U9a7V7X7ZU:q9c9d9fS;b:p:sQ;p;cR;x;qU!wQ'`-eT5y1o5{!Q_OXZ`st!V!Z#d#h%e%m&i&k&r&t&u&w(j,s,x.[2[2_]!pQ!r'`-e1o5{T#q]<V%^{OPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&o&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+]+g,p,s,x-i-q.P.V.g.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3d3l4z6T6e6f6i6|7[8t9T9_S(}#y#zS.b(m(n!s=l$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SU$fd)_,mS(p#p'iU*v%R(w4OU0m+O.n7gQ5^0xQ7V3`Q9d7YR:s9em!tQ!r!v!y!z'`'l'm'n-e-u1o5{5}Q't!uS(f#g2US-s'k'wQ/s*]Q0R*jQ3U-vQ4f/tQ4r0TQ4s0UQ4x0^Q7r4`S7}4t4vS8R4y4{Q9r7sQ9v7yQ9{8OQ:Q8TS:{9w9xS;g:|;PS;s;h;iS;{;t;uS<P;|;}R<S<QQ#wbQ's!uS(e#g2US(g#m+WQ+Y%fQ+j%xQ+p&OU-r'k't'wQ.W(fU/r*]*`/wQ0S*jQ0V*lQ1O+kQ1u,aS3R-s-vQ3Z.`S4e/s/tQ4n0PS4q0R0^Q4u0WQ6W1vQ7P3US7q4`4bQ7u4fU7|4r4x4{Q8P4wQ8v6XS9q7r7sQ9u7yQ9}8RQ:O8SQ:c8wQ:y9rS:z9v9xQ;S:QQ;^:dS;f:{;PS;r;g;hS;z;s;uS<O;{;}Q<R<PQ<T<SQ=o=jQ={=tR=|=uV!wQ'`-e%^aOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&o&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+]+g,p,s,x-i-q.P.V.g.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3d3l4z6T6e6f6i6|7[8t9T9_S#wz!j!r=i$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SR=o>R%^bOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&o&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+]+g,p,s,x-i-q.P.V.g.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3d3l4z6T6e6f6i6|7[8t9T9_Q%fj!^%xy!i!u%{%|%}'V'e'f'g'k'u*j+n+o-Y-l-m-t0R0U1R2u2|3T4r4s4v7}9{S&Oz!jQ+k%yQ,a&dW1v,b,c,d,eU6X1w1x1yS8w6Y6ZQ:d8x!r=j$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SQ=t>QR=u>R%QeOPXYstuvw!Z!`!g!o#S#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&r&t&u&w&{'T'b'r(V(](d(x(z)O)}*i+X+]+g,p,s,x-i-q.P.V.g.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3d3l4z6T6e6f6i6|7[8t9T9_Y#bWZ#W#Z(T!b%jm#h#i#l$x%e%h(^(h(i(j*Y*^*b+Z+[+^,o-V.T.Z.[.]._/m/p2d3[3]4a6r7TQ,n&o!p=k$Z$n)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SR=n'XU']!e%i*ZR2s-`%SdOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+],p,s,x-i-q.P.V.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3l4z6T6e6f6i6|8t9T9_!r)_$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SQ,m&oQ0x+gQ3`.gQ7Y3dR9e7[!b$Tc#Y%q(S(Y(t(y)Z)[)`)g+x-x-}.S.U.s.v/b0p3O3V3k3{5X5c6{7Q7a9]:o<W!P<d)^)q-Z.|2k2n3p3y3z4P4X6u7b7k7l8k9X9g9m9n;W;`=v!f$Vc#Y%q(S(Y(t(y)W)X)Z)[)`)g+x-x-}.S.U.s.v/b0p3O3V3k3{5X5c6{7Q7a9]:o<W!T<f)^)q-Z.|2k2n3p3v3w3y3z4P4X6u7b7k7l8k9X9g9m9n;W;`=v!^$Zc#Y%q(S(Y(t(y)`)g+x-x-}.S.U.s.v/b0p3O3V3k3{5X5c6{7Q7a9]:o<WQ4_/kz>S)^)q-Z.|2k2n3p4P4X6u7b7k7l8k9X9g9m9n;W;`=vQ>X>ZR>Y>['QkOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>SS$oh$pR4U/U'XgOPWXYZhstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n$p%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/U/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>ST$kf$qQ$ifS)j$l)nR)v$qT$jf$qT)l$l)n'XhOPWXYZhstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$Z$_$a$e$n$p%m%t&R&k&n&o&r&t&u&w&{'T'X'b'r(T(V(](d(x(z)O)s)}*i+X+]+g,p,s,x-U-X-i-q.P.V.g.t.{/U/V/n0]0l0r1S1r2S2T2V2X2[2_2a2p3Q3W3d3l4T4z5w6T6e6f6i6s6|7[8t9T9_:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>ST$oh$pQ$rhR)u$p%^jOPWXYZstuvw!Z!`!g!o#S#W#Z#d#o#u#x#{$O$P$Q$R$S$T$U$V$W$X$_$a$e%m%t&R&k&n&o&r&t&u&w&{'T'b'r(T(V(](d(x(z)O)}*i+X+]+g,p,s,x-i-q.P.V.g.t.{/n0]0l0r1S1r2S2T2V2X2[2_2a3Q3W3d3l4z6T6e6f6i6|7[8t9T9_!s>Q$Z$n'X)s-U-X/V2p4T5w6s:Z:m<U<X<Y<]<^<_<`<a<b<c<d<e<f<g<h<i<k<n<{=O=P=R=Z=[=e=f>S#glOPXZst!Z!`!o#S#d#o#{$n%m&k&n&o&r&t&u&w&{'T'b)O)s*i+]+g,p,s,x-i.g/V/n0]0l1r2S2T2V2X2[2_2a3d4T4z6T6e6f6i7[8t9T!U%Ri$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>Y#f(w#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^Q+T%aQ/c*Oo4O<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=h!U$yi$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>YQ*c$zU*l$|*Z*oQ+U%bQ0W*m#f=q#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^n=r<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=hQ=w>TQ=x>UQ=y>VR=z>W!U%Ri$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>Y#f(w#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^o4O<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=hnoOXst!Z#d%m&r&t&u&w,s,x2[2_S*f${*YQ-R'OQ-S'QR4i/y%[%Si#v$b$c$d$x${%O%Q%^%_%c)y*R*T*V*Y*a*g*w*x+f+i,S,V.f/P/d/m/x/y/{0`0b0i0j0o1f1i1q3c4^4_4j4o5Q5[5_6S7W7v8Q8V8[8q9b9p9y:P:`:r;Q;[;d;k<l<m<o<p<q<r<u<v<w<x<y<z=S=T=U=V=X=Y=]=^=_=`=a=b=c=d=g=h>P>X>Y>]>^Q,U&]Q1h,WQ5s1gR8h5tV*n$|*Z*oU*n$|*Z*oT5z1o5{S0P*i/nQ4w0]T8S4z:]Q+j%xQ0V*lQ1O+kQ1u,aQ6W1vQ8v6XQ:c8wR;^:d!U%Oi$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>Yx*R$v)e*S*u+V/v0d0e4R4g5R5S5W7p8U:R:x=p=}>OS0`*t0a#f<o#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^n<p<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=h!d=S(u)c*[*e.j.m.q/_/k/|0v1e3h4[4h4l5r7]7`7w7z8X8Z9t9|:S:};R;e;j;v>Z>[`=T3}7c7f7j9h:t:w;yS=_.l3iT=`7e9k!U%Qi$d%O%Q%^%_%c*R*T*a*w*x/P/x0`0b0i0j0o4_5Q8V9p>P>X>Y|*T$v)e*U*t+V/g/v0d0e4R4g4|5R5S5W7p8U:R:x=p=}>OS0b*u0c#f<q#v$b$c$x${)y*V*Y*g+f+i,S,V.f/d/m/y/{1f1i1q3c4^4j4o5[5_6S7W7v8Q8[8q9b9y:P:`:r;Q;[;d;k<o<q<u<w<y=S=U=X=]=_=a=c=g>]>^n<r<l<m<p<r<v<x<z=T=V=Y=^=`=b=d=h!h=U(u)c*[*e.k.l.q/_/k/|0v1e3f3h4[4h4l5r7]7^7`7w7z8X8Z9t9|:S:};R;e;j;v>Z>[d=V3}7d7e7j9h9i:t:u:w;yS=a.m3jT=b7f9lrnOXst!V!Z#d%m&i&r&t&u&w,s,x2[2_Q&f!UR,p&ornOXst!V!Z#d%m&i&r&t&u&w,s,x2[2_R&f!UQ,Y&^R1d,RsnOXst!V!Z#d%m&i&r&t&u&w,s,x2[2_Q1p,_S6R1s1tU8p6P6Q6US:_8r8sS;Y:^:aQ;m;ZR;w;nQ&m!VR,i&iR6_1|R:f8yW&Q|&V&W,OR1Z+vQ&r!WR,s&sR,y&xT2],x2_R,}&yQ,|&yR2f,}Q'y!{R-y'ySsOtQ#dXT%ps#dQ#OTR'{#OQ#RUR'}#RQ){$uR/`){Q#UVR(Q#UQ#XWU(W#X(X.QQ(X#YR.Q(YQ-^'YR2r-^Q.u(yS3m.u3nR3n.vQ-e'`R2v-eY!rQ'`-e1o5{R'j!rQ/Q)eR4S/QU#_W%h*YU(_#_(`.RQ(`#`R.R(ZQ-a']R2t-at`OXst!V!Z#d%m&i&k&r&t&u&w,s,x2[2_S#hZ%eU#r`#h.[R.[(jQ(k#jQ.X(gW.a(k.X3X7RQ3X.YR7R3YQ)n$lR/W)nQ$phR)t$pQ$`cU)a$`-|<jQ-|<WR<j)qQ/q*]W4c/q4d7t9sU4d/r/s/tS7t4e4fR9s7u$e*Q$v(u)c)e*[*e*t*u+Q+R+V.l.m.o.p.q/_/g/i/k/v/|0d0e0v1e3f3g3h3}4R4[4g4h4l4|5O5R5S5W5r7]7^7_7`7e7f7h7i7j7p7w7z8U8X8Z9h9i9j9t9|:R:S:t:u:v:w:x:};R;e;j;v;y=p=}>O>Z>[Q/z*eU4k/z4m7xQ4m/|R7x4lS*o$|*ZR0Y*ox*S$v)e*t*u+V/v0d0e4R4g5R5S5W7p8U:R:x=p=}>O!d.j(u)c*[*e.l.m.q/_/k/|0v1e3h4[4h4l5r7]7`7w7z8X8Z9t9|:S:};R;e;j;v>Z>[U/h*S.j7ca7c3}7e7f7j9h:t:w;yQ0a*tQ3i.lU4}0a3i9kR9k7e|*U$v)e*t*u+V/g/v0d0e4R4g4|5R5S5W7p8U:R:x=p=}>O!h.k(u)c*[*e.l.m.q/_/k/|0v1e3f3h4[4h4l5r7]7^7`7w7z8X8Z9t9|:S:};R;e;j;v>Z>[U/j*U.k7de7d3}7e7f7j9h9i:t:u:w;yQ0c*uQ3j.mU5P0c3j9lR9l7fQ*z%UR0g*zQ5]0vR8Y5]Q+_%kR0u+_Q5v1jS8j5v:[R:[8kQ,[&_R1m,[Q5{1oR8m5{Q1{,fS6]1{8zR8z6_Q1U+rW5h1U5j8a:VQ5j1XQ8a5iR:V8bQ+w&QR1[+wQ2_,xR6m2_YrOXst#dQ&v!ZQ+a%mQ,r&rQ,t&tQ,u&uQ,w&wQ2Y,sS2],x2_R6l2[Q%opQ&z!_Q&}!aQ'P!bQ'R!cQ'q!uQ+`%lQ+l%zQ,Q&XQ,h&mQ-P&|W-p'k's't'wQ-w'oQ0X*nQ1P+mQ1c,PS2O,i,lQ2g-OQ2h-RQ2i-SQ2}-oW3P-r-s-v-xQ5a1QQ5m1_Q5q1eQ6V1uQ6a2QQ6k2ZU6z3O3R3UQ6}3SQ8]5bQ8e5oQ8g5rQ8l5zQ8u6WQ8{6`S9[6{7PQ9^7OQ:W8cQ:b8vQ:g8|Q:n9]Q;U:XQ;]:cQ;a:oQ;l;VR;o;^Q%zyQ'd!iQ'o!uU+m%{%|%}Q-W'VU-k'e'f'gS-o'k'uQ0Q*jS1Q+n+oQ2o-YS2{-l-mQ3S-tS4p0R0UQ5b1RQ6v2uQ6y2|Q7O3TU7{4r4s4vQ9z7}R;O9{S$wi>PR*{%VU%Ui%V>PR0f*yQ$viS(u#v+iS)c$b$cQ)e$dQ*[$xS*e${*YQ*t%OQ*u%QQ+Q%^Q+R%_Q+V%cQ.l<oQ.m<qQ.o<uQ.p<wQ.q<yQ/_)yQ/g*RQ/i*TQ/k*VQ/v*aS/|*g/mQ0d*wQ0e*xl0v+f,V.f1i1q3c6S7W8q9b:`:r;[;dQ1e,SQ3f=SQ3g=UQ3h=XS3}<l<mQ4R/PS4[/d4^Q4g/xQ4h/yQ4l/{Q4|0`Q5O0bQ5R0iQ5S0jQ5W0oQ5r1fQ7]=]Q7^=_Q7_=aQ7`=cQ7e<pQ7f<rQ7h<vQ7i<xQ7j<zQ7p4_Q7w4jQ7z4oQ8U5QQ8X5[Q8Z5_Q9h=YQ9i=TQ9j=VQ9t7vQ9|8QQ:R8VQ:S8[Q:t=^Q:u=`Q:v=bQ:w=dQ:x9pQ:}9yQ;R:PQ;e=gQ;j;QQ;v;kQ;y=hQ=p>PQ=}>XQ>O>YQ>Z>]R>[>^Q+O%]Q.n<sR7g<tnpOXst!Z#d%m&r&t&u&w,s,x2[2_Q!fPS#fZ#oQ&|!`W'h!o*i0]4zQ(P#SQ)Q#{Q)r$nS,l&k&nQ,q&oQ-O&{S-T'T/nQ-g'bQ.x)OQ/[)sQ0s+]Q0y+gQ2W,pQ2y-iQ3a.gQ4W/VQ5U0lQ6Q1rQ6c2SQ6d2TQ6h2VQ6j2XQ6o2aQ7Z3dQ7m4TQ8s6TQ9P6eQ9Q6fQ9S6iQ9f7[Q:a8tR:k9T#[cOPXZst!Z!`!o#d#o#{%m&k&n&o&r&t&u&w&{'T'b)O*i+]+g,p,s,x-i.g/n0]0l1r2S2T2V2X2[2_2a3d4z6T6e6f6i7[8t9TQ#YWQ#eYQ%quQ%svS%uw!gS(S#W(VQ(Y#ZQ(t#uQ(y#xQ)R$OQ)S$PQ)T$QQ)U$RQ)V$SQ)W$TQ)X$UQ)Y$VQ)Z$WQ)[$XQ)^$ZQ)`$_Q)b$aQ)g$eW)q$n)s/V4TQ+d%tQ+x&RS-Z'X2pQ-x'rS-}(T.PQ.S(]Q.U(dQ.s(xQ.v(zQ.z<UQ.|<XQ.}<YQ/O<]Q/b)}Q0p+XQ2k-UQ2n-XQ3O-qQ3V.VQ3k.tQ3p<^Q3q<_Q3r<`Q3s<aQ3t<bQ3u<cQ3v<dQ3w<eQ3x<fQ3y<gQ3z<hQ3{.{Q3|<kQ4P<nQ4Q<{Q4X<iQ5X0rQ5c1SQ6u=OQ6{3QQ7Q3WQ7a3lQ7b=PQ7k=RQ7l=ZQ8k5wQ9X6sQ9]6|Q9g=[Q9m=eQ9n=fQ:o9_Q;W:ZQ;`:mQ<W#SR=v>SR#[WR'Z!el!tQ!r!v!y!z'`'l'm'n-e-u1o5{5}S'V!e-]U*j$|*Z*oS-Y'W'_S0U*k*qQ0^*rQ2u-cQ4v0[R4{0_R({#xQ!fQT-d'`-e]!qQ!r'`-e1o5{Q#p]R'i<VR)f$dY!uQ'`-e1o5{Q'k!rS'u!v!yS'w!z5}S-t'l'mQ-v'nR3T-uT#kZ%eS#jZ%eS%km,oU(g#h#i#lS.Y(h(iQ.^(jQ0t+^Q3Y.ZU3Z.[.]._S7S3[3]R9`7Td#^W#W#Z%h(T(^*Y+Z.T/mr#gZm#h#i#l%e(h(i(j+^.Z.[.]._3[3]7TS*]$x*bQ/t*^Q2U,oQ2l-VQ4`/pQ6q2dQ7s4aQ9W6rT=m'X+[V#aW%h*YU#`W%h*YS(U#W(^U(Z#Z+Z/mS-['X+[T.O(T.TV'^!e%i*ZQ$lfR)x$qT)m$l)nR4V/UT*_$x*bT*h${*YQ0w+fQ1g,VQ3_.fQ5t1iQ6P1qQ7X3cQ8r6SQ9c7WQ:^8qQ:p9bQ;Z:`Q;c:rQ;n;[R;q;dnqOXst!Z#d%m&r&t&u&w,s,x2[2_Q&l!VR,h&itmOXst!U!V!Z#d%m&i&r&t&u&w,s,x2[2_R,o&oT%lm,oR1k,XR,g&gQ&U|S+}&V&WR1^,OR+s&PT&p!W&sT&q!W&sT2^,x2_",nodeNames:"⚠ ArithOp ArithOp ?. JSXStartTag LineComment BlockComment Script Hashbang ExportDeclaration export Star as VariableName String Escape from ; default FunctionDeclaration async function VariableDefinition > < TypeParamList in out const TypeDefinition extends ThisType this LiteralType ArithOp Number BooleanLiteral TemplateType InterpolationEnd Interpolation InterpolationStart NullType null VoidType void TypeofType typeof MemberExpression . PropertyName [ TemplateString Escape Interpolation super RegExp ] ArrayExpression Spread , } { ObjectExpression Property async get set PropertyDefinition Block : NewTarget new NewExpression ) ( ArgList UnaryExpression delete LogicOp BitOp YieldExpression yield AwaitExpression await ParenthesizedExpression ClassExpression class ClassBody MethodDeclaration Decorator @ MemberExpression PrivatePropertyName CallExpression TypeArgList CompareOp < declare Privacy static abstract override PrivatePropertyDefinition PropertyDeclaration readonly accessor Optional TypeAnnotation Equals StaticBlock FunctionExpression ArrowFunction ParamList ParamList ArrayPattern ObjectPattern PatternProperty Privacy readonly Arrow MemberExpression BinaryExpression ArithOp ArithOp ArithOp ArithOp BitOp CompareOp instanceof satisfies CompareOp BitOp BitOp BitOp LogicOp LogicOp ConditionalExpression LogicOp LogicOp AssignmentExpression UpdateOp PostfixExpression CallExpression InstantiationExpression TaggedTemplateExpression DynamicImport import ImportMeta JSXElement JSXSelfCloseEndTag JSXSelfClosingTag JSXIdentifier JSXBuiltin JSXIdentifier JSXNamespacedName JSXMemberExpression JSXSpreadAttribute JSXAttribute JSXAttributeValue JSXEscape JSXEndTag JSXOpenTag JSXFragmentTag JSXText JSXEscape JSXStartCloseTag JSXCloseTag PrefixCast < ArrowFunction TypeParamList SequenceExpression InstantiationExpression KeyofType keyof UniqueType unique ImportType InferredType infer TypeName ParenthesizedType FunctionSignature ParamList NewSignature IndexedType TupleType Label ArrayType ReadonlyType ObjectType MethodType PropertyType IndexSignature PropertyDefinition CallSignature TypePredicate asserts is NewSignature new UnionType LogicOp IntersectionType LogicOp ConditionalType ParameterizedType ClassDeclaration abstract implements type VariableDeclaration let var using TypeAliasDeclaration InterfaceDeclaration interface EnumDeclaration enum EnumBody NamespaceDeclaration namespace module AmbientDeclaration declare GlobalDeclaration global ClassDeclaration ClassBody AmbientFunctionDeclaration ExportGroup VariableName VariableName ImportDeclaration defer ImportGroup ForStatement for ForSpec ForInSpec ForOfSpec of WhileStatement while WithStatement with DoStatement do IfStatement if else SwitchStatement switch SwitchBody CaseLabel case DefaultLabel TryStatement try CatchClause catch FinallyClause finally ReturnStatement return ThrowStatement throw BreakStatement break ContinueStatement continue DebuggerStatement debugger LabeledStatement ExpressionStatement SingleExpression SingleClassItem",maxTerm:380,context:bS,nodeProps:[["isolate",-8,5,6,14,37,39,51,53,55,""],["group",-26,9,17,19,68,207,211,215,216,218,221,224,234,237,243,245,247,249,252,258,264,266,268,270,272,274,275,"Statement",-34,13,14,32,35,36,42,51,54,55,57,62,70,72,76,80,82,84,85,110,111,120,121,136,139,141,142,143,144,145,147,148,167,169,171,"Expression",-23,31,33,37,41,43,45,173,175,177,178,180,181,182,184,185,186,188,189,190,201,203,205,206,"Type",-3,88,103,109,"ClassItem"],["openedBy",23,"<",38,"InterpolationStart",56,"[",60,"{",73,"(",160,"JSXStartCloseTag"],["closedBy",-2,24,168,">",40,"InterpolationEnd",50,"]",61,"}",74,")",165,"JSXEndTag"]],propSources:[xS],skippedNodes:[0,5,6,278],repeatNodeCount:37,tokenData:"$Fq07[R!bOX%ZXY+gYZ-yZ[+g[]%Z]^.c^p%Zpq+gqr/mrs3cst:_tuEruvJSvwLkwx! Yxy!'iyz!(sz{!)}{|!,q|}!.O}!O!,q!O!P!/Y!P!Q!9j!Q!R#:O!R![#<_![!]#I_!]!^#Jk!^!_#Ku!_!`$![!`!a$$v!a!b$*T!b!c$,r!c!}Er!}#O$-|#O#P$/W#P#Q$4o#Q#R$5y#R#SEr#S#T$7W#T#o$8b#o#p$<r#p#q$=h#q#r$>x#r#s$@U#s$f%Z$f$g+g$g#BYEr#BY#BZ$A`#BZ$ISEr$IS$I_$A`$I_$I|Er$I|$I}$Dk$I}$JO$Dk$JO$JTEr$JT$JU$A`$JU$KVEr$KV$KW$A`$KW&FUEr&FU&FV$A`&FV;'SEr;'S;=`I|<%l?HTEr?HT?HU$A`?HUOEr(n%d_$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z&j&hT$i&jO!^&c!_#o&c#p;'S&c;'S;=`&w<%lO&c&j&zP;=`<%l&c'|'U]$i&j(Z!bOY&}YZ&cZw&}wx&cx!^&}!^!_'}!_#O&}#O#P&c#P#o&}#o#p'}#p;'S&};'S;=`(l<%lO&}!b(SU(Z!bOY'}Zw'}x#O'}#P;'S'};'S;=`(f<%lO'}!b(iP;=`<%l'}'|(oP;=`<%l&}'[(y]$i&j(WpOY(rYZ&cZr(rrs&cs!^(r!^!_)r!_#O(r#O#P&c#P#o(r#o#p)r#p;'S(r;'S;=`*a<%lO(rp)wU(WpOY)rZr)rs#O)r#P;'S)r;'S;=`*Z<%lO)rp*^P;=`<%l)r'[*dP;=`<%l(r#S*nX(Wp(Z!bOY*gZr*grs'}sw*gwx)rx#O*g#P;'S*g;'S;=`+Z<%lO*g#S+^P;=`<%l*g(n+dP;=`<%l%Z07[+rq$i&j(Wp(Z!b'|0/lOX%ZXY+gYZ&cZ[+g[p%Zpq+gqr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p$f%Z$f$g+g$g#BY%Z#BY#BZ+g#BZ$IS%Z$IS$I_+g$I_$JT%Z$JT$JU+g$JU$KV%Z$KV$KW+g$KW&FU%Z&FU&FV+g&FV;'S%Z;'S;=`+a<%l?HT%Z?HT?HU+g?HUO%Z07[.ST(X#S$i&j'}0/lO!^&c!_#o&c#p;'S&c;'S;=`&w<%lO&c07[.n_$i&j(Wp(Z!b'}0/lOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z)3p/x`$i&j!p),Q(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`0z!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW1V`#v(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`2X!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW2d_#v(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'At3l_(V':f$i&j(Z!bOY4kYZ5qZr4krs7nsw4kwx5qx!^4k!^!_8p!_#O4k#O#P5q#P#o4k#o#p8p#p;'S4k;'S;=`:X<%lO4k(^4r_$i&j(Z!bOY4kYZ5qZr4krs7nsw4kwx5qx!^4k!^!_8p!_#O4k#O#P5q#P#o4k#o#p8p#p;'S4k;'S;=`:X<%lO4k&z5vX$i&jOr5qrs6cs!^5q!^!_6y!_#o5q#o#p6y#p;'S5q;'S;=`7h<%lO5q&z6jT$d`$i&jO!^&c!_#o&c#p;'S&c;'S;=`&w<%lO&c`6|TOr6yrs7]s;'S6y;'S;=`7b<%lO6y`7bO$d``7eP;=`<%l6y&z7kP;=`<%l5q(^7w]$d`$i&j(Z!bOY&}YZ&cZw&}wx&cx!^&}!^!_'}!_#O&}#O#P&c#P#o&}#o#p'}#p;'S&};'S;=`(l<%lO&}!r8uZ(Z!bOY8pYZ6yZr8prs9hsw8pwx6yx#O8p#O#P6y#P;'S8p;'S;=`:R<%lO8p!r9oU$d`(Z!bOY'}Zw'}x#O'}#P;'S'};'S;=`(f<%lO'}!r:UP;=`<%l8p(^:[P;=`<%l4k%9[:hh$i&j(Wp(Z!bOY%ZYZ&cZq%Zqr<Srs&}st%ZtuCruw%Zwx(rx!^%Z!^!_*g!_!c%Z!c!}Cr!}#O%Z#O#P&c#P#R%Z#R#SCr#S#T%Z#T#oCr#o#p*g#p$g%Z$g;'SCr;'S;=`El<%lOCr(r<__WS$i&j(Wp(Z!bOY<SYZ&cZr<Srs=^sw<Swx@nx!^<S!^!_Bm!_#O<S#O#P>`#P#o<S#o#pBm#p;'S<S;'S;=`Cl<%lO<S(Q=g]WS$i&j(Z!bOY=^YZ&cZw=^wx>`x!^=^!^!_?q!_#O=^#O#P>`#P#o=^#o#p?q#p;'S=^;'S;=`@h<%lO=^&n>gXWS$i&jOY>`YZ&cZ!^>`!^!_?S!_#o>`#o#p?S#p;'S>`;'S;=`?k<%lO>`S?XSWSOY?SZ;'S?S;'S;=`?e<%lO?SS?hP;=`<%l?S&n?nP;=`<%l>`!f?xWWS(Z!bOY?qZw?qwx?Sx#O?q#O#P?S#P;'S?q;'S;=`@b<%lO?q!f@eP;=`<%l?q(Q@kP;=`<%l=^'`@w]WS$i&j(WpOY@nYZ&cZr@nrs>`s!^@n!^!_Ap!_#O@n#O#P>`#P#o@n#o#pAp#p;'S@n;'S;=`Bg<%lO@ntAwWWS(WpOYApZrAprs?Ss#OAp#O#P?S#P;'SAp;'S;=`Ba<%lOAptBdP;=`<%lAp'`BjP;=`<%l@n#WBvYWS(Wp(Z!bOYBmZrBmrs?qswBmwxApx#OBm#O#P?S#P;'SBm;'S;=`Cf<%lOBm#WCiP;=`<%lBm(rCoP;=`<%l<S%9[C}i$i&j(o%1l(Wp(Z!bOY%ZYZ&cZr%Zrs&}st%ZtuCruw%Zwx(rx!Q%Z!Q![Cr![!^%Z!^!_*g!_!c%Z!c!}Cr!}#O%Z#O#P&c#P#R%Z#R#SCr#S#T%Z#T#oCr#o#p*g#p$g%Z$g;'SCr;'S;=`El<%lOCr%9[EoP;=`<%lCr07[FRk$i&j(Wp(Z!b$]#t(T,2j(e$I[OY%ZYZ&cZr%Zrs&}st%ZtuEruw%Zwx(rx}%Z}!OGv!O!Q%Z!Q![Er![!^%Z!^!_*g!_!c%Z!c!}Er!}#O%Z#O#P&c#P#R%Z#R#SEr#S#T%Z#T#oEr#o#p*g#p$g%Z$g;'SEr;'S;=`I|<%lOEr+dHRk$i&j(Wp(Z!b$]#tOY%ZYZ&cZr%Zrs&}st%ZtuGvuw%Zwx(rx}%Z}!OGv!O!Q%Z!Q![Gv![!^%Z!^!_*g!_!c%Z!c!}Gv!}#O%Z#O#P&c#P#R%Z#R#SGv#S#T%Z#T#oGv#o#p*g#p$g%Z$g;'SGv;'S;=`Iv<%lOGv+dIyP;=`<%lGv07[JPP;=`<%lEr(KWJ_`$i&j(Wp(Z!b#p(ChOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KWKl_$i&j$Q(Ch(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z,#xLva(z+JY$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sv%ZvwM{wx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KWNW`$i&j#z(Ch(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'At! c_(Y';W$i&j(WpOY!!bYZ!#hZr!!brs!#hsw!!bwx!$xx!^!!b!^!_!%z!_#O!!b#O#P!#h#P#o!!b#o#p!%z#p;'S!!b;'S;=`!'c<%lO!!b'l!!i_$i&j(WpOY!!bYZ!#hZr!!brs!#hsw!!bwx!$xx!^!!b!^!_!%z!_#O!!b#O#P!#h#P#o!!b#o#p!%z#p;'S!!b;'S;=`!'c<%lO!!b&z!#mX$i&jOw!#hwx6cx!^!#h!^!_!$Y!_#o!#h#o#p!$Y#p;'S!#h;'S;=`!$r<%lO!#h`!$]TOw!$Ywx7]x;'S!$Y;'S;=`!$l<%lO!$Y`!$oP;=`<%l!$Y&z!$uP;=`<%l!#h'l!%R]$d`$i&j(WpOY(rYZ&cZr(rrs&cs!^(r!^!_)r!_#O(r#O#P&c#P#o(r#o#p)r#p;'S(r;'S;=`*a<%lO(r!Q!&PZ(WpOY!%zYZ!$YZr!%zrs!$Ysw!%zwx!&rx#O!%z#O#P!$Y#P;'S!%z;'S;=`!']<%lO!%z!Q!&yU$d`(WpOY)rZr)rs#O)r#P;'S)r;'S;=`*Z<%lO)r!Q!'`P;=`<%l!%z'l!'fP;=`<%l!!b/5|!'t_!l/.^$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z#&U!)O_!k!Lf$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z-!n!*[b$i&j(Wp(Z!b(U%&f#q(ChOY%ZYZ&cZr%Zrs&}sw%Zwx(rxz%Zz{!+d{!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW!+o`$i&j(Wp(Z!b#n(ChOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z+;x!,|`$i&j(Wp(Z!br+4YOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z,$U!.Z_!]+Jf$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z07[!/ec$i&j(Wp(Z!b!Q.2^OY%ZYZ&cZr%Zrs&}sw%Zwx(rx!O%Z!O!P!0p!P!Q%Z!Q![!3Y![!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z#%|!0ya$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!O%Z!O!P!2O!P!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z#%|!2Z_![!L^$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad!3eg$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q![!3Y![!^%Z!^!_*g!_!g%Z!g!h!4|!h#O%Z#O#P&c#P#R%Z#R#S!3Y#S#X%Z#X#Y!4|#Y#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad!5Vg$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx{%Z{|!6n|}%Z}!O!6n!O!Q%Z!Q![!8S![!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S!8S#S#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad!6wc$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q![!8S![!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S!8S#S#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad!8_c$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q![!8S![!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S!8S#S#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z07[!9uf$i&j(Wp(Z!b#o(ChOY!;ZYZ&cZr!;Zrs!<nsw!;Zwx!Lcxz!;Zz{#-}{!P!;Z!P!Q#/d!Q!^!;Z!^!_#(i!_!`#7S!`!a#8i!a!}!;Z!}#O#,f#O#P!Dy#P#o!;Z#o#p#(i#p;'S!;Z;'S;=`#-w<%lO!;Z?O!;fb$i&j(Wp(Z!b!X7`OY!;ZYZ&cZr!;Zrs!<nsw!;Zwx!Lcx!P!;Z!P!Q#&`!Q!^!;Z!^!_#(i!_!}!;Z!}#O#,f#O#P!Dy#P#o!;Z#o#p#(i#p;'S!;Z;'S;=`#-w<%lO!;Z>^!<w`$i&j(Z!b!X7`OY!<nYZ&cZw!<nwx!=yx!P!<n!P!Q!Eq!Q!^!<n!^!_!Gr!_!}!<n!}#O!KS#O#P!Dy#P#o!<n#o#p!Gr#p;'S!<n;'S;=`!L]<%lO!<n<z!>Q^$i&j!X7`OY!=yYZ&cZ!P!=y!P!Q!>|!Q!^!=y!^!_!@c!_!}!=y!}#O!CW#O#P!Dy#P#o!=y#o#p!@c#p;'S!=y;'S;=`!Ek<%lO!=y<z!?Td$i&j!X7`O!^&c!_#W&c#W#X!>|#X#Z&c#Z#[!>|#[#]&c#]#^!>|#^#a&c#a#b!>|#b#g&c#g#h!>|#h#i&c#i#j!>|#j#k!>|#k#m&c#m#n!>|#n#o&c#p;'S&c;'S;=`&w<%lO&c7`!@hX!X7`OY!@cZ!P!@c!P!Q!AT!Q!}!@c!}#O!Ar#O#P!Bq#P;'S!@c;'S;=`!CQ<%lO!@c7`!AYW!X7`#W#X!AT#Z#[!AT#]#^!AT#a#b!AT#g#h!AT#i#j!AT#j#k!AT#m#n!AT7`!AuVOY!ArZ#O!Ar#O#P!B[#P#Q!@c#Q;'S!Ar;'S;=`!Bk<%lO!Ar7`!B_SOY!ArZ;'S!Ar;'S;=`!Bk<%lO!Ar7`!BnP;=`<%l!Ar7`!BtSOY!@cZ;'S!@c;'S;=`!CQ<%lO!@c7`!CTP;=`<%l!@c<z!C][$i&jOY!CWYZ&cZ!^!CW!^!_!Ar!_#O!CW#O#P!DR#P#Q!=y#Q#o!CW#o#p!Ar#p;'S!CW;'S;=`!Ds<%lO!CW<z!DWX$i&jOY!CWYZ&cZ!^!CW!^!_!Ar!_#o!CW#o#p!Ar#p;'S!CW;'S;=`!Ds<%lO!CW<z!DvP;=`<%l!CW<z!EOX$i&jOY!=yYZ&cZ!^!=y!^!_!@c!_#o!=y#o#p!@c#p;'S!=y;'S;=`!Ek<%lO!=y<z!EnP;=`<%l!=y>^!Ezl$i&j(Z!b!X7`OY&}YZ&cZw&}wx&cx!^&}!^!_'}!_#O&}#O#P&c#P#W&}#W#X!Eq#X#Z&}#Z#[!Eq#[#]&}#]#^!Eq#^#a&}#a#b!Eq#b#g&}#g#h!Eq#h#i&}#i#j!Eq#j#k!Eq#k#m&}#m#n!Eq#n#o&}#o#p'}#p;'S&};'S;=`(l<%lO&}8r!GyZ(Z!b!X7`OY!GrZw!Grwx!@cx!P!Gr!P!Q!Hl!Q!}!Gr!}#O!JU#O#P!Bq#P;'S!Gr;'S;=`!J|<%lO!Gr8r!Hse(Z!b!X7`OY'}Zw'}x#O'}#P#W'}#W#X!Hl#X#Z'}#Z#[!Hl#[#]'}#]#^!Hl#^#a'}#a#b!Hl#b#g'}#g#h!Hl#h#i'}#i#j!Hl#j#k!Hl#k#m'}#m#n!Hl#n;'S'};'S;=`(f<%lO'}8r!JZX(Z!bOY!JUZw!JUwx!Arx#O!JU#O#P!B[#P#Q!Gr#Q;'S!JU;'S;=`!Jv<%lO!JU8r!JyP;=`<%l!JU8r!KPP;=`<%l!Gr>^!KZ^$i&j(Z!bOY!KSYZ&cZw!KSwx!CWx!^!KS!^!_!JU!_#O!KS#O#P!DR#P#Q!<n#Q#o!KS#o#p!JU#p;'S!KS;'S;=`!LV<%lO!KS>^!LYP;=`<%l!KS>^!L`P;=`<%l!<n=l!Ll`$i&j(Wp!X7`OY!LcYZ&cZr!Lcrs!=ys!P!Lc!P!Q!Mn!Q!^!Lc!^!_# o!_!}!Lc!}#O#%P#O#P!Dy#P#o!Lc#o#p# o#p;'S!Lc;'S;=`#&Y<%lO!Lc=l!Mwl$i&j(Wp!X7`OY(rYZ&cZr(rrs&cs!^(r!^!_)r!_#O(r#O#P&c#P#W(r#W#X!Mn#X#Z(r#Z#[!Mn#[#](r#]#^!Mn#^#a(r#a#b!Mn#b#g(r#g#h!Mn#h#i(r#i#j!Mn#j#k!Mn#k#m(r#m#n!Mn#n#o(r#o#p)r#p;'S(r;'S;=`*a<%lO(r8Q# vZ(Wp!X7`OY# oZr# ors!@cs!P# o!P!Q#!i!Q!}# o!}#O#$R#O#P!Bq#P;'S# o;'S;=`#$y<%lO# o8Q#!pe(Wp!X7`OY)rZr)rs#O)r#P#W)r#W#X#!i#X#Z)r#Z#[#!i#[#])r#]#^#!i#^#a)r#a#b#!i#b#g)r#g#h#!i#h#i)r#i#j#!i#j#k#!i#k#m)r#m#n#!i#n;'S)r;'S;=`*Z<%lO)r8Q#$WX(WpOY#$RZr#$Rrs!Ars#O#$R#O#P!B[#P#Q# o#Q;'S#$R;'S;=`#$s<%lO#$R8Q#$vP;=`<%l#$R8Q#$|P;=`<%l# o=l#%W^$i&j(WpOY#%PYZ&cZr#%Prs!CWs!^#%P!^!_#$R!_#O#%P#O#P!DR#P#Q!Lc#Q#o#%P#o#p#$R#p;'S#%P;'S;=`#&S<%lO#%P=l#&VP;=`<%l#%P=l#&]P;=`<%l!Lc?O#&kn$i&j(Wp(Z!b!X7`OY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#W%Z#W#X#&`#X#Z%Z#Z#[#&`#[#]%Z#]#^#&`#^#a%Z#a#b#&`#b#g%Z#g#h#&`#h#i%Z#i#j#&`#j#k#&`#k#m%Z#m#n#&`#n#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z9d#(r](Wp(Z!b!X7`OY#(iZr#(irs!Grsw#(iwx# ox!P#(i!P!Q#)k!Q!}#(i!}#O#+`#O#P!Bq#P;'S#(i;'S;=`#,`<%lO#(i9d#)th(Wp(Z!b!X7`OY*gZr*grs'}sw*gwx)rx#O*g#P#W*g#W#X#)k#X#Z*g#Z#[#)k#[#]*g#]#^#)k#^#a*g#a#b#)k#b#g*g#g#h#)k#h#i*g#i#j#)k#j#k#)k#k#m*g#m#n#)k#n;'S*g;'S;=`+Z<%lO*g9d#+gZ(Wp(Z!bOY#+`Zr#+`rs!JUsw#+`wx#$Rx#O#+`#O#P!B[#P#Q#(i#Q;'S#+`;'S;=`#,Y<%lO#+`9d#,]P;=`<%l#+`9d#,cP;=`<%l#(i?O#,o`$i&j(Wp(Z!bOY#,fYZ&cZr#,frs!KSsw#,fwx#%Px!^#,f!^!_#+`!_#O#,f#O#P!DR#P#Q!;Z#Q#o#,f#o#p#+`#p;'S#,f;'S;=`#-q<%lO#,f?O#-tP;=`<%l#,f?O#-zP;=`<%l!;Z07[#.[b$i&j(Wp(Z!b(O0/l!X7`OY!;ZYZ&cZr!;Zrs!<nsw!;Zwx!Lcx!P!;Z!P!Q#&`!Q!^!;Z!^!_#(i!_!}!;Z!}#O#,f#O#P!Dy#P#o!;Z#o#p#(i#p;'S!;Z;'S;=`#-w<%lO!;Z07[#/o_$i&j(Wp(Z!bT0/lOY#/dYZ&cZr#/drs#0nsw#/dwx#4Ox!^#/d!^!_#5}!_#O#/d#O#P#1p#P#o#/d#o#p#5}#p;'S#/d;'S;=`#6|<%lO#/d06j#0w]$i&j(Z!bT0/lOY#0nYZ&cZw#0nwx#1px!^#0n!^!_#3R!_#O#0n#O#P#1p#P#o#0n#o#p#3R#p;'S#0n;'S;=`#3x<%lO#0n05W#1wX$i&jT0/lOY#1pYZ&cZ!^#1p!^!_#2d!_#o#1p#o#p#2d#p;'S#1p;'S;=`#2{<%lO#1p0/l#2iST0/lOY#2dZ;'S#2d;'S;=`#2u<%lO#2d0/l#2xP;=`<%l#2d05W#3OP;=`<%l#1p01O#3YW(Z!bT0/lOY#3RZw#3Rwx#2dx#O#3R#O#P#2d#P;'S#3R;'S;=`#3r<%lO#3R01O#3uP;=`<%l#3R06j#3{P;=`<%l#0n05x#4X]$i&j(WpT0/lOY#4OYZ&cZr#4Ors#1ps!^#4O!^!_#5Q!_#O#4O#O#P#1p#P#o#4O#o#p#5Q#p;'S#4O;'S;=`#5w<%lO#4O00^#5XW(WpT0/lOY#5QZr#5Qrs#2ds#O#5Q#O#P#2d#P;'S#5Q;'S;=`#5q<%lO#5Q00^#5tP;=`<%l#5Q05x#5zP;=`<%l#4O01p#6WY(Wp(Z!bT0/lOY#5}Zr#5}rs#3Rsw#5}wx#5Qx#O#5}#O#P#2d#P;'S#5};'S;=`#6v<%lO#5}01p#6yP;=`<%l#5}07[#7PP;=`<%l#/d)3h#7ab$i&j$Q(Ch(Wp(Z!b!X7`OY!;ZYZ&cZr!;Zrs!<nsw!;Zwx!Lcx!P!;Z!P!Q#&`!Q!^!;Z!^!_#(i!_!}!;Z!}#O#,f#O#P!Dy#P#o!;Z#o#p#(i#p;'S!;Z;'S;=`#-w<%lO!;ZAt#8vb$Z#t$i&j(Wp(Z!b!X7`OY!;ZYZ&cZr!;Zrs!<nsw!;Zwx!Lcx!P!;Z!P!Q#&`!Q!^!;Z!^!_#(i!_!}!;Z!}#O#,f#O#P!Dy#P#o!;Z#o#p#(i#p;'S!;Z;'S;=`#-w<%lO!;Z'Ad#:Zp$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!O%Z!O!P!3Y!P!Q%Z!Q![#<_![!^%Z!^!_*g!_!g%Z!g!h!4|!h#O%Z#O#P&c#P#R%Z#R#S#<_#S#U%Z#U#V#?i#V#X%Z#X#Y!4|#Y#b%Z#b#c#>_#c#d#Bq#d#l%Z#l#m#Es#m#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#<jk$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!O%Z!O!P!3Y!P!Q%Z!Q![#<_![!^%Z!^!_*g!_!g%Z!g!h!4|!h#O%Z#O#P&c#P#R%Z#R#S#<_#S#X%Z#X#Y!4|#Y#b%Z#b#c#>_#c#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#>j_$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#?rd$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q!R#AQ!R!S#AQ!S!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S#AQ#S#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#A]f$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q!R#AQ!R!S#AQ!S!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S#AQ#S#b%Z#b#c#>_#c#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#Bzc$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q!Y#DV!Y!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S#DV#S#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#Dbe$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q!Y#DV!Y!^%Z!^!_*g!_#O%Z#O#P&c#P#R%Z#R#S#DV#S#b%Z#b#c#>_#c#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#E|g$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q![#Ge![!^%Z!^!_*g!_!c%Z!c!i#Ge!i#O%Z#O#P&c#P#R%Z#R#S#Ge#S#T%Z#T#Z#Ge#Z#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z'Ad#Gpi$i&j(Wp(Z!bs'9tOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!Q%Z!Q![#Ge![!^%Z!^!_*g!_!c%Z!c!i#Ge!i#O%Z#O#P&c#P#R%Z#R#S#Ge#S#T%Z#T#Z#Ge#Z#b%Z#b#c#>_#c#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z*)x#Il_!g$b$i&j$O)Lv(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z)[#Jv_al$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z04f#LS^h#)`#R-<U(Wp(Z!b$n7`OY*gZr*grs'}sw*gwx)rx!P*g!P!Q#MO!Q!^*g!^!_#Mt!_!`$ f!`#O*g#P;'S*g;'S;=`+Z<%lO*g(n#MXX$k&j(Wp(Z!bOY*gZr*grs'}sw*gwx)rx#O*g#P;'S*g;'S;=`+Z<%lO*g(El#M}Z#r(Ch(Wp(Z!bOY*gZr*grs'}sw*gwx)rx!_*g!_!`#Np!`#O*g#P;'S*g;'S;=`+Z<%lO*g(El#NyX$Q(Ch(Wp(Z!bOY*gZr*grs'}sw*gwx)rx#O*g#P;'S*g;'S;=`+Z<%lO*g(El$ oX#s(Ch(Wp(Z!bOY*gZr*grs'}sw*gwx)rx#O*g#P;'S*g;'S;=`+Z<%lO*g*)x$!ga#`*!Y$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`0z!`!a$#l!a#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(K[$#w_#k(Cl$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z*)x$%Vag!*r#s(Ch$f#|$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`$&[!`!a$'f!a#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW$&g_#s(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW$'qa#r(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`!a$(v!a#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW$)R`#r(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(Kd$*`a(r(Ct$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!a%Z!a!b$+e!b#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW$+p`$i&j#{(Ch(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z%#`$,}_!|$Ip$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z04f$.X_!S0,v$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(n$/]Z$i&jO!^$0O!^!_$0f!_#i$0O#i#j$0k#j#l$0O#l#m$2^#m#o$0O#o#p$0f#p;'S$0O;'S;=`$4i<%lO$0O(n$0VT_#S$i&jO!^&c!_#o&c#p;'S&c;'S;=`&w<%lO&c#S$0kO_#S(n$0p[$i&jO!Q&c!Q![$1f![!^&c!_!c&c!c!i$1f!i#T&c#T#Z$1f#Z#o&c#o#p$3|#p;'S&c;'S;=`&w<%lO&c(n$1kZ$i&jO!Q&c!Q![$2^![!^&c!_!c&c!c!i$2^!i#T&c#T#Z$2^#Z#o&c#p;'S&c;'S;=`&w<%lO&c(n$2cZ$i&jO!Q&c!Q![$3U![!^&c!_!c&c!c!i$3U!i#T&c#T#Z$3U#Z#o&c#p;'S&c;'S;=`&w<%lO&c(n$3ZZ$i&jO!Q&c!Q![$0O![!^&c!_!c&c!c!i$0O!i#T&c#T#Z$0O#Z#o&c#p;'S&c;'S;=`&w<%lO&c#S$4PR!Q![$4Y!c!i$4Y#T#Z$4Y#S$4]S!Q![$4Y!c!i$4Y#T#Z$4Y#q#r$0f(n$4lP;=`<%l$0O#1[$4z_!Y#)l$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z(KW$6U`#x(Ch$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z+;p$7c_$i&j(Wp(Z!b(a+4QOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z07[$8qk$i&j(Wp(Z!b(T,2j$_#t(e$I[OY%ZYZ&cZr%Zrs&}st%Ztu$8buw%Zwx(rx}%Z}!O$:f!O!Q%Z!Q![$8b![!^%Z!^!_*g!_!c%Z!c!}$8b!}#O%Z#O#P&c#P#R%Z#R#S$8b#S#T%Z#T#o$8b#o#p*g#p$g%Z$g;'S$8b;'S;=`$<l<%lO$8b+d$:qk$i&j(Wp(Z!b$_#tOY%ZYZ&cZr%Zrs&}st%Ztu$:fuw%Zwx(rx}%Z}!O$:f!O!Q%Z!Q![$:f![!^%Z!^!_*g!_!c%Z!c!}$:f!}#O%Z#O#P&c#P#R%Z#R#S$:f#S#T%Z#T#o$:f#o#p*g#p$g%Z$g;'S$:f;'S;=`$<f<%lO$:f+d$<iP;=`<%l$:f07[$<oP;=`<%l$8b#Jf$<{X!_#Hb(Wp(Z!bOY*gZr*grs'}sw*gwx)rx#O*g#P;'S*g;'S;=`+Z<%lO*g,#x$=sa(y+JY$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_!`Ka!`#O%Z#O#P&c#P#o%Z#o#p*g#p#q$+e#q;'S%Z;'S;=`+a<%lO%Z)>v$?V_!^(CdvBr$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z?O$@a_!q7`$i&j(Wp(Z!bOY%ZYZ&cZr%Zrs&}sw%Zwx(rx!^%Z!^!_*g!_#O%Z#O#P&c#P#o%Z#o#p*g#p;'S%Z;'S;=`+a<%lO%Z07[$Aq|$i&j(Wp(Z!b'|0/l$]#t(T,2j(e$I[OX%ZXY+gYZ&cZ[+g[p%Zpq+gqr%Zrs&}st%ZtuEruw%Zwx(rx}%Z}!OGv!O!Q%Z!Q![Er![!^%Z!^!_*g!_!c%Z!c!}Er!}#O%Z#O#P&c#P#R%Z#R#SEr#S#T%Z#T#oEr#o#p*g#p$f%Z$f$g+g$g#BYEr#BY#BZ$A`#BZ$ISEr$IS$I_$A`$I_$JTEr$JT$JU$A`$JU$KVEr$KV$KW$A`$KW&FUEr&FU&FV$A`&FV;'SEr;'S;=`I|<%l?HTEr?HT?HU$A`?HUOEr07[$D|k$i&j(Wp(Z!b'}0/l$]#t(T,2j(e$I[OY%ZYZ&cZr%Zrs&}st%ZtuEruw%Zwx(rx}%Z}!OGv!O!Q%Z!Q![Er![!^%Z!^!_*g!_!c%Z!c!}Er!}#O%Z#O#P&c#P#R%Z#R#SEr#S#T%Z#T#oEr#o#p*g#p$g%Z$g;'SEr;'S;=`I|<%lOEr",tokenizers:[wS,PS,SS,kS,2,3,4,5,6,7,8,9,10,11,12,13,14,vS,new Sc("$S~RRtu[#O#Pg#S#T#|~_P#o#pb~gOx~~jVO#i!P#i#j!U#j#l!P#l#m!q#m;'S!P;'S;=`#v<%lO!P~!UO!U~~!XS!Q![!e!c!i!e#T#Z!e#o#p#Z~!hR!Q![!q!c!i!q#T#Z!q~!tR!Q![!}!c!i!}#T#Z!}~#QR!Q![!P!c!i!P#T#Z!P~#^R!Q![#g!c!i#g#T#Z#g~#jS!Q![#g!c!i#g#T#Z#g#q#r!P~#yP;=`<%l!P~$RO(c~~",141,340),new Sc("j~RQYZXz{^~^O(Q~~aP!P!Qd~iO(R~~",25,323)],topRules:{Script:[0,7],SingleExpression:[1,276],SingleClassItem:[2,277]},dialects:{jsx:0,ts:15175},dynamicPrecedences:{80:1,82:1,94:1,169:1,199:1},specialized:[{term:327,get:i=>$S[i]||-1},{term:343,get:i=>MS[i]||-1},{term:95,get:i=>CS[i]||-1}],tokenPrec:15201});var Ja;const Oi=new $e;function mg(i){return he.define({combine:i?e=>e.concat(i):void 0})}const Sd=new $e;class Cn{constructor(e,t,n=[],s=""){this.data=e,this.name=s,ze.prototype.hasOwnProperty("tree")||Object.defineProperty(ze.prototype,"tree",{get(){return Pt(this)}}),this.parser=t,this.extension=[Ms.of(this),ze.languageData.of((r,o,a)=>{let l=Mh(r,o,a),d=l.type.prop(Oi);if(!d)return[];let c=r.facet(d),u=l.type.prop(Sd);if(u){let h=l.resolve(o-l.from,a);for(let f of u)if(f.test(h,r)){let m=r.facet(f.facet);return f.type=="replace"?m:m.concat(c)}}return c})].concat(n)}isActiveAt(e,t,n=-1){return Mh(e,t,n).type.prop(Oi)==this.data}findRegions(e){let t=e.facet(Ms);if((t==null?void 0:t.data)==this.data)return[{from:0,to:e.doc.length}];if(!t||!t.allowsNesting)return[];let n=[],s=(r,o)=>{if(r.prop(Oi)==this.data){n.push({from:o,to:o+r.length});return}let a=r.prop($e.mounted);if(a){if(a.tree.prop(Oi)==this.data){if(a.overlay)for(let l of a.overlay)n.push({from:l.from+o,to:l.to+o});else n.push({from:o,to:o+r.length});return}else if(a.overlay){let l=n.length;if(s(a.tree,a.overlay[0].from+o),n.length>l)return}}for(let l=0;l<r.children.length;l++){let d=r.children[l];d instanceof pt&&s(d,r.positions[l]+o)}};return s(Pt(e),0),n}get allowsNesting(){return!0}}Cn.setState=Ve.define();function Mh(i,e,t){let n=i.facet(Ms),s=Pt(i).topNode;if(!n||n.allowsNesting)for(let r=s;r;r=r.enter(e,t,yt.ExcludeBuffers))r.type.isTop&&(s=r);return s}class jo extends Cn{constructor(e,t,n){super(e,t,[],n),this.parser=t}static define(e){let t=mg(e.languageData);return new jo(t,e.parser.configure({props:[Oi.add(n=>n.isTop?t:void 0)]}),e.name)}configure(e,t){return new jo(this.data,this.parser.configure(e),t||this.name)}get allowsNesting(){return this.parser.hasWrappers()}}function Pt(i){let e=i.field(Cn.state,!1);return e?e.tree:pt.empty}class AS{constructor(e){this.doc=e,this.cursorPos=0,this.string="",this.cursor=e.iter()}get length(){return this.doc.length}syncTo(e){return this.string=this.cursor.next(e-this.cursorPos).value,this.cursorPos=e+this.string.length,this.cursorPos-this.string.length}chunk(e){return this.syncTo(e),this.string}get lineChunks(){return!0}read(e,t){let n=this.cursorPos-this.string.length;return e<n||t>=this.cursorPos?this.doc.sliceString(e,t):this.string.slice(e-n,t-n)}}let Gi=null;class Fo{constructor(e,t,n=[],s,r,o,a,l){this.parser=e,this.state=t,this.fragments=n,this.tree=s,this.treeLen=r,this.viewport=o,this.skipped=a,this.scheduleOn=l,this.parse=null,this.tempSkipped=[]}static create(e,t,n){return new Fo(e,t,[],pt.empty,0,n,[],null)}startParse(){return this.parser.startParse(new AS(this.state.doc),this.fragments)}work(e,t){return t!=null&&t>=this.state.doc.length&&(t=void 0),this.tree!=pt.empty&&this.isDone(t??this.state.doc.length)?(this.takeTree(),!0):this.withContext(()=>{var n;if(typeof e=="number"){let s=Date.now()+e;e=()=>Date.now()>s}for(this.parse||(this.parse=this.startParse()),t!=null&&(this.parse.stoppedAt==null||this.parse.stoppedAt>t)&&t<this.state.doc.length&&this.parse.stopAt(t);;){let s=this.parse.advance();if(s)if(this.fragments=this.withoutTempSkipped(Fs.addTree(s,this.fragments,this.parse.stoppedAt!=null)),this.treeLen=(n=this.parse.stoppedAt)!==null&&n!==void 0?n:this.state.doc.length,this.tree=s,this.parse=null,this.treeLen<(t??this.state.doc.length))this.parse=this.startParse();else return!0;if(e())return!1}})}takeTree(){let e,t;this.parse&&(e=this.parse.parsedPos)>=this.treeLen&&((this.parse.stoppedAt==null||this.parse.stoppedAt>e)&&this.parse.stopAt(e),this.withContext(()=>{for(;!(t=this.parse.advance()););}),this.treeLen=e,this.tree=t,this.fragments=this.withoutTempSkipped(Fs.addTree(this.tree,this.fragments,!0)),this.parse=null)}withContext(e){let t=Gi;Gi=this;try{return e()}finally{Gi=t}}withoutTempSkipped(e){for(let t;t=this.tempSkipped.pop();)e=Ch(e,t.from,t.to);return e}changes(e,t){let{fragments:n,tree:s,treeLen:r,viewport:o,skipped:a}=this;if(this.takeTree(),!e.empty){let l=[];if(e.iterChangedRanges((d,c,u,h)=>l.push({fromA:d,toA:c,fromB:u,toB:h})),n=Fs.applyChanges(n,l),s=pt.empty,r=0,o={from:e.mapPos(o.from,-1),to:e.mapPos(o.to,1)},this.skipped.length){a=[];for(let d of this.skipped){let c=e.mapPos(d.from,1),u=e.mapPos(d.to,-1);c<u&&a.push({from:c,to:u})}}}return new Fo(this.parser,t,n,s,r,o,a,this.scheduleOn)}updateViewport(e){if(this.viewport.from==e.from&&this.viewport.to==e.to)return!1;this.viewport=e;let t=this.skipped.length;for(let n=0;n<this.skipped.length;n++){let{from:s,to:r}=this.skipped[n];s<e.to&&r>e.from&&(this.fragments=Ch(this.fragments,s,r),this.skipped.splice(n--,1))}return this.skipped.length>=t?!1:(this.reset(),!0)}reset(){this.parse&&(this.takeTree(),this.parse=null)}skipUntilInView(e,t){this.skipped.push({from:e,to:t})}static getSkippingParser(e){return new class extends lg{createParse(t,n,s){let r=s[0].from,o=s[s.length-1].to;return{parsedPos:r,advance(){let l=Gi;if(l){for(let d of s)l.tempSkipped.push(d);e&&(l.scheduleOn=l.scheduleOn?Promise.all([l.scheduleOn,e]):e)}return this.parsedPos=o,new pt(rn.none,[],[],o-r)},stoppedAt:null,stopAt(){}}}}}isDone(e){e=Math.min(e,this.state.doc.length);let t=this.fragments;return this.treeLen>=e&&t.length&&t[0].from==0&&t[0].to>=e}static get(){return Gi}}function Ch(i,e,t){return Fs.applyChanges(i,[{fromA:e,toA:t,fromB:e,toB:t}])}class Mi{constructor(e){this.context=e,this.tree=e.tree}apply(e){if(!e.docChanged&&this.tree==this.context.tree)return this;let t=this.context.changes(e.changes,e.state),n=this.context.treeLen==e.startState.doc.length?void 0:Math.max(e.changes.mapPos(this.context.treeLen),t.viewport.to);return t.work(20,n)||t.takeTree(),new Mi(t)}static init(e){let t=Math.min(3e3,e.doc.length),n=Fo.create(e.facet(Ms).parser,e,{from:0,to:t});return n.work(20,t)||n.takeTree(),new Mi(n)}}Cn.state=mn.define({create:Mi.init,update(i,e){for(let t of e.effects)if(t.is(Cn.setState))return t.value;return e.startState.facet(Ms)!=e.state.facet(Ms)?Mi.init(e.state):i.apply(e)}});let pg=i=>{let e=setTimeout(()=>i(),500);return()=>clearTimeout(e)};typeof requestIdleCallback<"u"&&(pg=i=>{let e=-1,t=setTimeout(()=>{e=requestIdleCallback(i,{timeout:400})},100);return()=>e<0?clearTimeout(t):cancelIdleCallback(e)});const el=typeof navigator<"u"&&(!((Ja=navigator.scheduling)===null||Ja===void 0)&&Ja.isInputPending)?()=>navigator.scheduling.isInputPending():null,TS=ts.fromClass(class{constructor(e){this.view=e,this.working=null,this.workScheduled=0,this.chunkEnd=-1,this.chunkBudget=-1,this.work=this.work.bind(this),this.scheduleWork()}update(e){let t=this.view.state.field(Cn.state).context;(t.updateViewport(e.view.viewport)||this.view.viewport.to>t.treeLen)&&this.scheduleWork(),(e.docChanged||e.selectionSet)&&(this.view.hasFocus&&(this.chunkBudget+=50),this.scheduleWork()),this.checkAsyncSchedule(t)}scheduleWork(){if(this.working)return;let{state:e}=this.view,t=e.field(Cn.state);(t.tree!=t.context.tree||!t.context.isDone(e.doc.length))&&(this.working=pg(this.work))}work(e){this.working=null;let t=Date.now();if(this.chunkEnd<t&&(this.chunkEnd<0||this.view.hasFocus)&&(this.chunkEnd=t+3e4,this.chunkBudget=3e3),this.chunkBudget<=0)return;let{state:n,viewport:{to:s}}=this.view,r=n.field(Cn.state);if(r.tree==r.context.tree&&r.context.isDone(s+1e5))return;let o=Date.now()+Math.min(this.chunkBudget,100,e&&!el?Math.max(25,e.timeRemaining()-5):1e9),a=r.context.treeLen<s&&n.doc.length>s+1e3,l=r.context.work(()=>el&&el()||Date.now()>o,s+(a?0:1e5));this.chunkBudget-=Date.now()-t,(l||this.chunkBudget<=0)&&(r.context.takeTree(),this.view.dispatch({effects:Cn.setState.of(new Mi(r.context))})),this.chunkBudget>0&&!(l&&!a)&&this.scheduleWork(),this.checkAsyncSchedule(r.context)}checkAsyncSchedule(e){e.scheduleOn&&(this.workScheduled++,e.scheduleOn.then(()=>this.scheduleWork()).catch(t=>Gn(this.view.state,t)).then(()=>this.workScheduled--),e.scheduleOn=null)}destroy(){this.working&&this.working()}isWorking(){return!!(this.working||this.workScheduled>0)}},{eventHandlers:{focus(){this.scheduleWork()}}}),Ms=he.define({combine(i){return i.length?i[0]:null},enables:i=>[Cn.state,TS,de.contentAttributes.compute([i],e=>{let t=e.facet(i);return t&&t.name?{"data-language":t.name}:{}})]});class NS{constructor(e,t=[]){this.language=e,this.support=t,this.extension=[e,t]}}const QS=he.define(),fa=he.define({combine:i=>{if(!i.length)return"  ";let e=i[0];if(!e||/\S/.test(e)||Array.from(e).some(t=>t!=e[0]))throw new Error("Invalid indent unit: "+JSON.stringify(i[0]));return e}});function Go(i){let e=i.facet(fa);return e.charCodeAt(0)==9?i.tabSize*e.length:e.length}function Xo(i,e){let t="",n=i.tabSize,s=i.facet(fa)[0];if(s=="	"){for(;e>=n;)t+="	",e-=n;s=" "}for(let r=0;r<e;r++)t+=s;return t}function gg(i,e){i instanceof ze&&(i=new ma(i));for(let n of i.state.facet(QS)){let s=n(i,e);if(s!==void 0)return s}let t=Pt(i.state);return t.length>=e?RS(i,t,e):null}class ma{constructor(e,t={}){this.state=e,this.options=t,this.unit=Go(e)}lineAt(e,t=1){let n=this.state.doc.lineAt(e),{simulateBreak:s,simulateDoubleBreak:r}=this.options;return s!=null&&s>=n.from&&s<=n.to?r&&s==e?{text:"",from:e}:(t<0?s<e:s<=e)?{text:n.text.slice(s-n.from),from:s}:{text:n.text.slice(0,s-n.from),from:n.from}:n}textAfterPos(e,t=1){if(this.options.simulateDoubleBreak&&e==this.options.simulateBreak)return"";let{text:n,from:s}=this.lineAt(e,t);return n.slice(e-s,Math.min(n.length,e+100-s))}column(e,t=1){let{text:n,from:s}=this.lineAt(e,t),r=this.countColumn(n,e-s),o=this.options.overrideIndentation?this.options.overrideIndentation(s):-1;return o>-1&&(r+=o-this.countColumn(n,n.search(/\S|$/))),r}countColumn(e,t=e.length){return ca(e,this.state.tabSize,t)}lineIndent(e,t=1){let{text:n,from:s}=this.lineAt(e,t),r=this.options.overrideIndentation;if(r){let o=r(s);if(o>-1)return o}return this.countColumn(n,n.search(/\S|$/))}get simulatedBreak(){return this.options.simulateBreak||null}}const Og=new $e;function RS(i,e,t){let n=e.resolveStack(t),s=e.resolveInner(t,-1).resolve(t,0).enterUnfinishedNodesBefore(t);if(s!=n.node){let r=[];for(let o=s;o&&!(o.from<n.node.from||o.to>n.node.to||o.from==n.node.from&&o.type==n.node.type);o=o.parent)r.push(o);for(let o=r.length-1;o>=0;o--)n={node:r[o],next:n}}return yg(n,i,t)}function yg(i,e,t){for(let n=i;n;n=n.next){let s=IS(n.node);if(s)return s(kd.create(e,t,n))}return 0}function _S(i){return i.pos==i.options.simulateBreak&&i.options.simulateDoubleBreak}function IS(i){let e=i.type.prop(Og);if(e)return e;let t=i.firstChild,n;if(t&&(n=t.type.prop($e.closedBy))){let s=i.lastChild,r=s&&n.indexOf(s.name)>-1;return o=>bg(o,!0,1,void 0,r&&!_S(o)?s.from:void 0)}return i.parent==null?LS:null}function LS(){return 0}class kd extends ma{constructor(e,t,n){super(e.state,e.options),this.base=e,this.pos=t,this.context=n}get node(){return this.context.node}static create(e,t,n){return new kd(e,t,n)}get textAfter(){return this.textAfterPos(this.pos)}get baseIndent(){return this.baseIndentFor(this.node)}baseIndentFor(e){let t=this.state.doc.lineAt(e.from);for(;;){let n=e.resolve(t.from);for(;n.parent&&n.parent.from==n.from;)n=n.parent;if(BS(n,e))break;t=this.state.doc.lineAt(n.from)}return this.lineIndent(t.from)}continue(){return yg(this.context.next,this.base,this.pos)}}function BS(i,e){for(let t=e;t;t=t.parent)if(i==t)return!0;return!1}function DS(i){let e=i.node,t=e.childAfter(e.from),n=e.lastChild;if(!t)return null;let s=i.options.simulateBreak,r=i.state.doc.lineAt(t.from),o=s==null||s<=r.from?r.to:Math.min(r.to,s);for(let a=t.to;;){let l=e.childAfter(a);if(!l||l==n)return null;if(!l.type.isSkipped){if(l.from>=o)return null;let d=/^ */.exec(r.text.slice(t.to-r.from))[0].length;return{from:t.from,to:t.to+d}}a=l.to}}function zS({closing:i,align:e=!0,units:t=1}){return n=>bg(n,e,t,i)}function bg(i,e,t,n,s){let r=i.textAfter,o=r.match(/^\s*/)[0].length,a=n&&r.slice(o,o+n.length)==n||s==i.pos+o,l=e?DS(i):null;return l?a?i.column(l.from):i.column(l.to):i.baseIndent+(a?0:i.unit*t)}const VS=i=>i.baseIndent;function tl({except:i,units:e=1}={}){return t=>{let n=i&&i.test(t.textAfter);return t.baseIndent+(n?0:e*t.unit)}}const ZS=he.define(),vg=new $e;function jS(i){let e=i.firstChild,t=i.lastChild;return e&&e.to<t.from?{from:e.to,to:t.type.isError?i.to:t.from}:null}function FS(i,e,t){let n=Pt(i);if(n.length<t)return null;let s=n.resolveStack(t,1),r=null;for(let o=s;o;o=o.next){let a=o.node;if(a.to<=t||a.from>t)continue;if(r&&a.from<e)break;let l=a.type.prop(vg);if(l&&(a.to<n.length-50||n.length==i.doc.length||!GS(a))){let d=l(a,i);d&&d.from<=t&&d.from>=e&&d.to>t&&(r=d)}}return r}function GS(i){let e=i.lastChild;return e&&e.to==i.to&&e.type.isError}function Uo(i,e,t){for(let n of i.facet(ZS)){let s=n(i,e,t);if(s)return s}return FS(i,e,t)}function wg(i,e){let t=e.mapPos(i.from,1),n=e.mapPos(i.to,-1);return t>=n?void 0:{from:t,to:n}}const pa=Ve.define({map:wg}),Tr=Ve.define({map:wg});function Pg(i){let e=[];for(let{head:t}of i.state.selection.ranges)e.some(n=>n.from<=t&&n.to>=t)||e.push(i.lineBlockAt(t));return e}const Ks=mn.define({create(){return ke.none},update(i,e){e.isUserEvent("delete")&&e.changes.iterChangedRanges((t,n)=>i=Eh(i,t,n)),i=i.map(e.changes);for(let t of e.effects)if(t.is(pa)&&!XS(i,t.value.from,t.value.to)){let{preparePlaceholder:n}=e.state.facet(xg),s=n?ke.replace({widget:new JS(n(e.state,t.value))}):Ah;i=i.update({add:[s.range(t.value.from,t.value.to)]})}else t.is(Tr)&&(i=i.update({filter:(n,s)=>t.value.from!=n||t.value.to!=s,filterFrom:t.value.from,filterTo:t.value.to}));return e.selection&&(i=Eh(i,e.selection.main.head)),i},provide:i=>de.decorations.from(i),toJSON(i,e){let t=[];return i.between(0,e.doc.length,(n,s)=>{t.push(n,s)}),t},fromJSON(i){if(!Array.isArray(i)||i.length%2)throw new RangeError("Invalid JSON for fold state");let e=[];for(let t=0;t<i.length;){let n=i[t++],s=i[t++];if(typeof n!="number"||typeof s!="number")throw new RangeError("Invalid JSON for fold state");e.push(Ah.range(n,s))}return ke.set(e,!0)}});function Eh(i,e,t=e){let n=!1;return i.between(e,t,(s,r)=>{s<t&&r>e&&(n=!0)}),n?i.update({filterFrom:e,filterTo:t,filter:(s,r)=>s>=t||r<=e}):i}function Wo(i,e,t){var n;let s=null;return(n=i.field(Ks,!1))===null||n===void 0||n.between(e,t,(r,o)=>{(!s||s.from>r)&&(s={from:r,to:o})}),s}function XS(i,e,t){let n=!1;return i.between(e,e,(s,r)=>{s==e&&r==t&&(n=!0)}),n}function Sg(i,e){return i.field(Ks,!1)?e:e.concat(Ve.appendConfig.of($g()))}const US=i=>{for(let e of Pg(i)){let t=Uo(i.state,e.from,e.to);if(t)return i.dispatch({effects:Sg(i.state,[pa.of(t),kg(i,t)])}),!0}return!1},WS=i=>{if(!i.state.field(Ks,!1))return!1;let e=[];for(let t of Pg(i)){let n=Wo(i.state,t.from,t.to);n&&e.push(Tr.of(n),kg(i,n,!1))}return e.length&&i.dispatch({effects:e}),e.length>0};function kg(i,e,t=!0){let n=i.state.doc.lineAt(e.from).number,s=i.state.doc.lineAt(e.to).number;return de.announce.of(`${i.state.phrase(t?"Folded lines":"Unfolded lines")} ${n} ${i.state.phrase("to")} ${s}.`)}const qS=i=>{let{state:e}=i,t=[];for(let n=0;n<e.doc.length;){let s=i.lineBlockAt(n),r=Uo(e,s.from,s.to);r&&t.push(pa.of(r)),n=(r?i.lineBlockAt(r.to):s).to+1}return t.length&&i.dispatch({effects:Sg(i.state,t)}),!!t.length},HS=i=>{let e=i.state.field(Ks,!1);if(!e||!e.size)return!1;let t=[];return e.between(0,i.state.doc.length,(n,s)=>{t.push(Tr.of({from:n,to:s}))}),i.dispatch({effects:t}),!0},YS=[{key:"Ctrl-Shift-[",mac:"Cmd-Alt-[",run:US},{key:"Ctrl-Shift-]",mac:"Cmd-Alt-]",run:WS},{key:"Ctrl-Alt-[",run:qS},{key:"Ctrl-Alt-]",run:HS}],KS={placeholderDOM:null,preparePlaceholder:null,placeholderText:"…"},xg=he.define({combine(i){return $r(i,KS)}});function $g(i){return[Ks,nk]}function Mg(i,e){let{state:t}=i,n=t.facet(xg),s=o=>{let a=i.lineBlockAt(i.posAtDOM(o.target)),l=Wo(i.state,a.from,a.to);l&&i.dispatch({effects:Tr.of(l)}),o.preventDefault()};if(n.placeholderDOM)return n.placeholderDOM(i,s,e);let r=document.createElement("span");return r.textContent=n.placeholderText,r.setAttribute("aria-label",t.phrase("folded code")),r.title=t.phrase("unfold"),r.className="cm-foldPlaceholder",r.onclick=s,r}const Ah=ke.replace({widget:new class extends Ai{toDOM(i){return Mg(i,null)}}});class JS extends Ai{constructor(e){super(),this.value=e}eq(e){return this.value==e.value}toDOM(e){return Mg(e,this.value)}}const ek={openText:"⌄",closedText:"›",markerDOM:null,domEventHandlers:{},foldingChanged:()=>!1};class nl extends xs{constructor(e,t){super(),this.config=e,this.open=t}eq(e){return this.config==e.config&&this.open==e.open}toDOM(e){if(this.config.markerDOM)return this.config.markerDOM(this.open);let t=document.createElement("span");return t.textContent=this.open?this.config.openText:this.config.closedText,t.title=e.state.phrase(this.open?"Fold line":"Unfold line"),t}}function tk(i={}){let e={...ek,...i},t=new nl(e,!0),n=new nl(e,!1),s=ts.fromClass(class{constructor(o){this.from=o.viewport.from,this.markers=this.buildMarkers(o)}update(o){(o.docChanged||o.viewportChanged||o.startState.facet(Ms)!=o.state.facet(Ms)||o.startState.field(Ks,!1)!=o.state.field(Ks,!1)||Pt(o.startState)!=Pt(o.state)||e.foldingChanged(o))&&(this.markers=this.buildMarkers(o.view))}buildMarkers(o){let a=new Si;for(let l of o.viewportLineBlocks){let d=Wo(o.state,l.from,l.to)?n:Uo(o.state,l.from,l.to)?t:null;d&&a.add(l.from,l.from,d)}return a.finish()}}),{domEventHandlers:r}=e;return[s,wP({class:"cm-foldGutter",markers(o){var a;return((a=o.plugin(s))===null||a===void 0?void 0:a.markers)||_e.empty},initialSpacer(){return new nl(e,!1)},domEventHandlers:{...r,click:(o,a,l)=>{if(r.click&&r.click(o,a,l))return!0;let d=Wo(o.state,a.from,a.to);if(d)return o.dispatch({effects:Tr.of(d)}),!0;let c=Uo(o.state,a.from,a.to);return c?(o.dispatch({effects:pa.of(c)}),!0):!1}}}),$g()]}const nk=de.baseTheme({".cm-foldPlaceholder":{backgroundColor:"#eee",border:"1px solid #ddd",color:"#888",borderRadius:".2em",margin:"0 1px",padding:"0 1px",cursor:"pointer"},".cm-foldGutter span":{padding:"0 1px",cursor:"pointer"}});class ga{constructor(e,t){this.specs=e;let n;function s(a){let l=Ps.newName();return(n||(n=Object.create(null)))["."+l]=a,l}const r=typeof t.all=="string"?t.all:t.all?s(t.all):void 0,o=t.scope;this.scope=o instanceof Cn?a=>a.prop(Oi)==o.data:o?a=>a==o:void 0,this.style=hg(e.map(a=>({tag:a.tag,class:a.class||s(Object.assign({},a,{tag:null}))})),{all:r}).style,this.module=n?new Ps(n):null,this.themeType=t.themeType}static define(e,t){return new ga(e,t||{})}}const Mc=he.define(),sk=he.define({combine(i){return i.length?[i[0]]:null}});function sl(i){let e=i.facet(Mc);return e.length?e:i.facet(sk)}function ik(i,e){let t=[ok],n;return i instanceof ga&&(i.module&&t.push(de.styleModule.of(i.module)),n=i.themeType),n?t.push(Mc.computeN([de.darkTheme],s=>s.facet(de.darkTheme)==(n=="dark")?[i]:[])):t.push(Mc.of(i)),t}class rk{constructor(e){this.markCache=Object.create(null),this.tree=Pt(e.state),this.decorations=this.buildDeco(e,sl(e.state)),this.decoratedTo=e.viewport.to}update(e){let t=Pt(e.state),n=sl(e.state),s=n!=sl(e.startState),{viewport:r}=e.view,o=e.changes.mapPos(this.decoratedTo,1);t.length<r.to&&!s&&t.type==this.tree.type&&o>=r.to?(this.decorations=this.decorations.map(e.changes),this.decoratedTo=o):(t!=this.tree||e.viewportChanged||s)&&(this.tree=t,this.decorations=this.buildDeco(e.view,n),this.decoratedTo=r.to)}buildDeco(e,t){if(!t||!this.tree.length)return ke.none;let n=new Si;for(let{from:s,to:r}of e.visibleRanges)HP(this.tree,t,(o,a,l)=>{n.add(o,a,this.markCache[l]||(this.markCache[l]=ke.mark({class:l})))},s,r);return n.finish()}}const ok=aa.high(ts.fromClass(rk,{decorations:i=>i.decorations})),ak=de.baseTheme({"&.cm-focused .cm-matchingBracket":{backgroundColor:"#328c8252"},"&.cm-focused .cm-nonmatchingBracket":{backgroundColor:"#bb555544"}}),Cg=1e4,Eg="()[]{}",Ag=he.define({combine(i){return $r(i,{afterCursor:!0,brackets:Eg,maxScanDistance:Cg,renderMatch:dk})}}),lk=ke.mark({class:"cm-matchingBracket"}),ck=ke.mark({class:"cm-nonmatchingBracket"});function dk(i){let e=[],t=i.matched?lk:ck;return e.push(t.range(i.start.from,i.start.to)),i.end&&e.push(t.range(i.end.from,i.end.to)),e}const uk=mn.define({create(){return ke.none},update(i,e){if(!e.docChanged&&!e.selection)return i;let t=[],n=e.state.facet(Ag);for(let s of e.state.selection.ranges){if(!s.empty)continue;let r=Un(e.state,s.head,-1,n)||s.head>0&&Un(e.state,s.head-1,1,n)||n.afterCursor&&(Un(e.state,s.head,1,n)||s.head<e.state.doc.length&&Un(e.state,s.head+1,-1,n));r&&(t=t.concat(n.renderMatch(r,e.state)))}return ke.set(t,!0)},provide:i=>de.decorations.from(i)}),hk=[uk,ak];function fk(i={}){return[Ag.of(i),hk]}const mk=new $e;function Cc(i,e,t){let n=i.prop(e<0?$e.openedBy:$e.closedBy);if(n)return n;if(i.name.length==1){let s=t.indexOf(i.name);if(s>-1&&s%2==(e<0?1:0))return[t[s+e]]}return null}function Ec(i){let e=i.type.prop(mk);return e?e(i.node):i}function Un(i,e,t,n={}){let s=n.maxScanDistance||Cg,r=n.brackets||Eg,o=Pt(i),a=o.resolveInner(e,t);for(let l=a;l;l=l.parent){let d=Cc(l.type,t,r);if(d&&l.from<l.to){let c=Ec(l);if(c&&(t>0?e>=c.from&&e<c.to:e>c.from&&e<=c.to))return pk(i,e,t,l,c,d,r)}}return gk(i,e,t,o,a.type,s,r)}function pk(i,e,t,n,s,r,o){let a=n.parent,l={from:s.from,to:s.to},d=0,c=a==null?void 0:a.cursor();if(c&&(t<0?c.childBefore(n.from):c.childAfter(n.to)))do if(t<0?c.to<=n.from:c.from>=n.to){if(d==0&&r.indexOf(c.type.name)>-1&&c.from<c.to){let u=Ec(c);return{start:l,end:u?{from:u.from,to:u.to}:void 0,matched:!0}}else if(Cc(c.type,t,o))d++;else if(Cc(c.type,-t,o)){if(d==0){let u=Ec(c);return{start:l,end:u&&u.from<u.to?{from:u.from,to:u.to}:void 0,matched:!1}}d--}}while(t<0?c.prevSibling():c.nextSibling());return{start:l,matched:!1}}function gk(i,e,t,n,s,r,o){let a=t<0?i.sliceDoc(e-1,e):i.sliceDoc(e,e+1),l=o.indexOf(a);if(l<0||l%2==0!=t>0)return null;let d={from:t<0?e-1:e,to:t>0?e+1:e},c=i.doc.iterRange(e,t>0?i.doc.length:0),u=0;for(let h=0;!c.next().done&&h<=r;){let f=c.value;t<0&&(h+=f.length);let m=e+h*t;for(let g=t>0?0:f.length-1,O=t>0?f.length:-1;g!=O;g+=t){let p=o.indexOf(f[g]);if(!(p<0||n.resolveInner(m+g,1).type!=s))if(p%2==0==t>0)u++;else{if(u==1)return{start:d,end:{from:m+g,to:m+g+1},matched:p>>1==l>>1};u--}}t>0&&(h+=f.length)}return c.done?{start:d,matched:!1}:null}const Ok=Object.create(null),Th=[rn.none],Nh=[],Qh=Object.create(null),yk=Object.create(null);for(let[i,e]of[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","tagName"],["attribute","attributeName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]])yk[i]=bk(Ok,e);function il(i,e){Nh.indexOf(i)>-1||(Nh.push(i),console.warn(e))}function bk(i,e){let t=[];for(let a of e.split(" ")){let l=[];for(let d of a.split(".")){let c=i[d]||Q[d];c?typeof c=="function"?l.length?l=l.map(c):il(d,`Modifier ${d} used at start of tag`):l.length?il(d,`Tag ${d} used as modifier`):l=Array.isArray(c)?c:[c]:il(d,`Unknown highlighting tag ${d}`)}for(let d of l)t.push(d)}if(!t.length)return 0;let n=e.replace(/ /g,"_"),s=n+" "+t.map(a=>a.id),r=Qh[s];if(r)return r.id;let o=Qh[s]=rn.define({id:Th.length,name:n,props:[dg({[n]:t})]});return Th.push(o),o.id}bt.RTL,bt.LTR;function Rh(i){let e=Object.keys(i).join(""),t=/\w/.test(e);return t&&(e=e.replace(/\w/g,"")),`[${t?"\\w":""}${e.replace(/[^\w\s]/g,"\\$&")}]`}function vk(i){let e=Object.create(null),t=Object.create(null);for(let{label:s}of i){e[s[0]]=!0;for(let r=1;r<s.length;r++)t[s[r]]=!0}let n=Rh(e)+Rh(t)+"*$";return[new RegExp("^"+n),new RegExp(n)]}function wk(i){let e=i.map(s=>typeof s=="string"?{label:s}:s),[t,n]=e.every(s=>/^\w+$/.test(s.label))?[/\w*$/,/\w+$/]:vk(e);return s=>{let r=s.matchBefore(n);return r||s.explicit?{from:r?r.from:s.pos,options:e,validFor:t}:null}}function Pk(i,e){return t=>{for(let n=Pt(t.state).resolveInner(t.pos,-1);n;n=n.parent){if(i.indexOf(n.name)>-1)return null;if(n.type.isTop)break}return e(t)}}const Sk=cs.define(),kk=de.baseTheme({".cm-tooltip.cm-tooltip-autocomplete":{"& > ul":{fontFamily:"monospace",whiteSpace:"nowrap",overflow:"hidden auto",maxWidth_fallback:"700px",maxWidth:"min(700px, 95vw)",minWidth:"250px",maxHeight:"10em",height:"100%",listStyle:"none",margin:0,padding:0,"& > li, & > completion-section":{padding:"1px 3px",lineHeight:1.2},"& > li":{overflowX:"hidden",textOverflow:"ellipsis",cursor:"pointer"},"& > completion-section":{display:"list-item",borderBottom:"1px solid silver",paddingLeft:"0.5em",opacity:.7}}},"&light .cm-tooltip-autocomplete ul li[aria-selected]":{background:"#17c",color:"white"},"&light .cm-tooltip-autocomplete-disabled ul li[aria-selected]":{background:"#777"},"&dark .cm-tooltip-autocomplete ul li[aria-selected]":{background:"#347",color:"white"},"&dark .cm-tooltip-autocomplete-disabled ul li[aria-selected]":{background:"#444"},".cm-completionListIncompleteTop:before, .cm-completionListIncompleteBottom:after":{content:'"···"',opacity:.5,display:"block",textAlign:"center"},".cm-tooltip.cm-completionInfo":{position:"absolute",padding:"3px 9px",width:"max-content",maxWidth:"400px",boxSizing:"border-box",whiteSpace:"pre-line"},".cm-completionInfo.cm-completionInfo-left":{right:"100%"},".cm-completionInfo.cm-completionInfo-right":{left:"100%"},".cm-completionInfo.cm-completionInfo-left-narrow":{right:"30px"},".cm-completionInfo.cm-completionInfo-right-narrow":{left:"30px"},"&light .cm-snippetField":{backgroundColor:"#00000022"},"&dark .cm-snippetField":{backgroundColor:"#ffffff22"},".cm-snippetFieldPosition":{verticalAlign:"text-top",width:0,height:"1.15em",display:"inline-block",margin:"0 -0.7px -.7em",borderLeft:"1.4px dotted #888"},".cm-completionMatchedText":{textDecoration:"underline"},".cm-completionDetail":{marginLeft:"0.5em",fontStyle:"italic"},".cm-completionIcon":{fontSize:"90%",width:".8em",display:"inline-block",textAlign:"center",paddingRight:".6em",opacity:"0.6",boxSizing:"content-box"},".cm-completionIcon-function, .cm-completionIcon-method":{"&:after":{content:"'ƒ'"}},".cm-completionIcon-class":{"&:after":{content:"'○'"}},".cm-completionIcon-interface":{"&:after":{content:"'◌'"}},".cm-completionIcon-variable":{"&:after":{content:"'𝑥'"}},".cm-completionIcon-constant":{"&:after":{content:"'𝐶'"}},".cm-completionIcon-type":{"&:after":{content:"'𝑡'"}},".cm-completionIcon-enum":{"&:after":{content:"'∪'"}},".cm-completionIcon-property":{"&:after":{content:"'□'"}},".cm-completionIcon-keyword":{"&:after":{content:"'🔑︎'"}},".cm-completionIcon-namespace":{"&:after":{content:"'▢'"}},".cm-completionIcon-text":{"&:after":{content:"'abc'",fontSize:"50%",verticalAlign:"middle"}}});class xk{constructor(e,t,n,s){this.field=e,this.line=t,this.from=n,this.to=s}}class xd{constructor(e,t,n){this.field=e,this.from=t,this.to=n}map(e){let t=e.mapPos(this.from,-1,Lt.TrackDel),n=e.mapPos(this.to,1,Lt.TrackDel);return t==null||n==null?null:new xd(this.field,t,n)}}class $d{constructor(e,t){this.lines=e,this.fieldPositions=t}instantiate(e,t){let n=[],s=[t],r=e.doc.lineAt(t),o=/^\s*/.exec(r.text)[0];for(let l of this.lines){if(n.length){let d=o,c=/^\t*/.exec(l)[0].length;for(let u=0;u<c;u++)d+=e.facet(fa);s.push(t+d.length-c),l=d+l.slice(c)}n.push(l),t+=l.length+1}let a=this.fieldPositions.map(l=>new xd(l.field,s[l.line]+l.from,s[l.line]+l.to));return{text:n,ranges:a}}static parse(e){let t=[],n=[],s=[],r;for(let o of e.split(/\r\n?|\n/)){for(;r=/[#$]\{(?:(\d+)(?::([^{}]*))?|((?:\\[{}]|[^{}])*))\}/.exec(o);){let a=r[1]?+r[1]:null,l=r[2]||r[3]||"",d=-1,c=l.replace(/\\[{}]/g,u=>u[1]);for(let u=0;u<t.length;u++)(a!=null?t[u].seq==a:c&&t[u].name==c)&&(d=u);if(d<0){let u=0;for(;u<t.length&&(a==null||t[u].seq!=null&&t[u].seq<a);)u++;t.splice(u,0,{seq:a,name:c}),d=u;for(let h of s)h.field>=d&&h.field++}for(let u of s)if(u.line==n.length&&u.from>r.index){let h=r[2]?3+(r[1]||"").length:2;u.from-=h,u.to-=h}s.push(new xk(d,n.length,r.index,r.index+c.length)),o=o.slice(0,r.index)+l+o.slice(r.index+r[0].length)}o=o.replace(/\\([{}])/g,(a,l,d)=>{for(let c of s)c.line==n.length&&c.from>d&&(c.from--,c.to--);return l}),n.push(o)}return new $d(n,s)}}let $k=ke.widget({widget:new class extends Ai{toDOM(){let i=document.createElement("span");return i.className="cm-snippetFieldPosition",i}ignoreEvent(){return!1}}}),Mk=ke.mark({class:"cm-snippetField"});class Ti{constructor(e,t){this.ranges=e,this.active=t,this.deco=ke.set(e.map(n=>(n.from==n.to?$k:Mk).range(n.from,n.to)),!0)}map(e){let t=[];for(let n of this.ranges){let s=n.map(e);if(!s)return null;t.push(s)}return new Ti(t,this.active)}selectionInsideField(e){return e.ranges.every(t=>this.ranges.some(n=>n.field==this.active&&n.from<=t.from&&n.to>=t.to))}}const Nr=Ve.define({map(i,e){return i&&i.map(e)}}),Ck=Ve.define(),Pr=mn.define({create(){return null},update(i,e){for(let t of e.effects){if(t.is(Nr))return t.value;if(t.is(Ck)&&i)return new Ti(i.ranges,t.value)}return i&&e.docChanged&&(i=i.map(e.changes)),i&&e.selection&&!i.selectionInsideField(e.selection)&&(i=null),i},provide:i=>de.decorations.from(i,e=>e?e.deco:ke.none)});function Md(i,e){return j.create(i.filter(t=>t.field==e).map(t=>j.range(t.from,t.to)))}function Ek(i){let e=$d.parse(i);return(t,n,s,r)=>{let{text:o,ranges:a}=e.instantiate(t.state,s),{main:l}=t.state.selection,d={changes:{from:s,to:r==l.from?l.to:r,insert:Qe.of(o)},scrollIntoView:!0,annotations:n?[Sk.of(n),mt.userEvent.of("input.complete")]:void 0};if(a.length&&(d.selection=Md(a,0)),a.some(c=>c.field>0)){let c=new Ti(a,0),u=d.effects=[Nr.of(c)];t.state.field(Pr,!1)===void 0&&u.push(Ve.appendConfig.of([Pr,Rk,_k,kk]))}t.dispatch(t.state.update(d))}}function Tg(i){return({state:e,dispatch:t})=>{let n=e.field(Pr,!1);if(!n||i<0&&n.active==0)return!1;let s=n.active+i,r=i>0&&!n.ranges.some(o=>o.field==s+i);return t(e.update({selection:Md(n.ranges,s),effects:Nr.of(r?null:new Ti(n.ranges,s)),scrollIntoView:!0})),!0}}const Ak=({state:i,dispatch:e})=>i.field(Pr,!1)?(e(i.update({effects:Nr.of(null)})),!0):!1,Tk=Tg(1),Nk=Tg(-1),Qk=[{key:"Tab",run:Tk,shift:Nk},{key:"Escape",run:Ak}],_h=he.define({combine(i){return i.length?i[0]:Qk}}),Rk=aa.highest(yd.compute([_h],i=>i.facet(_h)));function Jt(i,e){return{...e,apply:Ek(i)}}const _k=de.domEventHandlers({mousedown(i,e){let t=e.state.field(Pr,!1),n;if(!t||(n=e.posAtCoords({x:i.clientX,y:i.clientY}))==null)return!1;let s=t.ranges.find(r=>r.from<=n&&r.to>=n);return!s||s.field==t.active?!1:(e.dispatch({selection:Md(t.ranges,s.field),effects:Nr.of(t.ranges.some(r=>r.field>s.field)?new Ti(t.ranges,s.field):null),scrollIntoView:!0}),!0)}}),Sr={brackets:["(","[","{","'",'"'],before:")]}:;>",stringPrefixes:[]},zs=Ve.define({map(i,e){let t=e.mapPos(i,-1,Lt.TrackAfter);return t??void 0}}),Cd=new class extends Ws{};Cd.startSide=1;Cd.endSide=-1;const Ng=mn.define({create(){return _e.empty},update(i,e){if(i=i.map(e.changes),e.selection){let t=e.state.doc.lineAt(e.selection.main.head);i=i.update({filter:n=>n>=t.from&&n<=t.to})}for(let t of e.effects)t.is(zs)&&(i=i.update({add:[Cd.range(t.value,t.value+1)]}));return i}});function Ik(){return[Bk,Ng]}const rl="()[]{}<>«»»«［］｛｝";function Qg(i){for(let e=0;e<rl.length;e+=2)if(rl.charCodeAt(e)==i)return rl.charAt(e+1);return Gm(i<128?i:i+1)}function Rg(i,e){return i.languageDataAt("closeBrackets",e)[0]||Sr}const Lk=typeof navigator=="object"&&/Android\b/.test(navigator.userAgent),Bk=de.inputHandler.of((i,e,t,n)=>{if((Lk?i.composing:i.compositionStarted)||i.state.readOnly)return!1;let s=i.state.selection.main;if(n.length>2||n.length==2&&xr(ei(n,0))==1||e!=s.from||t!=s.to)return!1;let r=Vk(i.state,n);return r?(i.dispatch(r),!0):!1}),Dk=({state:i,dispatch:e})=>{if(i.readOnly)return!1;let n=Rg(i,i.selection.main.head).brackets||Sr.brackets,s=null,r=i.changeByRange(o=>{if(o.empty){let a=Zk(i.doc,o.head);for(let l of n)if(l==a&&Oa(i.doc,o.head)==Qg(ei(l,0)))return{changes:{from:o.head-l.length,to:o.head+l.length},range:j.cursor(o.head-l.length)}}return{range:s=o}});return s||e(i.update(r,{scrollIntoView:!0,userEvent:"delete.backward"})),!s},zk=[{key:"Backspace",run:Dk}];function Vk(i,e){let t=Rg(i,i.selection.main.head),n=t.brackets||Sr.brackets;for(let s of n){let r=Qg(ei(s,0));if(e==s)return r==s?Gk(i,s,n.indexOf(s+s+s)>-1,t):jk(i,s,r,t.before||Sr.before);if(e==r&&_g(i,i.selection.main.from))return Fk(i,s,r)}return null}function _g(i,e){let t=!1;return i.field(Ng).between(0,i.doc.length,n=>{n==e&&(t=!0)}),t}function Oa(i,e){let t=i.sliceString(e,e+2);return t.slice(0,xr(ei(t,0)))}function Zk(i,e){let t=i.sliceString(e-2,e);return xr(ei(t,0))==t.length?t:t.slice(1)}function jk(i,e,t,n){let s=null,r=i.changeByRange(o=>{if(!o.empty)return{changes:[{insert:e,from:o.from},{insert:t,from:o.to}],effects:zs.of(o.to+e.length),range:j.range(o.anchor+e.length,o.head+e.length)};let a=Oa(i.doc,o.head);return!a||/\s/.test(a)||n.indexOf(a)>-1?{changes:{insert:e+t,from:o.head},effects:zs.of(o.head+e.length),range:j.cursor(o.head+e.length)}:{range:s=o}});return s?null:i.update(r,{scrollIntoView:!0,userEvent:"input.type"})}function Fk(i,e,t){let n=null,s=i.changeByRange(r=>r.empty&&Oa(i.doc,r.head)==t?{changes:{from:r.head,to:r.head+t.length,insert:t},range:j.cursor(r.head+t.length)}:n={range:r});return n?null:i.update(s,{scrollIntoView:!0,userEvent:"input.type"})}function Gk(i,e,t,n){let s=n.stringPrefixes||Sr.stringPrefixes,r=null,o=i.changeByRange(a=>{if(!a.empty)return{changes:[{insert:e,from:a.from},{insert:e,from:a.to}],effects:zs.of(a.to+e.length),range:j.range(a.anchor+e.length,a.head+e.length)};let l=a.head,d=Oa(i.doc,l),c;if(d==e){if(Ih(i,l))return{changes:{insert:e+e,from:l},effects:zs.of(l+e.length),range:j.cursor(l+e.length)};if(_g(i,l)){let h=t&&i.sliceDoc(l,l+e.length*3)==e+e+e?e+e+e:e;return{changes:{from:l,to:l+h.length,insert:h},range:j.cursor(l+h.length)}}}else{if(t&&i.sliceDoc(l-2*e.length,l)==e+e&&(c=Lh(i,l-2*e.length,s))>-1&&Ih(i,c))return{changes:{insert:e+e+e+e,from:l},effects:zs.of(l+e.length),range:j.cursor(l+e.length)};if(i.charCategorizer(l)(d)!=Dt.Word&&Lh(i,l,s)>-1&&!Xk(i,l,e,s))return{changes:{insert:e+e,from:l},effects:zs.of(l+e.length),range:j.cursor(l+e.length)}}return{range:r=a}});return r?null:i.update(o,{scrollIntoView:!0,userEvent:"input.type"})}function Ih(i,e){let t=Pt(i).resolveInner(e+1);return t.parent&&t.from==e}function Xk(i,e,t,n){let s=Pt(i).resolveInner(e,-1),r=n.reduce((o,a)=>Math.max(o,a.length),0);for(let o=0;o<5;o++){let a=i.sliceDoc(s.from,Math.min(s.to,s.from+t.length+r)),l=a.indexOf(t);if(!l||l>-1&&n.indexOf(a.slice(0,l))>-1){let c=s.firstChild;for(;c&&c.from==s.from&&c.to-c.from>t.length+l;){if(i.sliceDoc(c.to-t.length,c.to)==t)return!1;c=c.firstChild}return!0}let d=s.to==e&&s.parent;if(!d)break;s=d}return!1}function Lh(i,e,t){let n=i.charCategorizer(e);if(n(i.sliceDoc(e-1,e))!=Dt.Word)return e;for(let s of t){let r=e-s.length;if(i.sliceDoc(r,e)==s&&n(i.sliceDoc(r-1,r))!=Dt.Word)return r}return-1}const Ig=[Jt("function ${name}(${params}) {\n	${}\n}",{label:"function",detail:"definition",type:"keyword"}),Jt("for (let ${index} = 0; ${index} < ${bound}; ${index}++) {\n	${}\n}",{label:"for",detail:"loop",type:"keyword"}),Jt("for (let ${name} of ${collection}) {\n	${}\n}",{label:"for",detail:"of loop",type:"keyword"}),Jt("do {\n	${}\n} while (${})",{label:"do",detail:"loop",type:"keyword"}),Jt("while (${}) {\n	${}\n}",{label:"while",detail:"loop",type:"keyword"}),Jt(`try {
	\${}
} catch (\${error}) {
	\${}
}`,{label:"try",detail:"/ catch block",type:"keyword"}),Jt("if (${}) {\n	${}\n}",{label:"if",detail:"block",type:"keyword"}),Jt(`if (\${}) {
	\${}
} else {
	\${}
}`,{label:"if",detail:"/ else block",type:"keyword"}),Jt(`class \${name} {
	constructor(\${params}) {
		\${}
	}
}`,{label:"class",detail:"definition",type:"keyword"}),Jt('import {${names}} from "${module}"\n${}',{label:"import",detail:"named",type:"keyword"}),Jt('import ${name} from "${module}"\n${}',{label:"import",detail:"default",type:"keyword"})],Uk=Ig.concat([Jt("interface ${name} {\n	${}\n}",{label:"interface",detail:"definition",type:"keyword"}),Jt("type ${name} = ${type}",{label:"type",detail:"definition",type:"keyword"}),Jt("enum ${name} {\n	${}\n}",{label:"enum",detail:"definition",type:"keyword"})]),Bh=new RP,Lg=new Set(["Script","Block","FunctionExpression","FunctionDeclaration","ArrowFunction","MethodDeclaration","ForStatement"]);function Xi(i){return(e,t)=>{let n=e.node.getChild("VariableDefinition");return n&&t(n,i),!0}}const Wk=["FunctionDeclaration"],qk={FunctionDeclaration:Xi("function"),ClassDeclaration:Xi("class"),ClassExpression:()=>!0,EnumDeclaration:Xi("constant"),TypeAliasDeclaration:Xi("type"),NamespaceDeclaration:Xi("namespace"),VariableDefinition(i,e){i.matchContext(Wk)||e(i,"variable")},TypeDefinition(i,e){e(i,"type")},__proto__:null};function Bg(i,e){let t=Bh.get(e);if(t)return t;let n=[],s=!0;function r(o,a){let l=i.sliceString(o.from,o.to);n.push({label:l,type:a})}return e.cursor(yt.IncludeAnonymous).iterate(o=>{if(s)s=!1;else if(o.name){let a=qk[o.name];if(a&&a(o,r)||Lg.has(o.name))return!1}else if(o.to-o.from>8192){for(let a of Bg(i,o.node))n.push(a);return!1}}),Bh.set(e,n),n}const Dh=/^[\w$\xa1-\uffff][\w$\d\xa1-\uffff]*$/,Dg=["TemplateString","String","RegExp","LineComment","BlockComment","VariableDefinition","TypeDefinition","Label","PropertyDefinition","PropertyName","PrivatePropertyDefinition","PrivatePropertyName","JSXText","JSXAttributeValue","JSXOpenTag","JSXCloseTag","JSXSelfClosingTag",".","?."];function Hk(i){let e=Pt(i.state).resolveInner(i.pos,-1);if(Dg.indexOf(e.name)>-1)return null;let t=e.name=="VariableName"||e.to-e.from<20&&Dh.test(i.state.sliceDoc(e.from,e.to));if(!t&&!i.explicit)return null;let n=[];for(let s=e;s;s=s.parent)Lg.has(s.name)&&(n=n.concat(Bg(i.state.doc,s)));return{options:n,from:t?e.from:i.pos,validFor:Dh}}const Gs=jo.define({name:"javascript",parser:ES.configure({props:[Og.add({IfStatement:tl({except:/^\s*({|else\b)/}),TryStatement:tl({except:/^\s*({|catch\b|finally\b)/}),LabeledStatement:VS,SwitchBody:i=>{let e=i.textAfter,t=/^\s*\}/.test(e),n=/^\s*(case|default)\b/.test(e);return i.baseIndent+(t?0:n?1:2)*i.unit},Block:zS({closing:"}"}),ArrowFunction:i=>i.baseIndent+i.unit,"TemplateString BlockComment":()=>null,"Statement Property":tl({except:/^\s*{/}),JSXElement(i){let e=/^\s*<\//.test(i.textAfter);return i.lineIndent(i.node.from)+(e?0:i.unit)},JSXEscape(i){let e=/\s*\}/.test(i.textAfter);return i.lineIndent(i.node.from)+(e?0:i.unit)},"JSXOpenTag JSXSelfClosingTag"(i){return i.column(i.node.from)+i.unit}}),vg.add({"Block ClassBody SwitchBody EnumBody ObjectExpression ArrayExpression ObjectType":jS,BlockComment(i){return{from:i.from+2,to:i.to-2}}})]}),languageData:{closeBrackets:{brackets:["(","[","{","'",'"',"`"]},commentTokens:{line:"//",block:{open:"/*",close:"*/"}},indentOnInput:/^\s*(?:case |default:|\{|\}|<\/)$/,wordChars:"$"}}),zg={test:i=>/^JSX/.test(i.name),facet:mg({commentTokens:{block:{open:"{/*",close:"*/}"}}})},Yk=Gs.configure({dialect:"ts"},"typescript"),Kk=Gs.configure({dialect:"jsx",props:[Sd.add(i=>i.isTop?[zg]:void 0)]}),Jk=Gs.configure({dialect:"jsx ts",props:[Sd.add(i=>i.isTop?[zg]:void 0)]},"typescript");let Vg=i=>({label:i,type:"keyword"});const Zg="break case const continue default delete export extends false finally in instanceof let new return static super switch this throw true typeof var yield".split(" ").map(Vg),ex=Zg.concat(["declare","implements","private","protected","public"].map(Vg));function tx(i={}){let e=i.jsx?i.typescript?Jk:Kk:i.typescript?Yk:Gs,t=i.typescript?Uk.concat(ex):Ig.concat(Zg);return new NS(e,[Gs.data.of({autocomplete:Pk(Dg,wk(t))}),Gs.data.of({autocomplete:Hk}),i.jsx?ix:[]])}function nx(i){for(;;){if(i.name=="JSXOpenTag"||i.name=="JSXSelfClosingTag"||i.name=="JSXFragmentTag")return i;if(i.name=="JSXEscape"||!i.parent)return null;i=i.parent}}function zh(i,e,t=i.length){for(let n=e==null?void 0:e.firstChild;n;n=n.nextSibling)if(n.name=="JSXIdentifier"||n.name=="JSXBuiltin"||n.name=="JSXNamespacedName"||n.name=="JSXMemberExpression")return i.sliceString(n.from,Math.min(n.to,t));return""}const sx=typeof navigator=="object"&&/Android\b/.test(navigator.userAgent),ix=de.inputHandler.of((i,e,t,n,s)=>{if((sx?i.composing:i.compositionStarted)||i.state.readOnly||e!=t||n!=">"&&n!="/"||!Gs.isActiveAt(i.state,e,-1))return!1;let r=s(),{state:o}=r,a=o.changeByRange(l=>{var d;let{head:c}=l,u=Pt(o).resolveInner(c-1,-1),h;if(u.name=="JSXStartTag"&&(u=u.parent),!(o.doc.sliceString(c-1,c)!=n||u.name=="JSXAttributeValue"&&u.to>c)){if(n==">"&&u.name=="JSXFragmentTag")return{range:l,changes:{from:c,insert:"</>"}};if(n=="/"&&u.name=="JSXStartCloseTag"){let f=u.parent,m=f.parent;if(m&&f.from==c-2&&((h=zh(o.doc,m.firstChild,c))||((d=m.firstChild)===null||d===void 0?void 0:d.name)=="JSXFragmentTag")){let g=`${h}>`;return{range:j.cursor(c+g.length,-1),changes:{from:c,insert:g}}}}else if(n==">"){let f=nx(u);if(f&&f.name=="JSXOpenTag"&&!/^\/?>|^<\//.test(o.doc.sliceString(c,c+2))&&(h=zh(o.doc,f,c)))return{range:l,changes:{from:c,insert:`</${h}>`}}}}return{range:l}});return a.changes.empty?!1:(i.dispatch([r,o.update(a,{userEvent:"input.complete",scrollIntoView:!0})]),!0)}),rx="#e5c07b",Vh="#e06c75",ox="#56b6c2",ax="#ffffff",ko="#abb2bf",Ac="#7d8799",lx="#61afef",cx="#98c379",Zh="#d19a66",dx="#c678dd",ux="#21252b",jh="#2c313a",Fh="#282c34",ol="#353a42",hx="#3E4451",Gh="#528bff",fx=de.theme({"&":{color:ko,backgroundColor:Fh},".cm-content":{caretColor:Gh},".cm-cursor, .cm-dropCursor":{borderLeftColor:Gh},"&.cm-focused > .cm-scroller > .cm-selectionLayer .cm-selectionBackground, .cm-selectionBackground, .cm-content ::selection":{backgroundColor:hx},".cm-panels":{backgroundColor:ux,color:ko},".cm-panels.cm-panels-top":{borderBottom:"2px solid black"},".cm-panels.cm-panels-bottom":{borderTop:"2px solid black"},".cm-searchMatch":{backgroundColor:"#72a1ff59",outline:"1px solid #457dff"},".cm-searchMatch.cm-searchMatch-selected":{backgroundColor:"#6199ff2f"},".cm-activeLine":{backgroundColor:"#6699ff0b"},".cm-selectionMatch":{backgroundColor:"#aafe661a"},"&.cm-focused .cm-matchingBracket, &.cm-focused .cm-nonmatchingBracket":{backgroundColor:"#bad0f847"},".cm-gutters":{backgroundColor:Fh,color:Ac,border:"none"},".cm-activeLineGutter":{backgroundColor:jh},".cm-foldPlaceholder":{backgroundColor:"transparent",border:"none",color:"#ddd"},".cm-tooltip":{border:"none",backgroundColor:ol},".cm-tooltip .cm-tooltip-arrow:before":{borderTopColor:"transparent",borderBottomColor:"transparent"},".cm-tooltip .cm-tooltip-arrow:after":{borderTopColor:ol,borderBottomColor:ol},".cm-tooltip-autocomplete":{"& > ul > li[aria-selected]":{backgroundColor:jh,color:ko}}},{dark:!0}),mx=ga.define([{tag:Q.keyword,color:dx},{tag:[Q.name,Q.deleted,Q.character,Q.propertyName,Q.macroName],color:Vh},{tag:[Q.function(Q.variableName),Q.labelName],color:lx},{tag:[Q.color,Q.constant(Q.name),Q.standard(Q.name)],color:Zh},{tag:[Q.definition(Q.name),Q.separator],color:ko},{tag:[Q.typeName,Q.className,Q.number,Q.changed,Q.annotation,Q.modifier,Q.self,Q.namespace],color:rx},{tag:[Q.operator,Q.operatorKeyword,Q.url,Q.escape,Q.regexp,Q.link,Q.special(Q.string)],color:ox},{tag:[Q.meta,Q.comment],color:Ac},{tag:Q.strong,fontWeight:"bold"},{tag:Q.emphasis,fontStyle:"italic"},{tag:Q.strikethrough,textDecoration:"line-through"},{tag:Q.link,color:Ac,textDecoration:"underline"},{tag:Q.heading,fontWeight:"bold",color:Vh},{tag:[Q.atom,Q.bool,Q.special(Q.variableName)],color:Zh},{tag:[Q.processingInstruction,Q.string,Q.inserted],color:cx},{tag:Q.invalid,color:ax}]),px=[fx,ik(mx)],gx=i=>{let{state:e}=i,t=e.doc.lineAt(e.selection.main.from),n=Ad(i.state,t.from);return n.line?Ox(i):n.block?bx(i):!1};function Ed(i,e){return({state:t,dispatch:n})=>{if(t.readOnly)return!1;let s=i(e,t);return s?(n(t.update(s)),!0):!1}}const Ox=Ed(Px,0),yx=Ed(jg,0),bx=Ed((i,e)=>jg(i,e,wx(e)),0);function Ad(i,e){let t=i.languageDataAt("commentTokens",e,1);return t.length?t[0]:{}}const Ui=50;function vx(i,{open:e,close:t},n,s){let r=i.sliceDoc(n-Ui,n),o=i.sliceDoc(s,s+Ui),a=/\s*$/.exec(r)[0].length,l=/^\s*/.exec(o)[0].length,d=r.length-a;if(r.slice(d-e.length,d)==e&&o.slice(l,l+t.length)==t)return{open:{pos:n-a,margin:a&&1},close:{pos:s+l,margin:l&&1}};let c,u;s-n<=2*Ui?c=u=i.sliceDoc(n,s):(c=i.sliceDoc(n,n+Ui),u=i.sliceDoc(s-Ui,s));let h=/^\s*/.exec(c)[0].length,f=/\s*$/.exec(u)[0].length,m=u.length-f-t.length;return c.slice(h,h+e.length)==e&&u.slice(m,m+t.length)==t?{open:{pos:n+h+e.length,margin:/\s/.test(c.charAt(h+e.length))?1:0},close:{pos:s-f-t.length,margin:/\s/.test(u.charAt(m-1))?1:0}}:null}function wx(i){let e=[];for(let t of i.selection.ranges){let n=i.doc.lineAt(t.from),s=t.to<=n.to?n:i.doc.lineAt(t.to);s.from>n.from&&s.from==t.to&&(s=t.to==n.to+1?n:i.doc.lineAt(t.to-1));let r=e.length-1;r>=0&&e[r].to>n.from?e[r].to=s.to:e.push({from:n.from+/^\s*/.exec(n.text)[0].length,to:s.to})}return e}function jg(i,e,t=e.selection.ranges){let n=t.map(r=>Ad(e,r.from).block);if(!n.every(r=>r))return null;let s=t.map((r,o)=>vx(e,n[o],r.from,r.to));if(i!=2&&!s.every(r=>r))return{changes:e.changes(t.map((r,o)=>s[o]?[]:[{from:r.from,insert:n[o].open+" "},{from:r.to,insert:" "+n[o].close}]))};if(i!=1&&s.some(r=>r)){let r=[];for(let o=0,a;o<s.length;o++)if(a=s[o]){let l=n[o],{open:d,close:c}=a;r.push({from:d.pos-l.open.length,to:d.pos+d.margin},{from:c.pos-c.margin,to:c.pos+l.close.length})}return{changes:r}}return null}function Px(i,e,t=e.selection.ranges){let n=[],s=-1;for(let{from:r,to:o}of t){let a=n.length,l=1e9,d=Ad(e,r).line;if(d){for(let c=r;c<=o;){let u=e.doc.lineAt(c);if(u.from>s&&(r==o||o>u.from)){s=u.from;let h=/^\s*/.exec(u.text)[0].length,f=h==u.length,m=u.text.slice(h,h+d.length)==d?h:-1;h<u.text.length&&h<l&&(l=h),n.push({line:u,comment:m,token:d,indent:h,empty:f,single:!1})}c=u.to+1}if(l<1e9)for(let c=a;c<n.length;c++)n[c].indent<n[c].line.text.length&&(n[c].indent=l);n.length==a+1&&(n[a].single=!0)}}if(i!=2&&n.some(r=>r.comment<0&&(!r.empty||r.single))){let r=[];for(let{line:a,token:l,indent:d,empty:c,single:u}of n)(u||!c)&&r.push({from:a.from+d,insert:l+" "});let o=e.changes(r);return{changes:o,selection:e.selection.map(o,1)}}else if(i!=1&&n.some(r=>r.comment>=0)){let r=[];for(let{line:o,comment:a,token:l}of n)if(a>=0){let d=o.from+a,c=d+l.length;o.text[c-o.from]==" "&&c++,r.push({from:d,to:c})}return{changes:r}}return null}const Tc=cs.define(),Sx=cs.define(),kx=he.define(),Fg=he.define({combine(i){return $r(i,{minDepth:100,newGroupDelay:500,joinToEvent:(e,t)=>t},{minDepth:Math.max,newGroupDelay:Math.min,joinToEvent:(e,t)=>(n,s)=>e(n,s)||t(n,s)})}}),Gg=mn.define({create(){return Wn.empty},update(i,e){let t=e.state.facet(Fg),n=e.annotation(Tc);if(n){let l=nn.fromTransaction(e,n.selection),d=n.side,c=d==0?i.undone:i.done;return l?c=qo(c,c.length,t.minDepth,l):c=Wg(c,e.startState.selection),new Wn(d==0?n.rest:c,d==0?c:n.rest)}let s=e.annotation(Sx);if((s=="full"||s=="before")&&(i=i.isolate()),e.annotation(mt.addToHistory)===!1)return e.changes.empty?i:i.addMapping(e.changes.desc);let r=nn.fromTransaction(e),o=e.annotation(mt.time),a=e.annotation(mt.userEvent);return r?i=i.addChanges(r,o,a,t,e):e.selection&&(i=i.addSelection(e.startState.selection,o,a,t.newGroupDelay)),(s=="full"||s=="after")&&(i=i.isolate()),i},toJSON(i){return{done:i.done.map(e=>e.toJSON()),undone:i.undone.map(e=>e.toJSON())}},fromJSON(i){return new Wn(i.done.map(nn.fromJSON),i.undone.map(nn.fromJSON))}});function xx(i={}){return[Gg,Fg.of(i),de.domEventHandlers({beforeinput(e,t){let n=e.inputType=="historyUndo"?Xg:e.inputType=="historyRedo"?Nc:null;return n?(e.preventDefault(),n(t)):!1}})]}function ya(i,e){return function({state:t,dispatch:n}){if(!e&&t.readOnly)return!1;let s=t.field(Gg,!1);if(!s)return!1;let r=s.pop(i,t,e);return r?(n(r),!0):!1}}const Xg=ya(0,!1),Nc=ya(1,!1),$x=ya(0,!0),Mx=ya(1,!0);class nn{constructor(e,t,n,s,r){this.changes=e,this.effects=t,this.mapped=n,this.startSelection=s,this.selectionsAfter=r}setSelAfter(e){return new nn(this.changes,this.effects,this.mapped,this.startSelection,e)}toJSON(){var e,t,n;return{changes:(e=this.changes)===null||e===void 0?void 0:e.toJSON(),mapped:(t=this.mapped)===null||t===void 0?void 0:t.toJSON(),startSelection:(n=this.startSelection)===null||n===void 0?void 0:n.toJSON(),selectionsAfter:this.selectionsAfter.map(s=>s.toJSON())}}static fromJSON(e){return new nn(e.changes&&Ot.fromJSON(e.changes),[],e.mapped&&Hn.fromJSON(e.mapped),e.startSelection&&j.fromJSON(e.startSelection),e.selectionsAfter.map(j.fromJSON))}static fromTransaction(e,t){let n=bn;for(let s of e.startState.facet(kx)){let r=s(e);r.length&&(n=n.concat(r))}return!n.length&&e.changes.empty?null:new nn(e.changes.invert(e.startState.doc),n,void 0,t||e.startState.selection,bn)}static selection(e){return new nn(void 0,bn,void 0,void 0,e)}}function qo(i,e,t,n){let s=e+1>t+20?e-t-1:0,r=i.slice(s,e);return r.push(n),r}function Cx(i,e){let t=[],n=!1;return i.iterChangedRanges((s,r)=>t.push(s,r)),e.iterChangedRanges((s,r,o,a)=>{for(let l=0;l<t.length;){let d=t[l++],c=t[l++];a>=d&&o<=c&&(n=!0)}}),n}function Ex(i,e){return i.ranges.length==e.ranges.length&&i.ranges.filter((t,n)=>t.empty!=e.ranges[n].empty).length===0}function Ug(i,e){return i.length?e.length?i.concat(e):i:e}const bn=[],Ax=200;function Wg(i,e){if(i.length){let t=i[i.length-1],n=t.selectionsAfter.slice(Math.max(0,t.selectionsAfter.length-Ax));return n.length&&n[n.length-1].eq(e)?i:(n.push(e),qo(i,i.length-1,1e9,t.setSelAfter(n)))}else return[nn.selection([e])]}function Tx(i){let e=i[i.length-1],t=i.slice();return t[i.length-1]=e.setSelAfter(e.selectionsAfter.slice(0,e.selectionsAfter.length-1)),t}function al(i,e){if(!i.length)return i;let t=i.length,n=bn;for(;t;){let s=Nx(i[t-1],e,n);if(s.changes&&!s.changes.empty||s.effects.length){let r=i.slice(0,t);return r[t-1]=s,r}else e=s.mapped,t--,n=s.selectionsAfter}return n.length?[nn.selection(n)]:bn}function Nx(i,e,t){let n=Ug(i.selectionsAfter.length?i.selectionsAfter.map(a=>a.map(e)):bn,t);if(!i.changes)return nn.selection(n);let s=i.changes.map(e),r=e.mapDesc(i.changes,!0),o=i.mapped?i.mapped.composeDesc(r):r;return new nn(s,Ve.mapEffects(i.effects,e),o,i.startSelection.map(r),n)}const Qx=/^(input\.type|delete)($|\.)/;class Wn{constructor(e,t,n=0,s=void 0){this.done=e,this.undone=t,this.prevTime=n,this.prevUserEvent=s}isolate(){return this.prevTime?new Wn(this.done,this.undone):this}addChanges(e,t,n,s,r){let o=this.done,a=o[o.length-1];return a&&a.changes&&!a.changes.empty&&e.changes&&(!n||Qx.test(n))&&(!a.selectionsAfter.length&&t-this.prevTime<s.newGroupDelay&&s.joinToEvent(r,Cx(a.changes,e.changes))||n=="input.type.compose")?o=qo(o,o.length-1,s.minDepth,new nn(e.changes.compose(a.changes),Ug(Ve.mapEffects(e.effects,a.changes),a.effects),a.mapped,a.startSelection,bn)):o=qo(o,o.length,s.minDepth,e),new Wn(o,bn,t,n)}addSelection(e,t,n,s){let r=this.done.length?this.done[this.done.length-1].selectionsAfter:bn;return r.length>0&&t-this.prevTime<s&&n==this.prevUserEvent&&n&&/^select($|\.)/.test(n)&&Ex(r[r.length-1],e)?this:new Wn(Wg(this.done,e),this.undone,t,n)}addMapping(e){return new Wn(al(this.done,e),al(this.undone,e),this.prevTime,this.prevUserEvent)}pop(e,t,n){let s=e==0?this.done:this.undone;if(s.length==0)return null;let r=s[s.length-1],o=r.selectionsAfter[0]||t.selection;if(n&&r.selectionsAfter.length)return t.update({selection:r.selectionsAfter[r.selectionsAfter.length-1],annotations:Tc.of({side:e,rest:Tx(s),selection:o}),userEvent:e==0?"select.undo":"select.redo",scrollIntoView:!0});if(r.changes){let a=s.length==1?bn:s.slice(0,s.length-1);return r.mapped&&(a=al(a,r.mapped)),t.update({changes:r.changes,selection:r.startSelection,effects:r.effects,annotations:Tc.of({side:e,rest:a,selection:o}),filter:!1,userEvent:e==0?"undo":"redo",scrollIntoView:!0})}else return null}}Wn.empty=new Wn(bn,bn);const Rx=[{key:"Mod-z",run:Xg,preventDefault:!0},{key:"Mod-y",mac:"Mod-Shift-z",run:Nc,preventDefault:!0},{linux:"Ctrl-Shift-z",run:Nc,preventDefault:!0},{key:"Mod-u",run:$x,preventDefault:!0},{key:"Alt-u",mac:"Mod-Shift-u",run:Mx,preventDefault:!0}];function Ni(i,e){return j.create(i.ranges.map(e),i.mainIndex)}function Qn(i,e){return i.update({selection:e,scrollIntoView:!0,userEvent:"select"})}function Rn({state:i,dispatch:e},t){let n=Ni(i.selection,t);return n.eq(i.selection,!0)?!1:(e(Qn(i,n)),!0)}function ba(i,e){return j.cursor(e?i.to:i.from)}function qg(i,e){return Rn(i,t=>t.empty?i.moveByChar(t,e):ba(t,e))}function zt(i){return i.textDirectionAt(i.state.selection.main.head)==bt.LTR}const Hg=i=>qg(i,!zt(i)),Yg=i=>qg(i,zt(i));function Kg(i,e){return Rn(i,t=>t.empty?i.moveByGroup(t,e):ba(t,e))}const _x=i=>Kg(i,!zt(i)),Ix=i=>Kg(i,zt(i));function Lx(i,e,t){if(e.type.prop(t))return!0;let n=e.to-e.from;return n&&(n>2||/[^\s,.;:]/.test(i.sliceDoc(e.from,e.to)))||e.firstChild}function va(i,e,t){let n=Pt(i).resolveInner(e.head),s=t?$e.closedBy:$e.openedBy;for(let l=e.head;;){let d=t?n.childAfter(l):n.childBefore(l);if(!d)break;Lx(i,d,s)?n=d:l=t?d.to:d.from}let r=n.type.prop(s),o,a;return r&&(o=t?Un(i,n.from,1):Un(i,n.to,-1))&&o.matched?a=t?o.end.to:o.end.from:a=t?n.to:n.from,j.cursor(a,t?-1:1)}const Bx=i=>Rn(i,e=>va(i.state,e,!zt(i))),Dx=i=>Rn(i,e=>va(i.state,e,zt(i)));function Jg(i,e){return Rn(i,t=>{if(!t.empty)return ba(t,e);let n=i.moveVertically(t,e);return n.head!=t.head?n:i.moveToLineBoundary(t,e)})}const eO=i=>Jg(i,!1),tO=i=>Jg(i,!0);function nO(i){let e=i.scrollDOM.clientHeight<i.scrollDOM.scrollHeight-2,t=0,n=0,s;if(e){for(let r of i.state.facet(de.scrollMargins)){let o=r(i);o!=null&&o.top&&(t=Math.max(o==null?void 0:o.top,t)),o!=null&&o.bottom&&(n=Math.max(o==null?void 0:o.bottom,n))}s=i.scrollDOM.clientHeight-t-n}else s=(i.dom.ownerDocument.defaultView||window).innerHeight;return{marginTop:t,marginBottom:n,selfScroll:e,height:Math.max(i.defaultLineHeight,s-5)}}function sO(i,e){let t=nO(i),{state:n}=i,s=Ni(n.selection,o=>o.empty?i.moveVertically(o,e,t.height):ba(o,e));if(s.eq(n.selection))return!1;let r;if(t.selfScroll){let o=i.coordsAtPos(n.selection.main.head),a=i.scrollDOM.getBoundingClientRect(),l=a.top+t.marginTop,d=a.bottom-t.marginBottom;o&&o.top>l&&o.bottom<d&&(r=de.scrollIntoView(s.main.head,{y:"start",yMargin:o.top-l}))}return i.dispatch(Qn(n,s),{effects:r}),!0}const Xh=i=>sO(i,!1),Qc=i=>sO(i,!0);function Cs(i,e,t){let n=i.lineBlockAt(e.head),s=i.moveToLineBoundary(e,t);if(s.head==e.head&&s.head!=(t?n.to:n.from)&&(s=i.moveToLineBoundary(e,t,!1)),!t&&s.head==n.from&&n.length){let r=/^\s*/.exec(i.state.sliceDoc(n.from,Math.min(n.from+100,n.to)))[0].length;r&&e.head!=n.from+r&&(s=j.cursor(n.from+r))}return s}const zx=i=>Rn(i,e=>Cs(i,e,!0)),Vx=i=>Rn(i,e=>Cs(i,e,!1)),Zx=i=>Rn(i,e=>Cs(i,e,!zt(i))),jx=i=>Rn(i,e=>Cs(i,e,zt(i))),Fx=i=>Rn(i,e=>j.cursor(i.lineBlockAt(e.head).from,1)),Gx=i=>Rn(i,e=>j.cursor(i.lineBlockAt(e.head).to,-1));function Xx(i,e,t){let n=!1,s=Ni(i.selection,r=>{let o=Un(i,r.head,-1)||Un(i,r.head,1)||r.head>0&&Un(i,r.head-1,1)||r.head<i.doc.length&&Un(i,r.head+1,-1);if(!o||!o.end)return r;n=!0;let a=o.start.from==r.head?o.end.to:o.end.from;return j.cursor(a)});return n?(e(Qn(i,s)),!0):!1}const Ux=({state:i,dispatch:e})=>Xx(i,e);function Sn(i,e){let t=Ni(i.state.selection,n=>{let s=e(n);return j.range(n.anchor,s.head,s.goalColumn,s.bidiLevel||void 0)});return t.eq(i.state.selection)?!1:(i.dispatch(Qn(i.state,t)),!0)}function iO(i,e){return Sn(i,t=>i.moveByChar(t,e))}const rO=i=>iO(i,!zt(i)),oO=i=>iO(i,zt(i));function aO(i,e){return Sn(i,t=>i.moveByGroup(t,e))}const Wx=i=>aO(i,!zt(i)),qx=i=>aO(i,zt(i)),Hx=i=>Sn(i,e=>va(i.state,e,!zt(i))),Yx=i=>Sn(i,e=>va(i.state,e,zt(i)));function lO(i,e){return Sn(i,t=>i.moveVertically(t,e))}const cO=i=>lO(i,!1),dO=i=>lO(i,!0);function uO(i,e){return Sn(i,t=>i.moveVertically(t,e,nO(i).height))}const Uh=i=>uO(i,!1),Wh=i=>uO(i,!0),Kx=i=>Sn(i,e=>Cs(i,e,!0)),Jx=i=>Sn(i,e=>Cs(i,e,!1)),e$=i=>Sn(i,e=>Cs(i,e,!zt(i))),t$=i=>Sn(i,e=>Cs(i,e,zt(i))),n$=i=>Sn(i,e=>j.cursor(i.lineBlockAt(e.head).from)),s$=i=>Sn(i,e=>j.cursor(i.lineBlockAt(e.head).to)),qh=({state:i,dispatch:e})=>(e(Qn(i,{anchor:0})),!0),Hh=({state:i,dispatch:e})=>(e(Qn(i,{anchor:i.doc.length})),!0),Yh=({state:i,dispatch:e})=>(e(Qn(i,{anchor:i.selection.main.anchor,head:0})),!0),Kh=({state:i,dispatch:e})=>(e(Qn(i,{anchor:i.selection.main.anchor,head:i.doc.length})),!0),i$=({state:i,dispatch:e})=>(e(i.update({selection:{anchor:0,head:i.doc.length},userEvent:"select"})),!0),r$=({state:i,dispatch:e})=>{let t=wa(i).map(({from:n,to:s})=>j.range(n,Math.min(s+1,i.doc.length)));return e(i.update({selection:j.create(t),userEvent:"select"})),!0},o$=({state:i,dispatch:e})=>{let t=Ni(i.selection,n=>{let s=Pt(i),r=s.resolveStack(n.from,1);if(n.empty){let o=s.resolveStack(n.from,-1);o.node.from>=r.node.from&&o.node.to<=r.node.to&&(r=o)}for(let o=r;o;o=o.next){let{node:a}=o;if((a.from<n.from&&a.to>=n.to||a.to>n.to&&a.from<=n.from)&&o.next)return j.range(a.to,a.from)}return n});return t.eq(i.selection)?!1:(e(Qn(i,t)),!0)};function hO(i,e){let{state:t}=i,n=t.selection,s=t.selection.ranges.slice();for(let r of t.selection.ranges){let o=t.doc.lineAt(r.head);if(e?o.to<i.state.doc.length:o.from>0)for(let a=r;;){let l=i.moveVertically(a,e);if(l.head<o.from||l.head>o.to){s.some(d=>d.head==l.head)||s.push(l);break}else{if(l.head==a.head)break;a=l}}}return s.length==n.ranges.length?!1:(i.dispatch(Qn(t,j.create(s,s.length-1))),!0)}const a$=i=>hO(i,!1),l$=i=>hO(i,!0),c$=({state:i,dispatch:e})=>{let t=i.selection,n=null;return t.ranges.length>1?n=j.create([t.main]):t.main.empty||(n=j.create([j.cursor(t.main.head)])),n?(e(Qn(i,n)),!0):!1};function Qr(i,e){if(i.state.readOnly)return!1;let t="delete.selection",{state:n}=i,s=n.changeByRange(r=>{let{from:o,to:a}=r;if(o==a){let l=e(r);l<o?(t="delete.backward",l=ro(i,l,!1)):l>o&&(t="delete.forward",l=ro(i,l,!0)),o=Math.min(o,l),a=Math.max(a,l)}else o=ro(i,o,!1),a=ro(i,a,!0);return o==a?{range:r}:{changes:{from:o,to:a},range:j.cursor(o,o<r.head?-1:1)}});return s.changes.empty?!1:(i.dispatch(n.update(s,{scrollIntoView:!0,userEvent:t,effects:t=="delete.selection"?de.announce.of(n.phrase("Selection deleted")):void 0})),!0)}function ro(i,e,t){if(i instanceof de)for(let n of i.state.facet(de.atomicRanges).map(s=>s(i)))n.between(e,e,(s,r)=>{s<e&&r>e&&(e=t?r:s)});return e}const fO=(i,e,t)=>Qr(i,n=>{let s=n.from,{state:r}=i,o=r.doc.lineAt(s),a,l;if(t&&!e&&s>o.from&&s<o.from+200&&!/[^ \t]/.test(a=o.text.slice(0,s-o.from))){if(a[a.length-1]=="	")return s-1;let d=ca(a,r.tabSize),c=d%Go(r)||Go(r);for(let u=0;u<c&&a[a.length-1-u]==" ";u++)s--;l=s}else l=Xt(o.text,s-o.from,e,e)+o.from,l==s&&o.number!=(e?r.doc.lines:1)?l+=e?1:-1:!e&&/[\ufe00-\ufe0f]/.test(o.text.slice(l-o.from,s-o.from))&&(l=Xt(o.text,l-o.from,!1,!1)+o.from);return l}),Rc=i=>fO(i,!1,!0),mO=i=>fO(i,!0,!1),pO=(i,e)=>Qr(i,t=>{let n=t.head,{state:s}=i,r=s.doc.lineAt(n),o=s.charCategorizer(n);for(let a=null;;){if(n==(e?r.to:r.from)){n==t.head&&r.number!=(e?s.doc.lines:1)&&(n+=e?1:-1);break}let l=Xt(r.text,n-r.from,e)+r.from,d=r.text.slice(Math.min(n,l)-r.from,Math.max(n,l)-r.from),c=o(d);if(a!=null&&c!=a)break;(d!=" "||n!=t.head)&&(a=c),n=l}return n}),gO=i=>pO(i,!1),d$=i=>pO(i,!0),u$=i=>Qr(i,e=>{let t=i.lineBlockAt(e.head).to;return e.head<t?t:Math.min(i.state.doc.length,e.head+1)}),h$=i=>Qr(i,e=>{let t=i.moveToLineBoundary(e,!1).head;return e.head>t?t:Math.max(0,e.head-1)}),f$=i=>Qr(i,e=>{let t=i.moveToLineBoundary(e,!0).head;return e.head<t?t:Math.min(i.state.doc.length,e.head+1)}),m$=({state:i,dispatch:e})=>{if(i.readOnly)return!1;let t=i.changeByRange(n=>({changes:{from:n.from,to:n.to,insert:Qe.of(["",""])},range:j.cursor(n.from)}));return e(i.update(t,{scrollIntoView:!0,userEvent:"input"})),!0},p$=({state:i,dispatch:e})=>{if(i.readOnly)return!1;let t=i.changeByRange(n=>{if(!n.empty||n.from==0||n.from==i.doc.length)return{range:n};let s=n.from,r=i.doc.lineAt(s),o=s==r.from?s-1:Xt(r.text,s-r.from,!1)+r.from,a=s==r.to?s+1:Xt(r.text,s-r.from,!0)+r.from;return{changes:{from:o,to:a,insert:i.doc.slice(s,a).append(i.doc.slice(o,s))},range:j.cursor(a)}});return t.changes.empty?!1:(e(i.update(t,{scrollIntoView:!0,userEvent:"move.character"})),!0)};function wa(i){let e=[],t=-1;for(let n of i.selection.ranges){let s=i.doc.lineAt(n.from),r=i.doc.lineAt(n.to);if(!n.empty&&n.to==r.from&&(r=i.doc.lineAt(n.to-1)),t>=s.number){let o=e[e.length-1];o.to=r.to,o.ranges.push(n)}else e.push({from:s.from,to:r.to,ranges:[n]});t=r.number+1}return e}function OO(i,e,t){if(i.readOnly)return!1;let n=[],s=[];for(let r of wa(i)){if(t?r.to==i.doc.length:r.from==0)continue;let o=i.doc.lineAt(t?r.to+1:r.from-1),a=o.length+1;if(t){n.push({from:r.to,to:o.to},{from:r.from,insert:o.text+i.lineBreak});for(let l of r.ranges)s.push(j.range(Math.min(i.doc.length,l.anchor+a),Math.min(i.doc.length,l.head+a)))}else{n.push({from:o.from,to:r.from},{from:r.to,insert:i.lineBreak+o.text});for(let l of r.ranges)s.push(j.range(l.anchor-a,l.head-a))}}return n.length?(e(i.update({changes:n,scrollIntoView:!0,selection:j.create(s,i.selection.mainIndex),userEvent:"move.line"})),!0):!1}const g$=({state:i,dispatch:e})=>OO(i,e,!1),O$=({state:i,dispatch:e})=>OO(i,e,!0);function yO(i,e,t){if(i.readOnly)return!1;let n=[];for(let s of wa(i))t?n.push({from:s.from,insert:i.doc.slice(s.from,s.to)+i.lineBreak}):n.push({from:s.to,insert:i.lineBreak+i.doc.slice(s.from,s.to)});return e(i.update({changes:n,scrollIntoView:!0,userEvent:"input.copyline"})),!0}const y$=({state:i,dispatch:e})=>yO(i,e,!1),b$=({state:i,dispatch:e})=>yO(i,e,!0),v$=i=>{if(i.state.readOnly)return!1;let{state:e}=i,t=e.changes(wa(e).map(({from:s,to:r})=>(s>0?s--:r<e.doc.length&&r++,{from:s,to:r}))),n=Ni(e.selection,s=>{let r;if(i.lineWrapping){let o=i.lineBlockAt(s.head),a=i.coordsAtPos(s.head,s.assoc||1);a&&(r=o.bottom+i.documentTop-a.bottom+i.defaultLineHeight/2)}return i.moveVertically(s,!0,r)}).map(t);return i.dispatch({changes:t,selection:n,scrollIntoView:!0,userEvent:"delete.line"}),!0};function w$(i,e){if(/\(\)|\[\]|\{\}/.test(i.sliceDoc(e-1,e+1)))return{from:e,to:e};let t=Pt(i).resolveInner(e),n=t.childBefore(e),s=t.childAfter(e),r;return n&&s&&n.to<=e&&s.from>=e&&(r=n.type.prop($e.closedBy))&&r.indexOf(s.name)>-1&&i.doc.lineAt(n.to).from==i.doc.lineAt(s.from).from&&!/\S/.test(i.sliceDoc(n.to,s.from))?{from:n.to,to:s.from}:null}const Jh=bO(!1),P$=bO(!0);function bO(i){return({state:e,dispatch:t})=>{if(e.readOnly)return!1;let n=e.changeByRange(s=>{let{from:r,to:o}=s,a=e.doc.lineAt(r),l=!i&&r==o&&w$(e,r);i&&(r=o=(o<=a.to?a:e.doc.lineAt(o)).to);let d=new ma(e,{simulateBreak:r,simulateDoubleBreak:!!l}),c=gg(d,r);for(c==null&&(c=ca(/^\s*/.exec(e.doc.lineAt(r).text)[0],e.tabSize));o<a.to&&/\s/.test(a.text[o-a.from]);)o++;l?{from:r,to:o}=l:r>a.from&&r<a.from+100&&!/\S/.test(a.text.slice(0,r))&&(r=a.from);let u=["",Xo(e,c)];return l&&u.push(Xo(e,d.lineIndent(a.from,-1))),{changes:{from:r,to:o,insert:Qe.of(u)},range:j.cursor(r+1+u[1].length)}});return t(e.update(n,{scrollIntoView:!0,userEvent:"input"})),!0}}function Td(i,e){let t=-1;return i.changeByRange(n=>{let s=[];for(let o=n.from;o<=n.to;){let a=i.doc.lineAt(o);a.number>t&&(n.empty||n.to>a.from)&&(e(a,s,n),t=a.number),o=a.to+1}let r=i.changes(s);return{changes:s,range:j.range(r.mapPos(n.anchor,1),r.mapPos(n.head,1))}})}const S$=({state:i,dispatch:e})=>{if(i.readOnly)return!1;let t=Object.create(null),n=new ma(i,{overrideIndentation:r=>{let o=t[r];return o??-1}}),s=Td(i,(r,o,a)=>{let l=gg(n,r.from);if(l==null)return;/\S/.test(r.text)||(l=0);let d=/^\s*/.exec(r.text)[0],c=Xo(i,l);(d!=c||a.from<r.from+d.length)&&(t[r.from]=l,o.push({from:r.from,to:r.from+d.length,insert:c}))});return s.changes.empty||e(i.update(s,{userEvent:"indent"})),!0},k$=({state:i,dispatch:e})=>i.readOnly?!1:(e(i.update(Td(i,(t,n)=>{n.push({from:t.from,insert:i.facet(fa)})}),{userEvent:"input.indent"})),!0),x$=({state:i,dispatch:e})=>i.readOnly?!1:(e(i.update(Td(i,(t,n)=>{let s=/^\s*/.exec(t.text)[0];if(!s)return;let r=ca(s,i.tabSize),o=0,a=Xo(i,Math.max(0,r-Go(i)));for(;o<s.length&&o<a.length&&s.charCodeAt(o)==a.charCodeAt(o);)o++;n.push({from:t.from+o,to:t.from+s.length,insert:a.slice(o)})}),{userEvent:"delete.dedent"})),!0),$$=i=>(i.setTabFocusMode(),!0),M$=[{key:"Ctrl-b",run:Hg,shift:rO,preventDefault:!0},{key:"Ctrl-f",run:Yg,shift:oO},{key:"Ctrl-p",run:eO,shift:cO},{key:"Ctrl-n",run:tO,shift:dO},{key:"Ctrl-a",run:Fx,shift:n$},{key:"Ctrl-e",run:Gx,shift:s$},{key:"Ctrl-d",run:mO},{key:"Ctrl-h",run:Rc},{key:"Ctrl-k",run:u$},{key:"Ctrl-Alt-h",run:gO},{key:"Ctrl-o",run:m$},{key:"Ctrl-t",run:p$},{key:"Ctrl-v",run:Qc}],C$=[{key:"ArrowLeft",run:Hg,shift:rO,preventDefault:!0},{key:"Mod-ArrowLeft",mac:"Alt-ArrowLeft",run:_x,shift:Wx,preventDefault:!0},{mac:"Cmd-ArrowLeft",run:Zx,shift:e$,preventDefault:!0},{key:"ArrowRight",run:Yg,shift:oO,preventDefault:!0},{key:"Mod-ArrowRight",mac:"Alt-ArrowRight",run:Ix,shift:qx,preventDefault:!0},{mac:"Cmd-ArrowRight",run:jx,shift:t$,preventDefault:!0},{key:"ArrowUp",run:eO,shift:cO,preventDefault:!0},{mac:"Cmd-ArrowUp",run:qh,shift:Yh},{mac:"Ctrl-ArrowUp",run:Xh,shift:Uh},{key:"ArrowDown",run:tO,shift:dO,preventDefault:!0},{mac:"Cmd-ArrowDown",run:Hh,shift:Kh},{mac:"Ctrl-ArrowDown",run:Qc,shift:Wh},{key:"PageUp",run:Xh,shift:Uh},{key:"PageDown",run:Qc,shift:Wh},{key:"Home",run:Vx,shift:Jx,preventDefault:!0},{key:"Mod-Home",run:qh,shift:Yh},{key:"End",run:zx,shift:Kx,preventDefault:!0},{key:"Mod-End",run:Hh,shift:Kh},{key:"Enter",run:Jh,shift:Jh},{key:"Mod-a",run:i$},{key:"Backspace",run:Rc,shift:Rc,preventDefault:!0},{key:"Delete",run:mO,preventDefault:!0},{key:"Mod-Backspace",mac:"Alt-Backspace",run:gO,preventDefault:!0},{key:"Mod-Delete",mac:"Alt-Delete",run:d$,preventDefault:!0},{mac:"Mod-Backspace",run:h$,preventDefault:!0},{mac:"Mod-Delete",run:f$,preventDefault:!0}].concat(M$.map(i=>({mac:i.key,run:i.run,shift:i.shift}))),E$=[{key:"Alt-ArrowLeft",mac:"Ctrl-ArrowLeft",run:Bx,shift:Hx},{key:"Alt-ArrowRight",mac:"Ctrl-ArrowRight",run:Dx,shift:Yx},{key:"Alt-ArrowUp",run:g$},{key:"Shift-Alt-ArrowUp",run:y$},{key:"Alt-ArrowDown",run:O$},{key:"Shift-Alt-ArrowDown",run:b$},{key:"Mod-Alt-ArrowUp",run:a$},{key:"Mod-Alt-ArrowDown",run:l$},{key:"Escape",run:c$},{key:"Mod-Enter",run:P$},{key:"Alt-l",mac:"Ctrl-l",run:r$},{key:"Mod-i",run:o$,preventDefault:!0},{key:"Mod-[",run:x$},{key:"Mod-]",run:k$},{key:"Mod-Alt-\\",run:S$},{key:"Shift-Mod-k",run:v$},{key:"Shift-Mod-\\",run:Ux},{key:"Mod-/",run:gx},{key:"Alt-A",run:yx},{key:"Ctrl-m",mac:"Shift-Alt-m",run:$$}].concat(C$),ef=typeof String.prototype.normalize=="function"?i=>i.normalize("NFKD"):i=>i;class vO{constructor(e,t,n=0,s=e.length,r,o){this.test=o,this.value={from:0,to:0},this.done=!1,this.matches=[],this.buffer="",this.bufferPos=0,this.iter=e.iterRange(n,s),this.bufferStart=n,this.normalize=r?a=>r(ef(a)):ef,this.query=this.normalize(t)}peek(){if(this.bufferPos==this.buffer.length){if(this.bufferStart+=this.buffer.length,this.iter.next(),this.iter.done)return-1;this.bufferPos=0,this.buffer=this.iter.value}return ei(this.buffer,this.bufferPos)}next(){for(;this.matches.length;)this.matches.pop();return this.nextOverlapping()}nextOverlapping(){for(;;){let e=this.peek();if(e<0)return this.done=!0,this;let t=Gm(e),n=this.bufferStart+this.bufferPos;this.bufferPos+=xr(e);let s=this.normalize(t);if(s.length)for(let r=0,o=n;;r++){let a=s.charCodeAt(r),l=this.match(a,o,this.bufferPos+this.bufferStart);if(r==s.length-1){if(l)return this.value=l,this;break}o==n&&r<t.length&&t.charCodeAt(r)==a&&o++}}}match(e,t,n){let s=null;for(let r=0;r<this.matches.length;r+=2){let o=this.matches[r],a=!1;this.query.charCodeAt(o)==e&&(o==this.query.length-1?s={from:this.matches[r+1],to:n}:(this.matches[r]++,a=!0)),a||(this.matches.splice(r,2),r-=2)}return this.query.charCodeAt(0)==e&&(this.query.length==1?s={from:t,to:n}:this.matches.push(1,t)),s&&this.test&&!this.test(s.from,s.to,this.buffer,this.bufferStart)&&(s=null),s}}typeof Symbol<"u"&&(vO.prototype[Symbol.iterator]=function(){return this});const A$={highlightWordAroundCursor:!1,minSelectionLength:1,maxMatches:100,wholeWords:!1},T$=he.define({combine(i){return $r(i,A$,{highlightWordAroundCursor:(e,t)=>e||t,minSelectionLength:Math.min,maxMatches:Math.min})}});function N$(i){return[L$,I$]}const Q$=ke.mark({class:"cm-selectionMatch"}),R$=ke.mark({class:"cm-selectionMatch cm-selectionMatch-main"});function tf(i,e,t,n){return(t==0||i(e.sliceDoc(t-1,t))!=Dt.Word)&&(n==e.doc.length||i(e.sliceDoc(n,n+1))!=Dt.Word)}function _$(i,e,t,n){return i(e.sliceDoc(t,t+1))==Dt.Word&&i(e.sliceDoc(n-1,n))==Dt.Word}const I$=ts.fromClass(class{constructor(i){this.decorations=this.getDeco(i)}update(i){(i.selectionSet||i.docChanged||i.viewportChanged)&&(this.decorations=this.getDeco(i.view))}getDeco(i){let e=i.state.facet(T$),{state:t}=i,n=t.selection;if(n.ranges.length>1)return ke.none;let s=n.main,r,o=null;if(s.empty){if(!e.highlightWordAroundCursor)return ke.none;let l=t.wordAt(s.head);if(!l)return ke.none;o=t.charCategorizer(s.head),r=t.sliceDoc(l.from,l.to)}else{let l=s.to-s.from;if(l<e.minSelectionLength||l>200)return ke.none;if(e.wholeWords){if(r=t.sliceDoc(s.from,s.to),o=t.charCategorizer(s.head),!(tf(o,t,s.from,s.to)&&_$(o,t,s.from,s.to)))return ke.none}else if(r=t.sliceDoc(s.from,s.to),!r)return ke.none}let a=[];for(let l of i.visibleRanges){let d=new vO(t.doc,r,l.from,l.to);for(;!d.next().done;){let{from:c,to:u}=d.value;if((!o||tf(o,t,c,u))&&(s.empty&&c<=s.from&&u>=s.to?a.push(R$.range(c,u)):(c>=s.to||u<=s.from)&&a.push(Q$.range(c,u)),a.length>e.maxMatches))return ke.none}}return ke.set(a)}},{decorations:i=>i.decorations}),L$=de.baseTheme({".cm-selectionMatch":{backgroundColor:"#99ff7780"},".cm-searchMatch .cm-selectionMatch":{backgroundColor:"transparent"}}),B$=new Map,D$=Ve.define(),z$=mn.define({create(){return ke.none},update(i,e){e.docChanged&&(i=i.map(e.changes));for(const t of e.effects)if(t.is(D$))return t.value;return i},provide:i=>de.decorations.from(i)});ke.mark({class:"cm-master-highlight"});function V$(i,e={}){const{theme:t="light",placeholder:n="",lineNumbers:s=!0,autofocus:r=!1,onUpdate:o=null}=e,a=i.value||"",l=[s?hh():[],xx(),tk(),fk(),Ik(),N$(),yd.of([...zk,...E$,...Rx,...YS]),tx(),de.lineWrapping,de.updateListener.of(c=>{if(c.docChanged&&o){const u=c.state.doc.toString();o(u)}if(c.docChanged){const u=c.state.doc.toString();i.value=u;const h=new Event("input",{bubbles:!0});i.dispatchEvent(h)}}),de.contentAttributes.of({"data-placeholder":n}),de.baseTheme({"&.cm-editor":{outline:"none",position:"relative",boxSizing:"border-box"},".cm-scroller":{display:"flex !important",alignItems:"flex-start !important",fontFamily:"monospace",lineHeight:"1.4",height:"100%",overflowX:"auto",position:"relative",zIndex:"0"},".cm-content":{margin:"0",flexGrow:"2",flexShrink:"0",display:"block",whiteSpace:"pre",wordWrap:"normal",boxSizing:"border-box",padding:"4px 0",outline:"none",minHeight:"120px"},".cm-lineWrapping":{whiteSpace:"pre-wrap",overflowWrap:"anywhere"},".cm-line":{display:"block",padding:"0 2px 0 6px"},".cm-gutters":{flexShrink:"0",display:"flex",height:"100%",boxSizing:"border-box",left:"0",zIndex:"200"},".cm-gutter":{display:"flex !important",flexDirection:"column",flexShrink:"0",boxSizing:"border-box",minHeight:"100%",overflow:"hidden"},".cm-gutterElement":{boxSizing:"border-box"},".cm-lineNumbers .cm-gutterElement":{padding:"0 3px 0 5px",minWidth:"20px",textAlign:"right",color:"#999",whiteSpace:"nowrap"}}),de.theme({"&.cm-editor":{fontSize:"14px",fontFamily:"'Courier New', Courier, monospace",border:"1px solid rgba(102, 126, 234, 0.25)",borderRadius:"12px",backgroundColor:"rgba(255, 255, 255, 0.9)",boxShadow:"inset 0 0 0 1px rgba(255, 255, 255, 0.5)",overflow:"hidden"},".cm-content":{minHeight:"120px",padding:"8px",caretColor:"#000"},".cm-focused":{outline:"none"},".cm-editor.cm-focused":{borderColor:"#667eea",backgroundColor:"#fff",boxShadow:"inset 0 0 0 1px rgba(255, 255, 255, 0.5), 0 0 0 2px rgba(102, 126, 234, 0.2)"},".cm-placeholder":{color:"#999",fontStyle:"italic"},".cm-gutters":{backgroundColor:"rgba(245, 245, 245, 0.5)",color:"#999",border:"none",borderRight:"1px solid rgba(102, 126, 234, 0.15)"}})];l.push(z$),t==="dark"&&l.push(px),hh||l.push(de.lineWrapping);let d;try{d=new de({doc:a,extensions:l}),i.style.display="none",i.parentNode.insertBefore(d.dom,i),console.log(`   Editor DOM created and inserted for ${i.id||"textarea"}`)}catch(c){return console.error("❌ Error creating Strudel REPL editor:",c),console.error("   Error details:",c.message,c.stack),null}return d&&(d.getTextarea=()=>i,d.getValue=()=>d.state.doc.toString(),d.setValue=c=>{if(d.state.doc.toString()!==c){d.dispatch({changes:{from:0,to:d.state.doc.length,insert:c||""}}),i.value=c||"";const h=new Event("input",{bubbles:!0});i.dispatchEvent(h)}}),r&&d.focus(),d}function Z$(){try{console.log("🎨 Initializing Strudel REPL editors...");const i=document.querySelectorAll("textarea[data-strudel-repl], #modal-pattern, #master-pattern");console.log(`   Found ${i.length} textareas to initialize:`,Array.from(i).map(e=>e.id||"unnamed")),i.forEach(e=>{if(e.tagName==="TEXTAREA"&&!e.dataset.strudelReplInitialized){const t=e.id==="modal-pattern",n=e.id==="master-pattern";console.log(`   Initializing editor for: ${e.id||"unnamed textarea"}`);const s=e.placeholder||"";try{const r=V$(e,{theme:"light",placeholder:s,lineNumbers:!0,autofocus:!1,onUpdate:o=>{e.value=o}});r?(e.dataset.strudelReplInitialized="true",e._strudelEditor=r,B$.set(e.id,r),console.log(`   ✅ Successfully created editor for ${e.id||"textarea"}`)):console.warn(`   ⚠️ Editor creation returned null for ${e.id||"textarea"}`)}catch(r){console.error(`   ❌ Error creating editor for ${e.id||"textarea"}:`,r)}}else e.dataset.strudelReplInitialized&&console.log(`   ⏭️ Skipping ${e.id||"unnamed"} - already initialized`)}),console.log("✅ Strudel REPL editors initialization complete")}catch(i){console.error("❌ Error initializing Strudel REPL editors:",i)}}function Pa(i){const e=typeof i=="string"?document.getElementById(i):i;return e&&e._strudelEditor||null}function Ae(i){const e=Pa(i);if(e&&e.getValue)return e.getValue();const t=typeof i=="string"?document.getElementById(i):i;return t?t.value:""}function Fe(i,e){const t=Pa(i);if(t&&t.setValue){t.setValue(e);return}const n=typeof i=="string"?document.getElementById(i):i;if(n){n.value=e;const s=new Event("input",{bubbles:!0});n.dispatchEvent(s)}}function j$(i,e){const t=Pa(i),n=document.getElementById(i);t&&t.contentDOM&&(t.contentDOM.setAttribute("contenteditable",e?"true":"false"),t.dom.classList.toggle("cm-readonly",!e)),n&&(n.readOnly=!e,n.classList.toggle("pattern-editor-readonly",!e))}function nf(i,e,t={}){if(!e||typeof e!="string")return;const n=typeof t.cursorOffset=="number"?t.cursorOffset:null,s=Pa(i);if(s){const f=s,{state:m}=f,g=m.selection.main,O=g.from,p=g.to,y=sf(e,()=>{let b=O;for(;b>0;){const S=m.doc.sliceString(b-1,b);if(b-=1,!/\s/.test(S))return S}return""}),M=n!==null?n:y.endsWith("()")||y.endsWith("{}")?1:0;f.dispatch({changes:{from:O,to:p,insert:y},selection:j.cursor(Math.max(O+y.length-M,0)),scrollIntoView:!0}),f.focus();return}const r=document.getElementById(i);if(!r)return;const o=typeof r.selectionStart=="number"?r.selectionStart:r.value.length,a=typeof r.selectionEnd=="number"?r.selectionEnd:r.value.length,l=r.value.slice(0,o),d=r.value.slice(a),c=sf(e,()=>{let f=o;for(;f>0;){const m=r.value.charAt(f-1);if(f-=1,!/\s/.test(m))return m}return""});r.value=`${l}${c}${d}`;const u=n!==null?n:c.endsWith("()")||c.endsWith("{}")?1:0,h=Math.max(o+c.length-u,0);typeof r.setSelectionRange=="function"&&r.setSelectionRange(h,h),r.dispatchEvent(new Event("input",{bubbles:!0})),r.focus()}function sf(i,e){if(!i||i.trimStart().startsWith(".")||/^\s/.test(i))return i;const n=typeof e=="function"?e():"";return!n||n==="."||/\s/.test(n)||/[\(\[\{,]/.test(n)?i:`.${i}`}class F${constructor(){this.modal=null,this.onLoginSuccess=null}init(){this.createModal(),this.attachEventListeners(),this.checkAuthStatus()}createModal(){document.body.insertAdjacentHTML("beforeend",`
      <div class="login-modal-overlay" id="login-modal-overlay" style="display: none;">
        <div class="login-modal">
          <div class="login-modal-header">
            <h2>Login to Strudesk 4000</h2>
            <button class="login-modal-close" id="login-modal-close" aria-label="Close">&times;</button>
          </div>
          <div class="login-modal-body">
            <p>Sign in to save and share your patterns</p>
            <div class="login-buttons">
              <button class="login-button login-button-google" id="login-google">
                <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                  <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
                  <path d="M9 18c2.43 0 4.467-.806 5.965-2.18l-2.908-2.258c-.806.54-1.837.86-3.057.86-2.35 0-4.34-1.587-5.053-3.72H.957v2.332C2.438 15.983 5.482 18 9 18z" fill="#34A853"/>
                  <path d="M3.947 10.712c-.18-.54-.282-1.117-.282-1.712s.102-1.172.282-1.712V4.956H.957C.348 6.174 0 7.55 0 9s.348 2.826.957 4.044l2.99-2.332z" fill="#FBBC05"/>
                  <path d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.956L3.947 7.288C4.66 5.153 6.65 3.58 9 3.58z" fill="#EA4335"/>
                </svg>
                Continue with Google
              </button>
              <button class="login-button login-button-github" id="login-github">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Continue with GitHub
              </button>
            </div>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("login-modal-overlay")}attachEventListeners(){const e=document.getElementById("login-modal-close");e&&e.addEventListener("click",()=>this.hide()),this.modal&&this.modal.addEventListener("click",r=>{r.target===this.modal&&this.hide()});const t=document.getElementById("login-google");t&&t.addEventListener("click",async()=>{const{authAPI:r}=await We(async()=>{const{authAPI:o}=await Promise.resolve().then(()=>qn);return{authAPI:o}},void 0);window.location.href=r.getGoogleLoginUrl()});const n=document.getElementById("login-github");n&&n.addEventListener("click",async()=>{const{authAPI:r}=await We(async()=>{const{authAPI:o}=await Promise.resolve().then(()=>qn);return{authAPI:o}},void 0);window.location.href=r.getGithubLoginUrl()}),new URLSearchParams(window.location.search).get("auth")==="success"&&(this.checkAuthStatus(),window.history.replaceState({},document.title,window.location.pathname))}async checkAuthStatus(){try{const{getCurrentUser:e}=await We(async()=>{const{getCurrentUser:n}=await Promise.resolve().then(()=>qn);return{getCurrentUser:n}},void 0),t=await e();t&&this.onLoginSuccess&&this.onLoginSuccess(t)}catch{}}show(){this.modal&&(this.modal.style.display="flex",document.body.style.overflow="hidden")}hide(){this.modal&&(this.modal.style.display="none",document.body.style.overflow="")}setOnLoginSuccess(e){this.onLoginSuccess=e}}const _c="/api";class ll extends Error{constructor(e,t,n){super(e),this.status=t,this.data=n}}async function fn(i,e={}){const t=`${_c}${i}`,n={...e,credentials:"include",headers:{"Content-Type":"application/json",...e.headers}};try{const s=await fetch(t,n),r=await s.json().catch(()=>({}));if(!s.ok)throw new ll(r.error||"Request failed",s.status,r);return r}catch(s){throw s instanceof ll?s:new ll(s.message||"Network error",0,null)}}const Nd={async getCurrentUser(){return fn("/auth/me")},async logout(){return fn("/auth/logout",{method:"POST"})},getGoogleLoginUrl(){return`${_c}/auth/google`},getGithubLoginUrl(){return`${_c}/auth/github`}},Ho={async listUsers(i="",e=50){const t=new URLSearchParams;return i&&t.append("search",i),t.append("limit",e),fn(`/users?${t.toString()}`)},async getUser(i){return fn(`/users/${i}`)},async updateUser(i,e){return fn(`/users/${i}`,{method:"PUT",body:JSON.stringify(e)})},async searchUsers(i){return fn(`/users/search/${encodeURIComponent(i)}`)}},Ic={async createPattern(i){return fn("/patterns",{method:"POST",body:JSON.stringify(i)})},async getPatterns(i={}){const e=new URLSearchParams;i.type&&e.append("type",i.type),i.isPublic!==void 0&&e.append("isPublic",i.isPublic),i.shared!==void 0&&e.append("shared",i.shared);const t=e.toString();return fn(`/patterns${t?`?${t}`:""}`)},async getPattern(i){return fn(`/patterns/${i}`)},async updatePattern(i,e){return fn(`/patterns/${i}`,{method:"PUT",body:JSON.stringify(e)})},async deletePattern(i){return fn(`/patterns/${i}`,{method:"DELETE"})},async sharePattern(i,e){return fn(`/patterns/${i}/share`,{method:"POST",body:JSON.stringify({userIds:e})})},async getPatternUsers(i){return fn(`/patterns/${i}/users`)}};async function Sa(){try{return await Nd.getCurrentUser()}catch{return null}}const qn=Object.freeze(Object.defineProperty({__proto__:null,authAPI:Nd,getCurrentUser:Sa,patternsAPI:Ic,usersAPI:Ho},Symbol.toStringTag,{value:"Module"}));class G${constructor(){this.modal=null,this.user=null,this.onUpdate=null}init(){this.createModal(),this.attachEventListeners()}createModal(){document.body.insertAdjacentHTML("beforeend",`
      <div class="user-profile-modal-overlay" id="user-profile-modal-overlay" style="display: none;">
        <div class="user-profile-modal">
          <div class="user-profile-modal-header">
            <h2>Edit Profile</h2>
            <button class="user-profile-modal-close" id="user-profile-modal-close" aria-label="Close">&times;</button>
          </div>
          <div class="user-profile-modal-body">
            <form id="user-profile-form">
              <div class="form-group">
                <label for="profile-avatar-url">Profile Image</label>
                <div class="avatar-preview-container">
                  <img id="profile-avatar-preview" src="" alt="Avatar preview" style="display: none; width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid #ddd;" />
                  <input type="url" id="profile-avatar-url" placeholder="https://example.com/your-image.jpg" />
                  <small>Enter a URL to your profile image</small>
                </div>
              </div>

              <div class="form-group">
                <label for="profile-artist-name">Artist Name (Pseudonym)</label>
                <input type="text" id="profile-artist-name" placeholder="Your artist name or pseudonym" />
                <small>This will be used as the default copyright holder for your patterns</small>
              </div>

              <div class="form-group">
                <label>Social Media Links</label>
                <div class="social-links-grid">
                  <div class="social-link-item">
                    <label for="social-twitter">Twitter/X</label>
                    <input type="url" id="social-twitter" placeholder="https://twitter.com/username" />
                  </div>
                  <div class="social-link-item">
                    <label for="social-instagram">Instagram</label>
                    <input type="url" id="social-instagram" placeholder="https://instagram.com/username" />
                  </div>
                  <div class="social-link-item">
                    <label for="social-soundcloud">SoundCloud</label>
                    <input type="url" id="social-soundcloud" placeholder="https://soundcloud.com/username" />
                  </div>
                  <div class="social-link-item">
                    <label for="social-bandcamp">Bandcamp</label>
                    <input type="url" id="social-bandcamp" placeholder="https://username.bandcamp.com" />
                  </div>
                  <div class="social-link-item">
                    <label for="social-youtube">YouTube</label>
                    <input type="url" id="social-youtube" placeholder="https://youtube.com/@username" />
                  </div>
                  <div class="social-link-item">
                    <label for="social-spotify">Spotify</label>
                    <input type="url" id="social-spotify" placeholder="https://open.spotify.com/artist/..." />
                  </div>
                  <div class="social-link-item">
                    <label for="social-website">Website</label>
                    <input type="url" id="social-website" placeholder="https://yourwebsite.com" />
                  </div>
                </div>
              </div>

              <div class="form-group">
                <div class="user-profile-info">
                  <p><strong>Name:</strong> <span id="profile-display-name"></span></p>
                  <p><strong>Email:</strong> <span id="profile-display-email"></span></p>
                </div>
              </div>

              <div class="user-profile-modal-footer">
                <button type="button" class="btn-cancel" id="profile-cancel-btn">Cancel</button>
                <button type="submit" class="btn-save" id="profile-save-btn">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("user-profile-modal-overlay")}attachEventListeners(){const e=document.getElementById("user-profile-modal-close");e&&e.addEventListener("click",()=>this.hide());const t=document.getElementById("profile-cancel-btn");t&&t.addEventListener("click",()=>this.hide()),this.modal&&this.modal.addEventListener("click",s=>{s.target===this.modal&&this.hide()});const n=document.getElementById("user-profile-form");n&&n.addEventListener("submit",async s=>{s.preventDefault(),await this.saveProfile()})}async loadUserData(){try{const e=await Sa();if(!e)throw new Error("Not authenticated");this.user=e;const t=await Ho.getUser(e.id);this.user=t;const n=document.getElementById("profile-avatar-url"),s=document.getElementById("profile-avatar-preview");n&&(n.value=t.avatarUrl||"",n.addEventListener("input",c=>{const u=c.target.value.trim();s&&(u?(s.src=u,s.style.display="block",s.onerror=()=>{s.style.display="none"}):s.style.display="none")}),t.avatarUrl&&s&&(s.src=t.avatarUrl,s.style.display="block",s.onerror=()=>{s.style.display="none"}));const r=document.getElementById("profile-artist-name");r&&(r.value=t.artistName||"");const o=document.getElementById("profile-display-name");o&&(o.textContent=t.name);const a=document.getElementById("profile-display-email");a&&(a.textContent=t.email);const l=t.socialLinks||{};return["twitter","instagram","soundcloud","bandcamp","youtube","spotify","website"].forEach(c=>{const u=document.getElementById(`social-${c}`);u&&(u.value=l[c]||"")}),t}catch(e){return console.error("Error loading user data:",e),alert("Failed to load profile data"),null}}async saveProfile(){var e,t;if(!this.user){alert("User not loaded");return}try{const n=((e=document.getElementById("profile-avatar-url"))==null?void 0:e.value.trim())||null,s=((t=document.getElementById("profile-artist-name"))==null?void 0:t.value.trim())||null,r={};["twitter","instagram","soundcloud","bandcamp","youtube","spotify","website"].forEach(l=>{const d=document.getElementById(`social-${l}`);d&&d.value.trim()&&(r[l]=d.value.trim())});const a=await Ho.updateUser(this.user.id,{avatarUrl:n,artistName:s,socialLinks:r});this.user=a,this.onUpdate&&this.onUpdate(a),this.hide(),alert("Profile updated successfully!")}catch(n){console.error("Error saving profile:",n),alert("Failed to save profile: "+(n.message||"Unknown error"))}}async show(){this.modal&&(await this.loadUserData(),this.modal.style.display="flex",document.body.style.overflow="hidden")}hide(){this.modal&&(this.modal.style.display="none",document.body.style.overflow="")}setOnUpdate(e){this.onUpdate=e}}class X${constructor(){this.modal=null,this.users=[],this.searchTimeout=null}init(){this.createModal(),this.attachEventListeners()}createModal(){document.body.insertAdjacentHTML("beforeend",`
      <div class="user-profiles-modal-overlay" id="user-profiles-modal-overlay" style="display: none;">
        <div class="user-profiles-modal">
          <div class="user-profiles-modal-header">
            <h2>User Profiles</h2>
            <button class="user-profiles-modal-close" id="user-profiles-modal-close" aria-label="Close">&times;</button>
          </div>
          <div class="user-profiles-modal-body">
            <div class="profiles-search-container">
              <input 
                type="text" 
                id="profiles-search-input" 
                placeholder="Search users by name, email, or artist name..." 
                class="profiles-search-input"
              />
            </div>
            <div class="profiles-list" id="profiles-list">
              <div class="profiles-loading">Loading profiles...</div>
            </div>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("user-profiles-modal-overlay")}attachEventListeners(){const e=document.getElementById("user-profiles-modal-close");e&&e.addEventListener("click",()=>this.hide()),this.modal&&this.modal.addEventListener("click",n=>{n.target===this.modal&&this.hide()});const t=document.getElementById("profiles-search-input");t&&t.addEventListener("input",n=>{const s=n.target.value.trim();clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.loadUsers(s)},300)})}async loadUsers(e=""){const t=document.getElementById("profiles-list");if(t)try{t.innerHTML='<div class="profiles-loading">Loading profiles...</div>';const n=await Ho.listUsers(e,100);if(this.users=n,n.length===0){t.innerHTML='<div class="profiles-empty">No users found.</div>';return}t.innerHTML=n.map(s=>this.renderUserCard(s)).join("")}catch(n){console.error("Error loading users:",n),t.innerHTML='<div class="profiles-error">Failed to load profiles. Please try again.</div>'}}renderUserCard(e){var a;const t=e.avatarUrl||"https://via.placeholder.com/80?text="+encodeURIComponent(e.name.charAt(0).toUpperCase()),n=e.artistName?`<div class="user-card-artist">${this.escapeHtml(e.artistName)}</div>`:"",s=((a=e._count)==null?void 0:a.patterns)||0,r=e.socialLinks||{},o=this.renderSocialLinks(r);return`
      <div class="user-card" data-user-id="${e.id}">
        <div class="user-card-avatar">
          <img src="${t}" alt="${this.escapeHtml(e.name)}" onerror="this.src='https://via.placeholder.com/80?text=' + encodeURIComponent('${this.escapeHtml(e.name.charAt(0).toUpperCase())}')" />
        </div>
        <div class="user-card-info">
          <div class="user-card-name">${this.escapeHtml(e.name)}</div>
          ${n}
          <div class="user-card-email">${this.escapeHtml(e.email)}</div>
          <div class="user-card-stats">
            <span class="user-card-patterns">${s} pattern${s!==1?"s":""}</span>
          </div>
          ${o}
        </div>
      </div>
    `}getSocialIcon(e){return{twitter:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>',instagram:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>',soundcloud:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M1.175 13.5c-.619 0-1.125-.506-1.125-1.125s.506-1.125 1.125-1.125h1.125v2.25H1.175zm2.25-3c-.619 0-1.125-.506-1.125-1.125S2.806 8.25 3.425 8.25h1.125v2.25H3.425zm2.25-2.25c-.619 0-1.125-.506-1.125-1.125S5.056 6 5.675 6h1.125v2.25H5.675zm2.25-1.5c-.619 0-1.125-.506-1.125-1.125S7.306 4.5 7.925 4.5H9.05v2.25H7.925zm2.25-1.5c-.619 0-1.125-.506-1.125-1.125S9.556 3 10.175 3h1.125v2.25h-1.125zm2.25 0c-.619 0-1.125-.506-1.125-1.125S11.806 3 12.425 3h1.125v2.25h-1.125zm2.25 1.5c-.619 0-1.125-.506-1.125-1.125S14.056 4.5 14.675 4.5h1.125v2.25h-1.125zm2.25 1.5c-.619 0-1.125-.506-1.125-1.125S16.306 6 16.925 6h1.125v2.25h-1.125zm2.25 2.25c-.619 0-1.125-.506-1.125-1.125S18.556 8.25 19.175 8.25h1.125v2.25h-1.125zm2.25 3c-.619 0-1.125-.506-1.125-1.125S20.806 11.25 21.425 11.25h1.125v2.25h-1.125z"/></svg>',bandcamp:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M0 18.75l7.5-7.5L0 3.75V0h24v3.75L16.5 11.25l7.5 7.5V24H0v-5.25z"/></svg>',youtube:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>',spotify:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.84-.179-.84-.66 0-.419.36-.66.78-.54 4.56 1.021 8.52 1.561 11.64 1.92.42.06.66.36.6.78zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.42 1.56-.3.421-1.02.599-1.56.3z"/></svg>',website:'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM18.92 8h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.9-4.33-3.56zm2.95-8H5.08c.96-1.66 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg>'}[e]||'<svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>'}renderSocialLinks(e){const t=[];return Object.entries(e).forEach(([n,s])=>{if(s){const r=this.getSocialIcon(n);t.push(`<a href="${this.escapeHtml(s)}" target="_blank" rel="noopener noreferrer" class="user-card-social-link" title="${n}">${r}</a>`)}}),t.length===0?"":`<div class="user-card-social">${t.join("")}</div>`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}async show(){if(this.modal){this.modal.style.display="flex",document.body.style.overflow="hidden",await this.loadUsers();const e=document.getElementById("profiles-search-input");e&&setTimeout(()=>e.focus(),100)}}hide(){if(this.modal){this.modal.style.display="none",document.body.style.overflow="";const e=document.getElementById("profiles-search-input");e&&(e.value="")}}}class U${constructor(){this.modal=null,this.onSave=null,this.currentPattern=null,this.patternType=null,this.elementId=null,this.selectedUsers=[]}init(){this.createModal(),this.attachEventListeners()}createModal(){document.body.insertAdjacentHTML("beforeend",`
      <div class="save-pattern-modal-overlay" id="save-pattern-modal-overlay" style="display: none;">
        <div class="save-pattern-modal">
          <div class="save-pattern-modal-header">
            <h2>Save Pattern</h2>
            <button class="save-pattern-modal-close" id="save-pattern-modal-close" aria-label="Close">&times;</button>
          </div>
          <div class="save-pattern-modal-body">
            <form id="save-pattern-form">
              <div class="form-group">
                <label for="save-pattern-title">Title (optional)</label>
                <input type="text" id="save-pattern-title" placeholder="e.g., My Awesome Beat" />
              </div>

              <div class="form-group">
                <label for="save-pattern-artist">Artist Name (optional)</label>
                <input type="text" id="save-pattern-artist" placeholder="Leave empty to use your default artist name" />
                <small>Override your default artist name for this pattern</small>
              </div>

              <div class="form-group">
                <label for="save-pattern-version-name">Version Name (optional)</label>
                <input type="text" id="save-pattern-version-name" placeholder="e.g., Remix, Live, Studio" />
                <small>Add a label to this version (version number is automatic)</small>
              </div>

              <div class="form-group" id="save-pattern-genre-group" style="display: none;">
                <label for="save-pattern-genre">Genre/Style (optional)</label>
                <select id="save-pattern-genre">
                  <option value="">Select a genre...</option>
                  <optgroup label="Electronic">
                    <option value="Techno">Techno</option>
                    <option value="House">House</option>
                    <option value="Trance">Trance</option>
                    <option value="Dubstep">Dubstep</option>
                    <option value="Drum & Bass">Drum & Bass</option>
                    <option value="Ambient">Ambient</option>
                    <option value="IDM">IDM</option>
                    <option value="Electro">Electro</option>
                    <option value="Synthwave">Synthwave</option>
                    <option value="Industrial">Industrial</option>
                  </optgroup>
                  <optgroup label="Hip Hop & Urban">
                    <option value="Hip Hop">Hip Hop</option>
                    <option value="Trap">Trap</option>
                    <option value="R&B">R&B</option>
                    <option value="Grime">Grime</option>
                    <option value="Drill">Drill</option>
                  </optgroup>
                  <optgroup label="Rock & Alternative">
                    <option value="Rock">Rock</option>
                    <option value="Alternative">Alternative</option>
                    <option value="Indie">Indie</option>
                    <option value="Punk">Punk</option>
                    <option value="Metal">Metal</option>
                    <option value="Post-Rock">Post-Rock</option>
                  </optgroup>
                  <optgroup label="Jazz & Blues">
                    <option value="Jazz">Jazz</option>
                    <option value="Blues">Blues</option>
                    <option value="Smooth Jazz">Smooth Jazz</option>
                    <option value="Bebop">Bebop</option>
                    <option value="Fusion">Fusion</option>
                  </optgroup>
                  <optgroup label="World & Folk">
                    <option value="World">World</option>
                    <option value="Folk">Folk</option>
                    <option value="Traditional">Traditional</option>
                    <option value="Ethnic">Ethnic</option>
                  </optgroup>
                  <optgroup label="Pop & Dance">
                    <option value="Pop">Pop</option>
                    <option value="Dance">Dance</option>
                    <option value="EDM">EDM</option>
                    <option value="Disco">Disco</option>
                    <option value="Funk">Funk</option>
                  </optgroup>
                  <optgroup label="Experimental">
                    <option value="Experimental">Experimental</option>
                    <option value="Noise">Noise</option>
                    <option value="Avant-garde">Avant-garde</option>
                    <option value="Minimal">Minimal</option>
                  </optgroup>
                  <optgroup label="Other">
                    <option value="Cinematic">Cinematic</option>
                    <option value="Game Music">Game Music</option>
                    <option value="Other">Other</option>
                  </optgroup>
                </select>
                <small>Select a genre to help with pattern matching and discovery</small>
              </div>

              <div class="form-group">
                <label class="privacy-toggle-label">
                  <input type="checkbox" id="save-pattern-public" />
                  <span>Make this pattern public</span>
                </label>
                <small>Public patterns can be seen and used by all users</small>
              </div>

              <div class="form-group" id="save-pattern-share-group" style="display: none;">
                <label>Share with specific users (optional)</label>
                <div class="user-search-container">
                  <input type="text" id="save-pattern-user-search" placeholder="Search users by name or email..." />
                  <div class="user-search-results" id="save-pattern-user-results"></div>
                </div>
                <div class="selected-users" id="save-pattern-selected-users"></div>
              </div>

              <div class="save-pattern-modal-footer">
                <button type="button" class="btn-cancel" id="save-pattern-cancel-btn">Cancel</button>
                <button type="submit" class="btn-save" id="save-pattern-save-btn">Save Pattern</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    `),this.modal=document.getElementById("save-pattern-modal-overlay")}attachEventListeners(){const e=document.getElementById("save-pattern-modal-close");e&&e.addEventListener("click",()=>this.hide());const t=document.getElementById("save-pattern-cancel-btn");t&&t.addEventListener("click",()=>this.hide()),this.modal&&this.modal.addEventListener("click",a=>{a.target===this.modal&&this.hide()});const n=document.getElementById("save-pattern-form");n&&n.addEventListener("submit",async a=>{a.preventDefault(),await this.savePattern()});const s=document.getElementById("save-pattern-public"),r=document.getElementById("save-pattern-share-group");s&&r&&s.addEventListener("change",a=>{a.target.checked?(r.style.display="none",this.selectedUsers=[],this.updateSelectedUsers()):r.style.display="block"});const o=document.getElementById("save-pattern-user-search");if(o){let a;o.addEventListener("input",l=>{clearTimeout(a);const d=l.target.value.trim();d.length>=2?a=setTimeout(()=>this.searchUsers(d),300):this.clearUserSearchResults()})}}async searchUsers(e){try{const{usersAPI:t}=await We(async()=>{const{usersAPI:s}=await Promise.resolve().then(()=>qn);return{usersAPI:s}},void 0),n=await t.searchUsers(e);this.displayUserSearchResults(n)}catch(t){console.error("Error searching users:",t)}}displayUserSearchResults(e){const t=document.getElementById("save-pattern-user-results");if(t){if(e.length===0){t.innerHTML='<div class="user-search-no-results">No users found</div>';return}t.innerHTML=e.filter(n=>!this.selectedUsers.find(s=>s.id===n.id)).map(n=>`
        <div class="user-search-result-item" data-user-id="${n.id}">
          <img src="${n.avatarUrl||""}" alt="${n.name}" class="user-search-avatar" onerror="this.style.display='none'">
          <div class="user-search-result-info">
            <div class="user-search-result-name">${n.name}</div>
            <div class="user-search-result-email">${n.email}</div>
          </div>
          <button type="button" class="user-search-add-btn">Add</button>
        </div>
      `).join(""),t.querySelectorAll(".user-search-result-item").forEach(n=>{const s=n.querySelector(".user-search-add-btn"),r=n.dataset.userId,o=e.find(a=>a.id===r);s&&o&&s.addEventListener("click",()=>{this.addUserToShare(o),n.remove()})})}}clearUserSearchResults(){const e=document.getElementById("save-pattern-user-results");e&&(e.innerHTML="")}addUserToShare(e){this.selectedUsers.find(n=>n.id===e.id)||(this.selectedUsers.push(e),this.updateSelectedUsers());const t=document.getElementById("save-pattern-user-search");t&&(t.value=""),this.clearUserSearchResults()}removeUserFromShare(e){this.selectedUsers=this.selectedUsers.filter(t=>t.id!==e),this.updateSelectedUsers()}updateSelectedUsers(){const e=document.getElementById("save-pattern-selected-users");if(e){if(this.selectedUsers.length===0){e.innerHTML="";return}e.innerHTML=this.selectedUsers.map(t=>`
      <div class="selected-user-item">
        <img src="${t.avatarUrl||""}" alt="${t.name}" class="selected-user-avatar" onerror="this.style.display='none'">
        <span class="selected-user-name">${t.name}</span>
        <button type="button" class="selected-user-remove" data-user-id="${t.id}">&times;</button>
      </div>
    `).join(""),e.querySelectorAll(".selected-user-remove").forEach(t=>{t.addEventListener("click",()=>{this.removeUserFromShare(t.dataset.userId)})})}}async show(e,t,n=null){var o,a,l,d;if(!this.modal)return;this.currentPattern=e,this.patternType=t,this.elementId=n,this.selectedUsers=[];const s=document.getElementById("save-pattern-genre-group");s&&(s.style.display=t==="master"?"block":"none"),(o=document.getElementById("save-pattern-title"))!=null&&o.value&&(document.getElementById("save-pattern-title").value=""),(a=document.getElementById("save-pattern-artist"))!=null&&a.value&&(document.getElementById("save-pattern-artist").value=""),(l=document.getElementById("save-pattern-version-name"))!=null&&l.value&&(document.getElementById("save-pattern-version-name").value="");const r=document.getElementById("save-pattern-genre");r&&(r.value=""),(d=document.getElementById("save-pattern-public"))!=null&&d.checked&&(document.getElementById("save-pattern-public").checked=!1),this.updateSelectedUsers(),this.clearUserSearchResults(),this.modal.style.display="flex",document.body.style.overflow="hidden"}hide(){this.modal&&(this.modal.style.display="none",document.body.style.overflow="")}async savePattern(){var e,t,n,s,r;if(!this.currentPattern){alert("No pattern to save");return}try{if(!await Sa()){alert("Please log in to save patterns");return}const a=((e=document.getElementById("save-pattern-title"))==null?void 0:e.value.trim())||null,l=((t=document.getElementById("save-pattern-artist"))==null?void 0:t.value.trim())||null,d=((n=document.getElementById("save-pattern-version-name"))==null?void 0:n.value.trim())||null,c=((s=document.getElementById("save-pattern-genre"))==null?void 0:s.value.trim())||null,u=((r=document.getElementById("save-pattern-public"))==null?void 0:r.checked)||!1;let h=this.currentPattern;const f=h.split(`
`);let m=0,g=f.length;for(let y=0;y<f.length;y++)if(f[y].trim()===""&&y>0&&f[y-1].trim().startsWith("//")){m=y+1;break}for(let y=f.length-1;y>=0;y--)if(f[y].includes("Made with Strudesk 4000")){g=y;break}h=f.slice(m,g).join(`
`).trim();const O={type:this.patternType,elementId:this.elementId,patternCode:h,title:a,artistName:l,versionName:d,genre:this.patternType==="master"?c:null,isPublic:u,metadata:{}},p=await Ic.createPattern(O);!u&&this.selectedUsers.length>0&&await Ic.sharePattern(p.id,this.selectedUsers.map(y=>y.id)),this.onSave&&this.onSave(p),this.hide(),alert("Pattern saved successfully!")}catch(o){console.error("Error saving pattern:",o),alert("Failed to save pattern: "+(o.message||"Unknown error"))}}setOnSave(e){this.onSave=e}}const wO={bd:"Bass drum, Kick drum",sd:"Snare drum",rim:"Rimshot",cp:"Clap",hh:"Closed hi-hat",oh:"Open hi-hat",cr:"Crash",rd:"Ride",ht:"High tom",mt:"Medium tom",lt:"Low tom",sh:"Shakers",cb:"Cowbell",tb:"Tambourine",perc:"Other percussions",misc:"Miscellaneous samples",fx:"Effects"},hi=new Set(["RolandTR808","RolandTR909","RolandTR707","RhythmAce","AkaiLinn","ViscoSpaceDrum","CasioRZ1"]),W$="https://raw.githubusercontent.com/felixroos/dough-samples/main/vcsl.json",Yo="vcsl:";let Vs=null,fi=null;const rf="World Instruments",of="VCSL Instruments",af=["Chordophones","Aerophones","Membranophones","Electrophones","Idiophones"],Lc=[{value:"mridangam",label:"Mridangam Percussion Set"}],q$=new Set(Lc.map(i=>i.value.toLowerCase())),cl=i=>{if(!i||typeof i!="string")return{rawValue:"",bankValue:"",isVcslInstrument:!1,vcslInstrument:""};if(i.startsWith(Yo)){const e=i.slice(Yo.length);return{rawValue:i,bankValue:"vcsl",isVcslInstrument:!0,vcslInstrument:e}}return{rawValue:i,bankValue:i,isVcslInstrument:!1,vcslInstrument:""}},PO=i=>i?i.replace(/[_-]+/g," ").replace(/\s+/g," ").trim().replace(/\b\w/g,e=>e.toUpperCase()):"",H$=i=>{if(!i)return"";if(typeof i=="string")return i;if(Array.isArray(i))return typeof i[0]=="string"?i[0]:"";if(typeof i=="object"){const e=Object.values(i)[0];if(typeof e=="string")return e;if(Array.isArray(e)&&typeof e[0]=="string")return e[0]}return""},Y$=(i,e)=>{const t=(i||e||"").toLowerCase();return/(membranophone|idiophone|drum|percussion|bongo|cajon|shaker|triangle|tambourine|clave|cowbell|snare|kick|timpani|gong|cymbal)/i.test(t)?"drums":"world"},K$=(i,e)=>{if(!i||!e)return i;try{return new URL(i,e).toString()}catch{return i}},Bc=(i,e)=>{if(typeof i=="string")return K$(i,e);if(Array.isArray(i))return i.map(t=>Bc(t,e));if(i&&typeof i=="object"){const t={};return Object.entries(i).forEach(([n,s])=>{t[n]=Bc(s,e)}),t}return i},J$=i=>{if(!i||typeof i!="object")return i;const e=i._base||"",t={};return Object.entries(i).forEach(([n,s])=>{n!=="_base"&&(t[n]=Bc(s,e))}),t},eM=i=>{if(!i||typeof i!="string")return"Other";const e=i.match(/^([^/]+)/);if(!e)return"Other";try{const t=decodeURIComponent(e[1]);return t.charAt(0).toUpperCase()+t.slice(1)}catch{return e[1]}},tM=i=>{const e=af.indexOf(i);return e===-1?af.length+1:e},nM=async()=>Vs||fi||(fi=fetch(W$).then(async i=>{if(!i.ok)throw new Error(`Failed to load VCSL instruments: ${i.status}`);const e=await i.json();J$(e);const n=Object.entries(e||{}).filter(([s])=>s&&s!=="_base").map(([s,r])=>{const o=H$(r),a=eM(o),l=Y$(o,a);return{value:s,optionValue:`${Yo}${s}`,label:`VCSL · ${PO(s)}`,category:l,samplePath:o,family:a,familyOrder:tM(a)}}).sort((s,r)=>s.familyOrder!==r.familyOrder?s.familyOrder-r.familyOrder:s.label.localeCompare(r.label));return Vs=n,n}).catch(i=>(console.warn("⚠️ Unable to load VCSL instrument list:",i),Vs=[],[])).finally(()=>{fi=null}),fi),ur={RolandTR808:"Roland TR-808",RolandTR909:"Roland TR-909",RolandTR707:"Roland TR-707",RhythmAce:"Rhythm Ace",AkaiLinn:"Akai Linn",ViscoSpaceDrum:"Visco Space Drum",CasioRZ1:"Casio RZ-1"},lf=/\b(note|n)\s*\(/i,cf=/\bn\(\s*["'][^"']*["']\s*\)/i,Kt=i=>!i||typeof i!="string"?!1:(lf.lastIndex=0,lf.test(i)),kn=i=>!i||typeof i!="string"?!1:(cf.lastIndex=0,cf.test(i)),Is=i=>{if(!i)return"Channel";const e=i.match(/element-(\d+)/i);return e&&e[1]?`Channel ${e[1]}`:i},sM=(i,e)=>{const t=Is(i),n=e?e.trim():"";if(!n||/^element\s*\d+$/i.test(n))return t;if(/^channel\s*\d+$/i.test(n))return n;const s=n.replace(/^channel\s*\d+\s*(–|-)\s*/i,"");return`${t} – ${s}`},On=(i,e)=>{const t=document.querySelector(`[data-sound-id="${i}"]`);if(!t)return;const n=t.querySelector(".element-title");n&&(n.textContent=sM(i,e));const s=t.querySelector(".config-button");s&&(s.textContent=e&&e.trim()?e.trim():"Configure Sound")},oo=i=>i?Object.prototype.hasOwnProperty.call(ur,i)?ur[i]:i.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/([A-Za-z])(\d+)/g,"$1 $2").trim():"",df={RolandTR808:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"cp",label:"CP",sample:"cp"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"},{key:"cb",label:"CB",sample:"cb"},{key:"sh",label:"SH",sample:"sh"}],RolandTR909:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"cp",label:"CP",sample:"cp"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}],RolandTR707:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}],RhythmAce:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}],AkaiLinn:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}],ViscoSpaceDrum:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}],CasioRZ1:[{key:"bd",label:"BD",sample:"bd"},{key:"sd",label:"SD",sample:"sd"},{key:"hh",label:"HH",sample:"hh"},{key:"oh",label:"OH",sample:"oh"},{key:"cr",label:"CR",sample:"cr"},{key:"rd",label:"RD",sample:"rd"},{key:"lt",label:"LT",sample:"lt"},{key:"mt",label:"MT",sample:"mt"},{key:"ht",label:"HT",sample:"ht"}]},iM=[{id:"roland808-simple-bd-hh",label:"Roland 808 – Kick & Hat",bank:"RolandTR808",description:"Simple BD/HH groove shown in the step editor",pattern:'s("bd ~ hh ~ bd ~ hh ~ bd ~ hh ~ bd ~ hh ~").bank("RolandTR808")',editorBadge:"Step editor"},{id:"drum-beat-generator",label:"Beat Generator",bank:"",description:"Opens in code editor for generative BD patterns",pattern:'s("bd").bank("RolandTR808").segment(16).degradeBy(.5).ribbon(16,1)',editorBadge:"Code"},{id:"random-modifiers",label:"Random Modifiers",bank:"",description:"chooseCycles randomizes BD / HH / SD each cycle",pattern:'s(chooseCycles("bd","hh","sd")).bank("RolandTR808").fast(8)',editorBadge:"Code"},{id:"mridangam-pulse",label:"Mridangam Percussion Set",bank:"",description:"Classical tha · dhi · thom · nam motif on the mridangam bank",pattern:`"tha dhi thom nam".drop("0 -1 -2 -3").sound().bank("mridangam")

/* Available sounds: tha · dhi · dhin · thom · nam · na · ta · ka · ki · gumki · dhum · chaapu · ardha */`,editorBadge:"Code"}],SO=[{id:"independent-params",label:"Note Names and Filter Pattern",bank:"",description:"note, cutoff, gain and sound controlled independently",pattern:'note("F3 A3 C3 E3").cutoff("<500 1000 2000 [4000 8000]>").gain(.8).s("sawtooth").log()'},{id:"semitones-scale-transpose",label:"Semitones, Scale & Transpose",bank:"",description:"Transposes notes inside the scale by the number of steps",pattern:`"[-8 [2,4,6]]*2".scale('c:ionian').scaleTranspose("<0 -1 -2 -3 -4 -5 -6 -4>*2").note().s("piano")`,useNoteNames:!1},{id:"simple-arpeggios",label:"Simple Arpeggios in Semitones & Chords",bank:"",description:"Combines numeric semitones with chord progressions",pattern:'n("0 1 2 3").chord("<C Am F G>").voicing()',useNoteNames:!1},{id:"simple-backing-track",label:"Simple Backing Track",bank:"",description:"Together with layer, struct and voicings, this can be used to create a basic backing track",pattern:`"<C^7 A7b13 Dm7 G7>*2".layer(
  x => x.voicings("lefthand").struct("[~ x]*2").note(),
  x => x.rootNotes(2).note().s("sawtooth").cutoff(800)
)`},{id:"vcsl-vocal-bed",label:"VCSL World Textures",bank:"",description:"Layered Ball Whistle + Bongo textures from the VCSL set",pattern:'sound("<ballwhistle ~ bongo ~>*2").bank("vcsl").slow(2).room(.35).shape(.2)'},{id:"jazz-blues-in-f",label:"Jazz Blues in F",bank:"",description:"Classic jazz-blues progression with layered voicings and struct patterns",pattern:`(() => {
  const chords = chord(\`<

F7 Bb7 F7 [Cm7 F7]

Bb7 Bo F7 [Am7 D7]

Gm7 C7 [F7 D7] [Gm7 C7]

>\`);

  return stack(
    n("7 8 [10 9] 8").set(chords).voicing().dec(.2),
    chords.struct("- x - x").voicing().room(.5),
    n("0 - 1 -").set(chords).mode("root:g2").voicing()
  );
})()`},{id:"mini-notation-example",label:"Mini-notation Example",bank:"",description:"Layered mini-notation demo showing melody + bass progressions",pattern:`note(\`<

[e5 [b4 c5] d5 [c5 b4]]

[a4 [a4 c5] e5 [d5 c5]]

[b4 [~ c5] d5 e5]

[c5 a4 a4 ~]

[[~ d5] [~ f5] a5 [g5 f5]]

[e5 [~ c5] e5 [d5 c5]]

[b4 [b4 c5] d5 e5]

[c5 a4 a4 ~]

,

[[e2 e3]*4]

[[a2 a3]*4]

[[g#2 g#3]*2 [e2 e3]*2]

[a2 a3 a2 a3 a2 a3 b1 c2]

[[d2 d3]*4]

[[c2 c3]*4]

[[b1 b2]*2 [e2 e3]*2]

[[a1 a2]*4]

>\`)`}],rM=[{id:"sampler-begin",label:"begin",description:"Skip the first section of each triggered sample.",tooltip:"A 0–1 pattern that trims the start of each hit (0.25 removes the first quarter).",pattern:`samples({
  "rave": "rave/AREUREADY.wav"
}, "github:tidalcycles/dirt-samples")

s("rave")
  .begin("<0 0.25 0.5 0.75>")
  .fast(2)`},{id:"sampler-end",label:"end",description:"Cut the tail of the sample instead of the beginning.",tooltip:"Same as .begin but trims from the end (1 = full sample, 0.5 = half length).",pattern:`s("bd*2,oh*4").bank("RolandTR808")
  .end("<0.1 0.2 0.5 1>")
  .fast(2)`},{id:"sampler-loop",label:"loop",description:"Keep a sample looping regardless of the cycle length.",tooltip:"Enable sustained looping (1 = on) — tempo is free-running.",pattern:`s("casio")
  .loop(1)`},{id:"sampler-loopBegin",label:"loopBegin",description:"Set the point inside the sample where looping starts.",tooltip:"Choose the loop start within 0–1 of the file; must be before loopEnd.",pattern:`s("space").loop(1)
  .loopBegin("<0 0.125 0.25>")
  ._scope()`},{id:"sampler-loopEnd",label:"loopEnd",description:"Set the point inside the sample where looping ends.",tooltip:"Choose the loop end (0–1). Must be after loopBegin for a valid loop.",pattern:`s("space").loop(1)
  .loopEnd("<1 0.75 0.5 0.25>")
  ._scope()`},{id:"sampler-cut",label:"cut",description:"Use classic drum-machine style choke groups.",tooltip:"Samples in the same cut group (1 here) stop each other when they retrigger.",pattern:`s("[oh hh]*4").bank("RolandTR808")
  .cut(1)`},{id:"sampler-clip",label:"clip",description:"Shorten or lengthen the note duration without altering tempo.",tooltip:"Multiplies sustain by the factor; values <1 gate the sample early.",pattern:`note("c a f e")
  .s("piano")
  .clip("<0.5 1 2>")
  .legato(1)`},{id:"sampler-loopAt",label:"loopAt",description:"Time-stretch samples to a specific number of cycles.",tooltip:"Stretches/compresses playback so the loop fits exactly 2 cycles.",pattern:`samples({
  "rhodes": "https://cdn.freesound.org/previews/132/132051_316502-lq.mp3"
})

s("rhodes").loopAt(2)`},{id:"sampler-fit",label:"fit",description:"Resize a sample to the length of each event.",tooltip:"Fits every triggered slice to its event duration — great for breakbeats.",pattern:`samples({
  "rhodes": "https://cdn.freesound.org/previews/132/132051-lq.mp3"
})

s("rhodes/2")
  .fit()`},{id:"sampler-chop",label:"chop",description:"Split samples into equal slices for granular tricks.",tooltip:"Cuts each hit into 4 tiny grains, then reorders/repeats them in two cycles.",pattern:`samples({
  "rhodes": "https://cdn.freesound.org/previews/132/132051-lq.mp3"
})

s("rhodes")
  .chop(4)
  .rev()
  .loopAt(2)`},{id:"sampler-striate",label:"striate",description:"Sequentially scan through chunks of each sample.",tooltip:"Each trigger jumps forward through 6 slices of the source file.",pattern:`s("numbers:0 numbers:1 numbers:2")
  .striate(6)
  .slow(3)`},{id:"sampler-slice",label:"slice",description:"Address slices explicitly using indexes or fractional lists.",tooltip:"Divide the file into slices and trigger them via patterns or fractional lists.",pattern:`samples("github:tidalcycles/dirt-samples")

s("breaks165")
  .slice(8, "0 1 <2 2*2> 3 [4 0] 5 6 7")
  .slow(0.75)

s("breaks125")
  .fit()
  .slice([0, 0.25, 0.5, 0.75], "0 1 1 <2 3>")`},{id:"sampler-splice",label:"splice",description:"Slice like .slice but time-stretches to match step length.",tooltip:"Each slice is warped to fill its step, so rhythms stay tight.",pattern:`samples("github:tidalcycles/dirt-samples")

s("breaks165")
  .splice(8, "0 1 [2 3 0]@2 3 0@2 7")`},{id:"sampler-scrub",label:"scrub",description:"Manually scrub through audio (great for granular tape FX).",tooltip:"Supply 0–1 positions (optionally with :speed) to scrub through the waveform.",pattern:`samples("github:switchangel/pad")
s("swpad:0")
  .scrub("{0.1!2 0.25@3 0.7!2 <0.8:1.5>}%8")

samples("github:yaxu/clean-breaks/main")
s("amen/4")
  .fit()
  .scrub(pattern("{0@3 0@2 4@3}%8").div(16))`},{id:"sampler-speed",label:"speed",description:"Pitch-shift or reverse by changing playback speed.",tooltip:"Positive speeds raise the pitch; negatives play the sample backwards.",pattern:`s("bd*6")
  .speed("1 2 4 1 -2 -4")

speed("1 1.5*2 [2 1.1]")
  .s("piano")
  .clip(1)`}].map(i=>({...i,editorBadge:"Code"}));SO.forEach(i=>{i.editorBadge||(i.editorBadge="Code")});const dl=[{id:"song-acidic-tooth",label:'Song · "acidic tooth" @by eddyflux',pattern:`// "acidic tooth" @by eddyflux
// @version 1.0

setcps(1)

stack(

  /* Channel 1 */
  stack(
    s("bd*2").mask("<0@4 1@16>"),
    s("hh*8").gain(saw.mul(saw.fast(2))).clip(sine)
    .mask("<0@8 1@16>")
  ).bank('RolandTR909')

  ,

  /* Channel 2 */
  note("[<g1 f1>/8](<3 5>,8)")
  .clip(perlin.range(.15,1.5))
  .release(.1)
  .s("sawtooth")
  .lpf(sine.range(400,800).slow(16))
  .lpq(cosine.range(6,14).slow(3))
  .lpenv(sine.mul(4).slow(4))
  .lpd(.2).lpa(.02)
  .ftype('24db')
  .rarely(add(note(12)))
  .room(.2).shape(.3).postgain(.5)
  .superimpose(x=>x.add(note(12)).delay(.5).bpf(1000))
  .gain("[.2 1@3]*2") // fake sidechain

)`.trim()}],uf=new URL("./assets/samples/voice/Strudesk4000_de.mp3",document.baseURI).href;let hn=null;const hf=25,ff=25,mf="strudel_channel_history:",ul="strudel_master_history",Wi={get(i){try{return window.localStorage.getItem(i)}catch(e){return console.warn("Pattern history storage get failed:",e),null}},set(i,e){try{window.localStorage.setItem(i,e)}catch(t){console.warn("Pattern history storage set failed:",t)}}},tn=(()=>{const i=new Map;let e=null;const t=c=>{if(!c)return[];try{const u=JSON.parse(c);return Array.isArray(u)?u:[]}catch{return[]}},n=(c,u)=>{Wi.set(c,JSON.stringify(u))};return{saveChannelVersion:(c,u)=>{const h=(u||"").trim();if(!c||!h||i.get(c)===h)return;const f=`${mf}${c}`;let m=t(Wi.get(f));if(m.length&&m[0].pattern===h){i.set(c,h);return}const g={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,pattern:h,createdAt:Date.now()};m.unshift(g),m.length>hf&&(m=m.slice(0,hf)),n(f,m),i.set(c,h)},getChannelVersions:c=>c?t(Wi.get(`${mf}${c}`)):[],markChannelSnapshot:(c,u)=>{c&&i.set(c,(u||"").trim())},saveMasterVersion:c=>{const u=(c||"").trim();if(!u||u===e){e=u;return}let h=t(Wi.get(ul));if(h.length&&h[0].pattern===u){e=u;return}const f={id:`${Date.now()}-${Math.random().toString(36).slice(2,8)}`,pattern:u,createdAt:Date.now()};h.unshift(f),h.length>ff&&(h=h.slice(0,ff)),n(ul,h),e=u},getMasterVersions:()=>t(Wi.get(ul)),markMasterSnapshot:c=>{e=(c||"").trim()}}})();window.__patternHistory=tn;const oM=()=>{const i=document.getElementById("pattern-history-modal");if(!i)return{openChannelHistory:()=>{},openMasterHistory:()=>{},close:()=>{}};const e=document.getElementById("pattern-history-title"),t=document.getElementById("pattern-history-list"),n=document.getElementById("pattern-history-tabs"),s=document.getElementById("pattern-history-close");let r=null,o=[],a="local";const l=p=>p.replace(/[&<>"']/g,y=>{switch(y){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";case'"':return"&quot;";case"'":return"&#039;";default:return y}}),d=p=>{try{return new Date(p).toLocaleString()}catch{return""}},c=()=>{i.classList.remove("is-open"),i.setAttribute("aria-hidden","true"),r=null,o=[]},u=()=>{i.classList.add("is-open"),i.setAttribute("aria-hidden","false")},h=(p,y={})=>{const{includeMasterSongs:M=!1,isCloudPatterns:b=!1}=y,S=document.createDocumentFragment();if(Array.isArray(p)&&p.length>0)p.forEach((x,E)=>{const B=document.createElement("div");B.className="pattern-history-entry";let F=x.patternCode||x.pattern||"";const W=F.length>240?`${F.slice(0,240)}…`:F,z=(E+1).toString().padStart(2,"0");let ce=d(x.createdAt);if(b){const ie=[];x.title&&ie.push(`"${x.title}"`),x.artistName&&ie.push(`by ${x.artistName}`),x.version&&ie.push(`v${x.version}${x.versionName?` (${x.versionName})`:""}`),x.userCount>0&&ie.push(`${x.userCount} user${x.userCount>1?"s":""}`),ie.length>0&&(ce=ie.join(" • "))}B.innerHTML=`
          <div class="pattern-history-meta">
            <span class="pattern-history-index">#${z}</span>
            <p class="pattern-history-date">${l(ce)}</p>
          </div>
          <pre class="pattern-history-snippet">${l(W)}</pre>
          <div class="pattern-history-actions">
            <button type="button" class="pattern-history-load" data-version-id="${x.id}" data-is-cloud="${b}">Load</button>
          </div>
        `,S.appendChild(B)});else{const x=document.createElement("p");x.className="pattern-history-empty",x.textContent="No saved versions yet.",S.appendChild(x)}if(M&&dl.length&&a==="local"){const x=document.createElement("h4");x.className="pattern-history-section-title",x.textContent="Songs",S.appendChild(x),dl.forEach((E,B)=>{const F=document.createElement("div");F.className="pattern-history-entry pattern-history-entry--song";const W=E.pattern.length>400?`${E.pattern.slice(0,400)}…`:E.pattern,z=(B+1).toString().padStart(2,"0");F.innerHTML=`
          <div class="pattern-history-meta">
            <span class="pattern-history-index">#${z}</span>
            <p class="pattern-history-date">${l(E.label)}</p>
          </div>
          <pre class="pattern-history-snippet">${l(W)}</pre>
          <div class="pattern-history-actions">
            <button type="button" class="pattern-history-load" data-song-id="${E.id}">Load</button>
          </div>
        `,S.appendChild(F)})}t.innerHTML="",t.appendChild(S)};t.addEventListener("click",async p=>{const y=p.target.closest(".pattern-history-load");if(!y||!hn)return;const M=y.dataset.versionId,b=y.dataset.songId,S=y.dataset.isCloud==="true";if(b&&(r==null?void 0:r.type)==="master"){const E=dl.find(B=>B.id===b);if(!E)return;hn.applyMasterHistoryEntry(E.pattern),c();return}let k=o.find(E=>E.id===M);if(S&&k)try{const{patternsAPI:E}=await We(async()=>{const{patternsAPI:F}=await Promise.resolve().then(()=>qn);return{patternsAPI:F}},void 0);k=await E.getPattern(M)}catch(E){console.error("Error loading cloud pattern:",E),alert("Failed to load pattern");return}if(!k)return;const x=k.patternCode||k.pattern;x&&((r==null?void 0:r.type)==="channel"?hn.applyChannelHistoryEntry(r.elementId,x):(r==null?void 0:r.type)==="master"&&hn.applyMasterHistoryEntry(x),c())}),s==null||s.addEventListener("click",c),i.addEventListener("click",p=>{p.target===i&&c()});const f=async(p,y=null)=>{try{const{patternsAPI:M,getCurrentUser:b}=await We(async()=>{const{patternsAPI:E,getCurrentUser:B}=await Promise.resolve().then(()=>qn);return{patternsAPI:E,getCurrentUser:B}},void 0),S=await b();if(!S)return[];const k={type:p};let x=[];return a==="my-patterns"?(x=await M.getPatterns({type:p,isPublic:!1}),x=x.filter(E=>E.userId===S.id)):a==="public"?x=await M.getPatterns({type:p,isPublic:!0}):a==="shared"&&(x=await M.getPatterns({type:p,shared:!0})),x}catch(M){return console.error("Error loading cloud patterns:",M),[]}},m=async p=>{if(a=p,n&&n.querySelectorAll(".pattern-history-tab").forEach(y=>{y.classList.toggle("active",y.dataset.tab===p)}),t.innerHTML='<p class="pattern-history-empty">Loading…</p>',p==="local")(r==null?void 0:r.type)==="channel"?(o=tn.getChannelVersions(r.elementId),h(o)):(r==null?void 0:r.type)==="master"&&(o=tn.getMasterVersions(),h(o,{includeMasterSongs:!0}));else{const y=await f((r==null?void 0:r.type)||"master",r==null?void 0:r.elementId);o=y,h(y,{isCloudPatterns:!0})}},g=async p=>{if(!p)return;r={type:"channel",elementId:p},e.textContent=`${Is(p)} history`,u();const{getCurrentUser:y}=await We(async()=>{const{getCurrentUser:b}=await Promise.resolve().then(()=>qn);return{getCurrentUser:b}},void 0),M=await y();n&&(n.style.display=M?"flex":"none"),t.innerHTML='<p class="pattern-history-empty">Loading…</p>',a="local",o=tn.getChannelVersions(p),h(o)},O=async()=>{r={type:"master"},e.textContent="Master history",u();const{getCurrentUser:p}=await We(async()=>{const{getCurrentUser:M}=await Promise.resolve().then(()=>qn);return{getCurrentUser:M}},void 0),y=await p();n&&(n.style.display=y?"flex":"none"),t.innerHTML='<p class="pattern-history-empty">Loading…</p>',a="local",o=tn.getMasterVersions(),h(o,{includeMasterSongs:!0})};return n&&n.addEventListener("click",p=>{const y=p.target.closest(".pattern-history-tab");y&&m(y.dataset.tab)}),{openChannelHistory:g,openMasterHistory:O,close:c}};let xo=null;const aM=i=>{var s,r;if(!xo)return;const e=i.target.closest("[data-history-save]");if(e){i.preventDefault();const o=e.dataset.historySave;if(o==="channel"){const a=e.closest(".sound-element"),l=a==null?void 0:a.getAttribute("data-sound-id");l&&hn&&((s=hn.saveChannelWithEffects)==null||s.call(hn,l))}else o==="master"&&hn&&((r=hn.saveMasterHistoryEntry)==null||r.call(hn));return}const t=i.target.closest('[data-history-target="channel"]');if(t){i.preventDefault();const o=t.closest(".sound-element"),a=o==null?void 0:o.getAttribute("data-sound-id");a&&xo.openChannelHistory(a);return}i.target.closest("#load-master-history-btn")&&(i.preventDefault(),xo.openMasterHistory())},pf=()=>{xo=oM(),document.addEventListener("click",aM)},hl=[{key:"bd",label:"BD",sample:"bd"},{key:"sn",label:"SN",sample:"sd"},{key:"hh",label:"HH",sample:"hh"}],Qd={superpiano:"piano",wood:"jazz"},ir=["sine","square","triangle","sawtooth","supersaw","pulse"],mi=["piano","supersaw","gtr","casio","jazz","metal","folkharp"],kO=Object.keys(Qd),lM=new Set([...ir,...mi,...kO]),cM=["note()","n()","sound()","s()","bank()","beat()","vowel()","chord()","voicing()","addVoicings()","gain()","adsr()","scale()","pan()","speed()","slow()","fast()","early()","late()","legato()","euclid()","euclidRot()","euclidLegato()","rev()","palindrome()","iter()","iterBack()","ply()","range()","rangex()","range2()","lpf()","lpa()","lpd()","lps()","lpq()","lpattack()","lpdecay()","lpsustain()","lprelease()","orbit()","postgain()","irand()","seg()","hpf()","hpq()","bpf()","bpg()","bpq()","fancor()","lpenv()","ftype()","attack()","decay()","sustain()","release()","tremolo()","resonance()","cutoff()","noise()","tremolosync()","tremoloskew()","tremolodepth()","tremolophase()","tremoloshape()","sometimes()","stack()","clip()","sub()","mul()","div()","floor()","ceil()","ratio()","as()","saw()","sine()","cosine()","tri()","square()","rand()","saw2()","sine2()","cosine2()","tri2()","square2()","rand2()","perlin()","brand()","brandBy()","mouseX()","mouseY()","choose()","wchoose()","chooseCycles()","wchooseCycles()","degradeBy()","degrade()","undegradeBy()","undegrade()","sometimesBy()","sometimes()","someCyclesBy()","someCycles()","often()","rarely()","almostNever()","almostAlways()","never()","always()","lastOf()","firstOf()","when()","chunk()","chunkBack()","fastChunk()","arp()","arpWith()","struct()","mask()","reset()","restart()","hush()","invert()","pick()","pickmod()","pickF()","pickmodF()","pickRestart()","pickmodRestart()","pickReset()","pickmodReset()","inhabit()","inhabitmod()","squeeze()","superimpose()","layer()","off()","echo()","echoWith()","transpose()","scaleTranspose()","rootNotes()","pace()","stepcat()","stepalt()","expand()","contract()","extend()","take()","drop()","polymeter()","shrink()","grow()","tour()","zip()","vib()","vibmod()","add()","anchor()","dict()","penv()","segment()","compress()","zoom()","linger()","fastGap()","inside()","outside()","cpm()","ribbon()","swingBy()","swing()","patt()","dec()","mode()","set()","struct()","pick()","pattack()","pdecay()","prelease()","pcurve()","panchor()","velocity()","fm()","fmh()","fmattack()","fmdecay()","fmsustain()","fmenv()","zrand()","curve()","slide()","deltaSlide()","zmod()","zcrush()","zdelay()","pitchJump()","pitchJumpTime()","lfo()","compressor()","control()","ccn()","ccv()","midimap()","midimaps()","defaultmidimap()","midi()","midiport()","midicmd()","midibend()","miditouch()","progNum()","sysex()","sysexid()","sysexdata()","osc()","mqtt()","xfade()","jux()","juxBy()","coarse()","crush()","distort()","delay()","delaytime()","delayfeedback()","room()","roomsize()","roomfade()","roomlp()","roomdim()","iresponse()","phaser()","phaserdepth()","phasercenter()","phasersweep()","duckorbit()","duckattack()","duckdepth()"],$o=["stack()","vowel()","beat()","bank()","sound()","chord()","note()"],dM=['sound("sawtooth")','sound("square")','sound("triangle")','sound("sine")','sound("white")','sound("pink")','sound("brown")'],uM=["beat","chord","note","sound","stack"],hM=new Map([['sound("brown")',"pattern-snippet-tag-sound-brown"],['sound("pink")',"pattern-snippet-tag-sound-pink"],['sound("white")',"pattern-snippet-tag-sound-white"]]),fM=new Set(["core"]),mM=new Set(["filters-lp","filters-hp","filters-bp"]),pM=new Set(["filters-lp","filters-hp","filters-bp"]),qi=new Map;function fl(i){return i<=20?0:i>=2e4?1:i<=100?(i-20)/80*.25:i<=500?.25+(i-100)/400*.25:i<=5e3?.5+(i-500)/4500*.3:.8+(i-5e3)/15e3*.2}function ml(i){return i<=0?20:i>=1?2e4:i<=.25?20+i/.25*80:i<=.5?100+(i-.25)/.25*400:i<=.8?500+(i-.5)/.3*4500:5e3+(i-.8)/.2*15e3}const Zn={lpf:{min:20,max:2e4,step:10,default:2e4,unit:"Hz"},hpf:{min:20,max:2e4,step:10,default:20,unit:"Hz"},bpf:{min:20,max:2e4,step:10,default:1e3,unit:"Hz"},lpq:{min:0,max:20,step:.1,default:0,unit:""},hpq:{min:0,max:20,step:.1,default:0,unit:""},bpq:{min:0,max:20,step:.1,default:0,unit:""},bpg:{min:-20,max:20,step:.1,default:0,unit:"dB"},attack:{min:0,max:2,step:.01,default:.01,unit:"s"},decay:{min:0,max:2,step:.01,default:.1,unit:"s"},sustain:{min:0,max:1,step:.01,default:.5,unit:""},release:{min:0,max:5,step:.01,default:.1,unit:"s"},lpattack:{min:0,max:2,step:.01,default:.01,unit:"s"},lpdecay:{min:0,max:2,step:.01,default:.1,unit:"s"},lpsustain:{min:0,max:1,step:.01,default:.5,unit:""},lprelease:{min:0,max:5,step:.01,default:.1,unit:"s"},hpattack:{min:0,max:2,step:.01,default:.01,unit:"s"},hpdecay:{min:0,max:2,step:.01,default:.1,unit:"s"},hpsustain:{min:0,max:1,step:.01,default:.5,unit:""},hprelease:{min:0,max:5,step:.01,default:.1,unit:"s"},bpattack:{min:0,max:2,step:.01,default:.01,unit:"s"},bpdecay:{min:0,max:2,step:.01,default:.1,unit:"s"},bpsustain:{min:0,max:1,step:.01,default:.5,unit:""},bprelease:{min:0,max:5,step:.01,default:.1,unit:"s"},bpenv:{min:0,max:1,step:.01,default:.5,unit:""},hpenv:{min:0,max:1,step:.01,default:.5,unit:""},pattack:{min:0,max:2,step:.01,default:.01,unit:"s"},pdecay:{min:0,max:2,step:.01,default:.1,unit:"s"},prelease:{min:0,max:5,step:.01,default:.1,unit:"s"},gain:{min:0,max:2,step:.01,default:.8,unit:""},postgain:{min:0,max:2,step:.01,default:1,unit:""},velocity:{min:0,max:1,step:.01,default:.5,unit:""},pan:{min:-1,max:1,step:.01,default:0,unit:""},slow:{min:.1,max:10,step:.1,default:2,unit:"x"},fast:{min:.1,max:10,step:.1,default:2,unit:"x"},early:{min:0,max:1,step:.01,default:.25,unit:""},late:{min:0,max:1,step:.01,default:.25,unit:""},delay:{min:0,max:1,step:.01,default:0,unit:""},delaytime:{min:0,max:1,step:.01,default:.25,unit:"s"},delayfeedback:{min:0,max:1,step:.01,default:.5,unit:""},room:{min:0,max:5,step:.01,default:0,unit:""},roomsize:{min:0,max:4,step:.01,default:.5,unit:""},roomfade:{min:0,max:1,step:.01,default:.5,unit:""},roomlp:{min:20,max:2e4,step:10,default:20,unit:"Hz"},roomdim:{min:0,max:1,step:.01,default:0,unit:""},iresponse:{min:0,max:1,step:.01,default:0,unit:""},phaser:{min:0,max:1,step:.01,default:0,unit:""},phaserdepth:{min:0,max:1,step:.01,default:.5,unit:""},phasercenter:{min:0,max:1,step:.01,default:.5,unit:""},phasersweep:{min:0,max:1,step:.01,default:.5,unit:""},duckattack:{min:0,max:2,step:.01,default:.01,unit:"s"},duckdepth:{min:0,max:1,step:.01,default:.5,unit:""},tremolo:{min:0,max:1,step:.01,default:0,unit:""},tremolodepth:{min:0,max:1,step:.01,default:.5,unit:""},tremoloskew:{min:0,max:1,step:.01,default:.5,unit:""},tremolophase:{min:0,max:1,step:.01,default:0,unit:""},resonance:{min:0,max:20,step:.1,default:0,unit:""},cutoff:{min:20,max:2e4,step:10,default:2e4,unit:"Hz"},speed:{min:.1,max:10,step:.1,default:1,unit:"x"},legato:{min:0,max:1,step:.01,default:0,unit:""},cpm:{min:60,max:300,step:1,default:120,unit:"BPM"}},hr=[{id:"core",order:0,label:"Core",heading:"Core",matcher:i=>["stack","beat","bank","sound","s","note","n"].includes(i),className:"snippet-group-core"},{id:"amplitude-modulation",order:1,label:"Amplitude Modulation",heading:"Amplitude Modulation",matcher:i=>["tremolo","tremolosync","tremolodepth","tremoloskew","tremolophase","tremoloshape"].includes(i),className:"snippet-group-amplitude-modulation"},{id:"amplitude-envelope",order:2,label:"Amplitude Envelope",heading:"Amplitude Envelope",matcher:i=>["attack","decay","sustain","release","adsr"].includes(i),className:"snippet-group-amplitude-envelope"},{id:"filter-envelope",order:3,label:"Filter Envelope",heading:"Filter Envelope",matcher:i=>["lpattack","lpdecay","lpsustain","lprelease","lpenv"].includes(i),className:"snippet-group-filter-envelope"},{id:"pitch-envelope",order:4,label:"Pitch Envelope",heading:"Pitch Envelope",matcher:i=>["pattack","pdecay","prelease","penv","pcurve","panchor"].includes(i),className:"snippet-group-pitch-envelope"},{id:"dynamics",order:5,label:"Dynamics",heading:"Dynamics",matcher:i=>["gain","velocity","compressor","postgain","xfade"].includes(i),className:"snippet-group-dynamics"},{id:"panning",order:6,label:"Panning",heading:"Panning",matcher:i=>["jux","juxby","pan"].includes(i),className:"snippet-group-panning"},{id:"waveshaping",order:7,label:"Waveshaping",heading:"Waveshaping",matcher:i=>["coarse","crush","distort"].includes(i),className:"snippet-group-waveshaping"},{id:"global-effects",order:8,label:"Global Effects",heading:"Global Effects",matcher:i=>["orbit"].includes(i),className:"snippet-group-global-effects"},{id:"delay",order:9,label:"Delay",heading:"Delay",matcher:i=>["delay","delaytime","delayfeedback"].includes(i),className:"snippet-group-delay"},{id:"reverb",order:10,label:"Reverb",heading:"Reverb",matcher:i=>["room","roomsize","roomfade","roomlp","roomdim","iresponse"].includes(i),className:"snippet-group-reverb"},{id:"phaser",order:11,label:"Phaser",heading:"Phaser",matcher:i=>["phaser","phaserdepth","phasercenter","phasersweep"].includes(i),className:"snippet-group-phaser"},{id:"duck",order:12,label:"Duck",heading:"Duck",matcher:i=>["duckorbit","duckattack","duckdepth"].includes(i),className:"snippet-group-duck"},{id:"filters-hp",order:5,label:"Filters · High-pass",heading:"Filters · High-pass",matcher:i=>i.startsWith("hp"),className:"snippet-group-filters-hp"},{id:"filters-bp",order:6,label:"Filters · Band-pass",heading:"Filters · Band-pass",matcher:i=>i.startsWith("bp"),className:"snippet-group-filters-bp"},{id:"filters-lp",order:7,label:"Filters · Low-pass",heading:"Filters · Low-pass",matcher:i=>i.startsWith("lp")||i==="ftype"||i==="vowel"||i==="applygraduallowpass",className:"snippet-group-filters-lp"},{id:"time",order:8,label:"Time Modifiers",heading:"Time Modifiers",matcher:i=>["slow","fast","early","late","clip","legato","euclid","euclidrot","euclidlegato","rev","palindrome","iter","iterback","ply","segment","compress","zoom","linger","fastgap","inside","outside","cpm","ribbon","swingby","swing"].includes(i),className:"snippet-group-time"},{id:"control-operators",order:9,label:"Control · Operators",heading:"Control Parameters · Operators",matcher:i=>["add","sub","mul","div","floor","ceil","range","rangex","range2","ratio","as"].includes(i),className:"snippet-group-controls"},{id:"signals",order:10,label:"Signals",heading:"Signals",matcher:i=>["saw","sine","cosine","tri","square","rand","saw2","sine2","cosine2","tri2","square2","rand2","perlin","irand","brand","brandby"].includes(i),className:"snippet-group-signals"},{id:"visual-feedback",order:11,label:"Visual Feedback",heading:"Visual Feedback",matcher:(i,e)=>{if(i==="color"||i==="markcss"||["fscope","generategraph","pianoroll","pitchwheel","scope","spiral","wordfall"].includes(i))return!0;if(!e||typeof e!="string")return!1;const t=e.toLowerCase();return t.includes("_punchcard")||t.includes("_pianoroll")||t.includes("_scope")||t.includes("_spiral")||t.includes("_pitchwheel")||t.includes("_spectrum")},className:"snippet-group-visual-feedback"},{id:"synths",order:12,label:"Synths",heading:"Synths",matcher:(i,e)=>i==="sound"?typeof e=="string"&&e.includes('sound("'):["decay","sustain","attack","release","cutoff","noise","vib","vibmod","fm","fmh","fmattack","fmdecay","fmsustain","fmenv","fmwave","zrand","curve","slide","deltaslide","zmod","zcrush","zdelay","pitchjump","pitchjumptime","lfo","tremolo","octave","pw","pwrate","pwsweep","spread","unison","isaw","isaw2","itri","itri2"].includes(i),className:"snippet-group-synths"},{id:"tonal",order:13,label:"Tonal Functions",heading:"Tonal Functions",matcher:i=>["voicing","voicings","addvoicings","scale","transpose","scaletranspose","rootnotes","chord","dict","anchor","mode","below","duck","above","offset","n","note"].includes(i),className:"snippet-group-tonal"},{id:"stepwise",order:14,label:"Stepwise Patterning",heading:"Stepwise Patterning",matcher:i=>["pace","stepcat","stepalt","expand","contract","extend","take","drop","polymeter","shrink","grow","tour","zip"].includes(i),className:"snippet-group-stepwise"},{id:"random",order:15,label:"Random Modifiers",heading:"Random Modifiers",matcher:i=>["choose","wchoose","choosecycles","wchoosecycles","degradeby","degrade","undegradeby","undegrade","sometimesby","sometimes","somecyclesby","somecycles","often","rarely","almostnever","almostalways","never","always"].includes(i),className:"snippet-group-random"},{id:"conditional",order:16,label:"Conditional Modifiers",heading:"Conditional Modifiers",matcher:i=>["lastof","firstof","when","chunk","chunkback","fastchunk","arp","arpwith","struct","mask","reset","restart","hush","invert","pick","pickmod","pickf","pickmodf","pickrestart","pickmodrestart","pickreset","pickmodreset","inhabit","inhabitmod","squeeze"].includes(i),className:"snippet-group-conditional"},{id:"accumulation",order:17,label:"Accumulation Modifiers",heading:"Accumulation Modifiers",matcher:i=>["superimpose","layer","off","echo","echowith"].includes(i),className:"snippet-group-accumulation"},{id:"midi",order:18,label:"MIDI",heading:"MIDI",matcher:i=>i.includes("midi")||i.startsWith("ccn")||i.startsWith("ccv")||i==="prognum"||i==="sysex"||i==="sysexid"||i==="sysexdata"||i==="control",className:"snippet-group-midi",exclude:["pianoroll"]},{id:"device",order:19,label:"Device Motion",heading:"Device Motion",matcher:i=>["orientation","acceleration","accelerate","accelerationx","accelerationy","accelerationz","rotationx","rotationy","rotationz","gravityx","gravityy","gravityz","mousex","mousey"].some(t=>i.includes(t)),className:"snippet-group-device"},{id:"external-communication",order:20,label:"External Communication",heading:"External Communication",matcher:i=>["osc","mqtt"].includes(i),className:"snippet-group-external-communication"},{id:"other",order:Number.MAX_SAFE_INTEGER,label:"Other",heading:"Other",matcher:()=>!0,className:"snippet-group-other"}],ao=hr.reduce((i,e)=>(i.set(e.id,e),i),new Map),gM={sound:["bank","note","chord","delay","room","phaser","gain","lpf","pan"],s:["bank","note","chord","delay","room","phaser","gain","lpf","pan"],note:["chord","scale","voicing","transpose","scaletranspose","rootnotes","attack","decay","release","lpf","gain","pan"],stack:["beat","sound","note","gain","pan"],beat:["sound","s","euclid","mask","slow","fast","rev","iter"],bank:["sound","s","gain","pan","slow","fast","euclid","mask","delay","room","crush","distort"],lpf:["lpenv","lpattack","lpdecay","lpsustain","lprelease","lpq","ftype","hpf","bpf","gain"],hpf:["hpattack","hpdecay","hpsustain","hprelease","hpq","lpf","bpf","gain"],bpf:["bpattack","bpdecay","bpsustain","bprelease","bpq","bpg","lpf","hpf","gain"],lpenv:["lpf","lpattack","lpdecay","lpsustain","lprelease","lpq"],lpattack:["lpf","lpenv","lpdecay","lpsustain","lprelease"],lpdecay:["lpf","lpenv","lpattack","lpsustain","lprelease"],lpsustain:["lpf","lpenv","lpattack","lpdecay","lprelease"],lprelease:["lpf","lpenv","lpattack","lpdecay","lpsustain"],lpq:["lpf","lpenv"],hpq:["hpf"],bpq:["bpf","bpg"],bpg:["bpf","bpq"],ftype:["lpf"],vowel:["lpf","ftype"],attack:["decay","sustain","release","adsr","gain","lpf"],decay:["attack","sustain","release","adsr","gain"],sustain:["attack","decay","release","adsr","gain"],release:["attack","decay","sustain","adsr","gain"],adsr:["attack","decay","sustain","release","gain"],pattack:["pdecay","prelease","penv","pcurve","panchor"],pdecay:["pattack","prelease","penv","pcurve"],prelease:["pattack","pdecay","penv","pcurve"],penv:["pattack","pdecay","prelease","pcurve","panchor"],pcurve:["penv","pattack","pdecay","prelease"],panchor:["penv","pattack"],delay:["delaytime","delayfeedback"],delaytime:["delay","delayfeedback"],delayfeedback:["delay","delaytime"],room:["roomsize","roomfade","roomlp","roomdim","iresponse"],roomsize:["room","roomfade","roomlp","roomdim"],roomfade:["room","roomsize","roomlp"],roomlp:["room","roomsize","roomfade"],roomdim:["room","roomsize"],iresponse:["room","roomsize"],phaser:["phaserdepth","phasercenter","phasersweep"],phaserdepth:["phaser","phasercenter","phasersweep"],phasercenter:["phaser","phaserdepth","phasersweep"],phasersweep:["phaser","phaserdepth","phasercenter"],duckorbit:["duckattack","duckdepth"],duckattack:["duckorbit","duckdepth"],duckdepth:["duckorbit","duckattack"],gain:["velocity","compressor","postgain","pan","delay","room"],velocity:["gain","attack","decay"],compressor:["gain","postgain"],postgain:["gain","compressor"],xfade:["gain"],pan:["jux","juxby","gain"],jux:["juxby","pan"],juxby:["jux","pan"],crush:["distort","coarse","gain"],distort:["crush","coarse","gain"],coarse:["crush","distort"],slow:["fast","early","late","clip","legato","swing"],fast:["slow","early","late","clip","legato"],early:["late","slow","fast","clip"],late:["early","slow","fast","clip"],clip:["slow","fast","legato","early","late"],legato:["clip","early","late","slow","fast"],euclid:["euclidrot","euclidlegato","mask","beat","slow","fast"],euclidrot:["euclid","euclidlegato","mask"],euclidlegato:["euclid","euclidrot","mask"],rev:["palindrome","iter","iterback"],palindrome:["rev","iter","iterback"],iter:["iterback","rev","palindrome"],iterback:["iter","rev","palindrome"],ply:["segment","compress","zoom"],segment:["ply","compress","zoom","ribbon"],compress:["ply","segment"],zoom:["linger","fastgap","ply","segment"],linger:["zoom","fastgap"],fastgap:["zoom","linger"],inside:["outside","clip"],outside:["inside","clip"],swing:["swingby","cpm","slow","fast"],swingby:["swing","cpm"],cpm:["swing","swingby"],ribbon:["segment","ply"],add:["sub","mul","div","range","rangex"],sub:["add","mul","div","range"],mul:["add","sub","div","range"],div:["add","sub","mul","range"],range:["rangex","range2","add","sub","mul"],rangex:["range","range2"],range2:["range","rangex"],floor:["ceil","ratio"],ceil:["floor","ratio"],ratio:["floor","ceil"],as:["range"],saw:["sine","tri","square","rand","range"],sine:["saw","cosine","tri","square","range"],cosine:["sine","saw","tri","square"],tri:["saw","sine","square","rand"],square:["saw","sine","tri","rand"],rand:["saw","sine","tri","square","irand","brand"],saw2:["sine2","tri2","square2","rand2"],sine2:["saw2","cosine2","tri2","square2"],cosine2:["sine2","saw2","tri2","square2"],tri2:["saw2","sine2","square2","rand2"],square2:["saw2","sine2","tri2","rand2"],rand2:["saw2","sine2","tri2","square2"],perlin:["rand","brand","range"],irand:["rand","brand"],brand:["rand","irand","brandby"],brandby:["brand"],chord:["voicing","addvoicings","scale","transpose","scaletranspose","rootnotes","dict","mode","note"],voicing:["chord","addvoicings","scale","transpose","note"],addvoicings:["voicing","chord"],scale:["chord","voicing","transpose","scaletranspose","rootnotes","dict","mode","note"],transpose:["scale","scaletranspose","chord","note","offset"],scaletranspose:["scale","transpose","chord"],rootnotes:["scale","chord","transpose"],dict:["chord","scale","note"],anchor:["penv","pcurve","panchor","scale"],mode:["scale","chord","note"],below:["above","note","chord"],above:["below","note","chord"],offset:["transpose","scale","note"],n:["note","chord","scale","voicing","transpose"],cutoff:["lpf","resonance","lpenv"],resonance:["cutoff","lpf","lpq"],noise:["sound","cutoff","lpf"],vib:["vibmod","tremolo"],vibmod:["vib"],fm:["fmh","fmattack","fmdecay","fmsustain","fmenv","fmwave"],fmh:["fm","fmattack","fmdecay"],fmattack:["fm","fmdecay","fmsustain","fmenv"],fmdecay:["fm","fmattack","fmsustain","fmenv"],fmsustain:["fm","fmattack","fmdecay","fmenv"],fmenv:["fm","fmattack","fmdecay","fmsustain"],fmwave:["fm"],zrand:["rand","brand"],curve:["slide","deltaslide"],slide:["curve","deltaslide"],deltaslide:["slide","curve"],zmod:["vib","vibmod"],zcrush:["crush","distort"],zdelay:["delay","delaytime"],pitchjump:["pitchjumptime","penv"],pitchjumptime:["pitchjump"],lfo:["tremolo","vib"],octave:["transpose","note"],pw:["pwrate","pwsweep"],pwrate:["pw","pwsweep"],pwsweep:["pw","pwrate"],spread:["unison","pan"],unison:["spread"],isaw:["isaw2","itri","itri2"],isaw2:["isaw","itri","itri2"],itri:["isaw","isaw2","itri2"],itri2:["isaw","isaw2","itri"],tremolo:["tremolosync","tremolodepth","tremoloskew","tremolophase","tremoloshape","lfo"],tremolosync:["tremolo","tremolodepth"],tremolodepth:["tremolo","tremolosync"],tremoloskew:["tremolo","tremolophase"],tremolophase:["tremolo","tremoloshape"],tremoloshape:["tremolo","tremolophase"],choose:["wchoose","sometimes","rarely"],wchoose:["choose","sometimes"],choosecycles:["wchoosecycles","somecycles"],wchoosecycles:["choosecycles","somecycles"],degradeby:["degrade","sometimes"],degrade:["degradeby","sometimes"],undegradeby:["undegrade"],undegrade:["undegradeby"],sometimesby:["sometimes","rarely","often"],sometimes:["sometimesby","rarely","often","choose"],somecyclesby:["somecycles","choosecycles"],somecycles:["somecyclesby","choosecycles"],often:["sometimes","rarely","almostalways"],rarely:["sometimes","often","almostnever"],almostnever:["rarely","never"],almostalways:["often","always"],never:["almostnever"],always:["almostalways"],lastof:["firstof","when","mask"],firstof:["lastof","when","mask"],when:["lastof","firstof","mask","struct"],chunk:["chunkback","fastchunk","mask","struct"],chunkback:["chunk","fastchunk","mask"],fastchunk:["chunk","chunkback","mask"],arp:["arpwith","chord","voicing","note"],arpwith:["arp","chord"],struct:["mask","pick","when","beat"],mask:["struct","when","euclid","beat","chunk"],reset:["restart","pickreset"],restart:["reset","pickrestart"],hush:["silence"],invert:["rev","palindrome"],pick:["pickmod","pickf","pickmodf","struct","mask"],pickmod:["pick","pickmodf","struct"],pickf:["pick","pickmodf","struct"],pickmodf:["pick","pickf","struct"],pickrestart:["pickmodrestart","restart"],pickmodrestart:["pickrestart"],pickreset:["pickmodreset","reset"],pickmodreset:["pickreset"],inhabit:["inhabitmod","mask","struct"],inhabitmod:["inhabit","mask"],squeeze:["compress","segment"],superimpose:["layer","off","echo"],layer:["superimpose","off"],off:["superimpose","layer"],echo:["echowith","delay","superimpose"],echowith:["echo"],pace:["stepcat","stepalt","polymeter","slow","fast"],stepcat:["pace","stepalt","polymeter"],stepalt:["pace","stepcat"],expand:["contract","extend","take","drop"],contract:["expand","extend","take","drop"],extend:["expand","contract","take","drop"],take:["drop","extend","expand","contract"],drop:["take","extend","expand","contract"],polymeter:["pace","stepcat","slow","fast"],shrink:["grow","compress"],grow:["shrink","expand"],tour:["zip","iter"],zip:["tour","iter"],orientation:["acceleration","rotationx","rotationy","rotationz"],acceleration:["accelerationx","accelerationy","accelerationz","gravityx","gravityy","gravityz"],accelerate:["acceleration"],accelerationx:["accelerationy","accelerationz","gravityx"],accelerationy:["accelerationx","accelerationz","gravityy"],accelerationz:["accelerationx","accelerationy","gravityz"],rotationx:["rotationy","rotationz","orientation"],rotationy:["rotationx","rotationz","orientation"],rotationz:["rotationx","rotationy","orientation"],gravityx:["gravityy","gravityz","accelerationx"],gravityy:["gravityx","gravityz","accelerationy"],gravityz:["gravityx","gravityy","accelerationz"],mousex:["mousey","pan","range"],mousey:["mousex","gain","range"],osc:["mqtt"],mqtt:["osc"],midi:["midiport","midicmd","midibend","miditouch"],midiport:["midi"],midicmd:["midi"],midibend:["midi","miditouch"],miditouch:["midi","midibend"],midimap:["midimaps","defaultmidimap"],midimaps:["midimap","defaultmidimap"],defaultmidimap:["midimap","midimaps"],ccn:["ccv","control"],ccv:["ccn","control"],control:["ccn","ccv"],prognum:["midi"],sysex:["sysexid","sysexdata"],sysexid:["sysex","sysexdata"],sysexdata:["sysex","sysexid"],orbit:["duckorbit","pan"],scope:["fscope","pianoroll","spiral"],fscope:["scope","pianoroll"],pianoroll:["scope","fscope"],spiral:["scope"],pitchwheel:["penv"],color:["markcss"],markcss:["color"],vowel:["ftype","lpf"],speed:["slow","fast"],seg:["segment"],fancor:["lpf"],patt:["struct"],dec:["decay"],set:["struct"],irand:["rand","brand"]};function $n(i){if(!i||typeof i!="string")return"";const e=i.replace(/^[.]+/,""),t=e.match(/^([a-zA-Z0-9_]+)/);return(t?t[1]:e).toLowerCase()}function pl(i){if(!i||typeof i!="string")return!1;if($o.includes(i))return!0;const e=i.toLowerCase();return uM.some(t=>{const n=`.${t}`,s=`${t}(`;return e.includes(n)||e.includes(s)})}function gl(i){if(!i||typeof i!="string")return"";const e=i.replace(/^[.]+/,"").toLowerCase();for(const[t,n]of hM.entries()){const s=t.toLowerCase();if(e===s||e.includes(s))return n}return""}function Dc(i){const e=document.createElement("div");return e.innerHTML=i||"",(e.textContent||e.innerText||"").trim()}let Ol=null,lo=null;async function zc(){return lo||(Ol||(Ol=We(()=>import("./index-CuqbEPxt.js"),[]).then(i=>{var n;const e=((n=i==null?void 0:i.reference)==null?void 0:n.docs)||{},t=new Map;for(const s of Object.values(e)){if(!s||!s.name)continue;const r=s.name.trim().toLowerCase();if(!r||t.has(r))continue;const o=Array.isArray(s.params)?s.params.map(a=>{var l;return{name:(a==null?void 0:a.name)||"",types:Array.isArray((l=a==null?void 0:a.type)==null?void 0:l.names)?a.type.names.slice():[],description:Dc((a==null?void 0:a.description)||"")}}):[];t.set(r,{name:s.name.trim(),descriptionHtml:s.description||"",descriptionText:Dc(s.description||""),params:o})}return t}).catch(i=>(console.warn("⚠️ Unable to load Strudel reference docs:",i),new Map))),lo=await Ol,lo)}function yl(i){return i?(typeof i.descriptionText=="string"||(i.descriptionText=Dc(i.descriptionHtml||"")),i.descriptionText):""}function xO(i){if(!i)return null;const e=i.toLowerCase(),t=e.match(/between\s+([-\d.]+)\s+and\s+([-\d.]+)/);if(t)return`${t[1]}-${t[2]}`;const n=e.match(/([-\d.]+)\s*-\s*([-\d.]+)/);return n?`${n[1]}-${n[2]}`:null}function OM(i){if(!i)return"";const e=i.name||"value",t=i.types||[],n=i.description||"",s=xO(n);return t.includes("number")?s?`${e}:${s}`:`${e}:number`:t.includes("string")?`${e}`:t.includes("Pattern")?`${e}:pattern`:e}function bl(i){if(!i)return"";const e=i.name||"value",t=i.types||[],n=i.description||"",s=xO(n);return t.includes("number")?s?`${e} (number ${s})`:`${e} (number)`:t.includes("string")?`${e} (string)`:t.includes("Pattern")?`${e} (pattern)`:n?`${e} (${n})`:e}function gf(i,e){if(!i||typeof i!="string"||!i.endsWith("()"))return i;const t=(e==null?void 0:e.params)||[];if(!t.length)return i;const n=t.map(OM).filter(Boolean);return n.length?`${i.slice(0,-1)}${n.join(", ")})`:i}let _t=null,os=null,Of=!1;function yM(){if(_t&&document.body.contains(_t))return _t;if(_t=document.createElement("div"),_t.id="pattern-snippet-tooltip",_t.className="pattern-snippet-tooltip",_t.setAttribute("role","tooltip"),_t.setAttribute("aria-hidden","true"),document.body.appendChild(_t),!Of){Of=!0;const i=()=>en();window.addEventListener("scroll",i,!0),window.addEventListener("resize",i,{passive:!0}),document.addEventListener("keydown",e=>{e.key==="Escape"&&en()},!0)}return _t}function en(i=os){_t&&(_t.classList.remove("visible"),_t.style.display="none",_t.style.visibility="hidden",_t.innerHTML="",_t.setAttribute("aria-hidden","true"),i&&i instanceof HTMLElement&&i.removeAttribute("aria-describedby"),os&&os!==i&&os.removeAttribute("aria-describedby"),os=null)}function vl(i){if(!i||!(i instanceof HTMLElement)||!document.body.contains(i))return;const e=yM();os&&os!==i&&en(os);const t=i.dataset.tooltipTitle||i.textContent||"",n=i.dataset.tooltipDescription||"",s=i.dataset.tooltipParams||"";if(e.innerHTML="",t){const f=document.createElement("div");f.className="pattern-snippet-tooltip-title",f.textContent=t,e.appendChild(f)}if(n){const f=document.createElement("div");f.className="pattern-snippet-tooltip-body",n.split(`
`).forEach((m,g)=>{const O=m.trim();O&&(g>0&&f.appendChild(document.createElement("br")),f.appendChild(document.createTextNode(O)))}),f.childNodes.length>0&&e.appendChild(f)}if(s){const f=document.createElement("div");f.className="pattern-snippet-tooltip-params",s.split(`
`).forEach(m=>{const g=m.trim();if(!g)return;const O=document.createElement("div");O.textContent=g,f.appendChild(O)}),f.childElementCount>0&&e.appendChild(f)}e.style.display="block",e.style.visibility="hidden",e.classList.remove("visible");const r=i.getBoundingClientRect(),o=window.innerWidth||document.documentElement.clientWidth||0,a=window.innerHeight||document.documentElement.clientHeight||0,l=e.getBoundingClientRect(),d=8;let c=r.bottom+d;if(c+l.height>a-12){const f=r.top-l.height-d;f>=12?c=f:c=Math.max(12,a-l.height-12)}let u=r.left+r.width/2-l.width/2;const h=o-l.width-12;u>h&&(u=h),u<12&&(u=12),e.style.left=`${Math.round(u)}px`,e.style.top=`${Math.round(c)}px`,e.style.visibility="visible",e.classList.add("visible"),e.setAttribute("aria-hidden","false"),e.id||(e.id="pattern-snippet-tooltip"),i.setAttribute("aria-describedby",e.id),os=i}let wl=null,Pl=null,yf="",Sl=null;function $O(i){return!i||typeof i!="string"?"":i.replace(/\/\/.*$/gm,"").replace(/\/\*[\s\S]*?\*\//g,"").replace(/\s+/g," ").trim()}function bM(i,e){if(!e)return i;const t=$O(e),n=new Set((t.match(/\.[a-zA-Z_][a-zA-Z0-9_]*/g)||[]).map(s=>$n(s)));return i.filter(s=>{const r=$n(s);return Zn[r]?!0:!n.has(r)})}async function bf(i=""){const e=$O(i);if(e===yf&&Sl)return Sl;Pl||(wl||(wl=(async()=>{const r=new Map;cM.forEach(g=>{const O=$n(g);!r.has(O)&&g&&r.set(O,g)});const o=await zc();o.forEach((g,O)=>{r.has(O)||/^[a-z][\w]*$/i.test(g.name)&&r.set(O,`${g.name}()`)});const a=hr.reduce((g,O)=>(g.set(O.id,{snippets:[]}),g),new Map),l=new Set($o.map(g=>$n(g))),d=new Map;Array.from(r.entries()).sort((g,O)=>g[0].localeCompare(O[0])).forEach(([g,O])=>{const p=o.get(g),y=hr.find(b=>b.exclude&&b.exclude.includes(g)?!1:b.matcher(g,O,p))||ao.get("other"),M=a.get(y.id);M&&M.snippets.push({snippet:O,groupId:y.id,className:y.className,heading:y.heading}),l.has(g)&&d.set(g,{snippet:O,groupId:y.id,className:y.className,heading:y.heading})});const c=$o.map(g=>{const O=$n(g);return d.get(O)||{snippet:g,groupId:"core",className:ao.get("core").className,heading:ao.get("core").heading}}).filter(Boolean).sort((g,O)=>g.snippet.localeCompare(O.snippet)),u=[],h=new Set;c.forEach(g=>{const{snippet:O,groupId:p,className:y,heading:M}=g;u.push({snippet:O,groupId:p,className:y,heading:M})}),[...hr].sort((g,O)=>g.heading.localeCompare(O.heading)).forEach(g=>{const O=a.get(g.id);!O||!O.snippets.length||(h.has(g.id)||h.add(g.id),O.snippets.slice().sort((p,y)=>p.snippet.localeCompare(y.snippet)).forEach(({snippet:p,className:y,heading:M})=>{$o.includes(p)||u.push({snippet:p,groupId:g.id,className:y,heading:M})}))});const m=ao.get("synths");return m&&dM.forEach(g=>{u.some(O=>O.snippet===g)||u.push({snippet:g,groupId:m.id,className:m.className,heading:m.heading})}),Pl=u,u})()),await wl);const t=Pl||[],n=bM(t.map(r=>r.snippet),e),s=t.filter(r=>n.includes(r.snippet));return yf=e,Sl=s,s}function co(i){if(!i||typeof i!="string")return i;const e=i.trim();return Qd[e.toLowerCase()]||e}function kl(i){if(!i||typeof i!="string")return i;let e=i;for(const[t,n]of Object.entries(Qd)){const s=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new RegExp(`(\\.s\\(["'])${s}(["']\\))`,"gi");e=e.replace(r,(a,l,d)=>`${l}${n}${d}`);const o=new RegExp(`(sound\\(["'])${s}(["']\\))`,"gi");e=e.replace(o,(a,l,d)=>`${l}${n}${d}`)}return e}function vf(i){if(!i||typeof i!="string")return!1;for(const e of lM){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(`\\.s\\(["']${t}["']\\)`,"i").test(i))return!0}return/\b(note|n)\s*\(/.test(i)}function vM(i){if(!i||typeof i!="string")return"";const e=i.trim();if(!e)return"";if(e.includes("sound(")||e.includes("s(")||Kt(e))return e;const t=e.split(/\s+/).filter(o=>o.trim()),n=[],s=[];for(const o of t)if(o)if(o.startsWith("."))s.push(o);else{const a=o.split("(")[0].trim();a&&(wO.hasOwnProperty(a.toLowerCase())||a.length>0)&&n.push(a)}if(n.length===0)return e;let r=`sound("${n.join(" ")}")`;return s.length>0&&(r+=s.join("")),r}function xn(i){let e=4,t=4;if(typeof i=="string"&&i.includes("/")){const[o,a]=i.split("/"),l=parseInt(o,10),d=parseInt(a,10);Number.isFinite(l)&&l>0&&(e=l),Number.isFinite(d)&&d>0&&(t=d)}const n=16/t,s=Math.max(1,Math.round(n)),r=Math.max(e,1)*s;return{signature:`${e}/${t}`,numerator:e,denominator:t,stepsPerBeat:s,totalSteps:r}}const wM=(i,e,t,n)=>{const s=(i-90)*Math.PI/180;return[t+Math.cos(s)*e,n+Math.sin(s)*e]},wf=(i,e,t,n,s=0)=>{const r=(i+s)*360;return wM(r,e*i,t,n)};function Pf(i,e){let{from:t=0,to:n=3,margin:s=40,cx:r=100,cy:o=100,rotate:a=0,thickness:l=s/2,color:d="#4c51bf",cap:c="round",stretch:u=1,fromOpacity:h=1,toOpacity:f=1}=e;t*=u,n*=u,a*=u,i.lineWidth=l,i.lineCap=c,i.strokeStyle=d,i.globalAlpha=h,i.beginPath();let[m,g]=wf(t,s,r,o,a);i.moveTo(m,g);const O=1/60;let p=t;for(;p<=n;){const[y,M]=wf(p,s,r,o,a);i.globalAlpha=(p-t)/(n-t)*f,i.lineTo(y,M),p+=O}i.stroke(),i.globalAlpha=1}class Sf{constructor(){hn=this,this.activeElements=new Set,this.initialized=!1,this.currentEditingElementId=null,this.mutedElements=new Set,this.soloedElements=new Set,this.elementCounter=4,this.masterActive=!1,this.masterPatternField=null,this._applyingVisualizer=!1,this.elementEffects={},this.elementFilters={},this.elementSynthesis={},this.currentTimeSignature="4/4",this.currentTimeSignatureMetrics=xn(this.currentTimeSignature),this.masterPunchcardContainer=null,this.masterPunchcardHeaderNote=null,this.masterPunchcardCanvas=null,this.masterPunchcardCtx=null,this.masterPunchcardPlaceholder=null,this.masterPunchcardIsRendering=!1,this.masterPunchcardPendingRefresh=!1,this.masterPunchcardResizeTimer=null,this.externalVisualizerCanvas=null,this.externalVisualizerObserver=null,this.externalVisualizerType=null,this.scopeAnimationFrame=null,this.barchartAnimationFrame=null,this.scopeDataArray=null,this.spectrumDataArray=null,this.activeVisualizerLoop=null,this.introSamplePlayed=!1,this._introSampleActivationHandler=null,this.nativeHighlightingEnabled=!1,this.nativeHighlightingDisabled=!1,this.nativeHighlightRetryCount=0,this.nativeHighlightRetryTimer=null,this.visualizerFullscreenBtn=null,this.handleVisualizerFullscreenChange=this.handleVisualizerFullscreenChange.bind(this),document.addEventListener("fullscreenchange",this.handleVisualizerFullscreenChange),document.addEventListener("webkitfullscreenchange",this.handleVisualizerFullscreenChange),document.addEventListener("mozfullscreenchange",this.handleVisualizerFullscreenChange),document.addEventListener("MSFullscreenChange",this.handleVisualizerFullscreenChange),this.chaospadEnabled=!1,this.currentCutoffValue=null,this.lastCutoffUpdate=null}async init(){C.appInstance=this,ot.onUpdate("tempo",n=>{C.setTempo(n)}),ot.onUpdate("key",n=>{C.setKey(n),console.log(`🎹 Key changed to: ${n}`)}),ot.onUpdate("scale",n=>{C.setScale(n),console.log(`🎼 Scale changed to: ${n||"(none)"}`)}),ot.onUpdate("timeSignature",n=>{if(this.currentTimeSignature=n||"4/4",this.currentTimeSignatureMetrics=xn(this.currentTimeSignature),C.setTimeSignature(n),console.log(`🎵 Time signature changed to: ${n}`),typeof this.applyTimeSignatureToDrumGrid=="function")try{this.applyTimeSignatureToDrumGrid(this.currentTimeSignature)}catch(s){console.warn("⚠️ Could not update drum grid for new time signature:",s)}this.refreshMasterPunchcard("time-signature-change").catch(s=>{console.warn("⚠️ Could not refresh punchcard after time signature change:",s)})}),ot.setSoundTrigger((n,s)=>{C.isAudioReady()&&(s.type==="synthesized"?C.playSynthesizedSound(n,s.pattern).catch(r=>{console.error(`Error triggering control sound for ${n}:`,r)}):s.type==="strudel"&&C.playStrudelPattern(n,s.pattern).catch(r=>{console.error(`Error triggering control sound for ${n}:`,r)}))}),this.registerElements(),this.setupElementControls(),C.onSoundsReady(()=>{console.log("🎉 Sounds are ready - activating green dots"),this.setAllElementsLoaded(),ot.updateStatus("Ready - Click elements to start/stop patterns (Press Escape to stop all)"),this.enableNativeStrudelHighlighting()}),C.onMasterPatternUpdate(async()=>{console.log("🔄 Master pattern updated - refreshing display"),this.updateMasterPatternDisplay(),this.updateActiveElementsDisplay(),this.refreshMasterPunchcard("master-update").catch(n=>{console.warn("⚠️ Could not refresh punchcard after master update:",n)})}),C.onMasterStateChange((n,s)=>{console.log(`🎚️ Master state changed: ${n?"playing":"stopped"}, elements: ${s.join(", ")}`),this.masterActive=n;const r=document.getElementById("play-master-btn"),o=document.querySelector(".master-active-dot");r&&(n?(r.textContent="❚❚",r.title="Pause Master",r.classList.add("active")):(r.textContent="▶",r.title="Play Master",r.classList.remove("active"))),o&&(n?o.classList.add("active"):o.classList.remove("active")),s.forEach(a=>{this.updateStatusDots(a,!0,n)}),n||document.querySelectorAll(".element-circle").forEach(a=>{a.classList.remove("playing")}),n?(this.selectedVisualizer==="off"?this.showMasterPunchcardPlaceholder():this.hideMasterPunchcardPlaceholder(),this.enableNativeStrudelHighlighting()):this.selectedVisualizer==="off"?this.showMasterPunchcardPlaceholder():this.hideMasterPunchcardPlaceholder()}),this.setupAudioInitialization(),this.setupMasterChannel();const e=n=>{console.log("Key pressed:",n.key),(n.key==="Escape"||n.keyCode===27)&&(console.log("🛑 Emergency stop activated (Escape key pressed)"),n.preventDefault(),n.stopPropagation(),C.stopAllSounds(),ot.updateStatus("🛑 All sounds stopped"),this.activeElements.clear(),this.updateActiveElementsDisplay(),et.elements.forEach(s=>{const r=this.elementHasPattern(s.id);this.updateStatusDots(s.id,r,!1)}))};document.addEventListener("keydown",e,!0),window.addEventListener("keydown",e,!0),console.log("✅ Escape key handler registered");const t=document.getElementById("stop-all-btn");t?(t.addEventListener("click",()=>{console.log("🛑 Stop All button clicked"),C.stopAllSounds(),ot.updateStatus("🛑 All sounds stopped"),this.activeElements.clear(),this.updateActiveElementsDisplay(),et.elements.forEach(n=>{const s=this.elementHasPattern(n.id);this.updateStatusDots(n.id,s,!1)})}),console.log("✅ Stop All button handler registered")):console.warn("⚠️ Stop All button not found in DOM"),this.initialized=!0,this.setAllElementsNotLoaded(),this.migrateLocalStorageQuotes(),this.loadAllElementConfigs(),this.setupModal(),this.setupAddElementButton(),ot.updateStatus("Ready - Click anywhere to enable audio (Press Escape to stop all sounds)"),setTimeout(()=>{try{Z$(),this.enableNativeStrudelHighlighting()}catch(n){console.warn("⚠️ Strudel REPL editor initialization failed (non-critical):",n.message),console.log("💡 Pattern editing will use plain textareas instead")}},100),console.log("Interactive Sound App initialized"),console.log("💡 Tip: Press Escape key or click Stop All button to silence everything")}initializeElementVisualizations(e=null,t=null){(e?[e]:document.querySelectorAll(".sound-element")).forEach(s=>{const r=t||s.dataset.soundId;if(!r)return;s.querySelector(".config-button");const o=this.loadElementConfig(r);if(o&&o.pattern&&o.pattern.trim()!==""){this.updateSynthesisSectionVisibility(r,o.pattern);const l=o.title&&o.title.trim()?o.title:o.bank?ur[o.bank]||o.bank:"";On(r,l)}else On(r,"")})}setupMasterChannel(){const e=document.getElementById("master-volume"),t=document.getElementById("master-pan"),n=document.getElementById("master-mute-btn"),s=document.getElementById("master-volume-value"),r=document.getElementById("master-pan-value");if(e){const o=parseFloat(e.value);C.masterVolume=o/100,s&&(s.textContent=Math.round(o)),console.log(`🎚️ Master volume slider initialized: ${o}% (${C.masterVolume})`),e.addEventListener("input",a=>{const l=parseFloat(a.target.value);console.log(`🎚️ Master volume slider changed: ${l}%`),C.setMasterVolume(l/100),s&&(s.textContent=Math.round(l)),C.updateMasterPattern(this.soloedElements,this.mutedElements)}),C.isAudioReady()&&C.masterGainNode?(console.log(`🎚️ Audio already ready, setting master volume to ${o}%`),C.setMasterVolume(o/100)):console.log("🎚️ Audio not ready yet, master volume will be set on initialization")}else console.warn("⚠️ Master volume slider not found in DOM");if(t){const o=parseFloat(t.value);C.masterPan=o,r&&(r.textContent=o.toFixed(2)),console.log(`🎚️ Master pan slider initialized: ${o}`),t.addEventListener("input",a=>{const l=parseFloat(a.target.value);console.log(`🎚️ Master pan slider changed: ${l}`),C.setMasterPan(l),r&&(r.textContent=l.toFixed(2)),C.updateMasterPattern(this.soloedElements,this.mutedElements)}),C.isAudioReady()&&C.masterPanNode?(console.log(`🎚️ Audio already ready, setting master pan to ${o}`),C.setMasterPan(o)):console.log("🎚️ Audio not ready yet, master pan will be set on initialization")}else console.warn("⚠️ Master pan slider not found in DOM");n&&n.addEventListener("click",()=>{console.log("🎚️ Master mute button clicked");const o=C.toggleMasterMute();n.textContent=o?"🔇":"🔊",n.title=o?"Unmute Master":"Mute Master",console.log(`🎚️ Master mute toggled: ${o?"MUTED":"UNMUTED"}`)}),this.setupMasterPatternControls(),this.setupMasterPunchcard(),console.log("✅ Master channel controls setup complete")}tryPlayIntroSample(){if(this.introSamplePlayed||!uf||!C)return;const e=typeof C.getAudioContext=="function"?C.getAudioContext():null,t=C.isAudioReady()&&e,n=()=>{try{C.playAudioFile("intro-sample",uf),this.introSamplePlayed=!0,this.detachIntroSampleActivationHandlers()}catch(s){console.warn("⚠️ Unable to play intro sample automatically:",s)}};t?e.state!=="running"?e.resume().then(()=>{n()}).catch(s=>{console.warn("⚠️ Unable to resume audio context for intro sample:",s),this.attachIntroSampleActivationHandlers()}):n():this.attachIntroSampleActivationHandlers()}attachIntroSampleActivationHandlers(){this._introSampleActivationHandler||this.introSamplePlayed||(this._introSampleActivationHandler=()=>{if(C!=null&&C.getAudioContext){const e=C.getAudioContext();e&&e.state==="suspended"&&e.resume().catch(()=>{})}this.tryPlayIntroSample()},document.addEventListener("pointerdown",this._introSampleActivationHandler,{passive:!0}),document.addEventListener("keydown",this._introSampleActivationHandler))}detachIntroSampleActivationHandlers(){this._introSampleActivationHandler&&(document.removeEventListener("pointerdown",this._introSampleActivationHandler),document.removeEventListener("keydown",this._introSampleActivationHandler),this._introSampleActivationHandler=null)}setupMasterPatternControls(){this.masterPatternField=document.getElementById("master-pattern");const e=document.getElementById("play-master-btn"),t=document.getElementById("update-master-btn"),n=document.querySelector(".master-active-dot");if(!this.masterPatternField){console.warn("⚠️ Master pattern field not found in DOM");return}e&&(e.addEventListener("click",async()=>{if(this.masterActive)console.log("⏸️ Pause Master button clicked"),(await C.stopMasterPattern()).success&&(this.masterActive=!1,C.masterActive=!1,e.textContent="▶",e.title="Play Master",e.classList.remove("active"),n&&n.classList.remove("active"),console.log("✅ Master playback paused"));else{console.log("▶️ Play Master button clicked");const a="modal-preview";if(C.isPlaying(a)){console.log("⏹️ Stopping modal preview before playing master"),C.stopSound(a);const c=document.getElementById("modal-preview-btn");c&&(c.textContent="▶ Preview Pattern",c.classList.remove("active"))}const l=Ae("master-pattern").trim();if(l&&l!==C.getMasterPatternCode()){if(C.masterPattern=C.formatMasterPatternWithTempoComment(l),typeof this.syncElementsFromMasterPattern=="function")try{this.syncElementsFromMasterPattern(C.masterPattern)}catch(c){console.warn("⚠️ Could not sync elements from master code before play:",c)}console.log("📝 Updated master pattern code directly before playing")}this.selectedVisualizer&&this.selectedVisualizer!=="punchcard"&&this.selectedVisualizer!=="off"?(console.log(`🎨 Preparing canvas for visualizer "${this.selectedVisualizer}"`),await this.prepareCanvasForExternalVisualizer()):this.showMasterPunchcardPlaceholder(),console.log(`🎨 Applying visualizer "${this.selectedVisualizer||"off"}" before playing`);try{await this.applyVisualizerToMaster()}catch(c){console.warn("⚠️ Error applying visualizer, continuing with playback:",c)}const d=await C.playMasterPattern();d.success?(this.masterActive=!0,e.textContent="❚❚",e.title="Pause Master",e.classList.add("active"),n&&n.classList.add("active"),console.log("✅ Master playback started")):(console.error("❌ Failed to play master:",d.error),alert(`Failed to play master: ${d.error}`))}}),this._masterSpacebarHandlerAttached||(this._masterSpacebarHandlerAttached=!0,document.addEventListener("keydown",async a=>{var u;if(a.code!=="Space")return;const l=document.activeElement,d=(u=l==null?void 0:l.tagName)==null?void 0:u.toLowerCase();l!=null&&l.isContentEditable||d==="textarea"||d==="input"&&(l==null?void 0:l.type)!=="button"&&(l==null?void 0:l.type)!=="checkbox"&&(l==null?void 0:l.type)!=="range"||d==="select"||(a.preventDefault(),e.click())})));const s=document.getElementById("export-audio-btn");s&&s.addEventListener("click",async()=>{if(console.log("🎵 Export Audio button clicked"),!C.getMasterPatternCode()||C.getMasterPatternCode().trim()===""){alert("No master pattern to export. Please create a pattern first.");return}const a=prompt("Enter export duration in seconds (default: 16):","16");if(a===null)return;const l=parseInt(a)||16;s.disabled=!0,s.textContent="⏳ Exporting...";try{const d=await C.exportAudioWAV(l);d.success?(d.warning?alert(`⚠️ Audio exported as ${d.format.toUpperCase()}!

${d.warning}`):alert(`✅ Audio exported successfully as ${d.format.toUpperCase()}!`),console.log("✅ Audio export complete")):(alert(`❌ Export failed: ${d.error}`),console.error("❌ Audio export failed:",d.error))}catch(d){alert(`❌ Export error: ${d.message}`),console.error("❌ Audio export error:",d)}finally{s.disabled=!1,s.textContent="🎵 Export Audio"}}),t&&t.addEventListener("click",async()=>{console.log("💾 Update Master button clicked");const a=Ae("master-pattern").trim();if(!a){alert("Master pattern is empty");return}const l=await C.setMasterPatternCode(a);l.success?(console.log("✅ Master pattern code updated"),alert("Master pattern updated successfully!")):(console.error("❌ Failed to update master:",l.error),alert(`Failed to update master: ${l.error}`))});const r=document.getElementById("copy-code-btn");r&&r.addEventListener("click",async()=>{const a=this.masterPatternField.value.trim();if(!a){alert("Master pattern is empty");return}try{const l="// Created with Strudesk 4000 by eKommissar",d=a.startsWith(l)?a:`${l}

${a}`;await navigator.clipboard.writeText(d);const c=r.textContent;r.textContent="✓ Copied!",r.title="Copied!",setTimeout(()=>{r.textContent=c,r.title="Copy"},2e3),console.log("✅ Master pattern code copied to clipboard")}catch(l){console.error("❌ Failed to copy code:",l),alert("Failed to copy code to clipboard")}});const o=document.getElementById("clear-all-btn");o&&o.addEventListener("click",()=>{confirm("Are you sure you want to clear all? This will clear the master pattern and all element configurations.")&&(console.log("🗑️ Clear All button clicked"),this.resetAll())}),console.log("✅ Master pattern controls setup complete")}setupMasterPunchcard(){if(this.masterPunchcardContainer=document.getElementById("master-punchcard"),this.masterPunchcardCanvas=document.getElementById("master-punchcard-canvas"),this.masterPunchcardPlaceholder=this.masterPunchcardContainer?this.masterPunchcardContainer.querySelector(".punchcard-placeholder"):null,!this.masterPunchcardContainer||!this.masterPunchcardCanvas){console.warn("⚠️ Master punchcard elements not found in DOM");return}const e=this.getMasterPunchcardContext();e&&(window.__strudelVisualizerCtx=e),this.selectedVisualizer="off";const t=document.getElementById("visualizer-select");this.visualizerSelect=t,t&&(t.value=this.selectedVisualizer,t.addEventListener("change",async s=>{this.selectedVisualizer=s.target.value,console.log(`🎨 Visualizer changed to: ${this.selectedVisualizer}`),this.selectedVisualizer==="off"?this.showMasterPunchcardPlaceholder():this.selectedVisualizer!=="punchcard"?await this.prepareCanvasForExternalVisualizer():this.showMasterPunchcardPlaceholder(),await this.applyVisualizerToMaster(),this.refreshMasterPunchcard("visualizer-change").catch(r=>{console.warn("⚠️ Unable to refresh punchcard after visualizer change:",r)})})),this.visualizerFullscreenBtn=document.getElementById("visualizer-fullscreen-btn"),this.visualizerFullscreenBtn&&(this.visualizerFullscreenBtn.addEventListener("click",()=>{this.toggleVisualizerFullscreen()}),this.updateVisualizerFullscreenButton(!1));const n=document.getElementById("chaospad-checkbox");if(n&&n.addEventListener("change",async s=>{if(this.chaospadEnabled=s.target.checked,console.log(`🎛️ Chaospad ${this.chaospadEnabled?"enabled":"disabled"}`),this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.cursor=this.chaospadEnabled?"pointer":""),!this.chaospadEnabled)console.log("🎛️ Chaospad: Disabled - removing cutoff"),await this.removeCutoffFromMaster();else if(console.log("🎛️ Chaospad: Enabled - applying initial cutoff"),this.masterPunchcardCanvas){const r=this.masterPunchcardCanvas.getBoundingClientRect();if(r.width>0){const o={clientX:r.left+r.width/2};this.handleChaospadMouseMove(o)}else console.log("🎛️ Chaospad: Canvas not ready, applying default cutoff 4250 Hz"),await this.applyCutoffToMaster(4250)}else console.log("🎛️ Chaospad: No canvas, applying default cutoff 4250 Hz"),await this.applyCutoffToMaster(4250)}),this.masterPunchcardCanvas){const s=()=>{this.chaospadEnabled?this.masterPunchcardCanvas.style.cursor="pointer":this.masterPunchcardCanvas.style.cursor=""};this.masterPunchcardCanvas.addEventListener("mousemove",r=>{this.chaospadEnabled&&this.handleChaospadMouseMove(r)}),this.masterPunchcardCanvas.addEventListener("mouseenter",r=>{this.chaospadEnabled&&this.handleChaospadMouseMove(r)}),s()}this.showMasterPunchcardPlaceholder(),this.handleChaospadMouseMove=this.handleChaospadMouseMove.bind(this),this.removeCutoffFromMaster=this.removeCutoffFromMaster.bind(this),window.addEventListener("resize",()=>{this.masterPunchcardResizeTimer&&clearTimeout(this.masterPunchcardResizeTimer),this.masterPunchcardResizeTimer=setTimeout(()=>{this.refreshMasterPunchcard("resize").catch(s=>{console.warn("⚠️ Unable to refresh punchcard after resize:",s)})},150)}),this.refreshMasterPunchcard("initial").catch(s=>{console.warn("⚠️ Unable to render initial punchcard:",s)})}getCurrentFullscreenElement(){return document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement||null}async toggleVisualizerFullscreen(){if(!this.masterPunchcardContainer)return;const e=this.getCurrentFullscreenElement(),t=this.masterPunchcardContainer.classList.contains("is-fullscreen")&&!e;if(e===this.masterPunchcardContainer||t){e===this.masterPunchcardContainer?document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.mozCancelFullScreen?await document.mozCancelFullScreen():document.msExitFullscreen&&await document.msExitFullscreen():(this.masterPunchcardContainer.classList.remove("is-fullscreen"),document.body.style.overflow="",this.updateVisualizerFullscreenButton(!1),this.removeMobileFullscreenCloseButton());return}try{if(this.masterPunchcardContainer.requestFullscreen){await this.masterPunchcardContainer.requestFullscreen();return}if(this.masterPunchcardContainer.webkitRequestFullscreen)try{const n=typeof Element<"u"&&Element.ALLOW_KEYBOARD_INPUT!==void 0?Element.ALLOW_KEYBOARD_INPUT:void 0;n!==void 0?await this.masterPunchcardContainer.webkitRequestFullscreen(n):await this.masterPunchcardContainer.webkitRequestFullscreen();return}catch(n){console.warn("⚠️ Webkit fullscreen failed, trying fallback:",n)}if(this.masterPunchcardContainer.mozRequestFullScreen){await this.masterPunchcardContainer.mozRequestFullScreen();return}if(this.masterPunchcardContainer.msRequestFullscreen){await this.masterPunchcardContainer.msRequestFullscreen();return}if(this.isMobileDevice()){this.masterPunchcardContainer.classList.add("is-fullscreen"),document.body.style.overflow="hidden",this.updateVisualizerFullscreenButton(!0),this.addMobileFullscreenCloseButton(),setTimeout(()=>{this.refreshMasterPunchcard("css-fullscreen").catch(n=>{console.warn("⚠️ Unable to refresh punchcard after CSS fullscreen:",n)})},100);return}console.warn("⚠️ Fullscreen API not supported on this device")}catch(n){console.warn("⚠️ Unable to enter visualizer fullscreen:",n),this.isMobileDevice()&&(this.masterPunchcardContainer.classList.add("is-fullscreen"),document.body.style.overflow="hidden",this.updateVisualizerFullscreenButton(!0),this.addMobileFullscreenCloseButton(),setTimeout(()=>{this.refreshMasterPunchcard("css-fullscreen-fallback").catch(s=>{console.warn("⚠️ Unable to refresh punchcard after CSS fullscreen fallback:",s)})},100))}}isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.innerWidth<=768&&"ontouchstart"in window}addMobileFullscreenCloseButton(){if(this.removeMobileFullscreenCloseButton(),!this.masterPunchcardContainer)return;const e=document.createElement("button");e.id="mobile-fullscreen-close",e.className="mobile-fullscreen-close-btn",e.innerHTML="✕",e.setAttribute("aria-label","Close fullscreen"),e.addEventListener("click",()=>{this.toggleVisualizerFullscreen()}),this.masterPunchcardContainer.appendChild(e)}removeMobileFullscreenCloseButton(){const e=document.getElementById("mobile-fullscreen-close");e&&e.remove()}updateVisualizerFullscreenButton(e){this.visualizerFullscreenBtn&&(this.visualizerFullscreenBtn.classList.toggle("is-active",e),this.visualizerFullscreenBtn.setAttribute("aria-label",e?"Exit visualizer fullscreen":"Enter visualizer fullscreen"))}handleVisualizerFullscreenChange(){const t=this.getCurrentFullscreenElement()===this.masterPunchcardContainer;this.masterPunchcardContainer&&(this.masterPunchcardContainer.classList.toggle("is-fullscreen",t),!t&&this.isMobileDevice()?(document.body.style.overflow="",this.removeMobileFullscreenCloseButton()):t&&this.isMobileDevice()&&setTimeout(()=>{this.addMobileFullscreenCloseButton()},100)),this.updateVisualizerFullscreenButton(t),this.refreshMasterPunchcard("fullscreen-change").catch(n=>{console.warn("⚠️ Unable to refresh punchcard after fullscreen change:",n)})}async applyVisualizerToMaster(){var u;if(console.log(`🎨 Applying visualizer "${this.selectedVisualizer}" to master pattern`),this.selectedVisualizer==="off"){this.scopeSpectrumObserver=null,this.scopeSpectrumCopyLoop=null,this.teardownExternalVisualizerCanvas(),this.stopVisualizerAnimation();let h=C.getMasterPatternCode();if(!h||h.trim()===""){if(C.trackedPatterns&&C.trackedPatterns.size>0&&(console.log(`🔄 Master pattern is empty but ${C.trackedPatterns.size} tracked pattern(s) found - rebuilding master pattern`),C.updateMasterPattern(new Set,new Set),h=C.getMasterPatternCode()),!h||h.trim()===""){const g=Ae("master-pattern").trim();g&&g!==""&&(console.log("📝 Reading master pattern from editor"),h=g)}(!h||h.trim()==="")&&(console.warn("⚠️ No master pattern to apply visualizer to, using silence"),h="silence")}h=h.replace(/\/\/.*$/gm,""),h=h.replace(/\/\*[\s\S]*?\*\//g,g=>/\/\*\s*Channel\s+\d+\s*\*\//i.test(g)?g:""),h=h.replace(/\n\s*\n/g,`
`).trim();const f=(g,O)=>{let p=1;for(let y=O+1;y<g.length;y++)if(g[y]==="(")p++;else if(g[y]===")"&&(p--,p===0))return y;return-1};["scope","tscope","fscope","spectrum","visual","pianoroll","barchart"].forEach(g=>{const O=new RegExp(`\\.\\s*_?${g}\\s*\\(`,"gi");let p;for(;(p=O.exec(h))!==null;){const y=p.index,M=p.index+p[0].length-1,b=f(h,M);if(b!==-1)h=h.substring(0,y)+h.substring(b+1),O.lastIndex=0;else break}}),h=h.trim().replace(/\.\s*$/,"").replace(/\.\.+/g,".").trim(),await C.setMasterPatternCode(h),this.showMasterPunchcardPlaceholder(),this.refreshMasterPunchcard("visualizer-off").catch(g=>{console.warn("⚠️ Unable to refresh punchcard after turning off visualizer:",g)});return}this.scopeSpectrumObserver=null,this.scopeSpectrumCopyLoop=null,this.teardownExternalVisualizerCanvas(),this.stopVisualizerAnimation(),this.selectedVisualizer!=="pianoroll"&&document.querySelectorAll('canvas[data-processed="true"]').forEach(f=>{f.id!=="master-punchcard-canvas"&&f.remove()}),await this.prepareCanvasForExternalVisualizer();let e=C.getMasterPatternCode();if(!e||e.trim()===""){if(C.trackedPatterns&&C.trackedPatterns.size>0&&(console.log(`🔄 Master pattern is empty but ${C.trackedPatterns.size} tracked pattern(s) found - rebuilding master pattern`),C.updateMasterPattern(new Set,new Set),e=C.getMasterPatternCode()),!e||e.trim()===""){const h=Ae("master-pattern").trim();h&&h!==""&&(console.log("📝 Reading master pattern from editor"),e=h)}(!e||e.trim()==="")&&(console.warn("⚠️ No master pattern to apply visualizer to, using silence"),e="silence")}e=e.replace(/\/\/.*$/gm,""),e=e.replace(/\/\*[\s\S]*?\*\//g,h=>/\/\*\s*Channel\s+\d+\s*\*\//i.test(h)?h:""),e=e.replace(/\n\s*\n/g,`
`).trim();const t=(h,f)=>{let m=1;for(let g=f+1;g<h.length;g++)if(h[g]==="(")m++;else if(h[g]===")"&&(m--,m===0))return g;return-1};["scope","tscope","fscope","spectrum","visual","pianoroll","barchart"].forEach(h=>{const f=new RegExp(`\\.\\s*_?${h}\\s*\\(`,"gi");let m;for(;(m=f.exec(e))!==null;){const g=m.index,O=m.index+m[0].length-1,p=t(e,O);if(p!==-1)e=e.substring(0,g)+e.substring(p+1),f.lastIndex=0;else break}}),e=e.trim().replace(/\.\s*$/,"").replace(/\.\.+/g,".").trim();let s=e;const r="master-punchcard-canvas";if(this.selectedVisualizer==="scope"||this.selectedVisualizer==="barchart"||this.selectedVisualizer==="spectrum"){C.setupVisualizerAnalyser(),await new Promise(m=>setTimeout(m,100));const h=r,f=((u=window.strudel)==null?void 0:u.getAnalyserById)||globalThis.getAnalyserById;if(f)try{const m=f(h);m&&m.context===C.audioContext?console.log(`✅ Verified analyser "${h}" is ready in correct audio context`):console.warn(`⚠️ Analyser "${h}" not ready or in wrong context`)}catch(m){console.warn("⚠️ Could not verify analyser:",m.message)}}const o=document.getElementById(r);if(o){o.style.position="relative",o.style.display="block",o.style.visibility="visible",o.style.opacity="1",o.style.left="0",o.style.top="0",o.style.width="100%",o.style.height="100%",o.id=r;const h=document.getElementById("master-punchcard");if(h&&o.parentNode!==h&&h.appendChild(o),h){const f=h.getBoundingClientRect(),m=window.devicePixelRatio||1,g=Math.max(f.width||320,320),O=Math.max(f.height||200,200);o.width=g*m,o.height=O*m,o.style.width=`${g}px`,o.style.height=`${O}px`,(this.selectedVisualizer==="scope"||this.selectedVisualizer==="barchart"||this.selectedVisualizer==="spectrum")&&(o.offsetHeight,console.log(`✅ Canvas "${r}" is ready for ${this.selectedVisualizer}:`,{id:o.id,width:o.width,height:o.height,visible:o.style.display!=="none",inDOM:document.contains(o)}))}}else console.error(`❌ Canvas "${r}" not found!`);if((this.selectedVisualizer==="scope"||this.selectedVisualizer==="barchart"||this.selectedVisualizer==="spectrum")&&(o&&o.id!==r&&(o.id=r),this.masterPunchcardCanvas.style.display="block"),this.selectedVisualizer==="pianoroll")try{const{getDrawContext:h}=await We(async()=>{const{getDrawContext:m}=await import("./strudel-web-C25uHgU2.js").then(g=>g.a);return{getDrawContext:m}},__vite__mapDeps([0,1])),f=h(r,{contextType:"2d"});window.__strudelVisualizerCtx=f,console.log(`✅ Registered canvas "${r}" with getDrawContext for ${this.selectedVisualizer}`)}catch(h){console.warn(`⚠️ Failed to register canvas with getDrawContext for ${this.selectedVisualizer}:`,h)}this.selectedVisualizer==="scope"||this.selectedVisualizer==="barchart"?s=e:this.selectedVisualizer==="spectrum"?s=`${e}._spectrum({
        id: '${r}',
        ctx: (window.__strudelVisualizerCtx || (document.getElementById('master-punchcard-canvas') && document.getElementById('master-punchcard-canvas').getContext && document.getElementById('master-punchcard-canvas').getContext('2d'))),
        thickness: 3,
        speed: 1,
        min: -80,
        max: 0
      })`:this.selectedVisualizer==="pianoroll"&&(this.externalVisualizerType="pianoroll",this.watchForExternalVisualizerCanvas("pianoroll"),this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.display="none"),s=`${e}.pianoroll({ 
          cycles: 4,
          playhead: 0.5,
          fill: true,
          fillActive: true,
          stroke: true,
          strokeActive: true,
          autorange: true,
          colorizeInactive: true,
          background: '#05060a'
        })`),console.log(`🎨 Pattern with visualizer: ${s.substring(0,150)}...`),console.log("🎨 Full pattern with visualizer:",s),(!s||s.trim()==="")&&(console.warn("⚠️ Pattern with visualizer is empty, using base pattern"),s=e||"silence");const l=this.selectedVisualizer==="scope"||this.selectedVisualizer==="barchart",d=!l&&this.selectedVisualizer!=="punchcard"&&this.selectedVisualizer!=="off";let c=!0;d?(c=new RegExp(`\\.\\s*_?${this.selectedVisualizer}\\s*\\(`).test(s),c?console.log(`✅ Visualizer "${this.selectedVisualizer}" found in pattern`):console.error(`❌ Visualizer "${this.selectedVisualizer}" not found in pattern! Pattern:`,s)):l&&console.log(`✅ Using internal analyser visualizer for ${this.selectedVisualizer}`),await C.setMasterPatternCode(s),this.selectedVisualizer==="off"?(this.stopVisualizerAnimation(),this.showMasterPunchcardPlaceholder()):this.selectedVisualizer==="scope"?this.startScopeVisualizerLoop():this.selectedVisualizer==="barchart"?this.startBarchartVisualizerLoop():this.selectedVisualizer==="pianoroll"&&(this.watchForExternalVisualizerCanvas("pianoroll"),this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.display="none"),this.hideMasterPunchcardPlaceholder()),this.refreshMasterPunchcard("visualizer-applied").catch(h=>{console.warn("⚠️ Unable to refresh punchcard after applying visualizer:",h)})}showMasterPunchcardPlaceholder(){this.masterPunchcardContainer&&(this.masterPunchcardPlaceholder&&this.masterPunchcardPlaceholder.classList.remove("hidden"),this.masterPunchcardCanvas&&this.masterPunchcardCtx&&(this.masterPunchcardCtx.setTransform(1,0,0,1,0,0),this.masterPunchcardCtx.clearRect(0,0,this.masterPunchcardCanvas.width,this.masterPunchcardCanvas.height)))}async refreshMasterPunchcard(e="auto"){if(!this.masterPunchcardContainer)return;if(this.selectedVisualizer==="off"){this.stopVisualizerAnimation(),this.showMasterPunchcardPlaceholder(),this.masterPunchcardCanvas&&this.masterPunchcardCtx&&(this.masterPunchcardCtx.setTransform(1,0,0,1,0,0),this.masterPunchcardCtx.clearRect(0,0,this.masterPunchcardCanvas.width,this.masterPunchcardCanvas.height));return}const t=C.getMasterPatternCode();if(!t||t.trim()===""){this.showMasterPunchcardPlaceholder();return}const n=this.shouldUseSpiralVisualizer(t),s=!n&&this.shouldUseScopeVisualizer(t),r=!n&&!s&&this.shouldUseSpectrumVisualizer(t),o=!n&&!s&&!r&&this.shouldUsePitchwheelVisualizer(t),a=!n&&!s&&!r&&!o&&this.shouldUsePianorollVisualizer(t),l=!n&&!s&&!r&&!o&&!a&&this.shouldUseBarchartVisualizer(t);r&&this.selectedVisualizer!=="spectrum"&&(!this.selectedVisualizer||this.selectedVisualizer==="off"||["scope","punchcard","barchart"].includes(this.selectedVisualizer))&&(this.selectedVisualizer="spectrum",this.visualizerSelect&&(this.visualizerSelect.value="spectrum")),a&&this.selectedVisualizer!=="pianoroll"&&(!this.selectedVisualizer||["scope","punchcard","barchart","spectrum"].includes(this.selectedVisualizer))&&(this.selectedVisualizer="pianoroll",this.visualizerSelect&&(this.visualizerSelect.value="pianoroll"));const d=this.selectedVisualizer||"punchcard";if(d==="scope"){await this.prepareCanvasForExternalVisualizer(),this.startScopeVisualizerLoop(),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardIsRendering=!1;return}if(d==="barchart"){await this.prepareCanvasForExternalVisualizer(),this.startBarchartVisualizerLoop(),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardIsRendering=!1;return}if(d==="spectrum"){await this.prepareCanvasForExternalVisualizer(),this.watchForExternalVisualizerCanvas("spectrum"),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardIsRendering=!1;return}if(d==="pianoroll"){this.watchForExternalVisualizerCanvas("pianoroll"),this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.display="none"),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardIsRendering=!1;return}if(d!=="scope"&&d!=="barchart"&&this.stopVisualizerAnimation(),this.selectedVisualizer==="off"){this.stopVisualizerAnimation(),this.showMasterPunchcardPlaceholder();return}if(s||r||n||o||a||l){(this.selectedVisualizer||"punchcard")==="punchcard"&&s&&this.watchForExternalVisualizerCanvas("scope"),a&&(this.watchForExternalVisualizerCanvas("pianoroll"),this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.display="none")),await this.prepareCanvasForExternalVisualizer(),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardIsRendering=!1;return}if(this.masterPunchcardIsRendering){this.masterPunchcardPendingRefresh=!0;return}this.masterPunchcardIsRendering=!0;try{const c=this.currentTimeSignatureMetrics||xn(this.currentTimeSignature||"4/4"),u=await this.computeMasterPunchcardData(t,c);if(!u||u.error){const f=u!=null&&u.error?`Unable to render punchcard: ${u.error}`:"Unable to render punchcard.";console.warn(f,{reason:e,data:u}),this.showMasterPunchcardPlaceholder();return}if(!u.counts||u.counts.length===0){this.showMasterPunchcardPlaceholder();return}if(Math.max(...u.counts)<=0){this.showMasterPunchcardPlaceholder();return}this.renderMasterPunchcard(c,u)}finally{this.masterPunchcardIsRendering=!1,this.masterPunchcardPendingRefresh&&(this.masterPunchcardPendingRefresh=!1,this.refreshMasterPunchcard("queued-refresh").catch(c=>{console.warn("⚠️ Queued punchcard refresh failed:",c)}))}}renderMasterPunchcard(e,t){!this.masterPunchcardContainer||!this.masterPunchcardCanvas||(this.hideMasterPunchcardPlaceholder(),this.drawMasterPunchcardCanvas(e,t))}async prepareCanvasForExternalVisualizer(){if(!this.masterPunchcardContainer||!this.masterPunchcardCanvas){console.warn("⚠️ Canvas elements not found for visualizer");return}const e=this.masterPunchcardCanvas.id;if(console.log(`🎨 Preparing canvas for external visualizer: ${e}`),!document.getElementById(e)){console.error(`❌ Canvas "${e}" not found via getElementById!`);return}console.log(`✅ Canvas "${e}" is accessible via getElementById`),this.hideMasterPunchcardPlaceholder(),this.masterPunchcardCanvas.style.position="relative",this.masterPunchcardCanvas.style.left="0",this.masterPunchcardCanvas.style.top="0",this.masterPunchcardCanvas.style.width="100%",this.masterPunchcardCanvas.style.height="100%",this.masterPunchcardCanvas.style.display="block";const n=["scope","barchart","spectrum"];this.masterPunchcardCanvas.style.background=n.includes(this.selectedVisualizer)?"#05060a":"rgba(255, 255, 255, 0.9)";let s;try{const{getDrawContext:r}=await We(async()=>{const{getDrawContext:o}=await import("./strudel-web-C25uHgU2.js").then(a=>a.a);return{getDrawContext:o}},__vite__mapDeps([0,1]));s=r(e,{contextType:"2d"}),console.log(`✅ Got draw context via getDrawContext for ${e}`)}catch(r){console.warn("⚠️ getDrawContext failed, falling back to native:",r),s=this.masterPunchcardCanvas.getContext("2d")}if(s&&(this.sizeCanvasToContainer(this.masterPunchcardCanvas,s),window.__strudelVisualizerCtx=s,window.strudel&&window.strudel.controls))try{window.strudel.controls.setCanvas(e),console.log(`✅ Registered canvas "${e}" with Strudel controls`)}catch(r){console.log("ℹ️ Could not register with strudel.controls:",r.message)}}sizeCanvasToContainer(e,t){if(!e||!this.masterPunchcardContainer)return;const n=this.masterPunchcardContainer.getBoundingClientRect(),s=Math.max(n.width||this.masterPunchcardContainer.offsetWidth||320,240),r=Math.max(n.height||this.masterPunchcardContainer.offsetHeight||200,220),o=window.devicePixelRatio||1;e.width=s*o,e.height=r*o,e.style.width="100%",e.style.height="100%",e.style.display="block",e.style.opacity="1",t&&(t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,e.width,e.height),t.setTransform(o,0,0,o,0,0))}ensureVisualizerAnalyser(){return C?(C.visualizerAnalyser||typeof C.setupVisualizerAnalyser=="function"&&C.setupVisualizerAnalyser(),C.visualizerAnalyser||null):null}stopVisualizerAnimation(){this.scopeAnimationFrame&&(cancelAnimationFrame(this.scopeAnimationFrame),this.scopeAnimationFrame=null),this.barchartAnimationFrame&&(cancelAnimationFrame(this.barchartAnimationFrame),this.barchartAnimationFrame=null),this.activeVisualizerLoop=null}drawVisualizerMessage(e){const t=this.masterPunchcardCanvas,n=this.getMasterPunchcardContext();if(!t||!n)return;this.sizeCanvasToContainer(t,n);const s=window.devicePixelRatio||1,r=t.width/s,o=t.height/s;n.fillStyle="rgba(5, 6, 10, 0.92)",n.fillRect(0,0,r,o),n.fillStyle="#94a3b8",n.font='14px "Fira Sans", "Inter", system-ui, sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillText(e,r/2,o/2)}startScopeVisualizerLoop(){if(this.activeVisualizerLoop==="scope")return;const e=this.masterPunchcardCanvas,t=this.getMasterPunchcardContext();if(!e||!t)return;const n=this.ensureVisualizerAnalyser();if(!n){this.drawVisualizerMessage("Scope analyser unavailable");return}const s=n.fftSize||2048;(!this.scopeDataArray||this.scopeDataArray.length!==s)&&(this.scopeDataArray=new Uint8Array(s)),this.activeVisualizerLoop="scope";const r=()=>{if(this.selectedVisualizer!=="scope"){this.stopVisualizerAnimation();return}const o=this.getMasterPunchcardContext();if(!o){this.stopVisualizerAnimation();return}this.hideMasterPunchcardPlaceholder(),this.masterPunchcardCanvas.style.display="block",this.sizeCanvasToContainer(e,o),n.getByteTimeDomainData(this.scopeDataArray);const a=window.devicePixelRatio||1,l=e.width/a,d=e.height/a;o.fillStyle="rgba(5, 6, 10, 0.92)",o.fillRect(0,0,l,d);const c=d/2;o.strokeStyle="#38bdf8",o.lineWidth=2,o.beginPath();const u=l/this.scopeDataArray.length;let h=0;for(let f=0;f<this.scopeDataArray.length;f++){const g=this.scopeDataArray[f]/128*d/2;f===0?o.moveTo(h,g):o.lineTo(h,g),h+=u}o.lineTo(l,c),o.stroke(),o.strokeStyle="rgba(14, 165, 233, 0.4)",o.beginPath(),o.moveTo(0,c),o.lineTo(l,c),o.stroke(),this.scopeAnimationFrame=requestAnimationFrame(r)};r()}startBarchartVisualizerLoop(){var l;if(this.activeVisualizerLoop==="barchart")return;const e=this.masterPunchcardCanvas,t=this.getMasterPunchcardContext();if(!e||!t)return;const n=this.ensureVisualizerAnalyser();if(!n){this.drawVisualizerMessage("Spectrum analyser unavailable");return}const s=n.frequencyBinCount||1024;(!this.spectrumDataArray||this.spectrumDataArray.length!==s)&&(this.spectrumDataArray=new Uint8Array(s));const o=(((l=n.context)==null?void 0:l.sampleRate)||44100)/2;this.activeVisualizerLoop="barchart";const a=()=>{if(this.selectedVisualizer!=="barchart"){this.stopVisualizerAnimation();return}const d=this.getMasterPunchcardContext();if(!d){this.stopVisualizerAnimation();return}this.hideMasterPunchcardPlaceholder(),this.masterPunchcardCanvas.style.display="block",this.sizeCanvasToContainer(e,d),n.getByteFrequencyData(this.spectrumDataArray);const c=window.devicePixelRatio||1,u=e.width/c,h=e.height/c;d.fillStyle="rgba(5, 6, 10, 0.92)",d.fillRect(0,0,u,h);const f=Math.min(200,Math.floor(u/2)),m=[];for(let O=0;O<this.spectrumDataArray.length;O++){const p=O/this.spectrumDataArray.length*o;if(p>=20&&p<=2e4){const y=fl(p),M=this.spectrumDataArray[O]/255;m.push({position:y,value:M,frequency:p})}}m.sort((O,p)=>O.position-p.position);const g=u/f;for(let O=0;O<f;O++){const p=O/f,y=1/f,M=p<.3?y*4:p<.6?y*2:y,b=m.filter(F=>Math.abs(F.position-p)<M);let S=b.length>0?Math.max(...b.map(F=>F.value)):0;if(S===0&&m.length>0){let F=0,W=1/0;for(const z of m){const ce=Math.abs(z.position-p);if(ce<W)W=ce,F=z.value;else if(ce>W)break}S=F}const k=Math.max(S*h,2),x=p*u,E=h-k,B=d.createLinearGradient(x,E,x,h);B.addColorStop(0,"rgba(56, 189, 248, 0.95)"),B.addColorStop(1,"rgba(14, 116, 144, 0.75)"),d.fillStyle=B,d.fillRect(x,E,g+1,k)}this.barchartAnimationFrame=requestAnimationFrame(a)};a()}teardownExternalVisualizerCanvas(){this.externalVisualizerObserver&&(this.externalVisualizerObserver.disconnect(),this.externalVisualizerObserver=null),this.externalVisualizerCanvas&&this.externalVisualizerCanvas.parentNode&&this.externalVisualizerCanvas.remove(),this.externalVisualizerCanvas=null,this.externalVisualizerType=null,this.masterPunchcardCanvas&&(this.masterPunchcardCanvas.style.display="")}attachExternalVisualizerCanvas(e){return!e||!this.masterPunchcardContainer?!1:(this.masterPunchcardCanvas.style.display="none",this.hideMasterPunchcardPlaceholder(),this.masterPunchcardContainer.style.position===""&&(this.masterPunchcardContainer.style.position="relative"),e.dataset.visualizerAttached="true",e.style.position="relative",e.style.left="0",e.style.top="0",e.style.pointerEvents="auto",this.sizeCanvasToContainer(e,e.getContext("2d")),this.masterPunchcardContainer.appendChild(e),this.externalVisualizerCanvas=e,!0)}watchForExternalVisualizerCanvas(e){const t=()=>{const n=this.findExternalVisualizerCanvasCandidate(e);return n?this.attachExternalVisualizerCanvas(n):!1};t()||(this.externalVisualizerObserver=new MutationObserver(()=>{t()&&this.externalVisualizerObserver&&(this.externalVisualizerObserver.disconnect(),this.externalVisualizerObserver=null)}),this.externalVisualizerObserver.observe(document.body,{childList:!0,subtree:!0}))}findExternalVisualizerCanvasCandidate(e){const t=Array.from(document.querySelectorAll("canvas"));for(const n of t)if(n!==this.masterPunchcardCanvas&&n.dataset.visualizerAttached!=="true"&&(e==="pianoroll"&&this.isPianorollCanvas(n)||e==="scope"&&this.isScopeCanvas(n)||e==="spectrum"&&this.isSpectrumCanvas(n)))return n;return null}isPianorollCanvas(e){if(!e)return!1;if(e.dataset.pianoroll!==void 0)return!0;const t=e.className||"";if(/pianoroll/i.test(t))return!0;const n=e.getBoundingClientRect();return n.width===0||n.height===0?!1:n.width>window.innerWidth*.6&&n.height>window.innerHeight*.4}isScopeCanvas(e){if(!e)return!1;const t=(e.id||"").toLowerCase(),n=(e.className||"").toLowerCase();if(t.includes("scope")||n.includes("scope")||e.dataset.scope!==void 0)return!0;const s=e.getBoundingClientRect();return s.width>window.innerWidth*.5&&s.height<260}isSpectrumCanvas(e){if(!e)return!1;const t=(e.id||"").toLowerCase(),n=(e.className||"").toLowerCase();if(t.includes("spectrum")||n.includes("spectrum")||e.dataset.spectrum!==void 0)return!0;const s=e.getBoundingClientRect();return s.width>window.innerWidth*.5&&s.height<400}hideMasterPunchcardPlaceholder(){this.masterPunchcardPlaceholder&&this.masterPunchcardPlaceholder.classList.add("hidden")}handleChaospadMouseMove(e){if(!this.masterPunchcardCanvas||!this.chaospadEnabled){console.log("🎛️ Chaospad: Skipping - canvas or enabled check failed",{hasCanvas:!!this.masterPunchcardCanvas,enabled:this.chaospadEnabled});return}const t=this.masterPunchcardCanvas.getBoundingClientRect(),n=e.clientX-t.left,s=t.width;if(s===0){console.log("⚠️ Chaospad: Canvas not sized yet");return}const r=Math.max(0,Math.min(1,n/s)),o=500,l=Math.round(o+(8e3-o)*r),d=Date.now();(this.currentCutoffValue===null||Math.abs(this.currentCutoffValue-l)>50||this.lastCutoffUpdate&&d-this.lastCutoffUpdate>100)&&(console.log(`🎛️ Chaospad: Mouse at ${(r*100).toFixed(1)}% - updating cutoff to ${l} Hz`),this.currentCutoffValue=l,this.lastCutoffUpdate=d,this.applyCutoffToMaster(l))}async applyCutoffToMaster(e){try{let t=C.getMasterPatternCode();if(!t||t.trim()===""){console.log("⚠️ Chaospad: No master pattern to apply cutoff to");return}console.log(`🎛️ Chaospad: Base pattern before cutoff: ${t.substring(0,100)}...`),t=t.replace(/\.\s*cutoff\s*\([^)]*\)/gi,""),t=t.trim().replace(/\.\s*$/,"").replace(/\.\.+/g,".").trim();let n;const s=t.match(/stack\s*\(/);if(s){let r=s.index+s[0].length-1,o=1,a=r+1,l=!1,d=null;for(;a<t.length&&o>0;){const c=t[a];!l&&(c==='"'||c==="'")?(l=!0,d=c):l&&c===d&&t[a-1]!=="\\"&&(l=!1,d=null),l||(c==="("?o++:c===")"&&o--),o>0&&a++}if(o===0){const c=t.substring(0,a+1),u=t.substring(a+1);n=`${c}.cutoff(${e})${u}`,console.log(`🎛️ Chaospad: Inserted cutoff after stack at position ${a}`)}else n=`${t}.cutoff(${e})`,console.log("🎛️ Chaospad: Couldn't find stack end, appending cutoff")}else n=`${t}.cutoff(${e})`,console.log("🎛️ Chaospad: Not a stack pattern, appending cutoff");console.log(`🎛️ Chaospad: Applying cutoff ${e} Hz to master pattern`),console.log(`🎛️ Chaospad: Full pattern with cutoff: ${n.substring(0,200)}...`),console.log(`🎛️ Chaospad: Master active: ${C.isMasterActive()}`),await C.setMasterPatternCode(n),console.log(`🎛️ ✅ Chaospad: Cutoff ${e} Hz applied successfully`)}catch(t){console.error("⚠️ Chaospad: Error applying cutoff to master pattern:",t)}}async removeCutoffFromMaster(){try{let e=C.getMasterPatternCode();if(!e||e.trim()==="")return;e=e.replace(/\.\s*cutoff\s*\([^)]*\)/gi,""),e=e.trim().replace(/\.\s*$/,"").replace(/\.\.+/g,".").trim(),await C.setMasterPatternCode(e),this.currentCutoffValue=null,this.lastCutoffUpdate=null,console.log("🎛️ Removed Chaospad cutoff from master pattern")}catch(e){console.warn("⚠️ Error removing cutoff from master pattern:",e)}}shouldUseSpiralVisualizer(e){return e?/\.\s*_?spiral\s*\(/i.test(e):!1}shouldUseScopeVisualizer(e){return e?/\.\s*_?(?:t?scope)\s*\(/i.test(e):!1}shouldUseSpectrumVisualizer(e){return e?/\.\s*_?spectrum\s*\(/i.test(e):!1}shouldUsePitchwheelVisualizer(e){return e?/\.\s*_?pitchwheel\s*\(/i.test(e):!1}shouldUsePianorollVisualizer(e){return e?/\.\s*_?pianoroll\s*\(/i.test(e):!1}shouldUseBarchartVisualizer(e){return e?/\.\s*_?barchart\s*\(/i.test(e):!1}extractSpiralOptions(e){if(!e)return{};const t=e.match(/\.\s*_?spiral\s*\(\s*\{([^}]*)\}\s*\)/i);if(!t)return{};const n={};return t[1].split(",").forEach(r=>{const[o,a]=r.split(":");if(!o||!a)return;const l=o.trim(),d=a.trim(),c=Number(d.replace(/[^0-9.+-eE]/g,""));Number.isNaN(c)?/true|false/i.test(d)?n[l]=/^true$/i.test(d):n[l]=d.replace(/['"]/g,""):n[l]=c}),n}async getMasterPunchcardContext(){if(!this.masterPunchcardCanvas)return null;if(!this.masterPunchcardCtx)try{const{getDrawContext:e}=await We(async()=>{const{getDrawContext:t}=await import("./strudel-web-C25uHgU2.js").then(n=>n.a);return{getDrawContext:t}},__vite__mapDeps([0,1]));this.masterPunchcardCtx=e(this.masterPunchcardCanvas.id,{contextType:"2d"})}catch(e){console.warn("⚠️ Falling back to native canvas context:",e),this.masterPunchcardCtx=this.masterPunchcardCanvas.getContext("2d")}return this.masterPunchcardCtx}drawMasterPunchcardCanvas(e,t){const n=this.masterPunchcardCanvas,s=this.getMasterPunchcardContext();if(!n||!s)return;const r=this.masterPunchcardContainer.getBoundingClientRect(),o=Math.max(r.width||this.masterPunchcardContainer.offsetWidth||600,240),a=Math.max(r.height||this.masterPunchcardContainer.offsetHeight||200,200),l=window.devicePixelRatio||1;(n.width!==o*l||n.height!==a*l)&&(n.width=o*l,n.height=a*l,n.style.width=`${o}px`,n.style.height=`${a}px`),s.setTransform(1,0,0,1,0,0),s.clearRect(0,0,n.width,n.height),s.save(),s.setTransform(l,0,0,l,0,0);const d=16,c=o-d*2,u=a-d*3,h=d,f=a-d*1.5,m=s.createLinearGradient(0,0,o,a);m.addColorStop(0,"rgba(102, 126, 234, 0.06)"),m.addColorStop(1,"rgba(118, 75, 162, 0.08)"),s.fillStyle=m,s.fillRect(0,0,o,a);const{counts:g,hits:O}=t,{totalSteps:p,stepsPerBeat:y}=e;g.length!==p&&console.warn("⚠️ Punchcard data length mismatch",{expected:p,received:g.length});const M=Math.max(...g,1e-4),b=c/p;s.strokeStyle="rgba(102, 126, 234, 0.25)",s.lineWidth=1,s.beginPath();for(let S=0;S<=p;S+=y){const k=h+S*b;s.moveTo(k,f),s.lineTo(k,f-u)}s.stroke(),g.forEach((S,k)=>{const x=Math.max(S/M,0),E=u*x,B=h+k*b,F=f-E;if(E<=2){s.fillStyle="rgba(148, 163, 184, 0.35)",s.fillRect(B+b*.3,f-3,b*.4,3);return}const W=s.createLinearGradient(B,F,B,f);W.addColorStop(0,"rgba(102, 126, 234, 0.9)"),W.addColorStop(1,"rgba(118, 75, 162, 0.85)"),s.fillStyle=W;const z=B+b*.2,ce=b*.6,ie=Math.min(b*.3,8);typeof s.roundRect=="function"?(s.beginPath(),s.roundRect(z,F,ce,E,ie),s.fill()):s.fillRect(z,F,ce,E);const se=O==null?void 0:O[k];if(se&&se.length){s.fillStyle="rgba(26, 32, 44, 0.75)",s.font='10px "Fira Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace',s.textAlign="center",s.textBaseline="bottom";const pe=se.slice(0,2).join(" • ");s.fillText(pe,B+b/2,F-4)}}),s.strokeStyle="rgba(79, 70, 229, 0.55)",s.lineWidth=1.5,s.beginPath(),s.moveTo(h,f),s.lineTo(h+c,f),s.stroke(),s.restore()}renderMasterSpiral(e,t,n={}){if(!this.masterPunchcardContainer||!this.masterPunchcardCanvas)return;const s=t.events||[];if(!s.length){this.showMasterPunchcardPlaceholder();return}this.hideMasterPunchcardPlaceholder(),this.drawMasterSpiralCanvas(e,s,n)}drawMasterSpiralCanvas(e,t,n={}){const s=this.masterPunchcardCanvas,r=this.getMasterPunchcardContext();if(!s||!r)return;const o=this.masterPunchcardContainer.getBoundingClientRect(),a=Math.max(o.width||this.masterPunchcardContainer.offsetWidth||320,240),l=Math.max(o.height||this.masterPunchcardContainer.offsetHeight||240,220),d=window.devicePixelRatio||1;(s.width!==a*d||s.height!==l*d)&&(s.width=a*d,s.height=l*d,s.style.width=`${a}px`,s.style.height=`${l}px`),r.setTransform(1,0,0,1,0,0),r.clearRect(0,0,s.width,s.height),r.save(),r.setTransform(d,0,0,d,0,0);const c=Number.isFinite(n.padding)?n.padding:32,u=Number.isFinite(n.inset)?n.inset:3,h=Number.isFinite(n.stretch)?n.stretch:1,f=Number.isFinite(n.rotations)?n.rotations:Math.max(e.numerator??4,4),m=Number.isFinite(n.steady)?n.steady:.9,g=Number.isFinite(n.thickness)?n.thickness:6,O=typeof n.cap=="string"?n.cap:"round",p=r.createLinearGradient(0,0,a,l);p.addColorStop(0,"rgba(102, 126, 234, 0.08)"),p.addColorStop(1,"rgba(118, 75, 162, 0.12)"),r.fillStyle=p,r.fillRect(0,0,a,l);const y=a/2,M=l/2,S=Math.max(Math.min(a,l)/2-c,40)/Math.max(f+u+1,1),x=m*0,E={margin:S,cx:y,cy:M,stretch:h,cap:O,thickness:g},B="rgba(76, 81, 191, 0.85)",F="rgba(148, 163, 184, 0.35)",W=Math.max(...t.map(ie=>ie.weight??1),1),z=f;t.forEach(ie=>{const se=Number.isFinite(ie.begin)?ie.begin:0,pe=Number.isFinite(ie.endClipped)?ie.endClipped:Number.isFinite(ie.end)?ie.end:se,Se=Number.isFinite(ie.weight)?Math.max(ie.weight,.1):1,st=ie.color||B,Ze=u+se*z,St=u+Math.max(pe,se)*z;Pf(r,{...E,from:Ze,to:St,rotate:x,thickness:E.thickness*(.6+Se/W*.8),color:st})});const ce=u+z+1;Pf(r,{...E,from:u,to:ce,rotate:x,color:F,thickness:E.thickness*.6,fromOpacity:.35,toOpacity:.1}),r.restore()}async computeMasterPunchcardData(e,t){try{C.strudelLoaded||await C.initStrudel()}catch(y){return console.warn("⚠️ Unable to initialize Strudel for punchcard:",y),{error:"Strudel is not ready yet."}}if(!window.strudel||typeof window.strudel.evaluate!="function")return{error:"Strudel evaluate function is unavailable."};let n=e;console.log("═══════════════════════════════════════════════════════════"),console.log("🔍 PUNCHCARD EVALUATION - Original pattern:"),console.log("   Full pattern:",n),console.log("───────────────────────────────────────────────────────────"),n=n.replace(/\/\/.*$/gm,""),n=n.replace(/\/\*[\s\S]*?\*\//g,""),n=n.replace(/\n\s*\n/g,`
`).trim(),n=n.replace(/\)\s*\.\s*\((gain|pan)\s*\(/g,").$1("),/\)\s*\.\s*(gain|pan)\s*\(/.test(n)||(n=n.replace(/([a-zA-Z_$][a-zA-Z0-9_$]*\s*\([^()]*\)(?:\s*\.\s*[a-zA-Z_$][a-zA-Z0-9_$]*\s*\([^()]*\))*)\s*\.\s*(gain|pan)\s*\(/g,(y,M,b)=>M.trim().startsWith("(")?y:`(${M}).${b}(`)),console.log("🔍 PUNCHCARD EVALUATION - After removing comments and fixing modifiers:"),console.log("   Pattern:",n),console.log("───────────────────────────────────────────────────────────");const r=(y,M)=>{let b=1;for(let S=M+1;S<y.length;S++)if(y[S]==="(")b++;else if(y[S]===")"&&(b--,b===0))return S;return-1},o=["scope","tscope","fscope","spectrum","visual","spiral"];if(o.forEach(y=>{const M=new RegExp(`\\.\\s*_?${y}\\s*\\(`,"gi");let b,S=0;for(;(b=M.exec(n))!==null;){const k=b.index,x=b.index+b[0].length-1,E=r(n,x);if(E!==-1)n=n.substring(0,k)+n.substring(E+1),S++,console.log(`  Stripped .${y}(...) occurrence #${S}`),M.lastIndex=0;else{console.warn(`  Could not find matching ) for .${y}( at position ${x}`);break}}}),n=n.trim(),n=n.replace(/\.\s*$/,"").replace(/\.\.+/g,".").trim(),console.log("🔍 PUNCHCARD EVALUATION - After stripping:"),console.log("   Stripped pattern:",n),console.log("───────────────────────────────────────────────────────────"),!n||n.trim()==="")return console.warn("⚠️ Pattern is empty after stripping visualizers"),{error:"Pattern is empty after removing visualizers."};if(o.some(y=>new RegExp(`\\.\\s*_?${y}\\s*\\(`,"i").test(n)))return console.warn("═══════════════════════════════════════════════════════════"),console.warn("⚠️ PUNCHCARD EVALUATION - FAILED TO STRIP VISUALIZERS"),console.warn("   Pattern still contains visualizers after stripping:"),console.warn("   ",n),console.warn("   This will cause Mini parser errors. Skipping punchcard evaluation."),console.warn("═══════════════════════════════════════════════════════════"),{error:"Pattern contains visualizers that could not be stripped."};if(console.log("✅ PUNCHCARD EVALUATION - Ready to evaluate (no visualizers detected)"),console.log("═══════════════════════════════════════════════════════════"),!n||n.trim()==="")return console.warn("⚠️ Pattern is empty after stripping - cannot evaluate"),{error:"Pattern is empty after processing"};console.log("📝 Final pattern to evaluate:",n);try{await C.ensurePatternResourcesLoaded(n)}catch(y){console.warn("⚠️ Unable to preload resources for punchcard evaluation:",y)}const l=y=>{if(y==null)return 0;if(typeof y=="number")return y;if(typeof y.valueOf=="function"){const b=y.valueOf();if(typeof b=="number"&&!Number.isNaN(b))return b}if(typeof y=="object"&&y!==null&&"n"in y&&"d"in y){const b=Number(y.n??0),S=Number(y.d??1);return S!==0?b/S:0}const M=Number(y);return Number.isFinite(M)?M:0},d=y=>y?typeof y=="string"?y:y.label?y.label:y.sample?y.sample:y.s?y.s:y.note?y.note:y.n?y.n:y.sound?y.sound:y.instrument?y.instrument:null:null;let c;try{const[{evaluate:y},{transpiler:M}]=await Promise.all([We(()=>import("./strudel-core-DenOJOif.js").then(S=>S.b),[]),We(()=>import("./index-DMlyjRuZ.js"),__vite__mapDeps([5,1,3]))]),b=await y(n,M,{wrapAsync:!1,addReturn:!1,emitMiniLocations:!1});c=b==null?void 0:b.pattern,console.log("🔍 Evaluated pattern object:",c)}catch(y){return console.error("❌ Failed to evaluate pattern for punchcard:",y),{error:(y==null?void 0:y.message)||"Pattern evaluation failed."}}if(!c&&window.strudel&&typeof window.strudel.evaluate=="function"){console.log("🔁 strudelCoreEvaluate returned no pattern - attempting fallback via window.strudel.evaluate");try{const y=`globalThis.__punchcard_pattern = ${n}`;console.log("🔍 Fallback evaluation code:",y.substring(0,200));const M=await window.strudel.evaluate(y);if(globalThis.__punchcard_pattern)c=globalThis.__punchcard_pattern,console.log("🔍 Fallback pattern object from globalThis:",c);else if(M&&typeof M.queryArc=="function")c=M,console.log("🔍 Fallback pattern object from eval result:",c);else if(M&&M._Pattern)c=M,console.log("🔍 Fallback pattern object (has _Pattern):",c);else{const b=await window.strudel.evaluate(n);b&&(typeof b.queryArc=="function"||b._Pattern)&&(c=b,console.log("🔍 Fallback pattern object from direct eval:",c))}}catch(y){console.warn("⚠️ Fallback evaluation failed:",y),console.warn("⚠️ Pattern that failed:",n.substring(0,200))}}if(!(c&&(typeof c.queryArc=="function"||typeof c.query=="function"||c._Pattern===!0))){if(console.warn("⚠️ Pattern did not return a valid Strudel pattern object"),console.warn("⚠️ Pattern object type:",typeof c),console.warn("⚠️ Pattern object:",c),console.warn("⚠️ Pattern that failed:",n.substring(0,300)),window.strudel&&typeof window.strudel.evaluate=="function")try{const M=`(${n})`,b=await window.strudel.evaluate(M);b&&(typeof b.queryArc=="function"||typeof b.query=="function"||b._Pattern===!0)&&(c=b,console.log("✅ Last attempt succeeded with wrapped pattern"))}catch(M){console.warn("⚠️ Last attempt also failed:",M)}if(!(c&&(typeof c.queryArc=="function"||typeof c.query=="function"||c._Pattern===!0)))return{error:"Pattern expression did not return a Strudel pattern."}}let h;try{if(typeof c.queryArc=="function")h=c.queryArc(0,1)||[];else if(typeof c.query=="function")h=c.query(0,1)||[];else if(c.__steps&&typeof c.__steps=="object")h=[],console.warn("⚠️ Pattern has _Pattern but no queryArc/query - attempting to extract haps from __steps");else throw new Error("Pattern object does not have queryArc, query, or __steps")}catch(y){return console.error("❌ Failed to query pattern arc for punchcard:",y),{error:(y==null?void 0:y.message)||"Pattern queryArc failed."}}try{delete globalThis.__punchcard_pattern}catch{globalThis.__punchcard_pattern=void 0}const f={events:h.map(y=>{const M=y==null?void 0:y.part,b=y==null?void 0:y.whole,S=l(M?M.begin??M.start??0:(b==null?void 0:b.begin)??0);let k=l(M?M.end??M.finish??M.begin??0:(b==null?void 0:b.end)??(b==null?void 0:b.begin)??0);(!Number.isFinite(k)||k<S)&&(k=S);const x=(y==null?void 0:y.value)??null,E=d(x),B=x&&typeof x=="object"?x.note??x.n??null:null,F=x&&typeof x=="object"?x.sound??x.s??null:null,W=x&&typeof x=="object"?x.sample??null:null,z=x&&typeof x=="object"?x.instrument??null:null,ce=x&&typeof x=="object"?x.source??x.path??null:null,ie=typeof x=="string"?x:null,se=x&&typeof x=="object"&&x.velocity!=null?Number(x.velocity):1,pe=x&&typeof x=="object"&&x.gain!=null?Number(x.gain):1,Se=(Number.isFinite(se)?se:1)*(Number.isFinite(pe)?pe:1);return{begin:S,end:k,endClipped:l((y==null?void 0:y.endClipped)??k),wholeBegin:l((b==null?void 0:b.begin)??S),wholeEnd:l((b==null?void 0:b.end)??k),label:E,weight:Number.isFinite(Se)&&Se>0?Se:1,color:x&&typeof x=="object"&&x.color?x.color:null,tags:Array.isArray(y==null?void 0:y.tags)?y.tags:[],meta:{label:E,note:B,sound:F,sample:W,instrument:z,source:ce,rawString:ie}}})};if(!f||f.error)return console.warn("⚠️ Parsed result has error:",f==null?void 0:f.error),{error:(f==null?void 0:f.error)||"Unknown error from Strudel evaluation."};const{totalSteps:m}=t,g=new Array(m).fill(0),O=new Array(m).fill(null).map(()=>[]),p=f.events||[];return p.forEach(y=>{if(!y)return;const{begin:M,end:b,endClipped:S,label:k,weight:x}=y,E=(Number(M)%1+1)%1,B=Number.isFinite(S)?S:b;let F=(Number(B)%1+1)%1;(!Number.isFinite(F)||F<E)&&(F=E);const W=Math.min(m-1,Math.max(0,Math.floor(E*m))),z=Math.min(m-1,Math.max(W,Math.ceil(F*m)-1)),ce=Number.isFinite(x)?Math.max(x,.1):1;for(let ie=W;ie<=z;ie+=1)if(g[ie]+=ce,k){const se=O[ie];se.includes(k)||se.push(k)}}),{counts:g,hits:O,events:p}}enableNativeStrudelHighlighting(e=500){if(this.nativeHighlightingEnabled||this.nativeHighlightingDisabled)return;const t=(globalThis==null?void 0:globalThis.Strudel)||(globalThis==null?void 0:globalThis.strudel)||(window==null?void 0:window.Strudel)||(window==null?void 0:window.strudel),n=t&&typeof t.enableHighlighting=="function"?t.enableHighlighting:null;if(n)try{n.call(t),this.nativeHighlightingEnabled=!0,this.nativeHighlightRetryCount=0,this.nativeHighlightRetryTimer&&(clearTimeout(this.nativeHighlightRetryTimer),this.nativeHighlightRetryTimer=null),console.log("✅ Enabled Strudel.enableHighlighting()");return}catch(r){console.warn("⚠️ Strudel.enableHighlighting() failed:",r),this.nativeHighlightingDisabled=!0;return}if(this.nativeHighlightRetryTimer)return;if(this.nativeHighlightRetryCount>=5){console.warn("⚠️ Strudel.enableHighlighting() unavailable; falling back without editor highlights."),this.nativeHighlightingDisabled=!0,this.nativeHighlightRetryCount=0;return}this.nativeHighlightRetryCount+=1;const s=Math.min(e*2,4e3);this.nativeHighlightRetryTimer=setTimeout(()=>{this.nativeHighlightRetryTimer=null,this.enableNativeStrudelHighlighting(s)},s)}updateMasterPatternDisplay(){if(!this.masterPatternField)return;const e=C.getMasterPatternCode();e&&e.trim()!==""?(Fe("master-pattern",e),this.masterPatternField.placeholder="",console.log(`📝 Updated master pattern display: ${e.substring(0,100)}...`)):(Fe("master-pattern",""),this.masterPatternField.placeholder="Combined pattern will appear here...")}updateMasterIndicators(){et.elements.forEach(e=>{const t=e.id,n=document.querySelector(`[data-sound-id="${t}"]`);if(n){const s=n.querySelector(".master-status-indicator");s&&(C.trackedPatterns.has(t)?s.classList.add("active"):s.classList.remove("active"))}})}registerElements(e=null){(e||et.elements.map(n=>{const s=document.querySelector(n.selector);return s?{element:s,elementId:n.id}:null}).filter(n=>n!==null)).forEach(({element:n,elementId:s})=>{n&&(n.getAttribute("data-sound-id"),n.addEventListener("click",r=>{if(r.target.classList.contains("config-button")||r.target.classList.contains("pause-button")||r.target.classList.contains("solo-button")||r.target.classList.contains("mute-button")||r.target.classList.contains("gain-slider")||r.target.classList.contains("pan-slider")||r.target.classList.contains("collapsible-toggle")||r.target.classList.contains("collapsible-content")||r.target.classList.contains("effect-slider")||r.target.classList.contains("filter-slider")||r.target.closest(".collapsible-section"))return;const o=n.getAttribute("data-sound-id");console.log(`🖱️ Click triggered for ${o}`),this.activeElements.has(o)?this.deactivateElement(o,n,"click"):this.activateElement(o,n,"click")}))})}setupElementControls(){et.elements.forEach(e=>{const t=document.querySelector(e.selector);if(!t)return;const n=e.id,s=t.querySelector(".gain-slider"),r=t.querySelector(".pan-slider");if(s){const d=parseFloat(s.value);C.setElementGain(n,d),s.addEventListener("input",c=>{c.stopPropagation();const u=parseFloat(c.target.value);C.setElementGain(n,u),C.updateTrackedElementGain(n,u),this.updateMasterPatternDisplay()})}if(r){const d=parseFloat(r.value);C.setElementPan(n,d),r.addEventListener("input",c=>{c.stopPropagation();const u=parseFloat(c.target.value);C.setElementPan(n,u),C.updateTrackedElementPan(n,u),this.updateMasterPatternDisplay()})}const o=t.querySelector(".pause-button");o&&o.addEventListener("click",async d=>{d.stopPropagation(),await this.handlePauseButton(n)});const a=t.querySelector(".solo-button");a&&a.addEventListener("click",d=>{d.stopPropagation(),this.handleSoloButton(n,a)});const l=t.querySelector(".mute-button");l&&l.addEventListener("click",d=>{d.stopPropagation(),this.handleMuteButton(n,l)}),this.setupCollapsibleSections(t,n)})}setupCollapsibleSections(e,t){if(!e||!t){console.warn("⚠️ setupCollapsibleSections: Invalid element or elementId",{element:e,elementId:t});return}const n=e.querySelectorAll(".collapsible-toggle");console.log(`🎛️ Setting up collapsible sections for ${t}: ${n.length} toggle buttons found`),n.forEach(s=>{s.addEventListener("click",r=>{r.stopPropagation(),s.classList.toggle("active");const o=s.nextElementSibling;o&&o.classList.contains("collapsible-content")&&o.classList.toggle("active")})}),this.setupFilterDropdowns(e,t),this.setupEffectsDropdowns(e,t),this.setupSynthesisDropdowns(e,t)}setupFilterDropdowns(e,t){const n=e.querySelector(".filters-content");if(!n)return;n.innerHTML="",[{key:"hpf",label:"HPF",params:[{key:"hpf",label:"Frequency",unit:"Hz"},{key:"hpq",label:"HPQ",unit:""}]},{key:"lpf",label:"LPF",params:[{key:"lpf",label:"Frequency",unit:"Hz"},{key:"lpq",label:"LPQ",unit:""}]},{key:"bpf",label:"BPF",params:[{key:"bpf",label:"Frequency",unit:"Hz"},{key:"bpq",label:"Q",unit:""}]}].forEach((r,o)=>{const a=document.createElement("div");a.className="filter-collapsible-row";const d={hpf:"snippet-group-filters-hp",lpf:"snippet-group-filters-lp",bpf:"snippet-group-filters-bp"}[r.key]||"";a.innerHTML=`
        <button class="filter-toggle ${d}" data-filter-key="${r.key}">
          <span class="toggle-icon">▶</span> ${r.label}
        </button>
        <div class="filter-sliders-container" style="display: none;">
          <!-- Sliders will be added here -->
        </div>
      `,n.appendChild(a);const c=a.querySelector(".filter-toggle"),u=a.querySelector(".filter-sliders-container");c.addEventListener("click",h=>{h.stopPropagation(),c.classList.toggle("active");const f=c.classList.contains("active");u.style.display=f?"block":"none";const m=c.querySelector(".toggle-icon");m.textContent=f?"▼":"▶",f&&u.children.length===0&&r.params.forEach(g=>{const O=Zn[g.key];if(!O)return;let p=O.default.toString();g.key==="bpg"&&g.unit==="dB"?p=`${O.default>=0?"+":""}${O.default.toFixed(1)} dB`:g.unit&&(p=`${O.default}${g.unit?" "+g.unit:""}`);const y=document.createElement("div");y.className="slider-row",y.innerHTML=`
              <div class="slider-label-row">
                <label>${g.label}</label>
                <span class="slider-value">${p}</span>
              </div>
              <input type="range" class="filter-slider" data-filter-type="${r.key}" data-param-key="${g.key}" 
                     min="${O.min}" max="${O.max}" step="${O.step}" 
                     value="${O.default}" />
            `,u.appendChild(y);const M=y.querySelector(".filter-slider");M&&!M.dataset.hasListener&&(M.dataset.hasListener="true",M.addEventListener("input",async b=>{const S=parseFloat(b.target.value),k=y.querySelector(".slider-value");if(k)if(g.key.includes("f"))k.textContent=Math.round(S)+" Hz";else if(g.key==="bpg"&&g.unit==="dB"){const x=S>=0?"+":"";k.textContent=`${x}${S.toFixed(1)} dB`}else k.textContent=S.toFixed(1)+(g.unit?" "+g.unit:"");await this.updateElementFilters(t)}))})})})}setupEffectsDropdowns(e,t){const n=e.querySelector(".effects-content");if(!n)return;n.innerHTML="",[{key:"delay",label:"Delay",params:[{key:"delay",label:"Delay Mix"},{key:"delayfeedback",label:"Delay Feedback"},{key:"delaytime",label:"Delay Time"}]},{key:"room",label:"Reverb",params:[{key:"room",label:"Room Mix"},{key:"roomsize",label:"Room Size"},{key:"roomlp",label:"Low-pass"},{key:"roomdim",label:"Dimension"},{key:"roomfade",label:"Fade"},{key:"iresponse",label:"Impulse Response"}]}].forEach(r=>{const o=document.createElement("div");o.className="effect-collapsible-row";const l={delay:"snippet-group-delay",room:"snippet-group-reverb"}[r.key]||"";o.innerHTML=`
        <button class="effect-toggle ${l}" data-effect-key="${r.key}">
          <span class="toggle-icon">▶</span> ${r.label}
        </button>
        <div class="effect-sliders-container" style="display: none;">
          <!-- Sliders will be added here -->
        </div>
      `,n.appendChild(o);const d=o.querySelector(".effect-toggle"),c=o.querySelector(".effect-sliders-container");d.addEventListener("click",async u=>{u.stopPropagation(),d.classList.toggle("active");const h=d.classList.contains("active");c.style.display=h?"block":"none";const f=d.querySelector(".toggle-icon");f.textContent=h?"▼":"▶",h&&c.children.length===0&&r.params.forEach(m=>{const g=Zn[m.key];if(!g)return;const O=document.createElement("div");O.className="slider-row",O.innerHTML=`
              <div class="slider-label-row">
                <label>${m.label}</label>
                <span class="slider-value">${g.default.toFixed(2)}${g.unit?" "+g.unit:""}</span>
              </div>
              <input type="range" class="effect-slider" data-effect-key="${m.key}" 
                     min="${g.min}" max="${g.max}" step="${g.step}" 
                     value="${g.default}" />
            `,c.appendChild(O);const p=O.querySelector(".effect-slider");p&&!p.dataset.hasListener&&(p.dataset.hasListener="true",p.addEventListener("input",async y=>{const M=parseFloat(y.target.value),b=O.querySelector(".slider-value");b&&(b.textContent=M.toFixed(2)+(g.unit?" "+g.unit:"")),await this.updateElementEffects(t)}))}),await this.updateElementEffects(t)})})}setupSynthesisDropdowns(e,t){const n=e.querySelector(".synthesis-content");if(!n)return;n.innerHTML="";const s=document.createElement("div");s.className="synthesis-sliders-container",[{key:"attack",label:"Attack",min:0,max:2,step:.01,default:.01,unit:"s"},{key:"decay",label:"Decay",min:0,max:2,step:.01,default:.1,unit:"s"},{key:"sustain",label:"Sustain",min:0,max:1,step:.01,default:.5,unit:""},{key:"release",label:"Release",min:0,max:5,step:.01,default:.1,unit:"s"}].forEach(o=>{const a=document.createElement("div");a.className="slider-row",a.innerHTML=`
        <div class="slider-label-row">
          <label>${o.label}</label>
          <span class="slider-value">${o.default.toFixed(2)}${o.unit?" "+o.unit:""}</span>
        </div>
        <input type="range" class="synth-slider ${o.key}-slider" 
               min="${o.min}" max="${o.max}" step="${o.step}" 
               value="${o.default}" />
      `,s.appendChild(a);const l=a.querySelector(".synth-slider");l&&!l.dataset.hasListener&&(l.dataset.hasListener="true",l.addEventListener("input",async d=>{const c=parseFloat(d.target.value),u=a.querySelector(".slider-value");u&&(u.textContent=c.toFixed(2)+(o.unit?" "+o.unit:"")),await this.updateElementSynthesis(t)}))}),n.appendChild(s)}async updateElementEffects(e){const t=document.querySelector(`[data-sound-id="${e}"]`);if(!t)return;const n=t.querySelectorAll(".effect-collapsible-row"),s={};n.forEach(o=>{const l=o.querySelector(".effect-toggle").classList.contains("active"),d=o.querySelectorAll(".effect-slider");l&&d.length>0&&d.forEach(c=>{const u=c.dataset.effectKey;u&&(s[u]=parseFloat(c.value))})}),this.elementEffects||(this.elementEffects={}),this.elementEffects[e]=s,console.log(`🎛️ Effects updated for ${e}:`,this.elementEffects[e]),this._effectsApplyTimers=this._effectsApplyTimers||new Map,this._effectsApplyTimers.has(e)&&clearTimeout(this._effectsApplyTimers.get(e));const r=setTimeout(()=>{this.applyEffectsAndFiltersToPattern(e),this._effectsApplyTimers.delete(e)},150);this._effectsApplyTimers.set(e,r)}async updateElementFilters(e){const t=document.querySelector(`[data-sound-id="${e}"]`);if(!t)return;const n=t.querySelectorAll(".filter-collapsible-row"),s={};n.forEach(o=>{const l=o.querySelector(".filter-toggle").classList.contains("active"),d=o.querySelectorAll(".filter-slider");l&&d.length>0&&d.forEach(c=>{const u=c.dataset.paramKey;u&&(s[u]=parseFloat(c.value))})}),this.elementFilters||(this.elementFilters={}),this.elementFilters[e]=s,console.log(`🔊 Filters updated for ${e}:`,this.elementFilters[e]),this._filtersApplyTimers=this._filtersApplyTimers||new Map,this._filtersApplyTimers.has(e)&&clearTimeout(this._filtersApplyTimers.get(e));const r=setTimeout(()=>{this.applyEffectsAndFiltersToPattern(e),this._filtersApplyTimers.delete(e)},150);this._filtersApplyTimers.set(e,r)}async updateElementSynthesis(e){const t=document.querySelector(`[data-sound-id="${e}"]`);if(!t)return;const n=t.querySelector(".attack-slider"),s=t.querySelector(".decay-slider"),r=t.querySelector(".sustain-slider"),o=t.querySelector(".release-slider"),a=n?parseFloat(n.value):.01,l=s?parseFloat(s.value):.1,d=r?parseFloat(r.value):.5,c=o?parseFloat(o.value):.1;this.elementSynthesis||(this.elementSynthesis={}),this.elementSynthesis[e]={attack:a,decay:l,sustain:d,release:c},console.log(`🎹 Synthesis updated for ${e}:`,this.elementSynthesis[e]),this._synthApplyTimers=this._synthApplyTimers||new Map,this._synthApplyTimers.has(e)&&clearTimeout(this._synthApplyTimers.get(e));const u=setTimeout(()=>{this.applyEffectsAndFiltersToPattern(e),this._synthApplyTimers.delete(e)},150);this._synthApplyTimers.set(e,u)}getPatternWithEffects(e,t){var d,c,u;if(!t)return t;const n=((d=this.elementEffects)==null?void 0:d[e])||{},s=((c=this.elementFilters)==null?void 0:c[e])||{},r=((u=this.elementSynthesis)==null?void 0:u[e])||{},o=(h,f)=>{if(f===void 0)return!1;const m=Zn[h];return m?f!==m.default:!0},a=(h,f)=>{if(f===void 0)return"";const m=Zn[h];return(m==null?void 0:m.unit)==="Hz"||h==="roomlp"?Math.round(f):f.toFixed(2)};let l=[];return o("delay",n.delay)&&l.push(`.delay(${a("delay",n.delay)})`),o("delayfeedback",n.delayfeedback)&&l.push(`.delayfeedback(${a("delayfeedback",n.delayfeedback)})`),o("delaytime",n.delaytime)&&l.push(`.delaytime(${a("delaytime",n.delaytime)})`),o("room",n.room)&&l.push(`.room(${a("room",n.room)})`),o("roomsize",n.roomsize)&&l.push(`.roomsize(${a("roomsize",n.roomsize)})`),o("roomlp",n.roomlp)&&n.roomlp<Zn.roomlp.default&&l.push(`.roomlp(${a("roomlp",n.roomlp)})`),o("roomdim",n.roomdim)&&l.push(`.roomdim(${a("roomdim",n.roomdim)})`),o("roomfade",n.roomfade)&&l.push(`.roomfade(${a("roomfade",n.roomfade)})`),o("iresponse",n.iresponse)&&l.push(`.iresponse(${a("iresponse",n.iresponse)})`),s.lpf!==void 0&&s.lpf<2e4&&l.push(`.lpf(${Math.round(s.lpf)})`),s.hpf!==void 0&&s.hpf>20&&l.push(`.hpf(${Math.round(s.hpf)})`),s.bpf!==void 0&&l.push(`.bpf(${Math.round(s.bpf)})`),s.bpq!==void 0&&s.bpq>0&&l.push(`.bpq(${s.bpq.toFixed(1)})`),s.lpq!==void 0&&s.lpq>0&&l.push(`.lpq(${s.lpq.toFixed(1)})`),s.hpq!==void 0&&s.hpq>0&&l.push(`.hpq(${s.hpq.toFixed(1)})`),r.attack!==void 0&&r.attack!==.01&&l.push(`.attack(${r.attack.toFixed(2)})`),r.decay!==void 0&&r.decay!==.1&&l.push(`.decay(${r.decay.toFixed(2)})`),r.sustain!==void 0&&r.sustain!==.5&&l.push(`.sustain(${r.sustain.toFixed(2)})`),r.release!==void 0&&r.release!==.1&&l.push(`.release(${r.release.toFixed(2)})`),l.length>0?t+l.join(""):t}async applyEffectsAndFiltersToPattern(e){const t=this.loadElementConfig(e);if(!t||!t.pattern)return;const n=t.pattern,s=this.getPatternWithEffects(e,n);s!==n&&console.log(`🎚️ Applying effects/filters/synthesis to ${e}: ${s}`),C.trackedPatterns&&C.trackedPatterns.has(e)?(await C.updatePatternInPlace(e,s,!0),this.updateMasterPatternDisplay()):C.isPlaying(e)||await C.cachePatternForElement(e,s)}applyChannelHistoryEntry(e,t){var r,o;if(!e||!t)return;const n=t.trim(),s=this.loadElementConfig(e)||{};tn.markChannelSnapshot(e,n),this.saveElementConfig(e,{...s,pattern:n},!0),this.currentEditingElementId!==e&&this.openModal(e),setTimeout(()=>{Fe("modal-pattern",n)},50),(o=(r=this.uiController)==null?void 0:r.updateStatus)==null||o.call(r,`Loaded history for ${e}. Save to apply.`)}applyMasterHistoryEntry(e){var n,s;if(!e)return;const t=e.trim();Fe("master-pattern",t),C.masterPattern=t,tn.markMasterSnapshot(t),this.updateMasterPatternDisplay(),(s=(n=this.uiController)==null?void 0:n.updateStatus)==null||s.call(n,"Loaded master pattern history entry.")}async saveChannelWithEffects(e){var o,a,l,d;const t=this.loadElementConfig(e);if(!t||!t.pattern){(a=(o=this.uiController)==null?void 0:o.updateStatus)==null||a.call(o,"Nothing to save for this channel.");return}const n=this.getPatternWithEffects(e,t.pattern),{getCurrentUser:s}=await We(async()=>{const{getCurrentUser:c}=await Promise.resolve().then(()=>qn);return{getCurrentUser:c}},void 0);if(await s()&&window.savePatternDialog)await window.savePatternDialog.show(n,"channel",e),window.savePatternDialog.setOnSave(async c=>{var h,f;const u={...t,pattern:n};this.saveElementConfig(e,u,!1),tn.markChannelSnapshot(e,n),(f=(h=this.uiController)==null?void 0:h.updateStatus)==null||f.call(h,`Saved channel ${e} to cloud.`)});else{const c={...t,pattern:n};this.saveElementConfig(e,c,!1),tn.markChannelSnapshot(e,n),(d=(l=this.uiController)==null?void 0:l.updateStatus)==null||d.call(l,`Saved channel ${e} locally.`)}}async saveMasterHistoryEntry(){var o,a,l,d;const e=document.getElementById("master-pattern"),n=((e?e.value:"")||"").trim();if(!n){(a=(o=this.uiController)==null?void 0:o.updateStatus)==null||a.call(o,"Master pattern is empty.");return}const{getCurrentUser:s}=await We(async()=>{const{getCurrentUser:c}=await Promise.resolve().then(()=>qn);return{getCurrentUser:c}},void 0);await s()&&window.savePatternDialog?(await window.savePatternDialog.show(n,"master",null),window.savePatternDialog.setOnSave(async c=>{var u,h;tn.saveMasterVersion(n),tn.markMasterSnapshot(n),C.masterPattern=n,this.updateMasterPatternDisplay(),(h=(u=this.uiController)==null?void 0:u.updateStatus)==null||h.call(u,"Saved master pattern to cloud.")})):(tn.saveMasterVersion(n),tn.markMasterSnapshot(n),C.masterPattern=n,this.updateMasterPatternDisplay(),(d=(l=this.uiController)==null?void 0:l.updateStatus)==null||d.call(l,"Saved master pattern locally."))}updateSynthesisSectionVisibility(e,t){const n=document.querySelector(`[data-sound-id="${e}"]`);if(!n)return;const s=n.querySelector(".synthesis-section");if(!s)return;const r=kl(t);vf(r)?(s.style.display="block",console.log(`🎹 Showing synthesis section for ${e} (synth pattern detected)`)):(s.style.display="none",console.log(`🎹 Hiding synthesis section for ${e} (not a synth pattern)`))}async handlePauseButton(e){const t=document.querySelector(`[data-sound-id="${e}"]`);if(!t)return;const n=t.querySelector(".element-indicator"),s=t.querySelector(".pause-button");(s==null?void 0:s.classList.contains("paused"))?(s==null||s.classList.remove("paused"),n==null||n.classList.remove("paused"),this.elementHasPattern(e)&&await C.triggerSound(e),console.log(`▶️ Resumed ${e}`)):(s==null||s.classList.add("paused"),n==null||n.classList.add("paused"),n==null||n.classList.remove("looped"),C.pauseSound(e),console.log(`⏸️ Paused ${e}`))}handleSoloButton(e,t){this.soloedElements.has(e)?(this.soloedElements.delete(e),t.classList.remove("active"),console.log(`🎵 Unsolo: ${e}`)):(this.soloedElements.add(e),t.classList.add("active"),console.log(`🎵 Solo: ${e}`)),this.updateElementAudioStates()}handleMuteButton(e,t){this.mutedElements.has(e)?(this.mutedElements.delete(e),t.classList.remove("active"),console.log(`🔊 Unmute: ${e}`)):(this.mutedElements.add(e),t.classList.add("active"),console.log(`🔇 Mute: ${e}`)),this.updateElementAudioStates()}updateElementAudioStates(){const e=this.soloedElements.size>0;et.elements.forEach(t=>{const n=t.id,s=this.mutedElements.has(n),r=this.soloedElements.has(n);let o;s?o=0:e?o=r?1:0:o=1;const a=document.querySelector(`[data-sound-id="${n}"]`);if(a){const l=a.querySelector(".gain-slider"),d=l?parseFloat(l.value):.8;C.setElementGain(n,d*o)}}),C.updateMasterPattern(this.soloedElements,this.mutedElements),this.updateMasterPatternDisplay()}activateElement(e,t,n){if(console.log(`🎵 Activating ${e} via ${n}`),this.masterActive&&C.trackedPatterns.has(e)){console.log(`   ⚠️ Master is playing and ${e} is tracked - ignoring individual activation`),ot.updateStatus(`Cannot play ${e} individually while master is active. Stop master first.`);return}ot.setElementState(t,"focus"),this.updateStatusDots(e,this.elementHasPattern(e),!1),ot.updateStatus("Ready")}deactivateElement(e,t,n){if(console.log(`🔇 Deactivating ${e} (was triggered by ${n})`),this.activeElements.has(e)){this.activeElements.delete(e),console.log(`   Stopping sound for ${e}`),C.stopSound(e);const s=this.elementHasPattern(e);this.updateStatusDots(e,s,!1),ot.setElementState(t,null),this.updateActiveElementsDisplay(),this.activeElements.size===0&&ot.updateStatus("Ready")}}updateActiveElementsDisplay(){const e=Array.from(this.activeElements).map(n=>{const s=et.getElementConfig(n);return(s==null?void 0:s.description)||n});ot.updateActiveElements(e);const t=document.getElementById("slots-info");if(t){const n=C.trackedPatterns?Array.from(C.trackedPatterns.keys()):[],s=new Set([...this.activeElements,...n]);if(s.size===0)t.textContent="None active";else{const r=Array.from(s).map(o=>{var f,m;const a=(f=C.strudelPatternSlots)==null?void 0:f.get(o),l=(m=C.trackedPatterns)==null?void 0:m.has(o),d=this.activeElements.has(o);let c="";try{const g=localStorage.getItem(`element-config-${o}`);g&&(c=JSON.parse(g).pattern||"")}catch{}if(!c){const g=et.getElementConfig(o);c=(g==null?void 0:g.pattern)||""}let u="";d&&l?u=" (A+M)":d?u=" (A)":l&&(u=" (M)");const h=a?`${o}→${a}${u}`:`${o}${u}`;if(c&&c.trim()){const g=c.length>80?c.substring(0,80)+"...":c;return`${h}: ${g}`}else return h});t.textContent=r.join(" | ")}}}elementHasPattern(e){const t=et.getElementConfig(e);if(t!=null&&t.pattern&&t.pattern.trim()!=="")return!0;try{const n=localStorage.getItem(`element-config-${e}`);if(n){const s=JSON.parse(n);if(s.pattern&&s.pattern.trim()!=="")return!0}}catch{}return!1}updateStatusDots(e,t,n){const s=document.querySelector(`[data-sound-id="${e}"]`);if(!s)return;const r=s.querySelector(".loaded-dot"),o=s.querySelector(".playing-dot"),a=s.querySelector(".element-circle");if(r&&(t?r.classList.remove("active"):r.classList.add("active")),o){const l=this.loadElementConfig(e);l&&l.pattern&&l.pattern.trim()!==""?(o.classList.add("active"),n?o.classList.add("is-playing"):o.classList.remove("is-playing")):(o.classList.remove("active"),o.classList.remove("is-playing"))}a&&(n?(a.classList.add("playing"),console.log(`🟢 Circle turned green for ${e} (playing)`)):a.classList.remove("playing"))}isDrumPattern(e){if(!e||typeof e!="string")return!1;const t=e.match(/sound\(["']([^"']+)["']\)|s\(["']([^"']+)["']\)/);if(!t)return!1;const n=t[1]||t[2];return n?n.split(/\s+/).filter(o=>o.trim()).some(o=>wO.hasOwnProperty(o.toLowerCase())):!1}convertNumericPatternToNoteNames(e,t,n){if(!e||!n)return e;const s=O=>typeof O=="string"&&/[b]/i.test(O),r=new Map([["Abb","G"],["Bbb","A"],["Cbb","Bb"],["Dbb","C"],["Ebb","D"],["Fbb","Eb"],["Gbb","F"],["A##","B"],["B##","C#"],["C##","D"],["D##","E"],["E##","F#"],["F##","G"],["G##","A"],["Fb","E"],["Cb","B"],["E#","F"],["B#","C"]]),o=new Map([["A#","Bb"],["C#","Db"],["D#","Eb"],["F#","Gb"],["G#","Ab"]]);function a(O,p){const y=O.match(/^([A-Ga-g])([#b]{0,2})(-?\d+)?$/);if(!y)return O;const M=y[1].toUpperCase(),b=y[2]||"",S=y[3]||"",k=`${M}${b}`;if(r.has(k))return`${r.get(k)}${S}`;if(p&&b==="#"){const x=o.get(`${M}#`);if(x)return`${x}${S}`}return`${M}${b}${S}`}const d={major:"major",minor:"minor",chromatic:"chromatic",harmonicMinor:"harmonic minor",melodicMinor:"melodic minor",dorian:"dorian",phrygian:"phrygian",lydian:"lydian",mixolydian:"mixolydian",locrian:"locrian",blues:"blues",pentatonicMajor:"major pentatonic",pentatonicMinor:"minor pentatonic",ionian:"major",aeolian:"minor","melodic minor":"melodic minor","dorian b2":"dorian b2","lydian augmented":"lydian augmented","lydian dominant":"lydian dominant","mixolydian b6":"mixolydian b6","locrian #2":"locrian #2",altered:"altered","harmonic minor":"harmonic minor","locrian #6":"locrian #6","ionian #5":"ionian #5","dorian #4":"dorian #4","phrygian dominant":"phrygian dominant","lydian #2":"lydian #2",ultralocrian:"ultralocrian","harmonic major":"harmonic major","dorian b5":"dorian b5","phrygian b4":"phrygian b4","lydian b3":"lydian b3","mixolydian b2":"mixolydian b2","lydian augmented #2":"lydian augmented #2","locrian bb7":"locrian bb7","major pentatonic":"major pentatonic","suspended pentatonic":"suspended pentatonic","man gong":"man gong",ritusen:"ritusen","minor pentatonic mode 5":"minor pentatonic","minor pentatonic":"minor pentatonic","blues minor pentatonic":"minor pentatonic","major pentatonic mode 3":"major pentatonic",egyptian:"egyptian","minor pentatonic mode 5":"minor pentatonic","whole tone":"whole tone","half-whole diminished":"dominant diminished","whole-half diminished":"diminished","minor blues":"blues"}[n]||n;let c="C";if(t){const O=t.trim().match(/^([a-gA-G])([#b]?)/);O?c=`${O[1].toUpperCase()}${O[2]||""}`:c=t.trim()}const u=`${c} ${d}`,h=Ki.get(u);if(!h||!h.notes||h.notes.length===0)return console.warn(`⚠️ Could not get scale notes for "${u}"`),e;const f=s(c),m=h.notes.map(O=>a(`${O}`,f).replace(/-?\d+$/,""));console.log(`🎼 Scale "${u}" notes:`,m);const g=/\b(n|note)\s*\(\s*(["'])([^"']+)\2\s*\)/g;return e.replace(g,(O,p,y,M)=>{const b=/(\s+|[,;:<>()[\]{}|\\/]+|\*+)/g,S=[];let k=0,x;for(;(x=b.exec(M))!==null;)x.index>k&&S.push({type:"number",value:M.substring(k,x.index)}),S.push({type:"separator",value:x[0]}),k=x.index+x[0].length;k<M.length&&S.push({type:"number",value:M.substring(k)});const E=[];for(const B of S)if(B.type==="separator")E.push(B.value);else{const F=parseInt(B.value.trim(),10);if(isNaN(F))E.push(B.value);else{const W=m.length||1,z=Math.floor(F/W),ce=(F%W+W)%W,ie=m[ce],pe=4+z,Se=a(`${ie}${pe}`,f);E.push(Se)}}return`note(${y}${E.join("")}${y})`})}getAllScaleNotesAsPattern(e,t){if(!t)return"";const s={major:"major",minor:"minor",chromatic:"chromatic",harmonicMinor:"harmonic minor",melodicMinor:"melodic minor",dorian:"dorian",phrygian:"phrygian",lydian:"lydian",mixolydian:"mixolydian",locrian:"locrian",blues:"blues",pentatonicMajor:"major pentatonic",pentatonicMinor:"minor pentatonic",ionian:"major",aeolian:"minor","dorian b2":"dorian b2","lydian augmented":"lydian augmented","lydian dominant":"lydian dominant","mixolydian b6":"mixolydian b6","locrian #2":"locrian #2",altered:"altered","harmonic minor":"harmonic minor","locrian #6":"locrian #6","ionian #5":"ionian #5","dorian #4":"dorian #4","phrygian dominant":"phrygian dominant","lydian #2":"lydian #2",ultralocrian:"ultralocrian","harmonic major":"harmonic major","dorian b5":"dorian b5","phrygian b4":"phrygian b4","lydian b3":"lydian b3","mixolydian b2":"mixolydian b2","lydian augmented #2":"lydian augmented #2","locrian bb7":"locrian bb7","major pentatonic":"major pentatonic","minor pentatonic":"minor pentatonic","suspended pentatonic":"suspended pentatonic","man gong":"man gong",ritusen:"ritusen","major pentatonic mode 3":"major pentatonic","minor pentatonic mode 5":"minor pentatonic","blues minor pentatonic":"minor pentatonic","whole tone":"whole tone","half-whole diminished":"dominant diminished","whole-half diminished":"diminished","minor blues":"blues"}[t]||t;let r="C";if(e){const c=e.trim().match(/^([a-gA-G])([#b]?)/);c?r=`${c[1].toUpperCase()}${c[2]||""}`:r=e.trim()}const o=`${r} ${s}`,a=Ki.get(o);if(!a||!a.notes||a.notes.length===0)return console.warn(`⚠️ Could not get scale notes for "${o}"`),"";const l=a.notes;return console.log(`🎼 Scale "${o}" notes:`,l),`n("${Array.from({length:l.length},(c,u)=>u).join(" ")}")`}getAllScaleNotesAsNoteNames(e,t){if(!t)return"";const s={major:"major",minor:"minor",harmonicMinor:"harmonic minor",melodicMinor:"melodic minor",dorian:"dorian",phrygian:"phrygian",lydian:"lydian",mixolydian:"mixolydian",locrian:"locrian",blues:"blues",pentatonicMajor:"major pentatonic",pentatonicMinor:"minor pentatonic"}[t]||t;let r="C";if(e){const c=e.trim().match(/^([a-gA-G])([#b]?)/);c?r=`${c[1].toUpperCase()}${c[2]||""}`:r=e.trim()}const o=`${r} ${s}`,a=Ki.get(o);if(!a||!a.notes||a.notes.length===0)return console.warn(`⚠️ Could not get scale notes for "${o}"`),"";const l=a.notes;return console.log(`🎼 Scale "${o}" notes:`,l),`note("${l.map(c=>`${c}4`).join(" ")}")`}resetAll(){console.log("🔄 Resetting all elements and master pattern..."),C.stopAllSounds(),document.querySelectorAll(".sound-element").forEach(s=>{const r=s.dataset.soundId;r&&parseInt(r.replace("element-",""))>4&&(console.log(`🗑️ Removing dynamically created element: ${r}`),s.remove())}),this.elementCounter=4,console.log("🗑️ Clearing all localStorage..."),localStorage.clear(),C.trackedPatterns.clear(),C.updateMasterPattern(),this.masterPatternField&&(Fe("master-pattern",""),this.masterPatternField.placeholder="Combined pattern will appear here..."),document.querySelectorAll(".sound-element").forEach(s=>{const r=s.dataset.soundId;if(r){const o=et.getElementConfig(r);o&&(o.pattern="",o.description="No sound assigned",o.title="",o.sampleUrl="",o.bank=void 0,o.key=void 0,o.scale=void 0,o.keepNotesAsWritten=!1),C.removeElementFromMaster(r),On(r,""),this.updateStatusDots(r,!1,!1);const a=s.querySelector(".element-circle");a&&a.classList.remove("playing");const l=s.querySelector(".master-status-indicator");l&&l.classList.remove("active");const d=s.querySelector(".gain-slider"),c=s.querySelector(".pan-slider");d&&(d.value=.8),c&&(c.value=0),s.querySelectorAll(".filter-collapsible-row").forEach(m=>{const g=m.querySelector(".filter-toggle"),O=m.querySelector(".filter-sliders-container");if(g){g.classList.remove("active");const p=g.querySelector(".toggle-icon");p&&(p.textContent="▶")}O&&(O.style.display="none",O.innerHTML="")}),s.querySelectorAll(".effect-collapsible-row").forEach(m=>{const g=m.querySelector(".effect-toggle"),O=m.querySelector(".effect-sliders-container");if(g){g.classList.remove("active");const p=g.querySelector(".toggle-icon");p&&(p.textContent="▶")}O&&(O.style.display="none",O.innerHTML="")});const f=s.querySelector(".synthesis-section");if(f){f.style.display="none";const m=f.querySelector(".synthesis-content");m&&(m.innerHTML="")}}}),this.activeElements.clear(),this.mutedElements.clear(),this.soloedElements.clear(),this.elementEffects={},this.elementFilters={},this.elementSynthesis={},this.masterActive=!1,this.currentEditingElementId=null,this.selectedVisualizer="scope";const n=document.getElementById("visualizer-select");if(n&&(n.value="scope"),this.masterPunchcardCanvas){const s=this.masterPunchcardCanvas.getContext("2d");s&&s.clearRect(0,0,this.masterPunchcardCanvas.width,this.masterPunchcardCanvas.height)}this.updateActiveElementsDisplay(),this.updateMasterPatternDisplay(),this.updateMasterIndicators(),ot.updateStatus("✅ All cleared")}setAllElementsNotLoaded(){et.elements.forEach(e=>{this.updateStatusDots(e.id,!1,!1)}),console.log("🔴 All element status dots marked as NOT loaded (red)")}setAllElementsLoaded(){et.elements.forEach(e=>{let t=!1;if(e.pattern&&e.pattern.trim()!==""&&(t=!0),!t)try{const n=localStorage.getItem(`element-config-${e.id}`);if(n){const s=JSON.parse(n);s.pattern&&s.pattern.trim()!==""&&(t=!0)}}catch{}this.updateStatusDots(e.id,t,!1)}),console.log("✅ Element status dots updated based on configured patterns")}setupAudioInitialization(){const e=async t=>{C.isAudioReady()||(await C.initialize()?(ot.updateStatus("Audio enabled - Loading sounds..."),document.removeEventListener("click",e),document.removeEventListener("touchstart",e),document.removeEventListener("keydown",e),document.removeEventListener("mousedown",e)):ot.updateStatus("Click to enable audio (required for sound playback)"))};document.addEventListener("click",e,{once:!1}),document.addEventListener("touchstart",e,{once:!1}),document.addEventListener("keydown",e,{once:!1}),document.addEventListener("mousedown",e,{once:!1})}loadAllElementConfigs(){et.elements.forEach(e=>{const t=this.loadElementConfig(e.id);if(t){const n=t.title&&t.title.trim()?t.title:t.bank&&t.bank.trim()?ur[t.bank]||t.bank.replace("github:tidalcycles/",""):"";On(e.id,n),t.pattern!==void 0&&(e.pattern=t.pattern),t.title!==void 0&&(e.description=t.title)}else On(e.id,e.description||"")})}migrateLocalStorageQuotes(){try{console.log("🔧 Migrating localStorage to fix fancy quotes...");let e=0;for(let t=0;t<localStorage.length;t++){const n=localStorage.key(t);if(n&&n.startsWith("element-config-"))try{const s=localStorage.getItem(n);if(s){const r=JSON.parse(s);if(r&&r.pattern){const o=r.pattern,a=o.replace(/[""]/g,'"').replace(/['']/g,"'");o!==a&&(r.pattern=a,localStorage.setItem(n,JSON.stringify(r)),e++,console.log(`  ✅ Fixed quotes in ${n}`))}}}catch(s){console.warn(`  ⚠️ Could not migrate ${n}:`,s)}}e>0?console.log(`✅ Migrated ${e} patterns with fancy quotes`):console.log("✅ No patterns needed migration")}catch(e){console.error("Error during localStorage migration:",e)}}loadElementConfig(e){try{const t=localStorage.getItem(`element-config-${e}`);if(t){const n=JSON.parse(t);if(n&&n.pattern&&(n.pattern=n.pattern.replace(/[""]/g,'"').replace(/['']/g,"'"),n.pattern=kl(n.pattern)),n&&n.bank){const s=co(n.bank);s!==n.bank&&console.log(`🔁 Normalized synth bank from "${n.bank}" to "${s}" for ${e}`),n.bank=s}return n}}catch(t){console.error(`Error loading config for ${e}:`,t)}return null}saveElementConfig(e,t,n=!1){try{if(t.bank&&typeof t.bank=="string"){const c=co(t.bank);c!==t.bank&&(console.log(`🔁 Normalized bank selection from "${t.bank}" to "${c}" before saving`),t.bank=c)}if(t.pattern&&typeof t.pattern=="string"){const c=kl(t.pattern);c!==t.pattern&&(console.log("🔁 Updated pattern to use canonical synth names before saving"),t.pattern=c),tn.saveChannelVersion(e,t.pattern)}localStorage.setItem(`element-config-${e}`,JSON.stringify(t));const s=et.getElementConfig(e);s&&(t.pattern!==void 0&&(s.pattern=t.pattern),t.title!==void 0&&(s.description=t.title),t.sampleUrl&&t.sampleUrl.trim()!==""?(s.audioFile=t.sampleUrl,s.type="audio"):(s.audioFile=void 0,s.type="strudel"));const r=t.title&&t.title.trim()?t.title:t.bank?ur[t.bank]||t.bank.replace("github:tidalcycles/",""):"";On(e,r);const o=document.querySelector(`[data-sound-id="${e}"]`);if(o){const c=t.pattern&&vf(t.pattern),u=o.querySelector(".synthesis-section");u&&c&&(u.style.display="block",console.log(`✅ ${e}: Synthesis section shown for synth pattern`))}const a=t.pattern&&t.pattern.trim()!=="",l=this.activeElements.has(e);this.updateStatusDots(e,a,!1),this.updateSynthesisSectionVisibility(e,t.pattern);const d=C.masterActive;if(t.pattern!==void 0&&(C.invalidatePatternCache(e),C.preEvaluatePattern(e,t.pattern).catch(c=>{console.log(`⚠️ Failed to pre-evaluate pattern for ${e}:`,c)})),!n&&t.pattern!==void 0&&t.pattern.trim()!==""){const c=document.querySelector(`[data-sound-id="${e}"]`);let u=.8,h=0;if(c){const m=c.querySelector(".gain-slider"),g=c.querySelector(".pan-slider");m&&(u=parseFloat(m.value)),g&&(h=parseFloat(g.value))}const f=C.saveElementToMaster(e,t.pattern,u,h);if(f.success){if(C.updateMasterPattern(this.soloedElements,this.mutedElements),!d&&C.masterActive){if(typeof C.stopMasterPattern=="function")try{C.stopMasterPattern()}catch(m){console.warn("⚠️ Could not stop master after save:",m)}C.masterActive=!1}if(!d&&window.strudel&&window.strudel.scheduler&&window.strudel.scheduler.started)try{window.strudel.scheduler.stop()}catch(m){console.warn("⚠️ Could not stop scheduler after save:",m)}this.updateMasterPatternDisplay(),this.updateMasterIndicators(),console.log(`✅ Pattern saved to master for ${e}`)}else console.error(`❌ Failed to save pattern to master for ${e}:`,f.error)}console.log(`✅ Saved config for ${e}:`,t)}catch(s){console.error(`Error saving config for ${e}:`,s)}}setupModal(){const e=document.getElementById("config-modal");if(!e)return;const t=this,n=document.getElementById("modal-pattern-bank"),s=document.getElementById("modal-sample-url"),r=document.getElementById("modal-sample-name"),o=document.getElementById("modal-add-sample-btn"),a=document.getElementById("modal-sample-file"),l=v=>{const w={baseUrl:"./",samplePath:""};if(!v||typeof v!="string")return w;const P=v.trim();if(!P)return w;try{const $=new URL(P),A=$.pathname||"",N=A.endsWith("/")&&A.length>1?A.slice(0,-1):A,T=N.lastIndexOf("/");if(T!==-1){const R=N.slice(T+1)||"",V=N.slice(0,T+1);return{baseUrl:`${$.origin}${V}`,samplePath:R||P}}return{baseUrl:`${$.origin}/`,samplePath:N||$.origin}}catch{const $=P.replace(/\\/g,"/"),A=$.lastIndexOf("/");return A!==-1?{baseUrl:$.slice(0,A+1),samplePath:$.slice(A+1)||$}:{baseUrl:"./",samplePath:$||"sample.wav"}}},d=(v="")=>v.replace(/[\r\n]+/g,"").trim(),c=(v="")=>JSON.stringify(v??""),u=(v,w,P)=>{const $=c(v||"sample"),A=d(P||v||""),N=c(A),T=d(w||"./"),R=c(T||"./"),V=`samples({
  ${$}: ${N}
}, { baseUrl: ${R} })`,J=`sound(${$})`,Z=`(${V},
 ${J})`,Pe=(Ae("modal-pattern")||"").trim(),be=Pe?`${Pe}

${Z}`:Z;Fe("modal-pattern",be),typeof se=="function"&&se(),r.value="",s.value="",a&&(a.value=""),r.focus()};o&&o.addEventListener("click",()=>{if(!r||!s)return;const v=r.value.trim(),w=s.value.trim(),P=a&&a.files&&a.files.length>0;if(!v||!w&&!P){alert("Please provide a Sample Name and either a Sample URL or select a file.");return}if(w){const{baseUrl:$,samplePath:A}=l(w);u(v,$,A||v)}else if(P){const $=a.files[0],A=new FileReader;A.onload=N=>{const T=N.target.result;typeof T=="string"&&T.length>0?u(v,"./",T):alert("Unable to read the selected file. Please try again.")},A.onerror=()=>{alert("Unable to read the selected file. Please try again.")},A.readAsDataURL($)}});const h=()=>{n&&n.querySelectorAll('option[data-source="specialty-vcsl"]').forEach(v=>v.remove())},f=(v=n?n.value:"")=>{if(!n)return;const w=n.value,P=v??w;let $=Array.from(n.children).find(Z=>Z.tagName==="OPTGROUP"&&Z.label&&Z.label.toLowerCase()==="drums"),A=Array.from(n.children).find(Z=>Z.tagName==="OPTGROUP"&&Z.label&&Z.label.toLowerCase().includes("waveform")),N=Array.from(n.children).find(Z=>Z.tagName==="OPTGROUP"&&Z.label&&Z.label.toLowerCase().includes("synth")),T=Array.from(n.children).find(Z=>Z.tagName==="OPTGROUP"&&Z.label===rf),R=Array.from(n.children).find(Z=>Z.tagName==="OPTGROUP"&&Z.label===of);$||($=document.createElement("optgroup"),$.label="Drums",n.insertBefore($,n.firstChild)),A||(A=document.createElement("optgroup"),A.label="Basic Waveforms",$.nextSibling?n.insertBefore(A,$.nextSibling):n.appendChild(A)),N||(N=document.createElement("optgroup"),N.label="Sample-based Synths",A.nextSibling?n.insertBefore(N,A.nextSibling):n.appendChild(N)),T||(T=document.createElement("optgroup"),T.label=rf,N.nextSibling?n.insertBefore(T,N.nextSibling):n.appendChild(T)),R||(R=document.createElement("optgroup"),R.label=of,n.appendChild(R)),$.innerHTML="";const V=document.createElement("option");V.value="",V.textContent="Default",$.appendChild(V),Array.from(hi).sort((Z,U)=>oo(Z).localeCompare(oo(U))).forEach(Z=>{const U=document.createElement("option");U.value=Z,U.textContent=oo(Z),$.appendChild(U)}),T.innerHTML="",R.innerHTML="",Lc.forEach(({value:Z,label:U})=>{const Pe=document.createElement("option");Pe.value=Z,Pe.textContent=U,Z.toLowerCase()==="vcsl"?R.appendChild(Pe):T.appendChild(Pe)}),h(),Array.isArray(Vs)&&Vs.length>0?Vs.forEach(Z=>{const U=document.createElement("option");U.value=Z.optionValue,U.textContent=Z.label,U.dataset.source="specialty-vcsl",U.dataset.instrument=Z.value,R.appendChild(U)}):fi||nM().then(()=>{f(v)}).catch(()=>{}),P&&n.querySelector(`option[value="${P}"]`)?n.value=P:w&&n.querySelector(`option[value="${w}"]`)?n.value=w:n.value=""};f();const m=document.getElementById("modal-drum-grid-section"),g=document.getElementById("modal-drum-grid-timesig"),O=(()=>{if(typeof localStorage>"u")return null;try{return localStorage.getItem("drumGridEditorMode")}catch{return null}})(),p={active:!1,totalSteps:0,built:!1,patternEditorEnabled:O?O==="code":!0,updatingFromPattern:!1,updatingFromGrid:!1,currentBankRows:null,checkboxes:{},numBars:1,currentBar:1,barTokens:[]},y=document.getElementById("modal-pattern-editor-select"),M=e.querySelector(".pattern-label-row");let b=e.querySelector(".pattern-snippet-container"),S=b?b.querySelector(".pattern-snippet-list"):null,k=b?b.querySelector(".pattern-snippet-search"):null;const x=document.getElementById("modal-presets-toggle"),E=document.getElementById("modal-presets-content"),B=document.getElementById("modal-drum-presets"),F=document.getElementById("modal-tonal-presets"),W=document.getElementById("modal-sampler-presets"),z=document.getElementById("modal-preview-btn"),ce=v=>{if(!x||!E)return;x.setAttribute("aria-expanded",v.toString()),E.classList.toggle("is-open",v),E.setAttribute("aria-hidden",(!v).toString());const w=x.closest(".modal-presets");w&&w.classList.toggle("collapsed",!v)},ie=()=>{E&&E.hasAttribute("hidden")&&E.removeAttribute("hidden"),ce(!1)},se=()=>{if(!z)return;const v=Ae("modal-pattern"),w=!!(v&&v.trim().length>0);z.disabled=!w};let pe=null;(async()=>{var T;const v=Ae("modal-pattern"),w=k?k.value.trim().toLowerCase():"",[P,$]=await Promise.all([bf(v),zc()]);if(!b){b=document.createElement("div"),b.className="pattern-snippet-container",b.setAttribute("aria-disabled","false");const R=document.createElement("span");if(R.className="pattern-snippet-heading",R.textContent="Add to pattern:",b.appendChild(R),k=document.createElement("input"),k.type="search",k.className="pattern-snippet-search",k.setAttribute("placeholder","Search tags…"),k.setAttribute("aria-label","Search snippet tags"),b.appendChild(k),S=document.createElement("div"),S.className="pattern-snippet-list",b.appendChild(S),M){const V=e.querySelector(".modal-presets");V&&V.parentElement===M.parentElement?V.insertAdjacentElement("afterend",b):M.insertAdjacentElement("afterend",b)}else(T=e.querySelector(".form-group"))==null||T.insertAdjacentElement("afterbegin",b)}S||(S=b.querySelector(".pattern-snippet-list")),k||(k=b.querySelector(".pattern-snippet-search")),this.selectedTagKey||(this.selectedTagKey=null);let A=this.selectedTagKey;const N=(R,V,J,Z)=>{en(),R.innerHTML="";const U=!!(Z&&Z.trim().length),Pe=Z||"",be=new Map,ve=[];V.forEach(G=>{const ge=typeof G=="string"?G:G.snippet,ye=typeof G=="string"?"other":G.groupId||"other",Le=typeof G=="string"?"":G.className||"",Ee=(typeof G=="string"?"Other":G.heading)||"Other",xe=$n(ge),He=J.get(xe);let ue=gf(ge,He);xe==="bank"&&ue.includes("display bank(bank)")&&(ue="bank()");const rt=ue.replace(/^[.]+/,"");let Ye=rt;const oe=rt.match(/^sound\s*\(\s*["']([^"']+)["']\s*\)/i);oe&&oe[1]?Ye=`sound("${oe[1]}")`:Ye=Ye.replace(/\([^)]*\)/g,"()");const Ke=Ye.toLowerCase(),ps=Ee.toLowerCase();Pe&&!Ke.includes(Pe)&&!xe.includes(Pe)&&!ps.includes(Pe)||(be.has(ye)||(be.set(ye,{id:ye,heading:Ee,className:Le,items:[]}),ve.push(be.get(ye))),be.get(ye).items.push({snippet:ge,insertionSnippet:rt,displayLabel:Ye,key:xe,className:Le,heading:Ee,referenceEntry:He}))}),ve.sort((G,ge)=>{const ye=(G.heading||"").toLowerCase(),Le=(ge.heading||"").toLowerCase();return ye.localeCompare(Le)});let le=!1;const H=new Map;if(V.forEach(G=>{const ge=typeof G=="string"?G:G.snippet,ye=$n(ge);H.has(ye)||H.set(ye,G)}),ve.forEach(G=>{if(!Array.isArray(G.items)||!G.items.length)return;G.items.sort((ue,rt)=>{const Ye=(ue.displayLabel||"").toLowerCase(),oe=(rt.displayLabel||"").toLowerCase();return Ye<oe?-1:Ye>oe?1:0}),le=!0;const ge=document.createElement("div");ge.className="pattern-snippet-group",ge.dataset.groupId=G.id;const ye=mM.has(G.id)?pM:fM,Le=qi.has(G.id)?qi.get(G.id):ye.has(G.id),Ee=U?!0:Le;qi.has(G.id)||qi.set(G.id,Le);const xe=document.createElement("button");xe.type="button",xe.className="pattern-snippet-group-heading",xe.textContent=G.heading,xe.setAttribute("aria-expanded",Ee?"true":"false");const He=document.createElement("div");He.className="pattern-snippet-group-items",Ee||ge.classList.add("collapsed"),xe.addEventListener("click",()=>{en();const rt=!ge.classList.toggle("collapsed");xe.setAttribute("aria-expanded",rt?"true":"false"),qi.set(G.id,rt)}),G.items.forEach(ue=>{var ht,Qt,Rt,Be;const rt=document.createElement("div");rt.className="pattern-snippet-item",rt.dataset.snippetKey=$n(ue.snippet);const Ye=$n(ue.snippet);let oe=Zn[Ye];if(!oe&&ue.snippet){const fe=ue.snippet.match(/\(([a-zA-Z_]+):number\)/),at=ue.snippet.match(/\(([0-9.]+)\)/);if(fe||at){let Oe=at?parseFloat(at[1]):null;if(fe&&!Oe){const Re=fe[1];Zn[Ye]?oe=Zn[Ye]:Re.includes("attack")||Re.includes("decay")||Re.includes("release")?oe={min:0,max:2,step:.01,default:.01,unit:"s"}:Re.includes("sustain")||Re.includes("modulation")||Re.includes("env")?oe={min:0,max:1,step:.01,default:.5,unit:""}:oe={min:0,max:1,step:.01,default:.5,unit:""}}else if(at&&Oe!==null){let Re=Math.max(0,Oe*.1),Te=Oe*10,jt=Oe<1?.01:Oe<10?.1:1;Oe>=20&&Oe<=2e4?(Re=20,Te=2e4,jt=10):Oe>=0&&Oe<=1?(Re=0,Te=1,jt=.01):Oe>=-1&&Oe<=1&&(Re=-1,Te=1,jt=.01),oe={min:Re,max:Te,step:jt,default:Oe,unit:""}}}}if(!!oe){const fe=document.createElement("button");fe.type="button";const at=gl(ue.snippet),Oe=!at&&ue.groupId!=="core"&&pl(ue.snippet),Re=[ue.className||"",at,Oe?"pattern-snippet-tag-core":""].filter(Boolean).join(" ");fe.className=`pattern-snippet-tag ${Re}`.trim(),fe.dataset.snippet=ue.snippet,fe.dataset.insertion=ue.insertionSnippet;let Te=ue.displayLabel;const jt=Te.match(/\(([a-zA-Z_]+):number\)/);jt?Te=`${jt[1]}()`:Te.includes('sound("')&&Te.includes('")')?Te=ue.displayLabel:Te=Te.replace(/\([^)]*\)/g,"()"),fe.textContent=Te,fe.setAttribute("aria-label",ue.displayLabel);const Je=document.createElement("div");Je.className="slider-row snippet-slider-row",Je.style.display="none",Je.style.width="100%",Je.style.marginTop="8px",Je.style.padding="8px",Je.style.backgroundColor="rgba(102, 126, 234, 0.05)",Je.style.border="1px solid rgba(102, 126, 234, 0.2)",Je.style.borderRadius="4px";const Ft=document.createElement("label");Ft.textContent=ue.displayLabel.replace(/\(\)$/,""),Ft.style.fontSize="0.75rem",Ft.style.fontWeight="600",Ft.style.color="#4c51bf",Ft.style.marginBottom="4px";const lt=document.createElement("div");lt.style.display="flex",lt.style.alignItems="center",lt.style.gap="8px",lt.style.width="100%";const we=document.createElement("input");we.type="range",we.className="snippet-slider",we.dataset.snippet=ue.snippet,we.dataset.tagKey=Ye,we.style.flex="1";let Ne;const In=Ye,De=oe.unit==="Hz"&&(Ye==="lpf"||Ye==="hpf"||Ye==="bpf"||Ye==="cutoff"||Ye==="roomlp");if(De){we.min="0",we.max="1",we.step="0.001";const Ht=(()=>{const Yt=Ae("modal-pattern")||"",Ct=new RegExp(`\\.${In}\\(([^)]+)\\)`,"g").exec(Yt);return Ct?Ct[1]:null})();let Mt=Ht?parseFloat(Ht):oe.default;Mt=Math.max(oe.min,Math.min(oe.max,Mt));const Ln=fl(Mt);we.value=String(Ln),Ne=document.createElement("span"),Ne.className="slider-value",Ne.style.minWidth="60px",Ne.style.textAlign="right",Ne.style.fontSize="0.75rem",Ne.style.fontWeight="600",Ne.textContent=Math.round(Mt)+" "+oe.unit,we.addEventListener("input",Yt=>{const cn=parseFloat(Yt.target.value),Ct=ml(cn);Ne.textContent=Math.round(Ct)+" "+oe.unit})}else{we.min=String(oe.min),we.max=String(oe.max),we.step=String(oe.step);const Ht=(()=>{const Mt=Ae("modal-pattern")||"",Yt=new RegExp(`\\.${In}\\(([^)]+)\\)`,"g").exec(Mt);return Yt?Yt[1]:null})();we.value=String(Ht||oe.default),Ne=document.createElement("span"),Ne.className="slider-value",Ne.style.minWidth="60px",Ne.style.textAlign="right",Ne.style.fontSize="0.75rem",Ne.style.fontWeight="600",Ne.textContent=we.value+(oe.unit?" "+oe.unit:""),we.addEventListener("input",Mt=>{const Ln=Mt.target.value;Ne.textContent=Ln+(oe.unit?" "+oe.unit:"")})}we.addEventListener("change",ss=>{let Ht=ss.target.value;if(De){const Ct=parseFloat(Ht),gn=ml(Ct);Ht=Math.round(gn),Ne.textContent=Ht+" "+oe.unit}else Ne.textContent=Ht+(oe.unit?" "+oe.unit:"");const Mt=Ae("modal-pattern")||"",Ln=`.${In}(${Ht})`,Yt=new RegExp(`\\.${In}\\([^)]*\\)`,"g");if(Yt.test(Mt)){const Ct=Mt.replace(Yt,Ln);Fe("modal-pattern",Ct)}else{const Ct=Mt.trim()+Ln;Fe("modal-pattern",Ct)}}),fe.addEventListener("click",ss=>{if(ss.stopPropagation(),ss.preventDefault(),Je.style.display==="none"||Je.style.display===""){Je.style.display="flex",Je.style.flexDirection="column",Je.style.gap="4px";const Mt=Ae("modal-pattern")||"",Yt=new RegExp(`\\.${In}\\(([^)]+)\\)`,"g").exec(Mt);if(Yt){let cn=Yt[1];if(De){const Ct=parseFloat(cn),gn=Math.max(oe.min,Math.min(oe.max,Ct)),zi=fl(gn);we.value=String(zi),Ne.textContent=Math.round(gn)+" "+oe.unit}else we.value=cn,Ne.textContent=cn+(oe.unit?" "+oe.unit:"")}else{let cn=we.value;if(De){const zi=parseFloat(we.value);cn=Math.round(ml(zi))}const Ct=`.${In}(${cn})`,gn=Mt.trim()+Ct;Fe("modal-pattern",gn)}}});const $t=((ht=ue.referenceEntry)==null?void 0:ht.name)||ue.displayLabel.replace(/^[.]+/,"").trim(),ui=yl(ue.referenceEntry),Zr=Array.isArray((Qt=ue.referenceEntry)==null?void 0:Qt.params)?ue.referenceEntry.params.map(bl).filter(Boolean).join(`
`):"";fe.dataset.tooltipTitle=$t||ue.displayLabel,fe.dataset.tooltipDescription=ui||"",fe.dataset.tooltipParams=Zr||"";const ct=()=>vl(fe),Di=()=>en(fe);fe.addEventListener("mouseenter",ct),fe.addEventListener("mouseleave",Di),fe.addEventListener("focus",ct),fe.addEventListener("blur",Di),lt.appendChild(we),lt.appendChild(Ne),Je.appendChild(Ft),Je.appendChild(lt),rt.appendChild(fe),rt.appendChild(Je)}else{const fe=document.createElement("button");fe.type="button";const at=gl(ue.snippet),Oe=!at&&ue.groupId!=="core"&&pl(ue.snippet),Re=[ue.className||"",at,Oe?"pattern-snippet-tag-core":""].filter(Boolean).join(" ");fe.className=`pattern-snippet-tag ${Re}`.trim(),fe.dataset.snippet=ue.snippet,fe.dataset.insertion=ue.insertionSnippet,fe.textContent=ue.displayLabel,fe.setAttribute("aria-label",ue.displayLabel);const Te=((Rt=ue.referenceEntry)==null?void 0:Rt.name)||ue.displayLabel.replace(/^[.]+/,"").trim(),jt=yl(ue.referenceEntry),Je=Array.isArray((Be=ue.referenceEntry)==null?void 0:Be.params)?ue.referenceEntry.params.map(bl).filter(Boolean).join(`
`):"";fe.dataset.tooltipTitle=Te||ue.displayLabel,fe.dataset.tooltipDescription=jt||"",fe.dataset.tooltipParams=Je||"";const Ft=()=>vl(fe),lt=()=>en(fe);fe.addEventListener("mouseenter",Ft),fe.addEventListener("mouseleave",lt),fe.addEventListener("focus",Ft),fe.addEventListener("blur",lt),fe.addEventListener("click",lt),rt.appendChild(fe)}He.appendChild(rt);const ps=A||t.selectedTagKey;if(ps&&Ye===ps){const fe=gM[Ye];if(fe&&Array.isArray(fe)&&fe.length>0){const at=document.createElement("div");at.className="pattern-snippet-suggestions";const Oe=document.createElement("div");Oe.className="pattern-snippet-suggestions-label",Oe.textContent="Suggested:",at.appendChild(Oe);const Re=document.createElement("div");Re.className="pattern-snippet-suggestions-list";const jt=fe.filter(Je=>H.has(Je)).slice(0,8);jt.forEach(Je=>{const Ft=H.get(Je),lt=typeof Ft=="string"?Ft:Ft.snippet,we=$n(lt),Ne=J.get(we),De=gf(lt,Ne).replace(/^[.]+/,"");let $t=De;$t=$t.replace(/\([^)]*\)/g,"()");let ui="other",Zr="";for(const gn of hr)if(gn.matcher(we,lt)){ui=gn.id,Zr=gn.className;break}const ct=document.createElement("button");ct.type="button";const Di=gl(lt),ss=!Di&&ui!=="core"&&pl(lt),Ht=[Zr,Di,ss?"pattern-snippet-tag-core":"","pattern-snippet-tag-suggested"].filter(Boolean).join(" ");ct.className=`pattern-snippet-tag ${Ht}`.trim(),ct.dataset.snippet=lt,ct.dataset.insertion=De,ct.textContent=$t,ct.setAttribute("aria-label",$t),ct.addEventListener("click",gn=>{gn.stopPropagation(),!b.classList.contains("disabled")&&p.patternEditorEnabled&&(A=we,t.selectedTagKey=we,en(ct),nf("modal-pattern",De),typeof pe=="function"&&pe().catch(zi=>console.warn("⚠️ Unable to refresh snippet tags:",zi)))});const Mt=(Ne==null?void 0:Ne.name)||$t.replace(/^[.]+/,"").trim(),Ln=yl(Ne),Yt=Array.isArray(Ne==null?void 0:Ne.params)?Ne.params.map(bl).filter(Boolean).join(`
`):"";ct.dataset.tooltipTitle=Mt||$t,ct.dataset.tooltipDescription=Ln||"",ct.dataset.tooltipParams=Yt||"";const cn=()=>vl(ct),Ct=()=>en(ct);ct.addEventListener("mouseenter",cn),ct.addEventListener("mouseleave",Ct),ct.addEventListener("focus",cn),ct.addEventListener("blur",Ct),Re.appendChild(ct)}),jt.length>0&&(at.appendChild(Re),He.appendChild(at))}}}),ge.appendChild(xe),ge.appendChild(He),R.appendChild(ge)}),!le){const G=document.createElement("div");G.className="pattern-snippet-empty",G.textContent="No tags match your search.",R.appendChild(G)}};S&&N(S,P,$,w),pe=async()=>{if(!S)return;const R=await bf(Ae("modal-pattern")),V=await zc(),J=k?k.value.trim().toLowerCase():"";A=t.selectedTagKey,N(S,R,V,J)},t.refreshSnippetButtons=pe,S&&!S.dataset.listenersAttached&&(S.addEventListener("click",R=>{const V=R.target.closest(".pattern-snippet-tag");if(!V||b.classList.contains("disabled")||!p.patternEditorEnabled)return;const J=V.closest(".pattern-snippet-item");if(J&&J.dataset.snippetKey){const Pe=J.dataset.snippetKey;if(Zn[Pe])return}const Z=V.dataset.insertion||V.dataset.snippet;if(!Z)return;const U=$n(Z);A=U,t.selectedTagKey=U,en(V),nf("modal-pattern",Z),typeof pe=="function"&&pe().catch(Pe=>console.warn("⚠️ Unable to refresh snippet tags:",Pe))}),S.addEventListener("mouseleave",()=>{en()}),S.addEventListener("scroll",()=>{en()}),S.dataset.listenersAttached="true"),k&&!k.dataset.listenerAttached&&(k.addEventListener("input",()=>{en(),typeof pe=="function"&&pe().catch(R=>console.warn("⚠️ Unable to refresh snippet tags:",R))}),k.dataset.listenerAttached="true")})().catch(v=>{console.warn("⚠️ Unable to prepare pattern snippet tags:",v)}),se();const st=v=>{try{if(!e)return;this.currentEditingElementId=v,ee(!0),y&&(y.value="code");const w=document.getElementById("modal-element-id");w&&(w.textContent=v||"");const P=this.loadElementConfig?this.loadElementConfig(v):null,$=(P==null?void 0:P.bank)||"",A=(P==null?void 0:P.vcslInstrument)||"",N=$==="vcsl"&&A?`${Yo}${A}`:$;f(N),n&&(n.value=N);const T=(P==null?void 0:P.pattern)||"";Fe("modal-pattern",T||"");const R=document.getElementById("modal-key-select"),V=document.getElementById("modal-scale-select");R&&(P!=null&&P.key||(P==null?void 0:P.key)==="")&&(R.value=P.key||""),V&&(P!=null&&P.scale||(P==null?void 0:P.scale)==="")&&(V.value=P.scale||"chromatic"),q(),te(),se(),Vr(),ns(),ie(),e.style.display="block"}catch(w){console.warn("⚠️ Failed to open modal:",w)}},Ze=()=>{try{if(!e)return;e.style.display="none",C&&typeof C.stopSound=="function"&&C.stopSound("modal-preview")}catch(v){console.warn("⚠️ Failed to close modal:",v)}};if(z&&!z.dataset.listenerAttached){let v=!1;z.addEventListener("click",async()=>{const w="modal-preview";if(C.trackedPatterns&&C.trackedPatterns.has(w)){C.stopSound&&C.stopSound(w);try{const Z=C.trackedPatterns?C.trackedPatterns.size:0;v&&Z===0&&C.stopMasterPattern&&await C.stopMasterPattern()}catch{}v=!1,z.textContent="▶ Preview Pattern",z.classList.remove("active"),ot.updateStatus("⏹ Preview stopped");return}p.active&&ii();let $=Ae("modal-pattern");if(!$||!$.trim()){ot.updateStatus("⚠️ No pattern to preview");return}const N=(n?cl(n.value):{bankValue:""}).bankValue;console.log("🎵 Preview: Original pattern:",$),console.log("🎵 Preview: Bank value:",N);const T=[...ir,...mi],R=N&&T.includes(N.toLowerCase()),V=N&&hi.has(N);if(N&&N!=="")if(V&&!R)if($.includes(".bank("))$=$.replace(/\.bank\(["'][^"']*["']\)/g,`.bank("${N}")`);else if($.includes(".gain(")||$.includes(".pan(")||$.includes(".fast(")||$.includes(".slow(")){const Z=$.match(/(\.(gain|pan|fast|slow)\([^)]*\))/);if(Z){const U=Z.index;$=$.slice(0,U)+`.bank("${N}")`+$.slice(U)}else $=`${$}.bank("${N}")`}else $=`${$}.bank("${N}")`;else R&&($=$.replace(/\.bank\(["'][^"']*["']\)/g,""),$=$.replace(/\.+$/,"").trim());else $=$.replace(/\.bank\(["'][^"']*["']\)/g,""),$=$.replace(/\.+$/,"").trim();console.log("🎵 Preview: Final pattern before preview:",$);const J=this.currentEditingElementId;if(J){const Z=C.elementGainValues.get(J)||.8,U=C.elementPanValues.get(J)||0,Pe=Z*.501;C.elementGainValues.set(w,Pe),C.elementPanValues.set(w,U),console.log(`🎵 Preview: Using gain=${Pe} (${Z} * 0.501 for -6dB), pan=${U} from element ${J}`)}if(N&&N!==""){console.log(`🎵 Preview: Ensuring bank "${N}" is loaded...`);try{await C.loadBank(N),console.log(`✅ Preview: Bank "${N}" loaded successfully`)}catch(Z){console.warn(`⚠️ Preview: Could not load bank "${N}":`,Z)}}ot.updateStatus("▶ Previewing pattern…"),z.textContent="⏹ Stop Preview",z.classList.add("active");try{const Z=!!C.masterActive;await C.playStrudelPattern(w,$),!C.masterActive&&C.playMasterPattern&&await C.playMasterPattern(),v=!Z&&!!C.masterActive,ot.updateStatus("✅ Preview playing")}catch(Z){console.error("Preview failed:",Z),ot.updateStatus("⚠️ Preview failed – check console for details"),z.textContent="▶ Preview Pattern",z.classList.remove("active")}}),z.dataset.listenerAttached="true"}const St=v=>{en(),j$("modal-pattern",v);const w=document.getElementById("modal-pattern");w&&w.classList.toggle("pattern-editor-readonly",!v),b&&(b.classList.toggle("disabled",!v),b.setAttribute("aria-disabled",(!v).toString())),k&&(k.disabled=!v)},it=()=>{var P;y&&(y.value=p.patternEditorEnabled?"code":"step"),St(p.patternEditorEnabled);const v=document.getElementById("modal-pattern-editor-wrapper");v&&(v.style.display=p.patternEditorEnabled?"block":"none",je()),b&&(b.style.display=p.patternEditorEnabled?"block":"none");const w=(P=document.getElementById("modal-time-signature-select"))==null?void 0:P.closest(".form-group");w&&(w.style.display=p.patternEditorEnabled?"none":"block")},je=()=>{const v=document.getElementById("modal-note-conversion-control");if(!v)return;const w=Ae("modal-pattern"),P=w&&Kt(w);P&&kn(w),P?v.style.display="block":v.style.display="none"},Ie=document.getElementById("modal-pattern");if(Ie&&!Ie.dataset.previewListenerAttached){const v=w=>{if(!w||typeof w!="string"||!w.includes("(silence)")||!/\b(note|n)\s*\(/i.test(w))return w;const P=w.trim().startsWith("(silence)"),$=w.trim().match(/^\(silence\)\.\s*([\s\S]+)$/);if(P&&$){const N=$[1].trim().replace(/^\.+/,""),T=w.search(/\b(note|n)\s*\(/i);if(T>=0){let R=w.indexOf("(",T),V=0,J=-1;for(let Z=R;Z<w.length;Z++){const U=w[Z];if(U==="(")V++;else if(U===")"&&(V--,V===0)){J=Z;break}}if(J>R){let U=`${w.substring(T,J+1).trim()}`;return N&&!/^\s*$/.test(N)&&(U=`${U}.${N}`.replace(/\.\.+/g,".").replace(/\.($|\s)/,"$1").trim()),U}}}let A=w.replace(/\(silence\)/g,"").replace(/\.\.+/g,".").trim();return A=A.replace(/^\./,"").trim(),A};Ie.addEventListener("input",()=>{const w=Ae("modal-pattern"),P=v(w);P!==w&&Fe("modal-pattern",P),se(),je(),P&&kn(P)&&(ai=P),ln=!1,ms(Ae("modal-pattern"),!0);const $=document.getElementById("modal-key-scale-group"),A=Ae("modal-pattern"),N=A&&Kt(A),T=n?n.value:"",R=T&&mi.includes(T.toLowerCase());$&&($.style.display=N||R?"block":"none"),typeof pe=="function"&&pe().catch(V=>console.warn("⚠️ Unable to refresh snippet tags:",V))}),Ie.dataset.previewListenerAttached="true"}const ee=v=>{p.patternEditorEnabled=!!v,it();try{typeof localStorage<"u"&&localStorage.setItem("drumGridEditorMode",p.patternEditorEnabled?"code":"step")}catch{}},kt=v=>{const w=cl(v);return w.bankValue&&hi.has(w.bankValue)},ut=v=>{g&&(g.textContent=`${v.signature} · ${v.totalSteps} steps`)},ae=()=>{const v=document.getElementById("modal-drum-grid-bar-count"),w=document.getElementById("modal-drum-grid-bar-arrow-left"),P=document.getElementById("modal-drum-grid-bar-arrow-right");v&&(p.numBars===1?v.textContent="1 bar":v.textContent=`Bar ${p.currentBar} of ${p.numBars}`),w&&(w.style.display=p.numBars>1&&p.currentBar>1?"flex":"none"),P&&(P.style.display=p.numBars>1&&p.currentBar<p.numBars?"flex":"none")},Me=v=>{if(v<1||v>p.numBars)return;const w=document.getElementById("modal-time-signature-select"),P=(w==null?void 0:w.value)||this.currentTimeSignature||"4/4",$=xn(P);ti($),p.currentBar=v,ae();const A=n?n.value:"";if(p.built=!1,_n($,A),!p.barTokens||!p.barTokens.length){const N=Ae("modal-pattern"),T=Vt(N);qt($,T||[])}else xt($);ni($)},qe=()=>{const v=document.getElementById("modal-time-signature-select"),w=(v==null?void 0:v.value)||this.currentTimeSignature||"4/4",P=xn(w);ti(P),p.numBars++,xt(P);const $=P.totalSteps;p.barTokens[p.numBars-1]=new Array($).fill("~"),ae(),Me(p.numBars)},ds=()=>{!p.active||p.updatingFromPattern||ii()},_n=(v,w)=>{if(!m)return;const P=w&&df[w]?df[w]:hl;if(!(!p.built||p.totalSteps!==v.totalSteps||JSON.stringify(p.currentBankRows)!==JSON.stringify(P)))return;const A=document.getElementById("modal-drum-grid-container");if(!A){console.error("❌ ensureDrumGridBuilt: Drum grid container not found!"),console.error("   Looking for: modal-drum-grid-container"),console.error("   Modal exists:",!!m),m&&console.error("   Drum grid section children:",Array.from(m.children).map(N=>N.id||N.className));return}console.log("🔨 Building drum grid with",P.length,"rows,",v.totalSteps,"steps"),console.log("   Grid container found:",A,"current children:",A.children.length),A.innerHTML="",p.checkboxes={},p.currentBankRows=P,P.forEach(({key:N,label:T,sample:R})=>{const V=document.createElement("div");V.className="drum-grid-row",V.setAttribute("data-row",N);const J=document.createElement("span");J.className="drum-grid-row-label",J.textContent=T,V.appendChild(J);const Z=document.createElement("div");Z.className="drum-grid-steps",Z.id=`drum-grid-steps-${N}`,Z.style.gridTemplateColumns=`repeat(${v.totalSteps}, minmax(18px, 1fr))`,p.checkboxes[N]=[],v.totalSteps*p.numBars;const U=(p.currentBar-1)*v.totalSteps,Pe=U+v.totalSteps;for(let be=U;be<Pe;be+=1){const ve=document.createElement("div");ve.className="drum-grid-step";const le=be-U;le>0&&le%4===0&&ve.classList.add("quarter-boundary");const H=document.createElement("input");H.type="checkbox",H.dataset.row=N,H.dataset.step=String(be),H.dataset.bar=String(p.currentBar),H.addEventListener("change",ds),ve.appendChild(H),Z.appendChild(ve),p.checkboxes[N].push(H)}V.appendChild(Z),A.appendChild(V)}),xt(v),ni(v),p.totalSteps=v.totalSteps,p.built=!0},Vt=v=>{if(!v||typeof v!="string")return null;const w=v.match(/(?:s|sound)\(\s*["'`]([^"'`]+)["'`]\s*\)/i);if(!w||!w[1])return null;const P=w[1].trim();return P?P.split(/\s+/).filter(Boolean):null};function pn(v){if(!v)return[];const w=v.trim();if(!w||w==="~")return[];let P=w;return(P.startsWith("[")&&P.endsWith("]")||P.startsWith("{")&&P.endsWith("}"))&&(P=P.slice(1,-1)),P=P.replace(/[,]+/g," "),P.split(/\s+/).map($=>$.trim()).filter(Boolean)}function xt(v){p.barTokens||(p.barTokens=[]);const w=v.totalSteps,P=Math.max(1,p.numBars);for(p.barTokens.length>P&&(p.barTokens.length=P);p.barTokens.length<P;)p.barTokens.push(new Array(w).fill("~"));p.barTokens=p.barTokens.map($=>{const A=Array.isArray($)?$.slice(0,w):[];for(;A.length<w;)A.push("~");return A})}function qt(v,w){const P=v.totalSteps,$=Math.max(1,p.numBars),A=P*$;let N=Array.isArray(w)?w.slice(0,A):[];N.length<A&&(N=N.concat(new Array(A-N.length).fill("~"))),p.barTokens=[];for(let T=0;T<$;T++){const R=T*P;p.barTokens.push(N.slice(R,R+P))}xt(v)}function ti(v){if(!p.active||p.updatingFromPattern||!p.checkboxes)return;const w=p.currentBar-1;if(w<0)return;xt(v);const P=v.totalSteps,$=p.currentBankRows||hl,A=new Array(P).fill("~");for(let N=0;N<P;N+=1){const T=[];$.forEach(({key:R,sample:V})=>{const J=p.checkboxes[R],Z=J?J[N]:null;Z&&Z.checked&&T.push(V)}),T.length===1?A[N]=T[0]:T.length>1&&(A[N]=`[${T.join(" ")}]`)}p.barTokens[w]=A}function ni(v){if(!p.checkboxes)return;xt(v);const w=p.currentBar-1,P=p.barTokens[w];if(!P)return;(p.currentBankRows||hl).forEach(({key:A,sample:N})=>{const T=p.checkboxes[A];T&&T.forEach((R,V)=>{if(!R)return;const J=pn(P[V]);R.checked=J.includes(N)})})}function Rr(){return Array.isArray(p.barTokens)?p.barTokens.flat():[]}const si=(v,w)=>{if(!m||!p.active)return;const P=Vt(v),$=w.totalSteps;if(P&&P.length){const A=Math.max(1,Math.ceil(P.length/$));p.numBars!==A&&(p.numBars=A,p.currentBar>p.numBars&&(p.currentBar=p.numBars),ae()),qt(w,P)}else p.barTokens.length?xt(w):qt(w,[]);p.updatingFromPattern=!0,ni(w),p.updatingFromPattern=!1},_r=v=>(xt(v),Rr()),ii=()=>{if(!m||!p.active||!n)return;const v=document.getElementById("modal-time-signature-select"),w=(v==null?void 0:v.value)||this.currentTimeSignature||"4/4",P=xn(w);ti(P);const A=_r(P).join(" "),N=n.value,T=N&&N!==""?`.bank("${N}")`:"",R=`s("${A}")${T}`;p.updatingFromGrid=!0,Fe("modal-pattern",R),p.updatingFromGrid=!1},ri=(v,w)=>{if(!m){console.warn("⚠️ Drum grid section not found");return}const P=n?n.value:"";console.log("🎹 Showing drum grid for bank:",P,"metrics:",v);const $=document.getElementById("modal-drum-grid-container");if(!$){console.error("❌ Drum grid container not found!");return}console.log("✅ Grid container found:",$),_n(v,P),ut(v),m.style.display="block",p.active=!0,si(w,v),ae();const A=$.querySelectorAll(".drum-grid-row");console.log("✅ Drum grid shown, active:",p.active,"rows:",A.length)},Es=()=>{m&&(m.style.display="none",p.active=!1,p.built=!1,p.numBars=1,p.currentBar=1,ae())};it();const ns=()=>{if(!n){console.log("⚠️ refreshDrumGridForCurrentState: bankSelect not found");return}const v=n.value,w=kt(v);if(console.log("🔄 refreshDrumGridForCurrentState: bankValue=",v,"isDrum=",w,"patternEditorEnabled=",p.patternEditorEnabled),y&&(y.style.display=w?"block":"none"),!w){console.log("📝 Not a drum bank, enabling pattern editor"),ee(!0),Es(),it();return}const P=Ae("modal-pattern");if(P&&P.trim(),Vt(P),p.patternEditorEnabled){console.log("📝 Pattern editor enabled, hiding drum grid"),Es(),it();return}console.log("🎹 Showing drum grid for drum bank");const $=document.getElementById("modal-time-signature-select"),A=($==null?void 0:$.value)||this.currentTimeSignature||"4/4",N=xn(A);console.log("🎹 Calling showDrumGrid with metrics:",N,"pattern:",P),ri(N,P)},Ce=document.getElementById("modal-pattern");Ce&&Ce.addEventListener("input",()=>{if(!p.active||p.updatingFromGrid||!n||!kt(n.value))return;const v=document.getElementById("modal-time-signature-select"),w=(v==null?void 0:v.value)||this.currentTimeSignature||"4/4",P=xn(w),$=Ce.value?Ce.value.trim():"",A=Vt(Ce.value);if($&&(!A||A.length===0)){ee(!0),Es();return}si(Ce.value,P)});const Ir=v=>{var T;if(!v)return;const w=this.currentEditingElementId;if(w){const R=document.getElementById("modal-title");R&&(R.value=v.label);const V=document.getElementById("modal-element-id");if(V&&(V.textContent=Is(w)),On(w,v.label),typeof this.saveElementConfig=="function"){const Z={...((T=this.loadElementConfig)==null?void 0:T.call(this,w))||{},title:v.label};this.saveElementConfig(w,Z,!0)}}const P=typeof v.bank=="string"?v.bank:"",$=()=>{if(typeof v.useNoteNames=="boolean")return v.useNoteNames;const R=v.pattern||"";return R.includes("note(")||R.includes('note("')},A=()=>{if(v.pattern){const R=document.getElementById("modal-keep-notes-as-written");R&&(R.checked=$()),Fe("modal-pattern",v.pattern.trim()),se()}P&&kt(P)?(ee(!1),ns()):(ee(!0),Es(),it()),Ce&&Ce.focus()},N=document.getElementById("modal-keep-notes-as-written");if(N&&(N.checked=$()),n){const R=P||"";if(n.value!==R){n.value=R,n.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout(A,60);return}}A()};ie();const us=v=>{if(!v||!v.classList.contains("has-tooltip"))return;const w=v.getBoundingClientRect();if(w.width===0&&w.height===0){requestAnimationFrame(()=>us(v));return}const P=(e==null?void 0:e.querySelector(".modal-presets-content"))||e,$=P?P.getBoundingClientRect():{left:0,width:window.innerWidth},A=$.left+$.width/2,T=w.left+w.width/2>A;v.classList.toggle("tooltip-align-right",T),v.classList.toggle("tooltip-align-left",!T)};let on=null;const wt=()=>{on||(on=requestAnimationFrame(()=>{on=null;const v=e==null?void 0:e.querySelectorAll(".modal-preset-button.has-tooltip");v==null||v.forEach(w=>us(w))}))};window.addEventListener("resize",wt);const hs=(v,w)=>{!v||!Array.isArray(w)||(v.innerHTML="",w.forEach(P=>{const $=document.createElement("button");$.type="button",$.className="modal-preset-button";const A=P.editorBadge?`<span class="modal-preset-badge${P.editorBadge.toLowerCase().includes("code")?" is-code":P.editorBadge.toLowerCase().includes("step")?" is-step":""}">${P.editorBadge}</span>`:"",N=P.secondaryLabel?`<div class="modal-preset-secondary-row">${P.secondaryLabel}</div>`:"";$.innerHTML=`
          <div class="modal-preset-heading-row">
            <strong>${P.label}</strong>
            ${A}
          </div>
          ${N}
          ${P.description?`<span class="modal-preset-description">${P.description}</span>`:""}
        `,P.tooltip&&($.classList.add("has-tooltip"),$.setAttribute("data-tooltip",P.tooltip),$.addEventListener("mouseenter",()=>us($)),$.addEventListener("focus",()=>us($)),requestAnimationFrame(()=>us($))),$.addEventListener("click",()=>Ir(P)),v.appendChild($)}),wt())},Lr=()=>{e.querySelectorAll(".modal-presets-subtoggle").forEach(w=>{const P=w.getAttribute("data-target"),$=P?document.getElementById(P):w.nextElementSibling;if(!$)return;const A=T=>{w.setAttribute("aria-expanded",String(T)),$.classList.toggle("is-open",T);const R=w.closest(".modal-presets-group");R&&R.classList.toggle("collapsed",!T)},N=$.classList.contains("is-open");A(N),w.addEventListener("click",()=>{const T=w.getAttribute("aria-expanded")!=="true";A(T)})})};x&&E&&x.addEventListener("click",()=>{const w=!(x.getAttribute("aria-expanded")==="true");ce(w)}),hs(B,iM),hs(F,SO),hs(W,rM),Lr(),y&&y.addEventListener("change",v=>{const w=v.target.value==="code";ee(w),ns()});const Qi=document.getElementById("modal-time-signature-select");Qi&&Qi.addEventListener("change",v=>{const w=v.target.value;if(w&&(this.currentTimeSignature=w,p.active)){const P=xn(w),$=Ae("modal-pattern"),A=n?n.value:"";_n(P,A),ut(P),ri(P,$)}});const As=document.getElementById("modal-drum-grid-bar-count"),Ri=document.getElementById("modal-drum-grid-add-bar"),_i=document.getElementById("modal-drum-grid-bar-arrow-left"),Ii=document.getElementById("modal-drum-grid-bar-arrow-right");As&&(As.addEventListener("click",()=>{const v=p.currentBar<p.numBars?p.currentBar+1:1;Me(v)}),As.style.cursor="pointer",As.title="Click to switch between bars"),_i&&_i.addEventListener("click",v=>{v.stopPropagation(),p.currentBar>1&&Me(p.currentBar-1)}),Ii&&Ii.addEventListener("click",v=>{v.stopPropagation(),p.currentBar<p.numBars&&Me(p.currentBar+1)}),Ri&&Ri.addEventListener("click",v=>{v.stopPropagation(),qe()}),this.applyTimeSignatureToDrumGrid=v=>{if(!m||!p.active)return;const w=xn(v||"4/4"),P=Ae("modal-pattern"),$=n?n.value:"";_n(w,$),ut(w),ri(w,P)};const Br=e.querySelector(".modal-close");Br&&Br.addEventListener("click",Ze);const fs=document.getElementById("modal-sample-file");fs&&fs.addEventListener("change",v=>{var N,T;const w=v.target.files&&v.target.files.length>0?v.target.files[0]:null,P=(N=document.getElementById("modal-pattern-bank"))==null?void 0:N.closest(".form-group"),$=(T=document.getElementById("modal-time-signature-select"))==null?void 0:T.closest(".form-group"),A=document.getElementById("modal-title");if(w){if(P&&(P.style.display="none"),$&&($.style.display="none"),A){const V=w.name.replace(/\.[^/.]+$/,"");A.value=V}}else P&&(P.style.display="block")});const gt=document.getElementById("modal-key-select"),Zt=document.getElementById("modal-scale-select"),L={container:document.getElementById("modal-scale-chord-suggestions"),title:document.getElementById("modal-scale-chord-title"),characteristic:document.getElementById("modal-scale-characteristic"),dropdown:document.getElementById("modal-chord-progression-select")},D=(v,w)=>{try{const P=v.trim(),$=w.map(N=>N);return G1.fromRomanNumerals(P,$).filter(Boolean).map((N,T)=>!N||N===""?w[T]:N)}catch(P){return console.warn("Error converting Roman numerals to chords:",P,"Romans:",w),w.map($=>$.replace(/b/g,"♭").replace(/#/g,"♯"))}},_={ionian:{displayName:"Ionian (Major)",colorTone:"7 (natural)",progressions:{"2-chord":[{label:"I – IV",romans:["I","IV"]},{label:"I – V",romans:["I","V"]},{label:"I – vi",romans:["I","vi"]}],"3-chord":[{label:"I – IV – V",romans:["I","IV","V"]},{label:"I – V – vi",romans:["I","V","vi"]},{label:"I – iii – vi",romans:["I","iii","vi"]}],"4-chord":[{label:"I – IV – V – I",romans:["I","IV","V","I"]},{label:"I – vi – IV – V",romans:["I","vi","IV","V"]},{label:"I – V – vi – IV (pop classic)",romans:["I","V","vi","IV"]}]}},dorian:{displayName:"Dorian",colorTone:"natural 6 in a minor scale",progressions:{"2-chord":[{label:"i – IV",romans:["i","IV"]},{label:"i – ii",romans:["i","ii"]}],"3-chord":[{label:"i – IV – v",romans:["i","IV","v"]},{label:"i – ii – IV",romans:["i","ii","IV"]},{label:"i – IV – VII",romans:["i","IV","VII"]}],"4-chord":[{label:"i – IV – i – v",romans:["i","IV","i","v"]},{label:"i – ii – IV – i",romans:["i","ii","IV","i"]},{label:"i – IV – vii° – i",romans:["i","IV","vii°","i"]}]}},phrygian:{displayName:"Phrygian",colorTone:"♭2 (very dark/tense)",progressions:{"2-chord":[{label:"i – ♭II",romans:["i","bII"]},{label:"i – v",romans:["i","v"]}],"3-chord":[{label:"i – ♭II – i",romans:["i","bII","i"]},{label:"i – v – ♭II",romans:["i","v","bII"]}],"4-chord":[{label:"i – ♭II – vii – i",romans:["i","bII","vii","i"]},{label:"i – v – ♭II – i",romans:["i","v","bII","i"]}]}},lydian:{displayName:"Lydian",colorTone:"♯4 (bright, dreamy, floaty)",progressions:{"2-chord":[{label:"I – II",romans:["I","II"]},{label:"I – Vmaj7",romans:["I","Vmaj7"]}],"3-chord":[{label:"I – II – I",romans:["I","II","I"]},{label:"I – V – II",romans:["I","V","II"]}],"4-chord":[{label:"I – II – V – I",romans:["I","II","V","I"]},{label:"I – vii – II – I",romans:["I","vii","II","I"]}]}},mixolydian:{displayName:"Mixolydian",colorTone:"♭7 (rock-dominant sound)",progressions:{"2-chord":[{label:"I – ♭VII",romans:["I","bVII"]},{label:"I – v",romans:["I","v"]}],"3-chord":[{label:"I – ♭VII – IV",romans:["I","bVII","IV"]},{label:"I – IV – ♭VII",romans:["I","IV","bVII"]}],"4-chord":[{label:"I – ♭VII – IV – I",romans:["I","bVII","IV","I"]},{label:"I – v – ♭VII – IV",romans:["I","v","bVII","IV"]}]}},aeolian:{displayName:"Aeolian (Natural Minor)",colorTone:"♭6",progressions:{"2-chord":[{label:"i – ♭VI",romans:["i","bVI"]},{label:"i – ♭VII",romans:["i","bVII"]}],"3-chord":[{label:"i – ♭VII – ♭VI",romans:["i","bVII","bVI"]},{label:"i – iv – ♭VI",romans:["i","iv","bVI"]}],"4-chord":[{label:"i – ♭VII – ♭VI – v",romans:["i","bVII","bVI","v"]},{label:"i – iv – ♭VII – ♭VI",romans:["i","iv","bVII","bVI"]}]}},locrian:{displayName:"Locrian",colorTone:"♭2, ♭5 (very unstable)",progressions:{"2-chord":[{label:"iø – ♭II",romans:["iø","bII"]},{label:"iø – v",romans:["iø","v"]}],"3-chord":[{label:"iø – ♭II – iø",romans:["iø","bII","iø"]},{label:"iø – v – ♭II",romans:["iø","v","bII"]}],"4-chord":[{label:"iø – ♭II – v – iø",romans:["iø","bII","v","iø"]}]}},"melodic minor":{displayName:"Melodic Minor (Jazz Minor)",colorTone:"i−maj7",progressions:{"2-chord":[{label:"i−maj7 – IV7",romans:["imMaj7","IV7"]}],"3-chord":[{label:"i−maj7 – IV7 – v",romans:["imMaj7","IV7","v"]}],"4-chord":[{label:"i−maj7 – ii – IV7 – i−maj7",romans:["imMaj7","ii","IV7","imMaj7"]}]}},"lydian dominant":{displayName:"Lydian Dominant",colorTone:"♯11",progressions:{"2-chord":[{label:"I7 – II",romans:["I7","II"]}],"3-chord":[{label:"I7 – ♭VII – II",romans:["I7","bVII","II"]}],"4-chord":[{label:"I7 – iiø – ♭VII – I7",romans:["I7","iiø","bVII","I7"]}]}},altered:{displayName:"Altered (Super-Locrian)",colorTone:"V7alt",progressions:{"2-chord":[{label:"V7alt → i",romans:["V7alt","i"]},{label:"V7alt → Imaj7",romans:["V7alt","Imaj7"]}],"3-chord":[{label:"iiø – V7alt – i",romans:["iiø","V7alt","i"]}]}},"harmonic minor":{displayName:"Harmonic Minor",colorTone:"i−maj7",progressions:{"2-chord":[{label:"i – V",romans:["i","V"]}],"3-chord":[{label:"i – iv – V",romans:["i","iv","V"]}],"4-chord":[{label:"i – iv – V – i",romans:["i","iv","V","i"]}]}},"phrygian dominant":{displayName:"Phrygian Dominant",colorTone:"Major chord on ♭II + dominant on V",progressions:{"2-chord":[{label:"i – ♭II",romans:["i","bII"]},{label:"V – i",romans:["V","i"]}],"3-chord":[{label:"V – ♭II – i",romans:["V","bII","i"]}],"4-chord":[{label:"i – ♭II – V – i",romans:["i","bII","V","i"]}]}},"dorian #4":{displayName:"Ukrainian Dorian (Dorian ♯4)",colorTone:"Dorian ♯4",progressions:{"2-chord":[{label:"i – IV",romans:["i","IV"]}],"3-chord":[{label:"i – ♭VII – IV",romans:["i","bVII","IV"]}],"4-chord":[{label:"i – iv – ♭VII – IV",romans:["i","iv","bVII","IV"]}]}},"whole tone":{displayName:"Whole Tone",colorTone:"V7♯5",progressions:{"2-chord":[{label:"V7♯5 – V7♯5",romans:["V7#5","V7#5"]},{label:"V7♯5 – I",romans:["V7#5","I"]}],"3-chord":[{label:"V7♯5 – ♭III+ – V7♯5",romans:["V7#5","bIII+","V7#5"]}]}},"half-whole diminished":{displayName:"Half–Whole Diminished",colorTone:"V7♭9♯11♭13",progressions:{"2-chord":[{label:"V7♭9 – V7♭9",romans:["V7b9","V7b9"]}],"3-chord":[{label:"iiø – V7♭9 – i",romans:["iiø","V7b9","i"]}]}},"whole-half diminished":{displayName:"Whole–Half Diminished",colorTone:"°7",progressions:{"2-chord":[{label:"°7 – °7",romans:["°7","°7"]}],"3-chord":[{label:"°7 – °7 – °7",romans:["°7","°7","°7"]}],"4-chord":[{label:"°7 – ♭III – vi – °7",romans:["°7","bIII","vi","°7"]}]}}},X=v=>!v||typeof v!="string"?"":v.replace(/bb(?=\d)/gi,"♭♭").replace(/b(?=\d)/gi,"♭").replace(/#(?=\d)/g,"♯").split(/\s+/).filter(Boolean).map(P=>P.charAt(0).toUpperCase()+P.slice(1)).join(" "),te=()=>{const v=document.getElementById("modal-scale-notes-display");if(!v)return;const w=gt?(gt.value||"").trim():"",P=Zt?(Zt.value||"").trim():"";if(!P||P==="chromatic"){v.textContent="";return}try{const A={major:"major",minor:"minor",chromatic:"chromatic",harmonicMinor:"harmonic minor",melodicMinor:"melodic minor",dorian:"dorian",phrygian:"phrygian",lydian:"lydian",mixolydian:"mixolydian",locrian:"locrian",blues:"blues",pentatonicMajor:"major pentatonic",pentatonicMinor:"minor pentatonic",ionian:"major",aeolian:"minor","melodic minor":"melodic minor","dorian b2":"dorian b2","lydian augmented":"lydian augmented","lydian dominant":"lydian dominant","mixolydian b6":"mixolydian b6","locrian #2":"locrian #2",altered:"altered","harmonic minor":"harmonic minor","locrian #6":"locrian #6","ionian #5":"ionian #5","dorian #4":"dorian #4","phrygian dominant":"phrygian dominant","lydian #2":"lydian #2",ultralocrian:"ultralocrian","harmonic major":"harmonic major","dorian b5":"dorian b5","phrygian b4":"phrygian b4","lydian b3":"lydian b3","mixolydian b2":"mixolydian b2","lydian augmented #2":"lydian augmented #2","locrian bb7":"locrian bb7","major pentatonic":"major pentatonic","suspended pentatonic":"suspended pentatonic","man gong":"man gong",ritusen:"ritusen","minor pentatonic":"minor pentatonic","blues minor pentatonic":"minor pentatonic","major pentatonic mode 3":"major pentatonic",egyptian:"egyptian","whole tone":"whole tone","half-whole diminished":"dominant diminished","whole-half diminished":"diminished","minor blues":"blues"}[P.toLowerCase()]||P.toLowerCase();let N="C";if(w){const U=w.trim().match(/^([a-gA-G])([#b]?)/);U?N=`${U[1].toUpperCase()}${U[2]||""}`:N=w.trim()}const T=`${N} ${A}`,R=Ki.get(T);if(!R||!R.notes||R.notes.length===0){v.textContent="";return}const J=R.notes.map((U,Pe)=>`${U.replace(/-?\d+$/,"")} = ${Pe}`),Z=`<strong>${N.toLowerCase()}:${A}</strong> ${J.join(", ")}`;v.innerHTML=Z}catch($){console.warn("Error displaying scale notes:",$),v.textContent=""}},q=()=>{if(!L.container||!L.dropdown)return;const v=gt?(gt.value||"").trim():"",w=Zt?(Zt.value||"").trim():"";if(L.dropdown.innerHTML='<option value="">Select a progression...</option>',!v||!w){L.container.style.display="none",L.container.dataset.state="idle",L.title&&(L.title.textContent="Select a key and scale to view chord progressions."),L.characteristic&&(L.characteristic.textContent="");return}const P=w.toLowerCase(),$=_[P],A=($==null?void 0:$.displayName)||X(w);if(L.container.style.display="block",L.title&&(L.title.textContent=`${v} ${A} Chord Progressions`),!$||!$.progressions){L.container.dataset.state="placeholder",L.characteristic&&(L.characteristic.textContent="No chord progressions available for this scale yet.");return}L.container.dataset.state="ready",L.characteristic&&(L.characteristic.textContent=`Color tone: ${$.colorTone||"N/A"}`),["2-chord","3-chord","4-chord"].forEach(T=>{const R=$.progressions[T];if(R&&R.length>0){const V=document.createElement("optgroup");V.label=T.charAt(0).toUpperCase()+T.slice(1).replace("-"," "),R.forEach(J=>{const Z=document.createElement("option"),U=D(v,J.romans),Pe=U.length>0?`${J.label} (${U.join(" – ")})`:J.label;Z.value=JSON.stringify({romans:J.romans,label:J.label}),Z.textContent=Pe,V.appendChild(Z)}),L.dropdown.appendChild(V)}})};q(),te(),L.dropdown&&L.dropdown.addEventListener("change",v=>{const w=v.target.value;if(!(!w||w===""))try{const P=JSON.parse(w),$=gt?(gt.value||"").trim():"";if(!$){console.warn("No key selected for chord progression");return}const A=D($,P.romans);if(A.length>0){let T=Ae("modal-pattern")||"";T=T.replace(/\bn\s*\([^)]*\)\s*\.\s*scale\s*\([^)]*\)(?:\s*\.\s*[a-zA-Z]+\s*\([^)]*\))*/gi,""),T=T.replace(/\bn\s*\(["'][^"']*["']\)\s*\.\s*scale\s*\(["'][^"']*["']\)(?:\s*\.\s*[a-zA-Z]+\s*\([^)]*\))*/gi,""),T=T.replace(/^\s*\.\s*/,"").replace(/\s*\.\s*$/,"").trim();const V=`n().chord("<${A.join(" ")}>").voicing()`;Fe("modal-pattern",V)}}catch(P){console.warn("Error parsing chord progression data:",P)}});const me=v=>{if(typeof v!="string")return!1;let w=0,P=!1,$="";for(let A=0;A<v.length;A++){const N=v[A];if(P){if(N==="\\"){A++;continue}N===$&&(P=!1,$="");continue}if(N==='"'||N==="'"){P=!0,$=N;continue}if(N==="("&&w++,N===")"&&w--,w<0)return!1}return!P&&w===0},Xe=(v,w,P=!1)=>{if(!v||!v.trim())return v;let $=v.trim();if(P){const A=/\.\s*bank\s*\(\s*["'][^"']*["']\s*\)/gi;A.test($)?$=$.replace(A,`.bank("${w}")`):$=`${$}.bank("${w}")`}else{const A=/\.\s*(s|sound)\s*\(\s*["'][^"']*["']\s*\)/gi;A.test($)?$=$.replace(A,`.s("${w}")`):$=`${$}.s("${w}")`}return $},an=v=>{if(!v||!v.trim())return"";const w=v.trim();if(/(\.\s*(bank|s|sound)\s*\()|(\b(note|n|stack|sound)\s*\()/i.test(w))return w;const $=vM(w);return $?$.trim():""},MO=(v,w,P,$)=>{let N=(v||"").trim();const T=/\.\s*(s|sound|scale)\s*\(/i.test(N);N?(!N.startsWith("(")||!N.endsWith(")"))&&(T||(N=`(${N})`)):N="(silence)";const R=N.match(/\.\s*scale\s*\(\s*['"]([^'"]+)['"]\s*\)/i),V=R?R[1]:null,J=N.match(/\.\s*(s|sound)\s*\(\s*["']([^"']+)["']\s*\)/i),Z=J?J[2]:null;let U=N.replace(/\.\s*scale\s*\([^)]*\)/gi,"").replace(/\.\s*(s|sound)\s*\([^)]*\)/gi,"");if(P&&P.trim()!==""||w&&w.trim()!==""){const be=w&&w.trim()!==""?w.trim().toLowerCase():"c",ve=P&&P.trim()!==""?P.trim():"major";U=`${U}.scale('${be}:${ve}')`}else V&&(U=`${U}.scale('${V}')`);return Z&&(U=`${U}.s("${Z}")`),U},ka=(v=!1)=>{q(),te();const w=Ae("modal-pattern"),P=gt&&gt.value||null,$=Zt&&Zt.value||null;if(console.log(`🎼 applyKeyScaleToPattern called: keyValue="${P}", scaleValue="${$}"`),!P&&!$){console.log("⚠️ No key/scale selected, skipping");return}const A=document.getElementById("modal-keep-notes-as-written"),N=v||A&&A.checked,T=P&&P.trim()!==""?P:null,R=$&&$.trim()!==""?$:null;if(!w||w.trim()===""||!Kt(w)){let le=null;if(w&&w.trim()!==""){const G=w.match(/\.\s*(s|sound)\s*\(\s*["']([^"']+)["']\s*\)/i);G&&G[2]&&(le=G[2])}if(!le){const G=document.getElementById("modal-pattern-bank");G&&G.value&&(le=G.value.toLowerCase())}let H="";if(N){if(typeof this.getAllScaleNotesAsNoteNames=="function"&&(H=this.getAllScaleNotesAsNoteNames(P||"C",$||"chromatic")||""),!H){const G=this.getAllScaleNotesAsPattern(P||"C",$||"chromatic");G&&(H=this.convertNumericPatternToNoteNames(G,P||"C",$||"chromatic"))}}else{const G=this.getAllScaleNotesAsPattern(P||"C",$||"chromatic");if(G){const ge=G.match(/(?:note|n)\s*\(\s*["']([^"']+)["']\s*\)/),ye=ge?ge[1]:"0 1 2 3 4 5",Le=`${(P||"C").toLowerCase()}:${$||"chromatic"}`;H=`n("${ye}").scale('${Le}')`}}if(!H){console.warn("⚠️ Could not generate scale notes for empty/non-note pattern");return}le&&(H=`${H}.s("${le}")`),me(H)?(Fe("modal-pattern",H),console.log(`🎼 Inserted scale notes for empty/non-note pattern: ${H}`)):console.warn("⚠️ Generated scale-notes pattern failed quick syntax check; not applying");return}const V=/\b(note|n)\s*\(/.test(w),J=/\b(note|n)\s*\(\s*["'][a-g][#b]?/.test(w),Z=/\b(note|n)\s*\(\s*["'][a-g][#b]?[a-z0-9]*\s*[a-z]/.test(w)||/\b(note|n)\s*\(\s*["'][^"']*\b(maj|min|m|dim|aug|sus|add|7|9|11|13)\b/i.test(w),U=/\.\s*chord\s*\(/i.test(w),Pe=/\b(note|n)\s*\(\s*["'][^"']*[a-g][#b]?\s/.test(w),be=J||Z||Pe||U,ve=V&&!be&&!U;if(be&&!ve){console.log("ℹ️ Pattern uses explicit note names – skipping key/scale rewrite");return}if(V&&kn(w)&&!be&&!U){const le=di(T,R);if(!le){console.log("ℹ️ Numeric pattern: no scale selected, skipping rewrite");return}let H=w.replace(/\.\s*scale\s*\((['"])(?:(?=(\\?))\2.)*?\1\)/gi,"");H=H.replace(/\.\s*scale\s*\([^)]*\)/gi,""),H=H.replace(/\.+/g,".").replace(/\.\s*\./g,".").trim(),H=H.replace(/\.+$/,"").trim(),H=zr(H,le),Fe("modal-pattern",H),ms(H,!0),console.log(`ℹ️ Numeric pattern updated with scale modifier ${le}`);return}if(N&&J&&!U){const le=C.convertNoteNamesToSemitones(w),H=T||"C",G=R||"chromatic";let ge=le?this.convertNumericPatternToNoteNames(le,H,G):null;if((!ge||ge===w)&&(ge=this.convertNumericPatternToNoteNames(w,H,G)),ge&&ge!==w){const ye=di(T,R);ye&&(oi=ye),ln=!0,ms(ge,!0),Fe("modal-pattern",ge),T&&(C.currentKey=T),R&&(C.currentScale=R);const Le=document.getElementById("modal-pattern");if(Le){try{Le.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}try{Le.dispatchEvent(new Event("change",{bubbles:!0}))}catch{}}console.log(`🎼 Converted note names to new key/scale: ${ge.substring(0,120)}...`);return}else console.log(`⚠️ Note names unchanged after conversion attempt (key=${H}, scale=${G})`)}if(!U&&ve){console.log(`🎼 applyKeyScaleToPattern: keyValue="${P}", scaleValue="${$}", pattern="${w.substring(0,50)}..."`);let le=w;if(R&&(T||R))if(N){const G=/\b(note|n)\s*\(\s*["'][a-gA-G][#b]?\d/.test(w);if(/\b(n|note)\s*\(\s*["'][\d\s]+["']/.test(w)&&!G)le=this.convertNumericPatternToNoteNames(w,T,R),console.log(`🎼 Converted numeric pattern to note names in ${R}: ${le.substring(0,100)}...`);else if(G){const ye=C.convertNoteNamesToSemitones(w);ye&&ye!==w?(le=this.convertNumericPatternToNoteNames(ye,T,R),console.log(`🎼 Converted note names to ${R} scale: ${le.substring(0,100)}...`)):le=this.convertNumericPatternToNoteNames(w,T,R)}try{const ye=this.getAllScaleNotesAsPattern(T||"C",R||"chromatic");if(ye){const Ee=this.convertNumericPatternToNoteNames(ye,T||"C",R||"chromatic").match(/\b(note|n)\s*\(\s*["']([^"']+)["']\s*\)/i),xe=le.match(/\b(note|n)\s*\(\s*["']([^"']+)["']\s*\)/i);if(Ee&&xe){const He=Ee[2];le=le.replace(/\b(note|n)\s*\(\s*["'][^"']+["']\s*\)/i,(ue,rt)=>`${rt}("${He}")`),console.log(`🎼 Resized note names to match scale: ${He}`)}}}catch{}}else{const G=MO(w,T,R);if(me(G)){le=G;const ge=le.match(/\b(n|note)\s*\(\s*["']([^"']+)["']\s*\)/i);if(ge&&ge[2]){const ye=ge[2].trim().split(/\s+/).map(Ee=>parseInt(Ee,10)).filter(Ee=>!isNaN(Ee)),Le=this.getAllScaleNotesAsPattern(T||"C",R||"chromatic");if(Le){const Ee=Le.match(/\b(n|note)\s*\(\s*["']([^"']+)["']\s*\)/i),xe=Ee?Ee[2]:null;if(xe){const He=xe.trim().split(/\s+/).length;ye.length!==He&&(le=le.replace(/\b(n|note)\s*\(\s*["'][^"']+["']\s*\)/i,(ue,rt)=>`${rt}("${xe}")`),console.log(`🎼 Resized numeric degrees to match scale (${He} steps): ${xe}`))}}}}else le=w;console.log(`🎼 Semitone mode: upserted scale=${R} key=${T}`)}let H=le;if(console.log(`🎼 applyKeyScaleToPattern: result="${H?H.substring(0,80):"null"}..."`),console.log(`🎼 Pattern comparison - original length: ${w.length}, new length: ${H?H.length:0}, same: ${H===w}`),!N&&H&&kn(H)){const G=xa(H,T,R);G&&G!==H&&(H=G,console.log(`🎼 Normalized numeric pattern to scale degrees (${R||"chromatic"})`))}if(!N&&H&&(T||R))try{const G=this.getAllScaleNotesAsPattern(T||"C",R||"chromatic"),ge=G&&G.match(/\b(n|note)\s*\(\s*["']([^"']+)["']\s*\)/i),ye=ge?ge[2]:null,Le=H.match(/\b(n|note)\s*\(\s*["']([^"']+)["']\s*\)/i);if(ye&&Le&&Le[2]){const ue=Le[2].trim().split(/\s+/);ue.every(oe=>/^-?\d+$/.test(oe))&&ue.every((oe,Ke)=>parseInt(oe,10)===Ke)&&(H=H.replace(/\b(n|note)\s*\(\s*["'][^"']+["']\s*\)/i,(oe,Ke)=>`${Ke}("${ye}")`),console.log(`🎼 Resized numeric degrees to match scale (${R||"chromatic"}): ${ye}`))}const Ee=T||"C",xe=R||"chromatic",He=this.convertNumericPatternToNoteNames(H,Ee,xe);if(He){const ue=C.convertNoteNamesToScaleDegrees(He,Ee,xe);ue&&me(ue)&&(H=ue,console.log(`🎼 Normalized numeric degrees to scale length (${xe})`))}}catch(G){console.warn("⚠️ Degree resize failed:",G)}if(N&&(T||R)){const G=di(T||null,R||null);G&&(oi=G)}if(H){!N&&kn(H)&&(H=xa(H,T,R),ai=H),ln=!1,ms(H,!0),Fe("modal-pattern",H),T&&(C.currentKey=T),R&&(C.currentScale=R);const G=document.getElementById("modal-pattern");if(G){try{G.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}try{G.dispatchEvent(new Event("change",{bubbles:!0}))}catch{}}console.log(`✅ Applied key/scale to pattern immediately: ${H.substring(0,100)}...`)}else console.log("⚠️ Pattern unchanged - applyGlobalSettingsToPattern returned null or undefined")}else if(!U&&be&&!N){const le=Dr(w);let H=T||null,G=R||null;le&&(H=H||le.key||null,G=G||le.scale||null);const ge=H||"C",ye=G||"chromatic",Le=C.convertNoteNamesToScaleDegrees(w,ge,ye),xe=(xa(Le||w,T,R)||w).replace(/\.\s*scale\s*\([^)]*\)/gi,""),He=zr(xe,di(T,R));if(me(He)){Fe("modal-pattern",He),T&&(C.currentKey=T),R&&(C.currentScale=R);const ue=document.getElementById("modal-pattern");if(ue){try{ue.dispatchEvent(new Event("input",{bubbles:!0}))}catch{}try{ue.dispatchEvent(new Event("change",{bubbles:!0}))}catch{}}console.log(`✅ Converted note names to semitone degrees for scale: ${He.substring(0,120)}...`)}else console.log("⚠️ Conversion to semitones or upsert failed validation; leaving pattern unchanged")}else console.log(`⚠️ Cannot apply scale - hasChordModifier: ${U}, isNumericPattern: ${ve}, hasNoteFunction: ${V}, hasExplicitNotes: ${be}`)};gt&&!gt.dataset.listenerAttached&&(gt.addEventListener("change",()=>{te(),ka(!1)}),gt.dataset.listenerAttached="true"),Zt&&!Zt.dataset.listenerAttached&&(Zt.addEventListener("change",()=>{te(),ka(!1)}),Zt.dataset.listenerAttached="true"),te();const Dr=v=>{const w=v.match(/\.\s*scale\s*\(\s*['"]([^'"]+)['"]\s*\)/i);if(w&&w[1]){const P=w[1];if(P.includes(":")){const[$,A]=P.split(":");return{key:$.trim(),scale:A.trim()}}else return{key:"C",scale:P.trim()}}return null};let oi=null,Ts=null,ln=!1,ai=null,Li=null,li=null,ci=null;const di=(v,w)=>{const P=v&&v.trim()!=="",$=w&&w.trim()!=="";if(!P&&!$)return null;const A=P?v.trim().toLowerCase():"c",N=$?w.trim():"major";return`.scale('${A}:${N}')`},CO=v=>{if(!v||typeof v!="string")return null;const w=v.match(/\bnote\s*\(\s*["']([^"']+)["']/i);if(!w||!w[1])return null;const $=w[1].match(/([a-gA-G])([#b]?)/);if(!$)return null;const A=$[1].toUpperCase(),N=$[2]?$[2]:"";return`${A}${N}`},ms=(v,w=!1)=>{if(!v||!Kt(v)){Ts=null,ln=!1;return}if(ln&&!w)return;if(kn(v)){Ts=v;return}const P=C.convertNoteNamesToSemitones(v);P&&kn(P)&&(Ts=P)},zr=(v,w)=>{if(!v||!w||/\.\s*scale\s*\(/i.test(v))return v;const P=v.search(/\.(s|sound)\s*\(/i);if(P!==-1){const A=v.slice(0,P),N=v.slice(P);return`${A}${w}${N}`}const $=v.trim();return $.startsWith("(")&&$.endsWith(")")?`${v}${w}`:`(${v})${w}`},xa=(v,w,P)=>{if(!v||!kn(v))return v;const $=!w||!w.trim()||!P||!P.trim()?Dr(v):null,A=w&&w.trim()||($==null?void 0:$.key)||"C",N=P&&P.trim()||($==null?void 0:$.scale)||"chromatic",T=this.convertNumericPatternToNoteNames(v,A,N);if(!T)return v;const R=C.convertNoteNamesToScaleDegrees(T,A,N);if(R&&kn(R)){const V=C.getScaleSemitoneSteps(A,N);if(!V||V.length===0)return R;const J=V.length;return(U=>{const Pe=/\b(n|note)\s*\(\s*(["'])([\s\S]*?)\2\s*\)/gi;return U.replace(Pe,(be,ve,le,H)=>{const G=H.trim().split(/\s+/);if(G.length<=J)return be;const ge=G.map(Ee=>{const xe=parseInt(Ee,10);return Number.isFinite(xe)?xe:null});if(ge.some(Ee=>Ee===null)||!ge.every((Ee,xe)=>Ee===xe))return be;const Le=Array.from({length:J},(Ee,xe)=>String(xe)).join(" ");return`${ve}(${le}${Le}${le})`})})(R)}return v},EO=(v,w,P=!1)=>{if(!v||!Kt(v))return v;const $=C.patternHasNoteNames&&C.patternHasNoteNames(v)||/\b(note|n)\s*\(\s*["'][^"']*[a-gA-G][#b]?\d/i.test(v),A=C.patternHasNumericNotePattern&&C.patternHasNumericNotePattern(v)||/\b(note|n)\s*\(\s*["'][\d\s\-~<>[\]]+["']/i.test(v)&&!$;if(w){if(A&&!$){ln||(Ts=v),ln=!0;const N=Dr(v),T=document.getElementById("modal-key-select"),R=document.getElementById("modal-scale-select");let V=T&&T.value||null,J=R&&R.value||null;return N&&(V=N.key,J=N.scale,console.log(`🎼 Using scale from pattern .scale() modifier: ${V}:${J}`)),V||J?t.convertNumericPatternToNoteNames(v,V,J||"major"):(console.log("⚠️ No key/scale selected, using C major for conversion"),t.convertNumericPatternToNoteNames(v,"C","major"))}return v}else{if($&&!A){if(ln=!1,Ts&&kn(Ts))return console.log("🔁 Restoring semitone snapshot for note-name toggle"),Ts;const N=Dr(v);let T=null,R=null;if(N)T=N.key,R=N.scale;else{const J=CO(v);if(J)T=J,R="chromatic";else{const Z=document.getElementById("modal-key-select"),U=document.getElementById("modal-scale-select");T=Z&&Z.value||"C",R=U&&U.value||"chromatic"}}let V=C.convertNoteNamesToScaleDegrees(v,T||"C",R||"chromatic");if(V&&V!==v){const J=di(T||"C",R||"chromatic");return J&&(V=zr(V,J)),console.log(`🔄 Converted note names to scale degrees: ${V.substring(0,80)}...`),ms(V,!0),ai=V,V}return v}return v}},Bi=document.getElementById("modal-keep-notes-as-written");Bi&&!Bi.dataset.listenerAttached&&(Bi.addEventListener("change",()=>{const v=Ae("modal-pattern"),w=Bi.checked;let P;w&&li&&ci&&v===ci?(P=li,console.log("🔁 Restoring original note-name pattern from snapshot")):!w&&Li&&v===Li&&ai?(P=ai,console.log("🔁 Restoring canonical numeric pattern from snapshot")):P=EO(v,w,!0);const $=document.getElementById("modal-key-select"),A=document.getElementById("modal-scale-select");if(w?ln=!0:ln=!1,w&&P){const N=/\.\s*scale\s*\((['"])(?:(?=(\\?))\2.)*?\1\)/gi,T=P.match(N);if(T&&T.length>0)oi=T[T.length-1];else{const R=di($==null?void 0:$.value,A==null?void 0:A.value);R&&(oi=R)}P=P.replace(N,""),P=P.replace(/\.\s*scale\s*\([^)]*\)/gi,""),P=P.replace(/\.+/g,".").replace(/\.\s*\./g,".").trim(),P=P.replace(/\.+$/,"").trim(),console.log("🗑️ Removed .scale() modifier when switching to note names")}else!w&&P&&oi&&(P=zr(P,oi));P!==v?(Fe("modal-pattern",P),w?(ai=v,Li=P,ln=!0,li=null,ci=null):(Li=null,ln=!1,v&&Kt(v)?(li=v,ci=P):(li=null,ci=null),ms(P,!0)),console.log(`🔄 Converted pattern ${w?"to note names":"to semitones"}: ${P.substring(0,100)}...`)):w||(Li=null,ln=!1,li=null,ci=null,ms(v,!0)),Vr()}),Bi.dataset.listenerAttached="true");const Vr=()=>{const v=document.getElementById("modal-key-scale-group");if(!v)return;document.getElementById("modal-keep-notes-as-written");const w=Ae("modal-pattern"),P=w&&Kt(w);v.style.display=P?"block":"none"};ms(Ae("modal-pattern"),!0);const AO=v=>v.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),TO=(v,w)=>{if(!v||!w)return v;let P=v.trim();const $=(N,T,R)=>{if(!R)return N;const V=new RegExp(`\\s*\\.\\s*${T}\\s*\\(\\s*${AO(R)}\\s*\\)\\s*$`,"i");let J=N;for(;V.test(J);)J=J.replace(V,"").trim();return J};return typeof w.gain=="number"&&Math.abs(w.gain-1)>1e-6&&(P=$(P,"gain",w.gain.toFixed(2))),typeof w.pan=="number"&&Math.abs(w.pan)>1e-6&&(P=$(P,"pan",w.pan.toFixed(2))),P=(N=>{let T=N;for(;T.startsWith("(")&&T.endsWith(")");){let R=0,V=!0;for(let J=0;J<T.length;J++){const Z=T[J];if(Z==="("?R++:Z===")"&&R--,R===0&&J<T.length-1){V=!1;break}}if(V&&R===0)T=T.slice(1,-1).trim();else break}return T})(P.trim()),P};this.syncElementsFromMasterPattern=v=>{var w,P;if(!v||typeof v!="string"){console.warn("⚠️ Cannot sync elements - master pattern missing or invalid");return}try{const $=/^\/\/\s*Controls Selected Tempo:[^\n]*\n?/im;let A=v.replace($,"").trim();if(!A){console.warn("⚠️ Master pattern empty after sanitizing, skipping element sync");return}let N=A;const T=A.indexOf("stack(");if(T!==-1){const Z=A.indexOf("(",T);if(Z!==-1){let U=1,Pe=Z+1,be=!1,ve=null;for(;Pe<A.length&&U>0;){const le=A[Pe],H=A[Pe-1];if(be)le===ve&&H!=="\\"&&(be=!1,ve=null);else if(le==='"'||le==="'")be=!0,ve=le;else if(le==="(")U++;else if(le===")"&&(U--,U===0)){N=A.slice(Z+1,Pe);break}Pe++}}}const R=/\s*\/\*\s*Channel\s+(\d+)\s*\*\/([\s\S]*?)(?=(\s*\/\*\s*Channel\s+\d+\s*\*\/)|$)/g;let V;const J=[];for(;(V=R.exec(N))!==null;){const Z=parseInt(V[1],10);if(!Number.isFinite(Z)||Z<1)continue;let U=V[2].trim();if(!U||(U=U.replace(/^,+/,"").replace(/,+$/,"").trim(),!U))continue;const Pe=((w=V[0])==null?void 0:w.trim())||U,be=`element-${Z}`,ve=(P=C.trackedPatterns)==null?void 0:P.get(be),H=TO(U,ve)||U,ge={...this.loadElementConfig(be)||{},pattern:H};if(this.saveElementConfig(be,ge,!0),C.trackedPatterns){const ye=(ve==null?void 0:ve.gain)??(typeof C.getElementGain=="function"?C.getElementGain(be):.8),Le=(ve==null?void 0:ve.pan)??(typeof C.getElementPan=="function"?C.getElementPan(be):0),Ee=(ve==null?void 0:ve.muted)??!1,xe=(ve==null?void 0:ve.soloed)??!1;C.trackedPatterns.set(be,{rawPattern:Pe,pattern:H,gain:ye,pan:Le,muted:Ee,soloed:xe})}if(this.currentEditingElementId===be){const ye=Ae("modal-pattern");if((ye==null?void 0:ye.trim())!==U.trim()&&(Fe("modal-pattern",U),console.log(`📝 Updated modal editor for ${be} to match master pattern`)),p.active&&n&&kt(n.value)){console.log("🔁 Refreshing drum grid to match updated pattern"),p.updatingFromPattern=!0;const Ee=document.getElementById("modal-time-signature-select"),xe=(Ee==null?void 0:Ee.value)||this.currentTimeSignature||"4/4",He=xn(xe);si(U,He),p.updatingFromPattern=!1}}J.push(be)}J.length>0?console.log(`🔄 Synced master pattern changes to elements: ${J.join(", ")}`):console.warn("ℹ️ No channel definitions found while syncing master pattern")}catch($){console.warn("⚠️ Failed to sync master pattern to elements:",$)}},setTimeout(()=>{const v=Ae("modal-pattern"),w=gt&&gt.value||null,P=Zt&&Zt.value||null;v&&Kt(v)&&(w||P)&&(console.log(`🎼 Applying initial key/scale on modal open: key="${w}", scale="${P}"`),ka())},200),n&&!n.dataset.listenerAttached&&n.addEventListener("change",async v=>{var ue,rt,Ye;const w=v.target.value,P=cl(w),$=P.bankValue;console.log("📦 Bank select changed to:",w),n.value!==w&&(n.value=w);const A=this.currentEditingElementId,N=(oe={},Ke=!0)=>{if(!A)return;const ht={...this.loadElementConfig(A)||{},...oe};P.isVcslInstrument?ht.vcslInstrument=P.vcslInstrument:"vcslInstrument"in ht&&delete ht.vcslInstrument,this.saveElementConfig(A,ht,Ke)};if($&&$!==""){fs&&(fs.value="");const oe=(ue=document.getElementById("modal-pattern-bank"))==null?void 0:ue.closest(".form-group");oe&&(oe.style.display="block"),Vr(),this.selectedTagKey="bank",typeof this.refreshSnippetButtons=="function"&&setTimeout(()=>{this.refreshSnippetButtons().catch(Ke=>console.warn("⚠️ Unable to refresh snippet tags:",Ke))},100)}else Vr(),this.selectedTagKey=null,typeof this.refreshSnippetButtons=="function"&&setTimeout(()=>{this.refreshSnippetButtons().catch(oe=>console.warn("⚠️ Unable to refresh snippet tags:",oe))},100);if(!A){console.warn("⚠️ No elementId when bank changed");return}const T=document.getElementById("status-text"),R=document.getElementById("modal-pattern"),V=!!(C!=null&&C.masterActive),J=Ae("modal-pattern");$&&$!==""&&(!J||J.trim()==="")&&R&&(R.placeholder='Drums and Percussion: s("bd sd rim cp hh oh cr rd ht mt lt sh cb tb perc misc fx"), Synths: note("c3 d3 [e3 f3]")');const Z=(rt=document.getElementById("modal-sample-url"))==null?void 0:rt.closest(".form-group"),U=(Ye=document.getElementById("modal-sample-file"))==null?void 0:Ye.closest(".form-group"),Pe=document.getElementById("modal-sample-name-group"),be=$&&$!=="";if(Z&&(Z.style.display=be?"none":"block"),U&&(U.style.display=be?"none":"block"),Pe&&(Pe.style.display=be?"none":"block"),!$||$===""){console.log("📦 Using Default (no bank)"),R.placeholder="",T&&(T.textContent="📦 Using Default samples");const oe=document.getElementById("modal-title");oe.value="Default";const Ke=document.getElementById("modal-element-id");Ke&&(Ke.textContent=Is(A)),On(A,"Default"),N({title:"Default",bank:void 0},!1),console.log(`📝 Saved title "Default" for ${A}`);let ps=Ae("modal-pattern").trim(),ht=an(ps);ht&&ht.trim()!==""?(ht=ht.replace(/\.\s*bank\s*\(\s*["'][^"']*["']\s*\)/gi,""),ht=ht.replace(/\.+/g,".").replace(/\.\s*\./g,".").trim(),ht=ht.replace(/\.+$/,"").trim(),Fe("modal-pattern",ht),R.placeholder="",console.log(`📝 Removed .bank() modifier only, preserving pattern: ${ht.substring(0,80)}...`)):R.placeholder=""}else{const oe=(Qt,Rt)=>{if(!Qt||Qt.trim()==="")return Rt;let Be=Qt.trim();return!Be.endsWith(".")&&!Rt.startsWith(".")&&(Be+="."),Be+=Rt,Be.replace(/\.\.+/g,".").replace(/\.\s+\./g,".").trim()};if(P.isVcslInstrument){const Qt=P.vcslInstrument,Rt=PO(Qt),Be=document.getElementById("modal-title");T&&(T.textContent=`🎙️ VCSL Instrument: ${Rt}`),Be&&(Be.value=Rt);const fe=document.getElementById("modal-element-id");fe&&(fe.textContent=Is(A)),On(A,Rt),N({title:Rt,bank:"vcsl"},!0);let at=Ae("modal-pattern").trim(),Oe=an(at);const Re=/sound\s*\(\s*["'][^"']*["']\s*\)/i,Te=Oe&&Oe.trim()!==""?Oe:"";Te?Re.test(Te)?Oe=Te.replace(Re,`sound("${Qt}")`):Te.includes(".s(")?Oe=Te.replace(/\.s\s*\(\s*["'][^"']*["']\s*\)/i,`.sound("${Qt}")`):Oe=oe(Te,`sound("${Qt}")`):Oe=`sound("${Qt}")`,Oe=Xe(Oe,"vcsl",!0),Fe("modal-pattern",Oe),R.placeholder="",setTimeout(()=>{je()},50);return}const Ke=co($);if([...ir,...mi].includes(Ke)||kO.includes($)){const Qt=document.getElementById("modal-title"),Rt={piano:"Piano",supersaw:"Saw Synth",gtr:"Guitar",casio:"Casio",wood:"Jazz",jazz:"Jazz",metal:"Metal",folkharp:"Folk Harp",superpiano:"Piano"},Be=Rt[Ke]||Rt[$]||Ke.charAt(0).toUpperCase()+Ke.slice(1);console.log(`🎹 Using synth sound: ${Ke}`),T&&(T.textContent=`🎹 Using ${Be}`),Qt.value=Be;const fe=document.getElementById("modal-element-id");fe&&(fe.textContent=Is(A)),On(A,Be),N({title:Be,bank:$}),console.log(`📝 Saved title "${Be}" for ${A}`);let at=Ae("modal-pattern").trim(),Oe=an(at);Oe&&Oe.trim()!==""?(console.log(`🎹 BANK CHANGE: Updating .s() modifier only, preserving pattern: ${Oe.substring(0,80)}...`),Oe=Xe(Oe,Ke,!1),console.log(`🎹 BANK CHANGE: Updated pattern: ${Oe.substring(0,80)}...`)):(Oe=`note("c3").s("${Ke}")`,console.log(`🎹 BANK CHANGE: Created minimal pattern with .s("${Ke}")`)),Fe("modal-pattern",Oe),R.placeholder="";const Re=document.getElementById("modal-keep-notes-as-written");Re&&(Re.checked=!0,console.log("🎹 Set note names toggle to ON for synth/waveform")),setTimeout(()=>{je()},50);const Te=Ae("modal-pattern");console.log(`🎹 BANK CHANGE: Verified textarea contains: ${Te}`)}else{console.log(`📦 Loading bank: ${$}`),T&&(T.textContent=`📦 Loading bank: ${$}...`);const Qt=["RolandTR808","RolandTR909","RolandTR707","RhythmAce","AkaiLinn","ViscoSpaceDrum","CasioRZ1"],Rt=[...ir,...mi,"insect","wind","east","crow","space","numbers","superpiano","jazz"],Be=($==null?void 0:$.toLowerCase())||"",fe=q$.has(Be),at=Qt.includes($)||Rt.includes(Be);let Oe=!1;if(fe)try{Oe=await C.loadBank(Be),Oe?(console.log(`✅ Specialty sample bank loaded: ${Be}`),T&&(T.textContent=`✅ Bank loaded: ${Be}`)):(console.log(`⚠️ Specialty sample bank "${Be}" may not be fully loaded`),T&&(T.textContent=`⚠️ Bank "${Be}" may not be available`))}catch(Re){console.error(`Error loading specialty bank ${Be}:`,Re),Oe=!1,T&&(T.textContent=`⚠️ Error loading bank: ${Be}`)}else if(at)Oe=!0,console.log(`✅ Built-in bank/waveform: ${$} (no loading required)`),T&&(T.textContent=`✅ Built-in: ${$}`);else try{Oe=await C.loadBank($),Oe?(console.log(`✅ Bank loaded: ${$}`),T&&(T.textContent=`✅ Bank loaded: ${$}`)):(console.log(`⚠️ Bank "${$}" may not be fully loaded, but continuing...`),T&&(T.textContent=`⚠️ Bank "${$}" may not be available`))}catch(Re){console.error(`Error loading bank ${$}:`,Re),Oe=!1,T&&(T.textContent=`⚠️ Error loading bank: ${$}`)}try{const Re=document.getElementById("modal-title");let Te;const jt=Lc.find(De=>De.value===Be);$.startsWith("github:")?Te=$.replace("github:tidalcycles/",""):hi.has($)?Te=oo($):jt?Te=jt.label:Te=$,Re.value=Te;const Je=document.getElementById("modal-element-id");if(Je&&(Je.textContent=Is(A)),On(A,Te),this.activeElements.has(A)){console.log(`🛑 Stopping sound for ${A} (bank selected, not auto-playing)`),C.stopSound(A),this.activeElements.delete(A);const De=document.querySelector(`[data-sound-id="${A}"]`);if(De){const $t=De.querySelector(".element-circle");$t&&$t.classList.remove("playing"),this.updateStatusDots(A,!0,!1)}}const Ft=this.loadElementConfig(A)||{};try{const De={...Ft,title:Te,bank:$};localStorage.setItem(`elementConfig_${A}`,JSON.stringify(De)),console.log(`📝 Saved title "${Te}" and bank "${$}" for ${A} (NOT saved to master)`)}catch(De){console.warn("⚠️ Could not save config:",De)}let lt=Ae("modal-pattern").trim();console.log(`📝 Bank change: currentPattern="${lt.substring(0,100)}..."`);let we=an(lt);console.log(`📝 Bank change: normalizedPattern="${we.substring(0,100)}..."`);const Ne=hi.has($),In=ir.includes(Be)||mi.includes(Be)||["sawtooth","square","triangle","sine"].includes(Be);if(console.log(`📝 Bank change: isDrumBank=${Ne}, isSynthOrWaveform=${In}, isSpecialSampleBank=${fe}, bankValue="${$}"`),Ne||fe){const De=fe?Be:$;if(we&&we.trim()!==""){const $t=we;we=Xe(we,De,!0),console.log(`📝 Updated .bank("${De}") modifier`),console.log(`   Before: ${$t.substring(0,80)}...`),console.log(`   After: ${we.substring(0,80)}...`)}else fe?we=`${De==="mridangam"?'sound("tha dhi thom nam")':'sound("ahh ~ ohh")'}.bank("${De}")`:we=`s("bd").bank("${De}")`,console.log(`📝 Created minimal pattern with .bank("${De}")`);Fe("modal-pattern",we),R.placeholder=""}else if(In){const De=co($);if(we&&we.trim()!==""){const ui=we;we=Xe(we,De,!1),console.log(`📝 Updated .s("${De}") modifier`),console.log(`   Before: ${ui.substring(0,80)}...`),console.log(`   After: ${we.substring(0,80)}...`)}else we=`note("c3").s("${De}")`,console.log(`📝 Created minimal pattern with .s("${De}")`);Fe("modal-pattern",we),R.placeholder="";const $t=document.getElementById("modal-keep-notes-as-written");$t&&($t.checked=!0,console.log("📝 Set note names toggle to ON for synth/waveform"))}else R.placeholder='Add a pattern, e.g., sound("bd").bank("CustomBank")';console.log(`📝 Final pattern in editor: ${Ae("modal-pattern").substring(0,100)}...`),setTimeout(()=>{je()},50)}catch(Re){console.error("Error loading bank:",Re)}}}const ve=document.getElementById("modal-title"),le=ve?ve.value.trim():"",H=R?R.value.trim():"";let G;H&&H.includes("(")&&H.includes(")")&&(H.match(/\([^)]+\)/g)||[]).some(oe=>oe.includes("drum")||oe.includes("Kick")||oe.includes("hi-hat"))?G=an(H):G=H;const ge=document.getElementById("modal-keep-notes-as-written"),ye=ge&&ge.checked;if(G&&Kt(G)&&!kn(G)&&!ye){const oe=C.convertPatternForScale(G);oe&&oe!==G&&(G=oe,R&&Fe("modal-pattern",oe))}if(!V&&this.activeElements.has(A)){console.log(`🛑 Stopping sound for ${A} (bank changed, not auto-playing)`),C.stopSound(A),this.activeElements.delete(A);const oe=document.querySelector(`[data-sound-id="${A}"]`);if(oe){const Ke=oe.querySelector(".element-circle");Ke&&Ke.classList.remove("playing"),this.updateStatusDots(A,!0,!1)}}else V&&console.log(`⏭️ Master running – skipping element stop for ${A}`);const Le=document.querySelector(`[data-sound-id="${A}"]`);if(!V&&Le){const oe=Le.querySelector(".loop-button");oe&&oe.classList.contains("active")&&(console.log(`🛑 Stopping loop for ${A} (bank changed)`),oe.classList.remove("active"),C.stopSound(A))}const Ee=document.getElementById("modal-keep-notes-as-written"),xe=Ee?Ee.checked:!1;this.saveElementConfig(A,{title:le||bankDisplayName,pattern:G,bank:$||void 0,keepNotesAsWritten:xe},!0),console.log(`💾 Saved config with bank: ${$}`),C.invalidatePatternCache(A),G&&(await C.preEvaluatePattern(A,G),console.log(`📦 Pre-evaluated pattern for ${A} (silent, ready for manual trigger)`));const He=$&&hi.has($);console.log("📦 Bank change: isDrum=",He,"bankValue=",$),He?(console.log("📦 Drum bank selected – preserving current editor mode"),p.patternEditorEnabled?ns():(p.built=!1,setTimeout(()=>{ns()},0))):(console.log("📦 Not a drum bank, using code editor"),ee(!0),ns())});const Rd=e.querySelector(".btn-cancel");Rd&&Rd.addEventListener("click",()=>{Ze()});const _d=e.querySelector(".btn-save");_d&&_d.addEventListener("click",()=>{if(!this.currentEditingElementId)return;p.active&&ii();let v=document.getElementById("modal-title").value.trim();v==="No sound assigned"&&(v="");const w=Ae("modal-pattern").trim();let P;w.includes(".bank(")||w.includes(".s(")||w.includes(".synth(")||Kt(w)||w.includes("sound(")||w.includes("s(")?P=w:P=an(w);const $=document.getElementById("modal-keep-notes-as-written"),A=$?$.checked:!1;if(P&&Kt(P)){const ve=/\b(note|n)\s*\(\s*["'][a-gA-G][#b]?\d/.test(P),le=/\b(n|note)\s*\(\s*["'][\d\s\-]+["']/.test(P)&&!/\b(note|n)\s*\(\s*["'][a-gA-G]/.test(P);ve&&!le?console.log(`📝 Preserving note names format: ${P.substring(0,50)}...`):le&&!ve&&console.log(`📝 Preserving semitones format: ${P.substring(0,50)}...`)}const N=A,T=document.getElementById("modal-key-select"),R=document.getElementById("modal-scale-select"),V=T&&T.value||null,J=R&&R.value||null;if(console.log(`🎼 Modal save: Reading key/scale from dropdowns - elementKey="${V}", elementScale="${J}", modalKeySelect.value="${T==null?void 0:T.value}", modalScaleSelect.value="${R==null?void 0:R.value}"`),P&&Kt(P)&&(V||J)){const ve=/\b(note|n)\s*\(/.test(P),le=/\b(note|n)\s*\(\s*["'][a-gA-G][#b]?\d/.test(P),H=/\b(n|note)\s*\(\s*["'][\d\s\-]+["']/.test(P)&&!/\b(note|n)\s*\(\s*["'][a-gA-G]/.test(P),G=/\.\s*chord\s*\(/i.test(P),ge=ve&&H&&!le&&!G;if(console.log(`🎼 Modal save: pattern="${P.substring(0,50)}...", hasNoteFunction=${ve}, hasNoteNames=${le}, hasNumericNotes=${H}, isNumericPattern=${ge}, elementKey="${V}", elementScale="${J}"`),!G&&ge&&!le){const ye=C.applyGlobalSettingsToPattern(P,!1,!1,V||null,J||null);console.log(`🎼 Modal save: patternWithScale="${ye?ye.substring(0,80):"null"}..."`),ye&&ye!==P?(P=ye,Fe("modal-pattern",P),console.log(`✅ Applied key/scale to pattern: ${P.substring(0,80)}...`)):console.log("⚠️ Scale not applied - pattern unchanged or applyGlobalSettingsToPattern returned same pattern")}else console.log(le?"📝 Pattern uses note names - preserving format, not applying scale modifier":`⚠️ Scale not applied - hasChordModifier=${G}, isNumericPattern=${ge}`)}else console.log(`⚠️ Key/Scale not applied - pattern: ${!!P}, hasNoteCall: ${P?Kt(P):!1}, elementKey: ${V}, elementScale: ${J}`);const Z=document.getElementById("modal-sample-url").value.trim(),U=document.getElementById("modal-sample-file"),Pe=n?n.value:"";let be=Z;if(U.files&&U.files.length>0){const ve=U.files[0],le=new FileReader;le.onload=H=>{be=H.target.result,this.saveElementConfig(this.currentEditingElementId,{title:v||this.currentEditingElementId,pattern:P,sampleUrl:be,fileName:ve.name,bank:Pe||void 0,keepNotesAsWritten:N,key:V,scale:J}),Ze()},le.readAsDataURL(ve)}else this.saveElementConfig(this.currentEditingElementId,{title:v||this.currentEditingElementId,pattern:P,sampleUrl:be,bank:Pe||void 0,keepNotesAsWritten:N,key:V,scale:J}),Ze()}),e.addEventListener("click",v=>{v.target===e&&Ze()}),document.addEventListener("keydown",v=>{v.key==="Escape"&&e.style.display!=="none"&&Ze()}),document.querySelectorAll(".config-button").forEach(v=>{v.addEventListener("click",w=>{w.stopPropagation();const P=v.closest(".sound-element");if(P){const $=P.getAttribute("data-sound-id");$&&st($)}})}),this.openConfigModal=st}isOverlapping(e,t){return!(e.x+e.width<t.x||t.x+t.width<e.x||e.y+e.height<t.y||t.y+t.height<e.y)}setupAddElementButton(){const e=document.getElementById("add-element-btn");e&&e.addEventListener("click",()=>{this.createNewElement()})}createNewElement(){this.elementCounter++;const e=`element-${this.elementCounter}`,t=this.elementCounter;console.log(`➕ Creating new element: ${e}`);const n=document.querySelector(".elements-container"),s=document.getElementById("add-element-btn");if(!n||!s)return;const r=`
      <div class="sound-element" data-sound-id="${e}">
        <input type="range" class="gain-slider" min="0" max="1" step="0.01" value="0.8" orient="vertical" />
        <div class="volume-label">Gain</div>
        <div class="channel-label">Channel ${t}</div>
        <input type="range" class="pan-slider" min="-1" max="1" step="0.01" value="0" orient="horizontal" />
        <div class="pan-label">Pan</div>
        <div class="status-dots">
          <div class="status-dot loaded-dot" title="Sound Loaded"></div>
          <div class="status-dot playing-dot" title="Playing"></div>
        </div>
        <div class="master-status-indicator" title="Pattern saved to Master">M</div>
        <div class="element-title">Element ${t}</div>
        <div class="element-indicator"></div>
        <div class="element-circle"></div>
        <div class="spiral-visualization-container" style="display: none;"></div>
        <div class="element-controls">
          <button class="solo-button" title="Solo">S</button>
          <button class="mute-button" title="Mute">M</button>
        </div>
        
        <!-- Synthesis Section (ADSR Envelope) - Only for synth sounds -->
        <div class="collapsible-section synthesis-section" style="display: none;">
          <button class="collapsible-toggle" data-target="synthesis">
            <span class="toggle-icon">▶</span> Synthesis
          </button>
          <div class="collapsible-content synthesis-content">
            <div class="slider-row">
              <label>Attack</label>
              <input type="range" class="synth-slider attack-slider" min="0" max="2" step="0.01" value="0.01" />
              <span class="slider-value">0.01</span>
            </div>
            <div class="slider-row">
              <label>Decay</label>
              <input type="range" class="synth-slider decay-slider" min="0" max="2" step="0.01" value="0.1" />
              <span class="slider-value">0.1</span>
            </div>
            <div class="slider-row">
              <label>Sustain</label>
              <input type="range" class="synth-slider sustain-slider" min="0" max="1" step="0.01" value="0.5" />
              <span class="slider-value">0.5</span>
            </div>
            <div class="slider-row">
              <label>Release</label>
              <input type="range" class="synth-slider release-slider" min="0" max="5" step="0.01" value="0.1" />
              <span class="slider-value">0.1</span>
            </div>
          </div>
        </div>
        
        <!-- Filters Section -->
        <div class="collapsible-section">
          <button class="collapsible-toggle" data-target="filters">
            <span class="toggle-icon">▶</span> Filters
          </button>
          <div class="collapsible-content filters-content">
            <div class="slider-row">
              <label>Low-pass</label>
              <span class="slider-endpoint slider-endpoint--min">20 Hz</span>
              <input type="range" class="filter-slider lpf-slider" min="20" max="20000" step="10" value="20000" />
              <span class="slider-value">20000</span>
              <span class="slider-endpoint slider-endpoint--max">20 kHz</span>
            </div>
            <div class="slider-row">
              <label>High-pass</label>
              <span class="slider-endpoint slider-endpoint--min">20 Hz</span>
              <input type="range" class="filter-slider hpf-slider" min="20" max="20000" step="10" value="20" />
              <span class="slider-value">20</span>
              <span class="slider-endpoint slider-endpoint--max">20 kHz</span>
            </div>
            <div class="slider-row">
              <label>Resonance</label>
              <input type="range" class="filter-slider resonance-slider" min="0" max="20" step="0.1" value="0" />
              <span class="slider-value">0</span>
            </div>
          </div>
        </div>
        
        <!-- Effects Section -->
        <div class="collapsible-section">
          <button class="collapsible-toggle" data-target="effects">
            <span class="toggle-icon">▶</span> Effects
          </button>
          <div class="collapsible-content effects-content">
            <div class="slider-row">
              <label>Reverb</label>
              <input type="range" class="effect-slider reverb-slider" min="0" max="1" step="0.01" value="0" />
              <span class="slider-value">0</span>
            </div>
            <div class="slider-row">
              <label>Delay</label>
              <input type="range" class="effect-slider delay-slider" min="0" max="1" step="0.01" value="0" />
              <span class="slider-value">0</span>
            </div>
            <div class="slider-row">
              <label>Distortion</label>
              <input type="range" class="effect-slider distortion-slider" min="0" max="10" step="0.1" value="0" />
              <span class="slider-value">0</span>
            </div>
          </div>
        </div>
        
        <div class="element-action-buttons">
        <button class="config-button">Configure Sound</button>
          <div class="history-button-row">
            <button class="history-button" type="button" data-history-target="channel">Load</button>
            <button class="history-button history-button--primary" type="button" data-history-save="channel">Save</button>
          </div>
        </div>
      </div>
    `;s.insertAdjacentHTML("beforebegin",r);const o=document.querySelector(`[data-sound-id="${e}"]`);if(o){et.elements.push({id:e,selector:`[data-sound-id="${e}"]`,type:"strudel",pattern:"",description:"No sound assigned"}),this.registerElements([{element:o,elementId:e}]),this.setupElementControlsForElement(o,e);const a=o.querySelector(".config-button");a&&this.openConfigModal&&a.addEventListener("click",d=>{d.stopPropagation(),this.openConfigModal(e)});const l=o.querySelector(".config-button");if(l&&(l.textContent="Configure Sound"),On(e,""),this.initializeElementVisualizations(o,e),l){const d=this.loadElementConfig(e);(!d||!d.pattern||d.pattern.trim()==="")&&(l.textContent="Configure Sound")}console.log(`✅ Element ${e} created and fully initialized`)}}setupElementControlsForElement(e,t){if(!e||!t)return;const n=e.querySelector(".gain-slider"),s=e.querySelector(".pan-slider");if(n){const a=parseFloat(n.value);C.setElementGain(t,a),n.addEventListener("input",l=>{l.stopPropagation();const d=parseFloat(l.target.value);C.setElementGain(t,d),C.updateTrackedElementGain(t,d),this.updateMasterPatternDisplay()})}if(s){const a=parseFloat(s.value);C.setElementPan(t,a),s.addEventListener("input",l=>{l.stopPropagation();const d=parseFloat(l.target.value);C.setElementPan(t,d),C.updateTrackedElementPan(t,d),this.updateMasterPatternDisplay()})}const r=e.querySelector(".solo-button");r&&r.addEventListener("click",a=>{a.stopPropagation(),this.handleSoloButton(t,r)});const o=e.querySelector(".mute-button");o&&o.addEventListener("click",a=>{a.stopPropagation(),this.handleMuteButton(t,o)}),this.setupCollapsibleSections(e,t)}}let uo=null,Hi=null,Yi=null,ho=null,xl=null;async function kf(){Hi=new F$,Hi.init(),Hi.setOnLoginSuccess(o=>{uo=o,$l(o)});try{const o=await Sa();o?(uo=o,$l(o)):Ml()}catch{Ml()}const i=document.getElementById("header-login-btn");i&&i.addEventListener("click",()=>{Hi&&Hi.show()});const e=document.getElementById("user-menu-button"),t=document.getElementById("user-menu-dropdown");e&&t&&(e.addEventListener("click",o=>{o.stopPropagation(),t.classList.toggle("active")}),document.addEventListener("click",o=>{!e.contains(o.target)&&!t.contains(o.target)&&t.classList.remove("active")}));const n=document.getElementById("user-logout-btn");n&&n.addEventListener("click",async()=>{try{await Nd.logout(),uo=null,Ml(),t.classList.remove("active")}catch(o){console.error("Logout error:",o)}});const s=document.getElementById("user-profile-link");s&&s.addEventListener("click",async o=>{o.preventDefault(),Yi&&await Yi.show(),t.classList.remove("active")}),Yi=new G$,Yi.init(),Yi.setOnUpdate(o=>{uo=o,$l(o)}),ho=new X$,ho.init();const r=document.getElementById("user-profiles-link");r&&r.addEventListener("click",async o=>{o.preventDefault(),ho&&await ho.show(),t.classList.remove("active")}),xl=new U$,xl.init(),window.savePatternDialog=xl}function $l(i){const e=document.getElementById("header-login-btn"),t=document.getElementById("user-menu"),n=document.getElementById("user-name"),s=document.getElementById("user-avatar");e&&(e.style.display="none"),t&&(t.style.display="block"),n&&(n.textContent=i.name||i.email),s&&i.avatarUrl&&(s.src=i.avatarUrl,s.style.display="block")}function Ml(){const i=document.getElementById("header-login-btn"),e=document.getElementById("user-menu");i&&(i.style.display="block"),e&&(e.style.display="none")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{new Sf().init(),pf(),kf()}):(new Sf().init(),pf(),kf());export{TM as A,EM as B,xM as C,NM as D,Ql as E,G1 as F,AM as G,Ki as H,qf as I,Wf as J,Zy as K,ea as L,Yf as M,Hc as N,r0 as O,Vf as P,Wt as Q,o0 as R,Jo as S,qc as T,jy as U,Yc as V,Uf as W,Ff as X,QM as Y,Ls as Z,kM as a,ta as b,s0 as c,jc as d,Nl as e,Hf as f,Jf as g,Bf as h,Uc as i,kr as j,Xs as k,Kf as l,Lf as m,nt as n,i0 as o,Js as p,Nf as q,Y0 as r,Fc as s,Yn as t,$M as u,SM as v,MM as w,PM as x,CM as y,H0 as z};
