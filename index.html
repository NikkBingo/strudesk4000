<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Niclas Etelävuori @ eKommissar.com">
  <title>Strudesk 4000 – Strudel Pattern Mixer</title>
  <link rel="stylesheet" href="/src/styles.css">
  <!-- Provide import maps so bare @strudel/* specifiers resolve when Strudel REPL dynamically imports modules -->
    <script type="importmap">
      {
        "imports": {
          "@strudel/core": "https://unpkg.com/@strudel/core@1.2.5/dist/index.mjs",
          "@strudel/draw": "https://unpkg.com/@strudel/draw@1.2.4/dist/index.mjs",
          "@strudel/transpiler": "https://unpkg.com/@strudel/transpiler@1.2.5/dist/index.mjs",
          "@strudel/web": "https://unpkg.com/@strudel/web@1.2.5/dist/index.mjs",
          "@strudel/webaudio": "https://unpkg.com/@strudel/webaudio@1.2.5/dist/index.mjs",
          "@strudel/tonal": "https://unpkg.com/@strudel/tonal@1.2.4/dist/index.mjs",
          "fraction.js": "https://cdn.jsdelivr.net/npm/fraction.js@4.2.0/+esm"
        }
      }
    </script>
  <!-- Strudel is loaded via Vite from local packages to avoid version conflicts -->
</head>
<body>
  <div class="bubble-background" aria-hidden="true"></div>
  <div class="container">
    <header>
      <div class="header-left">
        <img class="header-logo-img" src="/assets/img/strudesk4000logo.png" alt="Strudesk 4000 logo" />
        <h1 class="brand-font brand-logo header-logo">Strudesk 4000</h1>
        <span class="version-text">SPM v0.9.1</span>
      </div>
      <div class="header-right">
        <button class="login-button" id="header-login-btn" style="display: none;">Login</button>
        <div class="user-menu" id="user-menu" style="display: none;">
          <button class="user-menu-button" id="user-menu-button">
            <img class="user-avatar" id="user-avatar" src="" alt="User" style="display: none;">
            <span id="user-name">User</span>
            <span style="margin-left: 4px;">▼</span>
          </button>
          <div class="user-menu-dropdown" id="user-menu-dropdown">
            <a href="#" class="user-menu-item" id="user-profile-link">My Profile</a>
            <a href="#" class="user-menu-item" id="user-collab-link" style="display: none;">Live Collaboration</a>
            <a href="#" class="user-menu-item" id="user-profiles-link">Browse Users</a>
            <a href="#" class="user-menu-item" id="user-admin-link" style="display: none;">Admin Console</a>
            <button class="user-menu-item logout" id="user-logout-btn">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Status Indicator -->
    <div class="status-panel">
      <div id="status-text">Ready</div>
      <div id="active-elements"></div>
      <div id="pattern-slots" style="margin-top: 10px; font-size: 0.85rem; color: #666;">
        <strong>Pattern Slots:</strong> <span id="slots-info">None active</span>
      </div>
    </div>

    <!-- Interactive Elements -->
    <div class="elements-container">
      <div class="sound-element" data-sound-id="element-1">
        <input type="range" class="gain-slider" min="0" max="1" step="0.01" value="0.8" orient="vertical" />
        <div class="volume-label">Gain</div>
        <div class="channel-label">Channel 1</div>
        <input type="range" class="pan-slider" min="-1" max="1" step="0.01" value="0" orient="horizontal" />
        <div class="pan-label">Pan</div>
        <div class="status-dots">
          <div class="status-dot loaded-dot" title="Sound Loaded"></div>
          <div class="status-dot playing-dot" title="Playing"></div>
        </div>
        <div class="vu-meter-container">
          <div class="vu-meter">
            <div class="vu-bar"></div>
          </div>
        </div>
        <div class="master-status-indicator" title="Pattern saved to Master">M</div>
        <div class="element-title">Element 1</div>
        <div class="element-indicator"></div>
        <div class="element-circle"></div>
        <div class="spiral-visualization-container" style="display: none;"></div>
        <div class="element-controls">
          <button class="solo-button" title="Solo">S</button>
          <button class="mute-button" title="Mute">M</button>
        </div>
        
        <div class="element-midi-settings">
          <div class="midi-toggle-row">
            <label class="midi-toggle-label">
              Send MIDI
              <input type="checkbox" class="midi-enable-toggle" />
            </label>
          </div>
          <div class="midi-channel-row">
            <label class="midi-channel-label">
              Channel
              <select class="midi-channel-select" disabled>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </label>
          </div>
        </div>
        
        <div class="element-action-buttons">
          <button class="config-button">Configure Sound</button>
          <div class="history-button-row">
            <button class="history-button" type="button" data-history-target="channel">Load</button>
            <button class="history-button history-button--primary" type="button" data-history-save="channel">Save</button>
          </div>
        </div>
      </div>
      <div class="sound-element" data-sound-id="element-2">
        <input type="range" class="gain-slider" min="0" max="1" step="0.01" value="0.8" orient="vertical" />
        <div class="volume-label">Gain</div>
        <div class="channel-label">Channel 2</div>
        <input type="range" class="pan-slider" min="-1" max="1" step="0.01" value="0" orient="horizontal" />
        <div class="pan-label">Pan</div>
        <div class="status-dots">
          <div class="status-dot loaded-dot" title="Sound Loaded"></div>
          <div class="status-dot playing-dot" title="Playing"></div>
        </div>
        <div class="vu-meter-container">
          <div class="vu-meter">
            <div class="vu-bar"></div>
          </div>
        </div>
        <div class="master-status-indicator" title="Pattern saved to Master">M</div>
        <div class="element-title">Element 2</div>
        <div class="element-indicator"></div>
        <div class="element-circle"></div>
        <div class="spiral-visualization-container" style="display: none;"></div>
        <div class="element-controls">
          <button class="solo-button" title="Solo">S</button>
          <button class="mute-button" title="Mute">M</button>
        </div>
        
        <div class="element-midi-settings">
          <div class="midi-toggle-row">
            <label class="midi-toggle-label">
              Send MIDI
              <input type="checkbox" class="midi-enable-toggle" />
            </label>
          </div>
          <div class="midi-channel-row">
            <label class="midi-channel-label">
              Channel
              <select class="midi-channel-select" disabled>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </label>
          </div>
        </div>
        
        <div class="element-action-buttons">
          <button class="config-button">Configure Sound</button>
          <div class="history-button-row">
            <button class="history-button" type="button" data-history-target="channel">Load</button>
            <button class="history-button history-button--primary" type="button" data-history-save="channel">Save</button>
          </div>
        </div>
      </div>
      <div class="sound-element" data-sound-id="element-3">
        <input type="range" class="gain-slider" min="0" max="1" step="0.01" value="0.8" orient="vertical" />
        <div class="volume-label">Gain</div>
        <div class="channel-label">Channel 3</div>
        <input type="range" class="pan-slider" min="-1" max="1" step="0.01" value="0" orient="horizontal" />
        <div class="pan-label">Pan</div>
        <div class="status-dots">
          <div class="status-dot loaded-dot" title="Sound Loaded"></div>
          <div class="status-dot playing-dot" title="Playing"></div>
        </div>
        <div class="vu-meter-container">
          <div class="vu-meter">
            <div class="vu-bar"></div>
          </div>
        </div>
        <div class="master-status-indicator" title="Pattern saved to Master">M</div>
        <div class="element-title">Element 3</div>
        <div class="element-indicator"></div>
        <div class="element-circle"></div>
        <div class="spiral-visualization-container" style="display: none;"></div>
        <div class="element-controls">
          <button class="solo-button" title="Solo">S</button>
          <button class="mute-button" title="Mute">M</button>
        </div>
        
        <div class="element-midi-settings">
          <div class="midi-toggle-row">
            <label class="midi-toggle-label">
              Send MIDI
              <input type="checkbox" class="midi-enable-toggle" />
            </label>
          </div>
          <div class="midi-channel-row">
            <label class="midi-channel-label">
              Channel
              <select class="midi-channel-select" disabled>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </label>
          </div>
        </div>
        
        <div class="element-action-buttons">
          <button class="config-button">Configure Sound</button>
          <div class="history-button-row">
            <button class="history-button" type="button" data-history-target="channel">Load</button>
            <button class="history-button history-button--primary" type="button" data-history-save="channel">Save</button>
          </div>
        </div>
      </div>
      <div class="sound-element" data-sound-id="element-4">
        <input type="range" class="gain-slider" min="0" max="1" step="0.01" value="0.8" orient="vertical" />
        <div class="volume-label">Gain</div>
        <div class="channel-label">Channel 4</div>
        <input type="range" class="pan-slider" min="-1" max="1" step="0.01" value="0" orient="horizontal" />
        <div class="pan-label">Pan</div>
        <div class="status-dots">
          <div class="status-dot loaded-dot" title="Sound Loaded"></div>
          <div class="status-dot playing-dot" title="Playing"></div>
        </div>
        <div class="vu-meter-container">
          <div class="vu-meter">
            <div class="vu-bar"></div>
          </div>
        </div>
        <div class="master-status-indicator" title="Pattern saved to Master">M</div>
        <div class="element-title">Element 4</div>
        <div class="element-indicator"></div>
        <div class="element-circle"></div>
        <div class="spiral-visualization-container" style="display: none;"></div>
        <div class="element-controls">
          <button class="solo-button" title="Solo">S</button>
          <button class="mute-button" title="Mute">M</button>
        </div>
        
        <div class="element-midi-settings">
          <div class="midi-toggle-row">
            <label class="midi-toggle-label">
              Send MIDI
              <input type="checkbox" class="midi-enable-toggle" />
            </label>
          </div>
          <div class="midi-channel-row">
            <label class="midi-channel-label">
              Channel
              <select class="midi-channel-select" disabled>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
              </select>
            </label>
          </div>
        </div>
        
        <div class="element-action-buttons">
          <button class="config-button">Configure Sound</button>
          <div class="history-button-row">
            <button class="history-button" type="button" data-history-target="channel">Load</button>
            <button class="history-button history-button--primary" type="button" data-history-save="channel">Save</button>
          </div>
        </div>
      </div>
      <!-- Add Element Button -->
      <button class="add-element-button" id="add-element-btn" title="Add New Element">
        <span class="plus-icon">+</span>
      </button>
    </div>

    <!-- Master Channel -->
    <div class="master-section">
      <div class="master-visualizer">
        <div class="master-visualizer-header">
          <h3>Visualizer</h3>
          <div class="visualizer-header-controls">
            <select id="visualizer-select" class="visualizer-select">
              <option value="off">Off</option>
              <option value="scope">Scope</option>
              <option value="barchart">Bar Analyzer</option>
              <option value="spectrum">Spectrum</option>
              <option value="pianoroll">Pianoroll</option>
            </select>
            <button id="visualizer-fullscreen-btn" class="visualizer-fullscreen-btn" type="button" aria-label="Enter visualizer fullscreen">
              <span class="fullscreen-icon fullscreen-icon--enter" aria-hidden="true">⤢</span>
              <span class="fullscreen-icon fullscreen-icon--exit" aria-hidden="true">⤡</span>
            </button>
          </div>
        </div>
        <div id="master-punchcard" class="punchcard-grid">
          <canvas id="master-punchcard-canvas" aria-label="Master visualizer"></canvas>
          <div class="punchcard-placeholder">
          <div class="punchcard-logo-placeholder">
            <img src="/assets/img/strudesk4000logo.png" alt="Strudesk 4000 logo" class="punchcard-logo-img" />
            <div class="punchcard-text brand-font brand-logo punchcard-logo">STRUDESK 4000</div>
          </div>
          </div>
        </div>
        <div class="chaospad-control">
          <div class="chaospad-inline-controls">
          <label class="chaospad-checkbox-label">
            <input type="checkbox" id="chaospad-checkbox" class="chaospad-checkbox">
            <span>Chaospad</span>
          </label>
            <div class="chaospad-tilt-inline" id="chaospad-tilt-inline">
              <div class="tilt-slider">
                <label for="chaospad-tilt-x">
                  X tilt
                  <span class="tilt-value" id="chaospad-tilt-x-value">0°</span>
                </label>
                <input type="range" id="chaospad-tilt-x" min="-45" max="45" value="0" step="1">
              </div>
              <div class="tilt-slider">
                <label for="chaospad-tilt-y">
                  Y tilt
                  <span class="tilt-value" id="chaospad-tilt-y-value">0°</span>
                </label>
                <input type="range" id="chaospad-tilt-y" min="-45" max="45" value="0" step="1">
              </div>
            </div>
          </div>
        </div>
      </div>
      <h2>Master</h2>
      <div class="master-channel">
        <div class="master-controls">
          <div class="master-controls-row">
            <div class="control-group">
            <label for="master-volume">Master Volume:</label>
            <div class="master-inline-value">
              <input 
                type="range" 
                id="master-volume" 
                class="master-volume-slider"
                min="0" 
                max="100" 
              value="70"
              />
              <span id="master-volume-value">70%</span>
            </div>
            </div>
            <div class="control-group">
              <label for="master-pan">Master Pan:</label>
              <div class="master-inline-value">
                <input 
                  type="range" 
                  id="master-pan" 
                  class="master-pan-slider"
                  min="-1" 
                  max="1" 
                  step="0.01" 
                  value="0"
                />
                <span id="master-pan-value">0</span>
              </div>
            </div>
          <div class="control-group">
            <label for="tempo-slider">Tempo:</label>
            <div class="master-inline-value">
              <input 
                type="range" 
                id="tempo-slider" 
                min="60" 
                max="240" 
                value="120"
              class="inactive"
              />
              <span id="tempo-value" class="inactive">120</span> BPM
            </div>
              <button id="tap-tempo-btn" class="tap-tempo-button" title="Tap to set tempo">TAP</button>
            </div>
          </div>
        </div>
      </div>
      <div class="master-pattern-container">
        <div class="master-pattern-header">
          <label for="master-pattern">Master Pattern Code</label>
          <div class="header-buttons">
            <button id="clear-all-btn" class="clear-all-button" title="Clear All">Clear All</button>
            <button id="copy-code-btn" class="copy-code-button" title="Copy">Copy</button>
          </div>
        </div>
        <textarea 
          id="master-pattern" 
          class="master-pattern-field"
          data-strudel-repl
          placeholder="Combined pattern will appear here..."
          rows="15"
        ></textarea>
        <div class="master-history-controls">
          <div class="history-button-row history-button-row--inline history-button-row--center">
            <button id="load-master-history-btn" class="history-button" type="button">Load</button>
            <button id="play-master-btn" class="play-master-button" title="Play Master">▶</button>
            <button id="save-master-history-btn" class="history-button history-button--primary" type="button" data-history-save="master">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Piano Keyboard -->
    <section class="mobile-piano-section" id="mobile-piano-section">
      <div class="mobile-piano-header">
        <h3>Piano</h3>
        <div class="mobile-piano-octave-controls">
          <label>Octave:</label>
          <button class="piano-octave-btn" data-octave="1">1</button>
          <button class="piano-octave-btn" data-octave="2">2</button>
          <button class="piano-octave-btn active" data-octave="3">3</button>
          <button class="piano-octave-btn" data-octave="4">4</button>
          <button class="piano-octave-btn" data-octave="5">5</button>
        </div>
      </div>
      <div class="mobile-piano-keyboard" id="mobile-piano-keyboard">
        <button class="piano-key white" data-note="C">C</button>
        <button class="piano-key black" data-note="C#">C#</button>
        <button class="piano-key white" data-note="D">D</button>
        <button class="piano-key black" data-note="D#">D#</button>
        <button class="piano-key white" data-note="E">E</button>
        <button class="piano-key white" data-note="F">F</button>
        <button class="piano-key black" data-note="F#">F#</button>
        <button class="piano-key white" data-note="G">G</button>
        <button class="piano-key black" data-note="G#">G#</button>
        <button class="piano-key white" data-note="A">A</button>
        <button class="piano-key black" data-note="A#">A#</button>
        <button class="piano-key white" data-note="B">B</button>
      </div>
    </section>

    <section class="top-tracks-section">
      <div class="top-tracks-header">
        <div>
          <h3>Top 5 Tracks</h3>
          <p>Community favorites you can drop into your master</p>
        </div>
      </div>
      <div id="top-tracks-empty" class="top-tracks-empty">Loading top tracks…</div>
      <div id="top-tracks-list" class="top-tracks-grid"></div>
    </section>

    <!-- Credits Section -->
    <div class="credits-section">
      <p>
        <span class="brand-font brand-logo credits-logo">Strudesk 4000</span>
        <span> by <a href="https://ekommissar.com" target="_blank" rel="noopener noreferrer">eKommissar</a></span>
        <span class="credits-separator">·</span>
        <span>Based on <a href="https://strudel.cc/workshop/getting-started/" target="_blank" rel="noopener noreferrer">Strudel</a></span>
      </p>
    </div>

    <!-- Configuration Modal -->
    <div class="modal-overlay" id="config-modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title-group">
            <h2>Configure Channel</h2>
            <p class="modal-channel-label" id="modal-element-id"></p>
          </div>
          <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="modal-pattern-bank">Sound Bank:</label>
            <select id="modal-pattern-bank">
              <optgroup label="Drums">
                <option value="">Default</option>
                <option value="RolandTR808">Roland TR-808</option>
                <option value="RolandTR909">Roland TR-909</option>
                <option value="RolandTR707">Roland TR-707</option>
                <option value="RhythmAce">Rhythm Ace</option>
                <option value="AkaiLinn">Akai Linn</option>
                <option value="ViscoSpaceDrum">Visco Space Drum</option>
                <option value="CasioRZ1">Casio RZ-1</option>
              </optgroup>
              <optgroup label="Basic Waveforms">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="triangle">Triangle</option>
                <option value="sawtooth">Sawtooth</option>
              </optgroup>
              <optgroup label="Sample-based Synths">
                <option value="piano">Piano</option>
                <option value="supersaw">Saw Synth</option>
                <option value="casio">Casio</option>
                <option value="jazz">Jazz</option>
                <option value="metal">Metal</option>
                <option value="folkharp">Folk Harp</option>
              </optgroup>
            </select>
            <div class="pattern-help">
              <small>Select a sound bank to load. Banks are loaded when selected.</small>
            </div>
          </div>
          <div class="form-group">
            <label for="modal-title">Title:</label>
            <input type="text" id="modal-title" placeholder="e.g., My Drum Pattern or leave empty for bank name" />
          </div>
          <div class="form-group">
            <label for="modal-time-signature-select">Time Signature:</label>
            <select id="modal-time-signature-select" class="control-select" aria-label="Time Signature">
              <option value="4/4" selected>4/4 (Common Time)</option>
              <option value="3/4">3/4 (Waltz)</option>
              <option value="6/8">6/8</option>
              <option value="2/4">2/4 (March)</option>
              <option value="5/4">5/4</option>
              <option value="7/8">7/8</option>
              <option value="12/8">12/8</option>
              <option value="2/2">2/2 (Cut Time)</option>
              <option value="3/8">3/8</option>
              <option value="9/8">9/8</option>
              <option value="5/8">5/8</option>
              <option value="7/4">7/4</option>
            </select>
          </div>
          <div class="form-group" id="modal-key-scale-group" style="display: none;">
            <div style="display: flex; gap: 16px;">
              <div style="flex: 1;">
                <label for="modal-key-select">Key:</label>
                <select id="modal-key-select" class="control-select" aria-label="Key">
                  <option value="">Select Key</option>
                  <option value="C">C</option>
                  <option value="C#">C#</option>
                  <option value="Db">Db</option>
                  <option value="D">D</option>
                  <option value="D#">D#</option>
                  <option value="Eb">Eb</option>
                  <option value="E">E</option>
                  <option value="F">F</option>
                  <option value="F#">F#</option>
                  <option value="Gb">Gb</option>
                  <option value="G">G</option>
                  <option value="G#">G#</option>
                  <option value="Ab">Ab</option>
                  <option value="A">A</option>
                  <option value="A#">A#</option>
                  <option value="Bb">Bb</option>
                  <option value="B">B</option>
                </select>
              </div>
              <div style="flex: 1;">
                <label for="modal-scale-select">Scale:</label>
                <select id="modal-scale-select" class="control-select" aria-label="Scale">
                  <option value="chromatic" selected>Chromatic</option>
                  <optgroup label="Diatonic (Major Scale) Modes">
                    <option value="ionian">Ionian (Major)</option>
                    <option value="dorian">Dorian</option>
                    <option value="phrygian">Phrygian</option>
                    <option value="lydian">Lydian</option>
                    <option value="mixolydian">Mixolydian</option>
                    <option value="aeolian">Aeolian (Natural Minor)</option>
                    <option value="locrian">Locrian</option>
                  </optgroup>
                  <optgroup label="Melodic Minor Modes (Jazz Melodic Minor)">
                    <option value="melodic minor">Melodic Minor (Jazz Minor)</option>
                    <option value="dorian b2">Dorian ♭2</option>
                    <option value="lydian augmented">Lydian Augmented</option>
                    <option value="lydian dominant">Lydian Dominant</option>
                    <option value="mixolydian b6">Mixolydian ♭6</option>
                    <option value="locrian #2">Locrian ♮2</option>
                    <option value="altered">Altered Scale (Super-Locrian)</option>
                  </optgroup>
                  <optgroup label="Harmonic Major Modes">
                    <option value="harmonic major">Harmonic Major</option>
                    <option value="dorian b5">Dorian ♭5</option>
                    <option value="phrygian b4">Phrygian ♭4</option>
                    <option value="lydian b3">Lydian ♭3</option>
                    <option value="mixolydian b2">Mixolydian ♭2</option>
                    <option value="lydian augmented #2">Lydian Augmented ♯2</option>
                    <option value="locrian bb7">Locrian ♭♭7</option>
                  </optgroup>
                  <optgroup label="Harmonic Minor Modes">
                    <option value="harmonic minor">Harmonic Minor</option>
                    <option value="locrian #6">Locrian ♮6</option>
                    <option value="ionian #5">Ionian ♯5</option>
                    <option value="dorian #4">Dorian ♯4 (Ukrainian Dorian)</option>
                    <option value="phrygian dominant">Phrygian Dominant</option>
                    <option value="lydian #2">Lydian ♯2</option>
                    <option value="ultralocrian">Ultralocrian</option>
                  </optgroup>
                  <optgroup label="Pentatonic Modes (Major Pentatonic)">
                    <option value="major pentatonic">Major Pentatonic</option>
                    <option value="suspended pentatonic">Suspended Pentatonic</option>
                    <option value="man gong">Man Gong</option>
                    <option value="ritusen">Ritusen</option>
                    <option value="minor pentatonic mode 5">Minor Pentatonic Mode 5</option>
                  </optgroup>
                  <optgroup label="Pentatonic Modes (Minor Pentatonic)">
                    <option value="minor pentatonic">Minor Pentatonic</option>
                    <option value="blues minor pentatonic">Blues Minor (no ♭5)</option>
                    <option value="major pentatonic mode 3">Major Pentatonic Mode 3</option>
                    <option value="egyptian">Egyptian</option>
                    <option value="minor pentatonic mode 5">Minor Pentatonic Mode 5</option>
                  </optgroup>
                  <optgroup label="Other Scale Systems">
                    <option value="whole tone">Whole Tone</option>
                    <option value="half-whole diminished">Half–Whole</option>
                    <option value="whole-half diminished">Whole–Half</option>
                    <option value="minor blues">Minor Blues</option>
                  </optgroup>
                </select>
                <div id="modal-scale-notes-display" style="font-size: 0.85em; color: #666; margin-top: 4px; font-style: italic;"></div>
              </div>
            </div>
            <div class="scale-chord-suggestions" id="modal-scale-chord-suggestions" aria-live="polite">
              <div class="scale-chord-suggestions__header">
                <p id="modal-scale-chord-title">Select a key and scale to view chord progressions.</p>
                <p id="modal-scale-characteristic" class="scale-chord-suggestions__characteristic"></p>
              </div>
              <div class="scale-chord-suggestions__dropdown-wrapper">
                <label for="modal-chord-progression-select" class="scale-chord-suggestions__label">Chord Progressions:</label>
                <select id="modal-chord-progression-select" class="scale-chord-suggestions__select">
                  <option value="">Select a progression...</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="pattern-label-row">
              <label for="modal-pattern">Pattern</label>
              <select id="modal-pattern-editor-select" class="control-select" style="display: none;" aria-label="Editor Type">
                <option value="step">Step Editor</option>
                <option value="code">Code Editor</option>
              </select>
            </div>
            <div class="modal-presets">
              <button type="button" id="modal-presets-toggle" class="modal-presets-toggle pattern-snippet-group-heading" aria-expanded="false">
                <span>Presets</span>
              </button>
              <div id="modal-presets-content" class="modal-presets-content" hidden>
                <div class="modal-presets-group">
                  <button type="button" class="modal-presets-subtoggle pattern-snippet-group-heading" data-target="modal-drum-presets" aria-expanded="false">
                    <span>Drum Patterns</span>
                  </button>
                  <div class="modal-presets-subcontent modal-presets-buttons" id="modal-drum-presets"></div>
                </div>
                <div class="modal-presets-group">
                  <button type="button" class="modal-presets-subtoggle pattern-snippet-group-heading" data-target="modal-tonal-presets" aria-expanded="false">
                    <span>Tonal Examples</span>
                  </button>
                  <div class="modal-presets-subcontent modal-presets-buttons" id="modal-tonal-presets"></div>
                </div>
                <div class="modal-presets-group">
                  <button type="button" class="modal-presets-subtoggle pattern-snippet-group-heading" data-target="modal-sampler-subcontent" aria-expanded="false">
                    <span>Sampler Effects</span>
                  </button>
                  <div class="modal-presets-subcontent" id="modal-sampler-subcontent">
                    <p class="modal-presets-description">
                      Sampler effects are functions that change how audio files are triggered, looped, and reshaped.
                    </p>
                    <p class="modal-presets-description">
                      Source: <a href="https://strudel.cc/learn/samples/" target="_blank" rel="noreferrer">https://strudel.cc/learn/samples/</a>
                    </p>
                    <div class="modal-presets-buttons" id="modal-sampler-presets"></div>
                  </div>
                </div>
              </div>
            </div>
            <div id="modal-drum-grid-section" class="drum-grid-section" style="display: none;">
              <div class="drum-grid-header">
                <div class="drum-grid-title-row">
                  <span class="drum-grid-title">Drum Grid</span>
                  <span class="drum-grid-bar-selector" id="modal-drum-grid-bar-selector">
                    <button class="drum-grid-bar-arrow drum-grid-bar-arrow-left" id="modal-drum-grid-bar-arrow-left" title="Previous bar" style="display: none;">←</button>
                    <span class="drum-grid-bar-count" id="modal-drum-grid-bar-count">1 bar</span>
                    <button class="drum-grid-bar-arrow drum-grid-bar-arrow-right" id="modal-drum-grid-bar-arrow-right" title="Next bar" style="display: none;">→</button>
                    <button class="drum-grid-add-bar" id="modal-drum-grid-add-bar" title="Add another bar">+</button>
                  </span>
                </div>
                <span class="drum-grid-subtitle" id="modal-drum-grid-timesig">16th-note steps</span>
              </div>
              <div class="drum-grid" id="modal-drum-grid-container">
                <!-- Drum rows will be dynamically generated here -->
              </div>
              <div class="drum-grid-hint">Toggle 16th-note steps to build a drum groove. Pattern updates automatically.</div>
            </div>
            <div id="modal-pattern-editor-wrapper" style="display: none;">
              <div id="modal-note-conversion-control" style="display: none; margin-bottom: 12px;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                  <span style="font-weight: 500;">Semitones</span>
                  <label class="toggle-switch">
                    <input type="checkbox" id="modal-keep-notes-as-written">
                    <span class="toggle-slider"></span>
                  </label>
                  <span style="font-weight: 500;">Note names</span>
                </label>
              </div>
              <textarea id="modal-pattern" rows="8" placeholder=''></textarea>
            </div>
        <div class="pattern-preview-controls">
          <button id="modal-preview-btn" type="button" class="modal-preview-button" disabled>▶ Preview Pattern</button>
        </div>
            <div class="pattern-help">
              <small>
                Drum sounds examples: <a href="https://strudel.cc/workshop/first-sounds/#drum-sounds" target="_blank">https://strudel.cc/workshop/first-sounds/#drum-sounds</a><br>
                Synth sound examples: <a href="https://strudel.cc/workshop/first-notes/#changing-the-sound" target="_blank">https://strudel.cc/workshop/first-notes/#changing-the-sound</a><br>
                Effects examples: <a href="https://strudel.cc/learn/effects/" target="_blank">https://strudel.cc/learn/effects/</a>
              </small>
            </div>
          </div>
        <div class="modal-footer">
          <button class="btn-cancel">Cancel</button>
          <button class="btn-save">Send</button>
        </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Early console suppression - must run before any modules load -->
  <script>
    // Set up console suppression at the earliest possible moment
    // This must run before Strudel loads to catch its internal logging
    (function() {
      const originalError = console.error;
      const originalWarn = console.warn;
      const originalLog = console.log;
      
      function shouldSuppressStrudelError(args) {
        if (!args || args.length === 0) return false;
        
        // Convert all arguments to a single searchable string
        // Handle BigInt safely - avoid JSON.stringify which fails on BigInt
        const fullMessage = args.map(arg => {
          if (typeof arg === 'string') return arg;
          if (typeof arg === 'bigint') return String(arg);
          if (arg instanceof Error) return arg.message || String(arg);
          if (arg && typeof arg === 'object') {
            // Try to get message property first
            if (arg.message) return String(arg.message);
            // Try JSON.stringify with error handling for BigInt
            try {
              // Use a replacer to handle BigInt values
              return JSON.stringify(arg, (key, value) => 
                typeof value === 'bigint' ? value.toString() : value
              );
            } catch (e) {
              // Fallback to String() if JSON.stringify still fails
              return String(arg);
            }
          }
          return String(arg);
        }).join(' ');
        
        const lowerMessage = fullMessage.toLowerCase();
        
        // Suppress Strudel internal errors - check multiple variations
        // Check for eval/getTrigger errors (most common)
        // Also check first argument directly for immediate match
        const firstArg = args && args.length > 0 ? args[0] : null;
        const firstArgStr = firstArg ? String(firstArg) : '';
        const firstArgLower = firstArgStr.toLowerCase();
        
        // Check first argument directly (faster path) - catch all variations
        if (firstArgStr.includes('[eval]') || 
            firstArgStr.includes('[getTrigger]') ||
            firstArgStr.includes('[eval] error') || 
            firstArgStr.includes('[getTrigger] error') ||
            firstArgLower.includes('[eval]') ||
            firstArgLower.includes('[gettrigger]') ||
            firstArgStr.includes('undefined instead of pattern') ||
            firstArgStr.includes('got "undefined" instead of pattern') ||
            firstArgStr.includes('got undefined instead of pattern') ||
            firstArgLower.includes('undefined instead of pattern') ||
            firstArgStr.includes('not found') ||
            firstArgLower.includes('rolandtr') ||
            (firstArgStr.includes('error:') && firstArgStr.includes('undefined'))) {
          return true;
        }
        
        // Check full message for patterns
        if (fullMessage.includes('[eval]') || 
            fullMessage.includes('[getTrigger]') ||
            fullMessage.includes('[eval] error') || 
            fullMessage.includes('[getTrigger] error') ||
            lowerMessage.includes('[eval]') ||
            lowerMessage.includes('[gettrigger]')) {
          return true;
        }
        
        // Check for "undefined instead of pattern" errors - catch all variations
        if (fullMessage.includes('undefined instead of pattern') || 
            fullMessage.includes('got "undefined" instead of pattern') ||
            fullMessage.includes('got undefined instead of pattern') ||
            fullMessage.includes('undefined instead') ||
            fullMessage.includes('instead of pattern') ||
            (fullMessage.includes('[eval]') && fullMessage.includes('undefined')) ||
            (fullMessage.includes('error:') && fullMessage.includes('undefined')) ||
            lowerMessage.includes('undefined instead of pattern') ||
            lowerMessage.includes('undefined instead') ||
            lowerMessage.includes('instead of pattern')) {
          return true;
        }
        
        // Check for "sound X not found" patterns (multiple formats)
        if (fullMessage.includes('not found! Is it loaded?') ||
            fullMessage.includes('not found! is it loaded?') ||
            fullMessage.includes('not found') ||
            lowerMessage.includes('not found') ||
            (fullMessage.includes('sound ') && (fullMessage.includes('not found') || fullMessage.includes('not found!'))) ||
            (lowerMessage.includes('sound ') && lowerMessage.includes('not found'))) {
          return true;
        }
        
        // Suppress RolandTR errors (all variations)
        if (fullMessage.includes('RolandTR') ||
            fullMessage.includes('RolandTR808') ||
            fullMessage.includes('RolandTR909') ||
            lowerMessage.includes('rolandtr') ||
            lowerMessage.includes('rolandtr808') ||
            lowerMessage.includes('rolandtr909')) {
          return true;
        }
        
        // Suppress superdough scheduling warnings
        if (fullMessage.includes('[superdough]') || 
            fullMessage.includes('cannot schedule sounds in the past') ||
            lowerMessage.includes('[superdough]')) {
          return true;
        }
        
        // Suppress network 404 errors for bank loading (expected when banks don't exist)
        // Check for various network error formats
        const isBankLoadingError = fullMessage.includes('strudel.json') ||
                                    fullMessage.includes('raw.githubusercontent.com') ||
                                    fullMessage.includes('tidalcycles') ||
                                    fullMessage.includes('CycleTones') ||
                                    fullMessage.includes('RolandTR') ||
                                    fullMessage.includes('rolandtr') ||
                                    lowerMessage.includes('rolandtr');
        
        if (isBankLoadingError) {
          // Suppress if it's any kind of loading/404 error
          if (fullMessage.includes('Failed to load resource') || 
              fullMessage.includes('failed to load') ||
              fullMessage.includes('404') ||
              fullMessage.includes('Not Found') ||
              fullMessage.includes('GET http') ||
              fullMessage.includes('GET https') ||
              (fullMessage.includes('GET') && (fullMessage.includes('404') || fullMessage.includes('Not Found')))) {
            return true;
          }
        }
        
        return false;
      }
      
      // Override console.error
      console.error = function(...args) {
        if (shouldSuppressStrudelError(args)) {
          return; // Suppress
        }
        originalError.apply(console, args);
      };
      
      // Override console.warn
      console.warn = function(...args) {
        if (shouldSuppressStrudelError(args)) {
          return; // Suppress
        }
        originalWarn.apply(console, args);
      };
      
      // Don't override console.log - only suppress errors/warnings
      // console.log should always pass through for debugging
    })();
  </script>

  <script>
    (function initBubbleBackground() {
      const bubbleRoot = document.querySelector('.bubble-background');
      if (!bubbleRoot) return;
      const styles = getComputedStyle(document.documentElement);
      const bubbleCount = parseInt(styles.getPropertyValue('--bubble-count'), 10) || 12;
      bubbleRoot.innerHTML = '';
      for (let i = 0; i < bubbleCount; i++) {
        const bubble = document.createElement('span');
        bubble.style.setProperty('--x', Math.random().toString());
        bubble.style.setProperty('--size', Math.random().toString());
        bubble.style.setProperty('--speed', Math.random().toString());
        bubble.style.setProperty('--delay', Math.random().toString());
        bubbleRoot.appendChild(bubble);
      }
    })();
  </script>

  <script>
    (function detectBrandFont() {
      const root = document.documentElement;
      const fallbackClass = 'brand-font-fallback';
      const fontSpec = '1rem "Krieger Halftone"';
      const enableFallback = () => root.classList.add(fallbackClass);

      if (document.fonts && document.fonts.load && document.fonts.check) {
        document.fonts.load(fontSpec).then(() => {
          if (!document.fonts.check(fontSpec)) {
            enableFallback();
          }
        }).catch(enableFallback);

        setTimeout(() => {
          if (!root.classList.contains(fallbackClass) && !document.fonts.check(fontSpec)) {
            enableFallback();
          }
        }, 1500);
      } else {
        enableFallback();
      }
    })();
  </script>

  <script type="module" src="/src/main.js"></script>
  <div class="pattern-history-modal" id="pattern-history-modal" aria-hidden="true">
    <div class="pattern-history-dialog">
      <div class="pattern-history-header">
        <h3 id="pattern-history-title">Pattern History</h3>
        <button type="button" id="pattern-history-close" class="history-close-button" aria-label="Close history">&times;</button>
      </div>
      <div class="pattern-history-tabs" id="pattern-history-tabs" style="display: none;">
        <button class="pattern-history-tab active" data-tab="local">Local</button>
        <button class="pattern-history-tab" data-tab="my-patterns">My Patterns</button>
        <button class="pattern-history-tab" data-tab="public">Public</button>
        <button class="pattern-history-tab" data-tab="shared">Shared</button>
      </div>
      <div id="pattern-history-list" class="pattern-history-list">
        <p class="pattern-history-empty">No saved versions yet.</p>
      </div>
    </div>
  </div>
</body>
</html>

