// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  name          String   @unique
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  birthDate     DateTime? @map("birth_date")
  city          String?
  country       String?
  oauthProvider String   @map("oauth_provider") // 'google' | 'github' | 'test' | 'local'
  oauthId       String   @map("oauth_id")
  passwordHash  String?  @map("password_hash")
  emailVerifiedAt      DateTime? @map("email_verified_at")
  verificationToken    String?   @map("verification_token")
  verificationTokenExpires DateTime? @map("verification_token_expires")
  resetToken           String?   @map("reset_token")
  resetTokenExpires    DateTime? @map("reset_token_expires")
  avatarUrl     String?  @map("avatar_url")
  artistName    String?  @map("artist_name")
  socialLinks   Json?    @default("{}") @map("social_links")
  role          String   @default("user")
  status        String   @default("active")
  profileCompleted Boolean @default(false) @map("profile_completed")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  patterns       Pattern[]
  sharedPatterns PatternShare[]
  collabSessions CollabSession[]         @relation("UserOwnedSessions")
  sessionParticipations SessionParticipant[] @relation("UserSessionParticipations")
  sessionChannels SessionChannel[]       @relation("UserSessionChannels")
  sessionChannelRevisions SessionChannelRevision[] @relation("UserSessionChannelRevisions")
  invitesSent CollabInvite[] @relation("UserInvitesSent")
  invitesReceived CollabInvite[] @relation("UserInvitesReceived")

  @@unique([oauthProvider, oauthId])
  @@index([verificationToken])
  @@index([resetToken])
  @@map("users")
}

model Pattern {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  type        String // 'channel' | 'master'
  elementId   String?  @map("element_id")
  patternCode String   @map("pattern_code") @db.Text
  title       String?
  artistName  String?  @map("artist_name")
  genre       String? // Song style/genre for matching
  version     Int      @default(1)
  versionName String?  @map("version_name")
  isPublic    Boolean  @default(false) @map("is_public")
  userCount   Int      @default(0) @map("user_count")
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user   User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  shares PatternShare[]
  analytics PatternAnalytics?

  @@index([userId])
  @@index([isPublic])
  @@index([type])
  @@index([genre])
  @@map("patterns")
}

model PatternAnalytics {
  patternId        String   @id @map("pattern_id")
  masterLoadCount  Int      @default(0) @map("master_load_count")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  pattern Pattern @relation(fields: [patternId], references: [id], onDelete: Cascade)

  @@map("pattern_analytics")
}

model PatternShare {
  id               String   @id @default(uuid())
  patternId        String   @map("pattern_id")
  sharedWithUserId String   @map("shared_with_user_id")
  createdAt        DateTime @default(now()) @map("created_at")

  pattern        Pattern @relation(fields: [patternId], references: [id], onDelete: Cascade)
  sharedWithUser User    @relation(fields: [sharedWithUserId], references: [id], onDelete: Cascade)

  @@unique([patternId, sharedWithUserId])
  @@index([sharedWithUserId])
  @@map("pattern_shares")
}

model CollabSession {
  id             String   @id @default(uuid())
  ownerId        String   @map("owner_id")
  slug           String   @unique
  title          String
  status         String   @default("active")
  masterCode     String?  @map("master_code") @db.Text
  mergedStack    String?  @map("merged_stack") @db.Text
  applyDelayMs   Int      @default(0) @map("apply_delay_ms")
  cpuStats       Json?    @default("{}") @map("cpu_stats")
  settings       Json?    @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  owner          User                 @relation("UserOwnedSessions", fields: [ownerId], references: [id], onDelete: Cascade)
  participants   SessionParticipant[]
  channels       SessionChannel[]
  channelHistory SessionChannelRevision[]
  invites        CollabInvite[]

  @@index([ownerId])
  @@map("collab_sessions")
}

model SessionParticipant {
  id         String   @id @default(uuid())
  sessionId  String   @map("session_id")
  userId     String   @map("user_id")
  role       String   @default("member")
  joinedAt   DateTime @default(now()) @map("joined_at")

  session    CollabSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user       User          @relation("UserSessionParticipations", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
  @@index([userId])
  @@map("session_participants")
}

model SessionChannel {
  id              String   @id @default(uuid())
  sessionId       String   @map("session_id")
  userId          String   @map("user_id")
  elementId       String?  @map("element_id")
  name            String?
  code            String   @db.Text
  status          String   @default("draft")
  volume          Float?   @map("volume_db")
  pan             Float?
  metadata        Json?    @default("{}")
  lastEvaluatedAt DateTime? @map("last_evaluated_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  session         CollabSession           @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User                    @relation("UserSessionChannels", fields: [userId], references: [id], onDelete: Cascade)
  revisions       SessionChannelRevision[]

  @@index([sessionId])
  @@index([userId])
  @@map("session_channels")
}

model SessionChannelRevision {
  id            String   @id @default(uuid())
  channelId     String   @map("channel_id")
  sessionId     String   @map("session_id")
  userId        String   @map("user_id")
  code          String   @db.Text
  appliedToMaster Boolean @default(false) @map("applied_to_master")
  createdAt     DateTime @default(now()) @map("created_at")

  channel       SessionChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  session       CollabSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user          User           @relation("UserSessionChannelRevisions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([userId])
  @@map("session_channel_revisions")
}

model CollabInvite {
  id         String   @id @default(uuid())
  sessionId  String   @map("session_id")
  inviterId  String   @map("inviter_id")
  inviteeId  String   @map("invitee_id")
  status     String   @default("pending")
  createdAt  DateTime @default(now()) @map("created_at")
  respondedAt DateTime? @map("responded_at")

  session  CollabSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  inviter  User          @relation("UserInvitesSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee  User          @relation("UserInvitesReceived", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([sessionId, inviteeId])
  @@index([sessionId])
  @@index([inviteeId])
  @@index([inviterId])
  @@map("collab_invites")
}
